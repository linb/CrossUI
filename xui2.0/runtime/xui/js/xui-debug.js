;(function(){
/*!
* CrossUI(xui) JavaScript Library v2.1
* http://crossui.com
* 
* Copyright ( 2004 ~ present) CrossUI.com
* Released under the MIT license
*
*/
// speed up references
var undefined, window=this, document=window.document;
if(!document)throw new Error("CrossUI requires a window with a document");

// global : xui
// we have to keep xui for gloable var
var xui = window.xui = function(nodes,flag){return xui.Dom.pack(nodes, flag)};

// Class & Namespace
xui.Class=function(key, pkey, obj){
    var _Static, _parent=[], self=xui.Class, w=window, env=self._fun, reg=self._reg, parent0, _this,i,t,_t,_c=self._all,
        _funadj = function(str){return (str+"").replace(/(\s*\/\*[^*]*\*+([^\/][^*]*\*+)*\/)|(\s*\/\/[^\n]*)|(\)[\s\S]*)/g,function(a){return a.charAt(0)!=")"?"":a});}
    obj=obj||{};
    //exists?
    if(!self._ignoreNSCache && (t=xui.get(w, key.split('.')))&&typeof(t)=='function'&&t.$xuiclass$)return self._last=t;
    //clear SC
    if(t=xui.get(w,['xui','$cache','SC']))delete t[key];

    //multi parents mode
    pkey = ( !pkey?[]:typeof pkey=='string'?[pkey]:pkey);
    for(i=0; t=pkey[i]; i++)
        if(!(_parent[i]=(xui.get(w, t.split('.')) || (xui&&xui.SC&&xui.SC(t)))))
            throw 'errNoParent--'+ t;
    if(obj.Dependencies){
        if(typeof obj.Dependencies == "string")obj.Dependencies=[obj.Dependencies];
        for(i=0; t=obj.Dependencies[i]; i++)
            if(!(xui.get(w, t.split('.')) || (xui&&xui.SC&&xui.SC(t))))
                throw 'errNoDependency--'+ t;
    }
    parent0=_parent[0];

    // Give a change to modify the original object
    var $Start = obj.$Start || (parent0&&parent0.$Start);
    xui.tryF($Start, [], obj);

    // collect items
    _Static=obj.Static||{};
    t={};
    for(i in _Static)
        if(reg[i])t[i]=1;
    for(i in t)
        delete _Static[i];
    
    //before and after will pass to children
    _Static.Before = obj.Before || (parent0&&parent0.Before);
    _Static.After = obj.After || (parent0&&parent0.After);
    _Static.$Start = $Start;
    _Static.$End = obj.$End || (parent0&&parent0.$End);
    _Static.__gc = obj.__gc || _Static.__gc || (parent0&&parent0.__gc) || function(){xui.Class.__gc(this.$key)};

    /*set constructor first and create _this
    upper is the first parent Class
    */
    var cf=function(){
        if(xui.Class.$instanceCreated)xui.Class.$instanceCreated(this);
        if(typeof this.initialize=='function')this.initialize()
    };
    if(typeof obj.Constructor == 'function'){
        _this = env(obj.Constructor, 'Constructor', key, parent0||cf,'constructor');
        _this.Constructor = _funadj(obj.Constructor);
    }else{
        if(parent0){
            // Constructor is for opera, in opear fun.toString can't get arguments sometime
            var f=cf,str = parent0.Constructor;
            if(str)f=new Function(str.slice(str.indexOf("(") + 1, str.indexOf(")")).split(','), str.slice(str.indexOf("{") + 1, str.lastIndexOf("}")));
            _this = env(f, 'Constructor', key, parent0.upper,'constructor');
            _this.Constructor = _funadj(str);
        }else
            _this = cf;
    }

    //collect parent items, keep the last one
    _t=xui.fun();
    for(i=_parent.length-1; t=_parent[i--];){
        xui.merge(_t,t);
        xui.merge(_t.prototype,t.prototype);
    }
    //set keys
    _this.KEY=_this.$key=_this.prototype.KEY=_this.prototype.$key=key;
    //envelop
    //  from Static
    self._wrap(_this,_Static,0,_t,'static');
    //  from Instance
    if(t=obj.Instance)
        self._wrap(_this.prototype,t,1,_t.prototype,'instance');
    //inherite from parents
    self._inherit(_this,_t);
    self._inherit(_this.prototype,_t.prototype);
    _t=null;

    //exe before functoin
    if(xui.tryF(_this.Before, arguments, _this)===false)
        return false;

    //add child key to parents
    for(i=0; t=_parent[i]; i++){
        t=(t.$children || (t.$children=[]));
        for(var j=0,k=t.length,b;j<k;j++)
            if(t[k]==key){
                b=true;
                break;
            }
        if(!b)t[t.length]=key;
    }

    //set symbol
    _this.$xui$ = _this.$xuiclass$ = 1;
    _this.$children = [];
    _this.$parent = _parent;

    //set constructor
    _this.prototype.constructor = _this;
    _this.prototype.$xui$ = 1;
    //set key
    _this[key] = _this.prototype[key] = true;

    //allow load App.Sub first
    _t=t=xui.get(w, key.split('.'));
    xui.set(w, key.split('.'), _this);
    if(Object.prototype.toString.call(_t)=='[object Object]')
        for(i in _t)_this[i]=_t[i];

    //exe after function
    xui.tryF(_this.After, [], _this);
    //exe ini function
    xui.tryF(obj.Initialize, [], _this);
    xui.tryF(_this.$End, [], _this);

    xui.breakO([obj.Static, obj.Instance, obj],2);
    
    if(!(key in _c)){
        _c[key]=_c.length;
        _c.push(key);
    }

    //return Class
    return self._last=_this;
};
xui.Namespace=function(key){
    var a=key.split('.'),w=window;
    return xui.get(w, a) || xui.set(w, a, {});
};

//window.onerror will be redefined in xui.Debugger
//window.onerror=function(){return true};

/*merge hash from source to target
  target:hash
  source:hash
  type:'all', 'with', 'without'[default], or function <return true will trigger merge>
  return: merged target
*/
xui.merge=function(target, source, type, force){
    var i,f;
    if(typeof type == "function"){
        f=type;
        type='fun';
    }
    switch(type){
        case 'fun':
            for(i in source)if((force||source.hasOwnProperty(i)) && true===f(source[i],i))target[i]=source[i];
            break;
        case 'all':
            for(i in source)if((force||source.hasOwnProperty(i)))target[i]=source[i];
            break;
        case 'with':
            for(i in source)if((force||source.hasOwnProperty(i)) && target.hasOwnProperty(i))target[i]=source[i];
            break;
        default:
            for(i in source)if((force||source.hasOwnProperty(i)) && !target.hasOwnProperty(i))target[i]=source[i];
    }
    return target;
};

new function(){
    var lastTime=0,vendors=['ms','moz','webkit','o'],w=window,i=0,l=vendors.length,tag;
    for(;i<l && !w.requestAnimationFrame && (tag=vendors[i++]);) {
        w.requestAnimationFrame = w[tag+'RequestAnimationFrame'];
        w.cancelAnimationFrame = w[tag+'CancelAnimationFrame']||w[tag+'CancelRequestAnimationFrame'];
    }
    w.requestAnimationFrame=w.requestAnimationFrame||function(callback,element){
        var currTime=(new Date()).getTime(),
            timeToCall=Math.max(0,   1000 / 60 - (currTime-lastTime)),
            id=setTimeout(function(){callback(currTime + timeToCall)}, timeToCall);
        lastTime=currTime+timeToCall;
        return id;
    };
    w.cancelAnimationFrame = w.cancelAnimationFrame||function(id){clearTimeout(id)};
    w.requestIdleCallback = w.requestIdleCallback || function (cb) {
        return setTimeout(function () {
          var start = Date.now();
          cb({ 
            didTimeout: false,
            timeRemaining: function () {
              return Math.max(0, 50 - (Date.now() - start));
            }
          });
        }, 1);
    };
    w.cancelIdleCallback = w.cancelIdleCallback || function (id) {clearTimeout(id)}; 
};

new function(){
    var _to = Object.prototype.toString;
    xui.merge(xui,{
        stamp:function(){return +new Date()},
        rand:function(){
            return parseInt(xui.stamp()*Math.random(),10).toString(36);
        },
        setTimeout:function(callback,delay){
            return (delay===false||(delay||0)>1000/60)?(setTimeout(callback,delay||0)*-1):requestAnimationFrame(callback);
        },
        clearTimeout:function(id){
            if(id>=0)cancelAnimationFrame(id);
            else clearTimeout(Math.abs(id));
        },
        fun:function(){return function(){}},
        exec:function(script, id, closure){
            var me=this,
                d=document,
                h=d.getElementsByTagName("head")[0] || d.documentElement,
                s=d.createElement("script"),n;
            if(closure)script="!function(){"+script+"}(window)";
            s.type = "text/javascript";
            if(id){
                if((n=d.getElementById(id))&&n.parentNode==h){
                    h.removeChild(n);
                }
                s.id=id;
            }
            if(xui.browser.ie)
                s.text=script;
            else
                s.appendChild(d.createTextNode(script));
            h.appendChild(s);
            s.disalbed=true;
            s.disabled=false;
            if(!id){
                h.removeChild(s);
            }
            return s;
        },
        /*
        get something from deep hash
        hash:target hash
        arr:path array,
        example:
        xui.get({a:{b:{c:1}}},['a','b']) => {c:1};
            xui.get({a:{b:{c:1}}},['a','b','c']) => 1;
            xui.get({a:{b:{c:1}}},['a','b','c','d']) => undefined;
        */
        get:function(hash,path){
            if(!path) return hash;
            if(!xui.isSet(hash))return undefined;
            else if(typeof path=='string') return hash[path];
            else{
                for(var i=0,l=path.length,t;i<l;){
                    if(!(t=path[i++]+''))continue;
                    if(!hash || (hash=t!=(t=t.replace("()","")) ? (typeof(hash[t])=="function" && 0!==t.indexOf("set"))? hash[t]() : undefined : hash[t])===undefined )return;
                }
                return hash;
            }
        },
        /*
        set/unset a value to deep hash
        example:
            xui.set({a:{b:{c:1}}},['a','b','c'],2) => {a:{b:{c:2}}}
            xui.set({a:{b:{c:1}}},['a','b','c']) => {a:{b:{}}}
        */
        set:function(hash,path,value){
            if(!hash)return;
            if(typeof path!='string'){
                var v,i=0,m,last=path.length-1;
                for(;i<last;){
                    v=path[i++];
                    if(hash[v]&&((m=typeof hash[v])=='object' || m=='function')) hash=hash[v];
                    else hash=hash[v]={};
                }
                path=path[last];
            }
            // the last one can be a [set] function
            if(path!=(path=(path+"").replace("()","")) ){
                if(typeof(hash[path])=="function"){
                    hash[path](value);
                    return value;
                }
            }else{
                if(value===undefined){
                    if(hash.hasOwnProperty && hash.hasOwnProperty(path))
                        delete hash[path];
                    else hash[path]=undefined;
                }else{
                    return hash[path]=value;
                }
            }
        },
        /* try to excute a function
        fun:target function
        args:arguments for fun
        scope:[this] pointer for fun
        df:default return vale
        */
        tryF:function(fun, args, scope, df){
            return (fun && typeof fun=='function') ? fun.apply(scope||{}, args||[]) : df
        },
        /*asynchronous run function
        fun:target function
        defer: setTimeout defer time
        args: arguments for fun
        scope: [this] pointer for fun
        */
        asyRun:function(fun, defer, args, scope){
            //defer must set in opera
            return xui.setTimeout(typeof fun=='string' ? function(){xui.exec(fun)} : function(){fun.apply(scope,args||[]);fun=args=null;}, defer);
        },
        idleRun:function(fun, args, scope){
            return window.requestIdleCallback(typeof fun=='string' ? function(){xui.exec(fun)} : function(){fun.apply(scope,args||[]);fun=args=null;});
        },
        asyHTML:function(content, callback, defer, size){
            var div = document.createElement('div'),
                fragment = document.createDocumentFragment(),
                f=function(){
                    var i=size||10;
                    while(--i && div.firstChild)
                        fragment.appendChild(div.firstChild);
                    if(div.firstChild)
                        xui.setTimeout(f, defer);
                    else
                        callback(fragment);
                };
            div.innerHTML = content;
            f();
        },
        isEmpty:function(hash){
            if (hash==null) return true;
            if (xui.isNumb(hash)) return false;
            if (xui.isArr(hash) || xui.isStr(hash) || xui.isArguments(hash)) return hash.length === 0;
            for(var i in hash)if(Object.prototype.hasOwnProperty.call(hash, i))return false;
            return true;
        },

        /*
        this will always run newer function
        key: for identify
        fun: to run
        defer: setTimeout defer time
        args: arguments for fun
        scope: 'this' for fun
        */
        resetRun:function(key, fun, defer ,args, scope){
            var me=xui.resetRun, k=key, cache = me.$cache || ( (me.exists=function(k){return this.$cache[k]})&& (me.$cache = {}));
            if(cache[k]){xui.clearTimeout(cache[k])}
            if(typeof fun=='function')
                cache[k] = xui.setTimeout(function(){delete cache[k];fun.apply(scope||null,args||[])},defer);
            else delete cache[k];
        },
        //Dependencies: xui.Dom xui.Thread
        observableRun:function(tasks,onEnd,threadid,busyMsg){
            xui.Thread.observableRun(tasks,onEnd,threadid,busyMsg);
        },

        /*break object memory link
        target: target object
        n: depth, default 1
        */
        breakO:function(target,depth,_layer){
            var n=depth||1, l=1+(_layer||0), self=xui.breakO, _t='___gc_', i;
            if(target && (typeof target=='object' || typeof target=='function') && target!==window&&target!==document&&target.nodeType!==1){
                try{if(target.hasOwnProperty(_t))return; else target[_t]=null}catch(e){return}
                try{for(i in target){
                    if(target.hasOwnProperty(i) && target[i]){
                        if(typeof target[i]=='object' || typeof target[i]=='function')
                            if(l<n)
                                self(target[i],n,l);
                        try{target[i]=null}catch(e){}
                    }
                }}catch(e){return}
                if(target.length)target.length=0;
                delete target[_t];
            }
        },

        /*each function for hash
        fun: fun to exec, if return false, stop the $iterator
        scope: 'this' pointer;
        */
        each:function(hash,fun,scope){
            scope = scope||hash;
            for(var i in hash)
                if(false===fun.call(scope, hash[i], i, hash))
                    break;
            return hash;
        },
        compareVar:function(x,y,MAXL,MAXS){
            if(x===y)return true;

            if(xui.isObj(x)||xui.isObj(y)){
                if((xui.isDate(x) && xui.isDate(y)) || (xui.isReg(x) && xui.isReg(y)))
                    return x+''===y+'';
                else if((xui.isHash(x) && xui.isHash(y)) || (xui.isArr(x) && xui.isArr(y)) ||  (xui.isArguments(x) && xui.isArguments(y))){
                    x = xui.serialize(x,0,0,MAXL||5,MAXS||300);
                    y = xui.serialize(y,0,0,MAXL||5,MAXS||300);
                    return x.indexOf(xui.$_outofmilimted)==-1 && y.indexOf(xui.$_outofmilimted)==-1 && x===y;
                }else
                    return false;
            }
        },
        compareNumber:function(a,b,digits){
            return xui.toFixedNumber(a,digits) === xui.toFixedNumber(b,digits);
        },
        toFixedNumber:function(number,digits) {
            if(!xui.isSet(digits))digits=2;
            var m=Math.abs(number),
                s=''+Math.round(m * Math.pow(10, digits)),
                v, t, start, end;
            if(/\D/.test(s)){
              v = ""+m;
            }else{
                while(s.length<1+digits)s='0'+s;
                start=s.substring(0, t=(s.length-digits));
                end=s.substring(t);
                if(end)end="."+end;
                v=start+end;
            }
            return parseFloat((number<0?"-":"")+v);
        },
        toNumeric:function(value, precision, groupingSeparator, decimalSeparator){
            if(!xui.isNumb(value))
                value=parseFloat((value+"").replace(/\s*(e\+|[^0-9])/g, function(a,b,c){return b=='e+'||b=='E+'||(c==0&&b=='-')?b:b==decimalSeparator?'.':''}))||0;
            if(xui.isSet(precision) && precision>=0)
                 value=xui.toFixedNumber(value,precision);
            return value;
        },
        formatNumeric:function(value, precision, groupingSeparator, decimalSeparator, forceFillZero, trimTailZero){
            if(xui.isSet(precision))precision=parseInt(precision,10);
            precision=(precision||precision===0)?precision:0;
            groupingSeparator=xui.isSet(groupingSeparator)?groupingSeparator:",";
            decimalSeparator=decimalSeparator||".";
            value=""+parseFloat(value);
            if(value.indexOf('e')==-1){
                value=xui.toFixedNumber(value,precision) + "";
                value= value.split(".");
                if(forceFillZero!==false){
                    if((value[1]?value[1].length:0)<precision)value[1]=(value[1]||"")+xui.str.repeat('0',precision-(value[1]?value[1].length:0));
                }
                value[0] = value[0].split("").reverse().join("").replace(/(\d{3})(?=\d)/g, "$1"+groupingSeparator).split("").reverse().join("");
                value = value.join(decimalSeparator);
            }
            return trimTailZero && value.indexOf(decimalSeparator)!=-1 ? value.replace(new RegExp('['+decimalSeparator+']?0+$'),'') : value;
        },
        /***
            A wrapper for lots regExp string.replace to only once iterator replace
            You can use it, when
            1.replace >10
            2.need protect some regexp
            3.every long string to replac

            str: will be replace
            reg, array: [string, string] or [regex, string] or [[],[]]
            replace: to replace
            ignore_case: bool, for regexp symble 'i'
            return : replaced string

            For example:
                xui.replace("aAa","a","*",true)
                        will return "*A*"
                xui.replace("aAa","a","*",false)
                        will return "***"
                xui.replace("aAa","a","*")
                xui.replace("aAa",/a/,"*")         : "/a/" is OK, but not "/a/g"
                xui.replace("aAa",["a","*"])
                xui.replace("aAa",[["a","*"]])
                        will return "***"
                xui.replace("aAa",[["a","*"],[/A/,"-"]])
                        will return "*-*"
            Notice: there is a '$0' symbol here, for protect
                xui.replace("aba",[["ab","$0"],["a","*"]])
                        will return "ab*"
                here, "ab" will be first matched and be protected to replace by express "a"
        ***/
        replace:function(str, reg, replace, ignore_case){
            if(!str)return "";
            var i, len,_t, m,n, flag, a1 = [], a2 = [],
                me=arguments.callee,
                reg1=me.reg1 || (me.reg1=/\\./g),
                reg2=me.reg2 || (me.reg2=/\(/g),
                reg3=me.reg3 || (me.reg3=/\$\d/),
                reg4=me.reg4 || (me.reg4=/^\$\d+$/),
                reg5=me.reg5 || (me.reg5=/'/),
                reg6=me.reg6 || (me.reg6=/\\./g),
                reg11=me.reg11 || (me.reg11=/(['"])\1\+(.*)\+\1\1$/)
            ;

            if(!xui.isArr(reg)){reg=[reg,replace]}else{ignore_case=replace}
            if(!xui.isArr(reg[0])){reg=[reg]};
            xui.arr.each(reg,function(o){
                m= typeof o[0]=='string'?o[0]:o[0].source;
                n= o[1]||"";
                len = ((m).replace(reg1, "").match(reg2) || "").length;
                if(typeof n !='function'){
                    if (reg3.test(n)) {
                        //if only one paras and valid
                        if (reg4.test(n)) {
                            _t = parseInt(n.slice(1),10);
                            if(_t<=len)n=_t;
                        }else{
                            flag = reg5.test(n.replace(reg6, "")) ? '"' : "'";
                            i = len;
                            while(i + 1)
                                n = n.split("$" + i).join(flag + "+a[o+"+ i-- +"]+" + flag);

                            n = new Function("a,o", "return" + flag + n.replace(reg11, "$1") + flag);
                        }
                    }
                }
                a1.push(m || "^$");
                a2.push([n, len, typeof n]);
            });


            return str.replace(new RegExp("("+a1.join(")|(")+")", ignore_case ? "gim" : "gm"), function(){
                var i=1,j=0,args=arguments,p,t;
                if (!args[0]) return "";
                while (p = a2[j++]) {
                    if (t = args[i]) {
                        switch(p[2]) {
                            case 'function':
                                //arguments:
                                //1: array, all arguments; 
                                //2: the data position index,  args[i] is $0;
                                //3: the regexp index
                                return p[0](args, i, j-1);
                            case 'number':
                                return args[p[0] + i];
                            default:
                                return p[0];
                        }
                    }else{i += p[1]+1;}
                }
            });
        },
        /*shadow copy for hash/array
        * var a=[]; a.b='b'; a.b will not be copied
        */
        copy:function(hash,filter){
            return xui.clone(hash,filter,1);
        },
        /*deep copy for hash/array, and hash/array only
        * var a=[]; a.b='b'; a.b will not be cloned
        *be careful for dead lock
        */
        clone:function(hash,filter,deep,_layer){
            _layer=_layer||0;
            if(hash && (xui.isHash(hash)||xui.isArr(hash))){
                if(xui.isObj(hash)){
                    var me=xui.clone,
                        isArr=xui.isArr(hash),
                        h=isArr?[]:{},
                        i=0,v,l;
                    if(!deep){
                        if(deep<=0)return hash;
                        else deep=100;
                    }
                    if(isArr){
                        l=hash.length;
                        for(;i<l;i++){
                            if(typeof filter=='function'&&false===filter.call(hash,hash[i],i,_layer+1))continue;
                            h[h.length]=((v=hash[i]) && deep && (xui.isHash(v)||xui.isArr(v)))?me(v,filter,deep-1,_layer+1):v;
                        }
                    }else{
                        for(i in hash){
                            if(filter===true?i.charAt(0)=='_':
                                filter===false?(i.charAt(0)=='_'||i.charAt(0)=='$'):
                                typeof filter=='function'?false===filter.call(hash,hash[i],i,_layer+1):0)
                                continue;
                            h[i]=((v=hash[i]) && deep && (xui.isHash(v)||xui.isArr(v)))?me(v,filter,deep-1,_layer+1):v;
                        }
                    }
                    return h;
                }else return hash;
            }else return hash;
        },
        /*filter hash/array
        filter: filter function(will delete "return false")
        */
        filter:function(obj, filter, force){
            if(!force && obj && xui.isArr(obj)){
                var i,l,v,a=[],o;
                for(i=0, l=obj.length; i<l; i++)a[a.length]=obj[i];
                obj.length=0;
                for(i=0, l=a.length; i<l; i++)
                    if(typeof filter=='function'?false!==filter.call(a,a[i],i):1)
                        obj[obj.length]=a[i];
            }else{
                var i, bak={};
                for(i in obj)
                    if(filter===true?i.charAt(0)=='_':
                        filter===false?(i.charAt(0)=='_'||i.charAt(0)=='$'):
                        typeof filter=='function'?false===filter.call(obj,obj[i],i):0)
                        bak[i]=1;

                for(i in bak)
                    delete obj[i];
            }
            return obj;
        },
        /*convert iterator to Array
        value: something can be iteratorred
        xui.toArr({a:1},true) => [a];
        xui.toArr({a:1},false) => [1];
        xui.toArr('a,b') => ['a','b'];
        xui.toArr('a;b',';') => ['a','b'];
        */
        toArr:function(value, flag){
            if(!value)return [];
            var arr=[];
            //hash
            if(typeof flag == 'boolean')
                for(var i in value)
                    arr[arr.length]=flag?i:value[i];
            //other like arguments
            else{
                if(xui.isHash(value)){
                    for(var i in value){
                        arr.push({key:i,value:value[i]});
                    }
                }else if(typeof value=='string')
                    arr=value.split(flag||',');
                else
                    for(var i=0,l=value.length; i<l; ++i)
                        arr[i]=value[i];
            }
            return arr;
        },
        toUTF8:function(str){
            return str.replace(/[^\x00-\xff]/g, function(a,b) {
                return '\\u' + ((b=a.charCodeAt())<16?'000':b<256?'00':b<4096?'0':'')+b.toString(16)
            })
        },
        fromUTF8:function(str){
            return str.replace(/\\u([0-9a-f]{3})([0-9a-f])/g,function(a,b,c){return String.fromCharCode((parseInt(b,16)*16+parseInt(c,16)))})
        },
        urlEncode:function(hash){
            var a=[],b=[],i,c,o;
            for(i in hash){
                a[c=a.length]=b[b.length]=encodeURIComponent(i);
                if((o=hash[i]) || o===0) a[c] += '='+encodeURIComponent(typeof o=='string'?o:xui.serialize(o));
            }
            a=xui.arr.stableSort(a,function(x,y,i,j){return b[i]>b[j]?1:b[i]==b[j]?0:-1});
            return a.join('&');
        },
        urlDecode:function(str, key){
            if(!str)return key?'':{};
            var arr,hash={},a=str.split('&'),o;
            for(var i=0,l=a.length;i<l;i++){
                o=a[i];
                arr=o.split('=');
                try{
                    hash[decodeURIComponent(arr[0])]=decodeURIComponent(arr[1]||'');
                }catch(e){
                    hash[arr[0]]=arr[1]||'';
                }
            }
            return key?hash[key]:hash;
        },
        getUrlParams:function(url){
            return xui.urlDecode((url||location.href).replace(/^[^#]*[#!]+|^[^#]*$/,''));
        },
        preLoadImage:function(src, onSuccess, onFail) {
            if(xui.isArr(src)){
                for(var i=0, l=arr.length; i<l; i++)
                    xui.preLoadImage(src[i], onSuccess, onFail);
                return l;
            }
            var img = document.createElement("img");
            img.style.cssText = "position:absolute;left:-999px;top:-999px";
            img.width=img.height=2;
            img.onload = function () {
                if(typeof onSuccess=='function')onSuccess.call(this);
                this.onload = this.onerror = null;
                document.body.removeChild(this);
            };
            img.onerror = function () {
                if(typeof onFail=='function')onFail.call(this);
                this.onload = this.onerror = null;
                document.body.removeChild(this);
            };
            document.body.appendChild(img);
            img.src = src;
            return 1;
        },
        // type detection
        isDefined:function(target)  {return target!==undefined},
        isNull:function(target)  {return target===null},
        isSet:function(target)   {return target!==undefined && target!==null && target!==NaN},
        // including : object array function
        isObj:function(target)   {return !!target  && (typeof target == 'object' || typeof target == 'function')},
        isHash:function(target)  {return !!target && _to.call(target)=='[object Object]' && target.constructor && /^\s*function\s+Object\(\s*\)/.test(target.constructor.toString()) && !Object.prototype.hasOwnProperty.call(target,"callee")},
        isBool:function(target)  {return typeof target == 'boolean'},
        isNumb:function(target)  {return typeof target == 'number' && isFinite(target)},
        isFinite:function(target)  {return (target||target===0) && isFinite(target) && !isNaN(parseFloat(target))},
        isDate:function(target)  {return _to.call(target)==='[object Date]' && isFinite(+target)},
        isFun:function(target)   {return _to.call(target)==='[object Function]'},
        isArr:function(target)   {return _to.call(target)==='[object Array]'},
        isReg:function(target)   {return _to.call(target)==='[object RegExp]'},
        isStr:function(target)   {return _to.call(target)==='[object String]'},
        isArguments:function(target)   {return target && (_to.call(target)==='[object Arguments]' || Object.prototype.hasOwnProperty.call(target,"callee"))},
        isElem:function(target) {return !!(target && target.nodeType === 1)},
        isNaN:function(target) {return typeof target == 'number' && target != +target;},
        //for handling String
        str:{
            startWith:function(str,sStr){
                return str.indexOf(sStr) === 0;
            },
            endWith:function (str,eStr) {
                var l=str.length-eStr.length;
                return l>=0 && str.lastIndexOf(eStr) === l;
            },
            repeat:function(str,times){
                return new Array(times+1).join(str);
            },
            initial:function(str){
                return str.charAt(0).toUpperCase() + str.substring(1);
            },
            trim:function(str){
                return str?str.replace(/^(\s|\uFEFF|\xA0)+|(\s|\uFEFF|\xA0)+$/g, ''):str;
            },
            ltrim:function(str){
                return str?str.replace(/^(\s|\uFEFF|\xA0)+/,''):str;
            },
            rtrim:function(str){
                return str?str.replace(/(\s|\uFEFF|\xA0)+$/,''):str;
            },
            /*
            blen : function(s){
                var _t=s.match(/[^\x00-\xff]/ig);
                return s.length+(null===_t?0:_t.length);
            },
            */
            //Dependencies: xui.Dom
            toDom:function(str){
                var p=xui.$getGhostDiv(), r=[];
                p.innerHTML=str;
                for(var i=0,t=p.childNodes,l=t.length;i<l;i++)r[r.length]=t[i];
                p=null;
                return xui(r);
            }
        },
        //for handling Array
        arr:{
            fastSortObject:function(arr, getKey){
                if(!arr||arr.length<2)return arr;

                var ll=arr.length,
                    zero=[],
                    len=(ll+"").length,
                    p=Object.prototype,
                    o,s,c,t;
                for(var i=0;i<len;i++)zero[i]=new Array(len-i).join("0");
                for(var j=0;j<ll;j++){
                    s=j+'';
                    c=arr[j];
                    if(typeof c=="object")c._xui_$s$=(xui.isSet(t=getKey.call(c,j))?t:'') + zero[s.length-1] + s;
                }
                try{
                    o=p.toString;
                    p.toString=function(){return this.hasOwnProperty('_xui_$s$')?(this._xui_$s$):(o.call(this));};
                    arr.sort();
                }finally{
                    p.toString=o;
                    for(var j=0;j<ll;j++)if(typeof arr[j]=="object")delete arr[j]._xui_$s$;
                }
                return arr;
            },
            stableSort:function(arr,sortby){
                if(arr && arr.length > 1){
                    for(var i=0,l=arr.length,a=[],b=[];i<l;i++)b[i]=arr[a[i]=i];
                    if(xui.isFun(sortby))
                        a.sort(function(x,y){
                            return sortby.call(arr,arr[x],arr[y],x,y) || (x>y?1:-1);
                        });
                    else
                        a.sort(function(x,y){
                            return arr[x]>arr[y]?1:arr[x]<arr[y]?-1:x>y?1:-1;
                        });
                    for(i=0;i<l;i++)arr[i]=b[a[i]];
                    a.length=b.length=0;
                }
                return arr;
            },
            subIndexOf:function(arr,key,value){
                if(value===undefined)return -1;
                for(var i=0, l=arr.length; i<l; i++)
                    if(arr[i] && arr[i][key] === value)
                        return i;
                return -1;
            },
            removeFrom:function(arr, index,length){
                arr.splice(index, length || 1);
                return arr;
            },
            removeValue:function(arr, value){
                for(var l=arr.length,i=l-1; i>=0; i--)
                    if(arr[i]===value)
                        arr.splice(i,1);
                return arr;
            },
            intersection:function (a, b){
              var ai=0, bi=0, result = [];
              while( ai < a.length && bi < b.length ){
                 if(a[ai]<b[bi] )ai++;
                 else if(a[ai]>b[bi] )bi++;
                 else{
                   result.push(a[ai]);
                   ai++;
                   bi++;
                 }
              }
              return result;
            },
            /*
             insert something to array
             arr: any
             index:default is length-1
             flag: is add array

             For example:
             [1,2].insertAny(3)
                will return [1,2,3]
             [1,2].insertAny(3,0)
                will return [3,1,2]
             [1,2].insertAny([3,4])
                will return [1,2,3,4]
             [1,2].insertAny([3,4],3,true)
                will return [1,2,[3,4]]
            */
            insertAny:function (arr, target,index, flag) {
                var l=arr.length;
                flag=(!xui.isArr(target)) || flag;
                if(index===0){
                    if(flag)
                        arr.unshift(target);
                    else
                        arr.unshift.apply(arr, target);
                }else{
                    var a;
                    if(!index || index<0 || index>l)index=l;
                    if(index!=l)
                        a=arr.splice(index,l-index);
                    if(flag)
                        arr[arr.length]=target;
                    else
                        arr.push.apply(arr, target);
                    if(a)
                        arr.push.apply(arr, a);
                }
                return index;
            },
            indexOf:function(arr, value) {
                for(var i=0, l=arr.length; i<l; i++)
                    if(arr[i] === value)
                        return i;
                return -1;
            },
            /*
            fun: fun to apply
            desc: true - max to min , or min to max
            atarget: for this
            */
            each:function(arr,fun,scope,desc){
                var i, l, a=arr;
                if(!a)return a;
                if(!xui.isArr(a)){
                    if(!xui.isArr(a._nodes))
                        return a;
                    a=a._nodes;
                    if(desc===undefined)
                        desc=1;
                }
                l=a.length;
                scope = scope||arr;
                if(!desc){
                    for(i=0; i<l; i++)
                        if(fun.call(scope, a[i], i, a)===false)
                            break;
                }else
                    for(i=l-1; i>=0; i--)
                        if(fun.call(scope, a[i], i, a)===false)
                            break;
                return arr;
            },
            removeDuplicate:function(arr,subKey){
                var l=arr.length,a=arr.concat();
                arr.length=0;
                for(var i=l-1;i>=0;i--){
                    if(subKey? this.subIndexOf(a, subKey, a[i][subKey])===i: this.indexOf(a, a[i])===i)
                        arr.push(a[i]);
                }
                return arr.reverse();
            }
        },
        _scope_set: function(dataMap){
            if(window.get)xui._scope_bak=get;
            xui._scope_datamap=dataMap;
            window.get=function(key){
                if(key){
                    var t, i=(key=""+key).indexOf("."), scope=i==-1?key:key.substr(0,i), name=i==-1?null:key.substr(i+1,key.length);
                    return (t=xui._scope_datamap) &&  (t=t[scope]) && (name ? t[name] : t);
                }
            };
        },
        _scope_clear: function(bak){
            if(bak=xui._scope_bak){
                window.get=bak;
                delete xui._scope_bak;
                delete xui._scope_datamap;
            }
        }
    });
};

xui.merge(xui.fun,{
    body:function(fun){
        var s=""+fun;
        s=s.replace(/(\s*\/\*[^*]*\*+([^\/][^*]*\*+)*\/)|(\s*\/\/[^\n]*)|(\)[\s\S]*)/g,function(a){return a.charAt(0)!=")"?"":a});        
        return s.slice(s.indexOf("{") + 1, s.lastIndexOf("}"));
    },
    args:function(fun){
        var s=""+fun;
        s=s.replace(/(\s*\/\*[^*]*\*+([^\/][^*]*\*+)*\/)|(\s*\/\/[^\n]*)|(\)[\s\S]*)/g,function(a){return a.charAt(0)!=")"?"":a});
        s=s.slice(s.indexOf("(") + 1, s.indexOf(")")).split(/\s*,\s*/);
        return s[0]&&s;
    },
    clone:function(fun){
        return new Function(xui.fun.args(fun),xui.fun.body(fun));
    }
});

xui.merge(xui.Class, {
    _reg:{$key:1,$parent:1,$children:1,KEY:1,Static:1,Instance:1,Constructor:1,Initialize:1},
    // give nodeType to avoid breakO
    _reg2:{'nodeType':1,'constructor':1,'prototype':1,'toString':1,'valueOf':1,'hasOwnProperty':1,'isPrototypeOf':1,'propertyIsEnumerable':1,'toLocaleString':1},
    _all:[],
    /*envelop a function by some keys
    */
    _fun:function(fun, name, original, upper, type){
        fun.$name$=name;
        fun.$original$=original;
        if(type)fun.$type$=type;
        if(upper && fun!==upper)fun.upper=upper;
        return fun;
    },
    _other:["toString", "valueOf"],
    /*envelop object's item from an object
    target: target object
    src: from object
     i: key in hash
    limit: envelop values in a hash
    */
    _o:{},
    //inherit from parents
    _inherit:function (target, src, instance){
        var i, o, r=this._reg;
        for(i in src){
            if(i in target || (!instance && r[i]) || i.charAt(0)=='$')continue;
            o=src[i];
            if(o && o.$xui$)continue;
            target[i]=o;
        }
    },
    //wrap
    _wrap:function (target, src, instance, parent, prtt){
        var self=this, i,j,o,k=target.KEY,r=self._reg,r2=self._reg2,f=self._fun,oo=self._other;
        for(i in src){
            if(r2[i] || (!instance && r[i]))continue;
            o=src[i];
            target[i] = (typeof o != 'function') ? o : f(o, i, k, typeof parent[i]=='function'&&parent[i],prtt);
        }
        for(j=0;i=oo[j++];){
            o=src[i];
            if(o && (o == self._o[i]))continue;
            target[i] = (typeof o != 'function') ? o : f(o, i, k, typeof parent[i]=='function'&&parent[i],prtt);
        }
    },
    __gc:function(key){
        var _c=xui.Class._all;
        if(!key){
            for(var i=_c.length-1;i>0;i--)
                xui.Class.__gc(_c[i]);
            return;
        }
        if(typeof key=='object')key=key.KEY||"";
        var t = xui.get(window, key.split('.')),s,i,j;
        if(t){
            //remove from SC cache
            if(s=xui.get(window,['xui','$cache','SC']))delete s[key];

            //remove parent link
            if(t.$parent)
                t.$parent.length=0;

            //remove chidlren link
            //gc children
            if(s=t.$children){
                //destroy children
                for(var i=0,o; o=s[i];i++)
                    if(o=xui.get(window,o.split('.')))
                        if(o.__gc)
                            o.__gc();
                s.length=0;
            }

            //break function links
            for(i in t)
                if(i!='upper' && typeof t[i]=='function')
                    for(j in t[i])
                        if(t[i].hasOwnProperty(j))
                           delete t[i][j];
            xui.breakO(t);

            t=t.prototype;
            for(i in t)
                if(i!='upper' && typeof t[i]=='function')
                    for(j in t[i])
                        if(t[i].hasOwnProperty(j))
                            delete t[i][j];
            xui.breakO(t);

            //remove it out of window
            xui.set(window, key.split('.'));
        }

        _c.splice(_c[key],1);
        delete _c[key];
    },
    destroy:function(key){xui.Class.__gc(key)}
});

//function Dependencies: xui.Dom xui.Thread
xui.merge(xui,{
    version:2.1,
    $DEFAULTHREF:'javascript:;',
    $IEUNSELECTABLE:function(){return xui.browser.ie?' onselectstart="return false;" ':''},
    SERIALIZEMAXLAYER:99,
    SERIALIZEMAXSIZE:9999,

    $localeKey:'en',
    $localeDomId:'xlid',
    $dateFormat:'',
    $rand:"_rnd_",
    _rnd:function(){
        return xui.debugMode?xui.$rand+"="+xui.rand():null;
    },
    _debugInfo:function(){
        if(xui.debugMode && xui.isDefined(window.console) && typeof(console.log)=='function')
            console.log.apply(console, xui.toArr(arguments));
    },
    SpaceUnit:'em',
    $us:function(p){
        // ie67 always px
        return (xui.browser.ie6||xui.browser.ie7) ? p ? -2 : -1:
            ( p = p ? p.properties ? p.properties.spaceUnit : p.spaceUnit : '' ) == 'px' ? -2 :  p=='em'? 2 : 
                xui.SpaceUnit == 'px' ? -1 : xui.SpaceUnit == 'em' ? 1 : 0;
        },
    // for show xui.echo
    debugMode:true,

    Locale:{},
    constant:{},
    $cache:{
        thread:{},
        SC:{},
        clsByURI:{},
        fetching:{},
        hookKey:{},
        hookKeyUp:{},
        snipScript:{},

        subscribes:{},

        //ghost divs
        ghostDiv:[],
        data:{},
        callback:{},
        functions:{},
        //cache purge map for dom element
        domPurgeData:{},
        //cache DomProfile or UIProfile
        profileMap:{},
        //cache the reclaim serial id for UIProfile
        reclaimId:{},
        //cache built template for UIProfile
        template:{},
        //cache [key]=>[event handler] map for UIProfile
        UIKeyMapEvents:{},
        droppable:{},
        unique:{}
    },
    subscribe:function(topic, subscriber, receiver, asy){
        if(topic===null||topic===undefined||subscriber===null||subscriber===undefined||typeof receiver!='function')return;
        var c=xui.$cache.subscribes,i;
        c[topic]=c[topic]||[];
        i=xui.arr.subIndexOf(c[topic],"id",subscriber);
        if(i!=-1)xui.arr.removeFrom(c[topic],i);
        return c[topic].push({id:subscriber,receiver:receiver,asy:!!asy});
    },
    unsubscribe:function(topic, subscriber){
        var c=xui.$cache.subscribes,i;
        if(!subscriber){
            if(topic===null||topic===undefined)
                c={};
            else
                delete c[topic];
        }else if(c[topic]){
            i=xui.arr.subIndexOf(c[topic],"id",subscriber);
            if(i!=-1)xui.arr.removeFrom(c[topic],i);
        }
    },
    publish:function(topic, args, subscribers, scope){
        var c=xui.$cache.subscribes;
        if(topic===null||topic===undefined){
            for(var topic in c){
                xui.arr.each(c[topic],function(o){
                    if(!subscribers || subscribers===o.id || (xui.isArr(subscribers)&&xui.arr.indexOf(subscribers,o.id)!=-1)){
                        if(o.asy)
                            xui.asyRun(o.receiver, 0, args, scope);
                        else
                            return xui.tryF(o.receiver, args, scope, true);
                    }
                });
            }
        }else if(c[topic]){
            xui.arr.each(c[topic],function(o){
                if(!subscribers || subscribers===o.id || (xui.isArr(subscribers)&&xui.arr.indexOf(subscribers,o.id)!=-1)){
                    if(o.asy)
                        xui.asyRun(o.receiver, 0, args, scope);
                    else
                        return xui.tryF(o.receiver, args, scope, true);
                }
            });
        }
    },
    getSubscribers:function(topic){
        return (topic===null||topic===undefined)?xui.$cache.subscribes:xui.$cache.subscribes[topic];
    },

    setDateFormat:function(format){xui.$dateFormat=format},
    getDateFormat:function(format){return format||xui.$dateFormat||xui.$cache.data.$DATE_FORMAT},

    setAppLangKey:function(key){xui.$appLangKey=key},
    getAppLangKey:function(key){return xui.$appLangKey},
    getLang:function(){return xui.$localeKey},
    setLang:function(key,onOK,callback){
        var g=xui.getRes,t,v,i,j,f,m,z,a=[],l;
        xui.$localeKey=key;
        v = document.getElementsByTagName?document.getElementsByTagName('span'):document.all&&document.all.tags?document.all.tags('span'):null;
        if(!v)return;
        for(i=0;t=v[i];i++)if(t.id==xui.$localeDomId)a[a.length]=t;
        l=a.length;
        f=function(){
            var ff=function(){
                j=a.splice(0,100);
                for(i=0;t=j[i];i++)
                    if(t.className && typeof(v=g(t.className))=='string')
                        t.innerHTML=v;
                if(a.length)
                    xui.setTimeout(ff,0);
                xui.tryF(callback,[a.length,l]);
                if(!a.length)
                    xui.tryF(onOK,[0,l]);
            };
            ff();
        },
        z = 'xui.Locale.' + key,
        m=function(){
            var k=xui.$appLangKey;
            if(k)xui.include(z+'.'+k,xui.getPath('Locale.' + key, '.js'),f,f);
            else f();
        };
        // use special key to invoid other lang setting was loaded first
        xui.include(z+'.inline.$_$', xui.getPath(z, '.js'),m,m);
    },
    getTheme:function(a){
        try{
            a=xui.CSS.$getCSSValue('.setting-uikey','fontFamily');
        }catch(e){}finally{
            return a||"default";
        }
    },
    setTheme:function(key, refresh, onSucess, onFail, tag){
        key=key||'default';
        var okey=xui.getTheme();
        if(key!=okey){
            var onend=function(onSucess){
                if(okey!='default'){
                    var style;
                    while(style=xui.CSS.$getCSSValue('.setting-uikey','fontFamily',okey)){
                        style.disabled=true;
                        style.parentNode.removeChild(style);
                        style=null;
                    }
                }
                if(refresh!==false)
                    xui.CSS.adjustFont();
                xui.tryF(onSucess);
            };
            if(key=='default'){
                onend(onSucess);
            }else{
                try{
                    var tkey=xui.CSS.$getCSSValue('.setting-uikey','fontFamily');
                }catch(e){}finally{
                    if(tkey==key){
                        xui.tryF(onSucess);
                        return;
                    }else{
                        var id='theme:'+key,
                            path=xui.getPath('xui.appearance.' +key,'');
                        if(tag){
                            xui.getFileAsync(path+'theme.css', function(rsp){
                                rsp = xui.replace(rsp, [
                                    [/(\/\*[^*]*\*+([^\/][^*]*\*+)*\/)/,'$0'],
                                    [/\{[^}]*\}/,'$0'],
                                    [/([^\/{},]+)/, function(a){
                                        // protect '.setting-uikey'
                                        return xui.str.endWith(a[0],'.setting-uikey')?a[0]:a[0].replace(/([^\s>]+)/,"$1"+tag)
                                    }]
                                ]);
                                rsp=rsp.replace(/url\(([^)]+)\)/g, "url("+path+"$1)");
                                xui.CSS._appendSS(xui('head'), rsp, id, false);
                            });
                        }else
                            xui.CSS.includeLink(path+'theme.css',id);
                    }
                    var count=0,fun=function(){
                        // timeout: 21 seconds
                        if(count++>20){
                            fun=count=null;
                            if(false!==xui.tryF(onFail))
                                throw 'errLoadTheme:'+key;
                            return;
                        }
                        //test
                        try{
                            var tkey=xui.CSS.$getCSSValue('.setting-uikey','fontFamily');
                        }catch(e){}finally{
                            if(tkey==key){
                                onend(onSucess);
                                fun=count=null;
                            }else{
                                xui.asyRun(fun,100*count);
                            }
                        }
                    };fun();
                }
            }
        }else{
            xui.tryF(onSucess);
        }
    },
    reLayout:function(){
        if(xui.UI)xui.UI.getAll().reLayout(true);
    },
    _langParamReg:/\x24(\d+)/g,
    _langscMark:/[$@{][\S]+/,
     // locale  pattern  :  $*  $a  $a.b.c  $(a.b.c- d)
     // variable pattern: @a.b.c@  @a@  {!}  {a.b.c}
    _langReg:/((\$)([^\w\(]))|((\$)([\w][\w\.-]*[\w]+))|((\$)\(([\w][\w\.]*[^)\n\r]+))\)|((\$)([^\s]))|((\@)([\w][\w\.]*[\w]+)(\@?))|((\@)([^\s])(\@?))|((\{)([~!@#$%^&*+-\/?.|:][\w\[\]]*|[\w\[\]]+(\(\))?(\.[\w\[\]]+(\(\))?)*)(\}))/g,
    _escapeMap:{
        "$":"\x01",
        ".":"\x02",
        "-":"\x03",
        ")":"\x04",
        "@":"\x05"
    },
    _unescapeMap:{
        "\x01":"$",
        "\x02":".",
        "\x03":"-",
        "\x04":")",
        "\x05":"@"
    },
    //test1: xui.getRes("start.a.b.c $0 $1 ($- $. $$) end-1-2")  => "c 1 2 (- . $) end"
    //tset2: xui.getRes( ["a","b","c $0 $1 ($- $. $$) end"],1,2) => "c 1 2 (- . $) end"
    getRes:function(path){
        var arr,conf,tmp,params=arguments,rtn;
        if(xui.isStr(path)){
            path=path.replace(/\$([$.-])/g,function(a,b){return xui._escapeMap[b]||a;});
            if(path.charAt(0)=='$')path=path.slice(1);
            if(path.indexOf('-')!=-1){
                tmp=path.split('-');
                path=tmp[0];
                params=tmp;
            }else if(xui.isArr(params[1])){
                params=params[1];
                params.unshift(path);
            }
            arr=path.split(".");
            arr[arr.length-1]=arr[arr.length-1].replace(/([\x01\x02\x03\x04])/g,function(a){return xui._unescapeMap[a];});
        }else if(xui.isArr(path)){
            arr=path;
        }else{
            return path;
        }
        conf=xui.get(xui.Locale[xui.$localeKey], arr);
        if((tmp=typeof conf)=='function'){
           return conf.apply(null,params) ;
        }else if(tmp=='object'){
            return conf;
        }else{
            conf = tmp=='string' ? conf.replace(/\$([$.-])/g,function(a,b){return xui._escapeMap[b]||a;}) : arr[arr.length-1];
            rtn = params.length>1 ? conf.replace(xui._langParamReg,function(z,id,k){k=params[1+ +id];return (k===null||k===undefined)?z:k}) : conf;
            return rtn.replace(/([\x01\x02\x03])/g,function(a){return xui._unescapeMap[a];});
        }
    },
    wrapRes:function(id){
        if(!xui.isStr(id))return id;
        var i=id, s,r;
        if(i.charAt(0)=='$')arguments[0]=i.substr(1,i.length-1);
        s=id;
        r= xui.getRes.apply(null,arguments);
        if(s==r)r=i;
        return '<span id="'+xui.$localeDomId+'" class="'+s.replace(/([\x01\x02\x03\x04])/g,function(a){return '$'+xui._unescapeMap[a];})+'" '+xui.$IEUNSELECTABLE()+'>'+r+'</span>';
    },
    //test1: xui.adjustRes("$(start.a.b.c $0 $1 ($- $. $$$) end-1-2)"); => "c 1 2 (- . $) end"
    adjustRes:function(str, wrap, onlyBraces, onlyVars, params, scope1, scope2){
        if(!xui.isStr(str))return str;
        wrap=wrap?xui.wrapRes:xui.getRes;
        str=str.replace(/\$([\$\.\-\)])/g,function(a,b){return xui._escapeMap[b]||a;});
        str=xui._langscMark.test(str) ?  str.replace(xui._langReg, function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){
                    // protect $@{
            return c=='$' ? onlyVars?a:d :
                    // $a.b.c-1-3
                    f=='$' ? onlyVars?a:wrap(g,params) :
                    // $(a.b.c-d) 
                    i=='$' ? onlyVars?a:wrap(j,params) : 
                    // $a
                    l=='$' ? onlyVars?a:wrap(m,params) :
                    // variable: @a@ @a.b.c@ {a.b.c}
                     ((onlyBraces?0:(o=='@'||s=='@'))||w=="{") ? ((z=xui.SC.get(o=="@"?p:s=="@"?t:x, scope1, scope2)) || (xui.isSet(z)?z:""))
                     : a;
            }): str;
            return str.replace(/([\x01\x02\x03\x04])/g,function(a){return xui._unescapeMap[a];});
    },
    adjustVar:function(obj,scope1,scope2){
        var t;
        return typeof(obj)=="string" ?
                    obj=="{[]}"?[]:
                    obj=="{{}}"?{}:
                    obj=="{}"?"":
                    obj=="{true}"?true:
                    obj=="{false}"?false:
                    obj=="{NaN}"?NaN:
                    obj=="{null}"?null:
                    obj=="{undefined}"?undefined:
                    obj=="{now}"?new Date():
                    (t=/^\s*\{((-?\d\d*\.\d*)|(-?\d\d*)|(-?\.\d\d*))\}\s*$/.exec(obj))  ? parseFloat(t[1]):
                    // {a.b(3,"a")} 
                    // scope allows hash only
                    (t=/^\s*\{([\w\.]+\([^)]*\))\s*\}\s*$/.exec(obj)) && (scope1||scope2) && xui.isHash(scope1||scope2) ? (new Function("try{return this." + t[1] + "}catch(e){}")).call(scope1||scope2)  :
                    //{a.b.c} or {prf.boxing().getValue()}
                    (t=/^\s*\{([^}]+)\}\s*$/.exec(obj))  ?
                    xui.SC.get(t[1], scope1, scope2)
                   : xui.adjustRes(obj, false, true, true, null, scope1, scope2)
                   : obj;
    },
    _getrpc:function(uri,query,options){
        var t = (options&&options.proxyType) ? options.proxyType.toLowerCase() : "";

        return (t=="sajax"||t=="jsonp") ? xui.JSONP 
        : (t=="iajax"||t=="xdmi") ? xui.XDMI 
        : (t=="ajax") ? xui.Ajax
        // include a file => XDMI
        : (typeof query=='object' && ((function(d){if(!xui.isHash(d))return 0; for(var i in d)if((d[i] && d[i].nodeType==1 && d[i].nodeName=="INPUT") || (d[i] && d[i].$xuiFileCtrl))return 1})(query))) ? xui.XDMI
        // post: crossdomain => XDMI, else Ajax
        : (options&&options.method&&options.method.toLowerCase()=='post') ?  xui.absIO.isCrossDomain(uri) ? xui.XDMI  : xui.Ajax
        // get : crossdomain => JSONP, else Ajax
        : xui.absIO.isCrossDomain(uri) ? xui.JSONP : xui.Ajax;
    },
    request:function(uri, query, onSuccess, onFail, threadid, options){
        return xui._getrpc(uri, query, options).apply(null, arguments).start();
    },
    ajax:function(uri, query, onSuccess, onFail, threadid, options){
        return xui.Ajax.apply(null, arguments).start();
    },
    jsonp:function(uri, query, onSuccess, onFail, threadid, options){
        return xui.JSONP.apply(null, arguments).start();
    },
    xdmi:function(uri, query, onSuccess, onFail, threadid, options){
        return xui.XDMI.apply(null, arguments).start();
    },
    restGet:function(uri, query, onSuccess, onFail, threadid,options){
        if(!options) options={};options.method="get";
        return xui.Ajax(uri, query, onSuccess, onFail, threadid, options).start();
    },
    restPost:function(uri, query, onSuccess, onFail, threadid,options){
        if(!options) options={};options.method="post";
        return xui.Ajax(uri, query, onSuccess, onFail, threadid, options).start();
    },
    restPut:function(uri, query, onSuccess, onFail, threadid,options){
        if(!options) options={};options.method="put";
        return xui.Ajax(uri, query, onSuccess, onFail, threadid, options).start();
    },
    restDelete:function(uri, query, onSuccess, onFail, threadid,options){
        if(!options) options={};options.method="delete";
        return xui.Ajax(uri, query, onSuccess, onFail, threadid, options).start();
    },
    getFileSync:function(uri, onSuccess, onFail, options){
        return xui.Ajax(uri, xui._rnd(),onSuccess,onFail, null, xui.merge({asy:false, rspType:options&&options.rspType||"text"},options,'without')).start()||null;
    },
    getFileAsync:function(uri, onSuccess, onFail, threadid, options){
        xui.Ajax(uri,xui._rnd(),onSuccess, onFail,threadid, xui.merge({asy:true, rspType: options&&options.rspType||"text"},options,'without')).start();
    },
    include:function(id,path,onSuccess,onFail,sync,options){
        if(id&&xui.SC.get(id))
            xui.tryF(onSuccess);
        else{
            options=typeof options=='object'?options:{};
            if(!sync){
                options.rspType='script';
                options.checkKey=id;
                xui.JSONP(path,xui._rnd(),onSuccess,onFail,0,options).start()
            }else{
                options.asy=!sync;
                xui.Ajax(path,xui._rnd(),function(rsp){
                    try{xui.exec(rsp,id)}
                    catch(e){xui.tryF(onFail,[e.name + ": " + e.message])}
                    xui.tryF(onSuccess);
                },onFail,0,options).start();
                }
        }
    },
    mailTo:function(email, subject,body,cc,bcc){
       if(xui.isHash(subject)){
            bcc = subject.bcc||"";
            cc = subject.cc||"";
            body = subject.body||"";
            subject = subject.subject||"";
       }
       var url = 'mailto:'+email+
            '?subject=' +encodeURIComponent(xui.adjustRes(subject||""))
            + '&body= ' + encodeURIComponent(xui.adjustRes(body||""))
            + '&cc= ' + (cc||"")
            + '&bcc= ' + (bcc||"");
        xui.XDMI(url).start();
    },
    fetchClass:function(uri, onSuccess, onFail, onAlert, force, threadid, options){
        if(/\//.test(uri) && !/\.js$/i.test(uri))
            uri=uri+".js";
        options=options||{};
        var isPath=/\.js$/i.test(uri), 
            c=xui.$cache.clsByURI,
            f=xui.$cache.fetching,
            cls,t;
        if(isPath){
            cls=xui.getClassName(uri);
            if(xui.SC.get(cls))
                isPath=false;
        }else{
             // special path( dont use any dynamic
             if(!options.hasOwnProperty('appPath') && window["/"])options.appPath=window["/"];
             cls=uri;
             uri=xui.getPath(uri,'.js','js',options);
         }
        if(!force && (isPath?((t=c[uri]) && t.$xui$):(t=xui.SC.get(cls))))
            xui.tryF(onSuccess,[uri,cls],t);
        else{
            // For fetching one class multiple times
            if(!f[uri]){
                f[uri]=[onSuccess=onSuccess?[onSuccess]:[], onFail=onFail?[onFail]:[], onAlert=onAlert?[onAlert]:[],[]];
                if((options&&options.crossDomain) || xui.absIO.isCrossDomain(uri)){
                    xui.Class._ignoreNSCache=1;xui.Class._last=null;
                    xui.JSONP(uri,xui._rnd(),function(){
                        if(xui.Class._last)t=c[uri]=xui.Class._last;
                        xui.Class._ignoreNSCache=xui.Class._last=null;
                        if(t){for(var i=0,l=onSuccess.length;i<l;i++)xui.tryF(onSuccess[i], [uri,t.KEY],t);}
                        else{for(var i=0,l=onFail.length;i<l;i++)xui.tryF(onFail[i],  xui.toArr(arguments));}
                        var s=xui.getClassName(uri);
                        if(t&&t.KEY!=s){
                            var msg="The last class name in '"+uri+"' should be '"+s+"', but it's '"+t.KEY+"'!";
                            for(var i=0,l=onAlert.length;i<l;i++)xui.tryF(onAlert[i], [msg, uri, s, t.KEY]);
                            xui.asyRun(function(){
                                throw msg;
                            });
                        }
                        // for Thread.group in fetchClasses
                        for(var i in f[uri][3])xui.Thread(f[uri][3][i]).abort();
                        if(f[uri]){f[uri][0].length=0;f[uri][1].length=0;f[uri][2].length=0;f[uri][3].length=0;f[uri].length=0;delete f[uri];}
                    },function(){
                        xui.Class._ignoreNSCache=1;xui.Class._last=null;
                        for(var i=0,l=onFail.length;i<l;i++)xui.tryF(onFail[i], xui.toArr(arguments));
                        // for Thread.group in fetchClasses
                        for(var i in f[uri][3])xui.Thread(f[uri][3][i]).abort();
                        if(f[uri]){f[uri][0].length=0;f[uri][1].length=0;f[uri][2].length=0;f[uri][3].length=0;f[uri].length=0;delete f[uri];}
                    },threadid,{rspType:'script'}).start();
                }else{
                    xui.Ajax(uri,xui._rnd(),function(rsp){
                        xui.Class._ignoreNSCache=1;xui.Class._last=null;
                        var scriptnode;
                        var s=xui.getClassName(uri);
                        try{scriptnode=xui.exec(rsp, s)}
                        catch(e){for(var i=0,l=onFail.length;i<l;i++)xui.tryF(onFail[i],[e.name + ": " + e.message]);xui.Class._last=null;}
                        if(xui.Class._last)t=c[uri]=xui.Class._last;
                        xui.Class._last=null;
                        if(t){for(var i=0,l=onSuccess.length;i<l;i++)xui.tryF(onSuccess[i], [uri,t.KEY],t);}
                        else{for(var i=0,l=onFail.length;i<l;i++)xui.tryF(onFail[i],  xui.toArr(arguments));}
                        if(t&&t.KEY!=s){
                            var msg="The last class name in '"+uri+"' should be '"+s+"', but it's '"+t.KEY+"'!";
                            for(var i=0,l=onAlert.length;i<l;i++)xui.tryF(onAlert[i], [msg, uri, s,  t.KEY]);
                            xui.asyRun(function(){
                                throw msg;
                            });
                        }
                        // for Thread.group in fetchClasses
                        for(var i in f[uri][3])xui.Thread(f[uri][3][i]).abort();
                        if(f[uri]){f[uri][0].length=0;f[uri][1].length=0;f[uri][2].length=0;f[uri][3].length=0;f[uri].length=0;delete f[uri];}
                    },function(){
                        xui.Class._ignoreNSCache=xui.Class._last=null;
                        for(var i=0,l=onFail.length;i<l;i++)xui.tryF(onFail[i], xui.toArr(arguments));
                        // for Thread.group in fetchClasses
                        for(var i in f[uri][3])xui.Thread(f[uri][3][i]).abort();
                        if(f[uri]){f[uri][0].length=0;f[uri][1].length=0;f[uri][2].length=0;f[uri][3].length=0;f[uri].length=0;delete f[uri];}
                    },threadid,{rspType:'text',asy:true}).start();
                }
            }else{
                if(onSuccess)f[uri][0].push(onSuccess);
                if(onFail)f[uri][1].push(onFail);
                if(onAlert)f[uri][2].push(onAlert);
                if(threadid){
                    f[uri][3].push(threadid);
                    xui.Thread(threadid).suspend();
                }
            }
        }
    },
    fetchClasses:function(uris, onEnd, onSuccess, onFail, onAlert, force, threadid, options){
        var hash={}, f=function(uri,i,hash){
            hash[i]=xui.Thread(null,[function(tid){
                xui.fetchClass(uri, onSuccess, onFail, onAlert, force, tid, options);
            }]);
        };
        for(var i=0,l=uris.length;i<l;i++)f(uris[i],i,hash);
        return xui.Thread.group(null, hash, null, function(){
            xui.Thread(threadid).suspend();
        }, function(){
            xui.tryF(onEnd,arguments,this);
            xui.Thread(threadid).resume();
        }).start();
    },
    // Recursive require
    require:function(clsArr, onEnd, onSuccess, onFail, onAlert,force, threadid, options){
        if(xui.isStr(clsArr))clsArr=[clsArr];
        var fun=function(paths, tid){
            xui.fetchClasses(paths,function(){ 
                var a2=[], t, r;
                for(var i=0,l=paths.length;i<l;i++){
                    t=xui.SC.get(paths[i]);
                    //collect  required class
                    if(t && (r=t.Required) && r.length){
                        for(var j=0,m=r.length;j<m;j++){
                            if(!xui.SC.get(r[j]))a2.push(r[j]);
                        }
                    }
                    // if it's module, collect required class in iniComponents
                    if(t && t['xui.Module'] && (t=t.prototype&&t.prototype.iniComponents)){
                        xui.fun.body(t).replace(/\bxui.create\s*\(\s*['"]([\w.]+)['"]\s*[,)]/g,function(a,b){
                            if(!(a=xui.SC.get(b))){
                                a2.push(b);
                                a=null;
                            }
                           // if(force && a && a['xui.Module']){
                           //     a2.push(b);
                           // }
                        });
                    }
                }
                if(a2.length){
                    fun(a2, null);
                }else{
                    var arr=[];
                    for(var i=0,l=clsArr.length;i<l;i++){
                        arr.push(xui.SC.get(clsArr[i]));
                    }
                    if(onEnd)onEnd.apply(null,arr);
                }
            },onSuccess,onFail,onAlert,force,tid,options);
        };
        fun(clsArr, threadid);
    },
    /*
    set application main function
    example:
        xui.main(function(){
            ...
        });
    */
    _m:[],
    main:function(fun){
        if(xui.arr.indexOf(xui._m, fun)==-1)
            xui._m.push(fun);
        // run it now
        if(xui.isDomReady){
            xui._domReadyFuns();
        }
    },
    /*
    key: xui.UI.xxx
    tag: file tag
    add: appearance or bahavior
    example:
        xui.getPath('xui.UI.Button','','appearance') => xui.ini.path + /appearance/UI/Button/
        xui.getPath('xui.UI.Button','.gif','appearance') => xui.ini.path + /appearance/UI/Button.gif
        xui.getPath('a.b','','appearance') => xui.ini.appPath + /a/appearance/b/"
        xui.getPath('a.b','.gif','appearance') => xui.ini.appPath + /a/appearance/b.gif"
    */
    getPath : function(key, tag, folder,options){
        key=key.split('.');
        if(folder){
            var a=[key[0],folder];
            for(var i=1,l=key.length;i<l;i++)
                a.push(key[i]);
            key.length=0;
            key=a;
        }

        var pre,ini=xui.ini,t,
            ensureTag=function(s){
                return s&&s.slice(-1)!="/" ? s+"/" : s ;
            };
        if(key[0]=='xui'){
            key.shift();
            if(key.length==(folder?1:0))key.push('xui');
            
            pre=ensureTag((options&&options.xuiPath)||ini.path);
        }else{
            if(key.length==((folder?1:0)+1) && tag=='.js')key.push('index');

            if(pre=ensureTag(options&&options.appPath)){
                if(t=(options&&options.verPath)) pre += ensureTag(t);
                if(t=(options&&options.ver)) pre += ensureTag(t);
            }else if(pre=ensureTag(ini.appPath)){
                if(t=ini.verPath) pre += ensureTag(t);
                if(t=ini.ver) pre += ensureTag(t);
            }
        }
        return pre + key.join('\/') + (tag||'\/');
    },
    getClassName:function(uri){
        if(uri&&xui.isStr(uri)){
            var a=uri.split(/\/js\//g),
                b,c,n=a.length;
            if(n>=2){
                // get the last one: any/js/any/App/js/index.js
                b=a[n-2].split(/\//g);
                b=b[b.length-1];
                a=a[n-1].replace(/\.js$/i,"");
                return (b+(a?".":"")+a.replace(/\//g,".")).replace(/^([^.]+)\.index$/,'$1');
            }
        }
    },
    log:xui.fun(),
    echo:xui.fun(),
    message:xui.fun(),

    //profile object cache
    _pool:[],
    getObject:function(id){return xui._pool['$'+id]},
    getObjectByAlias:function(alias){
        var o,a=[],l=0;
        for(var i in xui._pool){
            o=xui._pool[i];
            if(('alias' in o)&&o.alias===alias){
                a.push(o);
                l++;
            }
        }
        return l===0?null:l===1?a[0]:a;
    },
    _ghostDivId:"xui.ghost::",
    $getGhostDiv:function(){
        var pool=xui.$cache.ghostDiv,
            i=0,l=pool.length,p;
        do{p=pool[i++]}while(i<l && (p&&p.firstChild))
        if(!p || p.firstChild){
            p=document.createElement('div');
            p.id=xui._ghostDivId;
            pool.push(p);
        }
        return p;
    },
    //for handling dom element
    $xid:0,
    $registerNode:function(o){
        //get id from cache or id
        var id,v,purge=xui.$cache.domPurgeData;
        if(!(o.$xid && (v=purge[o.$xid]) && v.element==o)){
            id='!'+xui.$xid++;
            v=purge[id]||(purge[id]={});
            v.element=o;
            o.$xid=v.$xid=id;
        }
        o=null;
        return v;
    },
    getId:function(node){
        if(typeof node=='string')node=document.getElementById(node);
        return node ? window===node?"!window":document===node?"!document":(node.$xid||'') : '';
    },
    getNode:function(xid){
        return xui.use(xid).get(0);
    },
    getNodeData:function(node,path){
        if(!node)return;
        return xui.get(xui.$cache.domPurgeData[typeof node=='string'?node:xui.getId(node)],path);
    },
    setData:function(path,value){
        return xui.set(xui.$cache.data,path,value);
    },
    getData:function(path){
        return xui.get(xui.$cache.data,path);
    },
    setNodeData:function(node,path,value){
        if(!node)return;
        return xui.set(xui.$cache.domPurgeData[typeof node=='string'?node:xui.getId(node)],path,value);
    },
    $purgeChildren:function(node){
        var cache=xui.$cache,
            proMap=cache.profileMap,
            ch=cache.UIKeyMapEvents,
            pdata=cache.domPurgeData,
            handler=xui.Event.$eventhandler,
            // ie<=10
            children=(xui.browser.ie && node.all )? node.all : node.getElementsByTagName('*'),
            l=children.length,
            bak=[],
            i,j,o,t,v,w,id;
         for(i=0;i<l;i++){
            if(!(v=children[i]))continue;
            if(t=v.$xid){
                if(o=pdata[t]){
                    if(w=o.eHandlers){
                        if(xui.browser.isTouch && w['onxuitouchdown']){
                            if(v.removeEventListener){
                                v.removeEventListener("xuitouchdown", handler,false);
                            }else if(v.detachEvent){
                                v.detachEvent("xuitouchdown", handler);
                            }
                        }
                        for(j in w)
                            v[j]=null;
                    }
                    for(j in o)
                        o[j]=null;

                    delete pdata[t];
                }

                //remove the only var in dom element
                if(xui.browser.ie)
                    v.removeAttribute('$xid');
                else
                    delete v.$xid;
            }

            //clear event handler
            if(id=v.id){
                //clear dom cache
                //trigger object __gc
                if(id in proMap){
                     o=proMap[id];
                     if(!o)continue;
                     t=o.renderId;
                     if('!window'===t||'!document'===t)continue;

                     //don't trigger any innerHTML or removeChild in __gc()
                     o.__gc(true, true);
                     //clear the cache
                     bak[bak.length]=id;
                     //clear the cache shadow
                     if(o.$domId && o.$domId!=o.domId)
                        bak[bak.length]=o.$domId;
                }
            }
         }
         //clear dom cache
         for(i=0;i<bak.length;)
             delete proMap[bak[i++]];
         //clear dom content
         //while(node.firstChild)
         //   node.removeChild(node.firstChild);
         node.innerHTML='';
    },

    //create:function(tag, properties, events, host){
    create:function(tag,bak){
        var arr,o,t,me=xui.create,r1=me.r1||(me.r1=/</);
        if(xui.isArr(tag)){
            arr=[];
            for(var i=0,l=tag.length;i<l;i++)Array.prototype.push.apply(arr, xui.create(tag[i]).get());
            return xui(arr);
        }else if(typeof tag == 'string'){
            //Any class inherited from xui.absBox
            if(t=xui.absBox.$type[tag]){
                arr=[];
                //shift will crash in opera
                for(var i=1,l=arguments.length;i<l;i++)
                    arr[i-1]=arguments[i];
                o = new (xui.SC(t))(false);
                if(o._ini)o._ini.apply(o, arr);
            }else if( ((t=xui.SC.get(tag))&&t["xui.Module"]) || bak =="xui.Module" ){
                if(t){
                    o=new t();
                // use place holder to lazy bind
                }else{
                    o = new xui.UI.MoudluePlaceHolder();
                    xui.require(tag,function(module){
                         if(module&&module["xui.Module"]){
                            if(o.get(0).renderId){
                                var m=new module();
                                m.create(function(){
                                    o.replaceWithModule(m);
                                });
                            }else{
                                o.get(0)._module = new module();
                            }
                         }
                     }); 
                }
            //from HTML string
            }else if(r1.test(tag)){
                o = xui.str.toDom(tag);
            //from HTML element tagName
            }else{
                o=document.createElement(tag);
                o.id = typeof id=='string'?id:xui.id();
                o=xui(o);
            }
        //Any class inherited from xui.absBox
        }else{
            if(tag['xui.Module']){
                if( (t=xui.SC.get(tag.key)) && t["xui.Module"]){
                    o=new t(tag);
                // use place holder to lazy bind
                }else{
                    o = new xui.UI.MoudluePlaceHolder();
                    if(t=tag.events)o.setEvents(t);
                    if(t=tag.properties)o.setProperties(t);

                    if(tag.moduleClass && tag.moduleXid){
                        o.get(0).moduleClass = tag.moduleClass;
                        o.get(0).moduleXid = tag.moduleXid;
                    }
                    xui.require(tag.key, function(module){
                        if(module&&module["xui.Module"]){
                            var m=new module(tag);
                            m.create(function(){
                                o.replaceWithModule(m);
                            });
                         }
                     });
                }
            }else{
                o = new (xui.SC(tag.key))(tag);
            }
        }
        if(o['xui.absObj'] && (t=o.n0) && (t.host&&t.host!=t) &&  t.alias)o.setHost(t.host, t.alias);
        return o;
    },
    query:function(){
        return xui.doc.query.apply(xui.doc, arguments);
    },
    querySelector:function(){
        return xui.doc.querySelector.apply(xui.doc, arguments);
    },
    querySelectorAll:function(){
        return xui.doc.querySelectorAll.apply(xui.doc, arguments);
    },
    use:function(xid){
        var c=xui._tempBox||(xui._tempBox=xui()), n=c._nodes;
        n[0]=xid;
        if(n.length!=1)n.length=1;
        return c;
    }
});

/* xui.ini xui.browser dom ready
*/
new function(){
    var ini=xui.ini={};
    //special var
    if(window.xui_ini)
        xui.merge(ini,window.xui_ini);

    //browser sniffer
    var w=window, u=navigator.userAgent.toLowerCase(), d=document, dm=d.documentMode, b=xui.browser={
        kde:/webkit/.test(u),
        applewebkit:/applewebkit/.test(u),
        opr:/opera/.test(u),
        ie:(/msie/.test(u) && !/opera/.test(u)),
        newie:/trident\/.* rv:([0-9]{1,}[.0-9]{0,})/.test(u),
        gek:/mozilla/.test(u) && !/(compatible|webkit)/.test(u),

        isStrict:d.compatMode=="CSS1Compat",
        isWebKit:/webkit/.test(u),
        isFF:/firefox/.test(u),
        isChrome:/chrome/.test(u),
        isSafari:(!/chrome/.test(u)) && /safari/.test(u),

        isWin:/(windows|win32)/.test(u),
        isMac:/(macintosh|mac os x)/.test(u),
        isAir:/adobeair/.test(u),
        isLinux:/linux/.test(u),
        isSecure:location.href.toLowerCase().indexOf("https")==0,
        // detect touch for browser
        isTouch: !!(navigator.userAgent.match(/AppleWebkit.*Mobile.*/)
            || (("ontouchend" in d) && !(/hp-tablet/).test(u) ) 
            || (w.DocumentTouch && d instanceof DocumentTouch) 
            || w.PointerEvent 
            || w.MSPointerEvent),
        isIOS:/iphone|ipad|ipod/.test(u),
        isAndroid:/android/.test(u),
        isBB:/blackberry/.test(u) || /BB[\d]+;.+\sMobile\s/.test(navigator.userAgent)
    },v=function(k,s){
        s=u.split(s)[1].split('.');
        return k + (b.ver=parseFloat((s.length>0 && isFinite(s[1]))?(s[0]+'.'+s[1]):s[0]))
    };
   // for new device
    if(w.matchMedia && typeof w.matchMedia=='function'){
        // detect touch for device
        b.isTouch = w.matchMedia('(any-pointer: coarse)').matches;
        b.deviceType = b.isTouch 
            ? ( 
                (w.matchMedia('(any-hover: hover)').matches || w.matchMedia('(any-pointer: fine)').matches) 
                    ? 'hybrid'
                    : 'touchOnly'
            ) 
            : 'mouseOnly';
    }else{
        b.deviceType = b.isTouch ? 'touchOnly' : 'mouseOnly';
    }
    // fake touch
    if(xui.ini.fakeTouch && b.deviceType=='mouseOnly'){
        b.fakeTouch = true;
    }
    xui.$secureUrl=b.isSecure&&b.ie?'javascript:""':'about:blank';

    xui.filter(b,function(o){return !!o});
    if(b.newie){
        b["newie"+(b.ver=dm)]=true;
        b.cssTag1="-ms-";
        b.cssTag2="ms";
    }else if(b.ie){
        // IE 8+
        if(xui.isNumb(dm))
            b["ie"+(b.ver=dm)]=true;
        else
            b[v('ie','msie ')]=true;
        if(b.ie6){
            //ex funs for ie6
            try {document.execCommand('BackgroundImageCache', false, true)}catch(e){}
            w.XMLHttpRequest = function(){return new ActiveXObject("Msxml2.XMLHTTP")};
        }
        if(b.ie6||b.ie7)b.ie67=1;
        if(b.ie6||b.ie7||b.ie8)b.ie678=1;
        b.cssTag1="-ms-";
        b.cssTag2="ms";
    }else if(b.gek){
        b[v('gek',/.+\//)]=true;
        b.cssTag1="-moz-";
        b.cssTag2="Moz";
    }else if(b.opr){
        b[v('opr','opera/')]=true;
        b.cssTag1="-o-";
        b.cssTag2="O";
    }else if(b.kde){
        b[v('kde','webkit/')]=true;
        if(b.isSafari){
           if(/applewebkit\/4/.test(u))
                b["safari"+(b.ver=2)]=true;
           else if(/version/.test(u))
                b[v('safari','version/')]=true;
        }else if(b.isChrome)
            b[v('chrome','chrome/')]=true;

        if(b.isWebKit){
            b.cssTag1="-webkit-";
            b.cssTag2="Webkit";
        }else{
            b.cssTag1="-khtml-";
            b.cssTag2="Khtml";
        }
    }
    // BB 6/7 is AppleWebKit
    if(b.isBB && !b.ver){
        // BB 4.2 to 5.0
        b.ver=parseFloat(ua.split("/")[1].substring(0, 3));
        b["bb"+b.ver]=true;
    }

    if(!ini.path){
        var s,arr = document.getElementsByTagName('script'), reg = /js\/xui(-[\w]+)?\.js$/,l=arr.length;
        while(--l>=0){
            s=arr[l].src;
            if(s.match(reg)){
                ini.path = s.replace(reg,'').replace(/\(/g,"%28").replace(/\)/g,"%29");
                break;
            }
        }
    }
    xui.merge(ini,{
        appPath:location.href.split('?')[0].replace(/[^\\\/]+$/,''),
        dummy_tag:'$_dummy_$'
    },'without');
    if(!ini.path) ini.path=ini.appPath+'/xui/';
    if(!ini.basePath)ini.basePath=ini.path.replace(/xui\/$/,"").replace(/runtime\/$/,"");
    ini.releasePath=ini.appPath;
    if(ini.verPath)ini.releasePath+=(ini.verPath?(ini.verPath+"/"):"")+(ini.ver?(ini.ver+"/"):"");

    var data = new Image();
    data.onload = data.onerror = function(){
        var path=xui.ini.path+"appearance/_oldbrowser/";
        if(this.width != 1 || this.height != 1){
            document.documentElement.className += " xui-nodatauri";
            xui.merge(xui.ini,{
                img_dd: path+'ondrag.gif',
                img_busy: path+'busy.gif',
                img_pic: path+'picture.png',
                img_handler: path+'handler.gif',
                img_bg: path+'bg.gif',
                img_blank: path+'bg.gif',
                img_touchcur: path+'touchcur.png'
            },'without');
        }
        data.onload = data.onerror = null;
    };
    data.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
    xui.merge(xui.ini,{
        img_dd:     "data:image/gif;base64,R0lGODlhEABAAPcAAAAAAAEBAQICAgMDAwUFBAUFBQcHBwgICAkJCQwMDA8PDx4eHiQkJDAwMD8/P0JCQl1dXf///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAP8ALAAAAAAQAEAAAAj/AP8JHPigQQMHAxMOTAAAgIABAgAkUPgPQsMABAoQCNAQAISEFw0cMMCxI4CFAAIY+Eey4b+LCgSmXCnzpECVBf49AEBgJEWVBwg8WCCgQMuEQEkuYDBgo8uBIlsyeCCgJMWWAB68fPpP5cCOAhm6TLpV4teQI0tyrTgzrcmPChNoVIuAYsKCB+3qtQsgQt+/fgPb/Ce4MOCvEfb6HbhYb1/Eigc35ptYZmW7kw1rRgy48+S9oEOLHk26tGnRnlMzTl0Yst7Mgyk+tnzWpO3JfSPo3q274eXcfjv21rxbeHDBwE32VphbeHPmvYEvBzmc9+eXxa3Hxm69OHPbtk2zNO68WvNh2q8lb6fuuix434Ola5/Nvbt53tLhH8/unXpw49vlhx90/E2HmH3XyTcgSO91FBAAOw==",
        img_busy:  "data:image/gif;base64,R0lGODlhEAAQAOMAAAQCBHx+fLy+vOTm5ERCRMTGxISGhAQGBISChMTCxOzq7FRSVMzKzP7+/gAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJCQANACwAAAAAEAAQAAAESrDJSau9OOvNe1VFonCFIBRcIiQJp7BjNySDxRjMNAQBUk+FAwCAaiR6gURhsUgYhgCEZIDgDRYEwqIALTZmNay2UTB4KwKmwBIBACH5BAkJAA8ALAAAAAAQABAAgwQCBHx+fLy+vERCRKSmpOTi5BQWFNTW1KyurIyKjMTCxERGRPTy9BwaHLSytP7+/gRE8MlJq7046827n47RIJwBAEZ5phsikg9TMNZBHBMj7PR0DEDco7ATFA6JhA04IEh0AgUjEQgomcLY7EG1PmzZClJpiQAAIfkECQkADQAsAAAAABAAEAAABEewyUmrtcywWxn4BTcZH4CIUlGGaFMYbOsuSywuBLHIuC4LNEFrkBjIBoEAwmhRFBKKRDKQuBQEgsIAoWRWEoJEleitRKGWCAAh+QQJCQAPACwAAAAAEAAQAIMEAgR8fny8vrxEQkSkpqTk4uQUFhTU1tSsrqyMiozEwsRERkT08vQcGhy0srT+/v4ERfDJ6UxDM2sDgHkHcWgT5x1DOpKIhRDpQJAaqtK1iJNHkqy7RyIQSAQlw+IR5APiGAXGkiGoSoOFqqBwpAoU1yA0vJxEAAAh+QQJCQANACwAAAAAEAAQAAAES7DJWdYqMzdmWFsEsTRDMkwMoFbhMgQBcjaGCiCCJQhwkEgFG2YyQMRmjYJhmCkhNVBFoqCAQgu7nzWTECS0W4k0UQ2bz+i0en2OAAAh+QQJCQAPACwAAAAAEAAQAIMEAgR8fny8vrxEQkSkpqTk4uQUFhTU1tSsrqyMiozEwsRERkT08vQcGhy0srT+/v4ERfDJeVI6M79DcApB8jAFQy3DUIEJI7zmQ6RDZx3FKxTSQWMTl0AR23Q0o5LEYWggkEgDAGCAaqRUawbRfGq/4LB4TC5DIwAh+QQJCQANACwAAAAAEAAQAAAER7DJqUpSM7eRRkuCUGjSgAQIJyQJ+QXwxWLkAKeuxnm5VCyLVk+yIBAWQ6IRmRQABclJwcCIMg4AwGhoyAIQyYJ3O5ySo9EIACH5BAkJAA8ALAAAAAAQABAAgwQCBHx+fLy+vERCRKSmpOTi5BQWFNTW1KyurIyKjMTCxERGRPTy9BwaHLSytP7+/gRG8MlJ62SFWcuE19tUeEIRXp4Cng+2hkeSHKyUBEFSP3e+x7Od5ECg1Q6LwcB4IigHBETD4NgcngcDAGCAFR9a7g5hMCAsEQA7",
        img_pic:    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAJOgAACToB8GSSSgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA92SURBVHiczZt7fFTlmce/ZzKT66S5cQsChUC4yKVsFaEUYlAWi4ClfqTq6tYVrfVSy1W01roudPWj4H6ga6ygu3SpZdeu0iKIgLFoIZREBAIGSDDhHkLIhMncJzNz3v3jPScZkklyzkzYT5/5vJ9J5pzznvf3O8/7vM/zvM9RhBAkIoqiWAALYNNaMpCkHY4AIaBV+1aFEGpCN+xlURIhQAOfBKQCGUAmkI4kQUEC9wEewAv4gfDfEgnWeC9UFEVBPvk04BtAXyAXSUKqdloQCf4q4ABaAK+iKKG/FRLiJgAJPgUJuL/W+gHpAyBTBdEon74PqR2p2v0UJAmtZkjQCL9GRKLzlzgJiHr6KUAWkJMPgyfB8BkwdDjkW4DTcGU31B6D+jNgsUJSWF6nAJ6eSFAURcFJAWl8Cz9ZOKliPcd5iSAgFEVRkTzETURcNkCb+8lIlc8fDeN/CjO/D7f2gb5WsGoGIOSCli1QthEOfgE1yKlwCWhCTo+Y00HxKzeQyjsofO+aAxHqqWIR32I30rCGgEjcJAghTDek4csAhoyHO7fCe5ehQYCI1a6C869w8LvwPHA3UAwUAnlILbJc07+fIgTNiG4+VfwKyEfaH1vHPow2S1ysSVFSIHk2DJoKk/tJGxBTsiFrLIx6FeYXwY0a8IFIDbIDNk2rUAJKEal8BOR0e/fRrOBFpml9pANJsexET5IIAaIAlHtgUhbc0NPJmWCfCDe+Bt+fBqOJRYJTmaGBtxsYuY0fsRgYgLRDKYDFLAnxrgIqEJ4MDIZh1nbHp1vJgIwbYczLoD4P7IOTbQcrmEo2mzECXpc+FCI1L4D0MVq1sRmWRDQgMhWUTKmqhg1QJmRMhLFr4AdFuia8zmxu4j3MgJed5ZJEDlID0mlfZg1LXARoFlf9IzS0QoUwyXomZIyD0f8Kdw1/jNn8jNewkGZ6IE04iJBKu/dpSBOjJW5HSAihblCUsApVQi5pA8xcnwEZzmLGX1jLzVjj1MRTnEc+xCTa/YvrrwG6PCaEbyNsjMABs9d+VgT3bSctmBbnGAIEeJrdyIArrH2rmJiOkCABABUQcMEqAYeNXrPnVpi7A7wZcd9WsJZtHMaBNH5eZNxhPr4w6Pjorm90U9A8yR2Qch5GhOFAV86Q3v58KyLD062L09NH5U22ASuAx4F5wASgD9IOWLoab0xs3QH3+xkaibAyHOajcJjyQIC3Gxq4H2l0UpA2xAIo68HWBLcI+Or/AfxzwJPAAmAKMBiw4/PdQzi8nnC4nFBoB17vy3z++RhkIKYbScUQAeEwjwqBK9Zht5udK1cyFumGpugdb4P0Bhgfhr2dwBf3Avg3+Aj4OfAUcC8wDRjOW28VEgp9GBNIJOKhpmY50vHKoIPb3BX4BT3NDL+fc88+yzRkHqBtDV4ASZdgrArHosGnexME/zp/BlYCi4D7gOnACDZtGkckUtvjPC4tXappSpY+VWIS4HKRJwSXjcQSXi8XnniCmcigxK6TsB/SHDAlDOW9An4VB4H1wEvAo8BtwCg2bhxvCLwQgkDAye23/z0wlPYASon19P/BTEDl8XDxkUf4HjIeaCNhPdiKt/Ngqp9IvNAVFfHtxTj7wi7gbeBfgPuBSaxZc5Nh8Hr77W//DbhFG2s6YOlk7UMhXjdDgGYT6hcuZPY1JPi5HUHcz15REXOfQPwSgj+Guhvgv4EXgAd46KE5tLaeNjdKIfjss13AbGAM0oW3dvIDhCCl4289id1O/rp1/MfChUwAsjjGHVj5EEG62b4AFAFznoLv/gb6Q/IUyF8KE8dCDsXFfSkp2YDNNjSOrlOR6m9HWxU6usKKz8eRrCzzPesk1Exl3b5s/pkAaaSirQ/G+4kGn4lc3AdCagZ8c1BGxm0PvP/+4HBGRp75EQJHjtQjV60UtNWgkwYcPkypquKJp3+7nfxt97JsSCM+WpBBagTDzmkX4BkADIW0GV7viIfWrPEY7zFKgsEgGzee6vR7RxsApNTVscysHYhuzS6uDDlIMxcQuBGEEKjG5vwrIN4A8T8g/gKiBoQDRABECMQVcP9oxYpzCKGaGtWvf/1HYAnSiN6i8ZoSiwAbkFNfz5ZESHC00DSkAqcREoyAj2gtAKIWPD945pkLhknYt+8Q8CzwE2AuMBZpBG2dzkXO2vTsbL555gzbEyHhylWah5TT0h0JRsGrWguBaAFRCd55y5df6pGEsrJDWK3PA08jvcepSIcoHUiKRYCuBdmZmYyqrWXHdSRBvW0RLiPgda8yAiIIohnEIfDOWb68vksSysoOa+AXAQ/Qno3OpitHSCNB3/ToY7dz49dfs/M6kKAm/Ts7RsO6lVBrBHw0CQHtvEPgmRNLE/bu/Qqr9UVgMfAgcDsyBdeHqFR8l6PWSEgF+trtjO1lElTeYCvwnAWevgWW7oQ6I+CF9ns0CV+Cb240CXv21GC1rkFGjf8EzESm4/tqmNqCoS53hqK2v2xApt1O/8pKXi8oYFb3603X0uTk6k3VJJ3bSynPsB+ZzHDkgWMp5D4MP8+BiTbaA/quRGgthMyGnAHfi8uXt5TOmhUMzp69i0jEC9QDtfIwl5Cbs/o2fdtTjn0DeYKqXeD2eLg8+k/8/vOzVMVLQJ9scg6PJPSdLRxBbos5gAYHnF29cmX1iOZmb/WoUcf0/FZ3LoSe/LMhY9yhkL5qzZqsV2fN8g2JRNKQGaIQ0hvxaf9HosHrQLtt2n2SqGEml/FYqojsqeN4ItPh6lUai4tZBMwCxrJ69TgikWqEECk+X8P+wsJTzSC8mtXvaip0nA7NII6C9zdQWQjrkEmTecB4pPp33oYzMmLc3EoYN34EjQhLFZHSU9QkQkJLCw3z53M/jz46ndbWU9FHrR5P45ZRo47Vg3CDaDVIQhCEC0QdeLbCl38no8cFQBFQgIwDrERlhXoGLzcq3agIwog2Er5C3X2S2kRIONgw6ARe75lYR60uV9N7I0acO6+BMkpCSCPCAe49cGCKdIDmAZOQnnU6PWWE2g6GmK4tXEJLTXQm4QR18YCvduW3pLQ0NnZ3ltXpbN40cmS1URJ0IvTWAq59sL8IltG+DGYDth4J6AS+Iwm++Ek42ZLvSm6+5DBydpLL1fT7wsJaMyRENze4y2DvZHgYmT3ur9kCpUsC8DAAgaPL0CUBEk625LuSHfXNZvTF5nQ2by4sPK2T0JNhjFGfcOV92PRtmUobiKxriu0IAQoqW3rM2cQg4ZMeSIgHfLQmbBo58sR5zTCaJaERau6UgdAgjYDYGoCbvj2C75qESNkRjvU2eL31+fjj0r9C3SUQPs3oGSUgCIG9sGqcDITalsPOjpCNm7r1Zjp6I3q1kB3U3WwtnsTblZVURJ9W7cp3Twh/GW7Nze++6qM7KS+v8N111x9Ww6uX4ZBeCGA0M5IESf0hq0j+23bpNQQoiqKgkm1qYDoJ/8V2lrI/FCI4ZQolx49TBlDjzndNiBwKJQS+rOww06Z94AuF1K1wvgReCMFxM2khBUKZQKHcSA3rv3fWgEYqTQ/wbT7iCcqQvr0zEODS5Mm8uK1q2M4JHA205gzINd2nPvD9ZUcoLv6AcDgI+CLgKYW6Y/AzAUdMdBWKwL4T0CI0gVgEzKSOCLWGu32HHfyEfYCb9hK4i56HnvLfVVA1OpjZp5+JQV4jeeU7zj6/s2jQ4PxwCjKQcQCO0+BYCxUn4F4VvjDQlVBlUHR+vRC+a490XAHAxiFmIwxsaLzDDmTI+VNktqUIGMnq1eMIhWoSMXh55TvO/OplS2TtWsRbb3F54kQeQ26EDkGmtZNeAqsXJgm5IRvqwgCqETjph0diLvkxlsEkIJOj/JIwgZjAAwRYwwdIN/Mp5F5dEVBISckYPbDpDfC/+x2itBRRUUH9vHnMR25tZaFldE5BihOGqfC+KmsVVc0jjKgQUOFkCJa9BNZYt+uUD4iqAs1mCZN5jEX0YwzZ9OUKTZziPMsppZwmZCjuABqABkpKrDz++J+wWEYaU/LOklfx8dkln84dbE9XLXl5kJ8vW9++ANQvXszCzZupApxoiXchhLisKBm5cE8STFJk4OMX8JkKR6xC7O3qfrEIUDQtSEPW8A0A+pNEjlaQlISMq/3aIK4AjZSUJCcM/uDOs0s+mRMTfGYm2Gzg83HhySdZ+O67HIf23QchhEBRrC2QaYPUdAhfhdYcIVq6u2fMjJBGghUZOWXBNaVoOgFebQBOXnnFyooVH19v8BYLKAq43Vz44Q/5x507OYV8CEHirBfuLiWmV1+lILUhTfvbgiRAfxkiQCj0n1itC+IBDpB3cNe5JZ/cOcierlpyc2HgwK7B61JXx1+GD2cRcBn5IIJ0zPYYkO5SYirSYfBrN2hCLnH1yDnfBLjweot7E3z0k7fbY4MHKCigqKSEecgsbwZxFElCD1ViGpt6XlAvR/Vp3wEgRHLyDLM3bZMDByoXbLzTEQ1+4MB28MnJscHrMmEC30Gmutpqhc0OoccLRLuoQohIVJMlaYoy3uxNASgvr2T69P99Z4O62e3mC7PgAQYMYCjSPn0DLd1tdhiJ1gkqqGqz6avKyyuZNu0PhMPecBjHqlWsDoX43Ax4gJYWAkj1z6C9WMuUJFwoSSh0zNT5UeCBZqC+tZVz993Hc01NfGoUPEB1NQ20v65nshJBSuIE7Nu3GVV1Gjq3vPxoR/DAReCiy8WFqVNZdvYsnxoB7/fjf+01vkSGtaZLZHVJnIA77rhEdfULPZ5XXn6UoqJo8PqKcgW5ljudThpuvpklp0/zaU/drVvH9spKmpHGWN8EuT6lsl012jdnctm162n8/s6JzmAwyJtvfojF8hxyi/pB2vfq+iH9C6vW0oB+ycmM3bWLdaEQ/o63dblw/eIXvAs8A/wYmIPc788lKttrtCX05ii0OUypQC7Tp4/i4YdnM2zYOBQlnaNH69m06WsOHtSLmp1AI+1+hJtr3/LQ45BMoM/8+Yy7+25mFBQwyuuFQ4eo37CB6tOncdO+tXYRqUnNQECYfCGzNwjQ3eY05JLUD+mc6GW0oO0vaoNs0r69aOB17y1qQzYZadlztb70N1JtWn9BwKX11Yh8M1V/LdcUoETeHAWkn6Aoih4cgfQePciYPZoAD5IEN9KZCtPBddX6UmnXighyjrdo/UUT4EGS4Nbu3buxgOmO2qPIZK3p1eQKEmyrNvBWtI3frgas9RXdX4r2bUVa+3BUX60k8OJkrxEAnQau1+mDfJptzehgo6ZEdIvur1sijcj/AcgCrHU5y1W7AAAAAElFTkSuQmCC",
        img_handler:"data:image/gif;base64,R0lGODlhBAAEAPcAAAAAAGSMtP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAP8ALAAAAAAEAAQAAAgPAP8JFCDwX4B/BAUe/BcQADs=",
        img_touchcur:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAATCAMAAACqTK3AAAAAnFBMVEVKS0sAAAD6+vr39/fj4+OsrKxQUVHk5OTY2NjV1dVgYWHm5ube3t7c3NzV1dXT09PPz8/q6ur19fXNzc2/v7/v7+/u7u6QkJB1dnbt7e1SU1Pd3d3b29vW1tbU1NTT09Ps7Ozl5eXe39/e3t709PS7u7u5ublmZ2fp6enn5+fj4+Ph4eHg4ODc3Nzc3NzZ2dnZ2dnW1tbU1NTT09Pxrtv7AAAANHRSTlPmAP78+fHnyPf26NGiizAcBfr49fPu7e3q6Oedh08oDPr5+Pj38vLp3NfBuLGUkXRrSzgYlzzxjwAAAKFJREFUGNNl0NUOwzAMQFE7sDLzSmPm/f+/LY2atVXv45FlyQac1ZPnaCfLdgdqr4TF/KATq+nJS1gOXWZE35L8wlhAHw+bjuxAiCqyOgozGDKJC1hTGKeXgM52QnsN0DYmxM9iik0oFlMuWY6JVYCY8JHk5CvoSc2/LNY3edAlOCox0laSr1Eu92WrwlPPeaWE6Ru6u/soSfapyketXjjrB1sXCDrwyo6RAAAAAElFTkSuQmCC',
        // transparent 1*1 gif and png
        img_bg:     data.src,
        img_blank: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII="
    },'without');

    //for dom ready
    var f = xui._domReadyFuns= function(){
        if(!xui.isDomReady){
            if(d.addEventListener ) {
              d.removeEventListener("DOMContentLoaded", f, false );
              w.removeEventListener("load", f, false );
            } else if(d.detachEvent){
              d.detachEvent("onreadystatechange", f);
              w.detachEvent("onload", f);
            }

            // adjust touchonly again
            if(xui.browser.deviceType != 'touchOnly' && !xui.Dom.getScrollBarSize()){
                // in Mac, the element barsize is 0 without mouse device plugged
                // and if you plug the mouse, barsize will be 15

                //xui.browser.deviceType = 'touchOnly';
                if(xui.UI){
                    var f2=function(c){
                        xui.arr.each(c,function(key){
                            if(key=xui.SC.get(key)){
                                if(key.$DataModel.overflow){
                                    key.$DataModel.overflow.ini='auto';
                                    key.$DataStruct.overflow='auto';
                                }
                                if(key.$children && key.$children.length)f2(key.$children);
                            }
                        });
                    };
                    f2(xui.UI.$children);
                }
            }
        }

        try{
            if(xui.ini.customStyle&&!xui.isEmpty(xui.ini.customStyle)){
                var arr=[],style=xui.ini.customStyle,txt;
                xui.each(style,function(v,k){arr.push(k+" : "+v+";")});
                txt=".xui-custom{\r\n"+arr.join("\r\n")+"\r\n}";
                xui.CSS.addStyleSheet(txt,"xui:css:custom",1);
            };
            for(var i=0,l=xui._m.length;i<l;i++)
                xui.tryF(xui._m[i])
            xui._m.length=0;
            xui.isDomReady=true;
        }catch(e){
            xui.asyRun(function(){throw e})
        }
    };

    if (d.addEventListener){
        d.addEventListener("DOMContentLoaded", f, false);
        w.addEventListener("load", f, false);
    }
    //IE<=10
    else{
    d.attachEvent("onreadystatechange", f);
        w.attachEvent("onload", f);

        var ff=function(){
            if(xui.isDomReady)return;
            try{
                //for ie7 iframe(doScroll is always ok)
                d.activeElement.id;
                d.documentElement.doScroll('left');f()
            }catch(e){xui.setTimeout(ff,9)}
        };
        ff();
    }

    // to ensure
    var fe=function(){
        ((!xui.isDomReady)&&((!d.readyState)||/in/.test(d.readyState)))?xui.setTimeout(fe,9):f()
   };
   fe();
};

// for loction url info
new function(){
    xui._uriReg=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/;
    xui._localReg=/^(?:about|app|app\-storage|.+\-extension|file|widget):$/;
    xui._curHref=(function(a){
        try{return location.href;}catch(e){
            a=document.createElement("a");
            a.href="";
            return a.href;
        }})(),
    xui._localParts=xui._uriReg.exec(xui._curHref.toLowerCase())||[];
};

new function(){
    xui.pseudocode={
        getScope:function(eventArgs, module, temp){
            return {
                    temp:temp,
                    page:module,
                    args:eventArgs,
                    functions:xui.$cache.functions,
                    'constant':xui.constant,
                    'global':xui.$cache.data,
                    // special functions
                    getCookies:xui.Cookies.get,
                    getFI:function(key){var h=xui.getUrlParams();return h&&h[key]}
                };
        },
        exec:function(_ns, conf, resumeFun, level){
           var  ns=this,t,tt,m,n,p,k,arr,type=conf.type||"other",
                comparevars=function(x,y,s){
                    switch(xui.str.trim(s)){
                        case '=':
                        case 'is':
                            return x===y;
                        case '<>':
                        case 'is-not':
                        case '!=':
                            return x!==y;
                        case 'exists':
                        case 'defined':
                            return xui.isDefined(x);
                        case 'not-exists':
                        case 'undefined':
                            return !xui.isDefined(x);
                        case 'empty':
                            return xui.isEmpty(x);
                        case 'non-empty':
                            return !xui.isEmpty(x);
                        case '>':
                            return parseFloat(x)>parseFloat(y);
                        case '<':
                            return parseFloat(x)<parseFloat(y);
                        case '>=':
                            return parseFloat(x)>=parseFloat(y);
                        case '<=':
                            return parseFloat(x)<=parseFloat(y);
                        case 'include':
                            return (x+"").indexOf(y+"")!=-1;
                        case 'exclude':
                            return (x+"").indexOf(y+"")==-1;
                        case 'begin':
                            return (x+"").indexOf(y+"")===0;
                        case 'end':
                            return (x+"").indexOf(y+"")===(x+"").length-(y+"").length;
                        case "objhaskey":
                            return typeof(x)=="object"?(y in x):false;
                        case "objnokey":
                            return typeof(x)=="object"?!(y in x):false;
                        case "arrhasvalue":
                            return xui.isArr(x)?xui.arr.indexOf(x,y)!==-1:false;
                        case "arrnovalue":
                            return xui.isArr(x)?xui.arr.indexOf(x,y)==-1:false;
                        case "objarrhaskey":
                            return xui.isArr(x)?xui.arr.subIndexOf(x,'id',y)!==-1:false;                        
                        case "objarrnokey":
                            return xui.isArr(x)?xui.arr.subIndexOf(x,'id',y)==-1:false;                        
                        default:
                            return false;
                    }
                },
                adjustparam=function(o){
                    if(typeof(o)=="string"){
                        var jsondata,oo;
                        if(xui.str.startWith(o,"[data]")){
                            o=o.replace("[data]","");
                            jsondata=1;
                        }
                        o=xui.adjustVar(oo=o, _ns);
                        if(!xui.isDefined(o))o=xui.adjustVar(oo);
                        // for file
                        if(jsondata && typeof(o)=="string")
                            o=xui.unserialize(xui.getFileSync(o));
                    }else if(xui.isHash(o)){
                        // one layer
                        for(var i in o)o[i]=adjustparam(o[i]);
                    }else if(xui.isArr(o)){
                        // one layer
                        for(var i=0,l=o.length;i<l;i++)o[i]=adjustparam(o[i]);
                    }
                    return o;
                },
                redirection=conf.redirection,
                target=conf.target,
                method=conf.method,
                // conf.args > conf.params
                iparams=xui.clone(conf.args||conf.params)||[],
                conditions=conf.conditions||[],
                adjust=adjustparam(conf.adjust)||null,
                iconditions=[],t1,t2,
                timeout=xui.isSet(conf.timeout)?parseInt(conf.timeout,10):null;
            
            var _debug = [conf.desc + " - "+ type +" > " + target +" > " +  method]; 

            // cover with inline params
            if(method.indexOf("-")!=-1){
                t=method.split("-");
                method=t[0];
                for(var i=1,l=t.length;i<l;i++)
                    if(t[i])iparams[i-1]=t[i];
            }
            // handle conditions
            // currently, support and only
            // TODO: complex conditions
            for(var i=0,l=conditions.length,con;i<l;i++){
                con=conditions[i];
                if(!comparevars(
                    !xui.isDefined(t1=xui.adjustVar(con.left, _ns))?xui.adjustVar(con.left):t1,
                    !xui.isDefined(t2=xui.adjustVar(con.right, _ns))?xui.adjustVar(con.right):t2,
                    con.symbol)){
                    if(typeof resumeFun=="function"){
                        xui._debugInfo.apply(xui, [xui.str.repeat('|', level||1) +" x ", _debug, conf]);
                        return resumeFun();
                    }
                    xui._debugInfo.apply(xui, [xui.str.repeat('|', level||1) +" x ", _debug, conf]);
                    return;
                }
            }
            if(redirection && (arr = redirection.split(":")) && xui.isArr(arr)){
                if(arr[0])type = arr[0];
                if(arr[1])target = arr[1];
                if(arr[2])method = arr[2];
            }
            if(target && method && target!="none"&&method!="none"){   
                //adjust params
                for(var i=redirection?3:(type=="other" && target=="callback")?method=="call"?1:method=="set"?2:0:0,l=iparams.length;i<l;i++)
                    iparams[i]=adjustparam(iparams[i]);

                if(redirection && !(type=="other" && target=="callback"&& method=="call")){
                    iparams=iparams.slice(3);
                }

                var fun=function(){
                    if(false===xui.tryF(ns._Handlers, [type, method, iparams, adjust, target, conf]))return;
                    switch(type){
                        case 'page':
                            // handle switch
                            if(method=="switch"){
                                if(!xui.History._callbackTag){
                                    xui.History._callbackTag = function(fi,init){
                                       if(init)return;
                                       var ar=xui.urlDecode(fi||"");
                                       if(!ar.cls){
                                            ar.cls="App";
                                            ar.cache=true;
                                        }
                                        // get root only
                                        xui('body').children().each(function(xid){
                                            var module=xui.Module.getFromDom(xid);
                                            if(module && module._showed){
                                                if(ar.cache)module.hide();else module.destroy();
                                            }
                                        });   
                                        xui.showModule(ar.cls);
                                        return false;
                                    };
                                }
                                var hash={
                                    cls:target,
                                    cache:!!iparams[0]
                                };
                                if(iparams[1] && !xui.isEmpty(iparams[1])){
                                    hash=xui.merge(hash,iparams[1]);
                                }
                                xui.History.setFI(hash,true);
                                return;
                            }else if(method=="open"){
                                var hash={
                                    cls:target
                                };
                                if(iparams[0] && !xui.isEmpty(iparams[0])){
                                    hash = xui.merge(hash, iparams[0]);
                                }
                                window.open('#!'+xui.urlEncode(hash));
                                return;
                            }
                            // try to get module
                           var cls=xui.get(window,target.split(".")),ins;
                            // TODO: now, only valid for the first one
                            if(cls)for(var i in cls._cache){ins=cls._cache[i];break;}
                            
                            if(method=="destroy"){
                                if(ins)if(xui.isFun(t=xui.get(ins,[method])))t.apply(ins,iparams);
                                return;
                            }else if(method=="show"){
                                // special for xui.Module.show
                                iparams.unshift(function(err,module){
                                    if(err){xui.message(err);}
                                });
                            }
                            if(ins){
                                if(xui.isFun(t=xui.get(ins,[method])))t.apply(ins,iparams);
                            }
                            // make sure call getModule once
                            else {
                                var t1 = _ns.temp._module_funs_ = _ns.temp._module_funs_|| {},
                                    t2 = t1[target] = t1[target] || [];
                                // collect funs
                                t2.push(function(ins,t){
                                    if(xui.isFun(t=xui.get(ins,[method])))t.apply(ins,iparams);
                                });
                                // Calling asyn call, but only for the first time
                                if(t2.length===1){
                                    xui.getModule(target,function(err,ins){
                                        if(err)return;
                                        if(ins)
                                            for(var i=0,l=t2.length;i<l;i++)
                                                t2[i].call(null, ins);
                                        t2.length=0;
                                        t1=t2=null;
                                        delete _ns.temp._module_funs_[target];
                                    });
                                }
                            }
                            break;
                        case 'control':
                        case 'module':
                            if(method=="disable"||method=="enable"){
                                if(xui.isFun(t=xui.get(_ns.page,[target,"setDisabled"])))t.apply(_ns.page[target],[method=="disable",true]);
                            }else{
                                if(method=="setProperties"){
                                    // [0] is native var, [1] is expression var
                                    var params=xui.merge(iparams[0], iparams[1], 'all');
                                    iparams[1]=null;
                                    if(m=params){
                                        if(m.CA){
                                            if(xui.isFun(t=xui.get(_ns.page,[target,"setCustomAttr"])))t.apply(_ns.page[target],[m.CA]);
                                            delete m.CA;
                                        }
                                        if(m.CC){
                                            if(xui.isFun(t=xui.get(_ns.page,[target,"setCustomClass"])))t.apply(_ns.page[target],[m.CC]);
                                            delete m.CC;
                                        }
                                        if(m.CS){
                                            if(xui.isFun(t=xui.get(_ns.page,[target,"setCustomStyle"])))t.apply(_ns.page[target],[m.CS]);
                                            delete m.CS;
                                        }
                                    }
                                }
                                if(xui.isFun(t=xui.get(_ns.page,[target,method])))t.apply(_ns.page[target],iparams);
                            }
                            break;
                        case 'other':
                            switch(target){
                                case 'url':
                                    switch(method){
                                        case "close":
                                            window.close();
                                            break;
                                        case "open":
                                            xui.Dom.submit(iparams[0],iparams[1],iparams[2],iparams[3]);
                                            break;
                                        case "mailTo":
                                            xui.mailTo.apply(xui,iparams);
                                            break;
                                        case "selectFile":
                                            xui.Dom.selectFile.apply(xui.Dom,iparams);
                                            break;
                                        case "readText":
                                            xui.getFileAsync.apply(xui,iparams);
                                            break;
                                        case "readJSON":
                                            iparams[4]={rspType:'json'};
                                            xui.getFileAsync.apply(xui,iparams);
                                            break;
                                    }
                                break;
                                case 'msg':
                                    if(method=="busy"||method=="free"){
                                        if(xui.isFun(t=xui.get(xui.Dom,[method])))t.apply(xui.Dom,iparams);
                                    }else if(method=="console" && xui.isDefined(window.console) && (typeof console.log=="function"))console.log.apply(console,iparams);
                                     else if(xui.isFun(t=xui.get(xui,[method]))) t.apply(xui,iparams);
                                break;
                                case "var":
                                    if(iparams[0].length){
                                        var v = iparams[1];
                                        if(iparams[2])
                                            v=xui.get(v, iparams[2].split(/\s*\.\s*/));
                                        if(adjust){
                                            switch(adjust){
                                                case "serialize":
                                                    v=xui.serialize(v);
                                                break;
                                                case "unserialize":
                                                    v=xui.unserialize(v);
                                                break;
                                                case "stringify":
                                                    v=xui.stringify(v);
                                                break;
                                                default:
                                                    if(typeof(adjust=xui.get(adjust))=="function")
                                                        v=adjust(v);
                                                break;
                                            }
                                        }
                                        xui.set(_ns, (method+"."+xui.str.trim(iparams[0])).split(/\s*\.\s*/), v);
                                    }
                                break;
                                case "callback":
                                    switch(method){
                                        case "setCookies":
                                            if(iparams[0]&&!xui.isEmpty(iparams[0]))xui.Cookies.set(iparams[0]);
                                            break;
                                        case "setFI":
                                            if(iparams[0]&&!xui.isEmpty(iparams[0]))xui.History.setFI(iparams[0],true,true);
                                            break;
                                        case "set":
                                            t=iparams[1];
                                            if(xui.isStr(t)&&/[\w\.\s*]+[^\.]\s*(\()?\s*(\))?\s*\}$/.test(t)){
                                                // args[0] => args.0
                                                t=t.replace(/\[(\d+)\]/,".$1");
                                                t=t.split(/\s*\.\s*/);
                                                if(t.length>1){
                                                    m=t.pop().replace(/[()}\s]/g,'');
                                                }else{
                                                    m=t[0].replace(/[{()}\s]/g,'');
                                                    t=["{window"];
                                                }
                                                t=t.join(".")+"}";
                                                t=xui.adjustVar(tt=t, _ns);
                                                if(!xui.isDefined(t))t=xui.adjustVar(tt);
                                                if(t && xui.isFun(t[m]))
                                                    xui.$cache.callback[iparams[0]]=[t,m];
                                            }
                                            break;
                                         case "call":
                                            var args=iparams.slice(3), doit,doit2;
                                            t=iparams[0];
                                            if(xui.isStr(t)&&/[\w\.\s*]+[^\.]\s*(\()?\s*(\))?\s*\}$/.test(t)){
                                                // args[0] => args.0
                                                t=t.replace(/\[(\d+)\]/,".$1");
                                                t=t.split(/\s*\.\s*/);
                                                if(t.length>1){
                                                    m=t.pop().replace(/[()}\s]/g,'');
                                                }else{
                                                    m=t[0].replace(/[{()}\s]/g,'');
                                                    t=["{window"];
                                                }
                                                t=t.join(".")+"}";
                                                t=xui.adjustVar(tt=t, _ns);
                                                if(!xui.isDefined(t))t=xui.adjustVar(tt);
                                                if(t&&t[m]){
                                                    // it's function
                                                    if(xui.isFun(t[m])){
                                                        doit=1;
                                                    }
                                                    // it's pseudo
                                                    else if( (t[m].actions && xui.isArr(t[m].actions) && t[m].actions.length ) || t[m]['return']){
                                                        t=t[m];
                                                        doit2=1;
                                                    }
                                                }
                                            }else if(xui.isStr(t=iparams[0])&&xui.isFun((n=xui.$cache.callback[t])&&(t=n[0])&&t&&(t[m=n[1]]))){
                                                doit=1;
                                            }
                                            if(doit){
                                                t=t[m].apply(t,args);
                                            }else if(doit2){
                                                // nested call
                                                // arguemsnt of function/event is modified
                                                t=ns._callFunctions(t, args, _ns.page, _ns.temp,null, 'nested '+(t.desc||t.id||""), (level||1)+1);
                                            }
                                            if(doit||doit2){
                                                if(iparams[1]&&iparams[2]&&xui.get(_ns,iparams[1].split(/\s*\.\s*/)))xui.set(_ns, (iparams[1]+"."+iparams[2]).split(/\s*\.\s*/), t);
                                            }
                                           break;
                                     }
                                break;
                            }
                            break;
                    }
                    xui._debugInfo.apply(xui, [xui.str.repeat('|', level||1) +" v ", _debug, iparams,conf]);
                };
                // asy
                if(timeout!==null)xui.asyRun(fun,timeout);
                else fun();
            }
            return conf["return"];
        },

        _callFunctions:function(pseudo, args, module, temp, holder, fromtag, level){
            temp=temp||{};
            var ns=this, fun, resume=0, t, rtn,
                funs = pseudo.actions || pseudo || [],
                rtn = pseudo['return'], funsrtn,
                innerE = funs.length==1&&(typeof(funs[0])=='function'||typeof(funs[0])=='string'),
                _ns=ns.getScope(args, module, temp),
                recursive=function(data){
                    var irtn;
                    // set prompt's global var
                    if(xui.isStr(this))_ns.temp[this+""]=data||"";
                    //callback from [resume]
                    for(var j=resume, l=funs.length;j<l;j++){
                        resume=j+1;
                        fun=funs[j];
                        if(module && typeof fun=='string')fun=module[fun];
                        if(holder && typeof fun=='string')fun=holder[fun];
                        if(typeof fun=='function'){
                            // only function action can affect return 
                            if(false===(irtn=xui.tryF(fun, _ns.args, _ns.page))){
                                resume=j;break;
                            }
                        }else if(xui.isHash(fun)){
                            if('onOK' in fun ||'onKO' in fun){
                                var resumeFun=function(key,args,flag){
                                    if(recursive){
                                        if(xui.isStr(flag))_ns.temp[flag]=true;
                                        return recursive.apply(key,args||[]);
                                    }
                                };
                                // onOK
                                if('onOK' in fun)(fun.args||fun.params||(fun.args=[]))[parseInt(fun.onOK,10)||0]=function(){
                                   if(resumeFun)resumeFun("okData",arguments, fun.okFlag);
                                };
                                if('onKO' in fun)(fun.args||fun.params||(fun.args=[]))[parseInt(fun.onKO,10)||0]=function(){
                                    if(resumeFun)resumeFun("koData",arguments,fun.koFlag);
                                };
                                ns.exec(_ns, fun, resumeFun, level);
                                break;
                            }else
                                if(false===(ns.exec(_ns, fun,null, level))){
                                    resume=j;break;
                                }
                        }
                    }
                    if(resume==j)resume=recursive=null;
                    return irtn;
                };
            if(!innerE)xui._debugInfo(xui.str.repeat('|',(level||1)-1)+ "<#pseudo ", "["+fromtag+"]", pseudo, _ns); 
            funsrtn = recursive();
            if(!innerE)xui._debugInfo(xui.str.repeat('|',(level||1)-1)+">"); 

            if(rtn){
                rtn=xui.adjustVar(t=rtn, _ns);
                if(!xui.isDefined(rtn))rtn=xui.adjustVar(t);
            }else{
                // for system beforeXXX events
                rtn=funsrtn;
            }
            return rtn;
        }/*,
        toCode:function(conf, args, module,temp){
        }*/
    };
};

/*serialize/unserialize
*/
new function(){
    var M ={
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '\"' : '\\"',
            '\\': '\\\\',
            '/': '\\/',
            '\x0B': '\\u000b'
        },
        H={'@window':'window','@this':'this'},
        // A1/A2 for avoiding IE's lastIndex problem
        A1=/\uffff/.test('\uffff') ? /[\\\"\x00-\x1f\x7f-\uffff]/ : /[\\\"\x00-\x1f\x7f-\xff]/,
        A2=/\uffff/.test('\uffff') ? /[\\\"\x00-\x1f\x7f-\uffff]/g : /[\\\"\x00-\x1f\x7f-\xff]/g,
        D=/^(-\d+|\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,3}))?((?:[+-](\d{2})(\d{2}))|Z)?$/,
        E=function(t,i,a,v,m,n,p){
            for(i in t)
                if((a=typeof (v=t[i]))=='string' && (v=D.exec(v))){
                    m=v[8]&&v[8].charAt(0);
                    if(m!='Z')n=(m=='-'?-1:1)*((+v[9]||0)*60)+(+v[10]||0);
                    else n=0;
                    m=new Date(+v[1],+v[2]-1,+v[3],+v[4],+v[5],+v[6],+v[7]||0);
                    n+=m.getTimezoneOffset();
                    if(n)m.setTime(m.getTime()+n*60000);
                    t[i]=m;
                }else if(a=='object' && t[i] && (xui.isObj(t[i]) || xui.isArr(t[i]))) E(t[i]);
            return t;
        },

        F='function',
        N='number',
        L='boolean',
        S='string',
        O='object',
        T={},
        PS=function(v,n){return ("000"+(v||0)).slice(-n)},
        Z=(function(a,b){a=-(new Date).getTimezoneOffset()/60; b=a>0?'+':'-'; a=''+Math.abs(a); return b+(a.length==1?'0':'')+a+'00'})();

    T['undefined']=function(){return 'null'};
    T[L]=function(x){return String(x)};
    T[N]=function(x){return ((x||x===0)&&isFinite(x))?String(x):'null'};
    T[S]=function(x){
        return H[x] ||
            '"' +
            (
            A1.test(x)
            ?
            x.replace(A2, function(a,b) {
                if(b=M[a])return b;
                return '\\u' + ((b=a.charCodeAt())<16?'000':b<256?'00':b<4096?'0':'')+b.toString(16)
            })
            :
            x
            )
            + '"'
    };
    T[O]=function(x,filter,dateformat,deep,max,MAXL,MAXS){
        var map = {prototype:1,constructor:1,toString:1,valueOf:1,toLocaleString:1,propertyIsEnumerable:1,isPrototypeOf:1,hasOwnProperty:1};
        deep=deep||1;
        max=max||0;
        MAXL=MAXL||xui.SERIALIZEMAXLAYER;
        MAXS=MAXS||xui.SERIALIZEMAXSIZE;
        if(deep>MAXL||max>MAXS)return xui.$_outofmilimted;
        max++;
        if (x){
            var a=[], b=[], f, i, l, v;
            if(x===window)return "window";
            if(x===document)return "document";
            //for ie alien
            if((typeof x==O || typeof x==F) && !xui.isFun(x.constructor))
                return x.nodeType? "document.getElementById('"+x.id+"')" :"$alien";
            else if(xui.isArr(x)){
                a[0] = '[';
                l = x.length;
                for(i=0;i<l;++i){
                    if(typeof filter=='function' && false==filter.call(x,x[i],i))continue;
                    
                    if(xui.isNaN(v=x[i]))b[b.length]="NaN";
                    else if(xui.isNull(v))b[b.length]="null";
                    else if(!xui.isDefined(v))b[b.length]="undefined";
                    else if(f=T[typeof v]){
                        if(typeof (v=f(v,filter,dateformat,deep+1,max,MAXL,MAXS))==S)
                            b[b.length]=v;
                    }
                }
                a[2]=']';
            }else if(xui.isDate(x)){
                if(dateformat=='utc')
                    return '"'+ PS(x.getUTCFullYear(),4) + '-' +
                         PS(x.getUTCMonth() + 1,2) + '-' +
                         PS(x.getUTCDate(),2) + 'T' +
                         PS(x.getUTCHours(),2) + ':' +
                         PS(x.getUTCMinutes(),2) + ':' +
                         PS(x.getUTCSeconds(),2) + '.' +
                         PS(x.getUTCMilliseconds(),3)+
                         'Z"';
                else if(dateformat=='gmt')
                    return '"'+ PS(x.getFullYear(),4) + '-' +
                         PS(x.getMonth() + 1,2) + '-' +
                         PS(x.getDate(),2) + 'T' +
                         PS(x.getHours(),2) + ':' +
                         PS(x.getMinutes(),2) + ':' +
                         PS(x.getSeconds(),2) + '.' +
                         PS(x.getMilliseconds(),3)+
                         Z+'"';
                else
                    return 'new Date('+[x.getFullYear(),x.getMonth(),x.getDate(),x.getHours(),x.getMinutes(),x.getSeconds(),x.getMilliseconds()].join(',')+')';
            }else if(xui.isReg(x)){
                return String(x);
            }else{
                if(typeof x.serialize == F)
                    x = x.serialize();
                if(typeof x==O){
                    if(x.nodeType){
                        return "document.getElementById('"+x.id+"')";
                    }else{
                        a[0] = '{';
                        for(i in x){
                            if(map[i] ||
                                (filter===true?i.charAt(0)=='_':typeof filter=='function'?false===filter.call(x,x[i],i):0))
                                continue;
                            if(xui.isNaN(v=x[i]))b[b.length]=T.string(i) + ':' + "NaN";
                            else if(xui.isNull(v))b[b.length]=T.string(i) + ':' + "null";
                            else if(!xui.isDefined(v))b[b.length]=T.string(i) + ':' + "undefined";
                            else if (f=T[typeof v]){
                                if (typeof (v=f(v,filter,dateformat,deep+1,max,MAXL,MAXS))==S)
                                    b[b.length] = T.string(i) + ':' + v;
                            }
                        }
                        a[2]='}';
                    }
                }else return String(x);
            }
            a[1]=b.join(', ');
            return a[0]+a[1]+a[2];
        }
        return 'null'
    };
    T[F]=function(x){return x.$path?x.$path:String(x)};

    xui.$_outofmilimted = '"\x01...\x01"';

    //serialize object to string (bool/string/number/array/hash/simple function)
    xui.serialize = function (obj,filter,dateformat,MAXL,MAXS){
        return xui.isNaN(obj) ? "NaN" : 
                    xui.isNull(obj) ? "null" : 
                    !xui.isDefined(obj) ? "undefined" :
                    T[typeof obj](obj,filter,xui.getDateFormat(dateformat),0,0,MAXL,MAXS)||'';
    };
    xui.stringify = function(obj,filter,dateformat,MAXL,MAXS){
        return xui.fromUTF8(xui.serialize(obj,filter,xui.getDateFormat(dateformat),0,0,MAXL,MAXS));
    };
    // for safe global
    var safeW;
    //unserialize string to object
    xui.unserialize = function(str, dateformat){
        if(typeof str !="string")return str;
        if(!str)return false;
        if(!safeW){
            var ifr = document.createElement( xui.browser.ie && xui.browser.ver<9?"<iframe>":"iframe"),w;
            document.body.appendChild(ifr);
            w=frames[frames.length-1].window;
            safeW={};
            for(var i in w)safeW[i]=null;
            document.body.removeChild(ifr);                
        }
        str='({_:(function(){with(this){return '+str+'}}).call(safeW)})';
        try{
            str=eval(str);
        }catch(e){
            return false;
        }
        if(xui.getDateFormat(dateformat))E(str);
        str=str._;
        return str;
    };
};

/*26 based id, some number id can crash opera9
*/
new function(){
    xui.id=function(){
        var self=this;
        if(self.constructor!==xui.id || self.a)
            return (xui.id._ || (xui.id._= new xui.id)).next();
        self.a=[-1];
        self.b=[''];
        self.value='';
    };
    xui.id.prototype = {
        constructor:xui.id,
        _chars  :"abcdefghijklmnopqrstuvwxyz".split(''),
        next : function(i){
            with(this){
                i = (i||i===0)?i:b.length-1;
                var m,k,l;
                if((m=a[i]) >= 25){
                    m=0;
                    if(i===0){
                        a.splice(0,0,1);
                        b.splice(0,0,'a');
                        l=a.length;
                        for(k=1;k<l;++k){
                            a[k]=0;
                            b[k]='0';
                        }
                        ++i;
                    }else
                      next(i-1);
                }else ++m;
                a[i]=m;
                b[i]=_chars[m];
                return value = b.join('');
            }
        }
    };
};


// Some basic Classes

/* xui.Thread
    Dependencies: xui
    parameters:
        id: id of this thread, if input null, thread will create a new id
        tasks: [task,task,task ...] or [{},{},{} ...]
            task: function
            or
            {
              task,      //function
              args,      //args array for task
              scope,     //this object for task
              delay ,    //ms number
              callback   //function for callback
           }
        delay:default delay time;
        callback:default calback function;
        onStart: on start function
        onEnd: on end function
        cycle: is the thread circular
*/
xui.Class('xui.Thread',null,{
    Constructor:function(id, tasks, delay, callback, onStart, onEnd, cycle){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        //for api call directly
        var self=this,me=arguments.callee,t=xui.$cache.thread;
        // xui.Thread() => self.constructor!==me
        // in an inner method => !!self.id is true
        if(self.constructor!==me || !!self.id)
            return new me(id, tasks, delay, callback, onStart, onEnd, cycle);

        if(typeof id!='string')id='$' + (self.constructor.$xid++);
        self.id=id;
        //thread profile
        self.profile = t[id] || (t[id] = {
            id:id,
            _start:false,
            time:0,
            _left:0,
            _asy:0.1,
            //sleep_flag:-1,
            index:0,

            tasks:tasks||[],
            delay: delay || 0,
            callback:callback,
            onStart:onStart,
            onEnd:onEnd,
            cache:{},
            status:"ini",
            cycle:!!cycle,
            instance:self
        });
    },
    Instance:{
        _fun:xui.fun(),
        __gc:function(){
            var m=xui.$cache.thread,t=m[this.id];
            if(t){
                delete m[this.id];
                t.tasks.length=0;
                for(var i in t)t[i]=null;
            }
        },
        _task:function(){
            var self=this,p=self.profile;

            // maybe abort or no task
            if(!p||!p.status||!p.tasks)
                return;
            // reset the asy flag
            p._asy=0.1;

            var t={}, value=p.tasks[p.index],r,i,type=typeof value;

            //function
            if(type=='function') t.task=value;
            //hash
            else if(type=='object')
                for(i in value) t[i]=value[i];

            //default callback
            if(typeof t.callback!='function')
                t.callback=p.callback

            if(typeof t.task=='function'){
                t.args=t.args||[];
                //last arg is threadid
                t.args.push(p.id);
            }

            // to next pointer
            p.index++;
            p.time=xui.stamp();

            // the real task
            if(typeof t.task=='function'){
                r = xui.tryF(t.task, t.args || [p.id], t.scope||self, null);
            }

            // maybe abort called in abover task
            if(!p.status)
                return;

            // cache return value
            if(t.id)
                p.cache[t.id] = r;

            // if callback return false, stop.
            if(t.callback && false===xui.tryF(t.callback, [p.id], self, true))
                return self.abort('callback');
            // if set suspend at t.task or t.callback , stop continue running
            if(p.status!=="run")
                return;

            self.start();
        },
        start:function(time, delaycb){
            var self=this, p=self.profile;

            if(p.__delaycb){
                xui.tryF(p.__delaycb,[p.id],self);
                delete p.__delaycb;
            }
            if(delaycb){
                p.__delaycb=delaycb;
            }

            if(p._start===false){
                p._start=true;
                //call onstart
                if(p.onStart){
                    var r=xui.tryF(p.onStart,[p.id],self);
                    if(false===r){
                        return self.abort('start');
                    }else if(true===r){
                        return;
                    }else if(xui.isNumb(r)){
                        self.suspend(r);
                        return;
                    }
                }
            }
           
            p.status="run";

            if(!p.tasks.length)
                return self.abort('empty');

            if(p.index>=p.tasks.length){
                if(p.cycle===true)
                    self.profile.index = 0;
                else
                    return self.abort('normal');
            }
            var task=p.tasks[p.index],
                delay=typeof task=='number' ? task : (task && typeof task.delay=='number') ? task.delay : p.delay;

            p._left= (time || time===0)?time:delay;

            // clear the mistake trigger task
            if(p._asy!=0.1)
                xui.clearTimeout(p._asy);

            p._asy = xui.asyRun(self._task, p._left, [], self);
            p.time=xui.stamp();
            return self;
        },
        suspend:function(time,delaycb){
            var n,p=this.profile;
            if(p.status=="pause")return;
            p.status="pause";

            if(p._asy!==0.1){
                xui.clearTimeout(p._asy);
                if(p.index>0)p.index--;
            }
            n=p._left-(xui.stamp() - p.time);

            p._left=(n>=0?n:0);

            if((Number(time) || 0))
                this.resume(time, delaycb);

            return this;
        },
        /*time
        number:set timeout to number
        true:set timeout to default
        false:set timeout to 0
        undefined: timetou to left
        */
        resume:function(time, delaycb){
            var self=this, p=self.profile;
            if(p.status=="run")return self;

            time = time===undefined ? p._left :
                        time===true ? p.delay :
                        time===false ? 0 :
                        (Number(time) || 0);

            p.status="run";
            self.start(time, delaycb);
            return self;
        },
        abort:function(flag){
            var self=this, p=self.profile;
            if(p.status=="stop")return;
            p.status="stop";

            var onEnd=p.onEnd,id=p.id;
            xui.clearTimeout(p._asy);
            this.__gc();
            // at last
            xui.tryF(onEnd, [id,flag]);
        },
        links:function(thread){
            var p=this.profile, onEnd=p.onEnd, id=p.id;
            p.onEnd=function(tid,flag){xui.tryF(onEnd,[tid,flag]); thread.start()};
            return this;
        },
        insert:function(arr, index){
            var self=this,o=self.profile.tasks,l=o.length,a;
            if(!xui.isArr(arr))arr=[arr];
            index= index || self.profile.index;
            if(index<0)index=-1;
            if(index==-1){
                Array.prototype.push.apply(o, arr);
            }else{
                if(index>l)index=l;
                a=o.splice(index,l-index);
                o.push.apply(o, arr);
                o.push.apply(o, a);
            }
            return self;
        },
        getCache:function(key){
            return this.profile.cache[key];
        },
        setCache:function(key,value){
            this.profile.cache[key] = value;
            return this;
        },
        isAlive:function(){
            return !!xui.$cache.thread[this.id];
        },
        getStatus:function(){
            return this.profile.status;
        }
    },
    After:function(){
        /*
        give shortcut to some functions
        */
        var self=this, f=function(i){
            self[i]=function(id){
                var t;
                if(xui.$cache.thread[id])
                    (t=xui.Thread(id))[i].apply(t,Array.prototype.slice.call(arguments,1));
            }
        },
        a = 'start,suspend,resume,abort'.split(',');
        for(var i=0,l=a.length;i<l;i++)f(a[i]);
    },
    Static:{
        $asFunction:1,
        $xid:1,
        __gc : function(){
            xui.$cache.thread={};
        },
        get:function(id){
            id=xui.$cache.thread[id];
            return id && id.instance;
        },
        isAlive:function(id){
            return !!xui.$cache.thread[id];
        },
        //Dependencies: xui.Dom
        observableRun:function(tasks,onEnd,threadid,busyMsg){
            var thread=xui.Thread, dom=xui.Dom;
            if(!xui.isArr(tasks))tasks=[tasks];
            //if thread exists, just inset task to the next positiong
            if(xui.$cache.thread[threadid]){
                if(typeof onEnd=='function')
                    tasks.push(onEnd);
                thread(threadid).insert(tasks);
            //if does not exist, create a new thread
            }else{
                thread(threadid, tasks,
                    0,null,
                    //set busy status to UI
                    function(threadid){
                        if(dom)dom.busy(threadid,busyMsg);
                    },
                    //set free status to UI
                    function(threadid){
                        xui.tryF(onEnd,arguments,this);
                        if(dom)dom.free(threadid);
                    }
                ).start();
            }
        },
        /*group thread run once
        group: hash include thread or threadid
        callback: call after a thread finish
        onStart:before all threads start
        onEnd:after all threads end
        */
        group:function(id, group, callback,onStart,onEnd){
            var bak={},
                thread=xui.Thread,
                f=function(o,i,threadid){
                    if(typeof o == 'string')o=thread(o);
                    if(o){
                        var f = function(){
                            var me=arguments.callee;
                            xui.tryF(me.onEnd,arguments,this);
                            me.onEnd=null;
                            delete bak[i];
                            //call callback here
                            xui.tryF(callback,[i, threadid],this);
                            if(xui.isEmpty(bak))
                                thread.resume(threadid);
                        };
                        f.onEnd = o.profile.onEnd;
                        o.profile.onEnd = f;
                        o.start();
                    }
                };
            for(var i in group)bak[i]=1;
            return thread(id, [function(threadid){
                if(!xui.isEmpty(group)){
                    thread.suspend(threadid);
                    for(var i in group)f(group[i],i, threadid);
                }
            }],0,null,onStart,onEnd);
        },
        repeat:function(task, interval, onStart, onEnd){
            return xui.Thread(null,[null],interval||0,task,onStart,onEnd,true).start();
        }
    }
});

/*xui.absIO/ajax
    Dependencies: xui.Thread
    
            get     post    get(cross domain)   post(corss domain)  post file   return big data(corss domain)
    ajax    +       +       -                   -                   -           -
    sajax   +       -       +                   -                   -           * JSONP
    iajax   +       +       +                   *                   *           * IDMI
*/
xui.Class('xui.absIO',null,{
    Constructor:function(uri, query, onSuccess, onFail, threadid, options){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        //get properties
        if(typeof uri=='object')
            options=uri;
        else{
            options=options||{};
            xui.merge(options, {
                uri:uri,
                query:query,
                onSuccess:onSuccess,
                onFail:onFail,
                threadid:threadid
            });
        }
        //for cache
        var self=this,  me=arguments.callee,con=self.constructor;
        if((con !== me) || self.id)
            return new me(options);

        //give defalut value to those members
        xui.merge(options,{
            id : options.id || (''+(con._id++)),
            uid: (''+(con.uid++)),
            uri : options.uri?xui.adjustRes(options.uri,0,1,1):'',
            username:options.username||undefined,
            password:options.password||undefined,
            query : options.query||'',
            contentType : options.contentType||'',
            Accept : options.Accept||'',
            header : options.header||null,
            asy : options.asy!==false
        },'all');
        var m=(options.method||con.method).toUpperCase();
        options.method = 'POST'==m ? 'POST' : 'PUT'==m ? 'PUT' : 'DELETE'==m ? 'DELETE' : 'PATCH'==m ? 'PATCH' : 'GET';

        var a='retry,timeout,reqType,rspType,optimized,customQS'.split(',');
        for(var i=0,l=a.length;i<l;i++){
            options[a[i]] = (a[i] in options)?options[a[i]]:con[a[i]];
            if(typeof options[a[i]]=="string")
                options[a[i]]=options[a[i]].toLowerCase();
        }

        xui.merge(self, options, 'all');

        if(self.reqType=='xml')
            self.method="POST";

        if(con.events)
            xui.merge(self, con.events);

        self.query = self.customQS(self.query, options&&options.exData);

        // remove all undefined item
        if(typeof self.query=='object' && self.reqType!="xml")
            self.query=xui.copy(self.query, function(o){return o!==undefined});

        if(!self._useForm && xui.isHash(self.query) && self.reqType!="xml")
            self.query = con._buildQS(self.query, self.reqType=="json",self.method=='POST');

        return self;
    },
    Instance:{
        _fun:xui.fun(),
        _flag:0,
        _response:false,
        _txtresponse:'',
        _retryNo:0,

        _time:function() {
            var self=this,c=self.constructor;
            self._clear();
            if (self._retryNo < self.retry) {
                self._retryNo++;
                xui.tryF(self.onRetry,[self._retryNo],self);
                self.start();
            }else{
                if(false!==xui.tryF(self.onTimeout,[],self))
                    self._onError(new Error("Request timeout"));
            }
        },
        _onEnd:function(){
            var self=this;
            if(!self._end){
                self._end=true;
                if(self._flag>0){
                    xui.clearTimeout(self._flag);
                    self._flag=0
                }
                xui.Thread.resume(self.threadid);
                xui.tryF(self.$onEnd,[],self);
                xui.tryF(self.onEnd,[],self);
                self._clear();
            }
        },
        _onStart:function(){
            var self=this;
            xui.Thread.suspend(self.threadid);
            xui.tryF(self.$onStart,[],self);
            xui.tryF(self.onStart,[],self);
        },
        _onResponse:function(){
            var self=this;
            if(false!==xui.tryF(self.beforeSuccess,[self._response, self.rspType, self.threadid], self))
                xui.tryF(self.onSuccess,[self._response, self.rspType, self.threadid], self);
            self._onEnd();
        },
        _onError:function(e){
            var self=this;
            if(false!==xui.tryF(self.beforeFail,[e, self.threadid],self))
                xui.tryF(self.onFail,[e.name?( e.name + ": " + e.message):e, self.rspType, self.threadid, e], self);
            self._onEnd();
        },
        isAlive:function(){
            return !this._end;
        },
        abort:function(){
            this._onEnd();
        }
    },
    Static:{
        $abstract:true,
        get:function(uri, query, onSuccess, onFail, threadid, options){
            options=options||{};
            options.method="GET";
            return this.apply(this, arguments).start();
        },
        post:function(uri, query, onSuccess, onFail, threadid, options){
            options=options||{};
            options.method="POST";
            return this.apply(this, arguments).start();
        },
        _id:1,
        uid:1,
        method:'GET',
        retry:0,
        timeout:60000,
        //form, xml, or json
        reqType:'form',
        //json, xml, text, script
        rspType:'json',

        optimized:false,

        callback:'callback',

        _buildQS:function(hash, flag, post){
            hash=xui.clone(hash,function(o,i){return !(xui.isNaN(o)||!xui.isDefined(o))});
            return flag?((flag=xui.serialize(hash))&&(post?flag:encodeURIComponent(flag))):xui.urlEncode(hash);
        },
        customQS:function(obj,ex){
            if(ex){
                if(typeof obj=='string'){
                    obj = (obj||"") + "&" + xui.urlEncode(ex);
                }else{
                    xui.merge(obj,ex,'all');
                }
            }
            return obj;
        },
        _if:function(doc,id,onLoad){
            var ie8=xui.browser.ie && xui.browser.ver<9,
                scr=ie8
                    ? ("<iframe "+(id?("name='"+"xui_xdmi:"+id+"'"):"")+(onLoad?(" onload='xui.XDMI._o(\""+id+"\")'"):"")+">")
                    : "iframe";
            var n=doc.createElement(scr),w;
            if(id)n.id=n.name="xui_xdmi:"+id;
            if(!ie8 && onLoad)n.onload=onLoad;
            n.style.display = "none";
            doc.body.appendChild(n);
            w=frames[frames.length-1].window;
            return [n,w,w.document];
        },
        isCrossDomain:function(uri){
            var b=xui._localParts;
            uri=uri.replace(/#.*$/,"").replace(/^\/\//,b[1]+"//");
            var a=xui._uriReg.exec((uri||'').toLowerCase());
            return !!( a&&(
                    a[1]!==b[1]||
                    a[2]!==b[2]||
                    (a[3]||(a[1]==="http:"?80:443))!==(b[3]||(b[1]==="http:"?80:443))
                )
            );
        },
        //get multi ajax results once
        groupCall:function(hash, callback, onStart, onEnd, threadid){
            var i,f=function(o,i,hash){
                hash[i]=xui.Thread(null,[function(threadid){
                    o.threadid=threadid;
                    o.start();
                }]);
            };
            for(i in hash)f(hash[i],i,hash);
            return xui.Thread.group(null, hash, callback, function(){
                xui.Thread(threadid).suspend();
                xui.tryF(onStart,arguments,this);
            }, function(){
                xui.tryF(onEnd,arguments,this);
                xui.Thread(threadid).resume();
            }).start();
        }
    }
});
// AJAX
xui.Class('xui.Ajax','xui.absIO',{
    Instance:{
        _XML:null,
        _unsafeHeader:"Accept-Charset,Accept-Encoding,Access-Control-Request-Headers,Access-Control-Request-Method,Connection,Content-Length,Cookie,Cookie2,Date,DNT,Expect,Host,Keep-Alive,Origin,Referer,TE,Trailer,Transfer-Encoding,Upgrade,User-Agent,Via".toLowerCase().split(","),
        _isunsafe:function(k){
            return xui.browser.isWebKit && (xui.str.startWith("Proxy-",k)||xui.str.startWith("Sec-",k)||xui.arr.indexOf(this._unsafeHeader,k.toLowerCase())!==-1);
        },
        _header:function(n,v){
            if(!this._isunsafe(n)){
                if(this._XML)this._XML.setRequestHeader(n,v);
            }
        },
        start:function() {
            var self=this;
            if(false===xui.tryF(self.beforeStart,[],self)){
                self._onEnd();
                return;
            }
            if (!self._retryNo)
                self._onStart();
            try {
                with(self){
                    //must use "self._XML", else opera will not set the new one
                   self._XML = new window.XMLHttpRequest();
                   if(asy)
                       self._XML.onreadystatechange = function(){
                           if(self && self._XML && self._XML.readyState==4) {
                               /*//Checking responseXML for Terminated unexpectedly in firfox
                               if(xui.browser.gek && !self._XML.responseXML)
                                    self._onError(new Error('errXMLHTTP:Terminated unexpectedly!'));
                               else*/
                                   self._complete.apply(self);
                               //must clear here, else memory leak
                               self._clear();
                           }
                       };

                    if (!_retryNo && method != "POST"){
                        if(query)
                            uri = uri.split("?")[0] + "?" + query;
                        query=null;
                    }
                    if(username&&password)
                        self._XML.open(method, uri, asy, username, password);
                    else
                        self._XML.open(method, uri, asy);

                    self._header("Accept", Accept ? Accept :
                        (rspType=='json' ? "application/json,text/javascript,*/*;q=0.01" : rspType=='xml' ? "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" : "*/*")
                    );
                    self._header("Content-type", contentType ? contentType : (
                        (reqType=='xml' ? "text/xml; " : reqType=='json' ? "application/json; " : method=="POST" ? "application/x-www-form-urlencoded; " : "") + "charset=" + (self.charset||"UTF-8")
                    ));
                    self._header("X-Requested-With", "XMLHttpRequest");
                    if(optimized){
                        try {
                            self._header("User-Agent", null);
                            self._header("Accept-Language", null);
                            self._header("Connection", "keep-alive");
                            self._header("Keep-Alive", null);
                            self._header("Cookie", null);
                            self._header("Cookie", "");
                        } catch(e) {}
                    }
                    try {
                        if(xui.isHash(header))
                            xui.each(header,function(o,i){
                                self._header(i, o);
                            });
                    } catch(e) {}

                    if(false===xui.tryF(self.beforeSend,[self._XML],self)){
                        self._onEnd();
                        return;
                    }

                    //for firefox syc GET bug
                    try{self._XML.send(query);}catch(e){}

                    if(asy){
                      if(self._XML&&timeout > 0)
                        _flag = xui.asyRun(function(){if(self && !self._end){self._time()}}, self.timeout);
                    }else
                        return _complete();
                }
            }catch(e){
                self._onError(e);
            }
            return self;
        },
        abort:function(){
            var self=this;
            if(self._XML){
                self._XML.onreadystatechange=self._fun;
                self._XML.abort();
                self._XML=null;
            }
            arguments.callee.upper.call(self);
        },
        _clear:function(){
            var self=this;
            if(self._XML){
                self._XML.onreadystatechange=self._fun;
                self._XML=null;
            }
        },
        _complete:function() {
            with(this){
                //this is for opera
                var ns=this,obj,status = ns._XML.status;
                _txtresponse = rspType=='xml'?ns._XML.responseXML:ns._XML.responseText;
                // try to get js object, or the original
                _response = rspType=="json" ?
                    /^\s*\</.test(_txtresponse) && (obj=xui.XML.xml2json(xui.XML.parseXML(_txtresponse))) && obj.data ? obj.data    
                    : ((obj=xui.unserialize(_txtresponse))===false?_txtresponse:obj) 
                    : _txtresponse;

                // crack for some local case ( OK but status is 0 in no-IE browser)
                if(!status && xui._localReg.test(xui._localParts[1])){
                    status=ns._XML.responseText?200:404;
                }

                // for IE7
                if(status==1223)status=204;

                if(status >= 200 && status < 300 || status==304)
                    _onResponse();
                // offline or other Network problems
                else if(status===undefined || status<10 )
                    _onError(new Error('Network problems--' +status));
                else
                    _onError(new Error('XMLHTTP returns--' +status));
            }
            return this._response;
        }
    },
    Static:{
        $asFunction:1
    }
});

// JSONP
xui.Class('xui.JSONP','xui.absIO',{
    Instance:{
        start:function(){
            var self=this,id,c=self.constructor, t, n, ok=false;
            if(false===xui.tryF(self.beforeStart,[],self)){
                self._onEnd();
                return;
            }
            if(!self._retryNo)
                self._onStart();
            //dont retry for loading script
            if(self.rspType=='script')
                self.retry=0;

            //first
            id=self.id;
            if(c._pool[id])
                c._pool[id].push(self);
            else
                c._pool[id]=[self];

            c.No["_"+id]=function(rsp){
                c.$response(rsp,id);
            };

            var w=document,
                _cb=function(){
                    if(!ok){
                        ok=true;
                        if(self.rspType=='script'){
                            if(typeof self.checkKey=='string')
                                xui.setTimeout(function(){
                                    xui.exec("!function(t){"
                                        +  "if(t=xui.get(xui.JSONP,['_pool','" + id + "',0])) {"
                                        +     "if(xui.SC.get('"+self.checkKey+"'))t._onResponse();"
                                        +     "else t._loaded();"
                                        +  "}"
                                        +"}()");
                                // ensure using setTimeout, for the case:
                                //    When the page loading, if you switch to the other page, and return back after timeout, the xui.JSONP._pool["1"] will be deleted
                                //    In this case: setTimeout will be executed first (it'll clear the JSONP), and requestAnimationFrame will be executed later
                                }, false);
                            else
                                self._onResponse();
                        }else
                            self._loaded();
                    }
                };
            n = self.node = w.createElement("script");

            var uri = self.uri;
            if(self.query)
                uri = uri.split("?")[0]  + "?" + self.query;

            n.src = uri;
            n.type= 'text/javascript';
            n.charset=self.charset||'UTF-8';
            n.onload = n.onreadystatechange = function(){
                if(ok)
                    return;
                var t=this.readyState;
                if(!t || t == "loaded" || t == "complete")
                    _cb();

                if(t=='interactive' && xui.browser.opr){
                    xui.Thread.repeat(function(){
                        if(ok)
                            return false;
                        if (/loaded|complete/.test(document.readyState)) {
                            _cb();
                            return false;
                        }
                    },50);
                }
            };

            if('onerror' in n)
                n.onerror=function(e){
                    //clear first
                    self._clear();
                    self._onError(new Error("Not Found - " + uri));
                    self=null;
                    return;
                };

            (w.body||w.getElementsByTagName("head")[0]).appendChild(n);

            n=null;

            //set timeout
            if(self.timeout > 0)
                self._flag = xui.asyRun(function(){
                    if(self && !self._end){
                        self._time()
                    }
                }, self.timeout);
        },
        _clear:function(){
            var self=this, n=self.node, c=self.constructor,id=self.id,_pool=c._pool;
            if(_pool[id]){
                _pool[id].length=0;
                delete _pool[id];
            }
            delete c.No["_"+id];

            if(n){
                self.node=n.onload=n.onreadystatechange=n.onerror=null;

                var div=document.createElement('div');
                //in ie + add script with url(remove script immediately) + add the same script(remove script immediately) => crash
                //so, always clear it later
                div.appendChild(n.parentNode&&n.parentNode.removeChild(n)||n);
                if(xui.browser.ie)
                    xui.asyRun(function(){div.innerHTML=n.outerHTML='';if(xui.isEmpty(_pool))c._id=1;_pool=c=n=div=null;});
                else{
                    xui.asyRun(function(){
                        div.innerHTML='';
                        n=div=null;
                        if(xui.isEmpty(_pool))c._id=1;
                    });
                }
            }else{
                if(xui.isEmpty(_pool))c._id=1;
            }
        },
        _loaded:function(){
            var self=this;
            xui.asyRun(function(){
                if(self.id && self.constructor._pool[self.id])
                    self._onError(new Error("JSONP return script doesn't match"));
            },500);
        }
    },
    Static : {
        $asFunction:1,
        _pool:{},
        "No":{},
        $response:function(obj,id) {
            var self=this,o;
            if(obj && (o = self._pool[id])){
                for(var i=0,l=o.length;i<l;i++){
                    o[i]._response=obj;
                    o[i]._onResponse();
                }
            }else
                self._onError(new Error("JSONP return value formatting error--"+obj));
        },
        customQS:function(obj,ex){
            var c=this.constructor,  b=c.callback,nr=(this.rspType!='script'),r;
            if(typeof obj=='string'){
                obj = (obj||"") + (nr?("&" + b + '=xui.JSONP.No._'+this.id):'');
                if(ex)obj = (obj||"") + (nr?("&" + xui.urlEncode(ex)):'');
            }else{
                if(nr){
                    obj[b]="xui.JSONP.No._"+this.id;
                    if(ex)xui.merge(obj,ex,'all');
                }
            }
            return obj;
        }
    }
});

// XDMI : Cross-Domain Messaging with iframes
xui.Class('xui.XDMI','xui.absIO',{
    Instance:{
        _useForm:true,
        start:function(){
            var self=this,w=window,c=self.constructor, i, id, t, n, k, o, b, form,onload;
            if(false===xui.tryF(self.beforeStart,[],self)){
                self._onEnd();
                return;
            }
            if (!self._retryNo)
                self._onStart();

            //first
            id=self.id;
            if(c._pool[id])
                c._pool[id].push(self);
            else
                c._pool[id]=[self];

            //create form
            var a=c._if(document,id, onload);
            self.node=a[0];
            self.frm=a[1];
            //create form
            form = self.form = document.createElement('form');
            form.style.display='none';

            // use postmessage
            if (w['postMessage']) {
                self._msgcb=function(e){
                    if(!self.node)return;
                    // only take self message
                    if(e.source!==self.frm){
                        return;
                    }
                    e=e.data;
                    if(self.rspType=="json"){
                        e = xui.unserialize(e) || e;
                    }
                    if(e && (t=c._pool[self.id])){
                        for(var i=0,l=t.length;i<l;i++){
                            t[i]._response=e;
                            t[i]._onResponse();
                        }
                    }else{
                        //clear first
                        self._clear();
                        self._onError(new Error("XDMI return value formatting error"));                        
                    }
                };
                 if (w.addEventListener) w.addEventListener('message', self._msgcb, false);
                 else w.attachEvent('onmessage', self._msgcb);
            }
            // use window.name
            else{
                self._onload = onload = function(id){
                    //in some situation, this function will be triggered twice.
                    if(self.OK)return;
                    //in IE/opera, "setting an image file as dummy" will trigger the second onload event with 'self.node == null'
                    if(!self.node)return;
                    var w=self.node.contentWindow,c=xui.XDMI,o,t;
                    //in opera, "set location" will trigger location=='about:blank' at first
                    if(xui.browser.opr)try{if(w.location=='about:blank')return}catch(e){}
                    self.OK=1;
                    // first round: try to syn domain
                    var flag=0;
                    try{if(w.name===undefined)flag=1}catch(e){flag=1}
                    if(flag){
                        w.location.replace(c._getDummy()+'#'+xui.ini.dummy_tag);
                    }

                    // get data
                    var getData = function(){
                        // second round: try to get data
                        var flag=0;
                        try{if(w.name===undefined)flag=1}catch(e){flag=1}
                        if(flag){
                            return xui.asyRun(getData);
                        }

                        var data;
                        if(("xui_xdmi:"+self.id)==w.name){
                            //clear first
                            self._clear();
                            self._onError(new Error('XDMI no return value'));
                            return;
                        }else{
                            data=w.name;
                        }

                        if(data && (o=xui.unserialize(data)) && (t=c._pool[self.id]) ){
                            for(var i=0,l=t.length;i<l;i++){
                                t[i]._response=o;
                                t[i]._onResponse();
                            }
                        }else{
                            //clear first
                            self._clear();
                            self._onError(new Error("XDMI return value formatting error, or no matched 'id'-- "+data));
                        }
                    };
                    getData();
                };
            }

            var uri=self.uri;
            if(self.method!='POST')
                uri = uri.split("?")[0];

            form.action=self.uri;
            form.method=self.method;
            form.target="xui_xdmi:"+id;

            k=self.query||{};
            var file,files=[];
            for(i in k){
                if(k[i] && k[i]['xui.UIProfile'] && k[i].$xuiFileCtrl){
                    if(file=k[i].boxing().getUploadObj()){
                        files.push({id:k[i].$xid, file:file});
                        file.id=file.name=i;
                        form.appendChild(file);
                        b=true;
                    }
                }else if(k[i] && k[i].nodeType==1){
                    k[i].id=k[i].name=i;
                    form.appendChild(k[i]);
                    b=true;
                }else{
                    if(xui.isDefined(k[i])){
                        t=document.createElement('textarea');
                        t.id=t.name=i;
                        t.value= typeof k[i]=='string'?k[i]:xui.serialize(k[i],function(o){return o!==undefined});
                        form.appendChild(t);
                    }
                }
            }
            if(self.method=='POST' && b){
                form.enctype = 'multipart/form-data';
                if(form.encoding)
                    form.encoding = form.enctype;
            }
            document.body.appendChild(form);
            //submit
            form.submit();
            
            if(files.length){
                xui.arr.each(files,function(o,i){
                    if(i=xui.getObject(o.id)){
                        if(i['xui.UIProfile'] && i.boxing() && i.boxing().setUploadObj){
                            i.boxing().setUploadObj(o.file);
                        }
                    }
                });
            }
            
            t=form=null;
            //set timeout
            if(self.timeout > 0)
                self._flag = xui.asyRun(function(){if(self && !self._end){self._time()}}, self.timeout);
        },
        _clear:function(){
            var self=this, n=self.node,f=self.form, c=self.constructor, w=window, div=document.createElement('div'),id=self.id,_pool=c._pool;
            if(_pool[id]){
                _pool[id].length=0;
                delete _pool[id];
            }
            if (n&&w['postMessage']) {
                 if (w.removeEventListener) w.removeEventListener('message', self._msgcb, false);
                 else w.detachEvent('onmessage', self._msgcb);
                 self._msgcb=null;
            }else{
                if(xui.browser.gek&&n)try{n.onload=null;var d=n.contentWindow.document;d.write(" ");d.close()}catch(e){}
            }
            self.form=self.node=self.frm=null;
            if(n)div.appendChild(n.parentNode.removeChild(n));
            if(f)div.appendChild(f.parentNode.removeChild(f));
            div.innerHTML='';
            if(xui.isEmpty(_pool))c._id=1;
            f=div=null;
        }
    },
    Static : {
        $asFunction:1,
        method:'POST',
        _pool:{},
        _o:function(id){
            var self=this,p=self._pool[id],o=p[p.length-1];
            xui.tryF(o._onload);
        },
        _getDummy:function(win){
            win=win||window;
            var ns=this,
                arr,o,
                d=win.document,
                ini=xui.ini,
                b=xui.browser,
                f=ns.isCrossDomain;
            if(ns.dummy)return ns.dummy;
            //can get from xui.ini;
            if(ini.dummy)return ns.dummy=ini.dummy;
            if(!f(ini.path)){
                //not for 'ex-domain include xui' case
                if(!d.getElementById('xui:img:bg')){
                    o=d.createElement('img');
                    o.id='xui:img:bg';
                    o.src=ini.img_bg;
                    o.style.display='none';
                    d.body.appendChild(o);
                    o=null;
                }
            }
            if(o=d.getElementById('xui:img:bg')){
                return ns.dummy=o.src.split('#')[0];
            }else{
                arr=d.getElementsByTagName("img");
                for(var i=0,j=arr.length; i<j; i++){
                    o = arr[i];
                    if(o.src && !f(o.src))
                        return ns.dummy=o.src.split('#')[0];
                }

                if(b.gek){
                    arr=d.getElementsByTagName("link");
                    for(var i=0,j=arr.length; i<j; i++){
                        o = arr[i];
                        if (o.rel == "stylesheet" && !f(o.href))
                            return ns.dummy=o.href.split('#')[0];
                    }
                }
            }
            //get from parent, not for opera in this case
            try{
                if(win!=win.parent)
                    if((win=win.parent) && !f(''+win.document.location.href))
                        return ns._getDummy(win);
            }catch(e){}
            //for the last change, return a file name whether it existes or does not exist, and not cache it.
            return '/favicon.ico';
        },
        customQS:function(obj, ex){
            var s=this,c=s.constructor,t=c.callback,w=window;
            if(window['postMessage'])
                obj[t]=obj.parentDomain=w.location.origin || (w.location.protocol + "//" + w.location.hostname + (w.location.port ? ':' + w.location.port: ''));
            else
                obj[t]='window.name';
            if(ex)xui.merge(obj,ex,'all');
            return obj;
        }
    }
});

new function(){
    // for compitable
    xui.SAjax=xui.JSONP;
    xui.IAjax=xui.XDMI;
};

/*xui.SC for straight call
  Dependencies: xui.Thread; xui.absIO/ajax
*/
xui.Class('xui.SC',null,{
    Constructor:function(path, callback, isAsy, threadid, options, force){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        var p = xui.$cache.SC,r;
        if(r=p[path]||(p[path]=xui.get(window,path.split('.'))))
            xui.tryF(callback,[path,null,threadid],r);
        else{
            options=options||{};
            options.$cb=callback;
            if(isAsy)options.threadid=threadid;
            r=p[path]=xui.SC._call(path||'', options, isAsy, force);
        }
        return r;
    },
    Static:{
        $asFunction:1,
        __gc:function(k){
            xui.$cache.SC={};
        },

        //get object from obj string
        get:function (path, obj1, obj2, v){
            // a[1][2].b[3] => a,1,2,b,3
            path=(path||'').replace(/\]$/g,'').split(/[\[\]\.]+/);
            if(obj1)v = xui.get(obj1,path);
            if(obj2 && v===undefined)v = xui.get(obj2,path);
            if(v===undefined)v = xui.get(window,path);
            return v;
        },
        /* function for "Straight Call"
        *   asy     loadSnips use
        *   true    true    ajax
        *   true    false   sajax JSONP
        *   false   ture    ajax
        *   false   false   ajax
        */
        _call : function (s, options, isAsy, force){
            isAsy = !!isAsy;
            var i,t,r,o,funs=[],ep=xui.SC.get,ct=xui.$cache.snipScript,
            f= function(text,n,threadid){
                var self=this,t,uri=this.uri;
                if(text){
                    //test again when asy end.
                    if(!ep(s)){
                        //loadSnips only
                        if(self.$p)
                            (self.$cache || ct)[self.$tag]=text;
                        else
                            //for sy xmlhttp ajax
                            try{xui.exec(text,s)}catch(e){throw e.name + ": " + e.message+ " " + self.$tag}
                    }
                }
                t=xui.Class._last;
                xui.Class._ignoreNSCache=xui.Class._last=null;
                // specified class must be in the first, maybe multi classes in code
                // and give a change to load the last class in code, if specified class doesn't exist
                xui.tryF(self.$cb,[self.$tag,text,threadid],ep(s)||t||{});
                if(!ep(s)&&t&&t.KEY!=s)
                    xui.asyRun(function(){
                            throw "'"+s+"' doesn't in '"+uri+"'. The last class '"+t.KEY+"' was triggered.";
                    });
            },fe=function(text){
                var self=this;
                //for loadSnips resume with error too
                xui.tryF(self.$cb,[null,null,self.threadid],self);
            };
            //get from object first
            if(force || !(r=ep(s))){
                //if script in cache
                if(!force && (t=ct[s])){
                    isAsy=false;
                    f.call({$cb: options.$cb},t);
                    //delete it
                    delete ct[s];
                }
                //get from object second
                if(force || !(r=ep(s))){
                     options = options ||{};
                     //load from sy ajax
                     o=xui.getPath(s,'.js','js',options);
                     options.$tag = s;
                     xui.Class._ignoreNSCache=1;xui.Class._last=null;
                     var ajax;
                     //asy and not for loadSnips
                     if(isAsy && !options.$p){
                        options.rspType="script";
                        ajax=xui.JSONP;
                     }else{
                        options.asy=isAsy;
                        ajax=xui.Ajax;
                    }
                    //get text from sy ajax
                    ajax(o, xui._rnd(), f, fe, null, options).start();
                    //for asy once only
                    if(!isAsy)
                        r=ep(s);
                }
            }else
                if(options.$cb)
                    f.call(options);
            return r;
        },
        /*
        arr: key array, ['xui.UI.Button','xui.UI.Input']
        callback: fire this function after all js loaded
        */
        loadSnips:function(pathArr,cache,callback,onEnd,threadid,options,isAsy){
            if(!pathArr || !pathArr.length){
                xui.tryF(onEnd,[threadid]);
                return;
            }
            var bak={}, options=xui.merge(options||{}, {$p:1,$cache:cache||xui.$cache.snipScript});
            for(var i=0,l=pathArr.length;i<l;i++)
                bak[pathArr[i]]=1;

            if(callback||onEnd){
                options.$cb=function(path){
                    //give callback call
                    if(callback)xui.tryF(callback,arguments,this);
                    delete bak[path||this.$tag];
                    if(xui.isEmpty(bak)){
                        xui.tryF(onEnd,[threadid]);
                        onEnd=null;
                        xui.Thread.resume(threadid);
                    }
                };
            }
            xui.Thread.suspend(threadid);
            for(var i=0,s; s=pathArr[i++];)
                this._call(s, xui.merge({$tag:s},options,isAsy), true);
        },
        runInBG:function(pathArr, callback, onStart, onEnd){
            var i=0,j,t,self=this,fun=function(threadid){
                while(pathArr.length>i && (t=self.get(j=pathArr[i++])));
                if(!t)
                    self._call(j, {threadid:threadid},true);
                //set abort function to the next step
                if(pathArr.length<i)
                    xui.Thread(threadid).abort();
                if(pathArr.length==i)i++;
            };
            xui.Thread(null, [fun], 1000, callback, onStart, onEnd, true).start();
        },
        execSnips:function(cache){
            var i,h=cache||xui.$cache.snipScript;
            for(i in h)
                try{xui.exec(h[i],i)}catch(e){throw e}
            h={};
        },
        //asy load multi js file, whatever Dependencies
        /*
        *1.busy UI
        *3.xui.SC.groupCall some js/class
        *4.resume thread
        *5.xui.SC.loadSnips other js/class
        *6.execute other ..
        *7.free UI
        */
        groupCall:function(pathArr, onEnd, callback, threadid,options,isAsy){
            if(pathArr){
                //clear first
                var self=this;
                self.execSnips();
                xui.Thread.suspend(threadid);
                self.loadSnips(pathArr, 0, callback, function(){
                    self.execSnips();
                    xui.tryF(onEnd,[threadid]);
                    onEnd=null;
                    xui.Thread.resume(threadid);
                },null,options,isAsy);
            }else
                xui.tryF(onEnd,[threadid]);
        }
    }
});

//xui.absBox
xui.Class('xui.absBox',null, {
    Constructor:function(){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        this._nodes=[];
        this.Class=this.constructor;
    },
    Before:function(key){
        var t=xui.absBox;
        if(t)(t=t.$type)[key.replace('xui.','')]=t[key]=key;
    },
    Instance:{
        __gc:function(){
            this.each(function(profile){
                xui.tryF(profile.__gc);
            });
            this._nodes=0;
        },
        _get:function(index){
            var t=this._nodes;
            return  xui.isNumb(index)?t[index]:t;
        },
        _empty:function(){
            this._nodes.length=0;
            return this;
        },
        getProfile:function(all){
            return all?this._nodes:this._nodes[0];
        },
        get:function(index){
            return this._get(index);
        },
        size:function(){
            return this._nodes.length;
        },
        _each:function(fun,scope,desc){
            var self=this,j=self._nodes,l=j.length,i,n;
            if(desc){
                for(i=l;i>=0;i--)
                    if(n=j[i])
                        if(false===fun.call(scope||self,n,i))
                            break;
            }else{
                for(i=0;i<l;i++)
                    if(n=j[i])
                        if(false===fun.call(scope||self,n,i))
                            break;
            }
            n=null;
            return self;
        },
        each:function(fun,scope,desc){
            return this._each(fun,scope,desc);
        },
        isEmpty:function(){
            return !this._nodes.length;
        },
        merge:function(obj){
            if(this==xui.win||this==xui.doc||this==xui('body'))return this;
            var self=this, c=self.constructor, obj=obj._nodes, i=0, t, n=self._nodes;
            if(obj.length){
                for(;t=obj[i++];)n[n.length]=t;
                self._nodes=c._unique(n);
            }
            return self;
        },
        reBoxing:function(key,ensureValue){
            var self=this, t=xui.absBox.$type[key||'Dom'];
            if(!t)return xui.UI.pack([]);
            if(t==self.KEY)return self;
            if(t=xui.SC(t))return t.pack(self._nodes, ensureValue);
        }
    },
    Static:{
        $abstract:true,
        $type:{},
        pack:function(arr, ensureValue){
            var o = new this(false);

            o._nodes =  !arr
                            ? []
                            : ensureValue===false
                            ? xui.isArr(arr)
                                ? arr
                                : [arr]
                            : typeof this._ensureValues=='function'
                                ? this._ensureValues(arr)
                                : xui.isArr(arr)
                                    ? arr
                                    : [arr];
            o.n0=o._nodes[0];
            return o;
        },
        _unique:function(arr){
            var h={},a=[],i=0,l=arr.length,t,k;
            for(;i<l;i++)a[i]=arr[i];
            arr.length=0;
            i=0;
            for(;t=a[i++];){
                k=typeof t=='string'? t : t.$xid;
                if(!h[k]){
                    h[k]=1;
                    arr.push(t);
                }
            }
            return arr;
        },
        plugIn:function(name, fun){
            this.prototype[name]=fun;
            return this;
        }
    }
});

xui.Class('xui.absProfile',null,{
    Constructor:function(){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        if(!this.$xid)this.$xid=xui.absProfile.$xid.next();
    },
    Instance:{
        getId:function(){
            return this.$xid;
        },
        link:function(obj,id,target,index){
            return xui.absProfile.prototype.$link(this,obj,id,target,index);
        },
        $link:function(self,obj,id,target,index){
            var uid='$'+self.$xid;

            target = target||self;
            if(obj[uid])self.unLink(id);

            //double link
            obj[uid]=target;
            if(xui.isArr(obj))
                xui.arr.insertAny(obj,target,index,true);

            //antilink track
            self._links[id]=obj;
            return self;
        },
        unLink:function(id){
             return xui.absProfile.prototype.$unLink(this,id);
        },
        $unLink:function(self, id){
            var o, index,
                //avoid Number;
                uid='$'+self.$xid;
            if(!self._links)return;
            if(!(o=self._links[id]))return;

            //remove from target
            if(xui.isArr(o)){
                index = xui.arr.indexOf(o,o[uid]);
                if(index!=-1){
                    xui.arr.removeFrom(o, index);
                }
            }delete o[uid];

            //remove from self
            delete self._links[id];

            return index;
        },
        unLinkAll:function(){
            return xui.absProfile.prototype.$unLinkAll(this);
        },
        $unLinkAll:function(self){
            var id='$'+self.$xid,
                l=self._links,
                o,i;
            for(i in l){
                o=l[i];
                if(xui.isArr(o))xui.arr.removeValue(o,o[id]);
                delete o[id];
            }
            self._links={};
            return self;
        },
        getModule:function(top){
            var prf=this, getUpperModule=function(module){
                    // if it's a inner module
                    if(module.moduleClass && module.moduleXid){
                        var pm = xui.SC.get(module.moduleClass);
                        if(pm && (pm = pm.getInstance(module.moduleXid))){
                            return getUpperModule(pm);    
                        }         
                    }
                    return module;
                },t;

            if(prf.moduleClass&&prf.moduleXid){
                if(t=xui.SC.get(prf.moduleClass)){
                    if(t=t.getInstance(prf.moduleXid)){
                        return top?getUpperModule(t):t;
                    }
                }
            }
        },
        getParent:function(){
            return this.parent && this.parent.boxing();
        },
        getChildrenId:function(){
            return this.childrenId;
        }
    },
    Static:{
        $xid:new xui.id,
        $abstract:true
    }
});

xui.Class('xui.Profile','xui.absProfile',{
    Constructor:function(host,key,alias,box,properties,events,options){
        var upper=arguments.callee.upper,args=xui.toArr(arguments);
        upper.apply(this,args);
        upper=null;
        var self=this;
        xui.merge(self,options);

        self.key=key||self.key||'';
        self.alias=alias||self.alias||'',
        self.properties=properties?xui.copy(properties):(self.properties||{});
        self.events=events?xui.copy(events):(self.events||{});
        self.host=host||self.host||self;
        self.Class=self.constructor;
        self.box=box||self.box;
        if(self.events){
            self.setEvents(self.events);
            delete self.events;
        }
        self._links={};
    },
    Instance:{
        setEvents:function(key, value){
            var evs=this.box.$EventHandlers;
            if(xui.isHash(key)){
                return xui.merge(this,key,'all',function(o,i){return evs[i]});
            }else{
                if(evs[key])
                    this[key]=value;
            }
        },
        getEvents:function(key){
            if(key){
                return this[key];
            }else{
                var self=this, t,hash={};
                xui.each(self.box.$EventHandlers,function(o,i){
                    if(self[i])hash[i]=self[i];
                });
                return hash;
            }
        },
        getProperties:function(key){
            if(this._getProperties)this.properties=this._getProperties();
            var prop=this.properties;
            return key?prop[key]:xui.copy(prop);
        },
        setProperties:function(key, value){
            if(xui.isHash(key)){
                xui.merge(key, this.box.$DataStruct, function(o,i){
                    if(!(i in key)){
                        key[i] = xui.isObj(o)?xui.clone(o):o;
                    }
                });
                this.properties=key;
            }else
                this.properties[key]=value;
            if(this.propSetAction)this.propSetAction(this.properties);
        },
        _applySetAction:function(fun, value, ovalue, force, tag, tag2){
            return fun.call(this,value, ovalue, force, tag, tag2);
        },
        __gc:function(){
            var ns=this, args=xui.toArr(arguments);
            if(ns.$beforeDestroy){
                xui.each(ns.$beforeDestroy,function(f){
                    xui.tryF(f,args,ns);
                });
                delete ns.$beforeDestroy;
            }
            xui.tryF(ns.$ondestory,args,ns);
            if(ns.onDestroy)ns.boxing().onDestroy();
            if(ns.destroyTrigger)ns.destroyTrigger();

            // try to clear parent host
            var o;
            if(ns.alias && ns.host && (o=ns.host[ns.alias]) && (o=o._nodes) && (o.length===0 || o.length===1 && o[0]==ns)){
                delete ns.host[ns.alias];
            }

            ns.unLinkAll();
            xui.tryF(ns.clearCache,[],ns);

            //set once
            ns.destroyed=true;
            //afterDestroy
            if(ns.$afterDestroy){
                xui.each(ns.$afterDestroy,function(f){
                    xui.tryF(f,args,ns);
                });
                delete ns.$afterDestroy;
            }
            if(ns.afterDestroy)ns.boxing().afterDestroy(ns);
            xui.breakO([ns.properties, ns.events, ns],2);
            //set again
            ns.destroyed=true;
        },
        boxing:function(){
            //cache boxing
            var self=this, t;
            //for destroyed UIProfile
            if(!self.box)return null;
            if(!((t=self.Instace) && t.get(0)==self && t._nodes.length==1))
                t = self.Instace = self.box.pack([self],false);
            return t;
        },
        serialize:function(rtnString, keepHost){
            var t,
                self = this,
                o = (t=self.box._beforeSerialized)?t(self):self,
                r={
                    alias:o.alias,
                    key:o.key,
                    host:o.host
                };
            //host
            if(r.host===self){
                delete r.host;
            }else if(o.host && !keepHost ){
                if(rtnString!==false)
                    r.host='@this';
                else
                    delete r.host;
            }

            //properties
            var c={}, p=o.box.$DataStruct, map=xui.absObj.$specialChars;
            xui.merge(c,o.properties, function(o,i){return (i in p) &&  p[i]!==o && !map[i.charAt(0)]});
            if(!xui.isEmpty(c))r.properties=c;

            //events
            if(!xui.isEmpty(t=this.getEvents()))r.events=t;
            var eh = o.box.$EventHandlers;
            xui.filter(r.events, function(o,i){
                return o!=eh[i];
            });
            if(xui.isEmpty(r.events))delete r.events;
            return rtnString===false?r:xui.serialize(r);
        }
    }
});

xui.Class('xui.absObj',"xui.absBox",{
    //properties, events, host
    Constructor:function(){
        var upper=arguments.callee.upper,args=xui.toArr(arguments);
        upper.apply(this,args);
        upper=null;
        //for pack function
        if(args[0]!==false && typeof this._ini=='function')
            return this._ini.apply(this,args);
    },
    Before:function(key, parent_key, o){
        xui.absBox.$type[key]=key;
        return true;
    },
    After:function(){
        var self=this, me=arguments.callee,
            temp,t,k,u,m,i,j,l,v,n,b;
        self._nameId=0;
        self._nameTag=self.$nameTag||(self.KEY.replace(/\./g,'_').toLowerCase());
        self._cache=[];
        m=me.a1 || (me.a1=xui.toArr('$Keys,$DataStruct,$EventHandlers,$DataModel'));
        for(j=0;v=m[j++];){
            k={};
            if((t=self.$parent) && (i=t.length))
                while(i--)
                    xui.merge(k, t[i][v]);
            self[v]=k;
        }

        self.setDataModel(self.DataModel);
        delete self.DataModel;

        self.setEventHandlers(self.EventHandlers);
        delete self.EventHandlers;

        m=me.a5 || (me.a5=xui.toArr('RenderTrigger,LayoutTrigger'));
        for(j=0;v=m[j++];){
            temp=[];
             if((t=self.$parent) && (l=t.length))
                for(i=0;i<l;i++){
                    u=t[i]
                    if(u=u['$'+v])
                        temp.push.apply(temp,u);
                }
            if(self[v])
                temp.push(self[v]);
            
            // sort sub node
            xui.arr.stableSort(temp,function(x,y){
                x=x.$order||0;y=y.$order||0;
                return x>y?1:x==y?0:-1;
            });

            self['$'+v] = temp;
            delete self[v];
        }
    },
    //don't add any other function or member to absObj
    Static:{
        $abstract:true,
        $specialChars:{_:1, $:1},

        // *** non-abstract child must have this
        //_objectProp:{tagVar:1,propBinder:1},
        DataModel:{
            "name":'',
            desc:'',
            tag:'',
            tagVar:{
                ini:{}
            },
            propBinder:{
                hidden:1,
                ini:{}
            },
            dataBinder:{
                ini:'',
                set:function(value){
                    var profile=this,
                        p=profile.properties,
                        ovalue=p.dataBinder;
                    if(ovalue)
                        xui.DataBinder._unBind(ovalue, profile);
                    p.dataBinder=value;
                    xui.DataBinder._bind(value, profile);
                }
            },
            dataField:{
                ini:''
            }
        },
        get:function(index){
          return this.pack([this._cache[index||0]]);
        },
        getAll:function(){
          return this.pack(this._cache);
        },
        pickAlias:function(){
            return xui.absObj.$pickAlias(this);
        },
        $pickAlias:function(cls){
            var a=cls._nameTag, p=cls._cache,t;
            while(t=(a+(++cls._nameId))){
                for(var i=0,l=p.length;i<l;i++){
                    if(p[i].alias===t){
                        t=-1;
                        break;
                    }
                }
                if(t==-1)continue;
                else return t;
            }
        },
        setDataModel:function(hash){
            var self=this,
                sc=xui.absObj.$specialChars,
                ds=self.$DataStruct,
                dm=self.$DataModel,
                ps=self.prototype,
                i,j,t,o,n,m,r;

            //merge default value and properties
            for(i in hash){
                if(!dm[i])dm[i]={};
                o=hash[i];
                if(null===o || undefined===o){
                    r=xui.str.initial(i);
                    delete ds[i];
                    delete dm[i]
                    if(ps[j='get'+r]&&ps[j].$auto$)delete ps[j];
                    if(ps[j='set'+r]&&ps[j].$auto$)delete ps[j];
                //Here, if $DataModel inherites from it's parent class, properties[i] will pointer to parent's object.
                }else{
                    t=typeof o;
                    if(t!='object' || o.constructor!=Object)
                        o={ini:o};
                    ds[i] = ('ini' in o)?o.ini:(i in ds)?ds[i]:'';

                    t=dm[i];
                    for(j in t)
                        if(!(j in o))
                            o[j]=t[j];
                    dm[i]=o;
                }
            }

            xui.each(hash,function(o,i){
                if(null===o || undefined===o || sc[i.charAt(0)])return;
                r=xui.str.initial(i);
                n = 'set'+r;
                //readonly properties
                if(o.set!==null && !(o && (o.readonly || o.inner))){
                    //custom set
                    var $set = o.set;
                    m = ps[n];
                    ps[n] = (typeof $set!='function' && typeof m=='function') ? m : xui.Class._fun(function(value,force,tag,tag2){
                        return this.each(function(v){
                            if(!v.properties)return;

                            var t,nfz;
                            // *** force to em/px
                            if(!force){
                                if(dm[i] && dm[i]['$spaceunit']){
                                    if(v.$forceu && value != 'auto'){
                                        t=xui.$us(v);
                                        value=v.$forceu(value,t==2?'em':t==-2?'px':null);
                                    }
                                }
                            }
                            //if same return
                            if(v.properties[i] === value && !force)return;

                            if(v.$beforePropSet && false===v.$beforePropSet(i,value,force,tag,tag2)){
                                return;
                            }else{
                                var ovalue = v.properties[i];
                                if(v.beforePropertyChanged && false===v.boxing().beforePropertyChanged(v,i,value,ovalue))
                                    return;

                                if(typeof $set=='function'){
                                    $set.call(v,value,force,tag,tag2);
                                }else{
                                    var m = xui.get(v.box.$DataModel, [i, 'action']);
                                    v.properties[i] = value;
                                    if(typeof m == 'function' && v._applySetAction(m, value, ovalue, force, tag, tag2) === false)
                                        v.properties[i] = ovalue;
                                }

                                if(v.afterPropertyChanged)v.boxing().afterPropertyChanged(v,i,value,ovalue);
                                if(v.$afterPropertyChanged) xui.tryF(v.$afterPropertyChanged,[v,i,value,ovalue],v);
                            }
                        });
                    },n,self.KEY,null,'instance');
                    //delete o.set;
                    if(ps[n]!==m)ps[n].$auto$=1;
                }else
                    delete ps[n];
                n = 'get'+r;
                if(!(o && o.inner)){
                    // get custom getter
                    var $get = o.get;
                    m = ps[n];
                    ps[n] = (typeof $get!='function' && typeof m=='function') ? m : xui.Class._fun(function(){
                        if(typeof $get=='function')
                            return $get.apply(this.get(0),arguments);
                        else
                            return this.get(0).properties[i];
                    },n,self.KEY,null,'instance');
                    //delete o.get;
                    if(ps[n]!==m)ps[n].$auto$=1;
                }else
                    delete ps[n];
            });
            return self;
        },
        setEventHandlers:function(hash){
            var self=this;
            xui.each(hash,function(o,i){
                if(null===o){
                    delete self.$EventHandlers[i];
                    delete self.prototype[i];
                }else{
                    self.$EventHandlers[i]=o;
                    var f=function(fun){
                        var l=arguments.length,j;
                        if(l==1 && (typeof fun == 'function' || typeof fun == 'string' || xui.isHash(fun) || xui.isArr(fun)))
                            return this.each(function(v){
                                if(v.renderId)
                                    v.clearCache();
                                if(v.box._addEventHanlder)v.box._addEventHanlder(v,i,fun);
                                v[i] =fun;
                            });
                        else if(l==1 && null===fun)
                            return this.each(function(v){
                                v.clearCache();
                                if(v.box._removeEventHanlder)v.box._removeEventHanlder(v,i,v[i]);
                                delete v[i];
                            });
                        else{
                            var args=[], prf=this.get(0);
                            if(prf){
                                var events=prf[i], host=prf.host || prf;
                                if(events && (!xui.isArr(events) || events.length)){
                                    if(prf.$inDesign)return;
                                    prf.$lastEvent=i;
                                    if(arguments[0]!=prf)args[0]=prf;
                                    for(j=0;j<l;j++)args[args.length]=arguments[j];
                                    if(xui.isStr(events)||xui.isFun(events))events=[events];
                                    if(xui.isArr(events.actions||events) && xui.isNumb(j=(events.actions||events)[0].event))args[j]=args[j]?xui.Event.getEventPara(args[j]):{};

                                    return xui.pseudocode._callFunctions(events, args, host, null,prf.$holder, ((host&&host.alias)||(prf.$holder&&prf.$holder.alias))+"."+prf.alias+"."+i);
                                }
                            }
                        }
                    };
                    f.$event$=1;
                    f.$original$=o.$original$||self.KEY;
                    f.$name$=i;
                    f.$type$='event';
                    self.plugIn(i,f);
                }
            });
            return self;
        },
        unserialize:function(target,keepSerialId){
            if(typeof target=='string')target=xui.unserialize(target);
            var f=function(o){
                if(xui.isArr(o))o=o[0];
                delete o.serialId;
                if(o.children)xui.arr.each(o.children,f);
            }, a=[];
            xui.arr.each(target,function(o){
                if(!keepSerialId)f(o);
                a.push((new (xui.SC(o.key))(o)).get(0));
            });
            return this.pack(a,false);
        }
    },
    Instance:{
        clone:function(){
            var arr=[],clrItems=arguments,f=function(p){
                //remove those
                delete p.alias;
                for(var i=0;i<clrItems.length;i++)
                    delete p[clrItems[i]];
                if(p.children)
                    for(var i=0,c;c=p.children[i];i++)
                        f(c[0]);
            };
            this.each(function(o){
                o=o.serialize(false,true);
                f(o);
                arr.push(o);
            });
            return this.constructor.unserialize(arr);
        },
        serialize:function(rtnString, keepHost){
            var a=[];
            this.each(function(o){
                a[a.length]=o.serialize(false, keepHost);
            });
            return rtnString===false?a:a.length==1?" new "+a[0].key+"("+xui.serialize(a[0])+")":"xui.UI.unserialize("+xui.serialize(a)+")";
        },
        getProperties:function(key){
            var h={},prf=this.get(0),prop=prf.properties,funName;
            if(key===true)
                return xui.copy(prop);
            else if(typeof key=='string')
                return prop[key];
            else{
                for(var k in prop){
                    funName="get"+xui.str.initial(k);
                    if(typeof this[funName]=='function')
                        h[k]=this[funName].call(this);
                }
                return h;
            }
        },
        setProperties:function(key, value, force){
            if(typeof key=="string"){
                var h={};
                h[key]=value;
                key=h;
            }
            return this.each(function(o){
                xui.each(key, function(v,k){
                    var funName="set"+xui.str.initial(k),ins=o.boxing();
                    if(ins && typeof ins[funName]=='function'){
                        ins[funName].call(ins, v, !!force);
                    }
                    // can set hidden prop here
                    else{
                        o.properties[k]=v;
                    }
                });
            });
        },
        getEvents:function(key){
            return this.get(0).getEvents(key);
        },
        setEvents:function(key, value){
            if(typeof key=="string"){
                var h={};
                h[key]=value;
                key=h;
            }
            return this.each(function(o){
                var ins=o.boxing();
                xui.each(key, function(v,k){
                    if(typeof ins[k]=='function')
                        ins[k].call(ins, v);
                });
            });
        },
        alias:function(value){
            return value?this.setAlias(value):this.getAlias();
        },
        host:function(value, alias){
            return value?this.setHost(value, alias):this.getHost();
        },
        setHost:function(host, alias){
            return this._setHostAlias(host, alias);
        },
        _setHostAlias:function(host, alias){
            var self=this,
                  prf=this.get(0),
                  oldAlias=prf.alias;
            
            alias=alias||prf.alias;

            if(oldAlias){
                if(prf.host && prf.host!==prf){
                    try{delete prf.host[oldAlias]}catch(e){prf.host[oldAlias]=undefined}
                    if(prf.host._ctrlpool)
                        delete prf.host._ctrlpool[oldAlias];
                }
            }
            prf.alias=alias;
            if(prf.box&&prf.box._syncAlias){
                prf.box._syncAlias(prf,oldAlias,alias);
            }

            if(host)prf.host=host;
            if(prf.host && prf.host!==prf){
                prf.host[alias]=self;
                if(prf.host._ctrlpool)
                    prf.host._ctrlpool[alias]=self.get(0);
            }
            return self;
        },
        setAlias:function(alias){
            return this._setHostAlias(null, alias);
        },
        getAlias:function(){
            return this.get(0).alias;
        },
        getHost:function(){
            return this.get(0).host;
        },
        reBindProp:function(dataMap, scope_set, scope_clear, _scope_handled){
            if(!_scope_handled){
                scope_set=scope_set || xui._scope_set;
                scope_clear=scope_clear || xui._scope_clear; 
            }

            var ns=this,prop,ins,fn,r;
            try{
                if(!_scope_handled)scope_set.call(this,dataMap);
                ns.each(function(prf){
                    prop=prf.properties;
                    if(prop.propBinder && !xui.isEmpty(prop.propBinder)){
                        ins=prf.boxing();
                        xui.each(prop.propBinder, function(get_prop_value,key){
                            if(false!==xui.tryF(ins._reBindProp, [prf, get_prop_value, key], ins)){
                                r= xui.isFun(get_prop_value) ? get_prop_value(prf) : xui.adjustVar(get_prop_value);
                                switch(key){
                                    case "CA": ins.setCustomAttr(r); break;
                                    case "CC": ins.setCustomClass(r); break;
                                    case "CS": ins.setCustomStyle(r);break;
                                    default:
                                        if(xui.isFun(ins[fn='set'+xui.str.initial(key)])) ins[fn](r,true);
                                }
                            }
                        });
                    }
                });
            }catch(e){
                if(!_scope_handled)scope_clear.call(this);
            }


            return this;
        }
        /*non-abstract inheritance must have those functions:*/
        //1. destroy:function(){this.get(0).__gc();}
        //2. _ini(properties, events, host, .....){/*set _nodes with profile*/return this;}
        //3. render(){return this}
    }
});

xui.Class("xui.Timer","xui.absObj",{
    Instance:{
        _ini:function(properties, events, host){
            var self=this,
                c=self.constructor,
                profile,
                options,
                alias,temp;
            if(properties && properties['xui.Profile']){
                profile=properties;
                alias = profile.alias || c.pickAlias();
            }else{
                if(properties && properties.key && xui.absBox.$type[properties.key]){
                    options=properties;
                    properties=null;
                    alias = options.alias || c.pickAlias();
                }else
                    alias = c.pickAlias();
                profile=new xui.Profile(host,self.$key,alias,c,properties,events, options);
            }
            profile._n=profile._n||[];

            for(var i in (temp=c.$DataStruct))
                if(!(i in profile.properties))
                    profile.properties[i]=typeof temp[i]=='object'?xui.copy(temp[i]):temp[i];

            //set anti-links
            profile.link(c._cache,'self').link(xui._pool,'xui');

            self._nodes.push(profile);
            profile.Instace=self;
            self.n0=profile;
            
            if(self._after_ini)self._after_ini(profile,alias);
            return self;
        },
        _after_ini:function(profile){
            if(profile.$inDesign)return;
            xui.asyRun(function(){
                if(profile&&profile.box&&profile.properties.autoStart)profile.boxing().start();
            });
        },
        destroy:function(){
            this.each(function(profile){
                if(profile._threadid)xui.Thread(profile._threadid).abort();
                //free profile
                profile.__gc();
            });
        },
        start:function(){
            return this.each(function(profile){
                if(profile.$inDesign)return;
                if(profile._threadid){
                    xui.Thread(profile._threadid).resume();
                }else{
                    var p=profile.properties,box=profile.boxing(),
                    t=xui.Thread.repeat(function(threadId){
                        if(profile.$onTime && false===profile.$onTime(profile,threadId))return false;
                        if(profile.onTime && false===box.onTime(profile,threadId))return false;
                    }, p.interval, function(threadId){
                        profile.onStart && box.onStart(profile,threadId);
                    }, function(threadId){
                        profile.onEnd && box.onEnd(profile,threadId);
                    });
                    profile._threadid = t.id;
                }
            });
        },
        suspend:function(){
            return this.each(function(profile){
                if(profile._threadid)xui.Thread(profile._threadid).suspend();
                profile.onSuspend && box.onSuspend(profile,threadId);
            });
        },
        getParent:function(){
            return this.parent && this.parent.boxing();
        },
        getChildrenId:function(){
            return this.childrenId;
        }
    },
    Static:{
        _objectProp:{tagVar:1,propBinder:1},
        _beforeSerialized:function(profile){
            var o={};
            xui.merge(o, profile, 'all');
            var p = o.properties = xui.clone(profile.properties,true);
            if(profile.box._objectProp){
                for(var i in profile.box._objectProp)
                    if((i in p) && p[i] && xui.isHash(p[i]) && xui.isEmpty(p[i]))delete p[i];
            }
            return o;
        },
        DataModel:{
            autoStart:true,
            "interval":1000
        },
        EventHandlers:{
            // return false will stop the Timer
            onTime:function(profile, threadId){},
            onStart:function(profile, threadId){},
            onSuspend:function(profile, threadId){},
            onEnd:function(profile, threadId){}
        }
    }
});

xui.Class("xui.MessageService","xui.absObj",{
    Instance:{
        _ini:xui.Timer.prototype._ini,
        _after_ini:function(profile){
            if(profile.$inDesign)return;
            var t, p=profile.properties;
            if(t = p.msgType)profile.boxing().setMsgType(t, true);
        },
        destroy:function(){
            this.each(function(profile){
                if(profile.$inDesign)return;
                //** unsubscribe
                var t,id=profile.$xid;
                if(t=profile.properties.msgType){
                    xui.arr.each(t.split(/[\s,;:]+/),function(t){
                        xui.unsubscribe(t,id);
                    });
                }
                //free profile
                profile.__gc();
            });
        },
        broadcast:function(type, msg1, msg2, msg3, msg4, msg5, callback){
            xui.arr.each(type.split(/[\s,;:]+/),function(t){
                xui.publish(t, [msg1, msg2, msg3, msg4, msg5, callback], null, this);
            });
        },
        getParent:xui.Timer.prototype.getParent,
        getChildrenId:xui.Timer.prototype.getChildrenId
    },
    Static:{
        _objectProp:xui.Timer._objectProp,
        _beforeSerialized:xui.Timer._beforeSerialized,
        DataModel:{
            msgType:{
                ini:"",
                set:function(value){
                        var profile=this, t, p=profile.properties,id=profile.$xid;
                        if(t = p.msgType){
                            xui.arr.each(t.split(/[\s,;:]+/),function(t){
                                xui.unsubscribe(t,id);
                            });
                        }
                        if(t = p.msgType = value||""){
                            xui.arr.each(t.split(/[\s,;:]+/),function(t){
                                xui.subscribe(t, id, function(){
                                    var a=xui.toArr(arguments), ins=profile.boxing();
                                    a.unshift(profile);
                                    if(profile.onMessageReceived) ins.onMessageReceived.apply(ins,a);
                                },p.asynReceive);
                            });
                        }
                }
            },
            asynReceive:false
        },
        EventHandlers:{
            onMessageReceived:function(profile, msg1, msg2, msg3, msg4, msg5, callback){}
        }
    }
});

/*** xui.ExcelFormula.calculate
    * formula :
    *      "=FIXED(SUM(1:1, AVERAGE(A:A, B3)) + ROUND(B5)*C6 + MAX(A1:B2, B3) + MIN(10, B3)/ 1000, 2)"
    *      "=FIXED(SUM(1, AVERAGE(1, 3)) + ROUND(3.3)*1 + MAX(4, 2) + MIN(10, 5)/ 3, 2)" => 11.67
    *      "=CHOOSE(2,'a','b','c')" => 'b'
    * cellsMap :
    *      true: force to return something without cell value maps
    *      {}: returns the result of the formula with cell value maps
***/
xui.Class("xui.ExcelFormula",null,{
    Static:{
        MAXCOUNT:256,
        // support functions: +,-,*,/,%,SUM, AVERAGE, MIN, MAX, ROUND, FIXED, CHOOSE 
        Supported : (function(){
                var flatten = function(args){
                    var arr=[], t, args = xui.toArr(args), i=0,l=args.length;
                    for(;i<l;i++){
                        if(xui.isArr(t=args[i])) arr=arr.concat(t);
                        else arr.push(t);
                    }
                    return arr;
                };
                return {
                    SUM:function(){ 
                        var result = 0, arr = flatten(arguments), i = 0, l=arr.length, v, parsed;
                        for (; i < l; ++i) {
                            v = arr[i];
                            if (typeof v === 'number') {
                                result += v;
                            } else if (typeof v === 'string') {
                                parsed = parseFloat(v);
                                if(!xui.isNaN(parsed))
                                    result += parsed;
                            }
                        }
                        return result;
                    },
                    AVERAGE:function(){
                        var result = 0, arr = flatten(arguments), i=0, l=arr.length, v, parsed;
                        for (; i < l; ++i) {
                            v = arr[i];
                            if (typeof v === 'number') {
                                result += v;
                            } else if (typeof v === 'string') {
                                parsed = parseFloat(v);
                                if(!xui.isNaN(parsed))
                                    result += parsed;
                            }
                        }
                        return result/l;
                    },
                    COUNT:function(){
                        var result = 0, arr = flatten(arguments), i = 0, l=arr.length, v;
                        for (; i < l; ++i) {
                            v = typeof(arr[i]);
                            if (v === 'string'||v === 'number')result++;
                        }
                        return result;
                    },
                    MIN:function(){return Math.min.apply(Math,flatten(arguments));},
                    MAX:function(){return Math.max.apply(Math,flatten(arguments));},
                    ROUND:function(){return Math.round.apply(Math, arguments);},
                    FIXED:function(){return xui.toFixedNumber.apply(xui, arguments);},
                    CHOOSE:function(){var a=arguments; return (xui.isNumb(a[0]) && (a[a[0]])) || ''; },
                    CONCATENATE:function(){return flatten(arguments).join('') },
                    ABS:function(a){return Math.abs(a)},
                    ISNUMBER:function(v){return xui.isFinite(v)},
                    NOW:function(){return new Date},
                    TODAY:function(){return xui.Date.getTimSpanStart(new Date, 'DAY')},
                    IF:function(a,b,c){return eval(a)?b:c},
                    AND:function(){return !!eval(xui.toArr(arguments).join("&&"))},
                    OR:function(){return !!eval(xui.toArr(arguments).join("||"))},
                    NOT:function(a){return !a}
                };
        })(),
        toColumnChr : function(num) {
            var s = "";
            num = num - 1;
            while (num >= 0) {
                s = String.fromCharCode(num % 26 + 97) + s;
                num = Math.floor(num / 26) - 1;
            }
            return s.toUpperCase();
        },
        toColumnNum : function(chr) {
            chr = chr.split('');
            var base = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                i=0, j=chr.length - 1, result = 0;

            for (; i < chr.length; i += 1, j -= 1) {
                result += Math.pow(base.length, j) * (base.indexOf(chr[i]) + 1);
            }
            return result;
        },
        toCoordinate : function(cell, offset, rtnArr){
            var alpha = /[A-Z]+/,
                num = /[0-9]+/,
                cellU = cell.toUpperCase(),row,col;
            if(!offset&&offset!==0)offset=-1;
            row = parseInt(cellU.match(num)[0], 10) + offset;
            col = this.toColumnNum(cellU.match(alpha)[0]) + offset;
            return rtnArr ? [row, col] : {col:col,row:row};
        },
        toCellId : function(col, row, offset){
            return this.toColumnChr(col+(offset||1)) + (row+(offset||1));
        },
        getCellRanges : function(cellFrom, cellEnd, colLimited, rowLimited){
            var ns=this,
                alpha = /[A-Z]+/,
                num = /[0-9]+/;

            if(!alpha.test(cellFrom))cellFrom = "A" + cellFrom;
            if(!num.test(cellFrom))cellFrom = cellFrom + "1";
            if(!alpha.test(cellEnd))cellEnd = ns.toColumnChr(colLimited||ns.MAXCOUNT) + cellEnd;
            if(!num.test(cellEnd))cellEnd = cellEnd + (rowLimited||ns.MAXCOUNT);

            var cellStart = ns.toCoordinate(cellFrom,0),
                cellStop = ns.toCoordinate(cellEnd,0),
                colStart = cellStart.col,
                colStop = cellStop.col,
                rowStart = cellStart.row,
                rowStop = cellStop.row,
                cellRange = [],
                row,
                col;

            if(colStart < colStop){
                for (col = colStart; col <= colStop; col++) {
                    if(rowStart < rowStop){
                        for (row = rowStart; row <= rowStop; row++) {
                            cellRange.push(ns.toColumnChr(col) + row);
                        }
                    }else{
                        for (row = rowStart; row >= rowStop; row--) {
                            cellRange.push(ns.toColumnChr(col) + row);
                        }
                    }
                }
            }else{
                for (col = colStart; col >= colStop; col--) {
                    if(rowStart < rowStop){
                        for (row = rowStart; row <= rowStop; row++) {
                            cellRange.push(ns.toColumnChr(col) + row);
                        }
                    }else{
                        for (row = rowStart; row >= rowStop; row--) {
                            cellRange.push(ns.toColumnChr(col) + row);
                        }
                    }
                }
            }
            return cellRange;
        },
        validate : function(formula){
            var str;
            if(xui.isFun(formula)) str = formula+'';
            else{
                if(!/^\s*\=\s*/.test(formula))
                    return false;
                str = formula.replace(/^\s*\=\s*/,'');
            }
            // for col/row fomula in the grid
            str = str.replace(/(\b)([\?_])([0-9]+\b)/g, '1').replace(/(\b[A-Z]+)([\?_])(\b)/g, '1');

            if(/function\s*\(/.test(str)){
                try{
                    str = xui.fun.body(str);
                    new Function("",str);
                }catch(e){
                    xui._debugInfo("#VALUE! ",  formula, str , e);
                    return false;
                }
            }else{
                var fake = function(){return 1;}, 
                    reg = new RegExp(xui.toArr(this.Supported,true).join('|'), 'g');
                str = xui.replace(str, [
                    // protect "" and ''
                    [/"(\\.|[^"\\])*"/,'1'],
                    [/'(\\.|[^'\\])*'/,'1'],
                    // replace cells
                    [/\{[^}]+\}/,'1'],
                    [/([A-Z\d]+\s*\:\s*[A-Z\d]+)/,'1'],
                    [/([A-Z]+[\d]+)/,'1'],
                    // replace expressions
                    [/[=<>]+/g,function(a){return a[0]=='='?'==':a[0]=='<>'?'!=':a[0]}]
                ]);
                if(/[A-Z_$]/.test(str.replace(reg,'')))
                    return false;
                str = str.replace(reg,'fake');                
                try{
                    eval(str);
                }catch(e){
                    xui._debugInfo("#VALUE! ",  formula, str , e);
                    return false;
                }
            }
            return true;
        },
        getRefCells : function(formula, colLimited, rowLimited){
            return this._parse (formula, false, colLimited, rowLimited);
        },
        parse : function(formula){
            return this._parse (formula, null);
        },        
        calculate : function(formula, cellsMap, colLimited, rowLimited){
            return this._parse (formula, cellsMap||true, colLimited, rowLimited);
        },
        _parse : function(formula, cellsMap, colLimited, rowLimited){
            var ret, ns=this,
                Supported = ns.Supported,
                RANGE = function(cellsMap, cellStart, cellStop){
                    var arr = ns.getCellRanges(cellStart, cellStop, colLimited, rowLimited),i=0,l=arr.length;
                    for(;i<l;i++)
                        arr[i] = cellsMap[arr[i]];
                    return arr;
                },
                doParse = function(formula, CELLS){
                    var cellHash,rtn,str=formula,
                    f=function(a){
                        if(a[8]){
                            if(cellHash){
                                if(!(a[8] in cellHash))cellHash[a[8]]=1;//ns.toCoordinate(a[8],-1);
                            }
                            return 'CELLS["' + a[8] + '"]';
                        }else if(a[6] && a[7]){
                            if(cellHash){
                                var arr = ns.getCellRanges(a[6], a[7], colLimited, rowLimited);
                                for(var i=0,l=arr.length;i<l;i++)
                                    if(!(arr[i] in cellHash))cellHash[arr[i]]=1;//ns.toCoordinate(arr[i],-1);
                            }
                            return 'RANGE(CELLS, "' + a[6] + '","' + a[7]+'")';
                        }else if(a[10] && a[11]){
                            return 'Supported["'+a[10] +'"]'+a[11];
                        }
                    };
                    cellHash={};
                    if(!ns.validate(str))
                        return false;
                    if(xui.isFun(str)) str = str+'';
                    else str = str.replace(/^\s*\=\s*/,'');
                    if(/function\s*\(/.test(str)){
                        str = xui.fun.body(str);
                        str = xui.replace(str, [
                            // protect all
                            [/\/\*[^*]*\*+([^\/][^*]*\*+)*\//,'$0'],
                            [/\/\/[^\n]*/,'$0'],
                            [/\/(\\[\/\\]|[^*\/])(\\.|[^\/\n\\])*\/[gim]*/,'$0'],
                            [/"(\\.|[^"\\])*"/,'$0'],
                            [/'(\\.|[^'\\])*'/,'$0'],
                            // replace cells
                            [/\b([A-Z]+[\d]+)\b/,function(a){
                                cellHash[a[0]]=1;
                                return a[0];
                            }]
                        ]);
                        try{
                            if(cellsMap===false){
                                rtn = cellHash;
                            }else{
                                if(cellsMap===true) cellsMap = {};

                                var pre  ="var map=arguments[0]";
                                xui.each(cellHash, function(o,i){
                                    pre += ", \n";
                                    pre += i + " = map['"+i+"']"
                                });
                                str = pre + ";\n" +  str;

                                rtn = xui.isHash(cellsMap) ? (new Function("",str)).call(null, CELLS, formula) : str;
                            }
                        }catch(e){
                            xui._debugInfo("#VALUE! ",  formula, str , e);
                        }finally{
                            return rtn;
                        }
                    }else{
                        str = xui.replace(str, [
                            // protect "" and ''
                            [/"(\\.|[^"\\])*"/,'$0'],
                            [/'(\\.|[^'\\])*'/,'$0'],
                            // replace cells
                            [/([A-Z\d]+)\s*\:\s*([A-Z\d]+)/, f],
                            [/[A-Z]+[\d]+/,f],
                            [/([A-Z]+)(\s*\()/,f],
                            // replace expressions
                            [/[=<>]+/g,function(a){return a[0]=='='?'==':a[0]=='<>'?'!=':a[0]}]
                        ]);
                        try{
                            if(cellsMap===false){
                                rtn = cellHash;
                            }else{
                                if(cellsMap===true)cellsMap = {};
                                rtn = xui.isHash(cellsMap) ? eval(str) :str;
                            }
                        }catch(e){
                            xui._debugInfo("#VALUE! ",  formula, str , e);
                        }finally{
                            return rtn;
                        }
                    }
                };

            ret = doParse(formula, cellsMap);

            return xui.isNaN(ret)?false:ret;
        }
    }
});xui.Class("xui.APICaller","xui.absObj",{
    Instance:{
        _ini:xui.Timer.prototype._ini,
        _after_ini:function(profile,ins,alias){
             if(!profile.name)profile.Instace.setName(alias);
        },
        destroy:function(){
            this.each(function(profile){
                var box=profile.box,name=profile.properties.name;
                //delete from pool
                delete box._pool[name];
                //free profile
                profile.__gc();
            });
        },
        setHost:function(value, alias){
            var self=this;
            if(value && alias)
                self.setName(alias);
            return arguments.callee.upper.apply(self,arguments);
        },

        setQueryData:function(data, path){
            return this.each(function(prf){
                if(path)xui.set(prf.properties.queryArgs, (path||"").split("."), data);
                else prf.properties.queryArgs=data||{};
            });
        },
        invoke:function(onSuccess, onFail, onStart, onEnd, mode, threadid, options){
            var ns=this,
                con=ns.constructor,
                prf=ns.get(0),
                prop=prf.properties;
            
            var responseType=prop.responseType,
                requestType=prop.requestType,
                requestId=prop.requestId,
                queryURL=prop.queryURL,
                proxyType=prop.proxyType.toLowerCase(),
                queryUserName=prop.queryUserName,
                queryPasswrod=prop.queryPasswrod,
                queryArgs=xui.clone(prop.queryArgs),
                oAuth2Token=prop.oAuth2Token,
                queryOptions=xui.clone(prop.queryOptions),
                queryHeader=xui.clone(prop.queryHeader),
                requestDataSource=prop.requestDataSource,
                responseDataTarget=prop.responseDataTarget,
                responseCallback=prop.responseCallback,
                funs=xui.$cache.functions,
                t1=funs['$APICaller:beforeInvoke'],
                t2=funs['$APICaller:beforeData'],
                t3=funs['$APICaller:onError'];

            queryURL = xui.adjustVar(queryURL);

            if(proxyType=="sajax") proxyType="jsonp";
            else if(proxyType=="iajax") proxyType="xdmi";
            if(requestType=="FORM"||requestType=="JSON") queryArgs = typeof queryArgs=='string'?xui.unserialize(queryArgs):queryArgs;
            if(!queryArgs)queryArgs={};
            if(prop.avoidCache){
                var i=0, rnd="_rand_";
                while(queryArgs.hasOwnProperty(rnd))rnd="_rand_" + ++i;
                queryArgs[rnd] = xui.rand();
            }
            // merge request data
            if(requestDataSource&&requestDataSource.length){
                for(var i in requestDataSource){
                    var o=requestDataSource[i],t,v,path;
                    switch(o.type){
                        case "databinder":
                            if(t = xui.DataBinder.getFromName(o.name)){
                                if(!t.updateDataFromUI()){
                                    return;
                                }else{
                                    path=(o.path||"").split('.');
                                    if(xui.isHash(v = xui.get(queryArgs, path)))xui.merge(v, t.getData(), 'without');
                                    else xui.set(queryArgs, path,t.getData());
                                }
                            }
                            break;
                        case "form":
                            if((t = xui.get(prf,["host",o.name])) && t.Class['xui.absContainer'] && t.getRootNode()){
                                if(!t.checkValid() || !t.checkRequired()){
                                    return;
                                }else{
                                    path=(o.path||"").split('.');
                                    if(xui.isHash(v = xui.get(queryArgs, path)))xui.merge(v, t.getFormValues(), 'without');
                                    else xui.set(queryArgs, path,t.getFormValues());
                                }
                            }
                            break;
                    }
                }
            }
            // the global handler
            if(xui.isFun(t1) && false===t1(requestId, prf))
                return;
            else if( xui.isHash(t1) && xui.isArr(t1.actions)
                        && false===xui.pseudocode._callFunctions(t1,  [requestId, prf], ns.getHost(),null,null,'$APICaller:beforeInvoke')
                    )
                    return;
            // Normally, Gives a change to modify "queryArgs" for XML
            if(prf.beforeInvoke && false===prf.boxing().beforeInvoke(prf, requestId))
                return;

            // for auto adjusting options
            var rMap={header:{}};
            if(!xui.isEmpty(queryHeader)){
                xui.merge(rMap.header, queryHeader);
            }
            if(queryOptions.header && !xui.isEmpty(queryOptions.header)){
                xui.merge(rMap.header, queryOptions.header);
                delete queryOptions.header;
            }
            if(responseType=='SOAP'||requestType=='SOAP'){
                // for wsdl
                if(!con.WDSLCache)con.WDSLCache={};
                if(!con.WDSLCache[queryURL]){
                    var wsdl=xui.SOAP.getWsdl(queryURL,function(rspData){
                       if(prf.afterInvoke)prf.boxing().afterInvoke(prf, rspData, requestId);

                        // the global handler
                        if(xui.isFun(t3))t3(rspData, requestId, prf);
                        else if( xui.isHash(t3) && xui.isArr(t3.actions))xui.pseudocode._callFunctions(t3,  [rspData, requestId, prf], ns.getHost(),null,null,'$APICaller:onError');

                        if(prf.onError)prf.boxing().onError(prf, rspData, requestId);
                        xui.tryF(onFail,arguments,this);
                        xui.tryF(onEnd,arguments,this);
                    });
                    if(wsdl)
                        con.WDSLCache[queryURL] = wsdl;
                    else
                        // stop the further call
                        return;
                }
            }
            switch(responseType){
                case "TEXT":
                    rMap.rspType="text";
                case "JSON":
                    rMap.rspType="json";
                break;
                case "XML":
                    proxyType="ajax";
                    rMap.rspType="xml";
                break;
                case "SOAP":
                    proxyType="ajax";
                    rMap.rspType="xml";
                    var namespace=xui.SOAP.getNameSpace(con.WDSLCache[queryURL]),
                        action = ((namespace.lastIndexOf("/")!=namespace.length-1)?namespace+"/":namespace)+(queryArgs.methodName||"");
                    rMap.header["SOAPAction"]=action;
                break;
            }
            switch(requestType){
                case "FORM":
                    // ensure object
                    queryArgs = typeof queryArgs=='string'?xui.unserialize(queryArgs):queryArgs;
                break;
                case "JSON":
                    rMap.reqType="json";

                    if(prop.queryMethod=="auto")
                        rMap.method="POST";
                    // ensure string
                    queryArgs = typeof queryArgs=='string'?queryArgs:xui.serialize(queryArgs);
                break;
                case "XML":
                    rMap.reqType="xml";
                    proxyType="ajax";
                    rMap.method="POST";
                    if(queryUserName && queryPassword){
                        rMap.username=queryUserName;
                        rMap.password=queryPassword;
                        rMap.header["Authorization"]="Basic "+con._toBase64(queryUserName+":"+queryPassword);
                    }
                    // ensure string
                    queryArgs = typeof queryArgs=='string'?queryArgs:xui.XMLRPC.wrapRequest(queryArgs);
                break;
                case "SOAP":
                    rMap.reqType="xml";
                    proxyType="ajax";
                    rMap.method="POST";
                    if(queryUserName && queryPassword){
                        rMap.username=queryUserName;
                        rMap.password=queryPassword;
                        rMap.header["Authorization"]="Basic "+con._toBase64(queryUserName+":"+queryPassword);
                    }
                    // ensure string
                    queryArgs = typeof queryArgs=='string'?queryArgs:xui.SOAP.wrapRequest(queryArgs, con.WDSLCache[queryURL]);
                break;
            }
            if(oAuth2Token)
               rMap.header["Authorization"]="Bearer " + oAuth2Token

            // Ajax/JSONP/XDMI
            if(proxyType!="ajax")
                rMap.asy=true;
            if(proxyType=="jsonp")
                rMap.method="GET";
  
            options=options||{};
            if(!("asy" in options))
                options.asy=!!prop.queryAsync;
            if(!("method" in options)&&prop.queryMethod!="auto")
                options.method=prop.queryMethod;
            if(!("onEnd" in options))
                options.onEnd=onEnd;
            if(!("onStart" in options))
                options.onStart=onStart;

            xui.merge(options, queryOptions);

            xui.merge(options, rMap, 'all');
            options.proxyType=proxyType;

            if(xui.isEmpty(options.header)){
                delete options.header;
            }
            var cookies={},t;
            if(!xui.isEmpty(prop.fakeCookies)){
                options.$onStart = function(){
                    xui.each(prop.fakeCookies,function(v,k){
                        if(xui.isSet(t=xui.Cookies.get(k))){
                            cookies[k] = t;
                            xui.Cookies.remove(k);
                        }
                    });
                    xui.Cookies.set(prop.fakeCookies,1,"/");
                }
            }
            if(!xui.isEmpty(prop.fakeCookies)){
                options.$onEnd = function(){
                    xui.each(prop.fakeCookies,function(v,k){
                        xui.Cookies.remove(k);
                    });
                    xui.Cookies.set(cookies);
                };
            }
            var ajax = xui._getrpc(queryURL, queryArgs, options).apply(null, [queryURL, queryArgs, function(rspData){
                var mapb,t;
                // ensure to json
                if((responseType=="XML"||responseType=="SOAP") && !xui.isHash(rspData)){
                    if(xui.isStr(rspData))
                        rspData=xui.XML.parseXML(rspData);
                    if(responseType=="XML")
                        rspData=xui.XMLRPC.parseResponse(rspData);
                    else if(responseType=="SOAP")
                        rspData=xui.SOAP.parseResponse(rspData, queryArgs.methodName, con.WDSLCache[queryURL]);
                }
                // Normally, Gives a change to modify the "rspData"
                if(prf.afterInvoke){
                    mapb = prf.boxing().afterInvoke(prf, rspData, requestId);
                    if(xui.isSet(mapb))rspData=mapb;
                    mapb=null;
                }
                
                // the global handler
                if(xui.isFun(t2) && false===t2(rspData, requestId, prf)){
                    return false;
                }else if( xui.isHash(t2) && xui.isArr(t2.actions)
                        && false===xui.pseudocode._callFunctions(t2,  [rspData, requestId, prf], ns.getHost(),null,null,'$APICaller:beforeData')
                    ){
                    return false;
                }
                if(prf.beforeData && false===prf.boxing().beforeData(prf, rspData, requestId)){
                    return false;
                }
                if(responseDataTarget&&responseDataTarget.length){
                    xui.arr.each(responseDataTarget, function(o){
                        var data = o.path?xui.get(rspData,o.path.split('.')):rspData,t;
                        switch(o.type){
                            case "alert":
                                data = xui.stringify(data);
                                if(xui.Coder)data=xui.Coder.formatText(data);
                                alert(data);
                            break;
                            case "log":
                                xui.log(data);
                            break;
                            case "databinder":
                                if(t = xui.DataBinder.getFromName(o.name)){
                                    t.setData(data);
                                    t.updateDataToUI();
                                }
                                break;
                            case "form":
                                if((t = xui.get(prf,["host",o.name])) && t.Class['xui.absContainer'] /*&& t.getRootNode()*/){
                                    t.setFormValues(data);
                                }
                                break;
                        }
                    });
                }
                if(responseCallback&&responseCallback.length){
                    xui.arr.each(responseCallback, function(o){
                        var t,host;
                        switch(o.type){
                            case "host":
                                if((t=ns.getHost()) && (t=t.functions) && (t=t[o.name])){
                                    host = ns.getHost();
                                }
                            break;
                            default:
                                if((t=xui.$cache.functions[o.name])){
                                    host = null;
                                }
                                break;
                        }
                        if(t && t.actions && xui.isArr(t.actions)){
                            xui.pseudocode._callFunctions(t, [rspData, ns], host,null,null,(host&&host.alias)+"."+ns.alias + "." + o.name);
                        }
                    });
                }
                if(prf.onData)prf.boxing().onData(prf, rspData, requestId);
                xui.tryF(onSuccess,arguments,this);

            }, function(rspData){
                if(prf.afterInvoke)prf.boxing().afterInvoke(prf, rspData, requestId);

                if(responseDataTarget&&responseDataTarget.length){
                    xui.arr.each(responseDataTarget, function(o, t){
                        switch(o.type){
                            case "alert":
                                rspData = xui.stringify(rspData);
                                if(xui.Coder)rspData=xui.Coder.formatText(rspData);
                                alert(rspData);
                            break;
                            case "log":
                                xui.log(rspData);
                            break;                            
                        }
                    });
                }
               
                // the global handler
                if(xui.isFun(t3))t3(rspData, requestId, prf);
                else if( xui.isHash(t3) && xui.isArr(t3.actions))xui.pseudocode._callFunctions(t3,  [rspData, requestId, prf], ns.getHost(),null,null,'$APICaller:onError');

                if(prf.onError)prf.boxing().onError(prf, rspData, requestId);
                xui.tryF(onFail,arguments,this);
            }, threadid, options]);

            if(mode=="quiet")
                ajax.start();
            else if(mode=="return")
                return ajax;
            else
                xui.observableRun(function(threadid){
                    ajax.threadid=threadid;
                    ajax.start();
                });                
        }
    },
    Static:{
        WDSLCache:{},
        $nameTag:"api_",
        _pool:{},
        _objectProp:{tagVar:1,propBinder:1,queryArgs:1,queryHeader:1,queryOptions:1,fakeCookies:1,requestDataSource:1,responseDataTarget:1,responseCallback:1},
        destroyAll:function(){
            this.pack(xui.toArr(this._pool,false),false).destroy();
            this._pool={};
        },
        getFromName:function(name){
            var o=this._pool[name];
            return o && o.boxing();
        },
        _toBase64:function(str){
            var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
                arr=[],
                i=0,
                c1,c2,c3,e1,e2,e3,e4;
            do {
                c1=str.charCodeAt(i++);
                c2=str.charCodeAt(i++);
                c3=str.charCodeAt(i++);
                e1=c1>>2;
                e2=((c1&3)<<4)|(c2>>4);
                e3=((c2&15)<<2)|(c3>>6);
                e4=c3&63;
                if (isNaN(c2))e3=e4=64;
                else if(isNaN(c3))e4=64;
                arr.push(keyStr.charAt(e1)+keyStr.charAt(e2)+keyStr.charAt(e3)+keyStr.charAt(e4));
            }while(i<str.length);
            return arr.join('');
        },
        _beforeSerialized:xui.Timer._beforeSerialized,
        DataModel:{
            dataBinder:null,
            dataField:null,
            requestId:"",
            queryAsync:true,
            queryURL:"",
            avoidCache:true,

            oAuth2Token:"",
            queryUserName:"",
            queryPassword:"",

            queryMethod:{
                ini:"auto",
                listbox:["auto","GET","POST","PUT","DELETE"]
            },
            requestType:{
                ini:"FORM",
                listbox:["FORM","JSON","XML","SOAP"]
            },
            responseType:{
                ini:"JSON",
                listbox:["JSON","TEXT","XML","SOAP"]
            },

            requestDataSource:{
                ini:[]
            },
            responseDataTarget:{
                ini:[]
            },
            responseCallback:{
                ini:[]
            },

            queryArgs:{
                ini:{}
            },
            queryHeader:{
                ini:{}
            },
            queryOptions:{
                ini:{}
            },
            fakeCookies:{
                ini:{}
            },
            proxyType:{
                ini:"auto",
                listbox:["auto","AJAX","JSONP","XDMI"]// Cross-Domain Messaging with iframes
            },
            "name":{
                set:function(value){
                    var o=this,
                        ovalue=o.properties.name,
                         c=o.box,
                        _p=c._pool,
                        _old=_p[ovalue],
                        _new=_p[value],
                        ui;

                    //if it exists, overwrite it dir
                    //if(_old && _new)
                    //    throw value+' exists!';

                    _p[o.properties.name=value]=o;

                    //pointer _old the old one
                    if(_new && !_old) o._n=_new._n;
                    //delete the old name from pool
                    if(_old)delete _p[ovalue];
                }
            },
            proxyInvoker:{
                inner:true,
                trigger:function(){
                    var prf = this.get(0),
                        prop = prf.properties,
                        bak1 = prop.responseDataTarget,
                        bak2 = prop.responseCallback,
                        fun = function(d){
                            prop.responseDataTarget = bak1;
                            prop.responseCallback = bak2;

                            d=xui.stringify(d);
                            if(xui.Coder)d=xui.Coder.formatText(d);
                            alert(d);
                        };

                    prop.responseDataTarget=[];
                    prop.responseCallback=[];
                    this.invoke(fun,fun);
                }
            }
        },
        EventHandlers:{
            beforeInvoke:function(profile, requestId){},
            afterInvoke:function(profile, rspData, requestId){},
            onData:function(profile, rspData, requestId){},
            beforeData:function(profile, rspData, requestId){},
            onError:function(profile, rspData, requestId){}
        }
    }
});xui.Class("xui.DataBinder","xui.absObj",{
    Instance:{
        _ini:xui.Timer.prototype._ini,
        destroy:function(){
            this.each(function(profile){
                var box=profile.box,name=profile.properties.name;
                //unlink
                xui.arr.each(profile._n, function(v){if(v)box._unBind(name,v)});
                //delete from pool
                delete box._pool[name];
                //free profile
                profile.__gc();
            });
        },
        setHost:function(value, alias){
            var self=this;
            if(value && alias)
                self.setName(alias);
            return arguments.callee.upper.apply(self,arguments);
        },

        isDirtied:function(){
            var elems=this.constructor._getBoundElems(this.get(0));
            for(var i=0,l=elems.length;i<l;i++){
                var profile=elems[i],ins;
                if(profile.box["xui.absValue"]){
                    ins = profile.boxing();
                    if((ins.getUIValue()+" ")!==(ins.getValue()+" ")){
                        return true;
                    }
                }
            }
            return false;
        },
        checkValid:function(ignoreAlert){
            var result=true;
            // check required first
            if(!this.checkRequired(ignoreAlert)){
                return false;
            }
            xui.absValue.pack(this.constructor._getBoundElems(this.get(0)),false).each(function(prf){
                if(!prf.boxing().checkValid()){
                    if(!ignoreAlert){
                        if(!prf.beforeInputAlert || false!==prf.boxing().prf.beforeInputAlert(profile, prf, 'invalid')){
                            xui.alert('$inline.invalid',xui.getRes('$inline.invalid') + (prf.properties.labelCaption?(" : " +prf.properties.labelCaption):"")  , function(){
                                if(prf&&prf.renderId)
                                       prf.boxing().activate();
                            });
                        }
                        return result=false;
                    }
                     result=false;
                }
            });
            return result;
        },
        checkRequired:function(ignoreAlert){
            var result = true;
            xui.absValue.pack(this.constructor._getBoundElems(this.get(0)),false).each(function(prf){
                if(prf.properties.required && (!(i=prf.boxing().getUIValue())) && i!==0){
                    if(!ignoreAlert){
                        if(!prf.beforeInputAlert || false!==prf.boxing().prf.beforeInputAlert(profile, prf, 'required')){
                            xui.alert('$inline.required',xui.getRes('$inline.required') + (prf.properties.labelCaption?(" : " +prf.properties.labelCaption):"")  , function(){
                                if(prf&&prf.renderId)
                                       prf.boxing().activate();
                            });
                        }
                        return result=false;
                    }
                    result=false;
                }
            });
            return result;
        },

        // for UI Controls
        getUI:function(key){
            var r;
            if(!key)
                r=xui.UI.pack(this.constructor._getBoundElems(this.get(0)),false);
            else
                xui.arr.each(this.constructor._getBoundElems(this.get(0)),function(profile){
                    var p=profile.properties;
                    if((p.dataField || p.name || profile.alias)==key){
                        r=profile.boxing();
                        return false;
                    }
                });
            return r;
        },
        getUIValue:function(withCaption, dirtied){
            var ns=this,
                prf=ns.get(0),
                hash={};
            xui.arr.each(this.constructor._getBoundElems(prf),function(profile){
                if(!profile.box["xui.absValue"])return;
                var p=profile.properties,
                    ins = profile.boxing(),
                    // maybe return array
                    uv = ins.getUIValue(),
                    key = p.dataField || p.name || profile.alias, keys;
                // v and uv can be object(Date,Number)
                if(!dirtied || (uv+" ")!==(ins.getValue()+" ")){
                    if(ins.getCaption){
                        if(key.indexOf(":")!=-1){
                            keys=key.split(':');
                        }
                        if(kyes && keys[0] && keys[1]){
                            hash[keys[0]]=uv;
                            hash[keys[1]]=ins.getCaption();
                        }else if(withCaption){
                            hash[key]={
                                value : uv,
                                caption : ins.getCaption()
                            };
                        }else{
                            hash[key]=uv;
                        }
                    }else{
                        hash[key]=uv;
                    }
                }
            });
            return hash;
        },
        // get dirtied UI Value
        getDirtied:function(withCaption){
            return this.getUIValue(withCaption, true);
        },
        getData:function(key, force, ignoreAlert){
            var prf=this.get(0);
            // refresh
            if(prf.$inDesign || force){
                prf.properties.data=  {};
                this.updateDataFromUI(false,false,false,null,null,ignoreAlert,false);
            }

            var data=prf.properties.data;
            return xui.isSet(key)?data[key]:data;
        },
        setData:function(key,value, force){
            var prf=this.get(0), prop=prf.properties;

            //clear data
            if(key===false){
                xui.each(prop.data,function(o,i){
                    prop.data[i]=null;
                });
            }
            // reset all data
            else if(!xui.isSet(key))
                prop.data={};
            // reset all data
            else if(xui.isHash(key))
                prop.data=key;
            // reset one
            else
                prop.data[key]=value;

            if(prf.$inDesign || force){
                this.updateDataToUI();
            }
            return this;
        },
        resetValue:function(){
            xui.arr.each(this.constructor._getBoundElems(this.get(0)), function(p,i){
                    if((i=p.properties.value) !== p.properties.$UIvalue)
                        p.boxing().resetValue(i);
            });
            return this;
        },
        clearValue:function(){
            xui.absValue.pack(this.constructor._getBoundElems(this.get(0)),false).resetValue(null);
            return this;
        },
        updateValue:function(){
            xui.absValue.pack(this.constructor._getBoundElems(this.get(0)),false).updateValue();
            return this;
        },
        updateDataFromUI:function(updateUIValue,withCaption,returnArr,adjustData,dataKeys,ignoreAlert,ignoreEvent){
            var ns=this,
                prf=ns.get(0),
                prop=prf.properties,
                map={},
                mapb;
            if(!ignoreAlert){
                // check valid first
                if(!ns.checkValid()){
                    return;
                }
                // and check required
                if(!ns.checkRequired()){
                    return;
                }
            }
            xui.merge(map,prop.data,function(v,t){
                return !dataKeys || dataKeys===t || (xui.isArr(dataKeys)?xui.arr.indexOf(dataKeys,t)!=-1:false);
            });
            xui.arr.each(ns.constructor._getBoundElems(prf),function(profile){
                var p=profile.properties,
                      eh=profile.box.$EventHandlers,
                      ins=profile.boxing(),
                      key=p.dataField || p.name || profile.alias, keys, cap;
                if(typeof(ins.setCaption)=="function" && key.indexOf(":")!=-1){
                    keys=key.split(":");
                    if(keys[1] && keys[2]){
                        key=keys[0];
                        cap=keys[1];
                    }
                }
                if(!dataKeys || dataKeys===key || (xui.isArr(dataKeys)?xui.arr.indexOf(dataKeys,key)!=-1:false)){
                    var b = profile.boxing(),capv,
                        // for absValue, maybe return array
                        uv = profile.box['xui.absValue']?b.getUIValue(xui.isBool(returnArr)?returnArr:profile.__returnArray):null;
                    // v and uv can be object(Date,Number)
                    if(xui.isHash(map[key])){
                        var pp=map[key].properties,theme=map[key].theme,cc=map[key].CC,ca=map[key].CA,cs=map[key].CS;

                        if(pp)delete map[key].properties;
                        if(theme)delete map[key].theme;
                        if(ca)delete map[key].CA;
                        if(cc)delete map[key].CC;
                        if(cs)delete map[key].CS;
                        // remove non-properties
                        xui.filter(map[key],function(o,i){
                            return !!(i in p);
                        });
                        // reset
                        if(!xui.isEmpty(map[key])){
                            xui.each(map[key],function(o,i){
                                if(i in p)map[key][i]=p[i];
                            });
                        }
                        // reset pp
                        if(xui.isHash(pp)){
                            xui.filter(pp,function(o,i){
                                return i in p && !(i in map[key]);
                            });
                            if(!xui.isEmpty(pp)){
                                xui.each(pp,function(o,i){
                                    if(i in p)pp[i]=p[i];
                                });                         
                                map[key].properties=pp
                            }
                        }
                         if(theme)map[key].theme=profile.theme;
                        if(ca)map[key].CA=xui.clone(profile.CA,true);
                        if(cc)map[key].CC=xui.clone(profile.CC,true);
                        if(cs)map[key].CS=xui.clone(profile.CS,true);

                        if('caption' in p && b.getCaption)
                        if(cap){
                            map[cap]=b.getCaption();
                        }else if('caption' in map[key] || withCaption)
                            if(pp&&'caption' in pp)pp.caption=b.getCaption();else map[key].caption=b.getCaption();
                        if(xui.isDefined(uv) && 'value' in p)
                            if(pp&&'value' in pp)pp.value=uv;else map[key].value=uv;
                    }else{
                        if(profile.box['xui.UI.ComboInput'] && (p.type=='file')){
                            map[key]=profile;
                        }else if('caption' in p){
                            capv=typeof(b.getCaption)=="function"?b.getCaption():p.caption;
                            if(cap){
                                map[key]=uv;
                                map[cap]=capv;
                            }else if(withCaption){
                                // igore unnecessary caption
                                if((!capv && !uv) || capv==uv)
                                    map[key]=uv;
                                else
                                    map[key]={value:uv, caption:capv};
                            }else{
                                map[key]=uv;
                            }
                        }else{
                            map[key]=uv;
                        }
                    }
                    // for absValue
                    if(updateUIValue!==false && profile.renderId && profile.box['xui.absValue'])
                        b.updateValue();
                }
            });

            // adjust UI data
            if(adjustData)
                map = xui.tryF(adjustData,[map, prf],this);

            if(!ignoreEvent && prf.afterUpdateDataFromUI){
                mapb = this.afterUpdateDataFromUI(prf, map);
                if(xui.isHash(mapb))map=mapb;
                mapb=null;
            }

            xui.merge(prf.properties.data,map,'all');

            return true;
        },
        updateDataToUI:function(adjustData, dataKeys, ignoreEvent){
            var key,keys,cap,ins,p,v,c,b,pp,uv,eh,
                ns=this,
                prf=ns.get(0),
                prop=prf.properties,
                map={},mapb;

            xui.merge(map,prop.data,function(v,t){
                return !dataKeys || dataKeys===t || (xui.isArr(dataKeys)?xui.arr.indexOf(dataKeys,t)!=-1:false);
            });

            if(adjustData)
                map = xui.tryF(adjustData,[map, prf],ns);

            if(!ignoreEvent && prf.beforeUpdateDataToUI){
                mapb = ns.beforeUpdateDataToUI(prf, map);
                if(xui.isHash(mapb))map=mapb;
                mapb=null;
            }

            xui.arr.each(ns.constructor._getBoundElems(prf),function(profile){
                p=profile.properties;
                eh=profile.box.$EventHandlers;
                key=p.dataField || p.name || profile.alias;
                ins=profile.boxing();
                if(typeof(ins.setCaption)=="function" && key.indexOf(":")!=-1){
                    keys=key.split(":");
                    if(keys[1] && keys[2]){
                        key=keys[0];
                        cap=keys[1];
                    }
                }

                if(!dataKeys || dataKeys===key || (xui.isArr(dataKeys)?xui.arr.indexOf(dataKeys,key)!=-1:false)){
                    // need reset?
                    if(map && key in map){
                        v=xui.clone(map[key],null,2);
                        uv=c=undefined;
                        b=profile.boxing();
                        if(xui.isHash(v)){
                            if(pp=v.properties){
                                xui.filter(pp,function(o,i){
                                    return i in p;
                                });
                                // keep value and caption at first
                                c= (cap&&pp[cap]) || (xui.isSet(pp.caption)?pp.caption:null);
                                uv=xui.isSet(pp.value)?pp.value:null;
                                delete pp.caption;delete pp.value;
                                if(!xui.isEmpty(pp))
                                    b.setProperties(pp);
                                delete v.properties;
                            }
                            if(pp=v.theme){if(typeof(b.setTheme)=="function")b.setTheme(pp);delete v.theme}
                            if(pp=v.CS){if(!xui.isEmpty(pp))b.setCustomStyle(pp);delete v.CS}
                            if(pp=v.CC){if(!xui.isEmpty(pp))b.setCustomClass(pp);delete v.CC}
                            if(pp=v.CA){if(!xui.isEmpty(pp))b.setCustomAttr(pp);delete v.CA}

                            if(!xui.isEmpty(v)){
                                xui.filter(v,function(o,i){
                                    return (i in p) || (i in v);
                                });
                                if(!xui.isEmpty(v)){
                                    // keep value and caption at first
                                    // value and caption in properties have high priority
                                    c=xui.isSet(c)?c:((cap&&pp[cap]) || xui.isSet(v.caption)?v.caption:null);
                                    uv=xui.isSet(uv)?uv:xui.isSet(v.value)?v.value:null;
                                    delete v.caption;delete v.value;
                                    
                                    if(!xui.isEmpty(v))
                                        b.setProperties(v);
                                }
                            }
                        }else{
                            uv=v;
                            c= (cap&&pp[cap]) || undefined;
                        }
                        // set value and caption at last
                        if(xui.isDefined(uv) && xui.isFun(b.resetValue)){
                            b.resetValue(uv);
                            profile.__returnArray=xui.isArr(uv);
                        }
                        // set caption
                        if(xui.isDefined(c) && xui.isFun(b.setCaption))
                            xui.tryF(b.setCaption,[c,true],b);
                    }
                }
            });
            return ns;
        }
    },
    Static:{
        $nameTag:"databinder_",
        _pool:{},
        _objectProp:{tagVar:1,propBinder:1,data:1},
        destroyAll:function(){
            this.pack(xui.toArr(this._pool,false),false).destroy();
            this._pool={};
        },
        getFromName:function(name){
            var o=this._pool[name];
            return o && o.boxing();
        },
        _beforeSerialized:xui.Timer._beforeSerialized,
        _getBoundElems:function(prf){
            var arr=[];
            xui.arr.each(prf._n,function(profile){
                // for container
                if(profile.behavior.PanelKeys){
                     xui.absValue.pack(profile.boxing().getChildren(null, true)).each(function(p){
                        arr.push(p);
                    });
                }
                // for absValue
                else if(profile.box['xui.absValue']){
                    arr.push(profile);
                }
            });
            return xui.arr.removeDuplicate(arr);
        },
        _bind:function(name, profile){
            if(!name)return;
            var o=this._pool[name];
            if(!o){
                b=new xui.DataBinder();
                b.setName(name);
                o=b.get(0);
            }
            if(profile){
                if(xui.arr.indexOf(o._n,profile)==-1){
                    //use link for 'destroy UIProfile' trigger 'auto unbind function '
                    profile.link(o._n, 'databinder.'+name);
                }
            }
        },
        _unBind:function(name, profile){
            if(profile && profile.box && this._pool[name])
                profile.unLink('databinder.'+name);
        },
        DataModel:{
            dataBinder:null,
            dataField:null,            
            "name":{
                set:function(value){
                    var o=this,
                        ovalue=o.properties.name,
                         c=o.box,
                        _p=c._pool,
                        _old=_p[ovalue],
                        _new=_p[value],
                        ui;

                    //if it exists, overwrite it dir
                    //if(_old && _new)
                    //    throw value+' exists!';

                    _p[o.properties.name=value]=o;
                    //modify name
                    if(_old && !_new && o._n.length)
                        for(var i=0,l=o._n.length;i<l;i++)
                            xui.set(o._n[i], ["properties","dataBinder"], value);

                    //pointer _old the old one
                    if(_new && !_old) o._n=_new._n;
                    //delete the old name from pool
                    if(_old)delete _p[ovalue];
                }
            },            
            "data":{
                ini:{}
            }
        },
        EventHandlers:{
            beforeInputAlert:function(profile, ctrlPrf, type){},
            beforeUpdateDataToUI:function(profile, dataToUI){},
            afterUpdateDataFromUI:function(profile, dataFromUI){}
        }
    }
});(xui.Locale.en||(xui.Locale.en={})).inline={
    $_$:1,
    ok:'O K',
    cancel:'Cancel',
    set:'SET',
    today:'Today',
    now:'Now',
    yes:'Yes',
    no:'No',
    noFlash:'No Flash PlugIn!',
    transparent:'transparent',
    required:'Required field',
    required2:'There is required field need to be filled out',
    invalid:'Invalid field',
    invalid2:'There is invalid field'
};
xui.Locale.en.date={
    WEEKS:{
        '0':'Su',
        '1':'Mo',
        '2':'Tu',
        '3':'We',
        '4':'Th',
        '5':'Fr',
        '6':'Sa',
        '7':'WK'
    },
    VIEWS:{
        '10 ms':'10 millisecond',
        '100 ms':'100 milliseconds',
        '1 s':'1 second',
        '10 s':'10 seconds',
        '1 n':'1 minute',
        '5 n':'5 minutes',
        '10 n':'10 minutes',
        '30 n':'30 minutes',
        '1 h':'1 hour',
        '2 h':'2 hours',
        '6 h':'6 hours',
        '1 d':'1 day',
        '1 w':'1 week',
        '15 d':'15 days',
        '1 m':'1 month',
        '1 q':'1 quarter',
        '1 y':'1 year',
        '1 de':'10 years',
        '1 c':'1 century'
    },
    MONTHS:{
        '1':'Jan.',
        '2':'Feb.',
        '3':'Mar.',
        '4':'Apr.',
        '5':'May.',
        '6':'Jun.',
        '7':'Jul.',
        '8':'Aug.',
        '9':'Sep.',
        '10':'Oct.',
        '11':'Nov.',
        '12':'Dec.'
    },
    MS:'ms',
    S:'s',
    N:'n',
    H:'h',
    D:'d',
    W:'w',
    M:'m',
    Q:'q',
    Y:'y',
    DE:'de',
    C:'c',
    HN:function(n,a,b){return (a.length==1?'0':'')+a+":"+(b.length==1?'0':'')+b},
    DHN:function(n,a,b,c){return a +'th '+ (b.length==1?'0':'')+b + ":" +(c.length==1?'0':'')+c },
    MDHN:function(n,a,b,c,d){return b+ 'th ' + xui.getRes('date.MONTHS.'+a) + " " + (c.length==1?'0':'')+c + ":" + (d.length==1?'0':'')+d},
    HNS:function(n,a,b,c){return (a.length==1?'0':'')+a+":"+(b.length==1?'0':'')+b+":"+(c.length==1?'0':'')+c},
    HNSMS:function(n,a,b,c,d){return (a.length==1?'0':'')+a+":"+(b.length==1?'0':'')+b+":"+(c.length==1?'0':'')+c+ ' ' +(d.length==1?'00':d.length==2?'0':'')+d},
    YM:function(n,a,b){return xui.getRes('date.MONTHS.'+b)+' '+a},
    YQ:function(n,a,b){return b+'Q ' + a},
    YMD:function(n,a,b,c){return a+'-'+(b.length==1?'0':'')+b+'-'+(c.length==1?'0':'')+c},
    YMD2:function(n,a,b,c){return xui.getRes('date.MONTHS.'+b)+' '+c+', '+a},
    MD:function(n,a,b){return xui.getRes('date.MONTHS.'+a) + " "+ b},
    YMDH:function(n,a,b,c,d){return a+'-'+(b.length==1?'0':'')+b+'-'+(c.length==1?'0':'')+c + ' ' +(d.length==1?'0':'')+d+':00'},
    YMDHN:function(n,a,b,c,d,e){return a+'-'+(b.length==1?'0':'')+b+'-'+(c.length==1?'0':'')+c + ' ' +(d.length==1?'0':'')+d+":"+(e.length==1?'0':'')+e},
    YMDHNS:function(n,a,b,c,d,e,f){return a+'-'+(b.length==1?'0':'')+b+'-'+(c.length==1?'0':'')+c + ' ' +(d.length==1?'0':'')+d+":"+(e.length==1?'0':'')+e+":"+(f.length==1?'0':'')+f},
    ALL:function(n,a,b,c,d,e,f,g){return a+'-'+(b.length==1?'0':'')+b+'-'+(c.length==1?'0':'')+c + ' ' +(d.length==1?'0':'')+d+":"+(e.length==1?'0':'')+e+":"+(f.length==1?'0':'')+f +" " +(g.length==1?'00':g.length==2?'0':'')+g}
};
xui.Locale.en.color={
  LIST:{
    "FFFFFF":"White",
    "FFFFF0":"Ivory",
    "FFFFE0":"Light Yellow",
    "FFFF00":"Yellow",
    "FFFAFA":"Snow",
    "FFFAF0":"Floral White",
    "FFFACD":"Lemon Chiffon",
    "FFF8DC":"Cornislk",
    "FFF5EE":"Sea Shell",
    "FFF0F5":"Lavender Blush",
    "FFEFD5":"Papaya Whip",
    "FFEBCD":"Blanched Almond",
    "FFE4E1":"Misty Rose",
    "FFE4C4":"Bisque",
    "FFE4B5":"Moccasin",
    "FFDEAD":"Navajo White",
    "FFDAB9":"Peach Puff",
    "FFD700":"Gold",
    "FFC0CB":"Pink",
    "FFB6C1 ":"Light Pink",
    "FFA500":"Orange",
    "FFA07A":"Light Salmon",
    "FF8C00":"Dark Orange",
    "FF7F50":"Coral",
    "FF69B4":"Hot Pink",
    "FF6347":"Tomato",
    "FF4500":"Orange Red",
    "FF1493":"Deep Pink",
    "FF00FF":"Magenta",
    "FF00FF":"Fuchsia",
    "FF0000":"Red",
    "FDF5E6":"Old Lace",
    "FAFAD2":"Light Goldenrod Yellow",
    "FAF0E6":"Linen",
    "FAEBD7":"Antique White",
    "FA8072":"Salmon",
    "F8F8FF":"Ghost White",
    "F5FFFA":"Medium Spring Green",
    "F5F5F5":"White Smoke",
    "F5DEB3":"Wheat",
    "F4A460":"Sandy Brown",
    "F0FFFF":"Azure",
    "F0FFF0":"Honeydew",
    "F0F8FF":"Alice Blue",
    "F0E68C":"Khaki",
    "F08080":"Light Coral",
    "EEE8AA":"Pale Godenrod",
    "EE82EE":"Violet",
    "E9967A":"Dark Salmon",
    "E6E6FA":"Lavender",
    "E1FFFF":"Light Cyan",
    "DEB887":"Bruly Wood",
    "DDA0DD":"plum",
    "DCDCDC":"Gainsboro",
    "DC143C":"Crimson",
    "DB7093":"Pale Violet Red",
    "DAA520":"Gold Enrod",
    "DA70D6":"Orchid",
    "D8BFD8":"Thistle",
    "D3D3D3":"Light Grey",
    "D2B48C":"Tan",
    "D2691E":"Chocolate",
    "CD853F":"Peru",
    "CD5C5C":"Indian Red",
    "C71585":"Medium Violet Red",
    "C0C0C0":"Silver",
    "BDB76B":"Dark Khaki",
    "BC8F8F":"Rosy Brown",
    "BA55D3":"Medium Orchid",
    "B22222":"Fire Brick",
    "B0E0E6":"Pow Der Blue",
    "B0C4DE":"Light Steel Blue",
    "AFEEEE":"Pale Turquoise",
    "ADFF2F":"Green Yellow",
    "ADD8E6":"Light BLue",
    "A9A9A9":"Dark Gray",
    "A52A2A":"Brown",
    "A0522D":"Sienna",
    "9932CC":"Dark Orchid",
    "98FB98":"Pale Green",
    "9400D3":"Dark Voilet",
    "9370DB":"Medium Purple",
    "90EE90":"Light Green",
    "8FBC8F":"Dark Sea Green",
    "8B4513":"Saddle Brown",
    "8B008B":"Dark Magenta",
    "8B0000":"Dark Red",
    "8A2BE2":"Blue Violet",
    "87CEFA":"Light Sky Blue",
    "87CEEB":"Sky Blue",
    "808080":"Gray",
    "808000":"Olive",
    "800080":"Purple",
    "800000":"Maroon",
    "7FFFAA":"Auqamarin",
    "7FFF00":"Chartreuse",
    "7CFC00":"Lawn Green",
    "7B68EE":"Medium Slate Blue",
    "778899":"Light Slate Gray",
    "708090":"Slate Gray",
    "6B8E23":"Beige",
    "6A5ACD":"Slate Blue",
    "696969":"Dim Gray",
    "6495ED":"Cornflower Blue",
    "5F9EA0":"Cadet Blue",
    "556B2F":"Olive Drab",
    "4B0082":"Indigo",
    "48D1CC":"Medium Turquoise",
    "483D8B":"Dark Slate Blue",
    "4682B4":"Steel Blue",
    "4169E1":"Royal Blue",
    "40E0D0":"Turquoise",
    "3CB371":"Spring Green",
    "32CD32":"Lime Green",
    "2F4F4F":"Dark Slate Gray",
    "2E8B57":"Sea Green",
    "228B22":"Forest Green",
    "20B2AA":"Light Sea Green",
    "1E90FF":"Doder Blue",
    "191970":"Midnight Blue",
    "00FFFF":"Cyan",
    "00FFFF":"Aqua",
    "00FF7F":"Mint Cream",
    "00FF00":"Lime",
    "00FA9A":"Medium Aquamarine",
    "00CED1":"Dark Turquoise",
    "00BFFF":"Deep Sky Blue",
    "008B8B":"Dark Cyan",
    "008080":"Teal",
    "008000":"Green",
    "006400":"Dark Green",
    "0000FF":"Blue",
    "0000CD":"Medium Blue",
    "00008B":"Dark Blue",
    "000080":"Navy",
    "000000":"Black"
  }
};
xui.Locale.en.editor={
    bold:'Bold',
    italic:'Italic',
    underline:'Underline',
    strikethrough:'Strikethrough',
    subscript:'Subscript',
    superscript:'Superscript',
    forecolor:'Font Color',
    bgcolor:'Background Color',
    left:'Align Left',
    center:'Align Center',
    right:'Align Right',
    justify:'Justify',
    indent:'Indent',
    outdent:'Outdent',
    ol:'Ordered List',
    ul:'Unordered List',
    hr:'Insert Horizontal Rule',
    unlink:'Remove Link',
    removeformat:'Remove Formatting',
    html:"HTML Editor",

    insertimage:'Insert Image',
    insertimage2:'Image URL:',
    createlink:'Insert Link',
    createlink2:'Link URL:',
    fontsize:'Font Size',
    fontname:'Font Family',
    formatblock:'Font Block',
    fontsizeList:'1,1(8pt);2,2(10pt);3,3(12pt);4,4(14pt);5,5(18pt);6,6(24pt);...,...',
    fontnameList:'Arial;Arial Black;Comic Sans MS;Courier New;Impact;Tahoma;Times New Roman;Trebuchet MS;Verdana;...',
    formatblockList:'p,Normal;h1,Heading1;h2,Heading2;h3,Heading3;h4,Heading4;h5,Heading5;h6,Heading6;...,...'
};/* event
*  Dependencies: base _ ; Class ; xui ;
*/
xui.Class('xui.Event',null,{
    Constructor:function(event,node,fordrag,tid){
        var self = xui.Event,
            w=window,
            d=document,
            dd=0,id,t,
            dragdrop=xui.DragDrop,
            src, pre, obj;

        //get event object , and src of event
        if(!(event=event||w.event) || !(src=node)){
            src=node=null;
            return false;
        }
        node=null;

        //type
        var type = event.type,
            xuievent=event.$xuievent,
            xuitype=event.$xuitype,
            xuiall=event.$xuiall;
        
        if(xui.browser.fakeTouch && type=="click" && xui.getData(['!document','$fakescrolling'])){
            return false;
        }

        // simulate for DD
        if(type=="xuitouchdown"){
            type="mousedown";
            xuievent=1;
            xuiall=0;
            xuitype="beforeMousedown";
        }

        //for correct mouse hover problems;
        if('mouseover'==type || 'mouseout'==type){
            dd=(dragdrop&&dragdrop._profile.isWorking)?1:2;
            //for droppable
            if(dd!=1 && fordrag){
                src=null;
                return self.$FALSE;
            }
            //don't return false, here, opera will stop the system event hander => cursor not change
            if(!self._handleMouseHover(event, src, dd==1)){
                src=null;
                return self.$FALSE;
            }
            if(dd==1)
                pre=dragdrop&&dragdrop._dropElement;
        //for tab focusHook
        }else if((obj=self._tabHookStack).length &&
            self._kb[type] &&
            (event.$key || event.keyCode || event.charCode)==9 &&
            false === self._handleTabHook(self.getSrc(event), obj=obj[obj.length-1])){
                src=null;
                return;
            }

        id = tid||self.getId(src);
        //get profile from dom cache
        if(obj = self._getProfile(id)){
            if(type=="DOMMouseScroll")
                type="mousewheel";
            //for setBlurTrigger
            if(type=='mousedown' || type=="mousewheel")
                xui.tryF(xui.Dom._blurTrigger,[obj,event]);
            //for resize
            else if(type=="resize"){
                type='size';
                //for IE, always fire window onresize event after any innerHTML action
                if(xui.browser.ie && w===src){
                    var w=xui.browser.contentBox && d.documentElement.clientWidth || d.body.clientWidth,
                        h=xui.browser.contentBox && d.documentElement.clientHeight || d.body.clientHeight;
                    if(obj._w==w&&obj._h==h){
                        src=null;
                        return;
                    }else{
                        obj._w=w;obj._h=h;
                    }
                }
            }

            var j, f, name, r=true, funs=[];
            //order by: before, on, after
            for(j=0; j<=2; ++j){
                // if in dd, effect beforeMouse(move/over/out) only
                if(dd==1 && j!==0 && !event.$force)break;
                // if not in dd, effect (on/after)Mouse(move/over/out) only
                if(dd==2 && j===0)continue;
                // get event name from event type
                name = self._type[type+j] || ( self._type[type+j] = self._getEventName(type, j));
                /*
                event.$xui : called by xui fireEvent
                event.$xuiall : fire all events of the type: before/on/after
                event.$xuitype : fire specific type only
                */
                if(!xuievent || xuiall || (name===xuitype))obj._getEV(funs, id, name, src.$xid);
            }

            /*call function by order
             widget before -> dom before -> widget on -> dom on -> widget after -> dom after
            */
            f=function(a,b){
                for(var i=0,v;v=arguments.callee.tasks[i++];)
                    //if any fun return false, stop event bubble
                    if(false === v(obj, a, b))
                        return false;
                return true;
            };
            f.tasks=funs;
            r = f(event, src.$xid);
            // add a patch for resize
            if(w===src && type=="size"){
                xui.asyRun(function(){
                    f(event, src.$xid);
                    f.tasks.length=0;
                    delete f.tasks;
                    f=src=null;
                },150);
            }
    
            if(dragdrop){
                //shortcut for onDrag('mousemove')
                if(type=='drag')
                    dragdrop._onDrag=f;
                else if(type=='dragover')
                    dragdrop._onDragover=f;
            }else if(type!=="size"){
                f.tasks.length=0;
                delete f.tasks;
                f=null;
            }

            if(dd==1){
                //From parent droppable node to child droppable node, fire parent node's mouseout manually
                if('mouseover'==type && dragdrop._dropElement==src.$xid && pre && pre!=src.$xid){
                    t=xui.use(pre).get(0);
                    self({
                        type: 'mouseout',
                        target: t,
                        $xui:true,
                        $xuitype:'beforeMouseout',
                        preventDefault:function(e){xui.Event.stopDefault(e);},
                        stopPropagation:function(e){xui.Event.stopBubble(e);}
                        },t);
                    dragdrop.setDropElement(src.$xid);
                }

                //Out of droppable node, 'dragdrop._dropElement' will be set to null in beforeMouseover
                //set _preDroppable flag, for parent node is droppable too
                if('mouseout'==type && !dragdrop._dropElement && pre && pre==src.$xid){
                    self._preDroppable=id;
                    xui.asyRun(function(){delete xui.Event._preDroppable});
                }

                //if fire dd, prevent to fire parent dd
                //notice: this dont trigger cursor changing in opera
                if(src.$xid==dragdrop._dropElement)
                    r=false;
            }

            if(r===false)self.stopBubble(event);
            return r;
        }
    },
    Static:{
        $FALSE:xui.browser.opr?undefined:false,
        _type:{},
        _kb:{keydown:1,keypress:1,keyup:1},
        _reg:/(-[\w]+)|([\w]+$)/g,
        $eventhandler:function(){return xui.Event(arguments[0],this)},
        $eventhandler2:function(){return xui.Event(arguments[0],this,1)},
        $eventhandler3:function(){return xui.Event(arguments[0],xui.Event.getSrc(arguments[0]||window.event))},
        $lastMouseupTime:0,
        $dblcInterval:500,
        $lastClickFunMark:0,
        //collection
        _events : ("mouseover,mouseout,mousedown,mouseup,mousemove,mousewheel,click,dblclick,contextmenu," +
                "keydown,keypress,keyup,scroll,"+
                "blur,focus,"+
                "load,unload,beforeunload,abort,"+
                "change,select,submit,reset,error,"+
                //customized handlers:
                //dont use resize in IE
                "move,size," +
                //dragstart dragdrop dragout will not work in IE(using innerHTML)
                // Use "dragbegin instead of dragstart" to avoid native DnD
                "dragbegin,drag,dragstop,dragleave,dragenter,dragover,drop,"+
                // touch event
                "touchstart,touchmove,touchend,touchcancel,mspointerdown,mspointermove,mspointerup,mspointercancel,pointerdown,pointermove,pointerup,pointercancel")
                .split(','),
        simulateEvent : function(target, type, options, fromtype) {
            options = options || {};
            if(target[0])target = target[0];
            xui.tryF(xui.Event.$eventsforSimulation[fromtype||type],[target, type, options]);
        },
        _getEventName:function(name,pos){
            return (name=this._map1[name]) && ((pos===0||pos==1||pos==2) ? name[pos] : name);
        },
        _getProfile:function(id,a,b){
            return id && (typeof id=='string') && ((a=(b=xui.$cache.profileMap)[id])
                            ?
                            a['xui.UIProfile']
                                ?
                                a
                                :
                                (b=b[id.replace(this._reg,'')])
                                    ?
                                    b
                                    :
                                    a
                            :
                            b[id.replace(this._reg,'')]);
        },
        _handleTabHook:function(src, target){
            if(src===document)return true;
            var node=src,r,tabindex=node.tabIndex;
            do{
                if(xui.getId(node)==target[0]){
                    node=src=null;
                    return true;
                }
            }while(node && (node=node.parentNode) && node!==document && node!==window)

            r=xui.tryF(target[1],[target[0],tabindex],src);
            node=src=null;
            return false;
        },
        _handleMouseHover:function(event,target,dd){
            if(target==document){
                target=null;
                return true;
            }
            var node = (event.type=='mouseover'?event.fromElement:event.toElement)||event.relatedTarget;

            //When out of droppable node, if the parent node is droppable return true;
            if(dd && event.type=='mouseover' &&this._preDroppable)
                try{
                    do{
                        if(node && node.id && node.id==this._preDroppable){
                            target=node=null;
                            return true
                        }
                    }while(node && (node=node.parentNode) && node!==document && node!==window)
                }catch(a){}

            //for firefox wearing anynomous div in input/textarea
            //related to 'div.anonymous-div' always returns true
            if(xui.browser.gek)
                try{
                    do{
                        if(node==target){
                            target=node=null;
                            return false
                        }
                    }while(node && (node=node.parentNode))
                }catch(a){
                    var pos=this.getPos(event),
                        node=xui([target]),
                        p=node.offset(),
                        s=node.cssSize(),
                        out=(pos.left<p.left||pos.left>p.left+s.width||pos.top<p.top||pos.top>p.top+s.height);
                    target=node=null;
                    return event.type=='mouseover'?!out:out;
                }
            else
                do{
                    if(node==target){
                        target=node=null;
                        return false
                    }
                }while(node && (node=node.parentNode))
            target=node=null;
            return true;
        },

        _tabHookStack:[],
        pushTabOutTrigger:function(boundary, trigger){this._tabHookStack.push([xui(boundary)._nodes[0], trigger]);return this},
        popTabOutTrigger:function(flag){if(flag)this._tabHookStack=[];else this._tabHookStack.pop();return this},
        getSrc:function(event){
            var a;
            return ((a=event.target||event.srcElement||null) && xui.browser.kde && a.nodeType == 3)?a.parentNode:a
        },
        getId:function(node){
            return window===node?"!window":document===node?"!document":node.id;
        },
        // only for mousedown and mouseup
        // return 1 : left button, else not left button
        getBtn:function(event){
            return xui.browser.ie ?
                    event.button==4 ?
                        'middle' :
                            event.button==2 ?
                                'right' :
                                    'left' :
                    event.which==2 ?
                        'middle':
                            event.which==3 ?
                                'right':
                                    'left';
        },
        getPos:function(event){
            event = event || window.event;
            if(xui.browser.isTouch && event.changedTouches && event.changedTouches[0])
                event = event.changedTouches[0];

            if('pageX' in event)
                return {left:event.pageX, top:event.pageY};
            else{
    			var d=document, doc = d.documentElement, body = d.body,t,
    			_L = (xui.isSet(t=doc && doc.scrollLeft)?t:xui.isSet(t=body && body.scrollLeft)?t:0) - (xui.isSet(t=doc.clientLeft)?t:0),
    			_T = (xui.isSet(t=doc && doc.scrollTop)?t:xui.isSet(t=body && body.scrollTop)?t:0) - (xui.isSet(t=doc.clientTop)?t:0);
                return {left:event.clientX+_L, top:event.clientY+_T};
            }
        },
        /*return array(key, control, shift, alt)
        ['k','1','',''] : 'k' pressed, 'control' pressed, 'shift' and 'alt' not pressed
        */
        /*
        opear in window:
            ' = right (39)
            - = insert (45)
            . = del (46)
        */
        getKey:function(event){
            // for the fake one
            if(event&&event.$xuievent)return event;

            event=event||window.event;
            // use keyCode first for newer safari
            var res=[],t, k= event.$key || event.keyCode || event.charCode || 0;
            //from xui event
            if(typeof k == 'string')
                res[0]=k;
            else{
                var key= String.fromCharCode(k),
                    type=event.type;
                if(
                 //visible char
                 (type=='keypress' && k>=33 && k<=128)
                 //0-9, A-Z
                 ||((k>=48&&k<=57) || (k>=65&&k<=90))
                 )res[0]=key;
                else{
                    if(!(t=arguments.callee.map)){
                        t = arguments.callee.map ={};
                        var k,arr =
                        ("3,enter,8,backspace,9,tab,12,numlock,13,enter,19,pause,20,capslock," +
                        "27,esc,32, ,33,pageup,34,pagedown,35,end,36,home,37,left,38,up,39,right,40,down,44,printscreen," +
                        "45,insert,46,delete,50,down,52,left,54,right,56,up," +
                        "91,win,92,win,93,apps," +
                        "96,0,97,1,98,2,99,3,100,4,101,5,102,6,103,7,104,8,105,9," +
                        "106,*,107,+,109,-,110,.,111,/," +
                        "112,f1,113,f2,114,f3,115,f4,116,f5,117,f6,118,f7,119,f8,120,f9,121,f10,122,f11,123,f12," +
                        "144,numlock,145,scroll," +
                        "186,;,187,=,189,-,190,.,191,/,192,`,"+
                        "219,[,220,\\,221,],222,'," +
                        "224,meta,"+ //Apple Meta and Windows key
                        //safari
                        "63289,numlock,63276,pageup,63277,pagedown,63275,end,63273,home,63234,left,63232,up,63235,right,63233,down,63272,delete,63302,insert,63236,f1,63237,f2,63238,f3,63239,f4,63240,f5,63241,f6,63242,f7,63243,f8,63244,f9,63245,f10,63246,f11,63247,f12,63248,print"
                        ).split(',')
                        for(var i=1,l=arr.length; i<l; i=i+2)
                            t[arr[i-1]]=arr[i]
                        arr.length=0;
                        //add
                        t[188]=',';
                    }
                    res[0]= t[k] || key;
                }
            }

            //control
            if((event.modifiers)?(event.modifiers&Event.CONTROL_MASK):(event.ctrlKey||event.ctrlLeft||k==17||k==57391)){
                if(k==17||k==57391)
                    res[0]='';
                res.push('1');
            }else
                res.push('');

            //shift
            if((event.modifiers)?(event.modifiers&Event.SHIFT_MASK):(event.shiftKey||event.shiftLeft||k==16||k==57390)){
                if(k==16||k==57390)
                    res[0]='';
                res.push('1');
            }else
                res.push('');

            //alt
            if((event.modifiers)?false:(event.altKey||event.altLeft||k==18||k==57388)){
                if(k==18||k==57388)
                    res[0]='';
                res.push('1');
            }else
                res.push('');

            // use keydown char
            res[0]=res[0];
            res.key=res[0];
            res.keyCode=k;
            res.type=type;
            res.ctrlKey=!!res[1];
            res.shiftKey=!!res[2];
            res.altKey=!!res[3];

            if(type=='keypress'){
                if(this.$keydownchar && this.$keydownchar.length>1)
                    res.key=this.$keydownchar;
            }
            // keep the prev keydown char
            else if(type=='keydown'){
                if(res[0].length>1)
                    this.$keydownchar=res[0];
                else if(this.$keydownchar)
                    this.$keydownchar=null;
            }
            // clear it
            else if(type=='keyup'){
                if(this.$keydownchar)
                    this.$keydownchar=null;
            }

            return res;
        },
        getEventPara:function(event, mousePos){
            if(!mousePos)mousePos=xui.Event.getPos(event);
            var keys = this.getKey(event), 
            button=this.getBtn(event), 
            h={
                button:button,
                pageX:mousePos&&mousePos.left,
                pageY:mousePos&&mousePos.top,
                key:keys.key,
                keyCode:keys.keyCode,
                ctrlKey:keys.ctrlKey,
                shiftKey:keys.shiftKey,
                altKey:keys.altKey
            };
            for(var i in event)if(i.charAt(0)=='$')h[i]=event[i];
            return h;
        },
        stopBubble:function(event){
            event=event||window.event;
            if(event.stopPropagation)event.stopPropagation();
            if("cancelBubble" in event)event.cancelBubble = true;
            this.stopDefault(event);
        },
        stopDefault:function(event){
            event=event||window.event;
            if(event.preventDefault)event.preventDefault();
            else if("returnValue" in event)event.returnValue = false;
        },
        _kbh:function(cache, key, ctrl, shift, alt, fun, id, args, scope, base){
            if(key){
                id = id || ((typeof fun=='string') ? fun :null);
                key = (key||'').toLowerCase() + ":"  + (ctrl?'1':'') + ":"  +(shift?'1':'')+ ":" + (alt?'1':'');
                cache[key] = cache[key]||[];
                if(typeof fun=='function'){
                    // remove previous attach
                    // try 1
                    if(id){
                        delete cache[key][id];
                        xui.arr.removeValue(cache[key], id);
                    }else id=xui.rand();

                    cache[key][id]=[fun,args,scope,base]
                    cache[key].push( id );
                    return id;
                }else{
                    if(id){
                        delete cache[key][id];
                        xui.arr.removeValue(cache[key], id);
                    }else
                        delete cache[key];
                }
            }
            return this;
        },
        //key:control:shift:alt
        keyboardHook:function(key, ctrl, shift, alt, fun, id, args, scope, base){
            return this. _kbh(xui.$cache.hookKey, key, ctrl, shift, alt, fun, id, args, scope, base);
        },
        keyboardHookUp:function(key, ctrl, shift, alt, fun, id, args,scope, base){
            return this. _kbh(xui.$cache.hookKeyUp, key, ctrl, shift, alt, fun, id, args, scope, base);
        },
        getWheelDelta:function(e){
            return e.wheelDelta
            // ie/opr/kde
            ?e.wheelDelta/120
            // gek
            :-e.detail/3
        },
        $TAGNAMES:{
          'select':'input','change':'input',  
          'submit':'form','reset':'form',  
          'error':'img','load':'img','abort':'img'  
        },
        _supportCache:{},
        isSupported:function(name, node) {
            var ns=this,c=ns._supportCache,rn=(node?node.tagName.toLowerCase():"div")+":"+name;
            if(rn in c)return c[rn];
            node = node || document.createElement(ns.$TAGNAMES[name] || 'div');
            name = 'on' + name;
            // When using `setAttribute`, IE skips "unload", WebKit skips "unload" and "resize", whereas `in` "catches" those
            var isSupported = (name in node);
            if (!isSupported) {
              // if it has no `setAttribute` (i.e. doesn't implement Node interface), try generic node
              if(!node.setAttribute)node = document.createElement('div');
                if(node.setAttribute) {
                  node.setAttribute(name, '');
                  isSupported = typeof node[name] == 'function';
                  if (typeof node[name] != 'undefined')node[name] = undefined;
                  node.removeAttribute(name);
                }
            }
            node = null;
            return c[rn]=isSupported;
        },
        _simulateMousedown:function(event){
            if(!event.touches)return true;
            var E=xui.Event,
                touches = event.changedTouches, 
                first = touches[0];
            if(event.touches.length>1)return true;

            E.__simulatedMousedownNode=first.target;

            if(!E.isSupported("mousedown")){
                E.simulateEvent(first.target,"mousedown",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY});
            }else{
                // use custom event to avoid affecting system or 3rd lib
                // it will fire xui beforeMousedown event group only
                // Needs delay to allow the browser to determine if the user is performing another gesture (etc. double-tap zooming)
                E._xuitouchdowntime=xui.setTimeout(function(){
                    E._xuitouchdowntime=0;
                    E.simulateEvent(first.target,"xuitouchdown",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY},'mousedown');
                },100);
            }
            
            return true;
        },
        _simulateMouseup:function(event){
            if(!event.touches)return true;
            var E=xui.Event,
                _now=(new Date).getTime(),
                interval=_now-E.$lastMouseupTime,
                touches = event.changedTouches, first = touches[0];
            if(E._xuitouchdowntime){
                xui.clearTimeout(E._xuitouchdowntime);
            }
            E.__simulatedMouseupNode=first.target;
            if(!E.isSupported("mouseup")){
                E.simulateEvent(first.target,"mouseup",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY});
            }

            // click and dblclick
            if(E.__simulatedMouseupNode===E.__simulatedMousedownNode){
                if(!E.isSupported("click")){
                    E.simulateEvent(first.target,"click",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY});
                }
                // doubleclick for touch event
                if(interval<=E.$dblcInterval){
                    xui.asyRun(function(){
                        // disalbe next one
                        E.$lastMouseupTime=0;
                        E.simulateEvent(first.target,"dblclick",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY});
                    });
                }
            }
            E.__simulatedMouseupNode=E.__simulatedMousedownNode=null;
            E.$lastMouseupTime=_now;

            return true;
        },
        stopPageTouchmove:function(){
            document.addEventListener(
                (xui.browser.ie&&xui.browser.ver>=11)?"pointermove":
                (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerMove":
                'touchmove', function(e){ e.preventDefault(); });
        }
    },
    Initialize:function(){
        var ns=this,
        w=window,
        d=document,
        m1={
            move:null,
            size:null,

            drag:null,
            dragstop:null,
            dragover:null,

            mousewheel:null,

            dragbegin:'onmousedown',
            dragenter:'onmouseover',
            dragleave:'onmouseout',
            drop:'onmouseup'
        },
        a1=['before','on','after'],
        t1,t2,s;
        
        t1=ns._map1={};
        xui.arr.each(ns._events,function(o){
            s=xui.str.initial(o);
            t1[o]=[a1[0]+s, a1[1]+s, a1[2]+s];
        });
        
        t1=ns._eventMap={};
        t2=ns._eventHandler={};
        xui.arr.each(ns._events,function(o){
            s=xui.str.initial(o);
            t1[o]=t1[a1[1]+o]=t1[a1[0]+s]=t1[a1[1]+s]=t1[a1[2]+s]= o;
            t2[o]=t2[a1[1]+o]=t2[a1[0]+s]=t2[a1[1]+s]=t2[a1[2]+s]= (o in m1)?m1[o]:('on'+o);
        });
        
        //add the root resize handler
        w.onresize=ns.$eventhandler;

        if (w.addEventListener)
            w.addEventListener('DOMMouseScroll', ns.$eventhandler3, false);

        // for simulation dblclick event in touchable device
        if(xui.browser.isTouch){
            if(d.addEventListener){
                d.addEventListener(
                    (xui.browser.ie&&xui.browser.ver>=11)?"pointerdown":
                    (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerDown":
                    "touchstart", ns._simulateMousedown, false/*need bubble*/);
                d.addEventListener(
                    (xui.browser.ie&&xui.browser.ver>=11)?"pointerup":
                    (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerUp":
                    "touchend", ns._simulateMouseup, false/*need bubble*/);
                d.addEventListener("xuitouchdown", ns.$eventhandler,false);
            }else if(d.attachEvent){
                d.attachEvent(
                    (xui.browser.ie&&xui.browser.ver>=11)?"pointerdown":
                    (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerDown":
                    "touchstart", ns._simulateMousedown);
                d.attachEvent(
                    (xui.browser.ie&&xui.browser.ver>=11)?"pointerup":
                    (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerUp":
                    "touchend", ns._simulateMouseup);
                d.attachEvent("xuitouchdown", ns.$eventhandler);
            }
        }

        // for simulation
        d.onmousewheel=w.onmousewheel =ns.$eventhandler3;
        
        var keyEvent=function(target, type , options){
            switch(type) {
                case "textevent":
                    type = "keypress"
                    break
                case "keyup":
                case "keydown":
                case "keypress":
                    break;
            }
           xui.merge(options,{
                bubbles :true,
                cancelable:true,
                view:w,
                ctrlKey:false,
                altKey:false,
                shiftKey:false,
                metaKey:false,
                keyCode : 0,
                charCode : 0
            },'without');
            var bubbles=options.bubbles,
                cancelable=options.cancelable,
                view=options.view,
                ctrlKey=options.ctrlKey,
                altKey=options.altKey,
                shiftKey=options.shiftKey,
                metaKey=options.metaKey,
                keyCode=options.keyCode,
                charCode=options.charCode;

            var customEvent = null;
            if (d.createEvent){    
                try {
                    customEvent = d.createEvent("KeyEvents");
                    // TODO: special decipher in Firefox
                    customEvent.initKeyEvent(type, bubbles, cancelable, view, ctrlKey,altKey, shiftKey, metaKey, keyCode, charCode);
                } catch (ex) {
                    try {
                        customEvent = d.createEvent("Events");    
                    } catch (uierror) {
                        customEvent = d.createEvent("UIEvents");    
                    } finally {
                        customEvent.initEvent(type, bubbles, cancelable);
                        customEvent.view = view;
                        customEvent.altKey = altKey;
                        customEvent.ctrlKey = ctrlKey;
                        customEvent.shiftKey = shiftKey;
                        customEvent.metaKey = metaKey;
                        customEvent.keyCode = keyCode;
                        customEvent.charCode = charCode;    
                    }
                }
                target.dispatchEvent(customEvent);    
                
            } 
            // for IE
            else if(d.createEventObject) {
                customEvent = d.createEventObject();
    
                customEvent.bubbles = bubbles;
                customEvent.cancelable = cancelable;
                customEvent.view = view;
                customEvent.ctrlKey = ctrlKey;
                customEvent.altKey = altKey;
                customEvent.shiftKey = shiftKey;
                customEvent.metaKey = metaKey;
        
    
                customEvent.keyCode = (charCode > 0) ? charCode : keyCode;
        
                target.fireEvent("on" + type, customEvent);
            } else {
                throw type + ' cant be simulated in ' + navigator.userAgent;
            }
        },
        mouseEvent=function(target, type , options){
           options=options||{};
           xui.merge(options,{
                bubbles :true,
                cancelable:true,
                view:w,
                detail:1,
                ctrlKey:false,
                altKey:false,
                shiftKey:false,
                metaKey:false,
                screenX:0,
                screenY:0,
                clientX:0,
                clientY:0,
                button:0,
                relatedTarget: null
            },'without');
            var bubbles=options.bubbles,
                cancelable=options.cancelable,
                view=options.view,
                detail=options.detail,
                ctrlKey=options.ctrlKey,
                altKey=options.altKey,
                shiftKey=options.shiftKey,
                metaKey=options.metaKey,
                screenX=options.screenX,
                screenY=options.screenY,
                clientX=options.clientX,
                clientY=options.clientY,
                button=options.button,
                relatedTarget=options.relatedTarget;
        
            var customEvent = null;    
            if (d.createEvent){    
                customEvent = d.createEvent("MouseEvents");
                
                if (customEvent.initMouseEvent){
                    customEvent.initMouseEvent(type, bubbles, cancelable, view, detail,
                                         screenX, screenY, clientX, clientY,
                                         ctrlKey, altKey, shiftKey, metaKey,
                                         button, relatedTarget);
                }
                // Safari 2.x doesn't support initMouseEvent
                else {
                    customEvent = d.createEvent("UIEvents");
                    customEvent.initEvent(type, bubbles, cancelable);
                    customEvent.view = view;
                    customEvent.detail = detail;
                    customEvent.screenX = screenX;
                    customEvent.screenY = screenY;
                    customEvent.clientX = clientX;
                    customEvent.clientY = clientY;
                    customEvent.ctrlKey = ctrlKey;
                    customEvent.altKey = altKey;
                    customEvent.metaKey = metaKey;
                    customEvent.shiftKey = shiftKey;
                    customEvent.button = button;
                    customEvent.relatedTarget = relatedTarget;
                }
    
                if (relatedTarget && !customEvent.relatedTarget) {
                    if (type === "mouseout") {
                        customEvent.toElement = relatedTarget;
                    } else if (type === "mouseover") {
                        customEvent.fromElement = relatedTarget;
                    }
                }
                target.dispatchEvent(customEvent);
            }
            //IE
            else if(d.createEventObject){
                customEvent = d.createEventObject();
        
                customEvent.bubbles = bubbles;
                customEvent.cancelable = cancelable;
                customEvent.view = view;
                customEvent.detail = detail;
                customEvent.screenX = screenX;
                customEvent.screenY = screenY;
                customEvent.clientX = clientX;
                customEvent.clientY = clientY;
                customEvent.ctrlKey = ctrlKey;
                customEvent.altKey = altKey;
                customEvent.metaKey = metaKey;
                customEvent.shiftKey = shiftKey;
        
                switch(button) {
                    case 0:
                        customEvent.button = 1;
                        break;
                    case 1:
                        customEvent.button = 4;
                        break;
                    case 2:
                        //leave as is
                        break;
                    default:
                        customEvent.button = 0;
                }
        
                customEvent.relatedTarget = relatedTarget;
        
                target.fireEvent("on" + type, customEvent);    
            } else {
                throw type + ' cant be simulated in ' + navigator.userAgent;
            }
        },
        UIEvent=function(target, type , options){    
           xui.merge(options,{
                bubbles : true,
                cancelable:(type === "submit"),
                view:w,
                detail:1
            },'without');
            var bubbles=options.bubbles,
                cancelable=options.cancelable,
                view=options.view,
                detail=options.detail;
    
            var customEvent = null;
            if (d.createEvent){    
                customEvent = d.createEvent("UIEvents");
                customEvent.initUIEvent(type, bubbles, cancelable, view, detail);
                target.dispatchEvent(customEvent);    
            }
            //IE
            else if(d.createEventObject){ 
                customEvent = d.createEventObject();
                customEvent.bubbles = bubbles;
                customEvent.cancelable = cancelable;
                customEvent.view = view;
                customEvent.detail = detail;
    
                target.fireEvent("on" + type, customEvent);    
            } else {
                throw type + ' cant be simulated in ' + navigator.userAgent;
            }
        },
        // for ios v2.0+
        gestureEvent=function(target, type , options){
           xui.merge(options,{
                bubbles :true,
                cancelable:true,
                detail:2,
                view:w,
                ctrlKey:false,
                altKey:false,
                shiftKey:false,
                metaKey:false,
                scale : 1.0,
                rotation : 0.0
            },'without');
            var bubbles=options.bubbles,
                cancelable=options.cancelable,
                detail=options.detail,
                view=options.view,
                ctrlKey=options.ctrlKey,
                altKey=options.altKey,
                shiftKey=options.shiftKey,
                metaKey=options.metaKey,
                scale=options.scale,
                rotation=options.rotation;
        
            var customEvent;
            customEvent = d.createEvent("GestureEvent");
            customEvent.initGestureEvent(type, bubbles, cancelable, view, detail,
                screenX, screenY, clientX, clientY,
                ctrlKey, altKey, shiftKey, metaKey,
                target, scale, rotation);
            target.dispatchEvent(customEvent);
        },
        touchEvent=function(target, type , options){
            if (type === 'touchstart' || type === 'touchmove') {
                if (!options.touches || !options.touches.length) {
                    throw 'No touch object in touches.';
                }
            } else if (type === 'touchend') {
                if (!options.changedTouches || !options.changedTouches.length) {
                    throw 'No touch object in changedTouches.';
                }
            }
           xui.merge(options,{
                bubbles :true,
                cancelable:(type !== "touchcancel"),
                detail:1,
                view:w,
                ctrlKey:false,
                altKey:false,
                shiftKey:false,
                metaKey:false,
                screenX:0,
                screenY:0,
                clientX:0,
                clientY:0,
                scale : 1.0,
                rotation : 0.0
            },'without');
            var bubbles=options.bubbles,
                cancelable=options.cancelable,
                detail=options.detail,
                view=options.view,
                scale=options.scale,
                rotation=options.rotation,
                touches=options.touches,
                targetTouches=options.targetTouches,
                changedTouches=options.changedTouches,
                ctrlKey=options.ctrlKey,
                altKey=options.altKey,
                shiftKey=options.shiftKey,
                metaKey=options.metaKey,
                screenX=options.screenX,
                screenY=options.screenY,
                clientX=options.clientX,
                clientY=options.clientY,
                cancelable = type=="touchcancel"? false : options.cancelable;
            var customEvent;
            if (d.createEvent){
                if (xui.browser.isAndroid) {
                    if (xui.browser.ver < 4.0) {
                        customEvent = d.createEvent("MouseEvents");
                        customEvent.initMouseEvent(type, bubbles, cancelable, view, detail, 
                            screenX, screenY, clientX, clientY,
                            ctrlKey, altKey, shiftKey, metaKey,
                            0, target);
                        customEvent.touches = touches;
                        customEvent.targetTouches = targetTouches;
                        customEvent.changedTouches = changedTouches;
                    } else {
                        customEvent = d.createEvent("TouchEvent");
                        // Andoroid isn't compliant W3C initTouchEvent
                        customEvent.initTouchEvent(touches, targetTouches, changedTouches,
                            type, view,
                            screenX, screenY, clientX, clientY,
                            ctrlKey, altKey, shiftKey, metaKey);
                    }
                } else if (xui.browser.isIOS) {
                    if (xui.browser.ver >= 2.0) {
                        customEvent = d.createEvent("TouchEvent");
                        customEvent.initTouchEvent(type, bubbles, cancelable, view, detail,
                            screenX, screenY, clientX, clientY,
                            ctrlKey, altKey, shiftKey, metaKey,
                            touches, targetTouches, changedTouches,
                            scale, rotation);
                    } else {
                        throw type + ' cant be simulated in ' + navigator.userAgent;
                    }
                } else {
                    throw type + ' cant be simulated in ' + navigator.userAgent;
                }
                target.dispatchEvent(customEvent);
            } else {
                throw type + ' cant be simulated in ' + navigator.userAgent;
            }
        };
        ns.$eventsforSimulation={
            click: mouseEvent,
            dblclick: mouseEvent,
            mouseover: mouseEvent,
            mouseout: mouseEvent,
            mouseenter: mouseEvent,
            mouseleave: mouseEvent,
            mousedown: mouseEvent,
            mouseup: mouseEvent,
            mousemove: mouseEvent,
            pointerover:  mouseEvent,
            pointerout:   mouseEvent,
            pointerdown:  mouseEvent,
            pointerup:    mouseEvent,
            pointermove:  mouseEvent,
            MSPointerOver:  mouseEvent,
            MSPointerOut:   mouseEvent,
            MSPointerDown:  mouseEvent,
            MSPointerUp:    mouseEvent,
            MSPointerMove:  mouseEvent,
            
            keydown: keyEvent,
            keyup: keyEvent,
            keypress: keyEvent,
            
            submit: UIEvent,
            blur: UIEvent,
            change: UIEvent,
            focus: UIEvent,
            resize: UIEvent,
            scroll: UIEvent,
            select: UIEvent,
            
            touchstart: touchEvent,
            touchmove: touchEvent,
            touchend: touchEvent,
            touchcancel: touchEvent,
            
            gesturestart: gestureEvent,
            gesturechange: gestureEvent,
            gestureend: gestureEvent
        };
    }
});xui.Class('xui.Date',null,{
    Initialize:function(){
        var self=this;
        self._mapKeys(self.$TIMEUNIT);
        var a=self._key1,b=self._key2,u=self.$UNIT={};
        for(var i=0,l=a.length;i<l;i++)u[a[i]]=1;
        for(var i=0,l=b.length;i<l;i++)u[b[i]]=1;
        u.w=1;
    },
    Static:{
        _key1:'MILLISECOND,SECOND,MINUTE,HOUR,DAY,WEEK,MONTH,QUARTER,YEAR,DECADE,CENTURY'.split(','),
        _key2:'ms,s,n,h,d,ww,m,q,y,de,c'.split(','),
        // Conversion factors
        $TIMEUNIT : {
            MILLISECOND : 1,
            SECOND      : 1000,           //SECONDS
            MINUTE      : 60000,          //MINUTES 60 * 1000
            HOUR        : 3600000,        //HOURS 60 * 60 * 1000
            DAY         : 86400000,       //DAYS 24 * 60 * 60 * 1000
            WEEK        : 604800000,      //WEEKS 7 * 24 * 60 * 60 * 1000
            MONTH       : 2592000000,     //MONTHS 30 * 24 * 60 * 60 * 1000  (approx = 1 month)
            QUARTER     : 7776000000,     //QUARTERS 90 * 24 * 60 * 60 * 1000  (approx = 3 months)
            YEAR        : 31557600000,    //YEARS 365 * 24 * 60 * 60 * 1000 (approx = 1 year)
            DECADE      : 315576000000,   //DECADES 10 * 365 * 24 * 60 * 60 * 1000 (approx = 1 decade)
            CENTURY     : 3155760000000   //CENTURIES 100 * 365 * 24 * 60 * 60 * 1000 (approx = 1 century)
        },
        $TEXTFORMAT:{
            utciso:function(d,w,f){f=xui.Date._fix; return d.getUTCFullYear() + '-' +f(d.getUTCMonth() + 1) + '-' +f(d.getUTCDate()) + 'T' +f(d.getUTCHours()) + ':' +f(d.getUTCMinutes()) + ':' +f(d.getUTCSeconds()) + 'Z'},
            iso:function(d,w,f){f=xui.Date._fix; return d.getFullYear() + '-' +f(d.getMonth() + 1) + '-' +f(d.getDate()) + 'T' +f(d.getHours()) + ':' +f(d.getMinutes()) + ':' +f(d.getSeconds())},
            ms:function(d,w){return xui.Date._fix(d.getMilliseconds(),3)+ (w?"":xui.wrapRes('date.MS'))},
            s:function(d,w){return d.getSeconds()+ (w?"":xui.wrapRes('date.S'))},
            ss:function(d,w){return xui.Date._fix(d.getSeconds())+ (w?"":xui.wrapRes('date.S'))},
            n:function(d,w){return d.getMinutes()+ (w?"":xui.wrapRes('date.N'))},
            nn:function(d,w){return xui.Date._fix(d.getMinutes())+ (w?"":xui.wrapRes('date.N'))},
            h :function(d,w){return d.getHours()+ (w?"":xui.wrapRes('date.H'))},
            hh :function(d,w){return xui.Date._fix(d.getHours())+ (w?"":xui.wrapRes('date.H'))},
            d:function(d,w){return d.getDate()+ (w?"":xui.wrapRes('date.D'))},
            dd:function(d,w){return xui.Date._fix(d.getDate())+ (w?"":xui.wrapRes('date.D'))},
            w : function(d,w,firstDayOfWeek){var a=(d.getDay() - firstDayOfWeek +7)%7; return w?a:xui.wrapRes('date.WEEKS.'+a)},
            ww : function(d,w,firstDayOfWeek){return xui.Date.getWeek(d, firstDayOfWeek) + (w?"":xui.wrapRes('date.W'))},
            m:function(d,w){return (d.getMonth()+1) + (w?"":xui.wrapRes('date.M'))},
            mm:function(d,w){return xui.Date._fix(d.getMonth()+1) + (w?"":xui.wrapRes('date.M'))},
            q : function(d,w){return (parseInt((d.getMonth()+3)/3-1,10) + 1) + (w?"":xui.wrapRes('date.Q'))},
            y :function(d,w){return d.getYear() + (w?"":xui.wrapRes('date.Y'))},
            yyyy :function(d,w){return d.getFullYear() + (w?"":xui.wrapRes('date.Y'))},
            de:function(d,w){return parseInt(d.getFullYear()/10,10) + (w?"":xui.wrapRes('date.DE'))},
            c:function(d,w){return parseInt(d.getFullYear()/100,10) + (w?"":xui.wrapRes('date.C'))},

            hn:function(d,w){return xui.wrapRes('date.HN-'+d.getHours()+"-"+d.getMinutes())},
            dhn:function(d,w){return xui.wrapRes('date.DHN-'+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes())},
            mdhn:function(d,w){return xui.wrapRes('date.MDHN-'+(d.getMonth()+1)+"-"+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes())},
            hns:function(d,w){return xui.wrapRes('date.HNS-'+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds())},
            hnsms:function(d,w){return xui.wrapRes('date.HNSMS-'+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds()+"-"+d.getMilliseconds())},

            yq:function(d,w){return xui.wrapRes('date.YQ-'+d.getFullYear()+"-"+(parseInt((d.getMonth()+3)/3-1,10)+1))},

            ym :   function(d,w){return xui.wrapRes('date.YM-'+d.getFullYear()+"-"+(d.getMonth()+1))},
            md :  function(d,w){return xui.wrapRes('date.MD-'+(d.getMonth()+1)+"-"+d.getDate())},
            ymd :  function(d,w){return xui.wrapRes('date.YMD-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate())},
            ymd2 :  function(d,w){return xui.wrapRes('date.YMD2-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate())},
            ymdh:  function(d,w){return xui.wrapRes('date.YMDH-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"-"+d.getHours())},
            ymdhn: function(d,w){return xui.wrapRes('date.YMDHN-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes())},
            ymdhns:function(d,w){return xui.wrapRes('date.YMDHNS-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds())},
            'all' :  function(d,w){return xui.wrapRes('date.ALL-'+d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds()+"-"+d.getMilliseconds())}
        },
        $TIMEZONE:[{
            id:"Asia(East,North)",
            sub:[{
                    id:"Brunei",
                    v:"+0800"
                },{
                    id:"Burma",
                    v:"+0630"
                },{
                    id:"Cambodia",
                    v:"+0700"
                },{
                    id:"China",
                    v:"+0800"
                },{
                    id:"China(HK,Macau)",
                    v:"+0800"
                },{
                    id:"China(TaiWan)",
                    v:"+0800"
                },{
                    id:"China(Urumchi)",
                    v:"+0700"
                },{
                    id:"East Timor",
                    v:"+0800"
                },{
                    id:"Indonesia",
                    v:"+0700"
                },{
                    id:"Japan",
                    v:"+0900"
                },{
                    id:"Kazakhstan(Aqtau)",
                    v:"+0400"
                },{
                    id:"Kazakhstan(Aqtobe)",
                    v:"+0500"
                },{
                    id:"Kazakhstan(Astana)",
                    v:"+0600"
                },{
                    id:"Kirghizia",
                    v:"+0500"
                },{
                    id:"Korea",
                    v:"+0900"
                },{
                    id:"Laos",
                    v:"+0700"
                },{
                    id:"Malaysia",
                    v:"+0800"
                },{
                    id:"Mongolia",
                    v:"+0800",
                    tag:"03L03|09L03"
                },{
                    id:"Philippines",
                    v:"+0800"
                },{
                    id:"Russia(Anadyr)",
                    v:"+1300",
                    tag:"03L03|10L03"
                },{
                    id:"Russia(Kamchatka)",
                    v:"+1200",
                    tag:"03L03|10L03"
                },{
                    id:"Russia(Magadan)",
                    v:"+1100",
                    tag:"03L03|10L03"
                },{
                    id:"Russia(Vladivostok)",
                    v:"+1000",
                    tag:"03L03|10L03"
                },{
                    id:"Russia(Yakutsk)",
                    v:"+0900",
                    tag:"03L03|10L03"
                },{
                    id:"Singapore",
                    v:"+0800"
                },{
                    id:"Thailand",
                    v:"+0700"
                },{
                    id:"Vietnam",
                    v:"+0700"
                }]
            },{
                id:"Asia(South,West)",
                sub:[{
                    id:"Afghanistan",
                    v:"+0430"
                },{
                    id:"Arab Emirates",
                    v:"+0400"
                },{
                    id:"Bahrain",
                    v:"+0300"
                },{
                    id:"Bangladesh",
                    v:"+0600"
                },{
                    id:"Bhutan",
                    v:"+0600"
                },{
                    id:"Cyprus",
                    v:"+0200"
                },{
                    id:"Georgia",
                    v:"+0500"
                },{
                    id:"India",
                    v:"+0530"
                },{
                    id:"Iran",
                    v:"+0330",
                    tag:"04 13|10 13"
                },{
                    id:"Iraq",
                    v:"+0300",
                    tag:"04 13|10 13"
                },{
                    id:"Israel",
                    v:"+0200",
                    tag:"04F53|09F53"
                },{
                    id:"Jordan",
                    v:"+0200"
                },{
                    id:"Kuwait",
                    v:"+0300"
                },{
                    id:"Lebanon",
                    v:"+0200",
                    tag:"03L03|10L03"
                },{
                    id:"Maldives",
                    v:"+0500"
                },{
                    id:"Nepal",
                    v:"+0545"
                },{
                    id:"Oman",
                    v:"+0400"
                },{
                    id:"Pakistan",
                    v:"+0500"
                },{
                    id:"Palestine",
                    v:"+0200"
                },{
                    id:"Qatar",
                    v:"+0300"
                },{
                    id:"Saudi Arabia",
                    v:"+0300"
                },{
                    id:"Sri Lanka",
                    v:"+0600"
                },{
                    id:"Syria",
                    v:"+0200",
                    tag:"04 13|10 13"
                },{
                    id:"Tajikistan",
                    v:"+0500"
                },{
                    id:"Turkey",
                    v:"+0200"
                },{
                    id:"Turkmenistan",
                    v:"+0500"
                },{
                    id:"Uzbekistan",
                    v:"+0500"
                },{
                    id:"Yemen",
                    v:"+0300"
                }]
            },{
                id:"North Europe",
                sub:[{
                    id:"Denmark",
                    v:"+0100",
                    tag:"04F03|10L03"
                },{
                    id:"Faroe Is.(DK)",
                    v:"+0100"
                },{
                    id:"Finland",
                    v:"+0200",
                    tag:"03L01|10L01"
                },{
                    id:"Iceland",
                    v:"+0000"
                },{
                    id:"Jan Mayen(Norway)",
                    v:"-0100"
                },{
                    id:"Norwegian",
                    v:"+0100"
                },{
                    id:"Svalbard(NORWAY)",
                    v:"+0100"
                },{
                    id:"Sweden",
                    v:"+0100",
                    tag:"03L01|10L01"
                }]
            },{
                id:"Eastern Europe",
                sub:[{
                    id:"Armenia",
                    v:"+0400"
                },{
                    id:"Austria",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Azerbaijan",
                    v:"+0400"
                },{
                    id:"Belarus",
                    v:"+0200",
                    tag:"03L03|10L03"
                },{
                    id:"Czech",
                    v:"+0100"
                },{
                    id:"Estonia",
                    v:"+0200"
                },{
                    id:"Georgia",
                    v:"+0500"
                },{
                    id:"Germany",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Hungarian",
                    v:"+0100"
                },{
                    id:"Latvia",
                    v:"+0200"
                },{
                    id:"Liechtenstein",
                    v:"+0100"
                },{
                    id:"Lithuania",
                    v:"+0200"
                },{
                    id:"Moldova",
                    v:"+0200"
                },{
                    id:"Poland",
                    v:"+0100"
                },{
                    id:"Rumania",
                    v:"+0200"
                },{
                    id:"Russia(Moscow)",
                    v:"+0300",
                    tag:"03L03|10L03"
                },{
                    id:"Slovakia",
                    v:"+0100"
                },{
                    id:"Switzerland",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Ukraine",
                    v:"+0200"
                },{
                    id:"Ukraine(Simferopol)",
                    v:"+0300"
                }]
            },{
                id:"Western Europe",
                sub:[{
                    id:"Andorra",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Belgium",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Channel Is.(UK)",
                    v:"+0000",
                    tag:"03L01|10L01"
                },{
                    id:"France",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Gibraltar(UK)",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Ireland",
                    v:"+0000",
                    tag:"03L01|10L01"
                },{
                    id:"Isle of Man(UK)",
                    v:"+0000",
                    tag:"03L01|10L01"
                },{
                    id:"Luxembourg",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Monaco",
                    v:"+0100"
                },{
                    id:"Netherlands",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"United Kingdom",
                    v:"+0000",
                    tag:"03L01|10L01"
                }]
            },{
                id:"South Europe",
                sub:[{
                    id:"Albania",
                    v:"+0100"
                },{
                    id:"Bosnia",
                    v:"+0100"
                },{
                    id:"Bulgaria",
                    v:"+0200"
                },{
                    id:"Croatia",
                    v:"+0100"
                },{
                    id:"Greece",
                    v:"+0200",
                    tag:"03L01|10L01"
                },{
                    id:"Holy See",
                    v:"+0100"
                },{
                    id:"Italy",
                    v:"+0100",
                    tag:"03L01|10L01"
                },{
                    id:"Macedonia",
                    v:"+0100"
                },{
                    id:"Malta",
                    v:"+0100"
                },{
                    id:"Montenegro",
                    v:"+0100"
                },{
                    id:"Portugal",
                    v:"+0000",
                    tag:"03L01|10L01"
                },{
                    id:"San Marino",
                    v:"+0100"
                },{
                    id:"Serbia",
                    v:"+0100"
                },{
                    id:"Slovenia",
                    v:"+0100"
                },{
                    id:"Span",
                    v:"+0100",
                    tag:"03L01|10L01"
                }]
            },{
                id:"North America",
                sub:[{
                    id:"Canada(AST)",
                    v:"-0400",
                    tag:"04F02|10L02"
                },{
                    id:"Canada(CST)",
                    v:"-0600",
                    tag:"04F02|10L02"
                },{
                    id:"Canada(EST)",
                    v:"-0500",
                    tag:"04F02|10L02"
                },{
                    id:"Canada(MST)",
                    v:"-0700",
                    tag:"04F02|10L02"
                },{
                    id:"Canada(NST)",
                    v:"-0330",
                    tag:"04F02|10L02"
                },{
                    id:"Canada(PST)",
                    v:"-0800",
                    tag:"04F02|10L02"
                },{
                    id:"Greenland(DK)",
                    v:"-0300"
                },{
                    id:"US(Central)",
                    v:"-0600",
                    tag:"03S02|11F02"
                },{
                    id:"US(Eastern)",
                    v:"-0500",
                    tag:"03S02|11F02"
                },{
                    id:"US(Mountain)",
                    v:"-0700",
                    tag:"03S02|11F02"
                },{
                    id:"US(Pacific)",
                    v:"-0800",
                    tag:"03S02|11F02"
                },{
                    id:"US(Alaska)",
                    v:"-0900"
                },{
                    id:"US(Arizona)",
                    v:"-0700"
                }]
            },{
                id:"South America",
                sub:[{
                    id:"Anguilla(UK)",
                    v:"-0400"
                },{
                    id:"Antigua&amp;Barbuda",
                    v:"-0400"
                },{
                    id:"Antilles(NL)",
                    v:"-0400"
                },{
                    id:"Argentina",
                    v:"-0300"
                },{
                    id:"Aruba(NL)",
                    v:"-0400"
                },{
                    id:"Bahamas",
                    v:"-0500"
                },{
                    id:"Barbados",
                    v:"-0400"
                },{
                    id:"Belize",
                    v:"-0600"
                },{
                    id:"Bolivia",
                    v:"-0400"
                },{
                    id:"Brazil(AST)",
                    v:"-0500",
                    tag:"10F03|02L03"
                },{
                    id:"Brazil(EST)",
                    v:"-0300",
                    tag:"10F03|02L03"
                },{
                    id:"Brazil(FST)",
                    v:"-0200",
                    tag:"10F03|02L03"
                },{
                    id:"Brazil(WST)",
                    v:"-0400",
                    tag:"10F03|02L03"
                },{
                    id:"British Virgin Is.(UK)",
                    v:"-0400"
                },{
                    id:"Cayman Is.(UK)",
                    v:"-0500"
                },{
                    id:"Chilean",
                    v:"-0300",
                    tag:"10F03|03F03"
                },{
                    id:"Chilean(Hanga Roa)",
                    v:"-0500",
                    tag:"10F03|03F03"
                },{
                    id:"Colombia",
                    v:"-0500"
                },{
                    id:"Costa Rica",
                    v:"-0600"
                },{
                    id:"Cuba",
                    v:"-0500",
                    tag:"04 13|10L03"
                },{
                    id:"Dominican",
                    v:"-0400"
                },{
                    id:"Ecuador",
                    v:"-0500"
                },{
                    id:"El Salvador",
                    v:"-0600"
                },{
                    id:"Falklands",
                    v:"-0300",
                    tag:"09F03|04F03"
                },{
                    id:"Grenada",
                    v:"-0400"
                },{
                    id:"Guadeloupe(FR)",
                    v:"-0400"
                },{
                    id:"Guatemala",
                    v:"-0600"
                },{
                    id:"Guiana(FR)",
                    v:"-0300"
                },{
                    id:"Guyana",
                    v:"-0400"
                },{
                    id:"Haiti",
                    v:"-0500"
                },{
                    id:"Honduras",
                    v:"-0600"
                },{
                    id:"Jamaica",
                    v:"-0500"
                },{
                    id:"Martinique(FR)",
                    v:"-0400"
                },{
                    id:"Mexico(Mazatlan)",
                    v:"-0700"
                },{
                    id:"Mexico(Tijuana)",
                    v:"-0800"
                },{
                    id:"Mexico(Mexico)",
                    v:"-0600"
                },{
                    id:"Montserrat(UK)",
                    v:"-0400"
                },{
                    id:"Nicaragua",
                    v:"-0500"
                },{
                    id:"Panama",
                    v:"-0500"
                },{
                    id:"Paraguay",
                    v:"-0400",
                    tag:"10F03|02L03"
                },{
                    id:"Peru",
                    v:"-0500"
                },{
                    id:"Puerto Rico(US)",
                    v:"-0400"
                },{
                    id:"So. Georgia&amp;So. Sandwich Is.(UK)",
                    v:"-0200"
                },{
                    id:"St. Kitts&amp;Nevis",
                    v:"-0400"
                },{
                    id:"St. Lucia",
                    v:"-0400"
                },{
                    id:"St. Vincent&amp;Grenadines",
                    v:"-0400"
                },{
                    id:"Suriname",
                    v:"-0300"
                },{
                    id:"Trinidad&amp;Tobago",
                    v:"-0400"
                },{
                    id:"Turks&amp;Caicos Is.(UK)",
                    v:"-0500"
                },{
                    id:"Uruguay",
                    v:"-0300"
                },{
                    id:"Venezuela",
                    v:"-0400"
                },{
                    id:"Virgin Is.(US)",
                    v:"-0400"
                }]
            },{
                id:"Africa(North)",
                sub:[{
                    id:"Algeria",
                    v:"+0100"
                },{
                    id:"Egypt",
                    v:"+0200",
                    tag:"04L53|09L43"
                },{
                    id:"Libyan",
                    v:"+0200"
                },{
                    id:"Morocco",
                    v:"+0000"
                },{
                    id:"Sudan",
                    v:"+0200"
                },{
                    id:"Tunisia",
                    v:"+0100"
                }]
            },{
                id:"Africa(Western)",
                sub:[{
                    id:"Benin",
                    v:"+0100"
                },{
                    id:"Burkina Faso",
                    v:"+0000"
                },{
                    id:"Canary Is.(SP)",
                    v:"-0100"
                },{
                    id:"Cape Verde",
                    v:"-0100"
                },{
                    id:"Chad",
                    v:"+0100"
                },{
                    id:"Gambia",
                    v:"+0000"
                },{
                    id:"Ghana",
                    v:"+0000"
                },{
                    id:"Guinea",
                    v:"+0000"
                },{
                    id:"Guinea-Bissau",
                    v:"+0000"
                },{
                    id:"Ivory Coast",
                    v:"+0000"
                },{
                    id:"Liberia",
                    v:"+0000"
                },{
                    id:"Mali",
                    v:"+0000"
                },{
                    id:"Mauritania",
                    v:"+0000"
                },{
                    id:"Niger",
                    v:"+0100"
                },{
                    id:"Nigeria",
                    v:"+0100"
                },{
                    id:"Senegal",
                    v:"+0000"
                },{
                    id:"Sierra Leone",
                    v:"+0000"
                },{
                    id:"Togo",
                    v:"+0000"
                },{
                    id:"Western Sahara",
                    v:"+0000"
                }]
            },{
                id:"Africa(Central)",
                sub:[{
                    id:"Cameroon",
                    v:"+0100"
                },{
                    id:"Cen.African Rep.",
                    v:"+0100"
                },{
                    id:"Congo,Democratic",
                    v:"+0100"
                },{
                    id:"Congo,Republic",
                    v:"+0100"
                },{
                    id:"Equatorial Guinea",
                    v:"+0100"
                },{
                    id:"Gabon",
                    v:"+0100"
                },{
                    id:"Sao Tome&amp;Principe",
                    v:"+0000"
                }]
            },{
                id:"Africa(East)",
                sub:[{
                    id:"Burundi",
                    v:"+0200"
                },{
                    id:"Comoros",
                    v:"+0300"
                },{
                    id:"Djibouti",
                    v:"+0300"
                },{
                    id:"Eritrea",
                    v:"+0300"
                },{
                    id:"Ethiopia",
                    v:"+0300"
                },{
                    id:"Kenya",
                    v:"+0300"
                },{
                    id:"Madagascar",
                    v:"+0300"
                },{
                    id:"Malawi",
                    v:"+0200"
                },{
                    id:"Mauritius",
                    v:"+0400"
                },{
                    id:"Mayotte(FR)",
                    v:"+0300"
                },{
                    id:"Mozambique",
                    v:"+0200"
                },{
                    id:"Reunion(FR)",
                    v:"+0400"
                },{
                    id:"Rwanda",
                    v:"+0200"
                },{
                    id:"Seychelles",
                    v:"+0300"
                },{
                    id:"Somalia",
                    v:"+0300"
                },{
                    id:"Tanzania",
                    v:"+0300"
                },{
                    id:"Uganda",
                    v:"+0300"
                }]
            },{
                id:"Africa(South)",
                sub:[{
                    id:"Angola",
                    v:"+0100"
                },{
                    id:"Botswana",
                    v:"+0200"
                },{
                    id:"Lesotho",
                    v:"+0200"
                },{
                    id:"Namibia",
                    v:"+0200",
                    tag:"09F03|04F03"
                },{
                    id:"Saint Helena(UK)",
                    v:"-0100"
                },{
                    id:"South Africa",
                    v:"+0200"
                },{
                    id:"Swaziland",
                    v:"+0200"
                },{
                    id:"Zambia",
                    v:"+0200"
                },{
                    id:"Zimbabwe",
                    v:"+0200"
                }]
            },{
                id:"Oceania",
                sub:[{
                    id:"American Samoa(US)",
                    v:"-1100"
                },{
                    id:"Australia(Adelaide)",
                    v:"+0930",
                    sub:"10L03|03L03"
                },{
                    id:"Australia(Brisbane)",
                    v:"+1000"
                },{
                    id:"Australia(Darwin)",
                    v:"+0930"
                },{
                    id:"Australia(Hobart)",
                    v:"+1000",
                    sub:"10L03|03L03"
                },{
                    id:"Australia(Perth)",
                    v:"+0800"
                },{
                    id:"Australia(Sydney)",
                    v:"+1000",
                    sub:"10L03|03L03"
                },{
                    id:"Cook Islands(NZ)",
                    v:"-1000"
                },{
                    id:"Eniwetok",
                    v:"-1200"
                },{
                    id:"Fiji",
                    v:"+1200",
                    sub:"11F03|02L03"
                },{
                    id:"Guam",
                    v:"+1000"
                },{
                    id:"Hawaii(US)",
                    v:"-1000"
                },{
                    id:"Kiribati",
                    v:"+1100"
                },{
                    id:"Marshall Is.",
                    v:"+1200"
                },{
                    id:"Micronesia",
                    v:"+1000"
                },{
                    id:"Midway Is.(US)",
                    v:"-1100"
                },{
                    id:"Nauru Rep.",
                    v:"+1200"
                },{
                    id:"New Calednia(FR)",
                    v:"+1100"
                },{
                    id:"New Zealand",
                    v:"+1200",
                    sub:"10F03|04F63"
                },{
                    id:"New Zealand(CHADT)",
                    v:"+1245",
                    sub:"10F03|04F63"
                },{
                    id:"Niue(NZ)",
                    v:"-1100"
                },{
                    id:"Nor. Mariana Is.",
                    v:"+1000"
                },{
                    id:"Palau",
                    v:"+0900"
                },{
                    id:"Papua New Guinea",
                    v:"+1000"
                },{
                    id:"Pitcairn Is.(UK)",
                    v:"-0830"
                },{
                    id:"Polynesia(FR)",
                    v:"-1000"
                },{
                    id:"Solomon Is.",
                    v:"+1100"
                },{
                    id:"Tahiti",
                    v:"-1000"
                },{
                    id:"Tokelau(NZ)",
                    v:"-1100"
                },{
                    id:"Tonga",
                    v:"+1300",
                    tag:"10F63|04F63"
                },{
                    id:"Tuvalu",
                    v:"+1200"
                },{
                    id:"Vanuatu",
                    v:"+1100"
                },{
                    id:"Western Samoa",
                    v:"-1100"
                },{
                    id:"Data Line",
                    v:"-1200"
                }]
            }
        ],
        //map like: MILLISECOND <=> ms
        _mapKeys:function(obj){
            var self=this, t=self._key2, m=self._key1;
            for(var i=0,l=m.length;i<l;i++)
                obj[t[i]]=obj[m[i]];
        },
        //get valid datepart
        _validUnit:function(datepart){
            return this.$UNIT[datepart]?datepart:'d';
        },
        _date:function(value,df){return xui.isDate(value) ? value : ((value || value===0)&&isFinite(value)) ? new Date(parseInt(value,10)) : xui.isDate(df) ? df : new Date},
        _isNumb:function(target)  {return typeof target == 'number' && isFinite(target)},
        _numb:function(value,df){return this._isNumb(value)?value:this._isNumb(df)?df:0},
        //time Zone like: -8
        _timeZone:-((new Date).getTimezoneOffset()/60),

        /*get specific date datepart
        *
        */
        get:function(date, datepart, firstDayOfWeek){
            var self=this;
            date = self._date(date);
            datepart = self._validUnit(datepart);
            firstDayOfWeek = self._numb(firstDayOfWeek);

            var map = arguments.callee.map || ( arguments.callee.map = {
                    ms:function(d){return d.getMilliseconds()},
                    s:function(d){return d.getSeconds()},
                    n:function(d){return d.getMinutes()},
                    h :function(d){return d.getHours()},
                    d:function(d){return d.getDate()},
                    ww:function(d,fd){return xui.Date.getWeek(d, fd)},
                    w :function(d,fd){return (7+d.getDay()-fd)%7},
                    m:function(d){return d.getMonth()},
                    q:function(d){return parseInt((d.getMonth()+3)/3-1,10)},
                    y :function(d){return d.getFullYear()},
                    de:function(d){return parseInt(d.getFullYear()/10,10)},
                    c:function(d){return parseInt(d.getFullYear()/100,10)}
                });
            return map[datepart](date,firstDayOfWeek);
        },
        /*
        * _fix(1,3,'0') => '100'
        */
        _fix:function(str,len,chr){
            len=len||2;
            chr=chr||'0';
            str+="";
            if(str.length<len)
                for(var i=str.length;i<len;i++)
                    str=chr+str;
            return str;
        },
        /*add specific datepart to date
        *
        */
        add: function(date, datepart, count ){
            var self=this,
                tu=self.$TIMEUNIT,
                map,
                date2;
            date = self._date(date);
            datepart = self._validUnit(datepart);


            if(!(map=arguments.callee.map)){
                map=arguments.callee.map = {
                    MILLISECOND:function(date,count){date.setTime(date.getTime() + count*tu.ms)},
                    SECOND:function(date,count){date.setTime(date.getTime() + count*tu.s)},
                    MINUTE:function(date,count){date.setTime(date.getTime() + count*tu.n)},
                    HOUR:function(date,count){date.setTime(date.getTime() + count*tu.h)},
                    DAY:function(date,count){date.setTime(date.getTime() + count*tu.d)},
                    WEEK:function(date,count){date.setTime(date.getTime() + count*tu.ww)},
                    MONTH:function(date,count){
                        var a=date.getDate(),b;
                        count = date.getMonth() + count;
                        this.YEAR(date, Math.floor(count/12));
                        date.setMonth((count%12+12)%12);
                        if((b=date.getDate())!=a)
                            this.DAY(date, -b)
                    },
                    QUARTER:function(date,count){this.MONTH(date,count*3)},
                    YEAR:function(date,count){
                        var a=date.getDate(),b;
                        date.setFullYear(date.getFullYear() + count)
                        if((b=date.getDate())!=a)
                            this.DAY(date, -b)
                    },
                    DECADE:function(date,count){this.YEAR(date,10*count)},
                    CENTURY:function(date,count){this.YEAR(date,100*count)}
                };
                self._mapKeys(map);
            }
            map[datepart](date2=new Date(date), count);
            return date2;
        },
        /*get specific datepart diff between startdate and date2
        *
        */
        diff:function(startdate, enddate, datepart, firstDayOfWeek) {
            var self=this;
            startdate = self._date(startdate);
            enddate = self._date(enddate);
            datepart = self._validUnit(datepart);
            firstDayOfWeek = self._numb(firstDayOfWeek);

            var tu=self.$TIMEUNIT,
                map;

            if(!(map=arguments.callee.map)){
                map = arguments.callee.map = {
                    MILLISECOND:function(startdate,enddate){return enddate.getTime()-startdate.getTime()},
                    SECOND:function(startdate,enddate){
                        var startdate = self.getTimSpanStart(startdate,'s'),
                            enddate = self.getTimSpanStart(enddate,'s'),
                            t=enddate.getTime()-startdate.getTime();
                        return t/tu.s;
                    },
                    MINUTE:function(startdate,enddate){
                        var startdate = self.getTimSpanStart(startdate,'n'),
                            enddate = self.getTimSpanStart(enddate,'n'),
                            t=enddate.getTime()-startdate.getTime();
                        return t/tu.n;
                    },
                    HOUR:function(startdate,enddate){
                        var startdate = self.getTimSpanStart(startdate,'h'),
                            enddate = self.getTimSpanStart(enddate,'h'),
                            t=enddate.getTime()-startdate.getTime();
                        return t/tu.h;
                    },
                    DAY:function(startdate,enddate){
                        var startdate = self.getTimSpanStart(startdate,'d',1),
                            enddate = self.getTimSpanStart(enddate,'d',1),
                            t=enddate.getTime()-startdate.getTime();
                        return t/tu.d;
                    },
                    WEEK:function(startdate,enddate,firstDayOfWeek){
                        var startdate = self.getTimSpanStart(startdate,'ww',1,firstDayOfWeek),
                            enddate = self.getTimSpanStart(enddate,'ww',1,firstDayOfWeek),
                            t=enddate.getTime()-startdate.getTime();
                        return t/tu.ww;
                    },
                    MONTH:function(startdate,enddate){return (enddate.getFullYear()-startdate.getFullYear())*12 + (enddate.getMonth()-startdate.getMonth())},
                    QUARTER:function(startdate,enddate){return (enddate.getFullYear()-startdate.getFullYear())*4 + parseInt((enddate.getMonth()-startdate.getMonth())/3,10)},
                    YEAR:function(startdate,enddate){return parseInt((enddate.getFullYear()-startdate.getFullYear()),10)},
                    DECADE:function(startdate,enddate){return parseInt((enddate.getFullYear()-startdate.getFullYear())/10,10)},
                    CENTURY:function(startdate,enddate){return parseInt((enddate.getFullYear()-startdate.getFullYear())/100,10)}
                };
                self._mapKeys(map);
            }
            return map[datepart](new Date(startdate),new Date(enddate),firstDayOfWeek);
        },
        /*get the first datepart begin of certain datepart
        *
        */
        getTimSpanStart: function(date, datepart, count, firstDayOfWeek) {
            var self=this,
                tu=self.$TIMEUNIT,
                map,date2;
            date = self._date(date);
            datepart = self._validUnit(datepart);
            firstDayOfWeek = self._numb(firstDayOfWeek);
            count=self._numb(count,1);
            if(!(map=arguments.callee.map)){
                var clearInDay = function(d) {
                        d.setMilliseconds(0);
                        d.setSeconds(0);
                        d.setMinutes(0);
                        d.setHours(0);
                    },
                    clearInYear = function(d) {
                        clearInDay(d);
                        d.setDate(1);
                        d.setMonth(0);
                    };

                map = arguments.callee.map = {
                    MILLISECOND:function(date,count){
                        var x = date.getMilliseconds();
                        date.setMilliseconds(x - (x % count));
                    },
                    SECOND:function(date,count){
                        date.setMilliseconds(0);
                        var x = date.getSeconds();
                        date.setSeconds(x - (x % count));
                    },
                    MINUTE:function(date,count){
                        date.setMilliseconds(0);
                        date.setSeconds(0);
                        var x = date.getMinutes();
                        date.setTime(date.getTime() - (x % count) * tu.n);
                    },
                    HOUR:function(date,count){
                        date.setMilliseconds(0);
                        date.setSeconds(0);
                        date.setMinutes(0);

                        var x = date.getHours();
                        date.setHours(x - (x % count));
                    },
                    DAY:function(date,count){
                        clearInDay(date);
                        var x=date.getDate();
                        date.setDate(x - (x % count));
                    },
                    WEEK:function(date,count,firstDayOfWeek){
                        clearInDay(date);

                        var d = (date.getDay() + 7 - firstDayOfWeek) % 7,date2,x, a=new Date();
                        date.setTime(date.getTime() - d * tu.d);
                        clearInYear(a);
                        a.setFullYear(date.getFullYear());
                        date2 = (a.getDay() + 7 - firstDayOfWeek) % 7;
                        a.setTime(a.getTime() - date2 * tu.d);

                        x= (date.getTime()-a.getTime())/tu.d/7;

                        date.setTime(date.getTime() - (x % count) * tu.ww);
                    },
                    MONTH:function(date,count){
                        clearInDay(date);
                        date.setDate(1);
                        var x = date.getMonth();
                        date.setMonth(x - (x % count));
                    },
                    QUARTER:function(date,count){
                        count=self._numb(count,1);
                        return this.MONTH(date, count*3);
                    },
                    YEAR:function(date,count){
                        clearInYear(date);
                        var x = date.getFullYear();
                        date.setFullYear(x - (x % count));
                    },
                    DECADE:function(date,count){
                        clearInYear(date);
                        date.setFullYear(Math.floor(date.getFullYear() / 10) * 10);
                    },
                    CENTURY:function(date,count){
                        clearInYear(date);
                        date.setFullYear(Math.floor(date.getFullYear() / 100) * 100);
                    }
                };
                self._mapKeys(map);

            }
            map[datepart](date2=new Date(date),count, firstDayOfWeek);
            return date2;
        },
        /*get the last datepart begin of certain datepart
        *
        */
        getTimSpanEnd : function(date, datepart, count,firstDayOfWeek) {
            var self=this;

            date = self._date(date);
            datepart = self._validUnit(datepart);
            firstDayOfWeek = self._numb(firstDayOfWeek);

            count=self._numb(count,1);

            var originalTime = date.getTime(),
                date2 = self.getTimSpanStart(date, datepart, count, firstDayOfWeek);
            if (date2.getTime() < originalTime)
                date2=self.add(date2, datepart, count);
            return date2;
        },
        /*fake a date for a certain timezone (based on the current timezone of "Date object")
        * You have to offset back it, if you expect a total real date:
        *   var localDate = new Date, timezone9Date=xui.Date.offsetTimeZone(localDate, 9);
        *   localDate.toString() == xui.Date.offsetTimeZone(timezone9Date, -9);
        */
        offsetTimeZone:function(date, targetTimeZone, back){
            var self=this;
            date=self._date(date);
            return new Date(date.getTime() + (back?-1:1)*(targetTimeZone - self._timeZone)*self.$TIMEUNIT.h);
        },

        /*get week
        *
        */
        getWeek:function(date, firstDayOfWeek){
            var self=this, date2, y;
            date=self._date(date);
            firstDayOfWeek = self._numb(firstDayOfWeek),
            y=date.getFullYear();

            date = self.add(self.getTimSpanStart(date, 'ww', 1, firstDayOfWeek),'d',6);

            if(date.getFullYear()!=y)return 1;

            date2 = self.getTimSpanStart(date, 'y', 1);
            date2 = self.add(self.getTimSpanStart(date2, 'ww', 1, firstDayOfWeek),'d',6);

            return self.diff(date2, date, 'ww')+1;
        },
        parse:function(str, format){
            var rtn;
            if(xui.isDate(str)){
                rtn=str;
            }else{
                // avoid null
                str+="";
                if(isFinite(str)){
                    rtn=new Date(parseInt(str,10));
                }else{
                    if(typeof format=='string'){
                        var a=format.split(/[^ymdhns]+/),
                            b=str.split(/[^0-9]+/),
                            n={y:0,m:0,d:0,h:0,n:0,s:0,ms:0};
                        if(a.length && a.length===b.length){
                            for(var i=0;i<a.length;i++)
                                if(a[i].length)
                                    n[a[i]=='ms'?'ms':a[i].charAt(0)]=parseInt(b[i].replace(/^0*/,''),10);
                            rtn=new Date(n.y,n.m-1,n.d,n.h,n.n,n.s,n.ms);
                        }else
                            rtn=null;
                    }else{

                        var self=this,utc,
                            me=arguments.callee,
                            dp=me.dp||(me.dp={
                              FullYear: 2,
                              Month: 4,
                              Date: 6,
                              Hours: 8,
                              Minutes: 10,
                              Seconds: 12,
                              Milliseconds: 14
                            }),
                            match = str.match(me.iso||(me.iso=/^((-\d+|\d{4,})(-(\d{2})(-(\d{2}))?)?)?T((\d{2})(:(\d{2})(:(\d{2})(\.(\d{1,3})(\d)?\d*)?)?)?)?(([+-])(\d{2})((\d{2}))?|Z)?$/)),
                            date = new Date(0)
                            ;
                        if(match){
                            //month
                            if(match[4])match[4]--;
                            //ms to 3 digits
                            if (match[15]>=5)match[14]++;
                            utc = match[16]||match[18]?"UTC":"";
                            for (var i in dp) {
                                var v = match[dp[i]];
                                if(!v)continue;
                                date["set" + utc + i](v);
                                if (date["get" + utc + i]() != match[dp[i]])
                                    rtn=null;
                            }
                            if(match[18]){
                                var h = Number(match[17] + match[18]),
                                    m = Number(match[17] + (match[20] || 0));
                                date.setUTCMinutes(date.getUTCMinutes() + (h * 60) + m);
                            }
                            rtn=date;
                        }else{
                            if(/^((-\d+|\d{4,})(-(\d{1,2})(-(\d{1,2}))))/.test(str))
                                str = str.replace(/-/g,'/');
                            var r=Date.parse(str);
                            rtn=r?date.setTime(r) && date:null;
                        }
                    }
                }
            }
            return rtn===null?null:isFinite(+rtn)?rtn:null;
        },
        getText:function(date, datepart, firstDayOfWeek){
            var self=this, map=self.$TEXTFORMAT;
            date = self._date(date);
            firstDayOfWeek = self._numb(firstDayOfWeek);
            return map[datepart]?map[datepart](date, false, firstDayOfWeek):datepart;
        },
        format:function(date, format, firstDayOfWeek){
            var self=this, map=self.$TEXTFORMAT;
            date = self._date(date);
            firstDayOfWeek = self._numb(firstDayOfWeek);
            return format.replace(/(utciso|iso|yyyy|mm|ww|dd|hh|nn|ss|ms|de|c|y|q|m|w|d|h|n|s)/g, function(a,b){
                return map[b]?map[b](date,true,firstDayOfWeek):b;
            });
        }
    }
});xui.Class("xui.CSS", null,{
    Static:{
        _r:xui.browser.ie?'rules':'cssRules',
        _baseid:'xui:css:base',
        _firstid:'xui:css:first',
        _lastid:'xui:css:last',
        _reg1:/\.(\w+)\[CLASS~="\1"\]/g,
        _reg2:/\[ID"([^"]+)"\]/g,
        _reg3:/\*([.#])/g,
        _reg4:/\s+/g,
        _reg5:/\*\|/g,
        _reg6:/(\s*,\s*)/g,
        _rep:function(str){
            var ns=this;
            return str.replace(ns._reg1,'.$1')
                     .replace(ns._reg2,'#$1')
                     .replace(ns._reg3,'$1')
                     .replace(ns._reg4,' ')
                     .replace(ns._reg5,'')
                     .replace(ns._reg6,',').toLowerCase();
        },
        _appendSS:function(container,txt, id, before, attr){
            var fc=document.createElement('style');
            fc.type="text/css";
            if(id)fc.id=id;
            if(xui.browser.ie && fc.styleSheet && "cssText" in fc.styleSheet)
                fc.styleSheet.cssText = txt||'';
            else
                try{fc.appendChild(document.createTextNode(txt||''))}catch(p){fc.styleSheet.cssText = txt||''}
            if(attr){
                xui(fc).attr(attr);
            }
            if(before) xui(container).prepend(fc);
            else xui(container).append(fc);
            return fc;
        },
        _createCss:function(id, txt,last){
            var ns=this,
                head=this._getHead(),
                fid=ns._firstid,
                lid=ns._lastid,
                fc,
                c;
            fc=document.createElement('style');
            fc.type="text/css";
            fc.id=id;
            if(txt){
                if(xui.browser.ie && fc.styleSheet && "cssText" in fc.styleSheet)
                    fc.styleSheet.cssText = txt||'';
                else
                    try{fc.appendChild(document.createTextNode(txt||''))}catch(p){fc.styleSheet.cssText = txt||''}
            }
            if(!last){
                c= document.getElementById(fid) || head.firstChild;
                while((c=c.nextSibling) && !/^(script|link|style)$/i.test(''+c.tagName));
                if(c)
                    head.insertBefore(fc, c);
                else{
                    if(c= document.getElementById(lid))
                        head.insertBefore(fc, c);
                    else
                        head.appendChild(fc);
                }
            }else
                head.appendChild(fc);
            return fc;
        },
        _getCss:function(id, css, last){
            return document.getElementById(id) || this._createCss(id, css, last);
        },
        _getBase:function(){
            return this._getCss(this._baseid);
        },
        _getFirst:function(){
            return this._getCss(this._firstid);
        },
        _getLast:function(){
            return this._getCss(this._lastid, null, true);
        },
        _getHead:function(){
            return this._head || (this._head=document.getElementsByTagName("head")[0]||document.documentElement);
        },
        _check:function(){
            if(!xui.browser.ie)return;
            var count=0;
            for(var head = this._getHead(),i=0,t=head.childNodes,l;l=t[i++];)
                if(l.type=="text/css" )
                    count++
            return count>20;
        },
        get:function(property, value){
            for(var head = this._getHead(),i=0,t=head.childNodes,l;l=t[i++];)
                if(l.type=="text/css" && property in l && l[property]==value)
                    return l;
        },
        //if backOf==true, add to head last node
        //else add to the before position of the base styleSheet
        addStyleSheet:function(txt, id, backOf, force){
            var e, ns=this, head = ns._getHead(),
            add=function(txt,id,backOf){
                var e = document.createElement('style');
                e.type="text/css";
                if(id)e.id=id;
                //for ie
                if(xui.browser.ie && e.styleSheet && "cssText" in e.styleSheet)
                    e.styleSheet.cssText = txt||'';
                else
                    try{e.appendChild(document.createTextNode(txt||''))}catch(p){e.styleSheet.cssText = txt||''}
                if(backOf===-1){
                    if(head.firstChild) head.insertBefore(e, head.firstChild); 
                    else head.appendChild(e);
                }else if(backOf===1){
                    head.appendChild(e);
                }else{
                    head.insertBefore(e, backOf?ns._getLast():ns._getBase());
                }
                e.disabled=true;
                e.disabled=false;
                return e;
            },merge=function(txt,backOf){
                var e=backOf ?ns._getLast():ns._getBase();
                e.styleSheet.cssText +=txt;
                return e;
            };
            if(id && (id=id.replace(/[^\w\-\_\.\:]/g,'_')) && (e=ns.get('id',id))){
                if(force){
                    e.disabled=true;
                    head.removeChild(e);
                }
                else return e;
            }

            if(ns._check()){
                return merge(txt, backOf);
            }else
                return add(txt,id,backOf);
        },
        //if front==true, add to the before position of the base styleSheet
        //else add to the last postion
        includeLink:function(href, id, front, attr){
            var e, ns=this, head = ns._getHead();
            if(href && (e=ns.get('href',href))){}else{
                e = document.createElement('link');
                e.type = 'text/css';
                e.rel = 'stylesheet';
                e.href = href;
                if(id)
                    e.id=id;
                e.media = 'all';
                xui.each(attr,function(o,i){
                    e.setAttribute(i,o);
                });
            }
            head.insertBefore(e, front?ns._getBase():ns._getLast());
            e.disabled=true;
            e.disabled=false;
            return e;
        },
        remove:function(property,value){
            var head = this._getHead();
            if(value=this.get(property,value)){
                value.disabled=true;
                head.removeChild(value);
            }
        },
        replaceLink:function(href, property, oValue, nValue){
            var ns=this,
                head=ns._getHead(),
                attr={},e,v;
            attr[property]=nValue;
            e=ns.includeLink(href,null,false,attr);
            if(v=ns.get(property,oValue))
                head.replaceChild(e,v);
            e.disabled=true;
            e.disabled=false;
        },
        _build:function(selector, value, flag){
            var t='';
            xui.each(value,function(o,i){
                t += i.replace(/([A-Z])/g,"-$1").toLowerCase() + ":" + o +";";
            });
            return flag?t:selector+"{" + t + "}";
        },
        //selector: single css exp without ','; not allow '.a, .b{}'
        //  for *** IE *** allow single css exp only
        setStyleRules:function(selector, value, force){
            var ns=this,
                add=true,
                ds=document.styleSheets,
                target, target2, selectorText, bak, h, e, t, _t;
            selector = xui.str.trim(selector.replace(/\s+/g,' '));
            if(!(value&&force)){
                bak=selector.toLowerCase();
                xui.arr.each(xui.toArr(ds),function(o){
                    try{o[ns._r]}catch(e){return}
                    xui.arr.each(xui.toArr(o[ns._r]),function(v,i){
                        if(!v.selectorText)return;
                        if(v.disabled)return;
                        selectorText = ns._rep(v.selectorText);
                        /*Notice: in IE, no ',' in any selectorTExt*/
                        _t=selectorText.split(',');
                        //null=>remove
                        if(!value){
                            add=false;
                            if(xui.arr.indexOf(_t,bak)!=-1 && _t.length>1){
                                _t=xui.arr.removeFrom(_t,xui.arr.indexOf(_t,bak)).join(',');
                                t=v.cssText.slice(v.cssText.indexOf("{")+1,v.cssText.lastIndexOf("}"));
                                if(o.insertRule)
                                    o.insertRule(_t+"{" + t + "}", o[ns._r].length);
                                else if(o.addRule )
                                    o.addRule(_t, t||"{}");
                                if(o.deleteRule)
                                    o.deleteRule(i);
                                else
                                    o.removeRule(i);
                                o.disabled=true;
                                o.disabled=false;
                            }else if(selectorText == bak){
                                if(o.deleteRule)
                                    o.deleteRule(i);
                                else
                                    o.removeRule(i);
                                o.disabled=true;
                                o.disabled=false;
                            }
                        //modify the last one
                        }else{
                            //for single css exp, (all single css exp in IE)
                            if(selectorText==bak){target=v;return false}
                            //for multi css exps, not in IE
                            if(xui.arr.indexOf(_t,bak)!=-1){target2=v;return false}
                        }
                    },null,true);
                    if(target){
                        add=false;
                        try{
                            xui.each(value,function(o,i){
                                i=i.replace(/(-[a-z])/gi, function(m,a){return a.charAt(1).toUpperCase()});
                                target.style[i]= typeof o=='function'?o(target.style[i]):o;
                            })
                        }catch(e){}
                        o.disabled=true;
                        o.disabled=false;
                        return false;
                    //not in IE
                    }else if(target2){
                        add=false;
                        o.insertRule(ns._build(selector,value), o[ns._r].length);
                        o.disabled=true;
                        o.disabled=false;
                        return false;
                    }
                },null,true);
            }
            //need to add
            if(force || add)
                ns._addRules(selector,value);
            return ns;
        },
        $getCSSValue:function(selector, cssKey, cssValue, ownerNode){
            var ns=this,
                k=ns._r, css,
                ds=document.styleSheets,
                l=ds.length,m, o,v,i,j,
                selectorText;
            selector=xui.str.trim(selector.replace(/\s+/g,' ').toLowerCase());
            for(i=l-1; i>=0; i--){
                try{
                    //firefox cracker
                    o=ds[i][k];
                }catch(e){continue;}
                if(!ds[i].disabled){
                    o=ds[i][k];
                    if(o){
                        m=o.length;
                        for(j=m-1; j>=0; j--){
                            if((v=o[j]).selectorText && !v.disabled){
                                selectorText = ns._rep(v.selectorText);
                                if(xui.arr.indexOf(selectorText.split(/\s*,\s*/g),selector)!=-1){
                                    if(!cssKey){
                                        (css=css||[]).push(v);
                                    }else{
                                        if(!cssValue){
                                            if(!ownerNode || (ownerNode==ds[i].ownerNode||ds[i].owningElement))
                                                if(v.style[cssKey]!=='')
                                                    // return cssValue
                                                    // replace is crack for opera
                                                    return (v.style[cssKey]||"").replace(/^\"|\"$/g,'');
                                        }else if(cssValue===v.style[cssKey]){
                                            // return css dom node
                                            return ds[i].ownerNode||ds[i].owningElement ;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            // return all stylesheets named cssKey
            return css;
        },
        _addRules:function(selector,value){
            var ns=this,
                target=ns._getLast(),
                changed=target.sheet || target.styleSheet;
            if(changed.insertRule)
                changed.insertRule(ns._build(selector,value), changed[ns._r].length);
            else if(changed.addRule )
                changed.addRule(selector, ns._build(selector,value,true)||"{}");
            target.disabled=true;
            target.disabled=false;
            return ns;
        },
        /*resetCSS:function(){
            var css = '';
            this.addStyleSheet(css,"xui.CSSreset");
        },*/
        adjustFont:function(fontSize, fontFamily, fontWeight, fontStyle){
            if(fontSize)xui('html').css('font-size', fontSize);
            if(fontFamily)xui('html').css('font-family', fontFamily);
            if(fontWeight)xui('html').css('font-weight', fontWeight);
            if(fontStyle)xui('html').css('font-style', fontStyle);

            this._dftEmStr='';
            this._getDftEmSize(true);
            this._dftRemStr='';
            this._getDftRemSize(true);
            if(xui.UI)
                xui.UI.getAll().reLayout(true);
        },
        _dftEmStr:'',
        _dftEm:0,
        _getDftEmSize: function(force){
            var ns=this;
            if(force || !ns._dftEm){
                var fz=ns.$getCSSValue('.xui-ui-ctrl','fontSize');

                // only can be triggerred by modifing font-size of '.xui-ui-ctrl' itslef.
                if(!ns._dftEmStr || ns._dftEmStr!=fz){
                    ns._dftEmStr=fz;
                    if(ns.$isPx(fz)){
                        ns._dftEm=parseFloat(fz);
                    }else if(ns.$isRem(fz)){
                        ns._dftEm=parseFloat(fz)*ns._getDftRemSize();
                    }else{
                        var div;
                        xui('body').append(div=xui.create('<div class="xui-ui-ctrl" style="height:1em;visibility:hidden;position:absolute;border:0;margin:0;padding:0;left:-10000px;"></div>'));
                        ns._dftEm=div.get(0).offsetHeight;
                        div.remove();
                    }
                }
            }
            return ns._dftEm;
        },
        $resetEm:function(){
            delete xui.CSS._dftEm;
        },
        _dftRemStr:'',
        _dftRem:0,
        _getDftRemSize: function(force){
            var ns=this;
            if(force || !ns._dftRem)
                ns._dftRem=parseFloat(xui('html').css('font-size'))||16;
            return ns._dftRem;
        },
        $resetRem:function(){
            delete xui.CSS._dftRem;
        },
        $isEm:function(value){
            return (!value||value=='auto')? xui.$us()==1 : /^-?((\d\d*\.\d*)|(^\d\d*)|(^\.\d\d*))em$/i.test(xui.str.trim(value+''));
        },
        $isRem:function(value){
            return (!value||value=='auto')? xui.$us()==1 : /^-?((\d\d*\.\d*)|(^\d\d*)|(^\.\d\d*))rem$/i.test(xui.str.trim(value+''));
        },
        $isPx:function(value){
            return (!value||value=='auto')? xui.$us()==1  : /^-?((\d\d*\.\d*)|(^\d\d*)|(^\.\d\d*))px$/i.test(xui.str.trim(value+''));
        },

        $em2px:function(value, node, roundPx){
            value = (!value||value=='auto')?value:(xui.isFinite(value) || this.$isEm(value)) ? (parseFloat(value)||0) * (node?xui.isFun(node)?node():xui.isFinite(node)?node:xui(node)._getEmSize():this._getDftEmSize()||this._getDftEmSize()) : value;
            return roundPx?Math.round(parseFloat(value)||0):value;
        },
        $px2em:function(value, node, roundPx){
            return (!value||value=='auto')?value:(xui.isFinite(value) || this.$isPx(value)) ?  (roundPx?Math.round(parseFloat(value)||0):(parseFloat(value)||0)) / (node?xui.isFun(node)?node():xui.isFinite(node)?node:xui(node)._getEmSize():this._getDftEmSize()||this._getDftEmSize()): value;
        },
        $rem2px:function(value, roundPx){
            value = (!value||value=='auto')?value:(xui.isFinite(value) || this.$isRem(value)) ? (parseFloat(value)||0) * this._getDftRemSize() : value;
            return roundPx?Math.round(parseFloat(value)||0):value;
        },
        $px2rem:function(value, roundPx){
            return (!value||value=='auto')?value:(xui.isFinite(value) || this.$isPx(value)) ?  (roundPx?Math.round(parseFloat(value)||0):(parseFloat(value)||0)) / this._getDftRemSize(): value;
        },
        $em2rem:function(value, node){
            return (!value||value=='auto') ? value : (xui.isFinite(value) || this.$isEm(value)) ? (parseFloat(value)||0)  * (node?xui.isFinite(node)?node:xui(node)._getEmSize():this._getDftEmSize()||this._getDftEmSize()) / this._getDftRemSize() : value;
        },
        $rem2em:function(value, node){
            return (!value||value=='auto') ? value : (xui.isFinite(value) || this.$isRem(value)) ? (parseFloat(value)||0)  * this._getDftRemSize() / (node?xui.isFinite(node)?node:xui(node)._getEmSize():this._getDftEmSize()||this._getDftEmSize()) : value;
        },
        $px:function(value, node, roundPx){
            value = ((!xui.isFinite(value)&&this.$isRem(value))?this.$rem2px(value,roundPx):this.$isEm(value)?this.$em2px(value, node, roundPx):(!value||value=='auto')?value:(parseFloat(value)||0));
            return roundPx?Math.round(parseFloat(value)||0):value;
        },
        $em:function(value, node, roundPx){
            return ((xui.isFinite(value)||this.$isPx(value))?this.$px2em(value, node,roundPx):this.$isRem(value)?this.$rem2em(value, node):(!value||value=='auto')?value:(parseFloat(value)||0));
        },
        $rem:function(value, node, roundPx){
            return ((xui.isFinite(value)||this.$isPx(value))?this.$px2rem(value,roundPx):this.$isEm(value)?this.$em2rem(value,node):(!value||value=='auto')?value:(parseFloat(value)||0));
        },
        $addpx:function(a,b,node){
            if(a=='auto')return a;
            if(this.$isRem(a)){
                return this.$px2rem(Math.round(this.$rem2px(a)+(parseFloat(b)||0)))+'rem';
            }else if(this.$isEm(a)){
                return this.$px2em(Math.round(this.$em2px(a,false,node)+(parseFloat(b)||0)))+'em';
            }else{
                return Math.round((parseFloat(a)||0)+(parseFloat(b)||0))+'px';
            }
        },
        $forceu:function(v,u,node,roundPx){
            return (v===null||v===undefined||v===''||v=='auto') ? v:
                ( u ? u=='rem' : (xui.$us()===0)) ? this.$rem(v,node,roundPx!==false)+'rem':
                ( u ? u=='em' : (xui.$us()==1)) ? this.$em(v,node,roundPx!==false)+'em':
                Math.round(this.$px(v,node,roundPx!==false))+'px'
        },
       
        $picku:function(v){return v && v!='auto' && (v+'').replace(/[-\d\s.]*/g,'') || (xui.$us()==1?'em':'px')},
        $addu:function(v){return v=='auto'?v:(xui.isFinite(v)||this.$isPx(v))?Math.round(parseFloat(v)||0)+'px':v+''}
    },
    Initialize:function(){
        var b=xui.browser,
            inlineblock= (b.gek
                    ? b.ver<3 
                        ? ((b.ver<3?"-moz-outline-offset:-1px !important;":"") + "display:-moz-inline-block;display:-moz-inline-box;display:inline-block;")
                        :"display:inline-block;"
                    : b.ie6
                        ?"display:inline-box;display:inline;"
                    :"display:inline-block;")+
                (b.ie?"zoom:1;":""),
            css =  ".xui-node{margin:0;padding:0;line-height:1.22;-webkit-text-size-adjust:none;}"+
            ".xui-node-highlight{color:#000;}"+
            ".xui-title-node{}"+
            ".xuifont-hover, .xuicon-hover{ color: #686868; }"+
            (!xui.browser.fakeTouch && xui.browser.deviceType != 'touchOnly'?".xuifont-active, .xuicon-active{ color: #3393D2; }":"")+
            ".xuifont-checked, .xuicon-checked{ color: #3393D2; }"+
            
            ".xui-wrapper{color:#000;font-family:arial,helvetica,clean,sans-serif;font-style:normal;font-weight:normal;vertical-align:middle;}"+
            ".xui-cover{cursor:wait;background:url("+xui.ini.img_bg+") transparent repeat;opacity:1;}"+
            ".xui-node-table{border-collapse:collapse;border-spacing:0;empty-cells:show;font-size:inherit;"+(b.ie?"font:100%;":"")+"}"+
            ".xui-node-fieldset,.xui-node-img{border:0;}"+
            ".xui-node-ol,.xui-node-ul,.xui-node-li{list-style:none;}"+
            ".xui-node-caption,.xui-node-th{text-align:left;}"+
            ".xui-node-th{font-weight:normal;}"+
            ".xui-node-q:before,.xui-node-q:after{content:'';}"+
            ".xui-node-abbr,.xui-node-acronym{border:0;font-variant:normal;}"+
            ".xui-node-sup{vertical-align:text-top;}"+
            ".xui-node-sub{vertical-align:text-bottom;}"+
            ".xui-node-input,.xui-node-textarea,.xui-node-select{cursor:text;font-family:inherit;font-size:inherit;font-weight:inherit;"+(b.ie?"font-size:100%;":"")+"}"+
            ".xui-node-del,.xui-node-ins{text-decoration:none;}"+
            ".xui-node-pre,.xui-node-code,.xui-node-kbd,.xui-node-samp,.xui-node-tt{font-family:monospace;"+(b.ie?"font-size:108%;":"")+"line-height:100%;}"+
// dont use font(use font-size/font-family) in IE678
            ".xui-node-select,.xui-node-input,.xui-node-textarea{font-family:arial,helvetica,clean,sans-serif;border-width:1px;}"+
            ((b.ie && b.ver<=8)?".xui-node-input{overflow:hidden;}":"")+
// base setting
            ".xui-node-a, .xui-node-a .xui-node{cursor:pointer;color:#0000ee;text-decoration:none;}"+
            ".xui-node-a:hover, .xui-node-a:hover .xui-node{color:red}"+
            (b.gek? (".xui-node-a:focus{outline-offset:-1px;"+ (b.ver<3?"-moz-outline-offset:-1px !important":"") +"}" ):"")+
            ".xui-node-span, .xui-node-div{border:0;}"+
            ((b.ie && b.ver<=8)?"":".xui-node-span:not(.xui-showfocus):focus, .xui-node-div:not(.xui-showfocus):focus{outline:0;}.xui-showfocus:focus{outline-width: 1px;outline-style: dashed;}")+
            ".xui-node-span, .xui-wrapper span"+((b.ie && b.ver<=7)?"":", .xui-v-wrapper:before, .xui-v-wrapper > .xui-v-node")+"{outline-offset:-1px;"+
            inlineblock+
            "}"+
            ".xui-node-h1,.xui-node-h2,.xui-node-h3,.xui-node-h4,.xui-node-h5,.xui-node-h6{font-size:100%;font-weight:normal;}"+
            ".xui-node-h1{font-size:138.5%;}"+
            ".xui-node-h2{font-size:123.1%;}"+
            ".xui-node-h3{font-size:108%;}"+
            ".xui-node-h1,.xui-node-h2,.xui-node-h3{margin:1em 0;}"+
            ".xui-node-h1,.xui-node-h2,.xui-node-h3,.xui-node-h4,.xui-node-h5,.xui-node-h6,.xui-node-strong{font-weight:bold;}"+
            ".xui-node-em{font-style:italic;}"+
            ".xui-node-legend{color:#000;}"+
            (b.ie6?("#"+xui.$localeDomId+"{vertical-align:baseline;}"):"")+
            
            // some cross browser css solution
            ".xui-nofocus:focus{outline:0;}"+
            ".xui-cls-wordwrap{"+
                "white-space: pre-wrap;word-break: break-all;" + // css-3
                (b.gek?"white-space: -moz-pre-wrap;":"") +  // Mozilla, since 1999
                (b.opr?"white-space: -pre-wrap;":"") + // Opera 4-6
                (b.opr?"white-space: -o-pre-wrap;":"") + // Opera 7
                (b.ie?"word-wrap: break-word;":"")+ // Internet Explorer 5.5+
           "}"+
           ((b.ie && b.ver<=8)?"":(".xui-v-wrapper:before{content:'';height:100%;font-size:0;vertical-align:middle;}"+
           ".xui-v-wrapper > .xui-v-node{vertical-align:middle;}"+
           ".xui-v-top > .xui-v-wrapper:before{vertical-align:top;}"+
           ".xui-v-top > .xui-v-wrapper > .xui-v-node{vertical-align:top;}"+
           ".xui-v-bottom > .xui-v-wrapper:before{vertical-align:bottom;}"+
           ".xui-v-bottom > .xui-v-wrapper > .xui-v-node{vertical-align:bottom;}"))+
            ".xui-node-tips{background-color:#FDF8D2;}"+

            // must here for get correct base font size
            ".xuifont, .xuicon{font-size:1.3333333333333333em;line-height:1em;}"+
            ".xuicon{margin: 0 .25em;"+
            inlineblock +
            "}" +
            ".xuicon:before{height:1em;width:1em;}" + 
            ".xui-ui-ctrl, .xui-ui-reset{font-family:arial,helvetica,clean,sans-serif; font-style:normal; font-weight:normal; vertical-align:middle; color:#000; }" + 
            //xui-ui-ctrl must be after xui-ui-reset
            ".xui-ui-reset{font-size: inherit;}"+
            // html(default 10px) > .xui-ui-ctrl(rem) > inner nodes(em)
            ".xui-ui-ctrl{cursor:default;font-size:1rem;}"+
            ".xui-title-node{font-size:1.1667em  !important;}"
           ;

        this.addStyleSheet(css, 'xui.CSS');
        
        /*
        xui.Thread.repeat(function(t){
            if((t=xui.CSS._dftEm) && (t!==xui.CSS._getDftEmSize(true)))xui.CSS.adjustFont();
        }, 10000);
        */
    }   
});xui.Class('xui.DomProfile', 'xui.absProfile', {
    Constructor:function(domId){
        var upper=arguments.callee.upper;
        if(upper)upper.call(this);
        upper=null;
        xui.$cache.profileMap[this.domId=domId]=this;
    },
    Instance:{
        __gc:function(){
            delete xui.$cache.profileMap[this.domId];
        },
        _getEV:function(funs, id, name){
            var t=xui.$cache.profileMap[id];
            if(t&&(t=t.events)&&(t=t[name]))
                for(var i=0,l=t.length;i<l;i++)
                    if(typeof t[t[i]]=='function')
                        funs[funs.length]=t[t[i]];
        }
    },
    Static:{
        get:function(id){
            return xui.$cache.profileMap[id];
        },
        $abstract:true
    }
});

/*xui.Dom
*/
xui.Class('xui.Dom','xui.absBox',{
    Instance:{
        get:function(index){
            var purge=xui.$cache.domPurgeData,t=this._nodes,s;
            if(xui.isNumb(index))
                return (s=t[index]) && (s=purge[s]) && s.element;
            else{
                var a=[],l=t.length;
                for(var i=0;i<l;i++)
                    a[a.length] = (s=purge[t[i]]) && s.element;
                return a;
            }
        },
        each:function(fun,desc){
            var ns=this,purge=xui.$cache.domPurgeData,n,
                  i, j=ns._nodes, l=j.length;
            if(desc){
                for(i=l;i>=0;i--)
                    if((n=purge[j[i]]) && (n=n.element))
                        if(false===fun.call(ns,n,i))
                            break;
            }else{
                for(i=0;i<l;i++)
                    if((n=purge[j[i]]) && (n=n.element))
                        if(false===fun.call(ns,n,i))
                            break;
            }
            n=null;
            return ns;
        },

        serialize:function(){
            var a=[];
            this.each(function(o){
                a[a.length]=o.id;
            });
            return "xui(['"+a.join("','")+"'])";
        },
        xid:function(){
            return xui.getId(this.get(0));
        },
        //Need to consider the cache in xui.$cache.profileMap
        id:function(value, ignoreCache){
            var t,i,cache=xui.$cache.profileMap;
            if(typeof value == 'string')
                return this.each(function(o){
                    if((i=o.id)!==value){
                        if(!ignoreCache&&(t=cache[i])){
                            cache[value] = t;
                            delete cache[i];
                        }
                        o.id=value;
                    }
                });
            else
                return this.get(0)&&this.get(0).id;
        },

        /*dom collection
        fun: fun to run
        args: arguments for fun
        */
        $sum:function(fun, args){
            var arr=[],r,i;
            this.each(function(o){
                r=fun.apply(o, args||[]);
                if(r){
                    if(xui.isArr(r))
                        for(i=0;o=r[i];i++)
                            arr[arr.length]=o;
                    else
                        arr[arr.length]=r;
                }
            });
            return xui(arr);
        },
        /*get all dir children
        */
        children:function(){
            return this.$sum(function(){
                return xui.toArr(this.childNodes)
            });
        },
        /* clone
         deep for clone all children
        */
        clone:function(deep){
            return this.$sum(function(){
                var n = this.cloneNode(deep?true:false),
                    children=n.getElementsByTagName('*'),
                    ie=xui.browser.ie && xui.browser.ver<9,
                    i=0,o;
                if(ie) n.removeAttribute('$xid');
                else delete n.$xid;
                for(;o=children[i];i++){
                    if(ie) o.removeAttribute('$xid');
                    else delete o.$xid;
                }
                return n;
            },arguments);
        },
        /* iterator
        // type: left : x-axis,  top :y-axis, xy: x-axis and y-axis
        // dir : true => left to right; top to buttom, false => right to left ; bottom to top
        // inn: does start consider children
         fun : number or function => number is iterator index; function is "return true ->stop"
        */
        $iterator:function(type, dir, inn, fun, top){
            return this.$sum(function(type, dir, inn, fun, top){
                var self=arguments.callee;
                if(typeof fun != 'function'){
                    var count=fun||0;
                    fun = function(n,index){return index==count;}
                }
                var index=0,m,n=this,flag=0,t;
                while(n){
                    if(n.nodeType==1)
                        if(fun(n, index++)===true)break;

                    //x-axis true: right ;false: left
                    if(type=='x')
                        n= dir?n.nextSibling:n.previousSibling;
                    //y-axis true: down ;false: up
                    else if(type=='y')
                        n= dir ? self.call(dir===1?n.lastChild:n.firstChild, 'x',(dir!==1), true, 0, top) : n.parentNode;
                    else{
                        inn=xui.isBool(inn)?inn:true;
                        m=null;
                        n= dir ?
                                 (t = inn && n.firstChild ) ? t
                                              : (t = n.nextSibling ) ? t
                                                              :(m=n.parentNode)
                               : (t = inn && n.lastChild) ? t
                                              : (t = n.previousSibling ) ? t
                                                              :(m=n.parentNode);
                        if(m){
                            while(!( m = dir ? n.nextSibling: n.previousSibling)){
                                n=n.parentNode;
                                //to the top node
                                if(!n)
                                    if(flag)
                                        return null;
                                    else{
                                        flag=true;
                                        m = dir ? document.body.firstChild : document.body.lastChild;
                                        break;
                                    }
                            }
                            n=m;
                        }
                        inn=true;
                    }
                }
                return n;
            },arguments);
        },
        /*
        query('div');
        query('div','id');
        query('div','id','a');
        query('div','id',/^a/);
        query('div',function(){return true});
        */
        query:function(tagName, property, expr){
            tagName = tagName||'*';
            var f='getElementsByTagName',
                me=arguments.callee, f1=me.f1||(me.f1=function(tag, attr, expr){
                var all = this[f](tag), arr=[];
                if(expr.test(this[attr]))
                    arr[arr.length]=this;
                for(var o,i=0; o=all[i]; i++)
                    if(expr.test(o[attr]))
                        arr[arr.length]=o;
                return arr;
            }),f2=me.f2||(me.f2=function(tag, attr, expr){
                var all = this[f](tag), arr=[];
                if(this[attr]==expr)
                    arr[arr.length]=this;
                for(var o,i=0; o=all[i]; i++)
                    if(o[attr]==expr)
                        arr[arr.length]=o;
                return arr;
            }),f3=me.f3||(me.f3=function(tag, attr, expr){
                var all = this[f](tag), arr=[];
                if(this[attr])
                    arr[arr.length]=this;
                for(var o,i=0; o=all[i]; i++)
                    if(o[attr])
                        arr[arr.length]=o;
                return arr;
            }),f4=me.f4||(me.f4=function(tag){
                return xui.toArr(this[f](tag));
            }),f5=me.f5||(me.f5=function(tag, attr){
                var all = this[f](tag), arr=[];
                if(attr(this))
                    arr[arr.length]=this;
                for(var o,i=0; o=all[i]; i++)
                    if(attr(o))
                        arr[arr.length]=o;
                return arr;
            });
            return this.$sum(property?typeof property=='function'?f5:expr?xui.isReg(expr)?f1:f2:f3:f4, [tagName, property, expr]);
        },
        querySelector:function(selectors){
            return this.$sum(function(){
                return this.querySelector(selectors);
            });
        },
        querySelectorAll:function(selectors){
            return this.$sum(function(){
                return xui.toArr(this.querySelectorAll(selectors));
            });
        },
        /*
        dom add implementation
        for addPrev prepend addNext append
        */
        $add:function(fun,target,reversed){
            if(xui.isHash(target) || xui.isStr(target))
                target=xui.create(target);
            if(reversed){
                reversed=xui(target);
                target=this;
            }else{
                target=xui(target);
                reversed=this;
            }
            if(target._nodes.length){
                var one=reversed.get(0),
                    ns=target.get(),
                    dom=xui.Dom,
                    cache=xui.$cache.profileMap,
                    fragment,uiObj,p,i,o,j,v,uiObj,arr=[];
                target.each(function(o){
                    uiObj=(p=o.id)&&(p=cache[p])&&p.LayoutTrigger&&(one===xui('body').get(0)||dom.getStyle(one,'display')!='none')&&p.LayoutTrigger;
                    if(uiObj)arr.push([uiObj,p]);
                });
                if(ns.length==1)
                    fragment=ns[0];
                else{
                    fragment=document.createDocumentFragment();
                    for(i=0;o=ns[i];i++)
                        fragment.appendChild(o);
                }
                fun.call(one,fragment);
                for(i=0;o=arr[i];i++){
                    for(j=0;v=o[0][j];j++)
                        v.call(o[1]);
                    if(o[1].onLayout)
                        o[1].boxing().onLayout(o[1]);
                }
                arr.length=0;

                one=o=fragment=null;
            }

            return this;
        },
        prepend:function(target,reversed){
            return this.$add(function(node){
                if(this.previousSibling!=node){
                    if(this.firstChild) this.insertBefore(node, this.firstChild);
                    else this.appendChild(node);
                }
            },target,reversed);
        },
        append:function(target,reversed,force){
            return this.$add(function(node){
                if(force||this!=node.parentNode){
                    this.appendChild(node);
                }
            },target,reversed);
        },
        addPrev:function(target,reversed){
            return this.$add(function(node){
                if(this.firstChild!=node)
                    this.parentNode.insertBefore(node,this);
            },target,reversed);
        },
        addNext:function(target,reversed){
            return this.$add(function(node){
                if(this.nextSibling!=node){
                    if(this.nextSibling) this.parentNode.insertBefore(node,this.nextSibling);
                    else this.parentNode.appendChild(node);
                }
            },target,reversed);
        },

        //flag: false => no remove this from momery(IE)
        replace:function(target, triggerGC){
            if(xui.isHash(target) || xui.isStr(target))
                target=xui.create(target);
            target=xui(target);
            var v,i,c=this.get(0),ns=target.get(),l=ns.length;
            if(l>0 && (v=ns[l-1])){
                c.parentNode.replaceChild(v,c);
                for(i=0;i<l-1;i++)
                    v.parentNode.insertBefore(ns[i],v);
                //for memory __gc
                if(triggerGC)
                    this.remove();
            }
            c=v=null;
            return target;
        },
        swap:function(target){
            var self=this,t = xui.Dom.getEmptyDiv().html('*',false);

            if(xui.isHash(target) || xui.isStr(target))
                target=xui.create(target);
            target=xui(target);

            self.replace(t,false);
            target.replace(self,false);
            t.replace(target,false);

            t.get(0).innerHTML='';
            document.body.insertBefore(t.get(0), document.body.firstChild);
            return self;
        },
        //flag : false => remove from dom tree, not free memory
        remove:function(triggerGC, purgeNow, callback){
            if(triggerGC===false)
                this.each(function(o,i){
                    if(o.raphael&&o.remove)o.remove();
                    else if(o.parentNode)o.parentNode.removeChild(o);
                });
            else{
                var c=xui.$getGhostDiv();
                // append to ghost first
                this.each(function(o){
                    c.appendChild(o);
                });
                var f=function(){
                    xui.$purgeChildren(c);
                    c.innerHTML='';
                    if(callback){
                        xui.tryF(callback);
                        callback=null;
                    }
                    c=null;
                };
                // for performance
                if(purgeNow)f();else xui.asyRun(f);
            }
            return this;
        },
        //set innerHTML empty
        //flag = false: no gc
        empty:function(triggerGC){
            return this.each(function(o){
                xui([o]).html('',triggerGC);
            });
        },

        //flag = false: no gc
        html:function(content,triggerGC,loadScripts,purgeNow, callback){
            var s='',t,o=this.get(0);triggerGC=triggerGC!==false;
            if(content!==undefined){
                if(o){
                    if(o.nodeType==3)
                        o.nodeValue=content;
                    else{
                         if(!o.firstChild && content==="")return this;
                         // innerHTML='' in IE, will clear it's childNodes innerHTML
                         // only asy purgeChildren need this line
                         // if(!triggerGC && xui.browser.ie)while(t=o.firstChild)o.removeChild(t);
                         //clear first
                         if(triggerGC){
                            // append to ghost first
                            var c=xui.$getGhostDiv();
                            xui(o).children().each(function(k){
                                c.appendChild(k);
                            });
                            var f=function(){
                                xui.$purgeChildren(c);
                                c.innerHTML='';
                                if(callback){
                                    xui.tryF(callback);
                                    callback=null;
                                }
                                c=null;
                            };
                            // for performance
                            if(purgeNow)f();else xui.asyRun(f);                            
                         }

                         var scripts;
                         if(loadScripts){
                            var reg1=/(?:<script([^>]*)?>)((\n|\r|.)*?)(?:<\/script>)/ig,
                                reg2=/(?:<script.*?>)((\n|\r|.)*?)(?:<\/script>)/ig,
                                reg3 = /\ssrc=([\'\"])(.*?)\1/i,
                                matched, attr,src;
                            scripts=[];
                            while((matched = reg1.exec(content))){
                                attr = matched[1];
                                src = attr ? attr.match(reg3) : false;
                                if(src && src[2]){
                                   scripts.push([1,src[2]]);
                                }else if(matched[2] && matched[2].length > 0){
                                   scripts.push([2,matched[2]]);
                                }
                            }
                            content=content.replace(reg2, '');
                        }

                        o.innerHTML=content;
                        if(scripts && scripts.length>0){
                            xui.arr.each(scripts,function(s){
                                if(s[0]==1)
                                    xui.include(null,s[1]);
                                else
                                    xui.exec(s[1]);
                            });
                        }

                        //if(triggerGC)
                        //    xui.UI.$addEventsHanlder(o);

                    }
                    o=null;
                }
                return this;
            }else{
                if(o){
                    s = (o.nodeType==3)?o.nodeValue:o.innerHTML;
                    o=null;
                }
                return s;
            }
        },
        loadHtml:function(options, onStart, onEnd){
            var ns=this;
            if(typeof options=='string')options={url:options};
            xui.tryF(onStart);
            xui.Ajax(options.url, options.query, function(rsp){
                var n=xui.create("div");
                n.html(rsp,false,true);
                ns.append(n.children());
                xui.tryF(onEnd);
            }, function(err){
                ns.append("<div>"+err+"</div>");
                xui.tryF(onEnd);
            }, null, options.options).start();
        },
        loadIframe:function(options, domId){
            if(typeof options=='string')options={url:options};
            var id=domId||("aiframe_"+xui.stamp()),t;
            if(t=xui.Dom.byId(domId)){
                xui(t).remove();
            }
            var e=xui.browser.ie && xui.browser.ver<9,
                ifr=document.createElement(e?"<iframe name='"+id+"'>":"iframe");
            ifr.id=ifr.name=id;
            ifr.src=options.url;
            ifr.frameBorder='0';
            ifr.marginWidth='0';
            ifr.marginHeight='0';
            ifr.vspace='0';
            ifr.hspace='0';
            ifr.allowTransparency='true';
            ifr.width='100%';
            ifr.height='100%';
            this.append(ifr);
            xui.Dom.submit(options.url, options.query, options.method, ifr.name, options.enctype);
        },
        outerHTML:function(content, triggerGC){
            var self=this, t,s='', o=self.get(0),id=o.id;
            if(content!==undefined){
                var n=self.replace(xui.str.toDom(content),false);
                self._nodes[0]=n._nodes[0];

                //avoid inner nodes memory leak
                xui([o]).remove(triggerGC);
                return self;
            }else{
                if(xui.browser.gek){
                    var m = xui.$getGhostDiv();
                    m.appendChild(self.get(0).cloneNode(true));
                    s=m.innerHTML;
                    m.innerHTML="";
                    m=null;
                }else{
                    s= o.outerHTML;
                }
                o=null;
                return s;
            }
        },
        text:function(content){
            if(content!==undefined){
                var self=this, arr=[];
                self.each(function(o){
                    var t=o.firstChild;
                     if(t&&t.nodeType!=1)
                        t.nodeValue = content;
                     else
                        arr[arr.length]=o;
                });
                if(arr.length){
                    xui(arr).empty().each(function(o){
                        o.appendChild(document.createTextNode(content));
                    })
                }
                return self;
            }else{
               return (function(o){
                  if(!o)return '';
                  return o.textContent || o.innerText;
                  /*
                  var i,a=o.childNodes,l=a.length,content='',me=arguments.callee;
                  for(i=0;i<l;i++)
                    if(a[i].nodeType!= 8)
                      content += (a[i].nodeType!=1) ? a[i].nodeValue : me(a[i]);
                  return content;
                  */
                })(this.get(0));
            }
        },
        /*
        .attr(name)=>get attr
        .attr(name,value)=>set attr
        .attr(name,null)=>remove attr
        */
        attr:function(name, value){
            //set one time only
            var self=this,
                me = arguments.callee,
                map1 = me.map1 || (me.map1 = {
                    'class':'className',
                    readonly: "readOnly",
                    tabindex: "tabIndex",
                    'for':'htmlFor',
                    maxlength: "maxLength",
                    cellspacing: "cellSpacing",
                    rowspan: "rowSpan",
                    value:'value'
                }),
                map2 = me.map2||(me.map2={
                    href:1,src:1,style:1
                });

            if(typeof name=='object'){
                for(var i in name)
                    me.call(self,i,name[i]);
                return self;
            }

            var iestyle = xui.browser.ie && name=='style',
                normal=!map2[name=map1[name]||name];
            if(value!==undefined){
                return self.each(function(o){
                    //remove attr
                    if(value===null){
                        if(iestyle)o.style.cssText='';
                        else if(normal){
                            try{
                                o[name]=null;
                                if(o.nodeType==1)o.removeAttribute(name)
                            }catch(e){}
                        }
                    //set attr
                    }else{
                        value=name=='style'?(value+'').replace(/[;]+/g,';').replace(/^;/,''):value;
                        if(iestyle)o.style.cssText=''+value;
                        else if(normal){
                             o[name]=value;
                             if(o.nodeType==1 && name!="value" && typeof value=='string')o.setAttribute(name, value);
                        }else
                            o.setAttribute(name, value);
                    }
                 });
            //get attr
            }else{
                var r,o=self.get(0);
                if(iestyle) return o.style.cssText;
                if(name=="selected"&&xui.browser.kde) return o.parentNode.selectedIndex;
                r=((name in o) && normal)?o[name]:o.getAttribute(name, xui.browser.ie && !normal ? 2 : undefined );
                o=null;
                return name=='style'?r.replace(/[;]+/g,';').replace(/^;/,''):r;
            }
        },
        $touchscroll:function(type){
            if(xui.browser.fakeTouch || (xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB))){
                var hash={"x":1,"y":1,"xy":1},opx=null,opy=null,ox=null,oy=null,speedx=0,speedy=0,nodes=this._nodes,
                      doSwipe = function(t){
                            if(speedx||speedy){
                                var params={},sl=t.scrollLeft,st=t.scrollTop,limit=50,rate=40,duration=2000;
                                if(speedx)params.scrollLeft=[sl, sl + Math.sign(speedx)*Math.min(limit,Math.abs(speedx))*rate];
                                if(speedy)params.scrollTop=[st, st + Math.sign(speedy)*Math.min(limit,Math.abs(speedy))*rate];
                                xui(t).animate(params, null, null,duration,null,"expoOut").start();
                            }
                            speedx=speedy=opx=opy=ox=oy=null;
                    };
                if(!hash[type])type=null;
                xui(nodes)[xui.browser.fakeTouch?'onMousedown':'onTouchstart'](hash[type]?function(p,e,src){
                    if(xui.DragDrop._profile.isWorking) return true;

                    var s,t=xui(src).get(0);
                    var tid=xui.getNodeData(t,'_inthread');
                    if(tid){
                        xui.Thread(tid).abort();
                        xui.setNodeData(t,'_inthread');
                    }

                    if(xui.browser.fakeTouch){
                        if(xui.Event.getBtn(e)!=='left')return true;
                        s=e;
                    }else{
                        if(e.touches.length>1)return true;
                        s=e.touches[0];
                    }
                    if(t){
                        if(type=='xy'||type=='x'){
                            ox=t.scrollXLeft;
                            opx=s.pageX;
                        }
                        if(type=='xy'||type=='y'){
                            oy=t.scrollTop
                            opy=s.pageY;
                        }
                    }
                    // ***add for fake case
                    if(xui.browser.fakeTouch){
                        xui.setData(['!document','$fakescroll'],1);
                        xui.doc.onMouseup(function(p,e,src){
                            xui.setData(['!document','$fakescroll']);
                            xui.asyRun(function(){xui.setData(['!document','$fakescrolling']);});
                            // ***clear for fake case
                            xui.doc.onMouseup(null,'touchscroll');
                            doSwipe(t);
                        },'touchscroll');
                        return false;
                    }
                    return true;
                }:null,'touchscroll');

                xui(nodes)[xui.browser.fakeTouch?'onMousemove':'onTouchmove'](hash[type]?function(p,e,src){
                    if(xui.DragDrop._profile.isWorking) return true;
                    if(xui.browser.fakeTouch && !xui.getData(['!document','$fakescroll']))return true;
                    var s,t=xui(src).get(0),x1,y1,first;
                    if(xui.browser.fakeTouch){
                        if(xui.Event.getBtn(e)!=='left')return true;
                        s=e;
                    }else{
                        if(e.touches.length>1)return true;
                        s=e.touches[0];
                    }
                    if(t){
                        x1=t.scrollLeft;y1=t.scrollTop;
                        if(type=='xy'||type=='x'){
                            t.scrollLeft=ox + opx - s.pageX;
                            if(x1==t.scrollLeft){
                                ox=t.scrollLeft;
                                opx=s.pageX;
                            }else{
                                speedx=t.scrollLeft-x1;
                            }
                        }
                        if(type=='xy'||type=='y'){
                            if(oy===null)oy=t.scrollTop+opy;
                            t.scrollTop=oy + opy - s.pageY;
                            if(y1==t.scrollTop){
                                oy=t.scrollTop;
                                opy=s.pageY;
                            }else{
                                speedy=t.scrollTop-y1;
                            }
                        }
                        // effected
                        if(xui.browser.fakeTouch){
                            if(x1!==t.scrollLeft || y1!==t.scrollTop){
                                xui.setData(['!document','$fakescrolling'], 1);
                            }
                        }
                        return x1==t.scrollLeft && y1==t.scrollTop;
                    }
                }:null,'touchscroll');

                xui(nodes).onTouchend(hash[type]?function(p,e,src){
                    if(xui.DragDrop._profile.isWorking) return true;
                    if(e.touches.length>1)return true;
                    doSwipe(xui(src).get(0));
                }:null,'touchscroll');
            }
            return this;
        },
        isScrollBarShowed:function(type){
            var n=this.get(0);
            if(n)return type=='y'?((n.offsetWidth||0)>(n.clientWidth||0)):((n.offsetHeight||0)>(n.clientHeight||0));
        },
        scrollable:function(type){
            type=type=='x'?'scrollLeft':'scrollTop';
            if(this[type]()!==0)return true;
            this[type](1);
            if(this[type]()===0)return false;
            this[type](0);
            return true;
        },
        scrollIntoView:function(){
            return  this.each(function(o){
                o.scrollIntoView();
            });
        },
        /*
        name format: 'xxxYxx', not 'xxx-yyy'
        left/top/width/height like, must specify 'px'
        Does't fire onResize onMove event
        */
        css:function(name, value, force){
            if(typeof name=='object' || value!==undefined){
                this.each(function(o){
                    xui.Dom.setStyle(o,name,value)
                });

                if(xui.browser.fakeTouch || (xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB))){
                    if(name=='overflow'||name=='overflow-x'||name=='overflow-y'){
                        if(value=='auto'||value=='scroll')
                            this.$touchscroll(name=='overflow'?'xy':name=='overflow-x'?'x':'y');
                        else
                            this.$touchscroll(null);
                    }
                }
                return this;
            }else{
                return xui.Dom.getStyle(this.get(0), name, force);
            };
        },
        _getEmSize:function(rate){
            return this.get(0) ? (parseFloat(xui.Dom.getStyle(this.get(0), 'fontSize', true))||0) * (rate||1) : null;
        },
        rotate:function(v){
            if(xui.isSet(v)){
                v=parseFloat(v)||0;
                v=v%360;
                if(v<0)v=v+360;
                return this.each(function(o){
                    if(o.raphael&&o.id){
                        var prf=xui.Event._getProfile(o.id);
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid)))
                            o.transform('r'+v);
                    }else{
                        v+='deg';
                        var transform=o.style.transform||"";
                        if(/rotate\([^)]*\)/i.test(transform))transform=transform.replace(/(rotate\()([^)]+)/i, '$1'+v);
                        else transform+=" rotate("+v+")";
                        xui.Dom.setStyle(o,'transform',transform);
                    }
                });
            }else{
                var o=this.get(0);
                if(o.raphael&&o.id){
                        var prf=xui.Event._getProfile(o.id);
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                            // for format
                            o=o.transform();
                            if(xui.isArr(o)){
                                if(!o.length) o="";
                                else o=o.join();
                            }else{
                                if(!o)o="";
                                else o=Raphael.parseTransformString(o).join();
                            }
                            var arr=/r,([-\d.]+)/i.exec(o);
                            v=arr?parseFloat(arr[1]||0):0;
                            v=v%360;
                            if(v<0)v=v+360;
                            return v;
                        }
                        return 0;
                }else{
                   var arr=/rotate\(([-\d.]+)/i.exec(o.style.transform);
                   return arr?parseFloat(arr[1]||0):0;
                }
            }
        },
        scaleX:function(v){
            if(xui.isSet(v)){
                return this.each(function(o){
                     v=parseFloat(v);
                     if(o.raphael&&o.id){
                         v=v||0;
                        var prf=xui.Event._getProfile(o.id),t;
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                            t=xui.clone(Raphael.parseTransformString(o.transform()),true);
                            // only for the first
                            if(t&&t[0]&&t[0][0]=="s"){
                                t[0][1]=v;
                            }else{
                                t=t||[];
                                t.unshift(['s',v,1]);
                            }
                            o.transform(t);
                        }
                    }else{
                        if(xui.isNaN(v))v=1;
                        var transform=o.style.transform||"";
                        if(/(scale\()([^,]+),([^)]+)/i.test(transform))transform=transform.replace(/(scale\()([^,]+),([^)]+)/i, '$1'+v+',$3');
                        else if(/scale\([-\d.]*\)/i.test(transform))transform=transform.replace(/scale\([-\d.]*\)/i, 'scale('+v+',1)');
                        else transform+=" scale("+v+",1)";
                        xui.Dom.setStyle(o,'transform',transform);
                    }
                });
            }else{
                 var o=this.get(0);
                if(o.raphael&&o.id){
                    v=1;
                    var prf=xui.Event._getProfile(o.id);
                    if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                         xui.arr.each(Raphael.parseTransformString(o.transform()),function(t){
                            if(t[0]=="s")v*=t[1];
                        });
                    }
                    return v;
                }else{
                   var arr=/(scale\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
                   if(arr)return parseFloat(arr[2]||1);
                   else{
                        arr=/scale\(([-\d.]*)\)/i.exec(this.get(0).style.transform);
                        return arr?arr[1]:1;
                    }
                }
            }
        },
        scaleY:function(v){
            if(xui.isSet(v)){
                return this.each(function(o){
                    v=parseFloat(v);
                    if(o.raphael&&o.id){
                        v=v||0;
                        var prf=xui.Event._getProfile(o.id),t;
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                            t=xui.clone(Raphael.parseTransformString(o.transform()),true);
                            // only for the first
                            if(t&&t[0]&&t[0][0]=="s"){
                                t[0][2]=v;
                            }else{
                                t=t||[];
                                t.unshift(['s',1,v]);
                            }
                            o.transform(t);
                        }
                    }else{
                         if(xui.isNaN(v))v=1;
                        var transform=o.style.transform||"";
                        if(/(scale\()([^,]+),([^)]+)/i.test(transform))transform=transform.replace(/(scale\()([^,]+),([^)]+)/i, '$1$2,'+v);
                        else if(/scale\([-\d.]*\)/i.test(transform))transform=transform.replace(/scale\([-\d.]*\)/i, 'scale(1,'+v+')');
                        else transform+=" scale(1,"+v+")";
                        xui.Dom.setStyle(o,'transform',transform);
                    }
                });
            }else{
                var o=this.get(0);
                if(o.raphael&&o.id){
                   v=1;
                    var prf=xui.Event._getProfile(o.id);
                    if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                         xui.arr.each(Raphael.parseTransformString(o.transform()),function(t){
                            if(t[0]=="s")v*=t[2];
                        });
                    }
                    return v;
                }else{
                   var arr=/(scale\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
                   if(arr)return parseFloat(arr[3]||1);
                   else{
                        arr=/scale\(([-\d.]*)\)/i.exec(this.get(0).style.transform);
                        return arr?arr[1]:1;
                    }
                }
            }
        },
        translateX:function(v){
            if(xui.isSet(v)){
                return this.each(function(o){
                     if(o.raphael&&o.id){
                        v=parseFloat(v)||0;
                        var prf=xui.Event._getProfile(o.id),t;
                        // modify the last 't'
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                            t=xui.clone(Raphael.parseTransformString(o.transform()),true);
                            if(t&&t.length&&t[t.length-1]&&(t[t.length-1][0]=="t")){
                                t[t.length-1][1]=v;
                            }else{
                                t=t||[];
                                t.push(['t',v,0]);
                            }
                            o.transform(t);
                        }
                    }else{
                        v=xui.CSS.$addu(v);
                        var transform=o.style.transform||"";
                        if(/translate\([^)]*\)/i.test(transform))transform=transform.replace(/(translate\()([^,]+),([^)]+)/i, '$1'+v+',$3');
                        else transform+=" translate("+v+",0)";
                        xui.Dom.setStyle(o,'transform',transform);
                    }
                });
            }else{
                var o=this.get(0);
                if(o.raphael&&o.id){
                    v=0;
                    var prf=xui.Event._getProfile(o.id);
                    if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                         xui.arr.each(Raphael.parseTransformString(o.transform()),function(t){
                            if(t[0]=="t")v+=t[1];
                        });
                    }
                    return v;
                }else{
                   var arr=/(translate\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
                   return arr?(arr[2]||"").replace(/\s/g,''):'';
                }
            }
        },
        translateY:function(v){
            if(xui.isSet(v)){
                return this.each(function(o){
                     if(o.raphael&&o.id){
                        v=parseFloat(v)||0;
                        var prf=xui.Event._getProfile(o.id);
                        if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                            t=xui.clone(Raphael.parseTransformString(o.transform()),true);
                            // modify the last 't'
                            if(t&&t.length&&t[t.length-1]&&(t[t.length-1][0]=="t")){
                                t[t.length-1][2]=v;
                            }else{
                                t=t||[];
                                t.push(['t',0,v]);
                            }
                            o.transform(t);
                        }
                    }else{
                        v=xui.CSS.$addu(v);
                        var transform=o.style.transform||"";
                        if(/translate\([^)]*\)/i.test(transform))transform=transform.replace(/(translate\()([^,]+),([^)]+)/i, '$1$2,'+v);
                        else transform+=" translate(0,"+v+")";
                        xui.Dom.setStyle(o,'transform',transform);
                    }
                });
            }else{
                var o=this.get(0);
                if(o.raphael&&o.id){
                    v=0;
                    var prf=xui.Event._getProfile(o.id);
                    if((prf = prf && prf.parent && prf.parent._paper) && (o=prf.getById(o.raphaelid))){
                         xui.arr.each(Raphael.parseTransformString(o.transform()),function(t){
                            if(t[0]=="t")v+=t[2];
                        });
                    }
                    return v;
                }else{
                   var arr=/(translate\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
                   return arr?(arr[3]||"").replace(/\s/g,''):'';
                }
            }
        },
        skewX:function(v){
            if(xui.isSet(v)){
                if(xui.isFinite(v))v+='deg';
                return this.each(function(o){
                    var transform=o.style.transform||"";
                    if(/skew\([^)]*\)/i.test(transform))transform=transform.replace(/(skew\()([^,]+),([^)]+)/i, '$1'+(v||0)+',$3');
                    else transform+=" skew("+v+",0deg)";
                    xui.Dom.setStyle(o,'transform',transform);
                });
            }else{
               var arr=/(skew\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
               return arr?parseFloat(arr[2]||0):0;
            }
        },
        skewY:function(v){
            if(xui.isSet(v)){
                 if(xui.isFinite(v))v+='deg';
                return this.each(function(o){
                    var transform=o.style.transform||"";
                    if(/skew\([^)]*\)/i.test(transform))transform=transform.replace(/(skew\()([^,]+),([^)]+)/i, '$1$2,'+(v||0));
                    else transform+=" skew(0deg,"+v+")";
                    xui.Dom.setStyle(o,'transform',transform);
                });
            }else{
               var arr=/(skew\()([^,]+),([^)]+)/i.exec(this.get(0).style.transform);
               return arr?parseFloat(arr[3]||0):0;
            }
        },
        /*
        *IE/opera \r\n will take 2 chars
        *in IE: '/r/n'.lenght is 2, but range.moveEnd/moveStart will take '/r/n' as 1.
        */
        caret:function(begin,end){
            var input =this.get(0), tn=input.nodeName.toLowerCase(), type=typeof begin,ie=xui.browser.ie, pos;
            if(!/^(input|textarea)$/i.test(tn))return;
            if(tn=="input" && input.type.toLowerCase()!='text'&& input.type.toLowerCase()!='password')return;
            input.focus();
            //set caret
            if(type=='number'){
                if(ie){
                    var r = input.createTextRange();
                    r.collapse(true);
                    r.moveEnd('character', end);
                    r.moveStart('character', begin);
                    r.select();
                }else{
                    input.focus();
                    input.setSelectionRange(begin, end);
                }
                return this;
            //replace text
            }else if(type=='string'){
                    var r=this.caret(),l=0,m=0,ret,
                        v=input.value,
                        reg1=/\r/g;
                    //for IE, minus \r
                    if(ie){
                        l=v.substr(0,r[0]).match(reg1);
                        l=(l && l.length) || 0;
                        m=begin.match(reg1);
                        m=(m && m.length) || 0;
                    }
                    //opera will add \r to \n, automatically
                    if(xui.browser.opr){
                        l=begin.match(/\n/g);
                        l=(l && l.length) || 0;
                        m=begin.match(/\r\n/g);
                        m=(m && m.length) || 0;
                        m=l-m;l=0;
                    }
                    input.value=v.substr(0,r[0])+begin+v.substr(r[1],v.length);
                    ret= r[0] - l + m + begin.length;
                    this.caret(ret,ret);
                    return ret;
            //get caret
            }else{
                if(ie && document.selection){
                    var r=document.selection.createRange(),
                        txt=r.text,
                        l=txt.length,
                        e,m;
                    if(tn.toLowerCase()=='input'){
                        r.moveStart('character', -input.value.length);
                        e=r.text.length;
                        return [e-l,e];
                    }else{
                        var rb=r.duplicate();
                        rb.moveToElementText(input);
                        rb.setEndPoint('EndToEnd',r);
                        e=rb.text.length;
                        return [e-l, e];
                    }
                //firefox opera safari
                }else
                    return [input.selectionStart, input.selectionEnd];
            }
        },
        //left,top format: "23px"
        show:function(left,top,callback,showEffects,ignoreEffects){
            var style,t,v=xui.Dom.HIDE_VALUE,vv;
            return this.each(function(o){
                if(o.nodeType != 1)return;
                var tid=xui.getNodeData(o,'_inthread');
                if(tid){
                    xui.Thread(tid).abort();
                    xui.setNodeData(o,'_inthread');
                }

                style=o.style;
                vv=xui.getNodeData(o);
                if(vv._xuihide){
                    if('_left' in vv)if(style.left!=(t=vv._left))style.left=t;
                    if('_top' in vv)if(style.top!=(t=vv._top))style.top=t;
                    if('_position' in vv)if(style.position!=(t=vv._position))style.position=t;
                    if(style.visibility!='visible')style.visibility='visible';
                    vv._xuihide=0;
                }
                if(xui.isSet(left))style.left=left;
                if(xui.isSet(top))style.top=top;
                //force to visible
//                if(style.visibility!='visible')style.visibility='visible';
//                if(style.display=='none')style.display='';

                //ie6 bug
              /*  if(xui.browser.ie&&xui.browser.ver<=6){
                    t=style.wordWrap=='normal';
                    xui.asyRun(function(){
                        style.wordWrap=t?'break-word':'normal'
                    })
                }*/
                showEffects=ignoreEffects?null:showEffects?showEffects:xui.get(xui.UIProfile.getFromDom(o),['properties','showEffects']);
                if(showEffects)showEffects=xui.Dom._getEffects(showEffects,1);
                if(showEffects)xui.Dom._vAnimate(o,showEffects,callback);else if(callback)callback();
            });
        },
        hide:function(callback,hideEffects,ignoreEffects){
            var style,vv;
            return this.each(function(o){
                if(o.nodeType != 1)return;
                var tid=xui.getNodeData(o,'_inthread');
                if(tid){
                    xui.Thread(tid).abort();
                    xui.setNodeData(o,'_inthread');
                }

                style=o.style;
                vv=xui.getNodeData(o);
                var fun=function(){
                    if(vv._xuihide!==1){
                        vv._position = style.position;
                        vv._visibility = style.visibility;
                        vv._top = style.top;
                        vv._left = style.left;
                        vv._xuihide=1;
                    }
                    if(style.position!='absolute')style.position = 'absolute';
                    style.visibility="hidden";
                    style.top = style.left = xui.Dom.HIDE_VALUE;

                    if(callback)callback();
                };
                hideEffects=ignoreEffects?null:hideEffects?hideEffects:xui.get(xui.UIProfile.getFromDom(o),['properties','hideEffects']);
               if(hideEffects)hideEffects=xui.Dom._getEffects(hideEffects,0);
                if(hideEffects)xui.Dom._vAnimate(o,hideEffects,fun);else fun();
            });
        },
        cssRegion:function(region,triggerEvent) {
            var self=this;
            if(typeof region=='object'){
                var i,t,m,  node=self.get(0), dom=xui.Dom, f=dom._setUnitStyle,m={};
                for(var j=0,c=dom._boxArr;i=c[j++];)
                    m[i] = ((i in region) && region[i]!==null)?f(node,i,region[i]):false;
                if(triggerEvent){
                    var f=dom.$hasEventHandler;
                    if(f(node,'onsize') && (m.width||m.height))self.onSize(true, {width:m.width,height:m.height});
                    if(f(node,'onmove') && (m.left||m.top))self.onMove(true, {left:m.left,top:m.top});
                }
                return self;
            }else{
                var offset=region,parent=triggerEvent,
                    pos = offset?self.offset(null,parent):self.cssPos(),
                    size = self.cssSize();
                return {
                    left:pos.left,
                    top:pos.top,
                    width:size.width,
                    height:size.height
                };
            }
        },
        //for quick size
        cssSize:function(size,triggerEvent) {
            var self=this, node=self.get(0),r,dom=xui.Dom,f=dom._setUnitStyle,b1,b2;
            if(node){
               if(size){
                    var t;
                    b1 = size.width!==null?f(node,'width',size.width):false;
                    b2 = size.height!==null?f(node,'height',size.height):false;
                    if(triggerEvent && (b1||b2) && dom.$hasEventHandler(node,'onsize'))self.onSize(true, {width:b1,height:b2});
                    r=self;
                }else
                    r={ width :self._W(node,1)||0,  height :self._H(node,1)};
                return r;
            }else{
                return size?self:{};
            }
        },
        //for quick move
        cssPos:function(pos, triggerEvent){
            var node=this.get(0),
                dom=xui.Dom,
                css=xui.CSS,
                f=dom._setUnitStyle,
                b1,b2,r;
            if(pos){
                var t;
                b1 = pos.left!=null?f(node,'left',pos.left):false;
                b2 = pos.top!==null?f(node,'top',pos.top):false;
                if(triggerEvent && (b1||b2) && dom.$hasEventHandler(node,'onmove'))this.onMove(true, {left:b1,top:b2});
                r=this;
            }
            // get always returns to px
            else{
                f=dom.getStyle;
                r={left :css.$px(f(node, 'left'),node),  top : css.$px(f(node, 'top'),node)};
            }
            node=null;
            return r;
        },
        /*
        +--------------------------+
        |margin                    |
        | #----------------------+ |
        | |border                | |
        | | +------------------+ | |
        | | |padding           | | |
        | | | +--------------+ | | |
        | | | |   content    | | | |

        # is the offset position in CrossUI
        */
        offset:function (pos,boundary){
            var r,t,
            browser = xui.browser,
            ns=this,
            node = ns.get(0),
            keepNode=node,
            parent =node.parentNode,
            op=node.offsetParent,
            doc=node.ownerDocument,
            dd=doc.documentElement,
            db=doc.body,
            _d=/^inline|table.*$/i,
            getStyle=xui.Dom.getStyle,
            fixed = getStyle(node, "position") == "fixed",

            me=arguments.callee,
            add= me.add || (me.add=function(pos, l, t){
                pos.left += parseFloat(l)||0;
                pos.top += parseFloat(t)||0;
            }),
            border=me.border || ( me.border = function(node, pos){
                add(pos, getStyle(node,'borderLeftWidth'), getStyle(node,'borderTopWidth'));
            }),
            TTAG=me.TTAG||(me.TTAG={TABLE:1,TD:1,TH:1}),
            HTAG = me.HTAG ||(me.HTAG={BODY:1,HTML:1}),
            posDiff=me.posDiff ||(me.posDiff=function(o,target){
                var cssPos = o.cssPos(),absPos = o.offset(null,target);
                return {left :absPos.left-cssPos.left, top :absPos.top-cssPos.top};
            });

            boundary=boundary?xui(boundary).get(0):doc;

            if(pos){
                //all null, return dir
                if(pos.left===null&&pos.top===null)return ns;
                var d = posDiff(ns,boundary);
                ns.cssPos({left :pos.left===null?null:(pos.left - d.left),  top :pos.top===null?null:(pos.top - d.top)});
                r=ns;
            }else{
                //for IE, firefox3(except document.body)
                if(!(xui.browser.gek && node===document.body) && node.getBoundingClientRect){
                    t = node.getBoundingClientRect();
                    pos = {left :t.left, top :t.top};
                    if(boundary.nodeType==1 && boundary!==document.body)
                        add(pos, -(t=boundary.getBoundingClientRect()).left+boundary.scrollLeft, -t.top+boundary.scrollTop);
                    else
                        add(pos, (dd.scrollLeft||db.scrollLeft||0)-dd.clientLeft, (dd.scrollTop||db.scrollTop||0)-dd.clientTop);
                }else{
                    pos = {left :0, top :0};
                    add(pos, node.offsetLeft, node.offsetTop );
                    //get offset, stop by boundary or boundary.offsetParent
                    while(op && op!=boundary && op!=boundary.offsetParent){
                        add(pos, op.offsetLeft, op.offsetTop);
                        if(browser.kde || (browser.gek && !TTAG[op.nodeName]))
                            border(op, pos);
                        if ( !fixed && getStyle(op,"position")== "fixed")
                            fixed = true;
                        if(op.nodeName!='BODY')
                            keepNode=op.nodeName=='BODY'?keepNode:op;
                        op = op.offsetParent;
                    }

                    //get scroll offset, stop by boundary
                    while (parent && parent.nodeName && parent!=boundary && !HTAG[parent.nodeName]){
                        if(!_d.test(getStyle(parent, "display")) )
                            add(pos, -parent.scrollLeft, -parent.scrollTop );
                        if(browser.gek && getStyle(parent,"overflow")!= "visible" )
                            border(parent,pos);
                        parent = parent.parentNode;
                    }
                    if((browser.gek && getStyle(keepNode,"position")!="absolute"))
                        add(pos, -db.offsetLeft, -db.offsetTop);
                    if(fixed)
                        add(pos, dd.scrollLeft||db.scrollLeft||0, dd.scrollTop||db.scrollTop||0);
                }
                r=pos;
            }
            return r;
        },
//class and src
        hasClass:function(name){
            var i,l,isReg=xui.isReg(name), arr = xui.Dom._getClass(this.get(0)).split(/\s+/);
            if(isReg){
                for(i=0,l=arr.length;i<l;i++){
                    if(name.test(arr[i])){
                        return true;
                    }
                }
            }else{
                return xui.arr.indexOf(arr, name+"")!=-1;
            }
            return false;
        },
        addClass:function(name){
            var arr, i,l,me=arguments.callee,reg=(me.reg||(me.reg=/\s+/)),t,ok,
                  arr2 = (name+"").split(reg);                
            if(!arr2.length)return this;

            return this.each(function(o){
                ok=0;
                arr = xui.Dom._getClass(o).split(reg);
                t=[];
                for(i=0,l=arr.length;i<l;i++)if(arr[i])t.push(arr[i]);
                for(i=0,l=arr2.length;i<l;i++){
                    if(arr2[i] && xui.arr.indexOf(arr, arr2[i])==-1){
                        ok=1;
                        t.push(arr2[i]);
                    }
                };
                if(ok)xui.Dom._setClass(o, t.join(" "));
            });
        },
        removeClass:function(name){
            var arr, i,l, isReg=xui.isReg(name), me=arguments.callee,reg=(me.reg||(me.reg=/\s+/)),ok,
                  arr2;
            if(!isReg){
                arr2=(name+"").split(reg);
                if(!arr2.length)return this;
            }
            return this.each(function(o){
                ok=0;
                arr = xui.Dom._getClass(o).split(reg);
                if(!isReg){
                    for(i=0,l=arr2.length;i<l;i++){
                        if(xui.arr.indexOf(arr,arr2[i])!=-1){
                            ok=1;
                            xui.arr.removeValue(arr, arr2[i]);
                        }
                    }
                }else{
                    xui.filter(arr,function(o,i){
                        if(name.test(o)){
                            ok=1;
                            return false;
                        }
                    });
                }
                if(ok)xui.Dom._setClass(o, arr.join(" "));
            });
        },
        replaceClass:function(regexp,replace){
            var n,r;
            return this.each(function(o){
                r = (n=xui.Dom._getClass(o)).replace(regexp, replace);
                if(n!=r)xui.Dom._setClass(o,r);
            });
        },
        tagClass:function(tag, isAdd){
            var self=this,
                me=arguments.callee,
                r1=me["_r1_"+tag]||(me["_r1_"+tag]=new RegExp("([-\\w]+" + tag + "[-\\w]*)")),
                r2=me["_r2"]||(me["_r2"]=/([-\w]+)/g);
            self.removeClass(r1);
            isAdd=false!==isAdd;
            var r= isAdd ? self.replaceClass(r2, '$1 $1' + tag) : self;

            //fix for ie67
            if(xui.__iefix2 && (tag=="-checked"||tag=="-fold"||tag=="-expand")){
                this.each(function(n){
                    var arr = xui.Dom._getClass(n).split(/\s+/);
                    if(xui.arr.indexOf(arr,'xuifont')!=-1 || xui.arr.indexOf(arr,'xuicon')!=-1){
                        xui.arr.each(arr,function(s){
                            //It has 'xxxx' and 'xxxx-checked'
                            if(xui.__iefix2[s+(isAdd?'':tag)] && xui.__iefix2[isAdd?s.replace(new RegExp(tag+'$'),''):s] ){
                                xui(n).html(xui.__iefix2[s.replace(new RegExp(tag+'$'),'')+(isAdd?tag:'')]);
                                return false;
                            }
                        });
                    }
                });
            }
            return r;
        },
//events:
        /*
        $addEvent('onClick',fun,'idforthisclick';)
        $addEvent([['onClick',fun,'idforthisclick'],[...]...])

        do:
            add onclick to dom
            append fun to xui.$cache.profileMap.id.events.onClick array
            append 'onclick' to xui.$cache.profileMap.id.add array
        */

        $addEventHandler:function(name){
            var event=xui.Event,
                type,
                handler=event.$eventhandler;
            return this.each(function(o){
                if(o.nodeType==3)return;
                //set to purge map
                xui.setNodeData(o, ['eHandlers', 'on'+event._eventMap[name]], handler);

                //set to dom node
                if(type=event._eventHandler[name]){
                    o[type]=handler;
                    xui.setNodeData(o, ['eHandlers', type], handler);

                    if(xui.browser.isTouch && type=='onmousedown'){
                        xui.setNodeData(o, ['eHandlers', 'onxuitouchdown'], handler);
                        if(o.addEventListener){
                            o.addEventListener("xuitouchdown", handler,false);
                        }else if(o.attachEvent){
                            o.attachEvent("xuitouchdown", handler);
                        }
                    }
                }
            });
        },
        /*
        'mousedown' -> 'dragbegin'
        'mouseover' -> 'dragenter'
        'mouseout' -> 'dragleave'
        'mouseup' -> 'drop'
        */
        $removeEventHandler:function(name){
            var event=xui.Event,
                handler=event.$eventhandler,
                type;
            return this.each(function(o){
                //remove from dom node
                if(type=event._eventHandler[name]){
                    o[type]=null;
                    if(xui.browser.isTouch && type=='onmousedown'){
                        if(o.removeEventListener){
                            o.removeEventListener("xuitouchdown", handler,false);
                        }else if(o.detachEvent){
                            o.detachEvent("xuitouchdown", handler);
                        }
                    }
                }

                //remove from purge map
                if(o=xui.getNodeData(o,'eHandlers')){
                    type='on'+event._eventMap[name];
                    delete o[type];
                    if(xui.browser.isTouch && type=='onmousedown'){
                        delete o['onxuitouchdown'];
                    }
                }
            });
        },
        $addEvent:function(name, fun, label, index){
            var self=this,
                event=xui.Event,
                arv=xui.arr.removeValue,
                ari=xui.arr.insertAny,
                id,c,t,m;

            if(!index && index!==0)index=-1;

            if(typeof label=='string')
                label="$"+label;
            else label=undefined;

            self.$addEventHandler(name).each(function(o){
                if(o.nodeType==3)return;

                if(!(id=event.getId(o))&&o!==window&&o!==document)
                    id=o.id=xui.Dom._pickDomId();

                if(!(c=xui.$cache.profileMap[id]))
                    c=new xui.DomProfile(id);

                t = c.events || (c.events = {});
                m = t[name] || (t[name]=[]);

                //if no label input, clear all, and add a single
                if(label===undefined){
                    m.length=0;
                    m=t[name]=[];
                    index=-1;
                    label='_';
                }
                m[label]=fun;
                arv(m,label);
                if(index==-1)m[m.length]=label;
                else
                    ari(m,label, index);

                if(xui.Event && (c=xui.Event._getProfile(id)) && c.clearCache)
                    c.clearCache();
            });

            return self;
        },
        /*
        $removeEvent('onClick','idforthisclick')
        $removeEvent('onClick')
            will remove all onClick in xui.$cache.profileMap.id.events.
        $removeEvent('onClick',null,true)
            will remove all onClick/beforeClick/afterClick in xui.$cache.profileMap.id.events.
        */
        $removeEvent:function(name, label, bAll){
            var self=this,c,t,k,id,i,type,
                event=xui.Event,
                dom=xui.$cache.profileMap,
                type=event._eventMap[name];

            self.each(function(o){
                if(!(id=event.getId(o)))return;
                if(!(c=dom[id]))return;
                if(!(t=c.events))return;
                if(bAll)
                    xui.arr.each(event._getEventName(type),function(o){
                        delete t[o];
                    });
                else{
                    if(typeof label == 'string'){
                        label='$'+label;
                        if(k=t[name]){
                            delete k[label];
                            if(xui.arr.indexOf(k,label)!=-1)
                                xui.arr.removeValue(k,label);
                        }
                    }else
                        delete t[name];
                }

                if(xui.Event && (c=xui.Event._getProfile(id)) && c.clearCache)
                    c.clearCache();
            });

            return self;
        },
        $getEvent:function(name, label){
            var id;
            if(!(id=xui.Event.getId(this.get(0))))return;

            if(label)
                return xui.get(xui.$cache.profileMap,[id,'events',name,'$' + label]);
            else{
                var r=[],arr = xui.get(xui.$cache.profileMap,[id,'events',name]);
                xui.arr.each(arr,function(o,i){
                    r[r.length]={o:arr[o]};
                });
                return r;
            }
        },
        $clearEvent:function(){
            return this.each(function(o,i){
                if(!(i=xui.Event.getId(o)))return;
                if(!(i=xui.$cache.profileMap[i]))return;
                xui.breakO(i.events,2);
                delete i.events;

                xui.arr.each(xui.Event._events,function(s){
                   if(o["on"+s])o["on"+s]=null;
                });
            });
        },
        $fireEvent:function(name, args){
            var type=xui.Event._eventMap[name],
            t,s='on'+type,
            handler,
            hash,
            me=arguments.callee,
            f=xui.Event.$eventhandler,
            f1=me.f1||(me.f1=function(){this.returnValue=false}),
            f2=me.f2||(me.f2=function(){this.cancelBubble=true});
            return this.each(function(o){
                if(!(handler=xui.getNodeData(o,['eHandlers', s])))return;
                if('blur'==type || 'focus'==type){
                    try{o[type]()}catch(e){}
                }else{
                      hash=xui.copy(args);
                      xui.merge(hash,{
                        type: type,
                        target: o,
                        button : 1,
                        $xuievent:true,
                        $xuitype:name,
                        preventDefault:f1,
                        stopPropagation:f2
                      },'all');
                    handler.call(o,hash);
                }
            });
        },
        nativeEvent:function(name){
            return this.each(function(o){
                if(o.nodeType===3||o.nodeType===8)return;
                try{o[name]()}catch(e){}
            });
        },

//functions
        $canFocus:function(){
            var me=arguments.callee, getStyle=xui.Dom.getStyle, map = me.map || (me.map={a:1,input:1,select:1,textarea:1,button:1,object:1}),t,node;
            return !!(
                (node = this.get(0)) &&
                node.focus &&
                //IE bug: It can't be focused with 'default tabIndex 0'; but if you set it to 0, it can be focused.
                //So, for cross browser, don't set tabIndex to 0
                (((t=map[node.nodeName.toLowerCase()]) && !(parseInt(node.tabIndex,10)<=-1)) || (!t && parseInt(node.tabIndex,10)>=(xui.browser.ie?1:0))) &&
                getStyle(node,'display')!='none' &&
                getStyle(node,'visibility')!='hidden' &&
                node.offsetWidth>0 &&
                node.offsetHeight>0
            );
        },
        focus:function(force){
            var ns=this;
            if(force || ns.$canFocus())
                try{ns.get(0).focus()}catch(e){}
            return ns;
        },
        blur:function(){
            var n=this.get(0);
            if(!n)return;
            n.blur();
            if(document.activeElement===n){
                xui.asyRun(function(){
                    xui('body').append(n = xui.create("<button style='position:absolute;width:1px;height:1px;left:-1000px;'></button>"));
                    n.focus();
                    n.remove();
                });
            }
        },
        setSelectable:function(value){
            var me=arguments.callee,cls;
            this.removeClass("xui-ui-selectable").removeClass("xui-ui-unselectable");
            this.addClass(value?"xui-ui-selectable":"xui-ui-unselectable");
            return this.each(function(o){
                if(xui.browser.ie && xui.browser.ver<10)
                    xui.setNodeData(o,"_onxuisel",value?"true":"false");
            })
        },
        contentBox : function(){
            return (xui.browser.ie||xui.browser.opr) ?
                    !/BackCompat|QuirksMode/.test(d.compatMode) :
                    (this.css("box-sizing") || this.css("-moz-box-sizing")) == "content-box";
        },
        setInlineBlock:function(){
            var ns=this;
            if(xui.browser.gek){
                if(xui.browser.ver<3)
                    ns.css('display','-moz-inline-block').css('display','-moz-inline-box').css('display','inline-block');
                else
                    ns.css('display','inline-block');
            }else if(xui.browser.ie&&xui.browser.ver<=6)
                ns.css('display','inline-block').css({display:'inline',zoom:'1'});
            else
                ns.css('display','inline-block');
            return ns;
        },
        topZindex:function(flag){
            //set the minimum to 1000
            var i=1000, j=0, k, node = this.get(0), p = node.offsetParent, t, o;
            if(xui.browser.ie && (!p||(p.nodeName+"").toUpperCase()=="HTML")){
                p=xui("body").get(0);
            }
            if(node.nodeType !=1 || !p)return 1;

            t=p.childNodes;
            for(k=0;o=t[k];k++){
                if(o==node || o.nodeType !=1 || !o.$xid || o.style.display=='none' || o.style.visibility=='hidden' || o.zIndexIgnore ||  xui.getNodeData(o,'zIndexIgnore') )continue;
                j = parseInt(o.style && o.style.zIndex,10) || 0 ;
                i=i>j?i:j;
            }
            i++;
            if(i>=xui.Dom.TOP_ZINDEX)
                xui.Dom.TOP_ZINDEX =i+1;

            if(flag)
                 node.style.zIndex = i;
            else{
                j = parseInt(node.style.zIndex,10) || 0;
                return i>j?i:j;
            }
            return this;
        },
        /*
        dir:true for next, false for prev
        inn:true for include the inner node
        set:true for give focus
        */
        nextFocus:function(downwards, includeChild, setFocus, pattern){
            downwards=xui.isBool(downwards)?downwards:true;
            var self=this.get(0),node = this.$iterator('',downwards,includeChild,function(node){return node!==self && (!pattern || (node.id&&pattern.test(node.id))) && xui([node]).$canFocus()});
            if(!node.isEmpty() && setFocus!==false)node.focus();
            self=null;
            return node;
        },

        /*
        args:{
            width:[0,100],
            height:[0,100],
            left:[0,100]
            top:[0,100]
            opacity:[0,1],
            backgroundColor:['#ffffff','#000000']
            scrollTop:[0,100]
            scrollLeft:[0,100]
            fontSize:[12,18]
        }
        */
        animate: function(endpoints, onStart, onEnd, duration, step, type, threadid, unit, restore, times, _goback){
            var self=this,  f, map={left:1,top:1,right:1,bottom:1,width:1,height:1},
                prf = xui.$cache.profileMap[self.id()],
                ctrl = prf?prf.boxing():null,
                css = xui.CSS,
                tween = xui.Dom.$AnimateEffects,
                _get = function(node, ctrl, key, t){
                    return (map[key] && ctrl && xui.isFun(ctrl[t='get'+xui.str.initial(key)])) ? ctrl[t](key) : node[key] ? node[key]() :node.css(key);
                },
                _set = function(node, ctrl, key, value, t){
                    return (map[key] && ctrl && xui.isFun(ctrl[t='set'+xui.str.initial(key)])) ? ctrl[t](value) : node[key] ? node[key](value) :node.css(key, value);
                },
                color = function(from,to,curvalue){
                    if(typeof from !='string' || typeof to != 'string')return '#fff';
                    if(curvalue<0)return from;
                    if(curvalue>1) return to;

                    var f,f1,f2,f3;
                    f=function(str){
                        return (str.charAt(0)!='#')?('#'+str):str;
                    };
                    from=f(from);to=f(to);

                    f1=function(str, i, j){
                        return parseInt(str.slice(i,j),16)||0;
                    };
                    f2=function(o){
                        return {red:f1(o,1,3),green:f1(o,3,5),blue:f1(o,5,7)}
                    };
                    from = f2(from);
                    to = f2(to);

                    f3=function(from, to, value,c){
                        var r= from[c]+Math.round(parseFloat(value*(to[c]-from[c]))||0);
                        return (r < 16 ? '0' : '') + r.toString(16)
                    };
                    return '#' + f3(from,to, curvalue, 'red') + f3(from,to, curvalue, 'green') + f3(from,to, curvalue, 'blue');
                };
            if(!endpoints){
                if(onEnd)xui.tryF(onEnd);
                return;
            }else{
                // adjust endpoints
                xui.each(endpoints,function(o,i){
                    if(!xui.isFun(o)){
                        if(!xui.isArr(o) || o.length===1) o = [_get(self, ctrl, i), o];
                        endpoints[i]=o;
                    }
                });
            }
            var parmsBak=endpoints;
            // clone it now
            endpoints=xui.clone(endpoints);
            
            // Estimate duration by steps
            if((step||0)>0)
                duration=step*16;
            else
                duration = duration||200;
            times=times||1;
            if((type||"").indexOf('-')!=-1)type=type.replace(/\-(\w)/g, function(a,b){return b.toUpperCase()});
            type = (type in tween)?type:'circIn';

            var starttime, node=self.get(0), fun=function(threadid){
                var offtime=xui.stamp() - starttime, curvalue,u,eu,su,s,e;
                if(offtime >= duration)offtime=duration;
                xui.each(endpoints,function(o,i){
                    curvalue = tween[type](duration, offtime);
                    if(typeof o == 'function') o.call(self, curvalue);
                    else{
                        s=o[0];e=o[1];u=o[2];
                        if(xui.str.endWith(i.toLowerCase(),'color')){
                            curvalue = color(s, e, curvalue);
                        }else{
                            if(!xui.isFinite(e)){
                                u=e.replace(/[-\d.]*/,'');
                                eu=u||'px';
                                if(!xui.isFinite(s)){
                                    su=s.replace(/[-\d.]*/,'')||'px';
                                    if(su!=eu){
                                        if(su=='em'&&eu=='px'){
                                            s=css.$em2px(s,node);
                                        }else if(su=='px'&&eu=='em'){
                                            s=css.$px2em(s,node);
                                        }
                                    }
                                }
                            }
                            s=parseFloat(s)||0;
                            e=parseFloat(e)||0;
                            curvalue = xui.toFixedNumber(s + (e-s)*curvalue, 6);
                        }
                        curvalue+=u||unit||'';
                        _set(self, ctrl, i, curvalue)
                    }
                });
                if(offtime==duration){
                    if(restore&&!_goback){
                        starttime=xui.stamp();
                        _goback=1;
                        xui.each(endpoints,function(v,k){if(!xui.isFun(v)){k=v[0];v[0]=v[1];v[1]=k}});
                    }else{
                        if(times==-1||times>0){
                            starttime=xui.stamp();
                            if(times>0)times-=1;
                            if(_goback){
                                _goback=0;
                                xui.each(endpoints,function(v,k){if(!xui.isFun(v)){k=v[0];v[0]=v[1];v[1]=k}});
                            }
                        }
                    }
                    if(!times){
                        xui.Thread(threadid).abort('normal');
                    }
                    return false;
                }
            },funs=[fun];

            var tid=xui.getNodeData(node,'_inthread');
            if(tid && xui.Thread.isAlive(tid)){
                xui.Thread(tid).abort('force');
                xui.setNodeData(node,'_inthread',null);
            }
            var reset=xui.getNodeData(node,'_animationreset');
            if(typeof reset=="function"){                
                reset();
                xui.setNodeData(node,'_animationreset',null);
            }

            return xui.Thread(threadid||xui.id(), funs, 0, null, function(tid){
                xui.setNodeData(node,'_inthread',tid);
                starttime=xui.stamp();
                xui.setNodeData(node,'_animationreset',function(){
                    xui.merge(endpoints,parmsBak,'all');
                    starttime=xui.stamp();
                    fun();
                });
                return xui.tryF(onStart,arguments,this);
            }, function(tid,flag){
                //maybe destroyed
                if(node&&node.$xid){
                    xui.setNodeData(node,'_inthread',null);
                    xui.setNodeData(node,'_animationreset',null);
                }
                if('force'!=flag)
                    xui.tryF(onEnd,arguments,this);
            },true);
        },
        pop : function(pos, type, parent, trigger, group){
            var ns=this,id=xui.stamp()+":"+ns.xid();
            ns.popToTop(pos, type||"outer",parent).setBlurTrigger(id, function(){
                if(typeof(trigger)=="function")xui.tryF(trigger);
                else ns.hide();
            });
            return id;
        },
        // pop to the top layer
        popToTop : function(pos, type, parent, callback, showEffects, ignoreEffects){
            var region, target=this, t;
            parent=xui(parent);
            if(parent.isEmpty())
                parent=xui('body');

            //prepare
            target.css({position:'absolute',left:xui.Dom.HIDE_VALUE, top:xui.Dom.HIDE_VALUE,display:'block', zIndex:xui.Dom.TOP_ZINDEX++});

            //ensure show target on the top of the other elements with the same zindex
            //parent.get(0).appendChild(target.get(0));
            target.css({left :0, top :0, visibility:'hidden',display:'block'});
            parent.append(target);

            //show
            target.cssPos(xui.Dom.getPopPos(pos, type, target, parent)).css({visibility:'visible'});

            showEffects=ignoreEffects?null:showEffects?showEffects:xui.get(xui.UIProfile.getFromDom(target),['properties','showEffects']);
            if(showEffects)showEffects=xui.Dom._getEffects(showEffects,1);
            if(showEffects)xui.Dom._vAnimate(target,showEffects,callback);else if(callback)callback();
            return this;
        },
        hoverPop : function(node, type, beforePop,beforeHide, parent, groupid, showEffects, hideEffects){
            node=xui(node);
            if(showEffects)showEffects=xui.Dom._getEffects(showEffects,1);
            if(hideEffects)hideEffects=xui.Dom._getEffects(hideEffects,0);
            if(!xui.isDefined(type))type='outer';

            var aysid=groupid || (this.xid()+":"+node.xid()),self=this;
            this.onMouseover(type===null?null:function(prf, e, src){
                if(e.$force)return;
                xui.resetRun(aysid,null);
                var ignore=xui.getData([aysid,'$ui.hover.pop'])
                                && xui.getNodeData(node.get(0)||"empty",'$ui.hover.parent')==src;
                if(!ignore){
                    xui.setData([aysid,'$ui.hover.pop'],1);
                    xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',src);
                    if(!beforePop || false!==beforePop(prf, node, e, src)){
                        node.popToTop(src, type, parent,showEffects);
                        node.onMouseover(function(){
                            self.onMouseover(true)
                        },'hoverPop').onMouseout(function(){
                            self.onMouseout(true)
                        },'hoverPop');
                    }
                }
            },aysid).onMouseout(type===null?null:function(prf, e, src){
                if(e.$force)return;
                xui.resetRun(aysid,function(){
                    xui.setData([aysid,'$ui.hover.pop']);
                    xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',0);
                    if(!beforeHide || false!==beforeHide(prf, node,e, src,'host')){
                        node.hide(null,hideEffects);
                        node.onMouseover(null,'hoverPop').onMouseout(null,'hoverPop');
                    }
                });
            },aysid);
            if(node){
                node.onMouseover(type===null?null:function(e){
                    if(e.$force)return;
                     xui.resetRun(aysid,null);
                },aysid).onMouseout(type===null?null:function(prf,e,src){
                    if(e.$force)return;
                    xui.resetRun(aysid,function(){
                        xui.setData([aysid,'$ui.hover.pop']);
                        xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',0);
                        if(!beforeHide || false!==beforeHide(prf, node,e, src, 'pop')){
                            node.hide(null,hideEffects);
                            node.onMouseover(null,'hoverPop').onMouseout(null,'hoverPop');
                        }
                    });
                },aysid);
            }
            node.css('display','none');
            return this;
        },
        //for remove obj when blur
        setBlurTrigger : function(id, trigger/*[false] for anti*/, group /*keep the original refrence*/,
                                  /*two inner params */ checkChild, triggerNext){
            var ns=this,
                doc=document,
                sid='$blur_triggers$',
                fun=xui.Dom._blurTrigger||(xui.Dom._blurTrigger=function(p,e){
                    var p=xui.Event.getPos(e),
                        arr=arguments.callee.arr,
                        srcN=xui.Event.getSrc(e),
                        a=xui.copy(arr),
                        b, pos, w, h, v;
                    //filter first
                    xui.arr.each(a,function(i){
                        b=true;
                        if(!(v=arr[i].target))b=false;
                        else
                            v.each(function(o){
                                if(o!==window&&o!==document&&!xui.Dom.byId(o.id))
                                    return b=false;
                            });
                        if(!b){
                            delete arr[i];
                            xui.arr.removeValue(arr,i);
                        };
                    });
                    a=xui.copy(arr);
                    xui.arr.each(a,function(i){
                        v=arr[i];
                        if(!v)return;

                        b=true;
                        var isChild=function(){
                            var nds=v.target.get();
                            while (srcN && srcN.nodeName && srcN.nodeName!="BODY" && srcN.nodeName!="HTML"){
                                if(xui.arr.indexOf(nds,srcN)!=-1)
                                    return true;
                                srcN = srcN.parentNode;
                            }
                        };
                        if(!v.checkChild || isChild()){
                            v.target.each(function(o){
                                if(o.parentNode && (w=o.offsetWidth) && (h=o.offsetHeight)){
                                    pos=xui([o]).offset();
                                    if(p.left>=pos.left && p.top>=pos.top && p.left<=(pos.left+w) && p.top<=(pos.top+h)){
                                        return b=false;
                                    }
                                }
                            });
                        }

                        isChild=null;

                        // anti trigger
                        if(!b && !xui.isFun(v.trigger))
                            return false;

                        if(b){
                            delete arr[i];
                            xui.arr.removeValue(arr,i);
                            xui.tryF(v.trigger,[p,e],v.target);
                            v=null;
                        }else if(v.stopNext){
                            //if the top layer popwnd cant be triggerred, prevent the other layer popwnd trigger
                            return false;
                        }
                    },null,true);
                    srcN=null;
                    a.length=0;
                }),
                arr=fun.arr||(fun.arr=[]),
                target;

            // remove this trigger first
            if(arr[id]){
                if(trigger===true){
                    xui.tryF(arr[id].trigger);
                    trigger=false;
                }
                delete arr[id];
                xui.arr.removeValue(arr,id);
            }
            // add trigger
            if(trigger){
                if(group){
                    //keep the original refrence
                    if(group['xui.Dom'])
                        target=group;
                    else if(xui.isArr(group)){
                        target=xui();
                        target._nodes=group;
                    }
                    target.merge(ns);
                }else{
                    target=ns;
                }

                target.each(function(o){if(!o.id&&o!==window&&o!==document)o.id=xui.Dom._pickDomId()});

                //double link
                arr[id]={
                    trigger:trigger,
                    target:target,
                    checkChild:!!checkChild,
                    stopNext:!triggerNext
                };
                arr.push(id);

                if(!doc.onmousedown)doc.onmousedown=xui.Event.$eventhandler;
                doc=fun=null;
            }
            return this;
        },
        //for firefox disappeared cursor bug in input/textarea
        $firfox2:function(){
            if(!xui.browser.gek2)return this;
            var ns=this;
            ns.css('overflow','hidden');
            xui.asyRun(function(){ns.css('overflow','auto')});
            return ns;
        },
        //IE not trigger dimension change, when change height only in overflow=visible.
        ieRemedy:function(){
            if(xui.browser.ie&&xui.browser.ver<=6){
                var a1=this.get(),a2=[],a3=[],l=a1.length;
                //xui.asyRun(function(){                    
                    for(var i=0;i<l;i++){
                        // allow once
                        if(!xui.isSet(a1[i].$ieRemedy)){
                            if(xui.isSet(a1[i].style.width)){
                                a1[i].$ieRemedy=a1[i].style.width;
                                a1[i].style.width=((xui.CSS.$px(a1[i].$ieRemedy,a1[i])||0)+1)+"px";
                            }
                        }
                        /*
                        if((a3[i]=a1[i].style.WordWrap)=='break-word')
                            a1[i].style.WordWrap='normal';
                        else
                            a1[i].style.WordWrap='break-word';
                        */
                    }
                    xui.asyRun(function(){
                        for(var i=0;i<l;i++){
                            if(xui.isSet(a1[i].$ieRemedy)){
                                a1[i].style.width=a1[i].$ieRemedy;
                                a1[i].removeAttribute('$ieRemedy');
                            }
                            //a1[i].style.WordWrap=a3[i];
                        }
                        a1.length=a2.length=a3.length=0;
                    });                    
               // });
            }
            return this;
        }
        /*,
        gekRemedy:function(){
            if(xui.browser.gek)
                return this.each(function(o,i){
                    if(i=o.style){
                        var b=i.zIndex||0;
                        i.zIndex=++b;
                        i.zIndex=b;
                    }
                });
        }*/
    },
    Static:{
        HIDE_VALUE : '-10000px',
        TOP_ZINDEX:10000,

        _boxArr:xui.toArr('width,height,left,top,right,bottom'),
        _cursor:{},

        _pickDomId:function(){
            var id;
            do{id='xui_'+xui.id()}while(document.getElementById(id))
            return id;
        },
        _map:{
            'html':1,
            'head':1,
            'body':1
        },
        //for ie6
        fixPng:function(n){
            if(xui.browser.ie&&xui.browser.ver<=6){
                if(n.nodeName=='IMG' && n.src.toLowerCase().search(/\.png$/) != -1){
                    n.style.height = n.height;
                    n.style.width = n.width;
                    n.style.backgroundImage ="none";
                    var t= ((n.style.filter?(n.style.filter+","):"")+"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, src=" + n.src + "', sizingMethod='image')").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/[,\s]+/g,', ');
                    if(xui.browser.ie8)n.style.msfilter = t;
                    n.style.filter = t;
                    n.src = xui.ini.img_bg;
                }
                var bgimg = n.currentStyle.backgroundImage || n.style.backgroundImage,
                    bgmatch = (bgimg||"").toLowerCase().match(/^url[("']+(.*\.png[^\)"']*)[\)"']+[^\)]*$/i);
                if(bgmatch){
                    n.style.backgroundImage ="none";
                    var t = ((n.style.filter?(n.style.filter+","):"")+"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, src=" + bgmatch[1] + "', sizingMethod='crop')").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/[,\s]+/g,', ');
                    if(xui.browser.ie8)n.style.msfilter = t;
                    n.style.filter=t;
                }
            }
        },
        _getTag:function(n){ return n ? n.$xid ? n.$xid : n.nodeType==1 ? xui.$registerNode(n).$xid : 0 : 0},
        _ensureValues:function(obj){
            var t,i,map=this._map,a=[],
            //can't be obj, or opera will crash
            arr =  obj===window
                    ? ['!window']
                    : obj===document
                    ? ['!document']
                    : xui.isArr(obj)
                    ? obj
                    :(obj=='[object NodeList]' || obj=='[object HTMLCollection]')
                    ? xui.toArr(obj)
                    : obj['xui.Dom']
                    ? obj._nodes
                    : obj._toDomElems
                    ? obj._toDomElems()
                    : typeof obj == 'function'
                    ? obj()
                    :[obj];
            for(i=0;i<arr.length;i++)
                if( t = !(t=arr[i])
                            ? 0
                            : t===window
                            ? '!window'
                            : t===document
                            ? '!document'
                            : (typeof t=='string' || (t['xui.DomProfile'] && (t=t.domId)))
                                ? t.charAt(0)=='!'
                                    ?  t
                                    : this._getTag( map[t] ? document.getElementsByTagName(t)[0] : document.getElementById(t))
                            : ((t=arr[i])['xui.UIProfile']||t['xui.Template'])
                            ? t.renderId ? t.renderId : (t.boxing().render() && t.renderId)
                            : this._getTag(t)
                  )
                    a[a.length]=t;
            return a.length<=1?a:this._unique(a);
        },
        _getClass:function(o){
            return (typeof o.className=="string"&&o.className)
            || (typeof o.className.baseVal=="string"&&o.className.baseVal)
            || (typeof o.getAttribute!=="undefined" && o.getAttribute("class"))
            || "";
        },
        _setClass:function(o,v){
            if(typeof o.className=="string"){
                o.className=v;
            }else if(typeof o.className.baseVal=="string"){
                o.className.baseVal=v;
            }else if(typeof o.getAttribute!="undefined"){
                o.setAttribute(v);
            }
        },
        /*
        pos: {left:,top:} or dom element
        parent:parent node
        type:1,2,3,4
        */
        getPopPos : function(pos, type, target, parent){
            var region, node, abspos, t, box;
            parent=xui(parent);
            if(parent.isEmpty())
                parent=xui('body');
            if(pos['xui.UI'] || pos['xui.UIProfile'] || pos['xui.Dom'] || pos.nodeType==1 || typeof pos=='string'){
                if(typeof(type)!="function"){
                    type=(type||12)+'';
                }
                node=xui(pos);
                //base region
                abspos = node.offset(null, parent);
                region = {
                    left:abspos.left,
                    top:abspos.top,
                    width:node.offsetWidth(),
                    height:node.offsetHeight()
                };
            }else{
                if(typeof(type)!="function"){
                    type = type?'3':'0';
                }
                t=type=='0'?0:8;
                region = pos.region || {
                    left:pos.left-t,
                    top:pos.top-t,
                    width:t*2,
                    height:t*2
                };
            }
            pos={left :0, top :0};

            //window edge
            t=(parent.get(0)===document.body || parent.get(0)===document || parent.get(0)===window)?xui.win:parent;
            box = {};

            box.left=t.scrollLeft();
            box.top=t.scrollTop();
            box.width =t.width()+box.left;
            box.height =t.height()+box.top;
            /*
                type:1
                    +------------------+    +------------------+
                    |        3         |    |        4         |
                    +--------------+---+    +---+--------------+
                    |              |            |              |
                    |              |            |              |
                    +--------------+---+    +---+--------------+
                    |        1         |    |        2         |
                    +------------------+    +------------------+
                type:2
                                         +---+              +---+
                                         |   |              |   |
                +---+--------------+---+ |   +--------------+   |
                |   |              |   | | 3 |              | 4 |
                | 2 |              | 1 | |   |              |   |
                |   +--------------+   | +---+--------------+---+
                |   |              |   |
                +---+              +---+
                type:3
                                         +---+              +---+
                                         | 3 |              | 4 |
                    +--------------+     +---+--------------+---+
                    |              |         |              |
                    |              |         |              |
                +---+--------------+---+     +--------------+
                | 2 |              | 1 |
                +---+              +---+
                type:4
                                     +------------------+
                                     | 3                |
                +--------------+---+ |   +--------------+ +----+--------------+ +--------------+----+
                |              |   | |   |              | |    |              | |              |    |
                |              |   | |   |              | |    |              | |              |    |
                +--------------+   | +---+--------------+ |    +--------------+ +--------------+    |
                |                1 |                      |  2                | |               4   |
                +------------------+                      +-------------------- +-------------------+
            */
            if(typeof(type)=='function'){
                pos=type(region, box, target, t);
            }else{
                //target size
                var w = target?target.offsetWidth():0,
                    h = target?target.offsetHeight():0,
                    arr=type.split(/-/g);
                if(arr.length==2){
                    var hp=arr[0],vp=arr[1];
                    switch(vp){
                        case "outertop":
                            pos.top=region.top-h;break;
                        case "top":
                            pos.top=region.top;break;
                        case "middle":
                            pos.top=region.top+region.height/2-h/2;break;
                        case "bottom":
                            pos.top=region.top+region.height-h;break;
                        default:
                        //case "outerbottom":
                            pos.top=region.top+region.height;
                    }
                    switch(hp){
                        case "outerleft":
                            pos.left=region.left-w;break;
                        case "left":
                            pos.left=region.left;break;
                        case "center":
                            pos.left=region.left+region.width/2-w/2;break;
                        case "right":
                            pos.left=region.left+region.width-w;break;
                        default:
                        //case "outerright":
                            pos.left=region.left+region.width;
                    }
                }else{
                    if(type=="outer")type="12";
                    else if(type=="inner")type="4";

                    var adjust=function(type){
                        var hi,wi;
                        switch(type){
                            case '2':
                                hi=true;wi=false;
                            break;
                            case '3':
                                hi=wi=false;
                            break;
                            case '4':
                                hi=wi=true;
                            break;
                            default:
                            //case '1':
                                hi=false;wi=true;
                        }

                        if(hi){
                            if(region.top + h < box.height)
                                pos.top=region.top;
                            else
                                pos.top=region.top+region.height-h;
                        }else{
                            if(region.top + region.height + h < box.height)
                                pos.top=region.top + region.height;
                            else
                                pos.top=region.top - h;
                        }
                        if(wi){
                            if(region.left + w < box.width)
                                pos.left=region.left;
                            else
                                pos.left=region.left+region.width-w;
                        }else{
                            if(region.left + region.width + w < box.width)
                                pos.left=region.left + region.width;
                            else
                                pos.left=region.left - w;
                        }
                        //over right
                        if(pos.left + w>  box.width)pos.left = box.width - w;
                        //over left
                        if(pos.left < box.left)pos.left = box.left;
                        //over bottom
                        if(pos.top + h>  box.height)pos.top = box.height - h;
                        //over top
                        if(pos.top < box.top)pos.top = box.top;
                    };

                    if(type=='12'){
                        adjust('1');
                        if(pos.top < region.top+region.height && pos.top+h > region.top)adjust('2');
                    }else if(type=='21'){
                        adjust('2');
                        if(pos.left < region.left+region.width && pos.left+w > region.left)adjust('1');
                    }else{
                        adjust(type);
                    }
                }
            }
            return pos;
        },
        _scrollBarSize:0,
        getScrollBarSize: function(force){
            var ns=this;
            if(force||!ns._scrollBarSize){
                var div;
                xui('body').append(div=xui.create('<div style="width:50px;height:50px;visibility:hidden;position:absolute;margin:0;padding:0;left:-10000px;overflow:scroll;"></div>'));
                ns._scrollBarSize=div.get(0).offsetWidth-div.get(0).clientWidth;
                div.remove();
            }
            return ns._scrollBarSize;
        },
        getStyle:function(node, name, force){
            if(!node || node.nodeType!=1)return '';
            if(name=="rotate"){
               return xui(node).rotate();
            }
            var ns=xui.Dom,
                css3prop=xui.Dom._css3prop;

            var value,b;
            if(name=='opacity' && (!ns.css3Support("opacity")) && xui.browser.ie)
                b = name = 'filter';

            value= node.style[name];
            if(force || !value || value==="initial"){
                var me =xui.Dom.getStyle,t,
                brs=xui.browser,
                map = me.map || (me.map = {'float':1,'cssFloat':1,'styleFloat':1}),
                c1 = me._c1 || (me._c1={}),
                c2 = me._c2 || (me._c2={}),
                c3 = me._c3 || (me._c3={}),
                name = c1[name] || (c1[name] = name.replace(/\-(\w)/g, function(a,b){return b.toUpperCase()})),
                name2 = c2[name] || (c2[name] = name.replace(/([A-Z])/g, "-$1" ).toLowerCase()),
                name3,name4;

                var n1=name;
                if(n1.indexOf("border")===0){
                    n1=n1.replace(/[-]?(left|top|right|bottom)/ig,'');
                }
                if(xui.arr.indexOf(css3prop,n1)!=-1){
                    if(!ns.css3Support(name)){
                        return '';
                    }else{
                        if(name!="textShadow"){
                            name3 = brs.cssTag2+name2.charAt(0).toUpperCase()+name2.substr(1);
                            name4 = brs.cssTag1+name2;
                        }
                    }
                }

                if(map[name])
                    name = xui.browser.ie?"styleFloat":"cssFloat";
                //document.defaultView first, for opera 9.0
                value = ((t=document.defaultView) && t.getComputedStyle)?
                    (t=t.getComputedStyle(node,null))?
                        (t.getPropertyValue(name2) || (name4 && t.getPropertyValue(name4)))
                        :''
                    :node.currentStyle?
                        (node.currentStyle[name] || node.currentStyle[name2] || (name3 && (node.currentStyle[name3] || node.currentStyle[name4])))
                :((node.style && (node.style[name]||(name3 && node.style[name3])))||'');
            /*
                            if(xui.browser.opr){
                                var map2 = me.map2 || (me.map2={left:1,top:1,right:1,bottom:1});
                                if(map2[name] && (xui.Dom.getStyle(node,'position')=='static'))
                                    value = 'auto';
                            }
            */
            }
            // xui.CSS.$px is for IE678
            if(!b && xui.browser.ie678){
                // INPUT/TEXTREA will always return % for font-size
                if((name=='fontSize'||name2=='font-size') && /%/.test(value) && node.parentNode){
                    value=(node.parentNode.currentStyle[name]||node.parentNode.currentStyle[name2]) * (parseFloat(value)||0);
                }else if(xui.CSS.$isEm(value)){
                    value=xui.CSS.$px(value, node);;
                }
            }
            return b?value?(parseFloat(value.match(/alpha\(opacity=(.*)\)/)[1] )||0)/100:1:(value||'');
        },
        $transformIE:function(node, value) {
            var t = (node.style.filter||"").replace(/progid\:DXImageTransform\.Microsoft\.Matrix\([^)]+\)/ig,"").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
            if(xui.browser.ie8)node.style.msfilter = t;
            node.style.filter = t;
            node.style.marginTop=node.style.marginLeft="";
            if(value){
                var tmatrix = function(){
                    var current,
                        degRat = Math.PI/180,
                        //create new matrix
                        matrix = function(m11, m12, m21, m22, dx, dy){
                            var m = {};
                            m.m11 = xui.isSet(m11)?parseFloat(m11):1;
                            m.m12 = xui.isSet(m12)?parseFloat(m12):0;
                            m.m21 = xui.isSet(m21)?parseFloat(m21):0;
                            m.m22 = xui.isSet(m22)?parseFloat(m22):1;
                            m.dx = xui.isSet(dx)?parseFloat(dx):0;
                            m.dy = xui.isSet(dy)?parseFloat(dy):0;
                            return m;
                        },
                        //multiply matrices
                        multiply = function(newMatrix, currentMatrix){
                            //modify transformation matrix
                            var m ={};
                            m.m11 = roundNumber(newMatrix.m11*currentMatrix.m11 + newMatrix.m21*currentMatrix.m12, 10);
                            m.m12 = roundNumber(newMatrix.m12*currentMatrix.m11 + newMatrix.m22*currentMatrix.m12, 10);
                            m.m21 = roundNumber(newMatrix.m11*currentMatrix.m21 + newMatrix.m21*currentMatrix.m22, 10);
                            m.m22 = roundNumber(newMatrix.m12*currentMatrix.m21 + newMatrix.m22*currentMatrix.m22, 10);
                            m.dx = roundNumber(currentMatrix.dx + newMatrix.dx, 10);
                            m.dy = roundNumber(currentMatrix.dy + newMatrix.dy, 10);
                            //return new transformation matrix
                            return m;
                        },
                        //convert degrees to radians
                        deg2rad = function(deg){
                            return degRat*deg;
                        },
                        //format number
                        roundNumber = function(num, dec) {
                            var result = Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);
                            return result;
                        };

                    //rotate transformation
                    this.rotate = function(deg){
                        var rad = xui.isSet(deg)?parseFloat(deg2rad(parseFloat(deg))):0;
                        var m = matrix(Math.cos(rad), -Math.sin(rad), Math.sin(rad), Math.cos(rad), 0, 0);
                        current = multiply(m, current);
                    };
                    //translate transformations
                    this.translate = function(x, y){
                        var m = matrix(1, 0, 0, 1, parseFloat(x), parseFloat(y));
                        current = multiply(m, current);
                    };
                    this.translateX = function(x){
                        this.translate(x,0);
                    };
                    this.translateY = function(y){
                        this.translate(0,y);
                    };
                    //scaling transformations
                    this.scale = function(x,y){
                        var m = matrix(xui.isSet(x)?parseFloat(x):1, 0, 0, xui.isSet(y)?parseFloat(y):1, 0, 0);
                        current = multiply(m, current);
                    };
                    this.scaleX = function(x){
                        this.scale(x,1);
                    };
                    this.scaleY = function(y){
                        this.scale(1,y);
                    };
                    //skew transformations
                    this.skew = function(xAng, yAng){
                        xAng = xui.isSet(xAng)?parseFloat(deg2rad(parseFloat(xAng))):0;
                        yAng = xui.isSet(yAng)?parseFloat(deg2rad(parseFloat(yAng))):0;
                        var m = matrix(1, Math.tan(xAng), Math.tan(yAng), 1, 0, 0);
                        current = multiply(m, current);
                    };
                    this.skewX = function(xAng){
                        this.skew(xAng, 0);
                    };
                    this.skewY = function(yAng){
                        this.skew(0, yAng);
                    };
                    //transformation matrix
                    this.matrix = function(m11,m12,m21,m22,dx,dy){
                        current = multiply(matrix(m11,m12,m21,m22,dx,dy), current);
                    };
                    //return matrix
                    this.getMatrix = function(){
                        return current;
                    };
                    //return IE CSS matrix
                    this.getFilter = function(){
                        return "progid:DXImageTransform.Microsoft.Matrix(M11=" + current.m11 + ", M12=" + current.m12 + ", M21=" + current.m21 + ", M22=" + current.m22 + ", Dx=" + current.dx + ", Dy=" + current.dy + ", SizingMethod='auto expand')";
                    };
                    this.getX=function(){
                        return current.dx;
                    };
                    this.getY=function(){
                        return current.dy;
                    };
                    this.reset=function(){
                        current = matrix(1,0,0,1,0,0);
                    };
                    this.reset();
                };
                var computeMatrix = function(transform) {
                    var m=new tmatrix();
                    //Split the webkit functions and loop through them
                    var functions = transform.match(/[A-z]+\([^\)]+/g) || [];
                    for (var k=0; k < functions.length; k++) {
                        //Prepare the function name and its value
                        var arr=functions[k].split('('),
                            func=arr[0],
                            value=arr[1],
                            values;
                        //Now we rotate through the functions and add it to our matrix
                        switch(func) {
                            case 'rotate':
                                m.rotate(value);
                                break;
                            case 'scale':
                                values = value.split(',');
                                m.scale(values[0],values[1]);
                                break;
                            case 'scaleX':
                                m.scaleX(value);
                                break;
                            case 'scaleY':
                                m.scaleY(value);
                                break;
                            case 'skew':
                                values = value.split(',');
                                 m.skew(values[0],values[1]);
                                break;
                            case 'skewX':
                                 m.skewX(value);
                                break;
                            case 'skewY':
                                 m.skewY(value);
                                break;
                            case 'translate':
                                values = value.split(',');
                                 m.translate(values[0],values[1]);
                                break;
                            case 'translateX':
                                 m.translateX(value);
                                break;
                            case 'translateY':
                                 m.translateY(value);
                                break;
                            }
                    }
                    return m;
                };
                var matrix=computeMatrix(value);
                var ow=node.offsetWidth,oh=node.offsetHeight;
                var filter=matrix.getFilter();
//xui.echo(filter);
                var t=((node.style.filter?(node.style.filter+","):"")+filter).replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                if(xui.browser.ie8)node.style.msfilter = t;
                node.style.filter=t;
//xui.echo(t);

                // for fake case
                if(node.getBoundingClientRect){
                    var transX=matrix.getX(), 
                        transY=matrix.getY(),
                        rect = node.getBoundingClientRect(),
                        w=rect.right - rect.left, 
                        h=rect.bottom-rect.top;
     
                    node.style.marginLeft =Math.round(parseFloat((ow-w)/2  + 10 + transX))+'px';
                    node.style.marginTop = Math.round(parseFloat((oh-h)/2 + 10 + transY))+ 'px';
                }

                // fake
                node.style.transform=value;
            }
        },
        $textShadowIE:function(node, value, box){
            if(!value){
                var f=function(s){
                    return (s||"").replace(/progid\:DXImageTransform\.Microsoft\.(Chroma|DropShadow|Glow)\([^)]+\)/ig,"").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                },
                s1=node.style.filter;
                if(s1){
                    if(xui.browser.ie8)node.style.msfilter=f(s1);
                    node.style.filter=f(s1);
                }
                if(!box)
                    node.style.backgroundColor="";
            }else{
                var f=function(x,y,r,c){
                    return (box?"":"progid:DXImageTransform.Microsoft.Chroma(Color=#cccccc) ")
                    + "progid:DXImageTransform.Microsoft.DropShadow(Color="+c+", OffX="+x+", OffY="+y+") "
                    + (parseFloat(r)>0 ?"progid:DXImageTransform.Microsoft.Glow(Strength="+r+", Color="+c+")":"");
                },
                r=value.match(/([\d\.-]+)px\s+([\d\.-]+)px(\s+([\d\.-]+)px)?(\s+([#\w]+))?/);
                if(r){
                    var t=((node.style.filter?(node.style.filter+","):"")+f(r[1],r[2],r[4],r[6]||"#000000")).replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter=t;
                    node.style.filter=t;
                    if(!box)
                        node.style.backgroundColor="#C5C5C5";
                }
            }
        },
        /*
        *type:linear, or radial
        *orient:LT/T/RT/R/RB/B/LB/L, + C for radial
        *stops:{clr:, pos:, opacity:}
        *rate:0~1
        *shape: circle or ellipse, only for radial
        *size: farthest-corner..
        */
        $setGradients:function(node, value, xb){
            xb=xb||xui.browser;
            var ns=this,
                ver=xb.ver,
                c16="0123456789ABCDEF",
                _toFF=function(n,b){
                    n = parseInt(n*b,10)||0;
                    n = (n>255||n<0)?0:n;
                    return c16.charAt((n-n%16)/16) + c16.charAt(n%16);
                },
                _to255=function(s){
                    s=s.split('');
                    return c16.indexOf(s[0].toUpperCase())*16 + c16.indexOf(s[1].toUpperCase());
                };
            window.btoa=window.btoa||function (text){
                if(/([^\u0000-\u00ff])/.test(text))return ;
                var table="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,cur,prev,byteNum,result=[];
                while(i<text.length){
                  cur=text.charCodeAt(i);
                  byteNum=(i+1)%3;
                  switch(byteNum){
                    case 1://first byte
                      result.push(table.charAt(cur >> 2));
                      break;
                    case 2: //second byte
                      result.push(table.charAt((prev & 3) << 4 | (cur >> 4)));
                      break;
                    case 0: //third byte
                      result.push(table.charAt((prev & 0x0f) << 2 | (cur >> 6)));
                      result.push(table.charAt(cur & 0x3f));
                      break;
                  }
                  prev = cur;
                  i++;
                }
                if (byteNum == 1){
                  result.push(table.charAt((prev & 3) << 4));
                  result.push("==");
                } else if (byteNum == 2){
                  result.push(table.charAt((prev & 0x0f) << 2));
                  result.push("=");
                }
                return result.join("");
            }
            var iecracker1=function(node, orient, stops, shape, size, rate){
                var id="xui.s-ie8gdfix";
                if(!node || node.nodeType != 1 || !node.style)return;
                var tmp1=ns.getStyle(node,'overflow'),
                    tmp2=ns.getStyle(node,'display');
                if(tmp1!='hidden' || (tmp2!='block' && tmp2!='relative'))return;

                if(!orient){
                    var i,a=node.childNodes,l=a.length;
                    for(i=0;i<l;i++){
                        if(a[i].nodeType==1 && a[i].id==id){
                            node.removeChild(a[i]);
                            break;
                        }
                    }
                    node.style.backgroundColor='';
                    var t = ((node.style.filter||"").replace(/progid\:DXImageTransform\.Microsoft\.Alpha\([^)]+\)/ig,'')).replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter = t;
                    node.style.filter=t;
                }else{
                    rate=rate||1;

                    var innerColor=stops[0].clr,
                        outerColor=stops[stops.length-1].clr;

                    var ew=node.offsetWidth||0,
                    eh=node.offsetHeight||0,
                    aw=ew*rate*2,
                    ah=eh*rate*2;

                    if(shape=='circle')
                        aw=ah=Math.min(aw,ah);

                    var l=-aw/2,t=-ah/2,w=aw,h=ah;
                    if(xui.isObj(orient)){
                        l=orient.left||(Math.round(parseFloat(l)||0)+'px');
                        t=orient.top||(Math.round(parseFloat(t)||0)+'px');
                    }else{
                        switch(orient){
                            case 'LT':
                                l=-aw/2;t=-ah/2;
                            break;
                            case 'T':
                                l=(ew-aw)/2;t=-ah/2;
                            break;
                            case 'RT':
                                l=ew-aw/2;t=-ah/2;
                            break;
                            case 'L':
                                l=-aw/2;t=(eh-ah)/2;
                            break;
                            case 'C':
                                l=(ew-aw)/2;t=(eh-ah)/2;
                            break;
                            case 'R':
                                l=ew-aw/2;t=(eh-ah)/2;
                            break;
                            case 'LB':
                                l=-aw/2;t=eh-ah/2;
                            break;
                            case 'B':
                                l=(ew-aw)/2;t=eh-ah/2;
                            break;
                            case 'RB':
                                l=ew-aw/2;t=eh-ah/2;
                            break;
                        }
                        l+='px';
                        t+='px';
                    }

                    var at = document.createElement('div'),
                        s=at.style;
                    at.id=id;
                    s.position = 'absolute';
                    s.zIndex = '0';
                    s.top = t;
                    s.left = l;
                    s.width = Math.round(parseFloat(w)||0)+'px';
                    s.height = Math.round(parseFloat(h)||0)+'px';
                    s.backgroundColor=innerColor;

                    var starto=stops[0].opacity?parseFloat(stops[0].opacity)*100:100
                    var t = ((s.filter?(s.filter+","):"")+'progid:DXImageTransform.Microsoft.Alpha(opacity='+starto+', finishopacity=0, style=2)').replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)s.msfilter = t;
                    s.filter=t;

                    // the first node
                    if(node.firstChild)
                        node.insertBefore(at, node.firstChild);
                    else
                        node.appendChild(at);
                    node.style.backgroundColor = outerColor;
                    if(stops[stops.length-1].opacity){
                        var t = ((node.style.filter?(node.style.filter+","):"")+"progid:DXImageTransform.Microsoft.Alpha(opacity="+(parseFloat(stops[stops.length-1].opacity)*100)+")").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                        if(xui.browser.ie8)node.style.msfilter = t;
                        node.style.filter=t;
                    }
                }
            },
            iecracker21=function(node, orient, stops){
                var id="xui.s-ie8gdfix";
                if(!node || node.nodeType != 1 || !node.style)return;
                var tmp1=ns.getStyle(node,'overflow'),
                    tmp2=ns.getStyle(node,'display');
                if(tmp1!='hidden'){
                    ns.setStyle(node,'overflow','hidden');
                }
                if(tmp2!='block' && tmp2!='relative'){
                    ns.setStyle(node,'display','relative');
                }

                if(!orient){
                    var i,a=node.childNodes,l=a.length;
                    for(i=0;i<l;i++){
                        if(a[i].nodeType==1 && a[i].id==id){
                            node.removeChild(a[i]);
                            break;
                        }
                    }
                    node.style.backgroundColor='';
                    var t = (node.style.filter||"").replace(/progid\:DXImageTransform\.Microsoft\.Alpha\([^)]+\)/ig,'').replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter = t;
                    node.style.filter=t;
                }else{
                    var innerColor=stops[0].clr,
                        outerColor=stops[stops.length-1].clr;

                    var ew=node.offsetWidth||0 ,
                    eh=node.offsetHeight||0,
                    size=Math.min(ew,eh),
                    xs=0,xe=size,ys=0,ye=size;

                    switch(orient){
                        case 'LT':
                        xs=0;ys=0;xe=size;ye=size;
                        break;
//                      case 'T':
//                      xs=0;ys=0;xe=0;ye=size;
//                      break;
                        case 'RT':
                        xs=size;ys=0;xe=0;ye=size;
                        break;
//                      case 'L':
//                      xs=0;ys=0;xe=0;ye=size;
//                      break;
//                      case 'R':
//                      xs=size;ys=0;xe=0;ye=0;
//                      break;
                        case 'LB':
                        xs=0;ys=size;xe=size;ye=0;
                        break;
//                      case 'B':
//                      xs=0;ys=size;xe=0;ye=0;
//                      break;
                        case 'RB':
                        xs=size;ys=size;xe=0;ye=0;
                        break;
                    }

                    var at = document.createElement('div'),
                        s=at.style;
                    at.id=id;
                    s.position = 'absolute';
                    s.zIndex = '0';
                    s.top = 0;
                    s.left = 0;
                    s.width = ew;
                    s.height = eh;
                    s.backgroundColor=innerColor;

                    var starto=stops[0].opacity?parseFloat(stops[0].opacity)*100:100
                    var t =( (s.filter?(s.filter+","):"")+'progid:DXImageTransform.Microsoft.Alpha(style=1, opacity='+starto+', finishopacity=0, startX='+xs+',finishX='+xe+',startY='+ys+',finishY='+ye+')').replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)s.msfilter = t;
                    s.filter=t;

                    // the first node
                    if(node.firstChild)
                        node.insertBefore(at, node.firstChild);
                    else
                        node.appendChild(at);
                    node.style.backgroundColor = outerColor;
                    if(stops[stops.length-1].opacity){
                        var t = ((node.style.filter?(node.style.filter+","):"")+"progid:DXImageTransform.Microsoft.Alpha(opacity="+(parseFloat(stops[stops.length-1].opacity)*100)+")").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                        if(xui.browser.ie8)node.style.msfilter = t;
                        node.style.filter=t;
                    }
                }
            },
            iecracker2=function(node,orient,stops){
                var id="xui.s-ie8gdfix";
                if(!node || node.nodeType!=1 || !node.style)return;
                if(!orient){
                    var t = ((node.style.filter||"").replace(/progid\:DXImageTransform\.Microsoft\.Gradient\([^)]+\)/ig,'')).replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter = t;
                    node.style.filter=t;
                    var i,a=node.childNodes,l=a.length;
                    for(i=0;i<l;i++){
                        if(a[i].nodeType==1 && a[i].id==id){
                            node.removeChild(a[i]);
                            break;
                        }
                    }
                    node.style.backgroundColor='';
                    var t = ((node.style.filter||"").replace(/progid\:DXImageTransform\.Microsoft\.Alpha\([^)]+\)/ig,'')).replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter = t;
                    node.style.filter = t;
                }else{
                    var innerColor=stops[0].clr,
                        outerColor=stops[stops.length-1].clr,
                        ori=1,t;
                    if(stops[0].opacity)
                        innerColor = innerColor.replace('#','#'+_toFF(stops[0].opacity,255));
                    if(stops[stops.length-1].opacity)
                        outerColor = outerColor.replace('#','#'+_toFF(stops[stops.length-1].opacity,255));
                    switch(orient){
                        case 'LT':
                        case 'RT':
                        case 'LB':
                        case 'RB':
                           iecracker21(node, orient, stops);
                        return;
                        case "L":
                            ori=1;
                        break;
                        case "R":
                            ori=1;
                            t=innerColor;
                            innerColor=outerColor;
                            outerColor=t;
                        break;
                        case "T":
                            ori=0;
                        break;
                        case "B":
                            ori=0;
                            t=innerColor;
                            innerColor=outerColor;
                            outerColor=t;
                        break;
                    }
                    var t = ((node.style.filter?(node.style.filter+","):"")+"progid:DXImageTransform.Microsoft.Gradient(StartColorstr='"+innerColor+"',EndColorstr='"+outerColor+"',GradientType="+ori+")").replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    if(xui.browser.ie8)node.style.msfilter = t;
                    node.style.filter =t;
                }
            },
            svgcracker1=function(node,orient,stops, shape, size, rate){
                if(!orient){
                    node.style.backgroundImage="";
                }else{
                    rate=rate||1;
                    var id='svg:'+xui.id(),
                        cx='0%',cy='0%',
                        r=rate*100+"%";
                    if(xui.isObj(orient)){
                        cx=orient.left||cx;
                        cy=orient.left||cy;
                    }else{
                        switch(orient){
                            case "T":
                                cx='50%';cy='0%';
                            break;
                            case "B":
                                cx='50%';cy='100%';
                            break;
                            case "L":
                                cx='0%';cy='50%';
                            break;
                            case "R":
                                cx='100%';cy='50%';
                            break;
                            case "LT":
                                cx='0%';cy='0%';
                            break;
                            case "RT":
                                cx='100%';cy='0%';
                            break;
                            case "RB":
                                cx='100%';cy='100%';
                            break;
                            case "LB":
                                cx='0%';cy='100%';
                            break;
                            case "C":
                                cx='50%';cy='50%';
                            break;
                        }
                    }
                    /*                    var rectw=1,recth=1;
                                        if(shape=='circle'){
                                            var m=Math.min(node.offsetWidth,node.offsetHeight);
                                            if(m==node.offsetWidth){
                                                recth=m/node.offsetHeight;
                                            }else{
                                                rectw=m/node.offsetWidth;
                                            }
                                        }
                    */
                    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 1 1" preserveAspectRatio="none">'
                    +'<radialGradient id="'+id+'" gradientUnits="userSpaceOnUse" cx="'+cx+'" cy="'+cy+'" r="'+r+'">';

                    for(var i=0,l=stops.length;i<l;i++){
                        svg += '<stop stop-color="'+stops[i].clr+'" offset="'+stops[i].pos+'" '+(xui.isSet(stops[i].opacity)?(' stop-opacity="'+stops[i].opacity+'"'):'')+' />';
                    }

                    svg += '</radialGradient>'
                    +'<rect x="-50" y="-50" width="101" height="101" fill="url(#'+id+')" />'
                    +'</svg>';

                    node.style.backgroundImage = 'url("data:image/svg+xml;base64,'+window.btoa(svg)+'")';
                }
            },
            svgcracker2=function(node,orient,stops){
                if(!orient){
                    node.style.backgroundImage='';
                }else{
                    var id='svg'+xui.id(),x1='0%',y1='0%',x2='0%',y2='100%';

                    switch(orient){
                        case "T":
                            x1='50%'; y1='0%';
                            x2='50%'; y2='100%';
                        break;
                        case "B":
                            x1='50%'; y1='100%';
                            x2='50%'; y2='0%';
                        break;
                        case "L":
                            x1='0%'; y1='50%';
                            x2='100%'; y2='50%';
                        break;
                        case "R":
                            x1='100%'; y1='50%';
                            x2='0%'; y2='50%';
                        break;
                        case "LT":
                            x1='0%'; y1='0%';
                            x2='100%'; y2='100%';
                        break;
                        case "RT":
                            x1='100%'; y1='0%';
                            x2='0%'; y2='100%';
                        break;
                        case "RB":
                            x2='0%'; y2='0%';
                            x1='100%'; y1='100%';
                        break;
                        case "LB":
                            x1='0%'; y1='100%';
                            x2='100%'; y2='0%';
                        break;
                        default:
                        /*To caculate x1/x2/y1/y2 from orient*/
                    }

                    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 1 1" preserveAspectRatio="none">'
                    +'<linearGradient id="'+id+'" gradientUnits="userSpaceOnUse" x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'">';

                    for(var i=0,l=stops.length;i<l;i++){
                        svg += '<stop stop-color="'+stops[i].clr+'" offset="'+stops[i].pos+'" '+(xui.isSet(stops[i].opacity)?(' stop-opacity="'+stops[i].opacity+'"'):'')+'/>';
                    }

                    svg += '</linearGradient>'
                    +'<rect x="0" y="0" width="1" height="1" fill="url(#'+id+')" />'
                    +'</svg>';

                    node.style.backgroundImage = 'url("data:image/svg+xml;base64,'+window.btoa(svg)+'")';
                }
            },
            css1=function(node,orient,stops, shape, size, rate){
                var arr1=[],arr2=[],style=node.style;
                xui.arr.each(stops,function(o){
                    var clr=o.clr;
                    if(xui.isSet(o.opacity) && clr.charAt(0)=='#'){
                        clr=clr.slice(1);
                        clr="rgba("+_to255(clr.substr(0, 2))+","+_to255(clr.substr(2, 2))+","+_to255(clr.substr(4, 2))+","+(parseFloat(o.opacity)||1)+")";
                    }
                    arr1.push(clr + " " + o.pos);
                    if(xb.isWebKit){
                        arr2.push("color-stop(" + o.pos + ',' + clr + ")");
                    }
                });

                if(!orient){
                    style.backgroundImage="";
                }else{
                    var position;
                    if(xui.isObj(orient)){
                        position = orient.left + " " + orient.top;
                    }else{
                        switch(orient){
                            case 'LT':position = 'left top';break;
                            case 'T':position = 'center top';break;
                            case 'RT':position = 'right top';break;
                            case 'L':position = 'left center';break;
                            case 'C':position = 'center center';break;
                            case 'R':position = 'right center';break;
                            case 'LB':position = 'left bottom';break;
                            case 'B':position = 'center bottom';break;
                            case 'RB':position = 'right bottom';break;
                            default:
                                position = 'left top';
                        }
                    }

                    if(xb.isWebKit){
                        style.backgroundImage = "-webkit-gradient(radial,"+position+", 0px, "+position+", 100%," + arr2.join(",") + ")";
                    }

                    var v1="radial-gradient("+ position +"," + shape + " "+ size +"," + arr1.join(",") + ")";
                    if(xb.cssTag1){
                        style.backgroundImage = xb.cssTag1+v1;
                    }
                    style.backgroundImage = "radial-gradient(" + size + " "+ shape + " at " + position +"," + arr1.join(",") + ")";
                }
            },
            css2=function(node,orient,stops){
                var arr1=[],arr2=[],style=node.style;
                xui.arr.each(stops,function(o){
                    var clr=o.clr;
                    if(xui.isSet(o.opacity) && clr.charAt(0)=='#'){
                        clr=clr.slice(1);
                        clr="rgba("+_to255(clr.substr(0, 2))+","+_to255(clr.substr(2, 2))+","+_to255(clr.substr(4, 2))+","+(parseFloat(o.opacity)||1)+")";
                    }
                    arr1.push(clr + " " + o.pos);
                    if(xb.isWebKit){
                        arr2.push("color-stop(" + o.pos + ',' + clr + ")");
                    }
                });

                if(!orient){
                    style.backgroundImage="";
                }else{
                    var direction = 'to bottom';
                    var directionmoz="top";
                    var directionwebkit = 'left top, left bottom';
                    switch(orient){
                        case 'LT':
                            direction="135deg";
                            directionmoz="-45deg";
                            directionwebkit = 'left top, right bottom';
                        break;
                        case 'T':
                            direction="to bottom";
                            directionmoz="top";
                            directionwebkit = 'left top, left bottom';
                        break;
                        case 'RT':
                            direction=directionmoz="-135deg";
                            directionwebkit = 'right top, left bottom';
                        break;
                        case 'L':
                            direction="to right";
                            directionmoz="left";
                            directionwebkit = 'left top, right top';
                        break;
                        case 'R':
                            direction="to left";
                            directionmoz="right";
                            directionwebkit = 'right top, left top';
                        break;
                        case 'LB':
                            direction=directionmoz="45deg";
                            directionwebkit = 'left bottom, right top';
                        break;
                        case 'B':
                            direction="to top";
                            directionmoz="bottom";
                            directionwebkit = 'left bottom, left top';
                        break;
                        case 'RB':
                            direction="-45deg";
                            directionmoz="135deg";
                            directionwebkit = 'right bottom, left top';
                        break;
                        default:
                            direction=orient;
                            directionmoz=orient;
                            directionwebkit = 'left top, right bottom';
                    }

                    if(xb.isWebKit){
                        style.backgroundImage = "-webkit-gradient(linear,"+directionwebkit+", " + arr2.join(",") + ")";
                    }

                    var v1="linear-gradient({#}," + arr1.join(",") + ")";
                    if(xb.cssTag1){
                        style.backgroundImage = xb.cssTag1+v1.replace("{#}",directionmoz);
                    }
                    style.backgroundImage = v1.replace("{#}",direction);
                }
            };

            var type=value?(value.type||value||'linear').toLowerCase():null,
                rate=value?(value.rate||1):null,
                shape=value?(value.shape||'circle').toLowerCase():null,
                size=value?(value.size||'farthest-corner').toLowerCase():null,
                orient=value?value.orient:null,
                stops=value?value.stops:null;

            if(type!='linear')
                type='radial';

            if(stops){
                if(stops.length>1){
                    xui.arr.stableSort(stops,function(x,y){
                        x=parseFloat(x.pos)||0;
                        y=parseFloat(y.pos)||0;
                        return x>y?1:x==y?0:-1;
                    });
                }else{
                    return;
                }
            }

            if(xb.ie678){
                if(type=='linear'){iecracker2(node,orient,stops);}
                else{iecracker1(node,orient,stops,shape,size,rate);}
            }
            if(xb.ie9 || (xb.opr && ver<11.1)){
                if(type=='linear'){svgcracker2(node,orient,stops);}
                else{svgcracker1(node,orient,stops,shape,size,rate);}
            }
            if(((xb.gek && ver>=3.6)
                ||(xb.isChrome && ver>=10)
                ||(xb.isSafari && ver>=5.1)
                ||(xb.ie && ver>=10)
                ||(xb.opr && ver>=11.1)
                )){
                if(type=='linear'){
                    css2(node,orient,stops);
                }else{
                    if(xb.opr && ver<12)
                        svgcracker1(node,orient,stops,shape,size,rate);
                    else
                        css1(node,orient,stops,shape,size,rate);
                }
            }
        },
        $setZoom:function(node,value){
            value=parseFloat(value);
            if(xui.isNaN(value) || value<=0)value='';
            var b=xui.browser,n=xui(node),h={};
            if(b.ie678)h.zoom=value;
            else{
                h[b.cssTag1 + "transform"] = h.transform = 'scale('+value+')';
                h[b.cssTag1 + "transform-origin"] = h["transform-origin"] = '0 0 0';
            }
            n.css(h);
        },
        _vAnimate:function(node,setting,callback){
            if(!setting || !setting.endpoints || xui.isEmpty(setting.endpoints)){
                if(callback)xui.tryF(callback);
                return;
            }

            var endpoints=setting.endpoints,begin={},end={};
            node=xui(node);
            xui.each(endpoints,function(o,i){if(!xui.isFun(o)){begin[i]=o[0];end[i]=o[1]}});

            return node.animate(endpoints, function(threadid){
                node.css(begin);
            },function(threadid){
                node.css(end);
                if(callback)xui.tryF(callback);
            },setting.duration,0,setting.type).start();
        },
        $adjustCss:function(hash,returnStr){
            var fack={nodeType:1,style:{}};
            xui.Dom.setStyle(fack,hash);
            if(returnStr){
                var arr=[];
                if(xui.browser.ie&&xui.browser.ver==8){
                    if(fack.style.filter)
                        fack.style["-ms-filter"]=fack.style.filter;
                    if(fack.style['background-image']=='none')
                        fack.style['background-image']="url(about:blank)";
                }
                xui.each(fack.style,function(o,i){
                    arr.push(i.replace(/([A-Z])/g, "-$1" ).toLowerCase()+":"+o);
                });
                return arr.join(';').replace(/[;]+/g,';');
            }else{
                return fack.style;
            }
        },
        _cssfake:{rotate:1, scaleX:1,scaleY:1,translateX:1,translateY:1,skewX:1,skewY:1},
        setStyle:function(node, name , value){
            if(name=="rotate"){
               xui(node).rotate(value);
               return this;
            }
            var ns=xui.Dom,
                css3prop=xui.Dom._css3prop,
                xb=xui.browser,
                fake=ns._cssfake;

            if(node.nodeType != 1)return;
            if(typeof name == 'string'){
                if(fake[name]){
                    xui(node)[name](value);
                }else{
                    var me=this.getStyle,
                    c1 = me._c1 || (me._c1={}),
                    r1 = me._r1 || (me._r1=/alpha\([^\)]*\)/ig),
                    map = me.map || (me.map = {'float':1,'cssFloat':1,'styleFloat':1});
                    var name2,name3,name4;
                    name = c1[name] || (c1[name] = name.replace(/\-(\w)/g, function(a,b){return b.toUpperCase()}));

                    var n1=name;
                    if(n1.indexOf("border")===0){
                        n1=n1.replace(/[-]?(left|top|right|bottom)/ig,'');
                    }

                    if(name=="$gradient"){
                        return ns.$setGradients(node,value);
                    }if(name=="$zoom"){
                        return ns.$setZoom(node,value);
                    }else if(name=='opacity'){
                        value=xui.isFinite(value)?
                                parseFloat(value)>1?
                                    1
                                    :parseFloat(value)<=0?
                                        0
                                    :parseFloat(value)
                                :1;
                        value= value >0.9999 ? '' : value;
                        if((!ns.css3Support("opacity"))&&xb.ie){
                            if(value==='')value=1;
                            // fake
                            node.style.opacity=value;
                            node.style.zoom=1;
                            value = "alpha(opacity="+ 100*value +")";
                            var ov = (node.style.filter||"").replace(r1, "");
                            value = (ov?(ov+","):"") + value;
                            name="filter";
                            if(xb.ver==8)name2="msfilter";
                        }
                    }else if(xui.arr.indexOf(css3prop,n1)!=-1){
                        if(!ns.css3Support(name)){
                            if(xb.ie && xb.ver<9){
                                switch(name){
                                    case "transform":
                                    xui.Dom.$transformIE(node,value);
                                    break;
                                    case "boxShadow":
                                    xui.Dom.$textShadowIE(node,value, true);
                                    break;
                                }
                            }
                            if(name=="textShadow" && xb.ie && xb.ver<10){
                                xui.Dom.$textShadowIE(node,value);
                            }
                            return this;
                        }else{
                            if(xb.cssTag2){
                                if(name!="textShadow"){
                                    name2=xb.cssTag2 + name.charAt(0).toUpperCase() + name.substr(1);
                                }
                            }
                        }
                    }else if(map[name]){
                        name = xb.ie?"styleFloat":"cssFloat";
                    }

                    if(name=="filter"){
                        value=value.replace(/(^[\s,]*)|([\s,]*$)/g,'').replace(/,[\s]+/g,','+(xui.browser.ver==8?"":" "));
                    }
                    node.style[name]=value;
                    if(name2)node.style[name2]=value;
                    if(name3)node.style[name3]=value;
                    if(name4)node.style[name4]=value;
                }
            }else
                for(var i in name)
                    arguments.callee.call(this,node, i, name[i]);
        },
        _css3prop:'opacity,textShadow,animationName,columnCount,flexWrap,boxDirection,backgroundSize,perspective,boxShadow,borderImage,borderRadius,boxReflect,transform,transition'.split(','),
        css3Support:function(key){
            var self=arguments.callee,
                _c=self._c||(self._c={});

            key=key.replace("$","").replace(/\-(\w)/g, function(a,b){return b.toUpperCase()});

            if(key in _c)return _c[key];

            var n = document.createElement("div"),
                s = n.style,
                rt = false,
                xb = xui.browser,
                f = function(k){
                    k=k.replace(/\-(\w)/g, function(a,b){return b.toUpperCase()});
                    if(s[k]!==undefined)
                        return true;
                    if(xui.browser.cssTag2){
                        k=xui.browser.cssTag2+k.charAt(0).toUpperCase()+k.substr(1);
                        if(s[k]!==undefined)
                            return true;
                    }
                    return false;
                };
            n.id="xui_css3_"+xui.stamp();

            if(key.indexOf("border")===0){
                key=key.replace(/[-]?(left|top|right|bottom)/ig,'');
            }
            switch(key){
                case "opacity":
                case "textShadow":{
                    rt = s[key]==='';
                }break;
                case "generatedContent":{
                    var id="tmp_css3_test"+xui.id(),
                        css='#'+n.id+'{line-height:auto;margin:0;padding:0;border:0;font:0/0 a}#'+n.id+':after{content:\'a\';visibility:hidden;line-height:auto;margin:0;padding:0;border:0;font:3px/1 a}';
                    xui.CSS.addStyleSheet(css,id);
                    xui('body').append(n);
                    var v=n.offsetHeight;
                    xui.CSS.remove("id",id);
                    xui(n.id).remove(n);
                    rt = v>=3;
                }break;
                case "fontFace":{
                    if(xb.ie && xb.ver>=6){
                        rt=true;
                    }else{
                        var id="tmp_css3_test"+xui.id(),
                            css='@font-face{font-family:"font";src:url("https://")}',
                            s=xui.CSS.addStyleSheet(css,id),
                            sh=s.sheet || s.styleSheet,
                            ctxt=sh?((sh.cssRules && sh.cssRules[0])?sh.cssRules[0].cssText:sh.cssText||''):'';

                        rt=/src/i.test(ctxt) && ctxt.indexOf("@font-face") === 0;
                        xui.CSS.remove("id",id);
                    }
                }break;
                case "rgba":{
                    s.cssText = "background-color:rgba(0,0,0,0.1)";
                    rt = s.backgroundColor.indexOf("rgba")!=-1;
                }break;
                case "hsla":{
                    s.cssText = 'background-color:hsla(120,40%,100%,.5)';
                    rt = s.backgroundColor.indexOf('hsla')!=-1 || s.backgroundColor.indexOf('rgba')!=-1;
                }break;
                case "multiplebgs":{
                    s.cssText = "background:url(//:),url(//:),red url(//:)";
                    rt = /(url\s*\(.*?){3}/.test(s.background);
                }break;
                case "gradient":{
                    var k = 'background-image:',
                    v1 = '-webkit-gradient(linear,left top,right bottom,from(#000),to(#fff));',
                    v2 = 'linear-gradient(left top,#000,#fff);',
                    arr=[k,v2];
                    if(xui.browser.cssTag1){
                        arr.push(k);
                        arr.push(xui.browser.cssTag1+v2);
                    }
                    if(xui.browser.isWebKit){
                        arr.push(k);
                        arr.push(v1);
                    }
                    s.cssText = arr.join('');
                    rt = !!s.backgroundImage;
                }break;
                case "transform3d":{
                    var r=f("perspective");
                    if(r && 'webkitPerspective' in document.documentElement.style){
                        var id="tmp_css3_test"+xui.id(),
                            css='@media (transform-3d),(-webkit-transform-3d){#'+n.id+'{font:0/0;line-height:0;margin:0;padding:0;border:0;left:9px;position:absolute;height:3px;}}';
                        xui.CSS.addStyleSheet(css,id);
                        xui('body').append(n);
                        var v1=n.offsetLeft,v2=n.offsetHeight;
                        xui.CSS.remove("id",id);
                        xui(n.id).remove(n);
                        rt = v1===9&&v2===3;
                    }
                    rt = r;
                }break;
                default:{
                    rt = f(key);
                }
            }
            return _c[key]=rt;
        },
        $AnimateEffects:{
            linear:function(s,c) {return (1/s)*c;},
            sineIn:function(s,c) {return -1*Math.cos(c/s*(Math.PI/2))+1;},
            sineOut:function(s,c) {return Math.sin(c/s*(Math.PI/2));},
            sineInOut:function(s,c) {return -1/2*(Math.cos(Math.PI*c/s)-1);},
            quadIn:function(s,c) {return (c/=s)*c;},
            quadOut:function(s,c) {return -1*(c/=s)*(c-2);},
            quadInOut:function(s,c) {if((c/=s/2)<1) {return 1/2*c*c;} return -1/2*((--c)*(c-2)-1);},
            cubicIn:function(s,c) {return (c/=s)*c*c;},
            cubicOut:function(s,c) {return ((c=c/s-1)*c*c+1);},
            cubicInOut:function(s,c) {if((c/=s/2)<1) {return 1/2*c*c*c;} return 1/2*((c-=2)*c*c+2);},
            quartIn:function(s,c) {return (c/=s)*c*c*c;},
            quartOut:function(s,c) {return -1*((c=c/s-1)*c*c*c-1);},
            quartInOut:function(s,c) {if((c/=s/2)<1) {return 1/2*c*c*c*c;} return -1/2*((c-=2)*c*c*c-2);},
            quintIn:function(s,c) {return (c/=s)*c*c*c*c;},
            quintOut:function(s,c) {return ((c=c/s-1)*c*c*c*c+1);},
            quintInOut:function(s,c) {if((c/=s/2)<1) {return 1/2*c*c*c*c*c;} return 1/2*((c-=2)*c*c*c*c+2);},
            expoIn:function(s,c) {return (c==0)?0:Math.pow(2,10*(c/s-1));},
            expoOut:function(s,c) {return (c==s)?1:(-Math.pow(2,-10*c/s)+1);},
            expoInOut:function(s,c) {if(c==0) {return 0;} if(c==s) {return 1;} if((c/=s/2)<1) {return 1/2*Math.pow(2,10*(c-1));} return 1/2*(-Math.pow(2,-10*--c)+2);},
            circIn:function(s,c) {return -1*(Math.sqrt(1-(c/=s)*c)-1);},
            circOut:function(s,c) {return Math.sqrt(1-(c=c/s-1)*c);},
            circInOut:function(s,c) {if((c/=s/2)<1) {return -1/2*(Math.sqrt(1-c*c)-1);} return 1/2*(Math.sqrt(1-(c-=2)*c)+1);},
            bounceIn:function(s,c) {return 1-xui.Dom.$AnimateEffects.bounceOut(s,s-c);},
            bounceOut:function(s,c) {var k=7.5625; if((c/=s)<(1/2.75)) {return (k*c*c);}else if(c<(2/2.75)) {return (k*(c-=(1.5/2.75))*c+.75);}else if(c<(2.5/2.75)) {return (k*(c-=(2.25/2.75))*c+.9375);}else {return (k*(c-=(2.625/2.75))*c+.984375);}},
            bounceInOut:function(s,c) {if(c<s/2) {return xui.Dom.$AnimateEffects.bounceIn(s,c*2)*.5;}else {return xui.Dom.$AnimateEffects.bounceOut(s,c*2-s)*.5+1*.5;}},
            backIn:function(s,c) {var k=1.70158; return (c/=s)*c*((k+1)*c-k);},
            backOut:function(s,c) {var k=1.70158;   return ((c=c/s-1)*c*((k+1)*c+k)+1);},
            backInOut:function(s,c) {var k=1.70158; if((c/=s/2)<1) {return 1/2*(c*c*(((k*=(1.525))+1)*c-k));} return 1/2*((c-=2)*c*(((k*=(1.525))+1)*c+k)+2);},
            elasticIn:function(s,c,p,a,z) {if(c==0) {return 0;} if((c/=s)==1) {return 1;} if(!z) {z=s*.3;} if(!a||a<1) {a=1; var k=z/4;}else {var k=z/(2*Math.PI)*Math.asin(1/a);} return -(a*Math.pow(2,10*(c-=1))*Math.sin((c*s-k)*(2*Math.PI)/z));},
            elasticOut:function(s,c,p,a,z) {if(c==0) {return 0;} if((c/=s)==1) {return 1;} if(!z) {z=s*.3;} if(!a||a<1) {a=1; var k=z/4;}else {var k=z/(2*Math.PI)*Math.asin(1/a);} return (a*Math.pow(2,-10*c)*Math.sin((c*s-k)*(2*Math.PI)/z)+1);},
            elasticInOut:function(s,c,p,a,z) {if(c==0) {return 0;} if((c/=s/2)==2) {return 1;} if(!z) {z=s*(.3*1.5);} if(!a||a<1) {a=1; var k=z/4;}else {var k=z/(2*Math.PI)*Math.asin(1/a);} if(c<1) {return -.5*(a*Math.pow(2,10*(c-=1))*Math.sin((c*s-k)*(2*Math.PI)/z));} return a*Math.pow(2,-10*(c-=1))*Math.sin((c*s-k)*(2*Math.PI)/z)*.5+1;}
        },
        $preDefinedAnims:{
            blinkAlert:{
                endpoints:{opacity:[1,0]}, 
                duration:200, 
                restore: true, 
                times:3
            },
            blinkAlertLoop:{
                endpoints:{opacity:[1,0]}, 
                duration:500, 
                restore: true, 
                times:-1
            },
            rotateAlert:{
                endpoints:{rotate:[0,360]}, 
                duration:400, 
                restore: false
            },
            rotateAlertLoop1:{
                endpoints:{rotate:[0,360]}, 
                duration:2000, 
                restore: false,
                times:-1
            },
            rotateAlertLoop2:{
                endpoints:{rotate:[0,-360]}, 
                duration:2000, 
                returned: false,
                times:-1
            },
            zoomAlert:{
                endpoints:{scaleX:[1,1.1],scaleY:[1,1.1]}, 
                duration:100, 
                restore: true, 
                times:3
            },
            translateXAlert:{
                endpoints:{translateX:[0,5]}, 
                duration:100, 
                restore: true, 
                times:3
            },
            translateYAlert:{
                endpoints:{translateY:[0,5]}, 
                duration:100, 
                restore: true, 
                times:3
            }
        },
        $preDefinedEffects:{
           "Classic":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],scaleX:[.75,1],scaleY:[.75,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],scaleX:[1,.75],scaleY:[1,.75]}}],
           "Blur":[{type:"circOut",duration:200,endpoints: {opacity:[0,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0]}}],
           "Drop":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],translateY:["-25%","0%"],scaleY:[.5,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],translateY:["0%","-25%"],scaleY:[1,.5]}}],
           "From Below":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],scaleX:[0,1],scaleY:[0,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],scaleX:[1,0],scaleY:[1,0]}}],
           "From Above":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],scaleX:[2,1],scaleY:[2,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],scaleX:[1,2],scaleY:[1,2]}}],
           "Slide In LR":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],translateX:["-150%","0%"]/*,scaleX:[.2,1],scaleY:[.2,1]*/}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],translateX:["0%","150%"]/*,scaleX:[1,.2],scaleY:[1,.2]*/}}],
           "Slide In TB":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],translateY:["-150%","0%"]/*,/*scaleX:[.2,1],scaleY:[.2,1]*/}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],translateY:["0%","150%"]/*,scaleX:[1,.2],scaleY:[1,.2]*/}}],
           "Flip V":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],scaleY:[0,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],scaleY:[1,0]}}],
           "Flip H":[{type:"circOut",duration:200,endpoints: {opacity:[0,1],scaleX:[0,1]}}, {type:"circIn",duration:200,endpoints: {opacity:[1,0],scaleX:[1,0]}}]
        },
        _getEffects:function(key,isIn){
                if(key && typeof(key)=="string"){
                    key=this.$preDefinedEffects[key];
                    key=key?isIn?key[0]:key[1]:null;
                }
                if(key &&xui.browser.ie&&xui.browser.ver<=8){
                    xui.filter(key,function(o,i){
                        return !!xui.Dom._cssfake[i];
                    });
                }
                return key;
        },
        _setUnitStyle:function(node, key, value){
            if(node.nodeType != 1)return false;
            var style=node.style;
            if(value || value===0){
                value =xui.CSS.$addu(value);
                if(value && (key=='width'||key=='height') && value.charAt(0)=='-')value='0';
                if(style[key]!=value){
                    style[key]=value;
                    return true;
                }
            }return false;
        },
        _emptyDivId:"xui.empty:",
        getEmptyDiv:function(pid, sequence){
            var i=1,id,rt,style,o,t,count=0,doc=document,
                body = pid && (pid=xui(pid)).get(0) || doc.body,
                ini=function(o){
                o.id=id;
                // position:relative; is for text wrap bug
                xui([o]).attr('style','position:absolute;visibility:hidden;overflow:visible;left:'+xui.Dom.HIDE_VALUE+';top:'+xui.Dom.HIDE_VALUE+';');
            };
            sequence=sequence || 1;
            pid=body==doc.body?'':pid.n0.replace('!','');
            while(1){
                id = this._emptyDivId + pid + ":" + i;
                //don't remove this {
                if(o=xui.Dom.byId(id)){
                    //Using firstChild, for performance
                    if((!o.firstChild||(o.firstChild.nodeType==3&&!o.firstChild.nodeValue)) && ++count == sequence)
                        return xui([o]);
                }else{
                    o=doc.createElement('div');
                    ini(o,id);
                    if(body.firstChild)
                        body.insertBefore(o, body.firstChild);
                    else
                        body.appendChild(o);
                    rt=xui([o]);
                    body=o=null;
                    return rt;
                }
                i++;
            }
            body=o=null;
        },
        setCover:function(visible,label,busyIcon,cursor,bgStyle){
            // get or create first
            var me=arguments.callee,
                id="xui.temp:cover:",
                id2="xui.temp:message:",
                content = (typeof(visible)=='string'||typeof(visible)=='function')?visible:'',
                o1,o2;

            if((o1=xui(id)).isEmpty()){
                xui('body').prepend(o1=xui.create('<button id="'+ id +'" class="xui-node xui-node-div xui-cover xui-cover-global xui-custom" style="position:absolute;display:none;text-align:center;left:0;top:0;border:0;padding:0;margin:0;padding-top:2em;"><div id="'+id2+'" class="xui-node xui-node-div xui-coverlabel xui-custom"></div></button>'));
                o1.setSelectable(false);
                xui.setNodeData(o1.get(0),'zIndexIgnore',1);
            }
            if(xui.Dom.byId(id2)){
                o2=xui(id2);
            }

            //clear the last one
            if(!visible){
                if(typeof me._label =='string' && me._label!==label)
                    return;
                if(me._showed){
                    if(o2)o2.empty(false);
                    o1.css({zIndex:0,cursor:'',display:'none',cursor:''});
                    o1.query('style').remove(false);
                    me._showed=false;
                }
                delete me._label;
            }else{
                if(typeof label=='string')me._label=label;
                var t = xui.win;
                if(!me._showed){
                    o1.css({zIndex:xui.Dom.TOP_ZINDEX*10,display:'',width:t.scrollWidth()+'px',height:t.scrollHeight()+'px',cursor:cursor||'progress'});
                    if(busyIcon)o1.addClass('xuicon xui-icon-loading'); else o1.removeClass('xuicon xui-icon-loading');
                    me._showed=true;
                }

                o1.query('style').remove(false);
                if(bgStyle)
                    xui.CSS._appendSS(o1.get(0), ".xui-cover-global:before{" + bgStyle + "}", "" ,true);

                //show content
                if(content){
                    if(typeof(content)=='function'){
                        content(o1,o2);
                    }else if(o2){
                        o2.html(content +'',false);
                    }
                }
            }
        },

        byId:function(id){
            return  document.getElementById(id||"");
        },
        $hasEventHandler:function(node, name){
            return xui.getNodeData(node,['eHandlers', name]);
        },
        /*
        action: uri
        data:hash{key:value}
        method:'post'(default) or 'get'
        target: uri target: _blank etc.
        */
        submit:function(action, data, method, target, enctype){
            data=xui.isHash(data)?data:{};
            data=xui.clone(data, function(o){return o!==undefined});

            action=action||'';
            target=target||(action.substring(0,6).toLowerCase()=='mailto'?'_self':'_blank');
            var _t=[];
            if(!xui.isEmpty(data)){
                var file,files=[];
                xui.each(data,function(o,i){
                    if(o && o['xui.UIProfile'] && o.$xuiFileCtrl){
                        if(file=o.boxing().getUploadObj()){
                            files.push({id:o.$xid, file:file});
                            file.id=file.name=i;
                            data[i]=file;
                        }
                    }
                });

                method=method||(file?'post':'get');

                if(method.toLowerCase()=='get'){
                    window.open(action + "?" + xui.urlEncode(data),target);
                }else{
                    xui.each(data,function(o,i){
                        if(xui.isDefined(o) && !xui.isElem(o))
                            _t.push('<textarea name="'+i+'">'+(typeof o=='object'?xui.serialize(o):o)+'</textarea>');
                    });
                    _t.push('<input type="hidden" name="rnd" value="'+xui.rand()+'">');
                    _t=xui.str.toDom('<form target="'+target+'" action="'+action+'" method="'+method  + (enctype?'" enctype="' +enctype:'') +  '">'+_t.join('')+'</form>');
                    xui.Dom.getEmptyDiv().append(_t);
                    // 1. add files
                    if(files.length){
                        xui.arr.each(files,function(o,i){
                            _t.append(o.file);
                        });
                    }
                    // 2.submit
                    _t.get(0).submit();
                    _t.remove();
                    _t=null;
                }
                // 3.restore file input
                if(files.length){
                    xui.arr.each(files,function(o,i){
                        if(i=xui.getObject(o.id)){
                            if(i['xui.UIProfile'] && i.boxing() && i.boxing().setUploadObj){
                                i.boxing().setUploadObj(o.file);
                            }
                        }
                    });
                }
            }else{
                window.open(action,target);
            }
        },
        selectFile:function(callback, accept){
            var fileInput=document.createElement( "input" );
            fileInput.type="file";
            // "image/*, video/*, audio/*"
            if(accept)fileInput.accept = accept;

            fileInput.onchange=function(){
                xui.tryF(callback, [this, this.files[0]], this);
            };
            if (!!window.ActiveXObject || "ActiveXObject" in window)  {
              var label=document.createElement( "div" );
              fileInput.appendChild(label);
              label.click();
              fileInput.removeChild(label);
            }else{
              fileInput.click();
            }
            fileInput=null;
        },
        busy:function(id,busyMsg,busyIcon,cursor,bgStyle){
            xui.Dom.setCover(busyMsg||true,id,busyIcon,cursor,bgStyle);
        },
        free:function(id){
           xui.Dom.setCover(false,id);
        },
        animate:function(css, endpoints, onStart, onEnd, duration, step, type, threadid, unit, restore,times){
            var node = document.createElement('div');
            xui.merge(css,{position:'absolute', left:this.HIDE_VALUE, zIndex:this.TOP_ZINDEX++});
            xui.Dom.setStyle(node, css);
            document.body.appendChild(node);
            return xui([node]).animate(endpoints, onStart, function(){
                xui.tryF(onEnd);
                if(node.parentNode)
                    node.parentNode.removeChild(node);
                node=null;
            }, duration, step, type, threadid, unit, restore, times);
        },
        //plugin event function to xui.Dom
        $enableEvents:function(name){
            if(!xui.isArr(name))name=[name];
            var self=this,f;
            xui.arr.each(name,function(o){
                f=function(fun, label, flag){
                    if(typeof fun  == 'function')
                        return this.$addEvent(o, fun, label, flag);
                    else if(fun===null)
                        return this.$removeEvent(o, label, flag);
                    var args = arguments[1] || {};
                    args.$xuiall = (arguments[0]===true);
                    return this.$fireEvent(o, args)
                };
                f.$event$=1;
                self.plugIn(o, f)
            });
        }
    },
    After:function(d){
        var self=this;
       //getter
        xui.each({ parent:['y',false], prev:['x',false], next:['x',true], first:['y',true], last:['y',1]},function(o,i){
            self.plugIn(i, function(index){
                return this.$iterator(o[0], o[1], true, index || 1)
            });
        });

        //readonly profile
        xui.arr.each(xui.toArr('offsetLeft,offsetTop,scrollWidth,scrollHeight'),function(o){
            self.plugIn(o,function(){
                var t=this.get(0),w=window,d=document;
                if(t==w||t==d){
                    if("scrollWidth"==o||"scrollHeight"==o){
                        var a=d.documentElement,b=d.body;
                        return Math.max(a[o], b[o]);
                    }else
                        t = xui.browser.contentBox ? d.documentElement : d.body;
                }
                return t[o];
            })
        });

        var p='padding',m='margin',b='border',c='inner',o='offset',r='outer',w='width',h='height',W='Width',H='Height',T='Top',L='Left',t='top',l='left',R='Right',B='Bottom';
        //dimesion
        xui.arr.each([['_'+p+'H',p+T,p+B],
            ['_'+p+'W',p+L,p+R],
            ['_'+b+'H',b+T+W,b+B+W],
            ['_'+b+'W',b+L+W,b+R+W],
            ['_'+m+'W',m+L,m+R],
            ['_'+m+'H',m+T,m+B]
        ],function(o){
            //use get Style dir
            var node,fun=xui.Dom.getStyle;
            self.plugIn(o[0],function(type){
                type=type||'both';
                node = this.get(0);
                return ((type=='both'||type=='left'||type=='top')?xui.CSS.$px(fun(node, o[1]),node):0) 
                     + ((type=='both'||type=='right'||type=='bottom')?xui.CSS.$px(fun(node, o[2]),node):0) || 0;
            })
        });
        /*
        get W/H for

        1:width
        2:innerWidth
        3:offsetWidth
        4:outerWidth

        content-box
        +--------------------------+
        |margin                    |
        | +----------------------+ |
        | |border                | |
        | | +------------------+ | |
        | | |padding           | | |
        | | | +--------------+ | | |
        | | | |   content    | | | |
        |-|-|-|--------------|-|-|-|
        | | | |<-css width ->| | | |
        | | |<-  innerWidth  ->| | |
        | |<--  offsetWidth   -->| |
        |<--    outerWidth      -->|

        border-box
        +--------------------------+
        |margin                    |
        | +----------------------+ |
        | |border                | |
        | | +------------------+ | |
        | | |padding           | | |
        | | | +--------------+ | | |
        | | | |   content    | | | |
        |-|-|-|--------------|-|-|-|
        | | |<-   css width  ->| | |
        | | |<-  innerWidth  ->| | |
        | |<--  offsetWidth   -->| |
        |<--    outerWidth      -->|
        */

        xui.arr.each([['_W',w, '_'+p+'W', '_'+b+'W', '_'+m+'W', c+W, o+W],
        ['_H',h, '_'+p+'H', '_'+b+'H', '_'+m+'H', c+H, o+H]],function(o){
            var _size=function(node,index,value,_in){
                var n,r,t,style=node.style,contentBox=xui.browser.contentBox,
                r1=/%$/,
                getStyle=xui.Dom.getStyle,
                f=xui.Dom._setUnitStyle,type=typeof value,t1;
                if(type=='undefined' || type=='boolean'){
                    if(value===true){
                        n=(getStyle(node,'display')=='none') || node.offsetHeight===0;
                        if(n){
                            var temp = xui.Dom.getEmptyDiv().html('*',false);
                            xui([node]).swap(temp);
                            var b,p,d;
                            b = style.visibility,p = style.position,d = style.display; p=p||'';b=b||'';d=d||'';
                            style.visibility = 'hidden'; style.position ='absolute';style.display = 'block';
                        }
                    }
                    t=xui([node]);
                    switch(index){
                        case 1:
                            r=getStyle(node,o[1]);
                            if((isNaN(parseFloat(r)) || r1.test(r))&&!_in)
                                r = _size(node,2,undefined,true) - (contentBox?t[o[2]]():0);
                            r=xui.CSS.$px(r,node)||0;
                            break;
                        case 2:
                            r=node[o[6]];
                            //get from css setting before css applied
                            if(!r){
                                if(!_in)r=_size(node,1,undefined,true)+(contentBox?t[o[2]]():0);
                            }else r-=t[o[3]]();
                            break;
                        case 3:
                            r=node[o[6]];
                            //get from css setting before css applied
                            if(!r)r=_size(node,1,value,true)+(contentBox?t[o[2]]():0)+t[o[3]]();
                            break;
                        case 4:
                            r=_size(node,3,value);
                            r+=t[o[4]]();
                            break;
                    }
                    if(n){
                        style.display = d; style.position = p;style.visibility = b;
                        t.swap(temp);
                        temp.empty(false);
                    }
                    return parseFloat(r)||0;
                }else{
                    switch(index){
                        case 1:
                            if(f(node, o[1], value))
                                if(xui.Dom.$hasEventHandler(node,'onsize')){
                                    var args={};args[o[1]]=1;
                                    xui([node]).onSize(true, args);
                                }
                            break;
                        case 2:
                            _size(node, 1, value - (contentBox?xui([node])[o[2]]():0));
                            break;
                        case 3:
                            //back value for offsetHeight/offsetWidth slowly
                            _size(node, 1, value - (t=xui([node]))[o[3]]() - (contentBox?t[o[2]]():0));
                            break;
                        case 4:
                            _size(node, 1, value - (t=xui([node]))[o[4]]() - t[o[3]]() - (contentBox?t[o[2]]():0));
                            break;
                    }
                    //if(node._bp)
                    //    node['_'+o[6]]=null;
                }
            };
            self.plugIn(o[0], _size)
        });
        xui.arr.each([[c+W,'_W',2],[o+W,'_W',3],[r+W,'_W',4],
         [c+H,'_H',2],[o+H,'_H',3],[r+H,'_H',4]],function(o){
            self.plugIn(o[0],function(value){
                var type=typeof value;
                if(type=='undefined' || type=='boolean')
                    return this[o[1]](this.get(0), o[2], value);
                else
                    return this.each(function(v){
                        this[o[1]](v, o[2],value);
                    });
            })
        });
        xui.arr.each([[l+'By',l],[t+'By',t],[w+'By',w],[h+'By',h]],function(o){
            self.plugIn(o[0],function(offset,triggerEvent){
                if(offset===0)return this;
                var m,args,k=o[1];
                return this.each(function(node){
                    m=xui.use(node.$xid)[k]();
                    m=(parseFloat(m)||0)+offset;
                    if(k=='width'||k=='height')m=m>0?m:0;
                    node.style[k]=xui.CSS.$forceu(m,null,node);
                    if(triggerEvent){
                        args={};args[k]=1;
                        var f=xui.Dom.$hasEventHandler;
                        if((k=='left' || k=='top')&& f(node,'onmove'))
                            xui([node]).onMove(true, args);
                        if((k=='width' || k=='height')&& f(node,'onsize')){
                            xui([node]).onSize(true, args);
                        }
                    }
                },this)
            });
        });
        xui.arr.each(['scrollLeft','scrollTop'],function(o){
            self.plugIn(o,function(value){
                var a=document.documentElement,b=document.body;
                if(value !==undefined)
                    return this.each(function(v){
                        if(v===window || v===document){
                            a[o]=b[o]=value;
                        }else
                            v[o]=value;
                    });
                else
                    return (v=this.get(0)) ? (v===window || v===document) ? (window["scrollTop"==o?"pageYOffset":"pageXOffset"] || (a[o]||b[o]||0))
                                                                                                            : v[o]
                                                        : 0;
            })
        });
        xui.arr.each('width,height,left,top'.split(','),function(o){
            self.plugIn(o,function(value){
                var self=this, node=self.get(0),b=xui.browser,type=typeof value,doc=document,t;
                if(!node || node.nodeType==3)return;
                if(type=='undefined'||type=='boolean'){
                    if((o=='width' && (t='Width'))||(o=='height' && (t='Height'))){
                        if(doc===node)return Math.max( doc.body['scroll'+t], doc.body['offset'+t], doc.documentElement['scroll'+t], doc.documentElement['offset'+t]);
                        if(window===node)return b.opr?Math.max(doc.body['client'+t],window['inner'+t]):b.kde?window['inner'+t]:(xui.browser.contentBox && doc.documentElement['client'+t]) ||doc.body['client'+t];
                    }
                    // give shortcut
                    // we force to get px number of width/height 
                    if(o=='width')value=(xui.CSS.$isPx(node.style.width)&&parseFloat(node.style.width))||self._W(node,1,value);
                    else if(o=='height')value=(xui.CSS.$isPx(node.style.height)&&parseFloat(node.style.height))||self._H(node,1,value);
                    else
                        value = xui.Dom.getStyle(node, o, true);
                    return (value=='auto'||value==='')?value:(value||0);
                }else{
                    var f=xui.Dom._setUnitStyle,t,a,
                    av = xui.CSS.$addu(value);
                    return self.each(function(v){
                        if(v.nodeType!=1)return;
                            if(v.style[o]!==av){
                                if(o=='width')self._W(v,1,value);
                                else if(o=='height')self._H(v,1,value);
                                else{
                                    if(f(v, o, value))
                                        if((o=='top' || o=='left') && xui.Dom.$hasEventHandler(node,'onmove')){
                                            a={};a[o]=1;
                                            xui([v]).onMove(true, a);
                                        }
                                }
                            }
                    });
                }
            });
        });

        //xui.Dom event
        xui.arr.each(xui.Event._events,function(o){
            xui.arr.each(xui.Event._getEventName(o),function(o){
                self.$enableEvents(o);
            })
        });
    },
    Initialize:function(){
        var w=window,d=document;
        xui.browser.contentBox = xui(d.documentElement).contentBox();
        xui.set(xui.$cache.domPurgeData,'!window',{$xid:'!window',element:w});
        xui.set(xui.$cache.domPurgeData,'!document',{$xid:'!document',element:d});

        xui.win=xui(['!window'],false);
        xui.doc=xui(['!document'],false);
        xui.busy=xui.Dom.busy;
        xui.free=xui.Dom.free;

        xui.$inlineBlock=xui.browser.gek
            ? xui.browser.ver<3
                ? ['-moz-inline-block', '-moz-inline-box','inline-block']
                : ['inline-block']
            : (xui.browser.ie&&xui.browser.ver<=6)
                ? ['inline-block', 'inline']
                : ['inline-block'];
        var fun=function(p,e,cache,keydown){
             var event=xui.Event,set,hash,rtnf,rst,remove={},
                ks=event.getKey(e);
            if(ks){
                if(ks[0].length==1)ks[0]=ks[0].toLowerCase();
                //if hot function return false, stop bubble
                if(arr = cache[ks.join(":")]){
                    xui.arr.each(arr,function(key,i){
                        set = arr[key];
                        if(set){
                            // remove hook for non-exist dom
                            if(set[3] && (typeof set[3]=='function'?false===(set[3])() : (!xui(set[3]).size()))){
                                // do nothing and detach it
                                delete arr[key];
                                remove[i]=1;
                                return;
                            }
                            rst = xui.tryF(set[0],set[1]||[arr,i,key],set[2]);
                            if(rst===false){
                                rtnf=1;
                                return false;
                            }else if(rst===true){
                                // detach it
                                delete arr[key];
                                remove[i]=1;
                            }
                        }
                    },null,true);
                    // remove
                    xui.filter(arr, function(key,i){
                        return !remove[i];
                    });
                    if(rtnf){
                        event.stopBubble(e);
                        return false;
                    }
                }
                if(xui.Module){
                    xui.arr.each(xui.Module._cache,function(m){
                       // by created order    
                       if(m._evsClsBuildIn && ('onHookKey' in m._evsClsBuildIn)){
                           // function or pseudocode
                           if(xui.isFun(f = m._evsClsBuildIn.onHookKey) || (xui.isArr(f) && f[0].type))
                               m.fireEvent('onHookKey', [m,ks, keydown, e]);
                       }
                       else if(m._evsPClsBuildIn && ('onHookKey' in m._evsPClsBuildIn)){
                           // function or pseudocode
                           if(xui.isFun(f = m._evsPClsBuildIn.onHookKey) || (xui.isArr(f) && f[0].type))
                               m.fireEvent('onHookKey', [m,ks, keydown, e]);
                       }
                    });
                }
            }
            return true;
        };
        //hot keys
        xui.doc.onKeydown(function(p,e){xui.Event.$keyboard=xui.Event.getKey(e); fun(p,e,xui.$cache.hookKey,true)},"document")
        .onKeyup(function(p,e){delete xui.Event.$keyboard; fun(p,e,xui.$cache.hookKeyUp,false)},"document");

        //hook link(<a ...>xxx</a>) click action
        //if(xui.browser.ie || xui.browser.kde)
        xui.doc.onClick(function(p,e,src){
            var o=xui.Event.getSrc(e),
                i=0,b,href;
            do{
                if(o.nodeName == 'A'){
                    b=true;
                    break;
                }
                if(++i>8)break;
            }while(o=o.parentNode)
            if(b){
                href=xui.str.trim(o.href||"").toLowerCase();
                if(xui.History){
                    var s = location.href.split('#')[0];
                    if(!xui.Event.getKey(e).shiftKey && xui.Event.getBtn(e)=='left' && (href.indexOf(s+'#')==0||href.indexOf('#')==0)){
                        xui.History.setFI(o.href.replace(s,''));
                    }
                }
                //**** In IE, click a fake(javascript: or #) href(onclick not return false) will break the current script downloading(SAajx)
                //**** You have to return false here
                if(xui.browser.ie && (href.indexOf('javascript:')==0 || href.indexOf('#')!==-1))return false;
            }
        },'hookA',0);

        if(xui.browser.ie && xui.browser.ver<10 && d.body)
            d.body.onselectstart=function(n,v){
                n=event.srcElement;
                while(n&&n.nodeName&&n.nodeName!="BODY"&&n.nodeName!="HTML"){
                    if(v=xui.getNodeData(n,"_onxuisel"))
                        return v!='false';
                    // check self only
                    if(n.nodeName=="INPUT"||n.nodeName=="TEXTAREA")
                        break;
                    n=n.parentNode;
                }
                return true;
            };
        //free memory
        xui.win.afterUnload(function(){
            w.onresize=null;
            if(w.removeEventListener)
                w.removeEventListener('DOMMouseScroll', xui.Event.$eventhandler3, false);

            d.onmousewheel=w.onmousewheel=null;

            // for simulation mouse event in touable device
            if(xui.browser.isTouch){
                if(d.removeEventListener){
                    d.removeEventListener(
                        (xui.browser.ie&&w.PointerEvent)?"pointerdown":
                        (xui.browser.ie&&w.MSPointerEvent)?"MSPointerDown":
                        "touchstart", xui.Event._simulateMousedown, false);
                    d.removeEventListener(
                        (xui.browser.ie&&xui.browser.ver>=11)?"pointerup":
                        (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerUp":
                        "touchend", xui.Event._simulateMouseup, false);
                }else if(d.detachEvent){
                    d.detachEvent(
                        (xui.browser.ie&&xui.browser.ver>=11)?"pointerdown":
                        (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerDown":
                        "touchstart", xui.Event._simulateMousedown);
                    d.detachEvent(
                        (xui.browser.ie&&xui.browser.ver>=11)?"pointerup":
                        (xui.browser.ie&&xui.browser.ver>=10)?"MSPointerUp":
                        "touchend", xui.Event._simulateMouseup);
                }
            }

            if(xui.browser.ie && d.body)
                d.body.onselectstart=null;

            if("onhashchange" in w)w.onhashchange=null;

            xui('body').empty();
            xui([w, d]).$clearEvent();
            //unlink link 'App'
            xui.SC.__gc();
            xui.Thread.__gc();
            xui.Class.__gc();
            xui.breakO(xui.$cache,2);
            xui.breakO([xui.Class, xui],3);
            w.xui=w.xui_ini=undefined;
        },"window",-1);

    }
});xui.Class('xui.Template','xui.absProfile',{
    Constructor:function(template,properties,events,domId){
        var upper=arguments.callee.upper, args=xui.toArr(arguments);
        upper.apply(this,args);
        upper=null;
        
        var self=this;
        self.$domId = self.KEY + ':' + (self.serialId=self._pickSerialId()) + ':';
        self.domId = typeof domId == 'string'?domId:self.$domId;
        self._links={};
        self.template={'root':[['<div></div>'],[]]};
        self.properties={};
        self.events={};
        self.$template={};
        self.link(self.constructor._cache,'self').link(xui._pool,'xui');
        self.Class=self.constructor;
        self.box=self.constructor;
        self.boxing=function(){return this};

        if(template)self.setTemplate(typeof template=='string'?{'root':template}:template);
        if(events)self.setEvents(events);
        if(properties)self.setProperties(properties);
        return self;
    },
    Instance : {
        renderId:null,
        __gc:function(){
            var self=this,
                t=xui.$cache.reclaimId;
            if(!self.$noReclaim) 
                (t[self.KEY] || (t[self.KEY]=[])).push(self.serialId);
            else 
                delete self.$noReclaim

            delete xui.$cache.profileMap[self.domId];
            delete xui.$cache.profileMap[self.$domId];
            self.unLinkAll();
            xui.breakO([self.properties, self.event, self], 2);
        },
        _reg0:/^\w[\w_-]*$/,
        show:function(parent){
            if(!parent)parent=xui('body');
            parent=xui(parent);
            parent.append(this);
            return this;
        },
        getRootNode:function(){
            return xui.getNodeData(this.renderId, 'element');
        },
        /*
         *getRoot is the only function that depends on xui.Dom Class
        */
        getRoot:function(){
            return xui([this.renderId],false);
        },
        setDomId:function(id){
            var t=this, c=xui.$cache.profileMap, reg=t._reg0;
            //ensure the value
            if(typeof id== 'string' && reg.test(id) && !document.getElementById(id)){
                //delete the original one
                if(t.domId!=t.$domId)delete c[t.domId];
                //set profile's domId
                t.domId=id;
                //change the domNode id value
                if(t.renderId)
                    t.getRootNode().id=id;
                //if doesn't create yet, don't set it to xui.$cache:
                if(c[t.$domId])c[id]=t;
            }
            return t;
        },
        destroy:function(){
            if(this.renderId){
                var rn=this.getRootNode();
                xui.$purgeChildren(rn);
                if(rn.parentNode)
                    rn.parentNode.removeChild(rn);
                rn=null;
            }else this.__gc();          
        },
        setEvents:function(key,value){
            var self=this;
            if(typeof key == 'object')
                self.events=key;
            else
                self.events[key]=value;
            return self;
        },
        setTemplate:function(key,value){
            var self=this, t=self.template,$t=self.$template,h;
            if(typeof key == 'object'){
                self.template=key;
                h={};
                for(var i in key)
                    h[i||'root']=self._buildTemplate(key[i]);
                self.$template=h;
            }else if(typeof value == 'string')
                $t[key]=self._buildTemplate(t[key]=value);
            else
                $t['root']=self._buildTemplate(t['root']=key);
            return self;
        },
        setProperties:function(key,value){
            var self=this;
            if(typeof key == 'object')
                self.properties=key;
            else
                self.properties[key]=value;
            return self;
        },
        getItem:function(src){
            var obj=xui.getNodeData(src);
            if(!obj)return;

            var id=obj.tpl_evid, tpl_evkey=obj.tpl_evkey;
            if(!id || !tpl_evkey)return;

            var me=arguments.callee,
                f = me.f || (me.f = function(data, tpl_evkey, id){
                    var i,o,j,v;
                    for(j in data){
                        o=data[j];
                        if(xui.isArr(o) && (tpl_evkey==j||tpl_evkey.indexOf((data.tpl_evkey||j)+'.')===0))
                            for(i=0;v=o[i];i++){
                                if(v.tpl_evkey==tpl_evkey&&v.id==id)return v;
                                else if(v=f(v,tpl_evkey,id)) return v;
                            }
                    }
                });
            return f(this.properties, tpl_evkey, id);
        } ,
        _pickSerialId:function(){
            //get id from cache or id
            var arr = xui.$cache.reclaimId[this.KEY];
            if(arr && arr[0])return arr.shift();
            return this.constructor._ctrlId.next();
        },
        render:function(){
            var self=this;
            if(!self.renderId){
                var div=xui.$getGhostDiv();
                xui.$cache.profileMap[self.domId]=xui.$cache.profileMap[self.$domId]=this;
                div.innerHTML = self.toHtml();
                //add event handler
                var ch=self.events,
                    eh=xui.Event._eventHandler,
                    children=div.getElementsByTagName('*'),
                    domId=self.$domId,
                    f=function(){return xui.Event(arguments[0],this,0,domId)},
                    i,l,j,k,o,key,id,t,v;
                if(l=children.length){
                    for(i=0;i<l;i++){
                        if((o=children[i]).nodeType!=1)continue;
                        key=o.getAttribute('tpl_evkey');
                        id=o.getAttribute('tpl_evid');
                        if(key!==null && id!==null){
                            v=xui.$registerNode(o);
                            v.tpl_evkey=key;
                            v.tpl_evid=id;
                            if(t = ch[key] ){
                                v=v.eHandlers||(v.eHandlers={});
                                for(j in t){
                                    //attach event handler to domPurgeData
                                    v[j]=f;
                                    //attach event handler to dom node
                                    if(k=eh[j])
                                        v[k]=o[k]=f;
                                }
                            }
                            o.removeAttribute('tpl_evkey');
                            o.removeAttribute('tpl_evid');
                        }
                    }
                    if(!div.firstChild.$xid)
                        xui.$registerNode(div.firstChild);
                    //the first
                    self.renderId=div.firstChild.$xid;
                }
                o=div=null;
            }
            return self;
        },
        refresh:function(){
            var ns=this;
            if(ns.renderId){
                var proxy = document.createElement('span'), 
                    rn = ns.getRootNode(),
                    cache=xui.$cache.profileMap;
                
                //avoid of being destroyed                
                delete cache[ns.domId];
                delete cache[ns.$domId];
                
                if(rn.parentNode)
                    rn.parentNode.replaceChild(proxy,rn);
                ns.destroy();
                
                delete ns.renderId;

                ns.render();

                if(proxy.parentNode)
                    proxy.parentNode.replaceChild(ns.getRootNode(), proxy);

                proxy=rn=null;
            }
            return ns;
        },
        renderOnto:function(node){
            var self=this,id,domNode,style='style',t;
            if(typeof node=='string')node=document.getElementById(node);
            id=node.id||self.domId;
            
            //ensure renderId
            if(!self.renderId)
                self.render();
            
            domNode=self.getRootNode();
            node.parentNode.replaceChild(domNode,node);

            if(domNode.tabIndex!=node.tabIndex)
                domNode.tabIndex!=node.tabIndex;
            if(node.className)
                domNode.className += node.className;
            if(xui.browser.ie && (t=node.style.cssText))
                domNode.style.cssText += t+'';
            else if(t=node.getAttribute(style))
                domNode.setAttribute(style, (domNode.getAttribute(style)||'') + t);

            this.setDomId(id);
        },
        toHtml:function(properties){
            //must copy it for giving a default tpl_evkey
            var p=xui.copy(properties||this.properties||{});
            p.tpl_evkey="root";
            return this._doTemplate(p);
        },
        _reg1:/([^{}]*)\{([\w]+)\}([^{}]*)/g,
        _reg2:/\[event\]/g,
        _buildTemplate:function(str){
            if(typeof str=='string'){
                var obj=[[],[]],
                    a0=obj[0],
                    a1=obj[1];
                str=str.replace(this._reg2,' tpl_evid="{id}" tpl_evkey="{tpl_evkey}" ');
                str.replace(this._reg1,function(a,b,c,d){
                    if(b)a0[a0.length]=b;
                    a1[a0.length]=a0[a0.length]=c;
                    if(d)a0[a0.length]=d;
                    return '';
                });
                return obj;
            }else
                return str;
        },
        _getEV:function(funs, id, name, xid){
            var obj=xui.getNodeData(xid);
            if(!obj)return;

            var evs = this.events,
                tpl_evkey = obj.tpl_evkey,
                evg = (tpl_evkey&&evs&&evs[tpl_evkey])||evs,
                ev = evg&&evg[name];
            if(ev)funs.push(ev);
        },
        _reg3:/(^\s*<\w+)(\s|>)(.*)/,
        _doTemplate:function(properties, tag, result){
            if(!properties)return '';

            var self=this, me=arguments.callee,s,t,n,isA = xui.isArr(properties),
            template = self.$template,
            temp = template[tag||'root'],
            r = !result;

            result= result || [];
            if(isA){
                if(typeof temp != 'function')temp = me;
                for(var i=0;t=properties[i++];){
                    t.tpl_evkey=tag;
                    temp.call(self, t, tag, result);
                }
            }else{
                if(typeof temp == 'function')
                    temp.call(self, properties, tag, result);
                else{
                    tag = tag?tag+'.':'';
                    var a0=temp[0], a1=temp[1];
                    for(var i=0,l=a0.length;i<l;i++){
                        if(n=a1[i]){
                            if(n in properties){
                                t=typeof properties[n]=='function'?properties[n].call(self, n, properties):properties[n];
                                //if sub template exists
                                if(template[s=tag+n])
                                    me.call(self, t, s, result);
                                else
                                    result[result.length]=t;
                            }
                        }else
                            result[result.length]=a0[i];
                    }
                }
            }
            if(r){
                return result.join('')
                    .replace(self._reg3, '$1 id="'+self.$domId+'" $2$3');
            }
        },
        serialize:function(){
            var self=this,
                s=xui.serialize,
                t=xui.absObj.$specialChars,
                properties = xui.isEmpty(self.properties)?null:xui.clone(self.properties,function(o,i){return !t[(i+'').charAt(0)]});            
            return 'new xui.Template(' + 
            s(self.template||null) + "," + 
            s(properties) + "," + 
            s(xui.isEmpty(self.events)?null:self.events) + "," + 
            s(self.$domId!=self.domId?self.domId:null) + 
            ')';
        }
    },
    Static : {
        getFromDom:function(id){
            if((id=typeof id=='string'?id:(id && id.id)) &&(id=xui.$cache.profileMap[id]) && id['xui.Template'])
                return id.boxing();
        },
        _cache:[],
        _ctrlId : new xui.id()
    }
});/*
        initialize
    beforeCreated
    onCreated
    beforeShow
    afterShow
    onLoadBaseClass
    onLoadRequiredClass
    onLoadRequiredClassErr
    onIniResource
        iniResource (asy)
    beforeIniComponents
        iniComponents (asy)
    afterIniComponents
        iniExModules (asy)
    onReady
    onRender
    onDestroy

    onModulePropChange

    // for values
    getValue:function(){},
    getUIValue:function(){},
    resetValue:function(){},
    setUIValue:function(){},
    updateValue:function(){},
    isDirtied:function(){},
    checkValid:function(){},
*/
xui.Class('xui.Module','xui.absProfile',{
    Initialize:function(){
        var ns=this;
        xui.launch = function(cls, onEnd, lang, theme, showUI, parent, subId, onCreated){
            ns.load.apply(ns, arguments);
        };
        // compitable
        ns['xui.Com']=ns.prototype['xui.Com']=1;
        xui.Com=ns;
        ns.$activeClass$='xui.Module';
    },
    After:function(){
        var self=this,k, e, t, b, i;
        xui.arr.each(['$DataModel','$EventHandlers'],function(v){
            k=self[v]||{};
            if((t=self.$parent) && (e=t.length)){
                while(e--){
                    b=t[e][v];
                    for(i in b){
                        if(!(i in k))k[i]=b[i];
                    }
                }
            }
            self[v]=k;
        });
        e = self.prototype;
        if('_evsClsBuildIn' in e){
            b = e._evsClsBuildIn;
            // for parents defination
            t = e._evsPClsBuildIn || (e._evsPClsBuildIn={});
            for(i in b){
                if(t[i]){
                    if(!xui.isArr(t[i]))t[i]=[t[i]];
                    xui.arr.insertAny(t[i],b[i]);
                }else t[i]=xui.clone(b[i]);
            }
            e._evsClsBuildIn=null;
        }
        if('events' in e){
            // for class defination
            e._evsClsBuildIn=e.events;
            // events for instance
            e.events={};
        }
        self._nameId=0;
        self._nameTag=self.$nameTag||(self.KEY.replace(/\./g,'_').toLowerCase());
        self._cache=[];
    },
    Constructor:function(properties, events, host){
        var self=this,opt,alias;

        // If it's a older moudle object, set xid first
		if(properties && properties.constructor==self.constructor){
			if(properties.$xid){
				self.$xid = properties.$xid;
			}
		}

        var upper=arguments.callee.upper;
        if(upper)upper.call(self);
        upper=null;

        // If it's a older moudle object, refresh itself
        if(properties && properties.constructor==self.constructor){
        	 var oldm = properties; 
             
             events = oldm.events || {};
             alias = oldm.alias;
             host = oldm.host;
             properties = oldm.properties || {};
             // for refresh , use the old pointer
             self=oldm;
        }else{
        	if(properties && properties.key && properties["xui.Module"]){
	             var opt=properties;
	             properties = (opt && opt.properties) || {};
	             events = (opt && opt.events) || {};
	             alias = opt.alias;
	             host = opt.host;
	        }else{
	            properties = properties || (self.properties?xui.clone(self.properties):{});
	            events = events || (self.events?xui.clone(self.events):{});
	        }
	    }
        

        self.Class=self.constructor;
        self.box=self.constructor;
        self.key=self.KEY;

        if(!alias)alias =self.constructor.pickAlias();
        if(!xui.isEmpty(self.constructor.$DataModel)){
            xui.merge( properties, xui.clone(self.constructor.$DataModel),'without');
        }
        //
        self._links={};
        self.link(self.constructor._cache, "self");
        self.link(xui.Module._cache, "xui.module");
        self.link(xui._pool,'xui');
        
        self.host=host||self;
        self.alias=alias;
        
        self.$UIvalue="";

        self._nodes=[];
        self._ctrlpool={};
        self.events=events;
        self.properties={};
        self.hooks={};
        if(self._evsClsBuildIn) self._evsClsBuildIn = xui.clone(self._evsClsBuildIn);
        if(self._evsPClsBuildIn) self._evsPClsBuildIn = xui.clone(self._evsPClsBuildIn);

        self.setProperties(properties, null, true);

        self._innerCall('initialize');

        return self;
    },
    Instance:{
        autoDestroy:true,
        background:"",

        // [[[ fake boxing
        get:function(index){
            return  xui.isNumb(index)?this:[this];
        },
        size:function(){
            return 1;
        },
        boxing:function(){
            return this;
        },
        each:function(fun,scope){
            fun.call(scope, this);
            return this;
        },
        getRoot:function(rtnPrf){
            if(!this._innerModulesCreated)this._createInnerModules();
            var fun = function(m){
                if(m["xui.Module"]){
                    for(var i=0,l=m._nodes,o;i<l, o=m._nodes[i];i++){
                        if(o["xui.Module"]) return fun(o);
                        if(o["xui.UIProfile"] && !o.box.$initRootHidden) return rtnPrf?o:o.getRoot();
                    }
                }
            };
            return fun(this);
        },
        getRootNode:function(){
            var ui=this.getRoot();
            if(!ui.isEmpty())return ui.get(0);
        },
        getModule:function(top){
        	var getUpperModule=function(module){
                // if it's a inner module
                if(module.moduleClass && module.moduleXid){
                    var pm = xui.SC.get(module.moduleClass);
                    if(pm && (pm = pm.getInstance(module.moduleXid))){
                        return getUpperModule(pm);    
                    }         
                }
                return module;
            };
            return top?getUpperModule(this):this;
        },
        // ]]] 
        /*
         // [[[ fake UIProfile
        linkParent:function(parentProfile, linkId, index){
            var profile=this;
            //unlink first
            profile.unlinkParent();
            if(!profile.destroyed){ 
            //link
                profile.parent = parentProfile;
                profile.childrenId = linkId;
                profile.link(parentProfile.children, '$parent', [profile, linkId], index);
            }
            return profile;
        },
        unlinkParent:function(){
            var profile=this;
            delete profile.parent;
            delete profile.childrenId;
            profile.unLink('$parent');
            return profile;
        },
        // ]]] 
        */
        _toDomElems:function(){
            var ns=this, innerUI=ns.getUIComponents();
            if(!ns.created)
                // create synchronously
                ns.create(null,false)
            ns.render();

            // force to create and render the first layer inner modules
            innerUI.each(function(o,i){
            	if((o=o.getModule()) && o!=ns){
            		o._toDomElems();
            	}
            });

            return innerUI._toDomElems();
        },
        setAlias:function(alias){
            return xui.absObj.prototype._setHostAlias.call(this, null, alias);
        },
        getAlias:function(){
            return this.alias;
        },
        setHost:function(host, alias){
            return xui.absObj.prototype._setHostAlias.call(this, host, alias);
        },
        getName:function(){
            return this.properties.name || this.alias;
        },
        setName:function(name){
            this.properties.name=name;
        },
        getDesc:function(){
            return this.properties.desc;
        },
        setDesc:function(desc){
            this.properties.desc=desc;
        },
        getTabindex:function(){
            return this.properties.tabindex;
        },
        setTabindex:function(tabindex){
            this.properties.tabindex=tabindex;
        },
        getHost:function(){
            return this.host;
        },
        setFunctions:function(key,value){
            var self=this;

            if(!key)
                delete self.functions;
            else if(typeof key=='string')
                self.functions[key]=value;
            else if(xui.isHash(key)){
                if(value/*force*/){
                    self.functions = xui.clone(key);
                }else{
                    xui.merge(self.functions, key, 'all');
                }
            }
        },
        getFunctions:function(key){
            var fs=this.functions;
            if(fs && xui.isHash(fs)){
                return key?fs[key]:fs;
            }
        },
        setProperties:function(key,value,ignoreEvent,innerDataOnly){
            var self=this;

            if(!key)
                self.properties={};
            else if(typeof key=='string')
                self.properties[key]=value;
            else if(xui.isHash(key)){
                if(value/*force*/){
                    self.properties = xui.clone(key);
                }else{
                    xui.merge(self.properties, key, 'all');
                }
            }

            if(self.propSetAction)self.propSetAction(self.properties);
            if(!ignoreEvent){
                if(!innerDataOnly){
                    var oDataBinder;
                    if('dataBinder' in self.properties){
                        oDataBinder = self.properties.dataBinder;
                    }
                    if('dataBinder' in self.properties){
                        if(oDataBinder!==self.properties.dataBinder){
                            if(oDataBinder)xui.DataBinder._unBind(oDataBinder, self);
                            if(self.properties.dataBinder)xui.DataBinder._bind(self.properties.dataBinder, self);
                        }
                    }
                }

                if(self._innerModulesCreated && ('__inner_coms_prf__' in self.properties))
                    self.setProfile(self.properties.__inner_coms_prf__);
            
                // the last one
                if(!innerDataOnly){
                    self._fireEvent('onModulePropChange');
                }
            }
            return self;
        },
        getProperties:function(key){
             var self=this;
             if(self._getProperties)self.properties=self._getProperties();

            return key?self.properties[key]:self.properties;
        },
        setEvents:function(key,value){
            var self=this;
            if(!key)
                self.events={};
            else if(typeof key=='string')
                self.events[key]=value;
            else if(xui.isHash(key)){
                if(value/*force*/){
                    self.events = xui.clone(key);            
                }else{
                    xui.merge(self.events, key, 'all');
                }
            }
            return self;
        },
        getEvents:function(key){
            return key?this.events[key]:this.events;
        },
        setHooks:function(key,value){
            var self=this;
            if(!key)
                self.hooks={};
            else if(typeof key=='string')
                self.hooks[key]=value;
            else if(xui.isHash(key)){
                if(value/*force*/){
                    self.hooks = xui.clone(key);            
                }else{
                    xui.merge(self.hooks, key, 'all');
                }
            }
            return self;
        },
        getHooks:function(key){
            return key?this.hooks[key]:this.hooks;
        },
        notifyHooks:function(key, msg1, msg2, msg3, msg4, msg5){
            var ns=this, hook, hooks=ns.hooks;
            if(key  && hooks  && (hook=hooks[key]) && xui.isFun(hook)){
                xui.tryF(hook, xui.toArr(arguments).slice(1), ns);
            }
            return ns;
        },
        postMessage:function(msg1, msg2, msg3, msg4, msg5, sender){
           this.fireEvent('onMessage',  [this, msg1, msg2, msg3, msg4, msg5, sender]);
        },
        serialize:function(rtnString, keepHost, children){
            var t,m,
                self=this,
                o=(t=self.constructor._beforeSerialized)?t(self):self,
                r={
                    "xui.Module":true,
                    alias:o.alias,
                    key:o.KEY,
                    host:o.host
                };
            //host
            if(r.host===self){
                delete r.host;
            }else if(o.host && !keepHost ){
                if(rtnString!==false)
                    r.host='@this';
                else
                    delete r.host;
            }
            //properties
            var c={}, p=o.box.$DataModel;
            xui.merge(c,o.properties, function(o,i){return p[i]!==o});
            if(!xui.isEmpty(c))r.properties=c;
            if(xui.isEmpty(r.properties))delete r.properties;

            //functions
            if(!xui.isEmpty(o.functions))r.functions=c;
            if(xui.isEmpty(r.functions))delete r.functions;

            //events
            if(!xui.isEmpty(t=this.getEvents()))r.events=t;
            var eh = o.box.$EventHandlers;
            xui.filter(r.events, function(o,i){
                return o!==eh[i];
            });

            //events
            if(!xui.isEmpty(t=this.getEvents()))r.events=t;
            if(xui.isEmpty(r.events))delete r.events;

            return rtnString===false?r:xui.serialize(r);
        },
        clone:function(){
            var ns=this.serialize(false,true);
            delete ns.alias;
            return this.constructor.unserialize(ns);
        },
        // for outter events
        fireEvent:function(name, args, host){
            var self = this;
            if(self.$inDesign)return;

            var r, tp = self._evsPClsBuildIn && self._evsPClsBuildIn[name],
                ti = self._evsClsBuildIn && self._evsClsBuildIn[name],
                tt = self.events && self.events[name],
                applyEvents=function(prf, events, host, args){
                    var j;
                    args=args||[];
 
                    if(xui.isStr(events)||xui.isFun(events))events=[events];
                    if(xui.isNumb(j=(events.actions||events)[0].event)  && xui.isObj(args[j]))args[j]=xui.Event.getEventPara(args[j]);
                    return xui.pseudocode._callFunctions(events, args, host,null,prf.$holder,((host&&host.alias)||(prf.$holder&&prf.$holder.alias)) + "."+ prf.alias + "."+ name);
                };
            self.$lastEvent=name;
            if(tp && (!xui.isArr(tp) || tp.length))r = applyEvents(self, tp, self, args);
            if(ti && (!xui.isArr(ti) || ti.length))r = applyEvents(self, ti, self, args);
            // only events can use host
            if(tt && (!xui.isArr(tt) || tt.length))r = applyEvents(self, tt,  host||self.host||self, args);
            return r;
        },
        // for inner events
        _fireEvent:function(name, args){
            var self = this;
            args=args||[];
            args.splice(0,0,self,self.threadid);
            return this.fireEvent(name, args);
        },
        _innerCall:function(name){
            var self=this;
            return xui.tryF(self[name],[self, self.threadid],self);
        },
        customAppend:function(parent,subId,left,top,threadid){
            return false;
        },
        popUp:function(pos, type, parent, trigger, group){
            var module=this,
                f=function(){module.getUIComponents(true).popUp(pos, type, parent, trigger, group);};
            if(self.created)f()
            else this.show(f);
        },
        show:function(onEnd,parent,subId,threadid,left,top){
            if(false===this._fireEvent('beforeShow'))return false;
            parent=parent||xui('body');
            
            if(parent['xui.UIProfile'])parent=parent.boxing();

            var self=this,f=function(){
                var style=self.customStyle;
                if(style && !xui.isEmpty(style)){
                    var arr=[];
                    xui.each(style,function(v,k){
                        arr.push(k+" : "+v+";");
                    });
                    var txt=".xui-module-"+self.$xid+"{\r\n"+arr.join("\r\n")+"\r\n}";
                    xui.CSS.addStyleSheet(txt,"xui:css:module-"+self.$xid,1);
                }
                // no UI control in module
                if(self.getUIComponents().isEmpty()){
                    xui.tryF(self.customAppend,[parent,subId,left,top,threadid], self);
                    xui.tryF(onEnd,[null, self, threadid],self.host);
                }else{
                    // if parent is an ui object without rendered, dont render the module
                    if(!(parent && parent['xui.UI']  && !parent.get(0).renderId))
                        self.render();

                    if(false===xui.tryF(self.customAppend,[parent,subId,left,top,threadid], self)){
                        //append only
                        parent.append(self.getUIComponents(false),subId);
                        // append and show
                        self.getUIComponents(true).each(function(o){
                            o.boxing().show(parent, subId);
                            if(o.KEY=='xui.UIProfile' && xui.get(o,['properties','defaultFocus'])){
                               try{xui.asyRun(function(){o.boxing().activate()})}catch(e){}
                            }
                        });
                    }
                    self.renderId='ok';
                    xui.tryF(onEnd,[null, self, threadid],self.host);
                }
                self._showed=1;
                self._fireEvent('afterShow');
            };
            
            self.threadid=threadid;
            if(self.created) f();
            else self.create(f,threadid);
            return self;
        },
        hide:function(){
            this.getUIComponents(true).hide();
            this._showed=0;
        },
        render:function(triggerLayout){
            var self=this;
            if(self.renderId!='ok'){
                self.renderId='ok';
                self.getUIComponents().render(triggerLayout);
                self._fireEvent('onRender');
            }
            return self;
        },
        refresh:function(callback,ignoreEffects, purgeNow){
            var paras, b, p, s, fun, 
                o=this,
                inm, firstUI,
                // for builder project module updating
                box=o.box,
                host=o.host,
                alias=o.alias,
                $xid=o.$xid,
                rt = o.$refreshTrigger,
                mcls = o.moduleClass,
                mxid = o.moduleXid;

            if(!o.renderId)return;
            if((inm=o.getUIComponents()).isEmpty())return;
            firstUI = inm.get(0);

            if(host && host['xui.Module']){
                host.$ignoreAutoDestroy=true;
            }
            //keep parent
            if(b=!!firstUI.parent){
                p=firstUI.parent.boxing();
                childId=firstUI.childrenId;
            }else{
                p=firstUI.getParent();
            }

            //unserialize
            s = o.serialize(false, true);
            o.destroy(true, true, true);
            //set back
            xui.merge(o,s,'all');
            // notice: remove destroyed here
            delete o.destroyed;
            o.$xid=$xid;
            //create, must keep the original refrence pointer
            new box(o);
            if(host)o.setHost(host,alias);

            // must here
            o.moduleClass=mcls;
            o.moduleXid=mxid;

            o.create(function(){
            	var f=function(t,m){
                    if(callback)xui.tryF(callback);
            	};
                //for functions like: UI refresh itself
                if(rt)rt.call(rt.target, o);
                //add to parent, and trigger RenderTrigger
                if(b)o.show(f,p,childId);
                else if(!p.isEmpty())o.show(f,p);
            });

            if(o.host&&o.host['xui.Module']){
                delete o.host.$ignoreAutoDestroy;
            }
            return this;
        },
        getParent:function(){
            var prf=this.getUIComponents().get(0);
            if(prf)return prf.parent && prf.parent.boxing();
        },
        getChildrenId:function(){
            var prf=this.getUIComponents().get(0);
            if(prf)return prf.childrenId;
        },
        create:function(onEnd, threadid){
            //get paras
            var self=this;

            if(self.created){
                xui.tryF(onEnd,[null, self, threadid],self.host);
                return;
            }

            var  t,funs=[];
            self.threadid=threadid;

            if(false===self._fireEvent('beforeCreated'))return;
            //if no threadid or threadid doesn't exist, reset threadid to self
            funs.push(function(threadid){
                if(threadid)
                    self.threadid=threadid;
                self._fireEvent('onCreated');
            });

            //base classes
            if((t=self.Dependencies) && t.length)
                funs.push(function(threadid){
                    xui.require(self.Dependencies,null,function(uri,key){
                        self._fireEvent('onLoadBaseClass', [uri,key]);
                    },function(){
                        self._fireEvent('onLoadBaseClassErr', xui.toArr(arguments));
                    },function(){
                        self._fireEvent('onLoadBaseClassErr',  xui.toArr(arguments));
                    },false, threadid);
                });
            if(self.iniComponents){
                var arr=[];
                try{
                    (self.iniComponents+"").replace(/append\s*\(\s*xui.create\(['"]([\w.]+)['"]\)/g,function(a,b){
                        if(!xui.SC.get(b))arr.push(b);
                    });
                }catch(e){}
                if(arr.length){
                    if(self.Required&&xui.isArr(self.Required)){
                        self.Required=self.Required.concat(arr);
                    }else{
                        self.Required=arr;
                    }
                }
            }
            //load required class
            if((t=self.Required) && t.length)
                funs.push(function(threadid){
                    xui.require(self.Required,null,function(uri,key){
                        self._fireEvent('onLoadRequiredClass', [uri,key]);
                    },function(){
                        self._fireEvent('onLoadRequiredClassErr',  xui.toArr(arguments));
                    },function(msg){
                        self._fireEvent('onLoadRequiredClassErr',  xui.toArr(arguments));
                    },false, threadid);
                });
            //inner components
            if(self.iniComponents)
                funs.push(function(){
                    self._createInnerModules();
                });
            //load resource here
            if(self.iniResource)
                funs.push(function(){
                    self._fireEvent('onIniResource');
                    self._innerCall('iniResource');
                });
            //Outter components
            if(self.iniExComs){
                self.iniExModules=self.iniExComs;
                delete self.iniExComs;
            }
            if(self.iniExModules)
                funs.push(function(){
                    self._innerCall('iniExModules');
                });
            //core
            funs.push(function(threadid){
                //lazy load
                if(self.background)
                    xui.SC.runInBG(self.background);
                self._fireEvent('onReady');
            });
            funs.push(function(threadid){
                self.created=true;
                xui.tryF(onEnd,[null, self, threadid],self.host);
            });
            if(threadid===false){
                xui.arr.each(funs,function(fun){
                    fun.call();
                });
            }else{
                //use asyUI to insert tasks
                xui.Thread.observableRun(funs,null,threadid);
            }

            return self;
        },
        _createInnerModules:function(){
            var self=this;
            if(self._recursived || self._innerModulesCreated)
                return;            
            var stop, checkCycle=function(h){
                if(h && h["xui.Module"] && h.moduleClass && h.moduleXid){
                    if(self.KEY == h.moduleClass){
                        if(self.$xid != h.moduleXid){
                            self._recursived = h._recursived = true;
                            h.destroy();
                            self.destroy();
                            stop=1;
                        }else{
                            // self is ok
                            return;
                        }
                    }else{
                        checkCycle(h.host);
                    }
                }
            };
            checkCycle(self.host);
            if(stop){
                alert("There's a [" + self.KEY + "] in another [" + self.KEY+"], check this recursive call please!");
                return;
            }


            if(false===self._fireEvent('beforeIniComponents'))return;
            Array.prototype.push.apply(self._nodes, self._innerCall('iniComponents')||[]);

            xui.arr.each(self._nodes,function(o){
                xui.Module.$attachModuleInfo(self,o);
                //Recursive call
                if(o['xui.Module'])o._createInnerModules();
            });
            // attach destroy to the first UI control
            var autoDestroy = self.autoDestroy || self.properties.autoDestroy;
            if(autoDestroy)
                xui.arr.each(self._nodes,function(o){
                    if(o.box && o.box["xui.UI"] && !o.box["xui.UI.MoudluePlaceHolder"] && !o.box.$initRootHidden){
                        (o.$afterDestroy=(o.$afterDestroy||{}))["moduleDestroyTrigger"]=function(ignoreEffects, purgeNow){
                            if(autoDestroy && !self.destroyed && !self.$ignoreAutoDestroy)
                                self.destroy(ignoreEffects, purgeNow);
                            self=null;
                        };
                        return false;
                    }
                });
            self._fireEvent('afterIniComponents');
            
            self._innerModulesCreated=true;
            // must be here
            self.setProperties({});
        },
        iniComponents:function(){},

        // calculate the profileTo's formula, and apply to it
        applyExcelFormula:function(profileTo){
            var ns=this,
                xformula = xui.ExcelFormula,
                formula = profileTo && profileTo.properties.excelCellFormula,
                colMax,rowMax,
                cellsMap={},
                cell2alias = {}, alias2cell={};
            if(formula){
                xui.each(this._ctrlpool, function(prf){
                    var p = prf.properties,t;
                    if((t=p.excelCellId) && /^\s*[a-zA-Z]+[\d]+\s*$/.test(t)){
                        cell2alias[t]=prf.alias;
                        alias2cell[prf.alias]=t;
                        t = xformula.toCoordinate(t,0);
                        colMax=Math.max(colMax, t[0]);
                        rowMax=Math.max(rowMax, t[1]);
                    }
                });
                var refs = xformula.getRefCells(formula,colMax,rowMax)
                if(!refs)return ;
                xui.each(cell2alias,function(o, i){
                    if( i in refs){
                        if(!(i in cellsMap)){
                            cellsMap[i] = ns[o].getExcelCellValue();
                        }
                    }
                });
                profileTo.boxing()._applyExcelFormula(cellsMap);
            }
            return ns;
        },
        // calculate all profiles' (or profileFrom's)  formula, and apply to them(it)
        triggerExcelFormulas:function(profileFrom){
            var ns=this,
                formulaCells = {}, cell2alias = {}, alias2cell={},
                xformula = xui.ExcelFormula,
                rowMax = 0, colMax = 0,
                cellId = profileFrom && profileFrom.alias;
            //1. collection all formula cells
            xui.each(this._ctrlpool, function(prf){
                var p = prf.properties,t;
                if(t=p.excelCellFormula){
                    formulaCells[prf.alias]=[prf,t];
                }
                if((t=p.excelCellId) && /^\s*[a-zA-Z]+[\d]+\s*$/.test(t)){
                    t.replace(/\s/g,'');
                    cell2alias[t]=prf.alias;
                    alias2cell[prf.alias]=t;
                    t = xformula.toCoordinate(t,0);
                    colMax=Math.max(colMax, t.col);
                    rowMax=Math.max(rowMax, t.row);
                }
            });
            // if input cell, must remove itself;
            if(cellId)delete formulaCells[cellId];
            if(xui.isEmpty(formulaCells))return;

            //2. collect refs for formulaCells
            var refs={};
            xui.each(formulaCells,function(a, alias,hash,hash1){
                 if(hash = xformula.getRefCells(a[1],colMax,rowMax)){
                     hash1={};
                     xui.each(hash,function(o,i){
                         hash1[cell2alias[i]] = o;
                     });
                     refs[alias]=hash1;
                 }
            });
            //3. loop to calculate non-ref cells
            var count, noFormulaRef, cellsMap={}, coo,
                changed={}, needRec;
            if(cellId){
                changed[cellId]=1;
            }
            do{
                count=0;
                xui.filter(refs,function(v,alias){
                    needRec=0;
                    if(!cellId)needRec=1;
                    else{
                        for(var i in v){
                            if(i in changed){
                                needRec=1;
                                break;
                            }
                        }
                    }
                    // no need to re-calculate
                    if(!needRec){
                        return false;
                    }

                    noFormulaRef=true;
                     for(var i in v){
                        if(!cellId && (i in formulaCells)){
                            noFormulaRef=false;
                        }else{
                            if(!(alias2cell[i] in cellsMap)){
                                cellsMap[alias2cell[i]] = ns[i].getExcelCellValue();
                            }
                        }
                     }
                     if(noFormulaRef){
                        // update value
                        ns[alias]._applyExcelFormula(cellsMap);
                        if(cellId)changed[alias]=1;
                        // remove from formulaCells
                        delete formulaCells[alias];
                        count++;
                        return false;
                     }
                });
            }
            // Avoid circular references
            while(!xui.isEmpty(formulaCells) && count>0);
            return ns;
        },

        getProfile:function(){
            if(!this._innerModulesCreated)this._createInnerModules();

            var hash={},t;
            xui.each(this._ctrlpool, function(prf){
                t=hash[prf.alias]=prf.serialize(false,false,false);
                delete t.key;
                delete t.alias;
                delete t.events;
                delete t['xui.Module'];
            });
            return hash;
        },
        setProfile:function(profiles){
            if(!this._innerModulesCreated)this._createInnerModules();

             xui.each(this._ctrlpool, function(prf,i){
                if(prf.alias in profiles){
                    i=profiles[prf.alias];
                    var ins=prf.boxing();
                    if(i && xui.isHash(i) && !xui.isEmpty(i)){
                        if(i.theme&&typeof(ins.setTheme)=="function")ins.setTheme(i.theme);
                        if(i.properties &&!xui.isEmpty(i.properties))ins.setProperties(i.properties);
                        if(i.CA&&!xui.isEmpty(i.CA))ins.setCustomAttr(i.CA);
                        if(i.CC&&!xui.isEmpty(i.CC))ins.setCustomClass(i.CC);
                        if(i.CS&&!xui.isEmpty(i.CS))ins.setCustomStyle(i.CS);
                    }else{
                        ins.setValue(i);
                    }
                }
            });
            return this;
        },
        getPropBinderKeys:function(scope_set, scope_clear){
            if(!this._innerModulesCreated)this._createInnerModules();

            scope_set=scope_set || xui._scope_set;
            scope_clear=scope_clear || xui._scope_clear; 

            // collect keys
            var hash={};
            try{
                scope_set.call(this);
                xui.each(this._ctrlpool, function(prf){
                    var prop=prf.properties;
                    if(prop.propBinder)
                        xui.each(prop.propBinder,function(fun,key){
                            if(key in prop){
                                if(xui.isFun(fun))fun();
                            }
                        });
                });
            }catch(e){}finally{
                scope_clear.call(this);
            }

            xui.each(hash, function(v,k){
                hash[k] = xui.toArr(v, true);
            });
            return hash;
        },
        reBindProp:function(dataMap, scope_set, scope_clear){
            if(!this._innerModulesCreated)this._createInnerModules();
            scope_set=scope_set || xui._scope_set;
            scope_clear=scope_clear || xui._scope_clear; 
            
            try{
                scope_set.call(this, dataMap);
                 xui.each(this._ctrlpool, function(prf){
                    prf.boxing().reBindProp(dataMap,scope_set,scope_clear, true);
                });
            }catch(e){
                scope_clear.call(this);
            }
        },
        getData:function(withValue){
            if(!this._innerModulesCreated)this._createInnerModules();

            var hash={};
             xui.each(this._ctrlpool, function(prf){
                var prop=prf.properties,
                    ins=prf.boxing(),
                    ih=hash[prf.alias]={};
                xui.arr.each(["src","html","items","listKey","header","rows","target","toggle","attr","JSONData","XMLData","JSONUrl","XMLUrl","name",'labelCaption'],function(k){
                    if(k in prop)ih[k]=prop[k];
                });
                if(withValue)
                    if('value' in prop)ih.value=prop.value;
                if('caption' in prop && xui.isSet(prop.caption)){
                    ih.caption=typeof(ins.getCaption)=="function"?ins.getCaption():prop.caption;
                }
            });
            return hash;
        },
        setData:function(data){
            if(!this._innerModulesCreated)this._createInnerModules();

             xui.each(this._ctrlpool, function(prf){
                var prop=prf.properties,
                    ins=prf.boxing(),ih;
               if(prf.alias in data){
                    ih=data[prf.alias];
                    if(ih && xui.isHash(ih) && !xui.isEmpty(ih)){
                        xui.arr.each(["src","html","items","listKey","header","rows","target","toggle","attr","JSONData","XMLData","JSONUrl","XMLUrl","name","value",'labelCaption',"caption"],function(k){
                            if(k in prop && k in ih)ins['set'+xui.str.initial(k)](ih[k]);
                        });
                    }else
                        ins.setValue(ih);
                }
            });
            return this;
        },

        // fack absValue
        getValue:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                var hash={}, cap, uv;
                 xui.each(this._ctrlpool, function(prf){
                    if('value' in prf.properties){
                        if(xui.isSet(prf.properties.caption)){
                            cap = prf.properties.caption;
                            uv = prf.properties.value;

                            // igore unnecessary caption
                            if((!cap && !uv) || cap==uv)
                                hash[prf.alias]=uv;
                            else
                                hash[prf.alias]={value:uv, caption:cap};
                        }
                        else{
                            hash[prf.alias]=prf.properties.value;
                        }
                    }
                });
                return hash;
            }else{
                return this.properties.value;
            }
        },
        setValue:function(values, innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                if(!xui.isEmpty(values)){
                     xui.each(this._ctrlpool, function(prf){
                        if('value' in prf.properties && prf.alias in values){
                            var v=values[prf.alias],b=xui.isHash(v) ;
                            prf.boxing().setValue((b && ('value' in v)) ? v.value : v, true,'module');
                            if(typeof(prf.boxing().setCaption)=="function" &&  b  && 'caption' in v)
                                prf.boxing().setCaption(v.caption, null, true,'module');
                        }
                    });
                }
            }else{
                this.properties.value = values;
            }
            return this;
        },
        getUIValue:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                var hash={};
                 xui.each(this._ctrlpool, function(prf){
                    if('$UIvalue' in prf.properties)
                        hash[prf.alias]=prf.properties.$UIvalue;
                });
                return hash;
            }else{
                return this.$UIvalue;
            }
        },
        setUIValue:function(values,innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                if(!xui.isEmpty(values)){
                     xui.each(this._ctrlpool, function(prf){
                        if('value' in prf.properties && prf.alias in values){
                            var v=values[prf.alias],b=xui.isHash(v) ;
                            prf.boxing().setUIValue((b && ('value' in v))?v.value:v, true,false,'module');
                            if(typeof(prf.boxing().setCaption)=="function" && b &&  'caption' in v)
                                prf.boxing().setCaption(v.caption, null, true,'module');
                        }
                    });
                }
            }else{
                this.$UIvalue = values;
            }
            return this;
        },
        resetValue:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();
                xui.each(this._ctrlpool, function(prf){
                     if(prf.boxing().resetValue)prf.boxing().resetValue();
                });
            }else{
                this.$UIvalue=this.properties.value; 
            }
            return this;
        },
        updateValue:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();
                xui.each(this._ctrlpool, function(prf){
                     if(prf.boxing().updateValue)prf.boxing().updateValue();
                });
            }else{
                this.properties.value=this.$UIvalue; 
                return this;
            }
            return this;
        },
        isDirtied:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                var dirtied=false;
                xui.each(this._ctrlpool, function(prf){
                    if(prf.boxing().isDirtied){
                        if(prf.boxing().isDirtied()){
                            return false;
                        }
                    }
                });
                 return dirtied;
            }else{
                return this.properties.value===this.$UIvalue;
            }
        },
        checkValid:function(innerUI){
            if(innerUI){
                if(!this._innerModulesCreated)this._createInnerModules();

                  xui.each(this._ctrlpool, function(prf){
                     if(prf.boxing().checkValid){
                         if(!prf.boxing().checkValid()){
                             return false;
                         }
                    }
                 });
            }else{
                return true;
            }
        },

        getDataBinders:function(){
            if(!this._innerModulesCreated)this._createInnerModules();
            
            var nodes = xui.copy(this._nodes),t,k='xui.DataBinder';
            xui.filter(nodes,function(o){
                return !!(o.box[k]);
            });
            return nodes;
        },
        getForms:function(){
            if(!this._innerModulesCreated)this._createInnerModules();
            
            var nodes = xui.copy(this._ctrlpool),t,k='xui.absContainer';
            xui.filter(nodes,function(o){
                return !!(o.box[k]);
            });
            return nodes;
        },
        // get all children
        getAllComponents:function(){
            if(!this._innerModulesCreated)this._createInnerModules();
            var nodes=[];
            var fun = function(m){
                    if(m["xui.Module"]){
                        xui.each(m._ctrlpool,function(o){
                            if(o["xui.Module"])fun(o);
                            else nodes.push(o);
                        });
                    }
                };
            fun(this);
            return xui.absObj.pack(nodes,false);
        },
        // get first level children only
        getComponents:function(){
            if(!this._innerModulesCreated)this._createInnerModules();
            var nodes = [];
            var fun = function(m){
                if(m["xui.Module"]){
                    xui.arr.each(m._nodes,function(o){
                        if(o["xui.Module"])fun(o);
                        else nodes.push(o);
                    });
                }
            };
            fun(this);
            return xui.absObj.pack(nodes,false);
        },
        // get first level UI children only
        // flag:true => no  $initRootHidden
        // flag:false => $initRootHidden
        // no flag: all
        getUIComponents:function(flag){
            var nodes = this.getComponents().get(),
                k='xui.UI', n='$initRootHidden';
            xui.filter(nodes,function(o){
                return !!(o && o.box &&o.box[k]) && (flag===true?!o.box[n]:flag===false?o.box[n]:true);
            });
            return xui.UI.pack(nodes, false);
        },
        setComponents:function(obj){
            var self=this,t;
            xui.arr.each(self._nodes,function(o){
                if((t=self[o.alias]) &&t.get(0)==o)
                    delete self[o.alias];
            });
            xui.arr.each(self._nodes=obj.get(),function(o){
                // set host
                o.boxing().setHost(self, o.alias);
            });
            xui.arr.each(self._nodes,function(o){
                xui.Module.$attachModuleInfo(self,o);
            });
            return self;
        },
        AddComponents:function(obj){
            var self=this;
            xui.arr.each(obj.get(),function(o){
                o.boxing().setHost(self, o.alias);
                self._nodes.push(o);
                xui.Module.$attachModuleInfo(self,o);
            });
            return self;
        },
        isDestroyed:function(){
            return !!this.destroyed;
        },
        destroy:function(ignoreEffects, purgeNow,keepStructure){
            var self=this,con=self.constructor,ns=self._nodes;
            if(self.destroyed)return;
            
            self._fireEvent('onDestroy');
            if(self.alias && self.host && self.host[self.alias]){
                delete self.host[self.alias];
            }

            //set once
        	self.destroyed=true;
            if(ns && ns.length)
                xui.arr.each(ns, function(o){
                    if(o && o.box)
                        o.boxing().destroy(ignoreEffects, purgeNow);
                },null,true);

            if(ns && ns.length)
                self._nodes.length=0;
        	self._ctrlpool=null;
            
            self.unLinkAll();

            if(!keepStructure){
	            xui.breakO(self);
	        }else{
                // for refresh itself
                delete self.renderId;
                delete self.created;
                delete self._innerModulesCreated;
            }
            //afterDestroy
            if(self.$afterDestroy){
                xui.each(self.$afterDestroy,function(f){
                    xui.tryF(f,[ignoreEffects, purgeNow],self);
                });
                xui.breakO(self.$afterDestroy,2);
            }
            //set again
        	self.destroyed=true;
        }
    },
    Static:{
        // fake absValue
        "xui.absValue":true,
        refresh:function(code){
            var m=this,keep={
                    '$children':m.$children,
                    _cache:m._cache,
                    _nameId:m._nameId
                },
                key=m.KEY,
                path=key.split("."),
                n;
            // clear cache
            if(s=xui.get(window,['xui','$cache','SC']))delete s[key];
            xui.set(window, path);
            // rebuild
            xui.exec(code);
            // the new one
            n=xui.get(window, path);
            // merge new to old
            xui.merge(m,n,function(o,i){return n.hasOwnProperty(i);});
            xui.merge(m.prototype, n.prototype,function(o,i){return n.prototype.hasOwnProperty(i);});
            // restore those
            xui.merge(m,keep,'all');
            // break new
            xui.breakO(n.prototype,1);
            xui.breakO(n,1);
            // restore namespace
            xui.set(window, path, m);
            return m;
        },
        pickAlias:function(){
            return xui.absObj.$pickAlias(this);
        },
        getFromDom:function(id){
            var prf=xui.UIProfile.getFromDom(id);
            if(prf&&(prf=prf.host)){
                return (!prf.destroyed) &&prf;
            }
        },
        getClsFromDom:function(id){
            return xui.get(this.getFromDom(id),["KEY"]);
        },
        getAllInstance:function(){
            var hash={};
            xui.arr.each(this._cache,function(o){
                hash[o.$xid]=o;
            });
            return hash;
        },
        getInstance:function(module, xid){
            var m=this;
            if(!xid){
                if(module['xui.Profile'] && module.moduleClass && module.moduleXid){
                    xid = module.moduleXid;
                    module = module.moduleClass;
                }else{
                    xid = module;
                    module = null;
                }
            }
            if(module){
                m=xui.SC.get(module);
                if(!m||!m['xui.Module'])return;
            }
            var c=m._cache;
            for(var i in c)
                if(xui.isFinite(i) ? (xid+"")==i : ('$'+xid)==i)return c[i];
        },
        postMessage:function(cls, msg1, msg2, msg3, msg4, msg5,  sender){
           var m = xui.SC.get(cls),hash;
            if(m && m['xui.Module'])
                xui.arr.each(m._cache,function(o){
                     m.fireEvent('onMessage',  [m, msg1, msg2, msg3, msg4, msg5, sender]);
                });
        },
        destroyAll:function(ignoreEffects, purgeNow){
            xui.arr.each(this._cache,function(o){
                if(!o.destroyed)o.destroy(ignoreEffects, purgeNow);
            });
        },
        load:function(cls, onEnd, lang, theme, showUI, parent, subId, onCreated){
            if(!cls){
                var e=new Error("No cls");
                xui.tryF(onEnd,[e,null]);
                throw e;
            }
            // compitable
            if(typeof theme=='function')thowUI=theme;
            var ifun=function(path){
                var a=this,
                    t, bg, zoom,
                    f=function(i,l,flag){
                        if(zoom)
                            xui.Dom.$setZoom(xui('html').get(0), zoom);
                        if(bg && xui.isHash(bg)){
                            xui.each(bg,function(v,k){
                                xui('html').css(k, xui.adjustRes(v));
                            });
                        }

                        if(!xui.isFun(a)){
                            var e=new Error( "'"+cls+"' is not a constructor");
                            xui.tryF(onEnd,[e,null]);
                            throw e;
                        }else{
                            var o=new a();
                            // record it
                            a._callfrom=cls;

                            xui.set(xui.ModuleFactory,["_cache",cls],o);

                            if(onCreated)xui.tryF(onCreated, [o]);

                            if(showUI!==false)o.show(onEnd, parent, subId);
                            else xui.tryF(onEnd,[null,o],o);
                        }
                    };
                //if successes
                if(path){
                    try{
                        // for CDN font icons
                        if((t=xui.ini.$FontIconsCDN) && xui.isHash(t)){
                            xui.each(t,function(o,i){
                                if(o.href){
                                    var attr={crossorigin:'anonymous'};
                                    xui.merge(attr, o, function(v,j){return j!=='href'});
                                    xui.CSS.includeLink(xui.adjustRes(o.href), 'xui_app_fscdn-'+i, false,attr);
                                }
                            });
                        }
                        // for theme or background of root
                        if((t=xui.ini.$PageAppearance) && xui.isHash(t)){
                            if(t.theme)theme=t.theme;
                            if(t.lang)lang=t.lang;
                            if('background' in t)bg=t.background;
                            if('zoom' in t)zoom=t.zoom;
                        }else if((t=this.viewStyles) && xui.isHash(t)){
                            if(t.theme)theme=t.theme;
                            bg={};
                            xui.each(t,function(o,i){
                                if(i=='theme')return;
                                bg[i]=o;
                            });
                        }
                        if((t=xui.ini.$ElementStyle) && xui.isHash(t)){
                            xui.CSS.setStyleRules(".xui-custom",t,true);
                        }
                        if((t=xui.ini.$DefaultProp) && xui.isHash(t)){
                            var allp={}, ctl;
                            xui.each(t,function(v,k){
                                if(/^xui\.UI\./.test(k) && xui.isHash(v) && (ctl=xui.get(window, k.split('.')))) {
                                    ctl.setDftProp(v);
                                }else{
                                    allp[k]=v;
                                }
                            });
                            if(!xui.isEmpty(allp)){
                                xui.UI.setDftProp(allp);
                            }
                        }
                    }catch(e){}
                    if(theme&&theme!="default"){
                        xui.setTheme(theme,true,function(){
                            if(lang) xui.setLang(lang, f); else f();
                        },function(){
                            xui.alert("Can't load theme - " + theme);
                            if(lang) xui.setLang(lang, f); else f();
                        });
                    }else{
                        //get locale info
                        if(lang) xui.setLang(lang, f);else f();
                    }
                }else{
                    var e=new Error("No class name");
                    xui.tryF(onEnd,[e,null]);
                    throw e;
                }
            },
            fun=function(){
                if(typeof(cls)=='function'&&cls.$xui$)ifun(ok);
                else cls=cls+"";
                if(/\//.test(cls) && !/\.js$/i.test(cls))
                    cls=cls+".js";
                if(/\.js$/i.test(cls)){
                    xui.fetchClass(cls,ifun,
                        function(e){
                            xui.tryF(onEnd,[e,null]);
                        });
                }else
                    //get app class
                    xui.SC(cls,ifun,true,null,{
                        retry:0,
                        onFail:function(e){
                            xui.tryF(onEnd,[e,null]);
                        }
                    });
            };
            if(xui.isDomReady)
                fun();
            else
                xui.main(fun);
        },
        unserialize:function(hash){
            return new this(hash);
        },
        $attachModuleInfo:function(module,prf){
            // module in module
            if(prf.moduleClass && prf.moduleXid){
                var t=xui.SC.get(prf.moduleClass);
                    t=t.getInstance(prf.moduleXid);
                if(t!==module){
                    t.moduleClass=module.KEY;
                    t.moduleXid=module.$xid;
                    return;
                }
            }

            prf.moduleClass=module.KEY;
            prf.moduleXid=module.$xid;
            xui.arr.each(prf.children,function(v){
               xui.Module.$attachModuleInfo(module, v[0]);
            });
        },

        // for setting only
        $DataModel:{
            autoDestroy:true,
            dataBinder:"",
            value:""
        },
        $EventHandlers:{
            onHookKey:function(module, key, e, keyDown){},
            onFragmentChanged:function(module, fragment, init, newAdd){},
            onMessage:function(module, msg1, msg2, msg3, msg4, msg5,  source){},
            beforeCreated:function(module, threadid){},
            onLoadBaseClass:function(module, threadid, uri, key){},
            onLoadBaseClassErr:function(module, threadid, key){},
            onLoadRequiredClass:function(module, threadid, uri, key){},
            onLoadRequiredClassErr:function(module, threadid, uri){},
            onIniResource:function(module, threadid){},
            beforeIniComponents:function(module, threadid){},
            afterIniComponents:function(module, threadid){},
            onModulePropChange:function(module, threadid){},
            onReady:function(module, threadid){},
            onRender:function(module, threadid){},
            onDestroy:function(module){}
        }
    }
});xui.Class("xui.Cookies", null,{
    Static:{
        set:function(name,value,days,path,domain,isSecure){
            if(xui.isHash(name)){
                for(var i in name) this.set(i, name[i],days,path,domain,isSecure);
           }else{
	           if(typeof value !="string")value=xui.serialize(value);
    	       document.cookie = escape(name+'') + "=" + escape(value) +
    		        (days?"; expires="+(new Date((new Date()).getTime()+(24*60*60*1000*days))).toGMTString():"")+
    		        (path?"; path="+path:"")+
    		        (domain?"; domain="+domain:"")+ 
    		        (isSecure?"; secure":"");
    	    }
            return this;
        },
        get:function(name){
        	var i,a,s,ca = document.cookie.split( "; " ),hash={},unserialize=function(v){
                return  /^\s*\{[\s\S]*\}$/.test(v) ? xui.unserialize(v) : /^\s*\[[\s\S]*\]$/.test(v) ? xui.unserialize(v) : v;
            };
        	for(i=0;i<ca.length;i++){
        		a=ca[i].split("=");
    	        s=a[1]?unescape(a[1]):'';
    	        hash[a[0]] = unserialize(s)||s;
        		if(name && a[0]==escape(name))
        		    return hash[a[0]];
        	}
        	return name?null:hash;
        },
        remove:function(name){
        	return this.set(name,"",-1).set(name,"/",-1);
        },
        clear:function(){
            xui.arr.each(document.cookie.split(";"),function(o){
                xui.Cookies.remove(xui.str.trim(o.split("=")[0]));
            });
        }
    }
});xui.Class('xui.XML',null,{
    Static:{
        //return xml text (for post data)
        json2xml:function(jsonObj, kf, vf){
           var arr=[],
           _f=function(key,value,arr){
                if(typeof value=="object"){
                    if(xui.isArr(value)){
                        if(value.length){
                            for(var i=0,l=value.length; i<l; i++)
                                arr.push(_f(key,value[i],arr));
                        }else
                            arr.push("<"+(kf?kf(key):key)+">"+"__[]__"+"</"+(kf?kf(key):key)+">");
                    }else{
                        var b;
                        arr.push("<"+(kf?kf(key):key));
                        for(var i in value) {
                            if(i.charAt(0)=="@")
                                arr.push(" "+i.substr(1)+'="'+(vf?vf(value[i]):value[i])+'"');
                            else
                                b=1;
                        }
                        arr.push(b?">":"/>");
                        if(b){
                            for(var i in value) {
                                if(i=="#text")
                                    arr.push((vf?vf(value[i]):value[i]));
                                else if(i=="#cdata")
                                    arr.push("<![CDATA["+(vf?vf(value[i]):value[i])+"]]>");
                                else if (i.charAt(0)!="@")
                                    arr.push(_f(i,value[i],arr));
                            }
                            arr.push("</"+(kf?kf(key):key)+">");
                        }
                    }
                }else
                    arr.push("<"+(kf?kf(key):key)+">"+(vf?vf(value):value)+"</"+(kf?kf(key):key)+">");
           };
           for(var i in jsonObj)
              _f(i,jsonObj[i],arr);
           return '<?xml version="1.0" encoding="UTF-8" ?>'+arr.join('');
        },
        //return json object (for request data)
        xml2json:function(xmlObj){
            if(xmlObj.nodeType==9)
                xmlObj=xmlObj.documentElement;
            var o={},
            M={
                '\b': '\\b',
                '\t': '\\t',
                '\n': '\\n',
                '\f': '\\f',
                '\r': '\\r',
                '"' : '\\"',
                '\\': '\\\\'
            },
            R=/^-?(\d\d*\.\d*$)|(^-?\d\d*$)|(^-?\.\d\d*$)/,
            _map={
                "__[]__":[],
                "null":null,
                'false':false,
                'true':true
             },
            _es=function(str){
                return str.replace(/[\s\S]/g,function(a,b){return (b=M[a])?b:a});
            },
            _clear = function(xml) {
                var n,k;
                xml.normalize();
                for(n=xml.firstChild;n;){
                    k=n;
                    if(n.nodeType==1)_clear(n);
                    n=n.nextSibling;
                    if(k.nodeType==3 && !k.nodeValue.match(/\S/))
                        xml.removeChild(k);
                }
                return xml;
            },
            _xml=function(n){
                if ("innerHTML" in n){
                    n=n.innerHTML;
                    n=n in _map?_map[n]:R.test(n)?parseFloat(n):n;
                }else{
                    var arr=[],t,
                    _in=function(n) {
                        if(n.nodeType==1) {
                            arr.push("<"+n.nodeName);
                            var m=n.attributes;
                            for(var i=0,l=m.length;i<l;i++)
                                arr.push(" "+m[i].nodeName+'="'+(m[i].nodeValue||"")+'"');
                            if (n.firstChild) {
                                arr.push(">");
                                for(m=n.firstChild;m;m=m.nextSibling)
                                    arr.push(_in(m));
                                arr.push("</"+n.nodeName+">");
                            }else arr.push("/>");
                        }else if(n.nodeType==3){
                            n=n.nodeValue;
                            arr.push(n in _map?_map[n]:R.test(n)?parseFloat(n):n);
                        }else if(n.nodeType==4)
                            arr.push("<![CDATA[" + n.nodeValue + "]]>");
                    };
                    for(var m=n.firstChild;m;m=m.nextSibling)
                        _in(m);
                    n=(arr.length==1?arr[0]:arr.join(''))
                }
                return typeof n=='string'?_es(n):n;
            },
            _f=function(xml){
                var o=null,t,tt;
                if(xml.nodeType==1 && ((t=xml.attributes).length||xml.firstChild)){
                    o={};
                    if(t.length){
                        for(var i=0,l=t.length;i<l;i++)
                            o["@"+t[i].nodeName]=(t[i].nodeValue||"")+"";
                    }
                    if(xml.firstChild){
                        var text=0, cdata=0, children=0, n;
                        for(n=xml.firstChild;n;n=n.nextSibling){
                            tt=n.nodeType;
                            if(tt==1)
                                children++;
                            else if(tt==3)
                                text++;
                            else if(tt==4)
                                cdata++;
                        }
                        if(children){
                            if(text<2 && cdata<2) {
                                for(n=xml.firstChild;n;n=n.nextSibling){
                                    if (n.nodeType==3)
                                        o["#text"]=_es(n.nodeValue);
                                    else if(n.nodeType==4)
                                        o["#cdata"]=_es(n.nodeValue);
                                    else if(o[tt=n.nodeName]){
                                        if(o[tt] instanceof Array)
                                            o[tt][o[tt].length]=_f(n);
                                        else
                                            o[tt]=[o[tt],_f(n)];
                                    }else
                                        o[tt]=_f(n);
                                }
                            }else {
                                if(!t.length)
                                    o=_xml(xml);
                                else
                                    o["#text"]= _xml(xml);
                            }
                        }else if(text){
                            if(!t.length) {
                                o=_xml(xml);
                            }else
                                o["#text"]=_xml(xml);
                        }else if(cdata) {
                            if(cdata>1)
                                o=_xml(xml);
                            else
                                for(n=xml.firstChild;n;n=n.nextSibling)
                                    o["#cdata"] = _es(n.nodeValue);
                        }
                    }
                }
                return o;
            };
            o[xmlObj.nodeName]=_f(_clear(xmlObj));
            return o;
        },
        parseXML:function(xmlText){
            var dom=null;
            if(typeof DOMParser=='undefined'){
                try{
                    dom=new ActiveXObject('Microsoft.XMLDOM');
                    dom.async=false;
                    dom.loadXML(xmlText||"");
                }catch(e){dom=null}
            }else{
                try{
                    var p=new DOMParser();
                    dom=p.parseFromString(xmlText||"", "text/xml");
                }catch(e){dom=null}finally{p=null}
            }
            return dom;
        }
    }
});xui.Class('xui.XMLRPC',null,{
    Static:{
        //wrapRequest(hash)
        // or wrapRequest(string, hash)
        wrapRequest:function(methodName,params){
            if(typeof methodName=="object"){
                params=methodName.params;
                methodName=methodName.methodName;
            }

            if(!methodName)return null;
            if(params && !params instanceof Array)return null;

            var ns=this,
                xml = ['<?xml version="1.0"?><methodCall><methodName>'+ methodName+'</methodName>'];
            if(params){
                xml.push('<params>');
                for(var i=0,j=params.length;i<j;i++)
                    xml.push('<param>'+ns._wrapParam(params[i])+'</param>');
                xml.push('</params>');
            }
            xml.push('</methodCall>');
            return xml.join('');
        },
        parseResponse:function(xmlObj){
            if(!xmlObj || !xmlObj.documentElement)return null;
            var doc=xmlObj.documentElement;
            if(doc.nodeName!='methodResponse')return null;
            var ns=this,
                json={},
                err,elem;
       
            elem = doc.getElementsByTagName('value')[0];
            if(elem.parentNode.nodeName=='param'&&elem.parentNode.parentNode.nodeName=='params'){
                json.result=ns._parseElem(elem);
            }
            else if(elem.parentNode.nodeName=='fault'){
                err=ns._parseElem(elem);
                json.error = {
                    code:err.faultCode,
                    message:err.faultString
                };
            }
            else return null;

            if(!json.result && !json.error)
                return null;
            return json;
        },
        _dateMatcher:/^(?:(\d\d\d\d)-(\d\d)(?:-(\d\d)(?:T(\d\d)(?::(\d\d)(?::(\d\d)(?:\.(\d+))?)?)?)?)?)$/,
        _parseElem:function(elem){
            var ns=this, 
                nodes=elem.childNodes,
                typeElem, dateElem, name, value, tmp;
            if(nodes.length==1&&nodes.item(0).nodeType==3)
                return nodes.item(0).nodeValue;

            for(var i=0,l=nodes.length;i<l;i++){
                if(nodes.item(i).nodeType==1){
                    typeElem=nodes.item(i);
                    switch(typeElem.nodeName.toLowerCase()){
                        case 'i4':
                        case 'int':
                            value=parseInt(typeElem.firstChild.nodeValue,10);
                            return isNaN(value)?null:value;
                        case 'double':
                            value=parseFloat(typeElem.firstChild.nodeValue);
                            return isNaN(value)?null:value;
                        case 'boolean':
                            return Boolean(parseInt(typeElem.firstChild.nodeValue,10)!==0);
                        case 'string':
                            return typeElem.firstChild?typeElem.firstChild.nodeValue:"";
                        case 'datetime.iso8601':
                            if(tmp=typeElem.firstChild.nodeValue.match(ns._dateMatcher)){
                                value = new Date;
                                if(tmp[1]) value.setUTCFullYear(parseInt(tmp[1],10));
                                if(tmp[2]) value.setUTCMonth(parseInt(tmp[2]-1,10));
                                if(tmp[3]) value.setUTCDate(parseInt(tmp[3],10));
                                if(tmp[4]) value.setUTCHours(parseInt(tmp[4],10));
                                if(tmp[5]) value.setUTCMinutes(parseInt(tmp[5],10));
                                if(tmp[6]) value.setUTCSeconds(parseInt(tmp[6],10));
                                if(tmp[7]) value.setUTCMilliseconds(parseInt(tmp[7],10));
                                return value;
                            }
                            return null;
                        case 'base64':
                            return null;
                        case 'nil':
                            return null;
                        case 'struct':
                            value = {};
                            for(var mElem,j=0;mElem=typeElem.childNodes.item(j);j++){
                                if(mElem.nodeType==1&&mElem.nodeName=='member'){
                                    name='';
                                    elem=null;
                                    for(var child,k=0;child=mElem.childNodes.item(k);k++){
                                        if(child.nodeType==1){
                                            if(child.nodeName=='name')
                                                name=child.firstChild.nodeValue;
                                            else if(child.nodeName=='value')
                                                elem = child;
                                        }
                                    }
                                    if(name&&elem)
                                       value[name] = ns._parseElem(elem);
                                }
                            }
                            return value;
                        case 'array':
                                value = [];
                                dateElem=typeElem.firstChild;
                                while(dateElem&&(dateElem.nodeType!=1||dateElem.nodeName!='data'))
                                    dateElem = dateElem.nextSibling;
                                if(!dateElem)
                                    return null;
                                elem=dateElem.firstChild;
                                while(elem){
                                    if(elem.nodeType==1)
                                        value.push(elem.nodeName=='value'?ns._parseElem(elem):null);
                                    elem=elem.nextSibling;
                                }
                                return value;
                        default:
                                return null;
                    }
                }
            }
            return null;
        },
        _map:{
            "<":"&lt;",
            ">":"&gt;",
            "&":"&amp;",
            '"':"&quot;",
            "'":"&apos;"
        },
        _date2utc:function(d){
            var ns=this,r=this._zeroPad;
            return d.getUTCFullYear()+'-'+
               r(d.getUTCMonth()+1)+'-'+
               r(d.getUTCDate())+'T'+
               r(d.getUTCHours())+':'+
               r(d.getUTCMinutes())+':'+
               r(d.getUTCSeconds())+'.'+
               r(d.getUTCMilliseconds(), 3);
        },
        _zeroPad:function(v,w){
            if(!w)w=2;
            v=((!v&&v!==0)?'':(''+v));
            while(v.length<w)v='0'+v;
            return v;
        },
        _wrapParam:function(value){
            var ns=this,
                map=ns._map,
                xml=['<value>'],sign;
            switch(typeof value){
                case 'number':
                    xml.push(!isFinite(value)?'<nil/>':
                        parseInt(value,10)===Math.ceil(value)?('<int>'+value+'</int>'):
                        ('<double>'+value+'</double>')
                    );
                    break;
                case 'boolean':
                    xml.push('<boolean>'+(value?'1':'0')+'</boolean>');
                    break;
                case 'string':
                    xml.push('<string>'+value.replace(/[<>&"']/g, function(a){return map[a]})+'</string>');
                    break;
                case 'undefined':
                    xml.push('<nil/>');
                case 'function':
                    xml.push('<string>'+(""+value).replace(/[<>&"']/g, function(a){return map[a]})+'</string>');
                case 'object':
                    sign=Object.prototype.toString.call(value);
                    if(value===null)
                        xml.push('<nil/>');
                    else if(sign==='[object Array]'){
                        xml.push('<array><data>');
                        for(var i=0,j=value.length;i<j;i++)
                            xml.push(ns._wrapParam(value[i]));
                        xml.push('</data></array>');
                    }
                    else if(sign==='[object Date]' && isFinite(+value)){
                        xml.push('<dateTime.iso8601>' + ns._date2utc(value) + '</dateTime.iso8601>');
                    }
                    else {
                        xml.push('<struct>');
                        for(var key in value)
                            if(value.hasOwnProperty(key))
                                xml.push('<member>'+'<name>'+key+'</name>'+ns._wrapParam(value[key])+'</member>');
                        xml.push('</struct>');
                    }
                    break;
            }
            xml.push('</value>');
            return xml.join('');
        }
    }
});xui.Class('xui.SOAP',null,{
    Static:{
        RESULT_NODE_NAME:"return",

        getNameSpace:function(wsdl){
            var ns=wsdl.documentElement.attributes["targetNamespace"];
            return ns===undefined?wsdl.documentElement.attributes.getNamedItem("targetNamespace").nodeValue:ns.value;
        },
        getWsdl:function(queryURL,onFail){
            var rst=false;

            // sync call for wsdl
            xui.Ajax(queryURL+'?wsdl',null,function(rspData){
                rst=rspData;
            },function(){
                xui.tryF(onFail,arguments,this);
            },null,{
                method:'GET',
                rspType:'xml',
                asy:false
            }).start();

            return rst;
        },
        wrapRequest:function(methodName, params, wsdl){
            if(typeof methodName=="object"){
                wsdl=params;
                params=methodName.params;
                methodName=methodName.methodName;
            }
            var ns=this, namespace=ns.getNameSpace(wsdl);
            //return "<?xml version=\"1.0\" encoding=\"utf-8\"?>" +
            return  "<soap:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">" +
                    "<soap:Body>" +
                    "<" + methodName + " xmlns=\""+namespace+"\">" +
                    ns._wrapParams(params) +
                    "</"+methodName+"></soap:Body></soap:Envelope>";
        },
        parseResponse:function(xmlObj, methodName, wsdl){
            if(typeof methodName=="object"){
                methodName=methodName.methodName;
            }
            var ns=this,
                hash={},
                nd=xmlObj.getElementsByTagName(methodName+"Result");
            if(!nd.length)
                nd=xmlObj.getElementsByTagName(ns.RESULT_NODE_NAME);
            if(!nd.length){
                hash.fault={
                    faultcode:xmlObj.getElementsByTagName("faultcode")[0].childNodes[0].nodeValue,
                    faultstring:xmlObj.getElementsByTagName("faultstring")[0].childNodes[0].nodeValue
                };
            }else{
                hash.result=ns._rsp2Obj(nd[0],wsdl);
            }
            return hash;
        },
        _rsp2Obj:function(xmlNode, wsdl){
            var ns=this,
                types=ns._getTypesFromWsdl(wsdl);
            return ns._node2obj(xmlNode,types);
        },
        _getTypesFromWsdl:function(wsdl){
            var types=[],
                ell,useNamedItem;

            ell=wsdl.getElementsByTagName("s:element");
            if(ell.length){
                useNamedItem=true;
            }else{
                ell=wsdl.getElementsByTagName("element");
                useNamedItem=false;
            }
            for(var i=0,l=ell.length;i<l;i++){
                if(useNamedItem){
                    if(ell[i].attributes.getNamedItem("name") != null && ell[i].attributes.getNamedItem("type") != null)
                        types[ell[i].attributes.getNamedItem("name").nodeValue] = ell[i].attributes.getNamedItem("type").nodeValue;
                }else{
                    if(ell[i].attributes["name"] != null && ell[i].attributes["type"] != null)
                        types[ell[i].attributes["name"].value] = ell[i].attributes["type"].value;
                }
            }
            return types;
        },
        _getTypeFromWsdl:function(elems, types){
            return types[elems]==undefined?"":types[elems];
        },
        _node2obj:function(xmlNode, types){
            if(xmlNode==null)return null;
            var ns=this,value,tmp;
            if(xmlNode.nodeType==3||xmlNode.nodeType==4){
                value=xmlNode.nodeValue;
                switch(ns._getTypeFromWsdl(xmlNode.parentNode.nodeName, types).toLowerCase()){
                    case "s:boolean":
                        return value+""=="true";
                    case "s:int":
                    case "s:long":
                        return value===null?0:parseInt(value+"", 10);
                    case "s:double":
                        return value===null?0:parseFloat(value+"");
                    case "s:datetime":
                        if(value == null)
                            return null;
                        else{
                            if(tmp=value.match(ns._dateMatcher)){
                                var d = new Date;
                                if(tmp[1]) d.setUTCFullYear(parseInt(tmp[1],10));
                                if(tmp[2]) d.setUTCMonth(parseInt(tmp[2]-1,10));
                                if(tmp[3]) d.setUTCDate(parseInt(tmp[3],10));
                                if(tmp[4]) d.setUTCHours(parseInt(tmp[4],10));
                                if(tmp[5]) d.setUTCMinutes(parseInt(tmp[5],10));
                                if(tmp[6]) d.setUTCSeconds(parseInt(tmp[6],10));
                                if(tmp[7]) d.setUTCMilliseconds(parseInt(tmp[7],10));
                                return d;
                            }
                            return null;
                        }
                    //case "s:string":
                    default:
                        return value===null?"":(value+"");
                }
            }else if(xmlNode.childNodes.length==1&&(xmlNode.childNodes[0].nodeType==3||xmlNode.childNodes[0].nodeType==4))
                return ns._node2obj(xmlNode.childNodes[0], types);
            else{
                if(ns._getTypeFromWsdl(xmlNode.nodeName, types).toLowerCase().indexOf("arrayof") == -1){
                    var obj=xmlNode.hasChildNodes()?{}:null;
                    for(var i=0,l=xmlNode.childNodes.length;i<l;i++)
                        obj[xmlNode.childNodes[i].nodeName]=ns._node2obj(xmlNode.childNodes[i], types);
                    return obj;
                }else{
                    var arr =[];
                    for(var i=0,l=xmlNode.childNodes.length;i<l;i++)
                        arr.push(ns._node2obj(xmlNode.childNodes[i], types));
                    return arr;
                }
            }
            return null;
        },
         _wrapParams:function(params){
            var ns=this,arr=[];
            for(var p in params){
                switch(typeof(params[p])){
                    case "string":
                    case "number":
                    case "boolean":
                    case "object":
                        arr.push("<" + p + ">" + ns._wrapParam(params[p]) + "</" + p + ">");
                        break;
                    default:
                        break;
                }

            }
            return arr.join('');
        },
        _map:{
            "<":"&lt;",
            ">":"&gt;",
            "&":"&amp;",
            '"':"&quot;",
            "'":"&apos;"
        },
        _wrapParam:function(param){
            var ns=this,
                s="",
                map=ns._map,
                sign,sign2,type,value;
            switch(typeof(param)){
                case "string":
                    s += param.replace(/[<>&"']/g, function(a){return map[a]});
                    break;
                case "number":
                case "boolean":
                    s += param+"";
                    break;
                case "object":
                    sign=Object.prototype.toString.call(param);
                    // Date
                    if(sign==='[object Date]' && isFinite(+param)){
                        s += ns._date2utc(param);
                    }else if(sign==='[object Array]'){
                        for(var p in param){
                            value=param[p];
                            switch(typeof value){
                                case 'number':
                                    type=parseInt(value,10)===Math.ceil(value)?'int':'double';
                                    break;
                                case 'boolean':
                                    type='bool';
                                    break;
                                case 'string':
                                    type='string';
                                    break;
                                case 'object':
                                    sign2=Object.prototype.toString.call(value);
                                    if(sign2==='[object Array]'){
                                        type="Array";
                                    }else if(sign2==='[object Date]' && isFinite(+value)){
                                        type="DateTime";
                                    }else
                                        type="object";
                                    break;
                            }
                            s += "<"+type+">"+ns._wrapParam(param[p])+"</"+type+">";
                        }
                    }else{
                        for(var p in param)
                            if(param.hasOwnProperty(p))
                                s += "<"+p+">"+ns._wrapParam(param[p])+"</"+p+">";
                    }
                    break;
            }
            return s;
        },
        _date2utc:function(d){
            var ns=this,r=this._zeroPad;
            return d.getUTCFullYear()+'-'+
               r(d.getUTCMonth()+1)+'-'+
               r(d.getUTCDate())+'T'+
               r(d.getUTCHours())+':'+
               r(d.getUTCMinutes())+':'+
               r(d.getUTCSeconds())+'.'+
               r(d.getUTCMilliseconds(), 3);
        },
        _zeroPad:function(v,w){
            if(!w)w=2;
            v=((!v&&v!==0)?'':(''+v));
            while(v.length<w)v='0'+v;
            return v;
        }
    }
});/*
profile input:
===========================
    [dragType]: String , "move","copy","deep_copy","shape","icon","blank" and "none", default is "shape"
        "blank": moves a empty proxy when mouse moves
        "move": moves target object directly when mouse moves
        "copy": moves a copy of target object when mouse moves
        "deep_copy": moves a deep copy of target object when mouse moves
        "shape": moves a shape of target object when mouse moves
        "icon": moves a icon that represents target object when mouse moves
        "none": moves mouse only
-------------------------
    [dragDefer] :  Number, when [xui.DragDrop.startDrag] is called, the real drag action will be triggered after [document.onmousemove] runs [dragDefer] times, default is 0;
-------------------------
    [magneticDistance]: Number,
    [xMagneticLines]: Array of Number,
    [yMagneticLines]: Array of Number,
        Magnetic setting:
        yMagneticLines 1                      2                     3
              |                      |                     |       xMagneticLines
          ----+----------------------+---------------------+-------1
              |                      |                     |
              |                      |                     |
              |                      |                     |
              |                      |                     |
          ----+----------------------+---------------------+-------2
              |                      |                     |
              |                      |                     |
              |                      |                     |
          ----+----------------------+---------------------+-------3
              |                      |                     |

        magneticDistance
         +-------------
         |*************
         |*************
         |**
         |**
         |**
-------------------------
    [widthIncrement]: Number,
    [heightIncrement]: Number,
        Increment setting:
                   widthIncrement
               <-------------------->
              |                      |                     |
          ----+----------------------+---------------------+-------
              |                      |                     |
heightIncrement|                      |                     |
              |                      |                     |
              |                      |                     |
          ----+----------------------+---------------------+-------
              |                      |                     |
              |                      |                     |
              |                      |                     |
              |                      |                     |
          ----+----------------------+---------------------+-------
              |                      |                     |
              |                      |                     |
-------------------------
    [horizontalOnly]: Number,
    [verticalOnly]: Number,
    horizontalOnly
    ------------------------------------------
                ****************
                ****************
                ****************
                ****************
                ****************
                ****************
    ------------------------------------------
    verticalOnly
               |                |
               |                |
               |****************|
               |****************|
               |****************|
               |****************|
               |****************|
               |****************|
               |                |
               |                |
-------------------------
    [maxBottomOffset]: Number,
    [maxLeftOffset]: Number,
    [maxRightOffset]: Number,
    [maxTopOffset]: Number,
        you can set the limited offset region
        +----------------------------------------------+
        |              |                               |
        |              |maxTopOffset                   |
        |<------------>****************<-------------->|
        |maxLeftOffset**************** maxRightOffset  |
        |              ****************                |
        |              ****************                |
        |              ****************                |
        |              ****************                |
        |              |maxBottomOffset                |
        |              |                               |
        +----------------------------------------------+
-------------------------
    [targetReposition]: <bool>,

    //ini pos and size
    [targetLeft]: Number
    [targetTop]: Number
    [targetWidth]: Number
    [targetHeight]: Number
    [targetCSS]: <object>
        You can set position and size when drag start:
                      targetLeft
                      |
                      |
        targetTop  ---**************** |
                      **************** |
                      **************** |
                      **************** |targetHeight
                      **************** |
                      **************** |
                     |<--targetWidth ->+
-------------------------
    //properties
    [dragCursor]: <string>
-------------------------
    //for drag data
    [dragKey]
    [dragData]

profile output: readonly
===========================
xui.DragDrop.getProfile():
    x  :current X value of mouse;
    y  :current Y value of mouse;
    ox: mouse original X when drag start;
    oy: mouse original Y when drag start;
    curPos:{left:xx,top:xx}: current css pos of the dragging node;
    offset : {x:,y}: offset from now to origin
    restrictedLeft : Number
    restrictedRight : Number
    restrictedTop : Number
    restrictedBottom : Number
    isWorking: Bool.
    proxyNode: xui.Dom object,
    dropElement: String, DOM element id.
*/
xui.Class('xui.DragDrop',null,{
    Static:{
        _eh:"_dd",
        _id:"xui.dd:proxy:",
        _idi:"xui.dd:td:",
        _type:{blank:1,move:1,shape:1,deep_copy:1,copy:1,icon:1,none:1},
        _Icons:{none:'0 0', move:'0 -16px', link:'0 -32px',add:'0 -48px'},
        _profile:{},

        //get left for cssPos
        _left:function(value){
            var proxySize=this.$proxySize;
            with(this._profile){
                if(magneticDistance>0 && xMagneticLines.length){
                    var l=xMagneticLines.length;
                    while(l--)
                        if(Math.abs(value + proxySize - xMagneticLines[l])<=magneticDistance)
                            return xMagneticLines[l] - proxySize;
                }
                if(widthIncrement>1)
                   return Math.floor((value + proxySize)/widthIncrement)*widthIncrement - proxySize;
                return value;
            }
        },
        //get top for cssPos
        _top:function(value){
            var proxySize=this.$proxySize;
            with(this._profile){
                if(magneticDistance>0 && yMagneticLines.length){
                    var l=yMagneticLines.length;
                    while(l--)
                        if(Math.abs(value + proxySize - yMagneticLines[l])<=magneticDistance)
                            return yMagneticLines[l] - proxySize;
                }
                if(heightIncrement>1)
                    return Math.floor((value + proxySize)/heightIncrement)*heightIncrement - proxySize;
                return value;
            }
        },

        _ini:function(o){
            var d=this,p=d._profile,_t=xui.win;

            d._box = { width :_t.width()+_t.scrollLeft(),  height :_t.height()+_t.scrollTop()};

            p.ox = p.x;
            p.oy = p.y;

            if(d._proxy = o){
                d._proxystyle=o.get(0).style;

                //ini cssPos here
                d._profile.curPos = d._cssPos= d._proxy.cssPos();

                d._cssPos_x = p.x - d._cssPos.left;
                d._cssPos_y = p.y - d._cssPos.top;

                p.restrictedLeft = p.x - (p.maxLeftOffset||0);
                p.restrictedRight =  p.x + (p.maxRightOffset||0);
                p.restrictedTop = p.y - (p.maxTopOffset||0);
                p.restrictedBottom = p.y + (p.maxBottomOffset||0);

                //here
                d._proxyLeft = d._pre.left = d._cssPos.left;
                d._proxyTop = d._pre.top = d._cssPos.top;

                if("move" !== p.dragType){
                    d._proxy.css('zIndex',xui.Dom.TOP_ZINDEX*10);
                    xui.setNodeData(d._proxy.get(0),'zIndexIgnore', 1);
                }
            }

        },
        _reset:function(){
            var d=this,NULL=null,FALSE=false;
            //reset
            xui.tryF(d.$reset);
            d.setDropFace();
            d._resetProxy();

            d.$proxySize=50;
            //event
            d.$mousemove=d.$mouseup=d.$onselectstart=d.$ondragstart='*';

            //reset private vars
            d._cursor='';
            d._pre={};
            d._proxyLeft=d._proxyTop=d._cssPos_x=d._cssPos_y=0;
            d._stop=FALSE;
            if(d._onDrag && d._onDrag.tasks){
                d._onDrag.tasks.length=0;
                delete d._onDrag.tasks;
            }
            if(d._onDragover && d._onDragover.tasks){
                d._onDragover.tasks.length=0;
                delete d._onDragover.tasks;
            }
            if(d._c_droppable){d._c_droppable.length=0;}
            d._c_droppable=d._c_dropactive=d._cssPos=d._box=d._dropElement=d._source=d._proxy=d._proxystyle=d._onDrag=d._onDragover=NULL;
            //reset profile
            d._profile={
                // the unqiue id for dd
                $id:xui.rand(),
                dragType:'shape',
                dragCursor:'move',
                targetReposition:true,

                dragIcon:xui.ini.img_dd,
                magneticDistance:0,
                xMagneticLines:[],
                yMagneticLines:[],
                widthIncrement:0,
                heightIncrement:0,
                dragDefer:0,

                horizontalOnly:FALSE,
                verticalOnly:FALSE,
                maxBottomOffset:NULL,
                maxLeftOffset:NULL,
                maxRightOffset:NULL,
                maxTopOffset:NULL,

                targetNode:NULL,
                targetCSS:NULL,
                dragKey:NULL,
                dragData:NULL,
                targetLeft:NULL,
                targetTop:NULL,
                targetWidth:NULL,
                targetHeight:NULL,
                targetOffsetParent:NULL,
                targetCallback:NULL,
                tagVar:NULL,

                shadowFrom:NULL,

                //Cant input the following items:
                proxyNode:NULL,
                x:0,
                y:0,
                ox:0,
                oy:0,
                curPos:{},
                offset:{},
                isWorking:FALSE,
                restrictedLeft:NULL,
                restrictedRight:NULL,
                restrictedTop:NULL,
                restrictedBottom:NULL,
                dropElement:NULL
            };
            d.__touchingfordd=0;
            return d;
        },
        abort:function(){
            this._stop=true;
        },
        _end:function(){
            var d=this,win=window,doc=document,body=doc.body,md="onmousedown",mm="onmousemove",mu="onmouseup",
                mm2,mu2;
            if(xui.browser.isTouch){
                mm2=(xui.browser.ie&&win.PointerEvent)?"onpointermove":(xui.browser.ie&&win.MSPointerEvent)?"onmspointermove":"ontouchmove";
                mu2=(xui.browser.ie&&win.PointerEvent)?"onpointerup":(xui.browser.ie&&win.MSPointerEvent)?"onmspointerup":"ontouchend";
            }
            
            if(d._proxy) d._unpack();

            //must here
            //if bak, restore
            if(d.$onselectstart!='*')body.onselectstart=d.$onselectstart;
            if(d.$ondragstart!='*')doc.ondragstart=d.$ondragstart;
            //if bak, restore
            if(d.$mousemove!='*')doc[mm]=d.$mousemove;
            if(d.$mouseup!='*')doc[mu]=d.$mouseup;
            if(xui.browser.isTouch){
                if(d.$touchmove!='*')doc[mm2]=d.$touchmove;
                if(d.$touchend!='*')doc[mu2]=d.$touchend;                
            }

            return  d;
        },
        startDrag:function(e, targetNode, profile, dragKey, dragData){
            var d=this,win=window,t;
            if(d._profile.isWorking)return false;
            //clear
            d._end()._reset();
            d._profile.isWorking=true;
            d.__touchingfordd = e.type=="xuitouchdown";

            profile=xui.isHash(profile)?profile:{};
            e = e || win.event;
            // not left button
            if(xui.Event.getBtn(e) !== 'left')
               return true;

            d._source = profile.targetNode = xui(targetNode);
            d._cursor = d._source.css('cursor');

            if((t=profile.targetNode.get(0)) && !t.id){
                t.id=xui.Dom._pickDomId();
                t=null;
            }

            //must set here
            d._defer = profile.dragDefer = xui.isNumb(profile.dragDefer) ? profile.dragDefer : 0;
            if(true===profile.dragCursor)profile.dragCursor=d._cursor;
            if(typeof profile.dragIcon == 'string') profile.dragType="icon";

            var doc=document, body=doc.body, _pos = xui.Event.getPos(e),md="onmousedown",mm="onmousemove",mu="onmouseup",
                mm2,mu2;
            if(xui.browser.isTouch){
                mm2=(xui.browser.ie&&win.PointerEvent)?"onpointermove":(xui.browser.ie&&win.MSPointerEvent)?"onmspointermove":"ontouchmove";
                mu2=(xui.browser.ie&&win.PointerEvent)?"onpointerup":(xui.browser.ie&&win.MSPointerEvent)?"onmspointerup":"ontouchend";
            }

            profile.x = _pos.left;
            profile.y = _pos.top;

            profile.dragKey= dragKey || profile.dragKey || null;
            profile.dragData= dragData  || profile.dragData|| null;

            var fromN=xui.Event.getSrc(e);

            d._start=function(e){
//ie6: mousemove - mousedown =>78 ms
//delay is related to window size, weird
            //                  try{
                var p=d._profile;
                //set profile
                xui.merge(p, profile, "with");

                //call event, you can call abort(set _stoop)
                d._source.beforeDragbegin();

                if(d._stop){d._end()._reset();return false}

                //set xui.Event._preDroppable at the begining of drag, for a dd from a child in a droppable node
                if(xui.Event && (t=d._source.get(0))){
                    xui.Event._preDroppable= t.id;
                    t=null;
                }

                //set default icon
                if(p.dragType=='icon')p.targetReposition=false;

                //ini
                d._ini(p.dragType=='none'?null:d._pack(_pos, p.targetNode));
                // on scrollbar
                if(profile.x >= d._box.width  || profile.y >= d._box.height ){d._end()._reset();return true}

                d._source.onDragbegin();

                //set back first
                if(p.dragDefer<1){
                    d.$mousemove = doc[mm];
                    d.$mouseup = doc[mu];
                    if(xui.browser.isTouch){
                        d.$touchmove = doc[mm2];
                        d.$touchend = doc[mu2];
                    }
                }
                //avoid setcapture
                if(xui.browser.ie)
                    xui.setTimeout(function(){if(fromN.releaseCapture)fromN.releaseCapture()});

                //back up
                doc[mm] = d.$onDrag;
                doc[mu] = d.$onDrop;
                if(xui.browser.isTouch){
                    doc[mm2] = d.$onDrag;
                    doc[mu2] = d.$onDrop;
                }
                
                //for events
                d._source.afterDragbegin();
                //for delay, call ondrag now
                if(p.dragDefer>0)d.$onDrag.call(d, e);
                
                // For touch-only platform
                // In ipad or other touch-only platform, you have to decide the droppable order by youself
                // The later added to DOM the higher the priority
                // Add droppable links
                if(xui.browser.isTouch && d.__touchingfordd){
                    d._c_droppable=[];
                    var cdata=xui.$cache.droppable[p.dragKey],purge=[];
                    xui.arr.each(cdata,function(i){
                        if(!xui.use(i).get(0)){
                            purge.push(i);
                            return;
                        }
                        var ni=xui.use(i),h=ni.offsetHeight(),w=ni.offsetWidth(),v=ni.css('visibility'),hash;
                        if(w&&h&&v!='hidden'){
                            hash=ni.offset();
                            hash.width=w;hash.height=h;hash.id=i;
                            d._c_droppable.unshift(hash);
                        }
                    });
                    // self clear
                    if(purge.length){
                        xui.arr.each(purge,function(key){
                            xui.arr.removeValue(cdata,key);
                        });
                    }
                }
            //                  }catch(e){d._end()._reset();}
            };
            if(xui.browser.ie){
                d.$ondragstart=doc.ondragstart;
                d.$onselectstart=body.onselectstart;
                doc.ondragstart = body.onselectstart = null;
                if(doc.selection && doc.selection.empty)try{doc.selection.empty()}catch(e){}            }
            //avoid select
            xui.Event.stopBubble(e);

            //fire document onmousedown event
            if(profile.targetNode.get(0)!==doc)
                xui(doc).onMousedown(true, xui.Event.getEventPara(e, _pos));

            if(profile.dragDefer<1){
                xui.tryF(d._start,[e],d);
                return false;
            }else{
                //for mouseup before drag
                d.$mouseup = doc[mu];
                doc[mu] = function(e){
                    xui.DragDrop._end()._reset();
                    return xui.tryF(document.onmouseup,[e],null,true);
                };
                if(xui.browser.isTouch){
                    d.$touchend = doc[mu2];
                    doc[mu2]=doc[mu];
                }
                var pbak={};
                //for mousemove before drag
                d.$mousemove = doc[mm];
                doc[mm] = function(e){
                    var p=xui.Event.getPos(e);
                    if(p.left===pbak.left&&p.top===pbak.top)return;
                    pbak=p;
                    if(--d._defer<=0)xui.DragDrop._start(e);
                    return false;
                };
                if(xui.browser.isTouch){
                    d.$touchmove = doc[mm2];
                    doc[mm2]=doc[mm];
                }
            }
//ie6: mousemove - mousedown =>78 ms
        },
        $onDrag:function(e){
            var d=xui.DragDrop,p=d._profile;

            if(d.$SimulateMousemoveInMobileDevice)return false;
            
           //try{
                e = e || window.event;
                //set _stop or (in IE, show alert)
                if(!p.isWorking || d._stop){
                //if(!p.isWorking || d._stop || (xui.browser.ie && (!e.button) )){
                    d.$onDrop(e);
                    return true;
                }

                var _pos=xui.Event.getPos(e);
                p.x=_pos.left;
                p.y=_pos.top;

                if(!p.isWorking)return false;

                if(d._proxy){
                    if(!p.verticalOnly){
                        d._proxyLeft=Math.floor(d._left(
                            ((p.maxLeftOffset!==null && p.x<=p.restrictedLeft)?p.restrictedLeft:
                             (p.maxRightOffset!==null && p.x>=p.restrictedRight)?p.restrictedRight : p.x)
                            - d._cssPos_x)
                        );
                        if(d._proxyLeft-d._pre.left)
                            d._proxystyle.left=Math.round(parseFloat(d._proxyLeft))+'px';
                        d._pre.left=d._proxyLeft;
                        p.curPos.left = d._proxyLeft + d.$proxySize;
                    }
                    if(!p.horizontalOnly){
                        d._proxyTop=Math.floor(d._top(
                            ((p.maxTopOffset!==null && p.y<=p.restrictedTop) ? p.restrictedTop :
                             (p.maxBottomOffset!==null && p.y>=p.restrictedBottom) ? p.restrictedBottom : p.y)
                            - d._cssPos_y)
                        );
                        if(d._proxyTop-d._pre.top)
                            d._proxystyle.top=Math.round(parseFloat(d._proxyTop))+'px';
                        d._pre.top=d._proxyTop;
                        p.curPos.top = d._proxyTop + d.$proxySize;
                    }
                }else{
                    p.curPos.left = p.x;
                    p.curPos.top = p.y;
                    //style='none', no dd.current dd._pre provided
                    //fireEvent
                    //d._source.onDrag(true); //shortcut for mousemove
                }
      
                if(d._onDrag!=1){
                    if(d._onDrag)d._onDrag(e,d._source._get(0));
                    else{
                        //ensure to run once only
                        d._onDrag=1;
                        //if any ondrag event exists, this function will set _onDrag
                        d._source.onDrag(true,xui.Event.getEventPara(e, _pos));
                    }
                }
                
                // For touch-only platform
                // In ipad or other touch-only platform, you have to decide the droppable order by youself
                // The later joined the higher the priority
                if(xui.browser.isTouch && d.__touchingfordd){
                    if(d._c_droppable){
                        for(var i=0,l=d._c_droppable.length;i<l;i++){
                            var o=d._c_droppable[i],
                                target=xui.use(o.id).get(0),
                                oactive=d._c_dropactive,
                                otarget=xui.use(oactive).get(0);

                            if(p.x>=o.left&&p.y>=o.top&&p.x<=(o.left+o.width)&&p.y<=(o.top+o.height)){
                                if(oactive==o.id){
                                    //console.log('in ' +o.id );
                                    var first = e.changedTouches[0];
                                    d.$SimulateMousemoveInMobileDevice=1;
                                    xui.Event.simulateEvent(target,"mousemove",{screenX:first.screenX, screenY:first.screenY, clientX:first.clientX, clientY:first.clientY});
                                    delete d.$SimulateMousemoveInMobileDevice;
                                }else{
                                    xui.Event.simulateEvent(target,"mouseover",{screenX:p.left, screenY:p.top, clientX:p.left, clientY:p.top});
                                    d._c_dropactive=o.id;

                                    //console.log('active ' +o.id);
                                    if(oactive && otarget){
                                        xui.Event.simulateEvent(otarget,"mouseout",{screenX:p.left, screenY:p.top, clientX:p.left, clientY:p.top});
                                        //console.log('deactive ' + oactive);
                                    }
                                }
                                break;
                            }else{
                                if(oactive==o.id){
                                    if(otarget){
                                        xui.Event.simulateEvent(otarget,"mouseout",{screenX:p.left, screenY:p.top, clientX:p.left, clientY:p.top});
                                    }
                                    d._c_dropactive=null;
                                    //console.log('deactive ' + oactive);
                                    break;
                                }
                            }
                        }
                    }
                }
                    
            //}catch(e){xui.DragDrop._end()._reset();}finally{
               return false;
            //}
        },
        $onDrop:function(e){
            var d=xui.DragDrop,p=d._profile,evt=xui.Event;
//                try{
                e = e || window.event;

                // opera 9 down with
                // if(!isWorking){evt.stopBubble(e);return false;}
                d._end();
                if(p.isWorking){

                    //here, release drop face first
                    //users maybe use html() function in onDrop function
                    d.setDropFace();

                    var r = d._source.onDragstop(true,evt.getEventPara(e));
                    if(d._dropElement)
                        xui.use(d._dropElement).onDrop(true,evt.getEventPara(e));
                }
//                }catch(a){}finally{
                d._reset();
                evt.stopBubble(e);
                xui.tryF(document.onmouseup,[e]);
                return !!r;
//                }
        },
        setDropElement:function(id){
            this._profile.dropElement=this._dropElement=id;
            return this;
        },
        getProfile:function(){
            var d=this,p=d._profile;
            p.offset=d._proxy
            ?
            { x : d._proxyLeft-p.ox+d._cssPos_x,  y : d._proxyTop-p.oy+d._cssPos_y}
            :
            { x : p.x-p.ox,  y : p.y-p.oy}
            ;
            return p;
        },
        setDropFace:function(target, dragIcon){
            var d=this,
                s1='<div style="position:absolute;z-index:'+xui.Dom.TOP_ZINDEX+';font-size:0;line-height:0;border-',
                s2=":dashed 1px #ff6600;",
                region=d._Region,rh=d._rh, st, sl, 
                bg='backgroundColor';
            if(region && region.parent())
                region.remove(false);
            if(d._R){
                d._R.css(bg, d._RB);
                delete d._R;
                delete d._RB;
            }

            if(target){
                //never create, or destroy the region
                if(!region || !region.get(0)){
                    region=d._Region=xui.create(s1+'top:solid 2px #ff6600;left:0;top:0;width:100%;height:0;"></div>'+s1+'right'+s2+'right:0;top:0;height:100%;width:0;"></div>'+s1+'bottom'+s2+'bottom:0;left:0;width:100%;height:0;"></div>'+s1+'left'+s2+'width:0;left:0;top:0;height:100%;"></div>');
                    rh=d._rh=xui([region.get(1),region.get(3)]);
                }
                target=xui(target);
                if(xui.browser.ie6)rh.height('100%');
                if(target.css('display')=='block'){
                    xui.setNodeData(region.get(0),'zIndexIgnore', 1);
                    target.append(region);
                    // ensure in the view
                    region.top(st=target.scrollTop()).left(sl=target.scrollLeft());
                    region.get(2).style.top='auto';region.get(1).style.left='auto';
                    region.get(2).style.bottom='-'+st+'px';
                    region.get(1).style.right='-'+sl+'px';

                    if(xui.browser.ie6 && !rh.get(0).offsetHeight)
                        rh.height(target.get(0).offsetHeight);
                }else{
                    d._RB = target.get(0).style[bg];
                    d._R=target;
                    target.css(bg, '#FA8072');
                }
                d.setDragIcon(dragIcon||'move');
            }else
                d.setDragIcon('none');
            return d;
        },
        setDragIcon:function(key){
            //avoid other droppable targetNode's setDropFace disturbing.
            xui.resetRun('setDropFace', null);
            var d=this,p=d._profile,i=p.proxyNode,ic=d._Icons;
            if(i && p.dragType=='icon')
                i.first(4).css(typeof key=='object'?key:{backgroundPosition: (ic[key]||key)});
            return d;
        },
        _setProxy:function(child, pos){
            var t,temp,d=this,p=d._profile,dom=xui.Dom;
            if(!dom.byId(d._id))
                xui('body').prepend(
                    //&nbsp; for IE6
                    xui.create('<div id="' + d._id + '" style="left:0;top:0;border:0;font-size:0;line-height:0;padding:'+d.$proxySize+'px;position:absolute;background:url('+xui.ini.img_bg+') repeat;"><div style="font-size:0;line-height:0;" id="' +d._idi+ '">'+(xui.browser.ie6?'&nbsp;':'')+'</div></div>')
                );
            t=xui(d._id);
            //t.rotate('10');
            if(p.dragKey){
                d.$proxySize=0;
                t.css('padding',0);
            }else{
                pos.left -=  d.$proxySize;
                pos.top -= d.$proxySize;
                if(!p.targetOffsetParent)
                    dom.setCover(true,null,false,p.dragCursor);
            }
            if(temp=p.targetOffsetParent)
                xui(temp).append(t);

            if(child){
                xui(d._idi).empty(false).append(child);
                p.proxyNode = child;
            }else
                p.proxyNode = xui(d._idi);
            t.css({display:'',zIndex:dom.TOP_ZINDEX*10,cursor:p.dragCursor}).offset(pos, temp);
            xui.setNodeData(t.get(0),'zIndexIgnore', 1);

            return t;
        },
        _resetProxy:function(){
            var d=this, p=d._profile,
                dom=xui.Dom,
                id1=d._id,
                id2=d._idi;
            if(dom.byId(id1)){
                var t,k,o=xui(id2),t=xui(id1);
                //&nbsp; for IE6
                if(xui.browser.ie6)
                    o.html('&nbsp;');
                else o.empty();
                o.attr('style','font-size:0;line-height:0;');
                //o.rotate(0);
                xui('body').prepend(
                    t
                    .css({
                        zIndex:0,
                        cursor:'',
                        display:'none',
                        padding:Math.round(parseFloat(d.$proxySize))+'px'
                    })
                );
                p.proxyNode=d._proxystyle=null;
                dom.setCover(false);
            }
        },
        _pack:function(mousePos,targetNode){
            var target, pos={}, size={}, d=this, p=d._profile, t;
            // get abs pos (border corner)
            if(p.targetLeft===null || null===p.targetTop)
                t=targetNode.offset(null, p.targetOffsetParent);
            pos.left = null!==p.targetLeft?p.targetLeft: t.left;
            pos.top = null!==p.targetTop?p.targetTop: t.top;

            switch(p.dragType){
                case 'deep_copy':
                case 'copy':
                   var t;
                    size.width =  xui.isNumb(p.targetWidth)? p.targetWidth:(targetNode.cssSize().width||0);
                    size.height = xui.isNumb(p.targetHeight)?p.targetHeight:(targetNode.cssSize().height||0);
                    var n=targetNode.clone(p.dragType=='deep_copy')
                        .css({position:'relative',margin:'0',left:'0',top:'0',right:'',bottom:'',cursor:p.dragCursor,'cssFloat':'none'})
                        .cssSize(size)
                        .id('',true)
                        .css('opacity',0.8);

                    if(p.targetCallback)
                        p.targetCallback(n);

                    n.query('*').id('',true);
                    if(p.targetCSS)
                        n.css(p.targetCSS);
                    target = d._setProxy(n,pos);
                    break;
                case 'shape':
                    // get size
                    size.width = null!==p.targetWidth?p.targetWidth:targetNode.offsetWidth();
                    size.height = null!==p.targetHeight?p.targetHeight:targetNode.offsetHeight();
                    size.width-=2;size.height-=2;
                    target = d._setProxy(
                        xui.create('div').css({border:'dashed 1px',fontSize:'0',lineHeight:'0'}).cssSize(size)
                        ,pos);
                    break;
                case 'blank':
                    target = d._setProxy(null,pos);
                    break;
                case 'icon':
                    pos.left=xui.isNumb(p.targetLeft)?p.targetLeft:(mousePos.left /*- xui.win.scrollLeft()*/ + 16);
                    pos.top=xui.isNumb(p.targetTop)?p.targetTop:(mousePos.top /*- xui.win.scrollTop()*/ + 16);
                    t='<table border="0" class="xui-node xui-node-table"><tr><td valign="top"><span class="xui-node xui-node-span" style="background:url('+p.dragIcon+') no-repeat left top;width:'+(xui.isNumb(p.targetWidth)?p.targetWidth:16)+'px;height:'+(xui.isNumb(p.targetHeight)?p.targetHeight:16)+'px;" ></span></td><td id="xui:dd:shadow" '+(p.shadowFrom?'style="border:solid 1px #e5e5e5;background:#fff;font-size:12px;line-height:14px;"':'')+'>'+(p.shadowFrom?

                    xui(p.shadowFrom).clone(true)
                    .css({left:'auto',top:'auto', position:'relative'})
                    .outerHTML().replace(/\s*id\=[^\s\>]*/g,''):'')

                    +'</td></tr></table>';
                    target = d._setProxy(xui.create(t).css('opacity',0.8), pos);
                    break;
                case 'move':
                    d.$proxySize=0;
                    target=targetNode;
                    if(target.css('position') != 'absolute')
                        target.css('position','absolute').offset(pos);
                    target.css('cursor',p.dragCursor);
            }

            return target;
        },
        _unpack:function(){
            var d=this, p=d._profile, t,f;
            if(p.targetReposition && ("move" != p.dragType)){
                if((t=xui(d._source)))
                    if(!t.isEmpty()){
                        if(t.css('position')!= 'absolute')
                            t.css('position','absolute').cssPos(t.offset(null,t.get(0).offsetParent ));

                        //for ie bug
                        if(xui.browser.ie)
                            t.cssRegion({right:'',bottom:''});
                        t.offset(p.curPos, p.targetOffsetParent||document.body);
                    }
            }
            if("move" == p.dragType)
                d._source.css('cursor',d._cursor);
        },
        _unRegister:function(node, key){
            var eh=this._eh;
            xui([node])
                .$removeEvent('beforeMouseover', eh)
                .$removeEvent('beforeMouseout', eh)
                .$removeEvent('beforeMousemove', eh);

            var o=xui.getNodeData(node.$xid, ['_dropKeys']),c=xui.$cache.droppable;            
            if(o)
                for(var i in o)
                    if(c[i])
                        xui.arr.removeValue(c[i],node.$xid);

            xui.setNodeData(node.$xid, ['_dropKeys']);
        },
        _register:function(node, key){
            var eh=this._eh;
            xui(node)
                .beforeMouseover(function(p,e,i){
                    var t=xui.DragDrop, p=t._profile;
                    if(p.dragKey && xui.getNodeData(i,['_dropKeys', p.dragKey])){
                        t.setDropElement(i);
                        t._onDragover=null;
                        xui.use(i).onDragenter(true);
                        if(t._dropElement)
                            xui.resetRun('setDropFace', t.setDropFace, 0, [i], t);
                    }
                }, eh)
                .beforeMouseout(function(p,e,i){
                    var t=xui.DragDrop,p=t._profile;
                     if(p.dragKey && xui.getNodeData(i,['_dropKeys', p.dragKey])){
                        xui.use(i).onDragleave(true);
                        if(t._dropElement==i){
                            t.setDropElement(t._onDragover=null);
                            xui.resetRun('setDropFace', t.setDropFace, 0, [null], t);
                        }
                    }
                }, eh)
                .beforeMousemove(function(a,e,i){
                    var t=xui.DragDrop, h=t._onDragover, p=t._profile;
                    //no dragover event
                    if(h==1)return;
                    if(t._dropElement==i && p.dragKey && xui.getNodeData(i,['_dropKeys', p.dragKey])){
                        if(h)h(e,i);
                        else{
                            //ensure to run once only
                            t._onDragover=1;
                            //if any dragover event exists, this function will set _onDragover
                            xui.use(i).onDragover(true,xui.Event.getEventPara(e));
                        }
                    }
                }, eh);

            var o=xui.getNodeData(node.$xid, ['_dropKeys']),c=xui.$cache.droppable;            
            if(o)
                for(var i in o)
                    if(c[i])
                        xui.arr.removeValue(c[i],node.$xid);

            var h={},a=key.split(/[^\w-]+/)
            for(var i=0,l=a.length;i<l;i++){
                h[a[i]]=1;
                c[a[i]]=c[a[i]]||[];
                c[a[i]].push(node.$xid);
            }
            xui.setNodeData(node.$xid, ['_dropKeys'], h);
            
        }
    },
    After:function(){
        this._reset();
        //add dom dd functions
        xui.each({
            startDrag:function(e, profile, dragKey, dragData){
                xui.DragDrop.startDrag(e, this.get(0), profile, dragKey||'', dragData||null);
                return this;
            },
            draggable:function(flag, profile, dragKey, dragData, target){
                var self=this,
                    target=target?typeof(target)=="function"?xui.tryF(getTarget,[],this):xui(target):null, 
                    dd=xui.DragDrop;
                if(!target || !target.get(0)){
                    target=self;
                }
                self.addClass('xui-ui-unselectable');
                if(flag===undefined)
                    flag=true;
                else if(typeof flag=='object'){
                    profile=flag;
                    flag=true;
                }
                var f=function(p,e,src){
                    if(xui.getId(xui.Event.getSrc(e))!=src)return true;
                    target.startDrag(e, profile, dragKey, dragData);
                };

                if(!!flag){
                    self.$addEvent('beforeMousedown',f, dd._eh, -1);
                }else{
                    self.$removeEvent('beforeMousedown', dd._eh);
                }

                return self;
            },
            droppable:function(flag, key){
                if(flag===undefined)flag=true;
                key = key || 'default';
                var d=xui.DragDrop;
                return this.each(function(o){
                    if(!!flag)
                        d._register(o, key);
                    else
                        d._unRegister(o, key);
                });
            }
        },function(o,i){
            xui.Dom.plugIn(i,o);
        });
    }
});//singleton
xui.Class("xui.Tips", null,{
    Constructor:function(){return null},
    Initialize:function(){
        if(xui.browser.fakeTouch)return;
        var dd=xui.DragDrop,
            tips=this;
        if(dd)
            dd.$reset=function(){
                tips._pos={left:dd._profile.x,top:dd._profile.y}
            };

        //for: span(display:-moz-inline-box) cant wrap in firefox
        xui.CSS.addStyleSheet(
            ".xui-tips{position:absolute;overflow:visible;visibility:hidden;left:-10000px;border-radius:1px;} "+
            ".xui-tips-i{overflow:hidden;position:relative;}"+
            ".xui-tips-i span{display:inline;}"+
            ".xui-tips-c{padding:.125em .25em .25em .25em;}"+
            ".xui-tips-c *{line-height:1.22em;}"+
            ".xui-tips .xui-tips-c{border-radius:1px;}"
        , this.KEY);

        xui.doc
        .afterMousedown(function(){
            tips._cancel();
        },'$Tips',-1)
        .afterMousemove(function(obj, e){
            if(dd.isWorking)return;
            var event=xui.Event,p,n;

            if((p=xui.resetRun.$cache) && p['$Tips']){
                tips._pos=event.getPos(e);
            }

            //it's first show
            if(tips._from){
                tips._pos=event.getPos(e);
                tips._showF();
                xui.resetRun('$Tips3');
            //after show, before hide
            }else if(tips._showed && tips.MOVABLE){
                p=event.getPos(e);
                n=tips._Node.style;
                n.left = Math.min(tips._tpl._ww-tips._tpl._w, Math.max(0, Math.round((parseFloat(n.left)||0) + (p.left-tips._pos.left), 10))) + 'px';
                n.top = Math.min(tips._tpl._hh-tips._tpl._h, Math.max(0, Math.round((parseFloat(n.top)||0) + (p.top-tips._pos.top), 10))) + 'px';
                
                tips._pos=p;
            }
        },'$Tips',-1)
        .afterMouseover(function(obj, e){
            var event=xui.Event,
                rt=event.$FALSE,
                node=event.getSrc(e),
                id,
                _from,
                tempid,evid,
                index=0,
                pass,
                rtn=function(rt){
                    if(tips._markId)tips._cancel()
                    return rt;
                };
            if(!node)
                return rtn(rt);
            try{
                //for inner renderer
                while((!node.id || node.id==xui.$localeDomId) && node.parentNode!==document && index++<10)
                    node=node.parentNode;
                if(!(id=(typeof node.id=="string"?node.id:null))){
                    node=null;
                    return rtn(rt);
                }
            }catch(e){}

            //check id
            if((_from=event._getProfile(id)) && _from.box && _from.KEY=='xui.UIProfile'){
                if(_from.properties.disableTips || _from.behavior.disableTips){
                    node=null;
                    return rtn(false);
                }

                var nt=_from.behavior.NoTips;
                if(nt){
                    for(var i=0,l=nt.length;i<l;i++){
                        if(id.indexOf(_from.keys[nt[i]])===0)
                            return rtn(false);
                    }
                }
                nt=_from.behavior.PanelKeys;
                if(nt){
                    for(var i=0,l=nt.length;i<l;i++){
                        if(id.indexOf(_from.keys[nt[i]])===0)
                            return rtn(false);
                    }
                }
                nt=_from.behavior.HoverEffected;
                //if onShowTips exists, use seprated id, or use item scope id
                tempid=_from.onShowTips?id:id.replace(tips._reg,
                //if HoverEffected exists, use seprated id
                function(a,b){
                    return nt&&(b in nt)?a:':';
                });
                if(tips._markId && tempid==tips._markId)
                    return rt;

                //set mark id
                tips._markId = tempid;
                tips._pos=event.getPos(e);

                if(tips._showed){
                    tips._from=_from;
                    tips._enode=id;
                    tips._showF();
                }else
                    xui.resetRun('$Tips', function(){
                        tips._from=_from;
                        tips._enode=id;
                        // if mouse stop move
                        xui.resetRun('$Tips3', function(){
                            if(tips._from)
                                tips._showF();
                        });
                    }, tips.DELAYTIME);
            }else
                tips._cancel();

            node=null;
            return rt;
        },'$Tips',-1)
        .afterMouseout(function(obj, e){
            if(tips._markId){
                var event=xui.Event,
                    id,
                    clear,
                    index=0,
                    node = e.toElement||e.relatedTarget;

                if(!node)
                    clear=1;
                else{
                    //for firefox wearing anynomous div in input/textarea
                    try{
                        //for inner renderer
                        while((!node.id || node.id==xui.$localeDomId) && node.parentNode!==document && index++<10)
                            node=node.parentNode;
                        if(!(id=(typeof node.id=="string"?node.id:null))){
                            node=null;
                            clear=1;
                        }
                    }catch(e){clear=1}
                }
                if(clear)
                    tips._cancel();
                return event.$FALSE;
            }
        },'$Tips',-1)
        .afterMouseup(function(obj, e){
            tips._cancel();
        },'$Tips',-1);

        this._Types = {
            'default' : new function(){
                this.show=function(item, pos, key){
                    //if trigger onmouseover before onmousemove, pos will be undefined
                    if(!pos)return;

                    var self=this,node,_ruler,s,w,h;
                    if(!(node=self.node) || !node.get(0)){
                        node = self.node = xui.create('<div class="xui-node xui-node-div xui-tips  xui-ui-shadow xui-custom"><div class="xui-node xui-wrapper xui-node-div xui-tips-i xui-custom"></div></div>');
                        _ruler = self._ruler = xui.create('<div class="xui-node xui-wrapper xui-node-div xui-tips  xui-ui-shadow xui-custom"><div class="xui-node xui-node-div xui-tips-i xui-custom"></div></div>');
                        self.n = node.first();
                        self._n = _ruler.first();
                        xui('body').append(_ruler);
                    }
                    _ruler = self._ruler;
                    //ensure zindex is the top
                    if(document.body.lastChild!=node.get(0))
                        xui('body').append(node,false,true);

                    s = typeof item=='object'? item[key||xui.Tips.TIPSKEY] :item ;
                    if(typeof s=='function')
                        s=s();
                    if(s+=""){
                        var html=/^\s*\</.test(s);
                        //get string
                        s=xui.adjustRes(s);
                        xui.Tips._curTips=s;
                        if(!item.transTips || !html)
                            s='<div class="xui-ui-ctrl xui-node xui-node-div  xui-uiborder-flat xui-uicell-alt xui-node-tips xui-tips-c xui-custom">'+s+'</div>';
                        //set to this one
                        self._n.get(0).innerHTML=s;

                        self._ww=xui.win.width();
                        self._hh=xui.win.height();

                        //get width
                        w=Math.min(html?self._ww:tips.MAXWIDTH, _ruler.get(0).offsetWidth + 2);

                        //set content, AND dimension
                        var style=node.get(0).style, t1=self.n.get(0),styleI=t1.style;
                        //hide first
                        style.visibility='hidden';
                        //set content
                        t1.innerHTML=s;
                        //set dimension
                        if(xui.browser.ie){
                            style.width=styleI.width=(self._w=Math.round(w+(w%2)))+'px';
                            h=t1.offsetHeight;
                            style.height=(self._h=Math.round(h-(h%2)))+'px';
                        }else{
                            styleI.width=(self._w=Math.round(w))+'px';
                            self._h=self.n.height();
                        }

                        if(pos===true){
                            style.visibility='visible';
                        }else{
                            //pop(visible too)
                            node.popToTop((pos['xui.UI'] || pos['xui.UIProfile'] || pos['xui.Dom'] || pos.nodeType==1 || typeof pos=='string')?pos:{left:pos.left,top:pos.top,region:{
                                left:pos.left,
                                top:pos.top-12,
                                width:24,
                                height:32
                            }},1);
                        }
                        
                        style=styleI=t1=null;
                    }else
                        node.css('zIndex',0).hide();
                };
                this.hide = function(){
                    this.node.css('zIndex',0).hide();
                };
            }/*,
            'animate' : new function(){
                this.threadid='$tips:1$';
                this.show=function(item, pos){
                    if(!this.node){
                        this.node = xui.create('<div class="xui-node xui-node-div xui-custom" style="position:absolute;border:solid gray 1px;background-color:#FFF1A0;padding:.5em;overflow:hidden;"></div>');
                        xui('body').append(this.node);
                    }
                    pos.left+=12;
                    pos.top+=12;
                    var s=item.tips;
                    s = s.charAt(0)=='$'?xui.wrapRes(s.slice(1)):s;
                    this.node.html(s).css('zIndex',xui.Dom.TOP_ZINDEX).cssPos(pos);
                    var w=this.node.width(),h=this.node.height();
                    this.node.cssSize({ width :0, height :0}).css('display','block').animate({width:[0,w],height:[0,h]},0,0,300,0,'expoOut',this.threadid).start();
                };
                this.hide = function(){
                    xui.Thread.abort(this.threadid);
                    this.node.height('auto').width('auto').css('display','none').css('zIndex',0);
                };
            }*/
        };
    },
    Static:{
        _reg:/-([\w]+):/,
        TIPSKEY:'tips',
        MAXWIDTH:600,
        MOVABLE:true,
        DELAYTIME:400,
        AUTOHIDETIME:5000,

        _showF:function(){
            if(xui.browser.fakeTouch)return;
            var self=this,
                _from=self._from,
                node=xui.Dom.byId(self._enode),
                pos=self._pos,
                id,
                o,t,b=true;

            self._from=self._enode=null;

            if(!node || !_from || !pos || !(o=_from.box))return;

            //1.CF.showTips
            b=false!==((t=_from.CF) && (t=t.showTips) && t(_from, node, pos));
            //2._showTips / onShowTips
            //check if showTips works
            if(b!==false)b=false!==(_from._showTips && _from._showTips(_from, node, pos));
            //check if showTips works
            if(b!==false)b=false!==(o._showTips && o._showTips(_from, node, pos));

            //default tips var(profile.tips > profile.properties.tips)
            if(b!==false){
                if(((t=_from) && t.tips)||(t && (t=t.properties) && t.tips)){
                    self.show(pos, t);
                    b=false;
                }
                else if((t=_from) && (t=t.properties) && t.autoTips && ('caption' in t)
                    // if tips is default value, try to show caption
                    // you can settips to null or undefined to stop it
                    && t.tips===''
                    ){
                    if(t.caption||t.labelCaption){
                        self.show(pos, {tips:t.caption||t.labelCaption});
                        b=false;
                    }
                }
            }

            //no work hide it
            if(b!==false){
                self.hide();
            }else {
                if(!self.MOVABLE)
                    xui.resetRun('$Tips2', self.hide,self.AUTOHIDETIME,null,self);
            }
            node=pos=_from=null;
        },
        getTips:function(){
            return this._curTips;
        },
        setTips:function(s){
            if(this._curTips && this._tpl&& this._Node){
                this._tpl.show(s, true);
            }
        },
        setPos:function(left,top){
            var n=this;
            if((n=n._Node)&&(n=n.style)){
                if(left||left===0)n.left=Math.round(parseFloat(left))+'px';
                if(top||top===0)n.top=Math.round(parseFloat(top))+'px';
            }
        },
        show:function(pos, item, key){
            var self=this,t;
            //for mousemove
            self._pos=pos;
            //same item, return
            if(self._item === item)return;

            //hide first
            //if(self._tpl)self._tpl.hide();

            //base check
            if(typeof item =='string' || (item && (item[key||xui.Tips.TIPSKEY]))){
                //get template
                t = self._tpl = self._Types[item.tipsTemplate] || self._Types['default'];
                t.show(item,pos,key);
                self._Node=t.node.get(0);
                self._item=item;
                self._showed = true;
            }else
                self._cancel();
        },
        hide:function(){
            var self=this;
            if(self._showed){
                if(self._tpl)self._tpl.hide();
                self._clear();
            }
        },
        _cancel:function(){
            var self=this;
            if(self._markId){
                if(self._showed){
                    self.hide();
                }else{
                    xui.resetRun('$Tips');
                    xui.resetRun('$Tips3');
                    self._clear();
                }
            }
        },
        _clear:function(){
            var self=this;
            self._Node=self._curTips=self._markId = self._from=self._tpl = self._item = self._showed = null;
        }
    }
});xui.Class("xui.History",null,{
    Static:{
        activate:function(){
            var self=this;
            if(self._activited)return;
            self._activited=1;
            switch(self._type){
                case 'event':
                    window.onhashchange=self._checker;
                break;
                case "iframe":
                    document.body.appendChild(document.createElement('<iframe id="'+self._fid+'" src="about:blank" style="display: none;"></iframe>'));
                    var doc=document.getElementById(self._fid).contentWindow.document;
                    doc.open("javascript:'<html></html>'");
                    doc.write("<html><head><scri" + "pt type=\"text/javascript\">parent.xui.History._checker('"+hash+"');</scri" + "pt></head><body></body></html>");
                    doc.close();
                case 'timer':
                    if(self._itimer)
                        clearInterval(self._itimer);
                    self._itimer = setInterval(self._checker, 200);
                break;
            }
        },
        _fid:'xui:history',
        _type:(xui.browser.ie && (xui.browser.ver<8))?'iframe':("onhashchange" in window)?'event':'timer',
        _callbackTag:null,
        _callbackArr:null,
        _inner_callback:null,
        _callback:function(fragment, init, newAdd){
            var ns=this, arr, f;
            xui.arr.each(xui.Module._cache,function(m){
              // by created order    
               if(m._evsClsBuildIn && ('onFragmentChanged' in m._evsClsBuildIn)){
                   // function or pseudocode
                   if(xui.isFun(f = m._evsClsBuildIn.onFragmentChanged) || (xui.isArr(f) && f[0].type)){
                       m.fireEvent('onFragmentChanged', [m,fragment, init, newAdd]);
                   }
               }
               else if(m._evsPClsBuildIn && ('onFragmentChanged' in m._evsPClsBuildIn)){
                   // function or pseudocode
                   if(xui.isFun(f = m._evsPClsBuildIn.onFragmentChanged) || (xui.isArr(f) && f[0].type)){
                       m.fireEvent('onFragmentChanged', [m,fragment, init, newAdd]);
                   }
               }
            });
            // tag
            if(xui.isFun(ns._callbackTag) && false===ns._callbackTag(fragment, init, newAdd))return;
            // tagVar
            arr = ns._callbackArr;
            if(arr&&xui.isArr(arr)){
                for(var i=0,l=arr.length;i<l;i++){
                    if(xui.isFun(arr[i]) && false===arr[i](fragment, init, newAdd))
                        return;
                }
            }
            // the last one
            if(xui.isFun(ns._inner_callback))ns._inner_callback(fragment, init, newAdd);
        },
        /* set callback function
        callback: function(hashStr<"string after #!">)
        */
        setCallback: function(callback){
            var self=this,
                hash = location.hash;
            if(hash)hash='#!' + encodeURIComponent((''+decodeURIComponent(hash)).replace(/^#!/,''));
            else hash="#!";
            self._inner_callback = callback;

            self._lastFI = decodeURIComponent(hash);

            self._callback(decodeURIComponent(self._lastFI.replace(/^#!/, '')), true, callback);

            return self;
        },
        _checker: function(hash){
            var self=xui.History;
            switch(self._type){
                case "iframe":
                    if(xui.isSet(hash))
                        location.hash=hash;
                case 'event':
                case 'timer':
                    if(decodeURIComponent(location.hash) != decodeURIComponent(self._lastFI)) {
                        self._lastFI = decodeURIComponent(location.hash);
                        self._callback(decodeURIComponent(location.hash.replace(/^#(!)?/, '')));
                    }
                break;
            }
        },
        getFI:function(){
            return this._lastFI;
        },
        /*change Fragement Identifier(string after '#!')
        */
        setFI:function(fi,triggerCallback,merge){
            var self=this;
            
            self.activate();

            // ensure encode once
            if(fi){
                if(!xui.isHash(fi))fi=xui.urlDecode((fi+'').replace(/^#!/,'')); //encodeURIComponent((''+decodeURIComponent(fi)).replace(/^#!/,''));
                if(merge)fi = xui.merge(fi, xui.getUrlParams(), 'without');
                fi='#!' + xui.urlEncode(fi);
            }else{
                fi="#!";
            }
            if(self._lastFI == decodeURIComponent(fi))return false;

            switch(self._type){
                case "iframe":
                    var doc=document.getElementById(self._fid).contentWindow.document;
                    doc.open("javascript:'<html></html>'");
                    doc.write("<html><head><scri" + "pt type=\"text/javascript\">parent.xui.History._checker('"+fi+"');</scri" + "pt></head><body></body></html>");
                    doc.close();
                break;
                case 'event':
                case 'timer':
                    location.hash = self._lastFI = decodeURIComponent(fi);
                if(triggerCallback!==false)
                    self._callback(decodeURIComponent(fi.replace(/^#!/,'')));
                break;
            }
        }
    }
});xui.Class('xui.ModuleFactory',null,{
    Initialize:function(){
        var ns=this;
        xui.getModule=function(cls, onEnd, threadid, cached, properties, events){
            return ns.getModule.apply(ns,arguments)
        };
        xui.newModule=function(cls, onEnd, threadid, properties, events){
            return ns.newModule.apply(ns,arguments)
        };
        xui.showModule=function(cls, beforeShow, onEnd, threadid, cached, properties, events, parent, subId, left, top){
            return ns.getModule(cls, function(err, module, threadid){
                if(!err && false!==xui.tryF(beforeShow, [module, threadid], module)){
                    this.show.apply(module, [onEnd,parent,subId,threadid,left,top]);
                }else{
                    xui.tryF(onEnd, [err, module, threadid], module);
                }
            }, threadid, cached, properties, events);
        };

        //compitable
        xui.getCom=xui.getModule;
        xui.newCom=xui.newModule;
        xui.showCom=xui.showModule;

        ns.setCom=ns.setModule;
        ns.getComFromCache=ns.getModuleFromCache;
        ns.getCom=ns.getModule;
        ns.newCom=ns.newModule;
        ns.storeCom=ns.storeModule;
        ns.prepareComs=ns.prepareModules;

        xui.ComFactory=ns;
    },
    Static:{
        _pro:{},
        _cache:{},
        _domId:'xui:ModuleFactory:',
        getProfile:function(key){
            return key?this._pro[key]:this._pro;
        },
        setProfile:function(key, value){
            if(typeof key=='string')
                this._pro[key]=value;
            else if(xui.isHash(key))
                this._pro=key;
            return this;
        },
        destroyAll:function(){
            xui.each(this._cache,function(o){
                xui.tryF(o.destroy,[],o);
            });
            this._cache={};
        },
        broadcast:function(fun){
            if(typeof fun=='function'){
                var i,c=this._cache;
                for(i in c)
                    fun.call(c[i],i);
            }
        },

        setModule:function(id, obj){
            this._cache[id]=obj;
            if(obj)obj.moduleRefId=id;
            return this;
        },
        getModuleFromCache:function(id){
            return this._cache[id]||null;
        },
        //cached:false->don't get it from cache, and don't cache the result.
        getModule:function(id, onEnd, threadid, cached, properties, events){
            if(!id){
                var e=new Error("No id");
                xui.tryF(onEnd,[e,null,threadid]);
                if(threadid&&xui.Thread.isAlive(threadid))xui.Thread(threadid).abort();
                throw e;
                return;
            }
            cached=cached!==false;
            var c=this._cache,
                p=this._pro,
                config,
                clsPath;

            if(cached && c[id] && !c[id].destroyed){
                xui.tryF(onEnd, [null,c[id],threadid], c[id]);
                return c[id];
            }else{
                // if no configure
                if(!(config=p[id])){
                    config={
                        cls:id,
                        cached:cached,
                        properties:properties,
                        events:events
                    };
                    clsPath=id;
                }else
                    clsPath=config.cls || config;

                var self=arguments.callee, 
                    me=this,
                    task=function(cls,config,threadid){
                        if(!xui.isFun(cls))
                            throw "'"+clsPath+"' is not a constructor";
                        var o = new cls();

                        if(config.properties)
                            xui.merge(o.properties,config.properties,'all');
                        if(config.events)
                            xui.merge(o.events,config.events,'all');
                        if(config.cached!==false)
                            xui.ModuleFactory.setModule(id, o);

                        var args = [function(err,module,threadid){
                            var arr = module.getUIComponents().get(),
                                fun=function(arr,subcfg,firstlayer){
                                    var self1 = arguments.callee;
                                    xui.arr.each(arr,function(v,i){
                                        if(v.children){
                                            var a=[];
                                            xui.arr.each(v.children,function(o){
                                                a[a.length]=o[0];
                                            });
                                            self1(a, subcfg);
                                        }
                                    });
                                };
                            //handle tag sub from module
                            fun(arr,config.children,1);
                        }];
                        args.push(threadid||null);

                        //insert first
                        if(onEnd)
                            xui.Thread(threadid).insert({
                                task:onEnd,
                                args:[null,o,threadid],
                                scope:o
                            });
                        //latter
                        xui.tryF(o[config.iniMethod ||'create'], args, o);
                    };
                xui.Thread.observableRun(function(threadid){
                    var f=function(threadid){
                        // this for js path doesn't match Class name space
                        var cls=this||xui.SC.get(clsPath);
                        // it must be a xui Class
                        if(cls&&cls.$xui$){
                            xui.Thread(threadid).insert({
                                task:task,
                                args:[cls, config,threadid]
                            });
                        }else{
                            var e=new Error("Cant find Class '"+clsPath+"' in the corresponding file (maybe SyntaxError)");
                            xui.tryF(onEnd,[e,null,threadid]);
                            if(threadid&&xui.Thread.isAlive(threadid))xui.Thread(threadid).abort();
                            throw e;
                        }
                    };
                    xui.SC(clsPath, function(path){
                        if(path)
                            f.call(this, threadid);
                        else{
                            var e=new Error("No class name");
                            xui.tryF(onEnd,[e,null, threadid]);
                            if(threadid&&xui.Thread.isAlive(threadid))xui.Thread(threadid).abort();
                            throw e;
                        }
                    }, true,threadid,{
                        retry:0,
                        onFail:function(e){
                            xui.tryF(onEnd,[e,null,threadid]);
                        }
                    });
                },null,threadid);
            }
        },
        newModule:function(cls, onEnd, threadid, properties, events){
            return this.getModule(cls, onEnd, threadid, false, properties, events);
        },
        storeModule:function(id){
            var m,t,c=this._cache,domId=this._domId;
            if(t=c[id]){
                if(!(m=xui.Dom.byId(domId)))
                    //using display:none here for performance, when appendchild, it'll not trigger layout etc.
                    xui('body').prepend(xui.create('<div id="'+domId+'" style="display:none;"></div>'));
                m=xui(domId);
                t=t.getUIComponents();
                if(!t.isEmpty()){
                    //detach
                    t.get(0).unlinkParent();
                    //move to hide
                    m.append(t);
                }
            }
        },
        prepareModules:function(arr){
            var self=this,funs=[];
            xui.arr.each(arr, function(i){
                funs.push(function(){
                    self.getModule(i);
                });
            });
            xui.Thread(null, funs, 500).start();
            return this;
        }
    }
});xui.Class('xui.Debugger', null, {
    Static:{
        $time:xui.stamp(),
        _id1:'xui:dbg::_frm',
        _id4:'xui:dbg::_head',
        _id2:'xui:dbg::_con',
        _id3:'xui:dbg::_inp',
        err:function(sMsg,sUrl,sLine){
            if(xui.browser.gek && sMsg=='Error loading script')
                return true;
            xui.Debugger.log('>>' + sMsg+' at File: '+ sUrl + ' ( line ' + sLine + ' ).');
            return true;
        },
        trace:function(obj){
            var args=xui.toArr(arguments),
                fun=args[1]||arguments.callee.caller,
                arr=args[2]||[];
            if(fun){
                arr.push('function "' + (fun.$name$||'') + '" in Class "' + (fun.$original$||'') +'"');
                if(fun.caller){
                    try{
                        arguments.callee(null,fun.caller,arr,1);
                    }catch(e){}
                }
            }
            if(!args[3]){
                var a=[];
                a.push(' >> Object Info:');
                if(typeof obj == 'object')
                    for(var i in obj)
                        a.push(' -- ' + i + " : " + obj[i]);
                else
                    a.push(obj);
                a.push(' >> Function Trace: ' + arr.join(' <= '));
                xui.Debugger.log.apply(xui.Debugger,a);
            }
            fun=null;
        },
        log:function(){
            var t1,t2,time,self=this,arr=xui.toArr(arguments),str;
            if(!arr.length)return;

            t1 = document.createElement("div");
            t2 = document.createElement("div");
            t2.className='xui-uibase xui-dbg-con1';
            time=xui.stamp();
            t2.appendChild(document.createTextNode('Time stamp : '+time +'('+(time-self.$time)+')' ));
            self.$time=time;
            t1.appendChild(t2);
            for(var i=0,l=arr.length;i<l;i++){
                str=arr[i];
                t2 = document.createElement("div");
                t2.className='xui-uibase xui-dbg-con2';
                t2.appendChild(document.createTextNode(" "+xui.stringify(xui.isArguments(str)?xui.toArr(str):str)));
                t1.appendChild(t2);
            }

            if(!xui.Dom.byId(self._id2)){
                var ns=xui.create('<div id='+self._id1+' style="left:5px;top:'+(xui.win.scrollTop()+5)+'px;" class="xui-ui-reset xui-node xui-node-div xui-wrapper xui-dbg-frm xui-custom"><div class="xui-node xui-node-div xui-dbg-box xui-custom"><div id='+self._id4+' class="xui-node xui-node-div xui-uibar xui-dbg-header xui-custom">&nbsp;&nbsp;:&nbsp;)&nbsp;&nbsp;CrossUI Monitor window <span class="xui-node xui-node-span xui-dbg-cmds xui-custom"><a class="xui-node xui-node-a xui-custom" href="javascript:;" onclick="xui(\''+self._id2+'\').empty();">Clear</a><a class="xui-node xui-node-a xui-custom" href="javascript:;" onclick="xui(\''+self._id1+'\').remove();"></a></span></div><div id='+self._id2+' class="xui-node xui-node-div xui-uibase xui-dbg-content xui-custom"></div><div class="xui-node xui-node-div xui-uibase xui-dbg-tail xui-custom"><table class="xui-node xui-node-table xui-custom"><tr><td style="font-family:serif;">&nbsp;>>>&nbsp;</td><td style="width:100%"><input class="xui-node xui-node-input xui-custom" id='+self._id3+' /></td></tr></table></div></div></div>');
                xui('body').append(ns);
                self.$con=xui(self._id2);
                xui(self._id4).draggable(true,null,null,null,xui(self._id4).parent(2));

                if(xui.Dom.css3Support("boxShadow")){
                    ns.css("boxShadow","2px 2px 5px #ababab");
                }

                if(xui.browser.ie6){
                    ns.height(ns.offsetHeight());
                    ns.width(299);
                    xui.asyRun(function(){ns.width(300);})
                }
                var bak='',temp;
                xui(self._id3).onKeydown(function(p,e,s){
                    var k=xui.Event.getKey(e).key;
                    s=xui.use(s).get(0);
                    if(k=='enter'){
                        switch(s.value){
                            case '?':
                            case 'help':
                                self.$con.append(xui.create("<div class='xui-node xui-node-div xui-uibase xui-dbg-con3 xui-custom'><p class='xui-node xui-node-p xui-custom'><strong  class='xui-node xui-node-strong xui-custom'>vailable commands:</strong></p><ul  class='xui-node xui-node-ul xui-custom'><li  class='xui-node xui-node-li xui-custom'> -- <strong  class='xui-node xui-node-strong xui-custom'>[clr]</strong> or <strong>[clear]</strong> : clears the message</li><li  class='xui-node xui-node-li xui-custom'> -- <strong  class='xui-node xui-node-strong xui-custom'>[?]</strong> or <strong  class='xui-node xui-node-strong xui-custom'>[help]</strong> : shows this message</li><li  class='xui-node xui-node-li xui-custom'> -- <strong class='xui-node xui-node-strong xui-custom'>any other</strong>: shows its string representation</li></ul></div>"));
                                break;
                            case 'clr':
                            case 'clear':
                                xui(self._id2).empty();
                                break;
                            default:
                                try{
                                    temp=s.value;
                                    if(/^\s*\x7b/.test(temp))temp='('+temp+')';
                                    self.log(eval(temp));
                                }catch(e){self.$con.append(xui.create("<div  class='xui-node xui-node-div xui-uibase xui-dbg-con4 xui-custom'>"+String(e)+"</div>"));return;}
                        }
                        bak=s.value;
                        s.value='';
                    }else if(k=='up'||k=='down'){
                        var a=s.value;
                        s.value=bak||'';
                        bak=a;
                    }
                    k=s=temp=bak=null;
                });
            }
            self.$con.append(t1).scrollTop(self.$con.scrollHeight());
            t1=t2=null;
        }
    },
    Initialize:function(){
        xui.CSS.addStyleSheet(
            '.xui-dbg-frm{position:absolute;width:25em;z-index:2000;}'+
            '.xui-dbg-header{cursor:move;height:1.5em;padding-top:.25em;position:relative;border-bottom:solid 1px #CCC;background-color:#FFAB3F;font-weight:bold;}'+
            '.xui-dbg-cmds{position:absolute;right:.25em;top:.25em;}'+
            '.xui-dbg-cmds a{margin:.25em;}'+
            '.xui-dbg-box{position:relative;overflow:hidden;border:solid 1px #AAA;}'+
            '.xui-dbg-content{position:relative;width:100%;overflow:auto;height:25em;overflow-x:hidden;}'+
            '.xui-dbg-con1{background-color:#CCC;width:24.5empx;}'+
            '.xui-dbg-con2{padding-left:.5em;border-bottom:dashed 1px #CCC;width:24.5em;}'+
            '.xui-dbg-con3{padding-left:.5em;border-bottom:dashed 1px #CCC;background:#EEE;color:#0000ff;width:24.5em;}'+
            '.xui-dbg-con4{padding-left:.5em;border-bottom:dashed 1px #CCC;background:#EEE;color:#ff0000;width:24.5em;}'+
            '.xui-dbg-tail{overflow:hidden;position:relative;border-top:solid 1px #CCC;height:1.3333333333333333em;background:#fff;color:#0000ff;}'+
            '.xui-dbg-tail input{width:100%;border:0;background:transparent;}'
        ,this.KEY);
        //fix ie6:

        //shorcut
        xui.echo = function(){
            if(!xui.debugMode)return false;
            xui.Debugger.log.apply(xui.Debugger,xui.toArr(arguments));
        };
        xui.message = function(body, head, width, duration){
           width = width || 300;
           if(xui.browser.ie)width=width+(width%2);
           var div, h, me=arguments.callee,
           stack=me.stack||(me.stack=[]),
           allmsg=me.allmsg||(me.allmsg=[]),
           t=xui.win, left = t.scrollLeft() + t.width()/2 - width/2, height=t.height(), st=t.scrollTop();

           div=stack.pop();
           while(div&&!div.get(0))
                div=stack.pop();

           if(!div){
               div =
               '<div class="xui-ui-reset xui-node xui-node-div xui-wrapper xui-uibar xui-uiborder-outset xui-custom" style="border:solid 1px #cdcdcd;position:absolute;overflow:visible;top:-50px;">' +
                   '<div class="xui-node xui-node-div xui-custom" style="font-size:1.25em;overflow:hidden;font-weight:bold;padding:.25em;"></div>'+
                   '<div class="xui-node xui-node-div xui-custom" style="font-size:1em;padding:.5em;overflow:hidden;"></div>'+
               '</div>';
               div = xui.create(div);
               if(div.addBorder)div.addBorder();
               allmsg.push(div);
               if(xui.Dom.css3Support("boxShadow")){
                    div.css("boxShadow","2px 2px 5px #ababab");
               }
            }
            if(document.body.lastChild!=div.get(0))
                xui('body').append(div,false,true);

            div.topZindex(true);

            div.__hide=0;

            div.css({left:left+'px', width:width+'px', visibility:'visible'})
            .first().html(head||'').css('display',head?'':'none')
            .next().html(body||'');

            if(xui.browser.ie && xui.browser.ver<=8)
                div.ieRemedy();

            if(me.last && me.last.get(0) && div!=me.last){
                var last=me.last;
                var l=last.left();
                if(last._thread&&last._thread.id&&last._thread.isAlive())last._thread.abort();
                last._thread=last.animate({left:[l,l+(last.width+width)/2+20]},function(){
                    last.left(l);
                },function(){
                    last.left(l+(last.width+width)/2+20);
                }).start();
                
                var lh=last.offsetHeight();
               xui.filter(allmsg,function(ind){
                    if(ind.isEmpty())
                        return false;
                   if(!ind.__hide && ind!=div && ind!=last){
                       if(ind._thread.id&&ind._thread.isAlive())
                            ind._thread.abort();
                       ind.topBy(lh);
                    }
               });

            }
            me.last = div;
            me.last.width = width;

            //height() is ok
            h = div.height();

            if(xui.browser.ie6)div.cssSize({ height :h, width :width+2});

            if(div._thread&&div._thread.id&&div._thread.isAlive())div._thread.abort();
            div._thread=div.animate({top:[st-h-20,st+20]},function(){
                div.top(st-h-20);
            },function(){
                div.top(st+20);
            },300,0,'expoOut').start();

            xui.asyRun(function(){
                if(div._thread&&div._thread.id&&div._thread.isAlive())div._thread.abort();
                div._thread=div.animate({top:[div.top(), height+20]},null,function(){
                     stack.push(div); 
                     div.hide();
                     div.__hide=1;
                },300,0).start();
            }, duration||5000);
            me=null;
        };

        if(xui.isDefined(window.console) && (typeof window.console.log=="function")){
            xui.log=function(){window.console.log.apply(window.console,xui.toArr(arguments));};
        }else if(xui.debugMode){
            xui.log=xui.echo;
            window.onerror=this.err;
        }
    }
});new function(){
    xui.builtinFontIcon={
        "xui-icon-xui":'&#xe61b;',
        "xui-load-error":'&#xe682;',
        "xui-icon-numbers":'&#xe681;',
        "xui-icon-number0":'&#xe67c;',
        "xui-icon-number1":'&#xe67d;',
        "xui-icon-number2":'&#xe680;',
        "xui-icon-number3":'&#xe67b;',
        "xui-icon-number4":'&#xe64c;',
        "xui-icon-number5":'&#xe61c;',
        "xui-icon-number6":'&#xe67a;',
        "xui-icon-number7":'&#xe65a;',
        "xui-icon-number8":'&#xe67e;',
        "xui-icon-number9":'&#xe67f;',
        "xui-icon-placeholder":'&#xe62c;',
        "xui-icon-empty": '&#xe62c;',
        "xui-icon-filter":'&#xe61a;',
        "xui-icon-search":'&#xe619;',
        "xui-uicmd-helpinput": '&#xe671;',
        "xui-icon-zoomin": '&#xe61d;',
        "xui-icon-zoomout": '&#xe61e;',
        "xui-icon-bullet": '&#xe632;',
        "xui-icon-minus": '&#xe606;',
        "xui-uicmd-add": '&#xe609;',
        "xui-icon-star": '&#xe649;',
        "xui-icon-dragmove": '&#xe64a;',
        "xui-uicmd-check": '&#xe631;',
        "xui-uicmd-date": '&#xe64b;',
        "xui-icon-number": '&#xe633;',
        "xui-uicmd-pop": '&#xe61f;',
        "xui-icon-mouse": '&#xe64d;',
        "xui-icon-prev": '&#xe60a;',
        "xui-icon-question": '&#xe63d;',
        "xui-icon-loading": '&#xe68d;',
        "xui-icon-indent": '&#xe634;',
        "xui-icon-outdent": '&#xe635;',
        "xui-icon-strikethrough": '&#xe636;',
        "xui-icon-inserthr": '&#xe637;',
        "xui-uicmd-remove": '&#xe66d;',
        "xui-icon-super": '&#xe638;',
        "xui-icon-sub": '&#xe639;',
        "xui-icon-alignjustify": '&#xe62b;',
        "xui-icon-alignright": '&#xe646;',
        "xui-uicmd-arrowdrop": '&#xe623;',
        "xui-icon-upload": '&#xe624;',
        "xui-icon-formatbrush": '&#xe63a;',
        "xui-refresh": '&#xe625;',
        "xui-icon-undo": '&#xe660;',
        "xui-uicmd-refresh": '&#xe621;',
        "xui-icon-date": '&#xe626;',
        "xui-icon-trash": '&#xe60c;',
        "xui-icon-alignleft": '&#xe647;',
        "xui-icon-singleright": '&#xe672;',
        "xui-icon-singleleft": '&#xe673;',
        "xui-icon-singledown":'&#xe82e;',
        "xui-icon-singleup":'&#xe82f;',
        "xui-uicmd-max": '&#xe60d;',
        "xui-icon-last": '&#xe60f;',
        "xui-icon-error": '&#xe674;',
        "xui-icon-remove": '&#xe627;',
        "xui-uicmd-pin": '&#xe628;',
        "xui-icon-link": '&#xe63b;',
        "xui-icon-forecolor": '&#xe63c;',
        "xui-uicmd-time": '&#xe64f;',
        "xui-icon-aligncenter": '&#xe666;',
        "xui-uicmd-check-checked": '&#xe608;',
        "xui-uicmd-cmdbox": '&#xe64e;',
        "xui-uicmd-toggle": '&#xe601;',
        "xui-uicmd-getter": '&#xe657;',
        "xui-uicmd-save": '&#xe629;',
        "xui-icon-dragcopy": '&#xe612;',
        "xui-icon-dropdown": '&#xe679;',
        "xui-uicmd-popbox": '&#xe668;',
        "xui-uicmd-close": '&#xe62a;',
        "xui-uicmd-datetime": '&#xe66c;',
        "xui-icon-arrowright": '&#xe652;',
        "xui-icon-font": '&#xe63e;',
        "xui-icon-bgcolor": '&#xe63f;',
        "xui-icon-mobile": '&#xe600;',
        "xui-icon-clock": '&#xe602;',
        "xui-icon-circledown": '&#xe603;',
        "xui-icon-circleleft": '&#xe607;',
        "xui-icon-circleright": '&#xe658;',
        "xui-icon-circleup": '&#xe659;',
        "xui-uicmd-opt": '&#xe610;',
        "xui-icon-italic": '&#xe640;',
        "xui-icon-redo": '&#xe661;',
        "xui-icon-bold": '&#xe641;',
        "xui-icon-bigup": '&#xe650;',
        "xui-icon-doubledown": '&#xe65c;',
        "xui-icon-doubleleft": '&#xe65d;',
        "xui-icon-doubleright": '&#xe65e;',
        "xui-icon-doubleup": '&#xe65f;',
        "xui-uicmd-color": '&#xe62e;',
        "xui-icon-breaklink": '&#xe642;',
        "xui-icon-picture": '&#xe643;',
        "xui-icon-back": '&#xe62d;',
        "xui-icon-dragadd": '&#xe614;',
        "xui-icon-formatclear": '&#xe644;',
        "xui-uicmd-select": '&#xe66e;',
        "xui-uicmd-file": '&#xe66b;',
        "xui-icon-triangle-up": '&#xe676;',
        "xui-icon-dragstop": '&#xe651;',
        "xui-uicmd-dotted": '&#xe62f;',
        "xui-icon-dialog": '&#xe82c;',
        "xui-icon-print": '&#xe613;',
        "xui-icon-right": '&#xe616;',
        "xui-icon-file": '&#xe617;',
        "xui-uicmd-info": '&#xe618;',
        "xui-icon-smill": '&#xe65b;',
        "xui-icon-sort": '&#xe620;',
        "xui-icon-arrowtop": '&#xe654;',
        "xui-icon-file-fold": '&#xe622;',
        "xui-icon-circle": '&#xe656;',
        "xui-icon-underline": '&#xe645;',
        "xui-uicmd-radio": '&#xe604;',
        "xui-uicmd-radio-checked": '&#xe605;',
        "xui-uicmd-restore": '&#xe630;',
        "xui-uicmd-toggle-checked": '&#xe662;',
        "xui-icon-smallup": '&#xe663;',
        "xui-icon-smalldown": '&#xe664;',
        "xui-icon-html": '&#xe665;',
        "xui-icon-code": '&#xe648;',
        "xui-uicmd-min": '&#xe667;',
        "xui-uicmd-location": '&#xe66f;',
        "xui-icon-file-expand": '&#xe669;',
        "xui-uicmd-delete": '&#xe670;',
        "xui-uicmd-land": '&#xe615;',
        "xui-icon-arrowbottom": '&#xe655;',
        "xui-icon-arrowleft": '&#xe653;',
        "xui-icon-next": '&#xe60b;',
        "xui-icon-first": '&#xe66a;',
        "xui-icon-triangle-left": '&#xe675;',
        "xui-icon-triangle-down": '&#xe677;',
        "xui-icon-triangle-right": '&#xe678;',
        "xui-icon-sort-checked": '&#xe6bb;',
        "xui-icon-transparent":'&#xe60e;',
        "xui-icon-menu":'&#xe611;',
        "xui-icon-menu-checked":'&#xe82d;'
    };
    // IE67 don't support :before/:after
    // and, IE8 is buggy, force to ignore :before/:after
    if(xui.browser.ie678){
        // fonticon fixed
        xui.__iefix2=xui.builtinFontIcon;
    }
};

//UIProfile Class
xui.Class('xui.UIProfile','xui.Profile', {
    Instance:{
        //readonly please
        renderId:null,
        _render:function(){
            var ns=this,ins=ns.boxing(),t,map=xui.$cache.profileMap;

            if(ns.beforeRender&&false===ins.beforeRender(ns))
                return;

            //first render
            if(!ns.renderId){
                var ele=xui.Dom.byId(ns.$domId);

                //for dynRender
                if(!ele)return;

                if(ns.domId!=ns.$domId)
                    ele.id=ns.domId;

                map[ns.domId] = map[ns.$domId] = ns;

                //e.g. use div.innerHTML = ui.toHtml();
                if(!ele.$xid)
                    xui.UI.$addEventsHanlder(ns,ele, true);

                // for svg widget
                if(ns._elset){
                    for(var i=1,l=ns._elset.length;i<l;i++)
                        xui.UI.$addEventsHanlder(ns,ns._elset[i].node, true);
                }

                // unselectable="on" will kill onBlur
                if(xui.browser.ie && xui.browser.ver<10 && 'selectable' in ns.properties)
                    xui.setNodeData(ele,"_onxuisel",ns.properties.selectable?"true":"false");

                ns.rendered=ns.renderId=ele.$xid;

                ele=null;
            }

            if(ns.CA&&!xui.isEmpty(ns.CA)){
                ins.setCustomAttr(ns.CA);
            }
            if(ns.CS&&!xui.isEmpty(ns.CS)){
                ins.setCustomStyle(ns.CS);
            }

            // For touch-only platform
            // In ipad or other touch-only platform, you have to decide the droppable order by youself
            // The later added to DOM the higher the priority
            // Add droppable links
            if(xui.browser.isTouch){
                if((t=ns.box.$Behaviors.DroppableKeys) && t.length){
                    xui.arr.each(t,function(o){
                        ins.getSubNode(o,true).each(function(node){
                            var key=ns.box.getDropKeys(ns,node.$xid);
                            if(key){
                                var c=xui.$cache.droppable,a=key.split(/[^\w-]+/);
                                for(var i=0,l=a.length;i<l;i++){
                                    c[a[i]]=c[a[i]]||[];
                                    c[a[i]].push(node.$xid);
                                }
                            }
                        });
                    });
                }
            }

            if(xui.browser.fakeTouch || (xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB))){
                var check={'auto':1,'scroll':1},dir;
                // for UI's appearances overflow
                xui.each(ns.box.$Appearances,function(o,i){
                    dir='';
                    if(check[o.overflow]){
                        dir='xy';
                    }else{
                        if(check[o['overflow-x']])dir += 'x';
                        if(check[o['overflow-y']])dir += 'y';
                    }
                    if(dir)ns.getSubNode(i,true).$touchscroll(dir);
                });
                // for UI's overflow property
                if('overflow' in ns.properties) {
                    if(xui.browser.fakeTouch){
                        xui.asyRun(function(){
                            var dir='',root=ns.getRoot();
                            if(root&&!root.isEmpty()){
                                if(root.isScrollBarShowed('x'))dir += 'x';
                                if(root.isScrollBarShowed('y'))dir += 'y';
                                if(dir)root.$touchscroll(dir);
                            }
                        });
                    }else{
                        if(check[ns.properties.overflow]){
                            ins.setOverflow(ns.properties.overflow,true);
                        }
                    }
                }
            }

            //RenderTrigger
            if(t=ns.RenderTrigger){
                for(var i=0,l=t.length;i<l;i++)
                    t[i].call(ns);
                delete ns.RenderTrigger;
            }

            if(ns.onRender)
                ins.onRender(ns);
            xui.tryF(ns.$onrender,[],ns);

            if(arguments[0]===true && (t=ns.LayoutTrigger)){
                for(var i=0,l=t.length;i<l;i++)
                    t[i].call(ns);
                if(ns.onLayout)
                    ins.onLayout(ns);
            }
            if(!ns.properties.lazyAppend){
                if(ns.children)
                    for(var i=0,v;v=ns.children[i++];)
                        if(v[0]._render)
                            v[0]._render(true);

                if(ns.$attached){
                    for(var i=0,v;v=ns.$attached[i++];){
                        if(v._render)v._render(true);
                    }
                    delete ns.$attached;
                }
                if(ns.exchildren){
                    var arr=[];
                    for(var i=0,v;v=ns.exchildren[i++];)
                        ins.append(v[0],v[1]);
                    delete ns.exchildren;
                }
                if(ns.exmodules){
                    var arr=[];
                    for(var i=0,v;v=ns.exmodules[i++];)
                        v[0].show(null, ins, v[1], false);
                    delete ns.exmodules;
                }
            }

            ns.renderCompleted=1;
        },
        __gc:function(ignoreEffects, purgeNow){
            var ns=this, t, args=xui.toArr(arguments);
            if(ns.destroyed)return;
            if(ns.$beforeDestroy){
                xui.each(ns.$beforeDestroy,function(f){
                    xui.tryF(f,args,ns);
                });
                xui.breakO(ns.$beforeDestroy,2);
            }
            xui.tryF(ns.$ondestory,args,ns);
            if(ns.onDestroy)ns.boxing().onDestroy();
            if(ns.destroyTrigger)ns.destroyTrigger();

            //gc already
            if(!ns.serialId)return;
            if(t=ns._$composed)
                xui.each(t,function(v){
                    v.__gc(ignoreEffects, purgeNow);
                });

            //clear cache things
            ns.clearCache();

            //for refresh function
            if(!ns.$noReclaim){
                //restore dom id
                t=xui.$cache.reclaimId;
                (t[ns.key] || (t[ns.key]=[])).push(ns.serialId);
            }else delete ns.$noReclaim

            //clear cache point
            delete xui.$cache.profileMap[ns.domId];
            delete xui.$cache.profileMap[ns.$domId];

            // try to clear parent host
            var o;
            if(ns.alias && ns.host && (o=ns.host[ns.alias]) && (o=o._nodes) && (o.length===0 || o.length===1 && o[0]==ns)){
                delete ns.host[ns.alias];
            }

            //clear anti link
            ns.unLinkAll();

            if(ns.LayoutTrigger)
                ns.LayoutTrigger.length=0;
            if(ns.RenderTrigger)
                ns.RenderTrigger.length=0;

            //gc children
            if((t=ns.children).length){
                t=xui.copy(t);
                for(var i=0;i<t.length;i++){
                    t[i][0].__gc(ignoreEffects, purgeNow);
                    t[i].length=0;
                }
                t.length=0;
            }

            //set once
            ns.destroyed=true;
            //afterDestroy
            if(ns.$afterDestroy){
                xui.each(ns.$afterDestroy,function(f){
                    xui.tryF(f,args,ns);
                });
                xui.breakO(ns.$afterDestroy,2);
            }
            if(ns.afterDestroy)ns.boxing().afterDestroy(ns);
            xui.breakO([ns.properties,ns.events, ns.CF, ns.CB, ns.CC, ns.CA, ns.CS, ns],2);
            //set again
            ns.destroyed=true;
        },
        linkParent:function(parentProfile, linkId, index){
            var profile=this;
            //unlink first
            profile.unlinkParent();
            if(!profile.destroyed){
                //link
                profile.parent = parentProfile;
                profile.childrenId = linkId;
                profile.link(parentProfile.children, '$parent', [profile, linkId], index);
            }
            return profile;
        },
        unlinkParent:function(){
            var profile=this;
            delete profile.parent;
            delete profile.childrenId;
            profile.unLink('$parent');
            return profile;
        },
        getRootNode:function(){
            return xui.getNodeData(this.renderId, 'element');
        },
        getRoot:function(){
            var ns=this;
            return ns.renderId ? (ns['*']||(ns['*']=xui([ns.renderId],false))) : xui([],false);
        },
        getAllNodes:function(){
            return this.getRoot().query().merge(this.getRoot());
        },
        getContainer:function(subId){
            if(subId!==true&&(subId=typeof subId=='string'?subId:null))subId=this.getSubIdByItemId(subId);
            return this.box._CONTAINERKEY?this.getSubNodes(this.box._CONTAINERKEY, subId):this.keys.PANEL?this.getSubNodes(this.keys.PANEL, subId):this.getRoot();
        },
        // wrap these functions from xui.CSS
        getEmSize:function(force){
            var prf=this,
                root=prf.getRoot(),
                node=root.get(0);
            // for special parent css
            return (!force && prf._nodeEmSize) ||  ( node ? (prf._nodeEmSize = root._getEmSize()) : xui.CSS._getDftEmSize() ) ;
        },
        adjustSize:function(useProp, asy, flag){
            var prf=this,
                t=prf.getRootNode();
            if(t&&(useProp||(t=t.style))){
                var f=function(){
                    xui.UI.$tryResize(prf, useProp ? prf.properties.width : t.width , useProp ? prf.properties.height : t.height, true, flag);
                };
                if(asy)xui.asyRun(f);
                f();
            }
        },
        // have to call these after rendered
        $px:function(value, node, roundPx){
            var ns=this;
            return xui.CSS.$px(value, node||function(){return ns.getEmSize()},roundPx);
        },
        $em:function(value, node, roundPx){
            var ns=this;
            return xui.CSS.$em(value, node||function(){return ns.getEmSize()},roundPx);
        },
        $px2em:function(value, node, roundPx){
            var ns=this;
            return xui.CSS.$px2em(value, node||function(){return ns.getEmSize()},roundPx);
        },
        $em2px:function(value, node, roundPx){
            var ns=this;
            return xui.CSS.$em2px(value, node||function(){return ns.getEmSize()},roundPx);
        },
        $forceu:function(value,u,node,roundPx){
            var ns=this;
            return xui.CSS.$forceu(value,u,node||function(){return ns.getEmSize()},roundPx);
        },
        $addpx:function(a,b,node){
            var ns=this;
            return xui.CSS.$addpx(a,b,node||function(){return ns.getEmSize()});
        },
        $isEm:function(value){return xui.CSS.$isEm(value);},
        $isPx:function(value){return xui.CSS.$isPx(value);},
        $picku:function(value){return xui.CSS.$picku(value);},
        $addu:function(value){return xui.CSS.$addu(value);},

        _cacheR1:/^\w[\w_-]*$/,
        setDomId:function(id){
            var t=this, c=xui.$cache.profileMap;
            //ensure the value
            if(typeof id== 'string' && (t._cacheR1.test(id)||id==t.$domId) && !xui.Dom.byId(id)){
                //delete the original one
                if(t.domId!=t.$domId)delete c[t.domId];
                //set profile's domId
                t.domId=id;

                //change the dom Node id value
                if(t.renderId)
                    t.getRootNode().id=id;

                //if doesn't create yet, don't set it to xui.$cache:
                if(c[t.$domId])c[id]=t;
            }
            return t;
        },
        getDomId:function(){
            return this.domId;
        },
        clearCache:function(){
            var ns=this,
                t=ns.$_egetter;
            for(var i in t){
                t[i].length=0;
                delete t[i];
            }

            t=ns.$_domid;
            for(var i in t){
                 t[i].__gc(true,true);
                 delete t[i];
            }
            delete ns['*'];

            return ns;
        },
        //get events function from profile
        _getEV:function(funs,id, name){
            var self=this,
                $k = id+"+"+name,
                g = self.$_egetter ||(self.$_egetter={}),
                cache;
            if(g[$k]){
                Array.prototype.push.apply(funs,g[$k]);
                return;
            }else cache=g[$k]=[];

            var dom=xui.$cache.profileMap,t,key;
            //for event attached on dom node
            if( (t=dom[id]) && (t=t.events) && (t=t[name]) )
                for(var i=0,l=t.length;i<l;i++)
                    if(typeof t[t[i]]=='function')
                        cache.push(funs[funs.length]=t[t[i]]);

            //for event attached on xui widgets
            //get event function path of cache
            key = id.split(":")[0].split("-")[1];

            //for priority intercept
            if(typeof (((t=self._CB) && (key?(t=t[key]):1)) && (t=t[name]))=='function')
                cache.push(funs[funs.length]=t);
            else{
                //get event function from customBehavior first
                if(typeof (((t=self.CB) && (key?(t=t[key]):1)) && (t=t[name]))=='function')
                    cache.push(funs[funs.length]=t);
                else{
                    //get event function from public behavior
                    if(typeof (((t=self.behavior) && (key?(t=t[key]):1)) && (t=t[name]))=='function')
                        cache.push(funs[funs.length]=t);
                }
            }
        },
        _cacheR2:/<!--\x03([^>^\s]*)\x04-->/g,
        toHtml:function(force){
            var self=this,
                prop=self.properties,
                c = self.box,
                h={},
                str,
                k1='xui.UIProfile',
                k2='xui.Module',
                id, i, l, o, m, a, b, data;
            if(self.destroyed)return "";

            // create first
            if(c['xui.svg']){
                c._RenderSVG(self);
                return "";
            }else{
                //before _dynamicTemplate
                data=c._prepareData(self);
                if(c._dynamicTemplate)c._dynamicTemplate(self);
                str = c._build(self, data);

                if((!prop.lazyAppend||force) && (m=self.children)){
                    for(i=0, l=m.length; i<l; i++){
                        o=m[i];
                        if(o&&o[0]){
                            if(o[0][k2]){
                                var mh=new xui.UI.MoudluePlaceHolder({
                                    host:o[0].host,
                                    alias:o[0].alias
                                });
                                mh.get(0)._module = o[0];
                                o[0] = mh.get(0);
                            }
                            if(o[0][k1]){
                                id=o[1]||'';
                                a=h[id]||(h[id]=[]);
                                a[a.length]=o[0].toHtml(force);
                            }
                        }
                    }
                }

                return str.replace(self._cacheR2, function(a,b){
                    return h[b]?h[b].join(''):'';
                });
            }
        },
        _buildItems:function(key, items, addEventHandler){
            var ns=this,
                box=ns.box,
                str=box._rpt(ns, xui.UI.$doTemplate(ns, xui.get(xui.$cache.template,[box.KEY, ns._hash]), items, key)),
                nodes = xui.UI.$toDom(ns, str.replace(ns._cacheR2,''), addEventHandler);
            if(ns.CA&&!xui.isEmpty(ns.CA)){
                ns.boxing().setCustomAttr(ns.CA,undefined,nodes);
            }
            // set custom styles for the given nodes only
            if(ns.CS&&!xui.isEmpty(ns.CS)){
                ns.boxing().setCustomStyle(ns.CS,undefined,nodes);
            }
            return nodes;
        },
        serialize:function(rtnString, keepHost, children){
            var t,m,moduleHash={},
                self=this,
                o=(t=self.box._beforeSerialized)?t(self):self,
                r={
                    alias:o.alias,
                    key:o.key,
                    host:o.host
                },
                zz = o.moduleClass+"["+o.moduleXid+"]";
            //host
            if(r.host===self){
                delete r.host;
            }else if(o.host && !keepHost ){
                if(rtnString!==false)
                    r.host='@this';
                else
                    delete r.host;
            }
            if(typeof o.theme=="string")
              r.theme=o.theme;

            //domId
            if(o.$domId!=o.domId)r.domId=o.domId;

            //properties
            var c={}, p=o.box.$DataStruct, map=xui.absObj.$specialChars;
            xui.merge(c,o.properties, function(o,i){return (i in p) &&  p[i]!==o && !map[i.charAt(0)]});
            if(!xui.isEmpty(c))r.properties=c;

            //events
            if(!xui.isEmpty(t=this.getEvents()))r.events=t;
            var eh = o.box.$EventHandlers;
            xui.filter(r.events, function(o,i){
                return o!=eh[i];
            });
            if(xui.isEmpty(r.events))delete r.events;

            if(!xui.isEmpty(o.CB)) r.CB=xui.copy(o.CB);
            if(!xui.isEmpty(o.CC)) r.CC=xui.copy(o.CC);
            if(!xui.isEmpty(o.CF)) r.CF=xui.copy(o.CF);
            if(!xui.isEmpty(o.CS)) r.CS=xui.clone(o.CS,function(o,i){return !((i+"").charAt(0)=="$"&&!o)});
            if(!xui.isEmpty(o.CA)) r.CA=xui.copy(o.CA);
            if(typeof o.theme == "string") r.theme=o.theme;

            //children
            if(false!==children && o.children && o.children.length){
                if(o.box.KEY!="xui.UI.SVGPaper"){
                    xui.arr.stableSort(o.children,function(x,y){
                        x=(x[0].properties.tabindex||0);y=(y[0].properties.tabindex||0);
                        return x>y?1:x==y?0:-1;
                    });
                }
                t=r.children=[];
                xui.arr.each(o.children,function(v,w,y,z){
                    w=v[0];
                    if(w.moduleClass && w.moduleXid && (y=xui.SC.get(w.moduleClass)) && (y=y.getInstance(w.moduleXid)) && y["xui.Module"]){
                        z=w.moduleClass+"["+w.moduleXid+"]";
                        // same module with the parent
                        if(z!==zz){
                            // same module with another sibling
                            if(moduleHash[z]){
                                return;
                            }else{
                                moduleHash[z]=1;
                                w=y;
                            }
                        }
                    }
                    m=[w.serialize(false, keepHost)];
                    if(v[1])m[1]=v[1];
                    t[t.length]=m
                });
            }
            if(false!==children && o.exchildren && o.exchildren.length){
                r.exchildren=o.exchildren;
            }
            moduleHash=null;
            return rtnString===false?r:xui.serialize(r);
        },
        _applySetAction:function(fun, value, ovalue, force, tag, tag2){
            if(this.renderId)
                return fun.call(this, value, ovalue, force, tag, tag2);
        },
        getKey:function(id,tagOnly){
            var t;
            if(id.charAt(0)=='!')id=xui.use(id).id();
            if(id.indexOf(':')==-1)id=(t=xui.$cache.profileMap[id])&&(t.$domId);
            if(id){
                id=id.split(":")[0];
                if(tagOnly)id=id.split('-')[1]||"KEY";
            }
            return id||"";
        },
        getSubId:function(id){
            var t;
            if(id.charAt(0)=='!')id=xui.use(id).id();
            if(id.indexOf(':')==-1)id=(t=xui.$cache.profileMap[id])&&(t.$domId);
            return id?id.split(":")[2]:"";
        },
        pickSubId:function(key){
            var self=this, r,o = self.cache_subid || (self.cache_subid={});
            if((o[key] || (o[key]=[]))[0])return o[key].shift();
            o = self.subId || (self.subId={});
            r=(o[key] || (o[key]=new xui.id)).next();
            return r;
        },
        reclaimSubId:function(id, key){
            var o = this.cache_subid || (this.cache_subid={});
            (o[key] || (o[key]=[])).push(id);
        },
        /*
        *('KEY','-hover',false);
        */
        _cacheR3:/\./g,
        _cacheH1:{},
        getClass:function(key, tag){
            key=this.keys[key] || key;
            var self=this,
                hash=key+":"+(tag||'');
            return self._cacheH1[hash] || (self._cacheH1[hash]=key.replace(self._cacheR3,'-').toLowerCase().replace('xui-ui','xui') + (tag||''));
        },
        _getSubNodeId:function(key, subId, tag){
            var arr = this.$domId.split(':');
            arr[0]=key;
            arr[2]=xui.isSet(subId)?(subId+""):'';
            if(tag)arr[2]+='_'+tag;
            key=arr.join(':');
            return key==this.$domId
                ? xui.$cache.profileMap[key].domId
                : key;
        },
        //flag : remove from cache
        getSubNode:function(key, subId, tag){
            var ns=this;

            // destroyed already
            if(!ns.renderId)return xui();

            var key=ns.keys[key] || key, r,
                h=ns.$_domid||(ns.$_domid={});

            // by key only
            if(subId===true){
                //key==ns.keys.KEY for domId!=$domId
                if(key==ns.keys.KEY)r=xui([ns.renderId]);
                if(!r || !r.get(0)){
                    r =xui([ns.renderId]).query('*', 'id', new RegExp('^'+key+':'+ns.serialId +(tag?("_"+tag):"")));
                }
            }else{
                if(!xui.isSet(subId) && h[key] && h[key]._nodes.length==1)return h[key];
                r=xui(ns._getSubNodeId(key, subId, tag));
                if(r._nodes.length==1 && !xui.isSet(subId))h[key]=r;
            }
            return r;
        },
        getSubNodes:function(arr,subId,tag){
            var ns=this, a=[],s1=!xui.isArr(arr),s2=!xui.isArr(subId),a,o,v,push=Array.prototype.push;
            if(subId===true||xui.isNull(subId)){
                if(!s1){
                    a=[];
                    for(var i=0;o=arr[i++];)a.push(ns.keys[o] || o);
                    arr = '('+a.join('|')+')';
                }
                // get call once for better performance
                push.apply(a,ns.getSubNode(arr,true,tag).get());
            }else{
                if(s1){
                    if(s2)
                        push.apply(a,ns.getSubNode(arr,subId,tag).get());
                    else
                        for(var j=0;v=subId[j++];)
                            push.apply(a,ns.getSubNode(arr,v,tag).get());
                }else{
                    for(var i=0;o=arr[i++];){
                        if(s2)
                            push.apply(a,ns.getSubNode(o,subId,tag).get());
                        else
                            for(var j=0;v=subId[j++];)
                                push.apply(a,ns.getSubNode(o,v,tag).get());
                    }
                }
            }
            return xui(a);
        },

        getSubNodeByItemId:function(key, itemId, tag){
            return (itemId=this.getSubIdByItemId(itemId)) ? this.getSubNode(key, itemId, tag) : xui();
        },
        getItemByItemId:function(itemId){
            var prf=this,t;
            if(xui.isNumb(itemId))itemId=xui.get(prf.properties.items,[itemId,"id"]);
            if((t=prf.ItemIdMapSubSerialId) && (t=t[itemId]))
                return prf.SubSerialIdMapItem[t];
            t=prf.queryItems(prf.properties.items, function(v,k){
                return v.id==itemId;
            }, 1,1);
            return t&&t[0];
        },
        getSubIdByItemId:function(itemId){
            var prf=this,t;
            if(xui.isNumb(itemId))itemId=xui.get(prf.properties.items,[itemId,"id"]);
            return (t=this.ItemIdMapSubSerialId) && t[itemId];
        },

        getItemByDom:function(src){
            return this.SubSerialIdMapItem && this.SubSerialIdMapItem[
                this.getSubId( typeof src=='string'
                    ? src.charAt(0)=='!'
                        ? ((src=xui.use(src).get(0))&&src.id)
                        : src
                    : src.id )
             ];
        },
        getItemIdByDom:function(src){
            var t;
            return (t=this.getItemByDom(src)) && t.id;
        },
        queryItems:function(items, fun, deep, single, flag){
            var r=[],
                me=arguments.callee,
                f = me.f || (me.f = function(items, fun, deep, single, flag, r){
                    xui.arr.each(items,function(o,i){
                        if(fun===true || fun.call(null, o, i, items)){
                            r.push(flag?[o,i,items]:o);
                            if(single)
                                return false;
                        }
                        if(deep && o.sub && o.sub.length)
                            f(o.sub, fun, deep, single, flag, r);
                    });
                });
            f(items, fun, deep, single, flag, r);
            return r;
        }
    },
    Static:{
        getFromDom:function(id){
            if(
                (id = (id && id.KEY=="xui.Dom")? id.get(0).id
                   : typeof id=='string' ? id.charAt(0)=='!'
                        ? ((id=xui.use(id).get(0)) && id.id)
                        :id
                    : (id && id.id)
                ) &&
                (id=xui.Event._getProfile(id)) && id['xui.UIProfile']
               )
                return id;
        }
    }
});

//UI Class
xui.Class("xui.UI",  "xui.absObj", {
    Before:function(key, parent_key, o){
        xui.absBox.$type[key.replace("xui.UI.","").replace("xui.","")]=xui.absBox.$type[key]=key;
        return true;
    },
    After:function(){
        var self=this,me=arguments.callee,
            temp,t,k,u,c,i,j,e,w,v,b,d;

        xui.absObj.After.apply(this,arguments);

        // remove datafield for containers
        if(self.Behaviors && self.Behaviors.PanelKeys &&  self.$DataModel && self.$DataModel.dataField){
            delete self.$DataModel.dataField;
            delete self.$DataStruct.dataField;
            delete self.prototype.setDataField;
            delete self.prototype.getDataField;
        }

        self._ctrlId = new xui.id();
        self._idCache=[];
        self.$cssKeys={};

        /*change keys*/
        t=self.$Keys;
        t.KEY = t.$key = self.KEY;
        self.addTemplateKeys(xui.toArr(t,true));

        //Inheriates Behaviors
        v='$Behaviors';
        k={};
        if((t=self.$parent) && (e=t.length)){
            while(e--){
                b=t[e][v];
                for(i in b){
                    if(typeof b[i]=='object'){
                        if(xui.isArr(b[i])){
                            u=k[i]||(k[i]=[]);
                            u.push.apply(u,b[i]);
                        }else{
                            u=k[i]||(k[i]={});
                            xui.merge(u,b[i]);
                        }
                    }else
                        k[i]=b[i];
               }
            }
        }
        self[v]=k;

        //Inheriates Templates
        v='$Templates';
        k={};
        if((t=self.$parent) && (e=t[0]))
            for(i in e[v])
                if(i.charAt(0)!='$')
                    k[i]=e[v][i];
        self[v]=xui.clone(k);

        //Inheriates Appearances
        v='$Appearances';
        k={};
        if((t=self.$parent) && (e=t.length))
        while(e--){
            b=t[e];
            for(i in b[v]){
                t=b[v][i];
                u=k[i]||(k[i]={});
                xui.merge(u,t);
            }
        }
        self[v]=k;

        self.setTemplate(self.Templates);
        delete self.Templates;

        self.setBehavior(self.Behaviors||{});
        delete self.Behaviors;

        self.setAppearance(self.Appearances);
        delete self.Appearances;

        if(t=self.PublicAppearance){
            xui.UI.$cache_css += self.buildCSSText(t);
            delete self.PublicAppearance;
        }
    },
    Instance:{
        animate:function(key, callback){
            // only for the first profile
            var prf=this.get(0),t,
                node=prf.getRootNode(),
                tid=xui.getNodeData(node,'_inthread'),
                reset=xui.getNodeData(node,'_animationreset'),t;
            if(tid && xui.Thread.isAlive(tid)){
                xui.Thread(tid).abort('force');
                xui.setNodeData(node,'_inthread',null);
            }
            if(typeof reset=="function"){
                reset();
                xui.setNodeData(node,'_animationreset',null);
            }

            if(key && (t=xui.AnimBinder.getFromName(key))) {
                return t.apply(node, callback);
            }else{
                if(!key)key="blinkAlert";
                var item = (xui.isHash(key) && key.endpoints) ? key : xui.Dom.$preDefinedAnims[key];
                if(item && item.endpoints){
                    var onEnd;
                    if(xui.isFun(callback)){
                        if(xui.isFun(item.onEnd)){
                            onEnd=function(){
                                item.onEnd.apply(this,arguments);
                                callback.apply(this,arguments);
                            };
                        }else{
                            onEnd=callback;
                        }
                    }else if(xui.isFun(item.onEnd)){
                        onEnd=item.onEnd;
                    }
                    return prf.getRoot().animate(item.endpoints, item.onStart, onEnd,item.duration||200, null, item.type||"linear", null, item.unit, item.restore, item.times).start();
                }
            }
        },
        hoverPop : function(node, type, beforePop, beforeHide, parent, groupid){
            var prf=this.get(0),source=prf.boxing(),popmenu;
            if(!prf.box.$EventHandlers.beforeHoverEffect){
                source.getRoot().hoverPop(node, type, beforePop,beforeHide, parent, groupid);
                return this;
            }
            node=xui(node);
            popmenu=xui.UIProfile.getFromDom(node.id());
            if(popmenu&&popmenu.key==='xui.UI.PopMenu'){
                popmenu=popmenu.boxing();
            }else{
                popmenu=null;
            }
            if(!xui.isDefined(type))type='outer';
            var aysid=groupid||(source.getRoot().xid()+":"+node.xid());
            source.each(function(o){
                o.$beforeHover=type===null?null:function(prf, item, e, src, mtype){
                    if(e.$force)return;
                    if(mtype=='mouseover'){
                        xui.resetRun(aysid,null);
                        var ignore=xui.getData([aysid,'$ui.hover.pop'])
                                        && xui.getNodeData(node.get(0)||"empty",'$ui.hover.parent')==src;
                        if(!ignore){
                            xui.setData([aysid,'$ui.hover.pop'],{item:item});
                            xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',src);
                            if(!beforePop || false!==beforePop(prf, node, e, src, item)){
                                if(popmenu) popmenu.pop(src, type, parent);
                                else node.popToTop(src, type, parent);
                                node.onMouseover(function(){
                                    xui(src).onMouseover(true)
                                },'hoverPop')
                                node.onMouseout(function(){
                                    xui(src).onMouseout(true)
                                },'hoverPop');
                            }
                        }
                    }else{
                        xui.resetRun(aysid,function(){
                            xui.setData([aysid,'$ui.hover.pop']);
                            xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',0);
                            if(!beforeHide || false!==beforeHide(prf, node,e, src ,'host',item)){
                                if(popmenu) popmenu.hide();
                                else node.hide();
                                node.onMouseover(null,'hoverPop').onMouseout(null,'hoverPop');
                            }
                        });
                    }
                };
            });
            if(node){
                node.onMouseover(type===null?null:function(e){
                    if(e.$force)return;
                    if(!xui.getData([aysid,'$ui.hover.pop']))return;
                    xui.resetRun(aysid,null);
                },'hoverPop');
                node.onMouseout(type===null?null:function(prf,e,src){
                    if(e.$force)return;
                    if(!xui.getData([aysid,'$ui.hover.pop']))return;
                    xui.resetRun(aysid,function(){
                        xui.setData([aysid,'$ui.hover.pop'])
                        xui.setNodeData(node.get(0)||"empty",'$ui.hover.parent',0);
                        var item=xui.getData([aysid,'$ui.hover.pop']);
                        if(!beforeHide || false!==beforeHide(prf,node, e,src,'pop',item&&item.item)){
                            if(popmenu) popmenu.hide();
                            else node.hide();
                            node.onMouseover(null,'hoverPop').onMouseout(null,'hoverPop');
                        }
                    });
                },'hoverPop');
                node.css('display','none');
            }
            return this;
        },
        setTheme:function(key){
            if(typeof key!="string" || !key)key=null;
            var k,arr=[];
            this.each(function(o){
                if(key!=o.theme){
                    if(key===null)
                        delete o.theme;
                    else
                        o.theme=key;
                    arr.push(o);
                }
            });
            xui.UI.pack(arr,false).refresh();
            return this;
        },
        getTheme:function(){
            return this.get(0) && this.get(0).theme;
        },
        getModule:function(top){
            var prf=this.get(0);
            if(prf)return prf.getModule(top);
        },
        destroy:function(ignoreEffects, purgeNow){
            var ns=this;
            this.each(function(o,i){
                if(o.destroyed)return;
                var fun=function(){
                    if(o.beforeDestroy && false===o.boxing().beforeDestroy(ignoreEffects, purgeNow))return;

                    if(o.$beforeDestroy){
                        xui.each(o.$beforeDestroy,function(f){
                            xui.tryF(f,[ignoreEffects, purgeNow],o);
                        });
                        xui.breakO(o.$beforeDestroy,2);
                    }

                    if(o.renderId){
                        o.getRoot().remove(true, purgeNow);
                    }
                    else{
                        o.__gc(ignoreEffects, purgeNow);
                    }
                    xui.arr.removeFrom( ns._nodes, i);

                    if(o.$afterDestroy){
                        xui.each(o.$afterDestroy,function(f){
                            xui.tryF(f,[ignoreEffects, purgeNow],o);
                        });
                        xui.breakO(o.$afterDestroy,2);
                    }
                };
                var p=o.properties,
                     a=ignoreEffects?null:xui.Dom._getEffects(p.hideEffects,0);
                if(a)xui.Dom._vAnimate(o.getRoot(),false,fun);
                else fun();
            },null,true);
        },
        isDestroyed:function(){
            return !!(this.get(0)?this.get(0).destroyed:1);
        },
        _toDomElems:function(){
            var arr=[];
            //collect those need to be rendered
            xui.arr.each(this._nodes,function(o){
                if(!o.renderId)
                    arr.push(o);
            });
            //render those
            if(arr.length)
                xui.UI.pack(arr,false).render();

            //get rendered
            arr.length=0;
            xui.arr.each(this._nodes,function(o){
                arr.push(o.renderId);
            });
            return arr;
        },

        _ini:function(properties, events, host, theme, CS, CC, CB, CF, CA){
            var self=this,
                c=self.constructor,
                profile,
                t='default',
                options,
                df1=xui.UI.__resetDftProp,
                df2=c.__resetDftProp,
                df3=c.$adjustProp,
                ds=c.$DataStruct,
                alias,temp;
            if(properties && properties['xui.Profile']){
                profile=properties;
                alias = profile.alias || c.pickAlias();
                xui.UIProfile.apply(profile,[host,self.$key,alias,c,null,events]);
            }else{
                if(properties && properties.key && xui.absBox.$type[properties.key]){
                    options=properties;
                    properties=null;
                    alias = options.alias || c.pickAlias();
                }else
                    alias = c.pickAlias();
                profile=new xui.UIProfile(host,self.$key,alias,c,properties,events, options);
            }

            for(var i in ds){
                if(!(i in profile.properties)){
                    temp = df2&&(i in df2) ? df2[i] : df1&&(i in df1) ? df1[i] : ds[i];
                    profile.properties[i]=typeof temp=='object'?xui.clone(temp,true):temp;
                }
            }
            if(typeof(df3)=="function")df3(profile);

            profile.keys = c.$Keys;

            // custom
            profile.CS = CS?xui.copy(CS):(profile.CS||{});
            profile.CB = CB?xui.copy(CB):(profile.CB||{});
            profile.CC = CC?xui.copy(CC):(profile.CC||{});
            profile.CF = CF?xui.copy(CF):(profile.CF||{});
            profile.CA = CA?xui.copy(CA):(profile.CA||{});
            if(typeof theme =="string")profile.theme = theme;

            profile.template = c.getTemplate();
            profile.behavior = c.$Behaviors;

            if(!profile.serialId)profile.serialId=c._pickSerialId();

            profile.$domId = profile.key + ":" + profile.serialId + ":";
            profile.domId = profile.domId || profile.$domId;

            profile.RenderTrigger=xui.copy(c.$RenderTrigger);
            profile.LayoutTrigger=xui.copy(c.$LayoutTrigger);

            //set links
            profile.link(xui.UI._cache,'UI').link(c._cache,'self').link(xui._pool,'xui');

            temp=profile.children;
            profile.children=[];
            if(temp && temp.length){
                for(var i=0,v;v=temp[i++];){
                    //from serialize
                    if(!v[0]['xui.UIProfile'])  v[0]=xui.create(v[0]).get(0);
                    if(v[0]['xui.UIProfile'])  v[0].linkParent(profile,v[1]);
                    else if(v[0]['xui.Module'])
                        v[0].getUIComponents().each(function(p){
                            p.linkParent(profile,v[1]);
                        });
                }
            }
            self._nodes.push(profile);
            profile.Instace=self;
            self.n0=profile;
            if(c.$onInited)xui.tryF(c.$onInited,[],profile);
            return self;
        },
        busy:function(coverAll,html,key,subId, bgStyle){
            html=typeof html=='string'?html:'Loading...';
            // busy dom too
            if(coverAll===true)xui.Dom.busy();

            return this.each(function(profile){
                xui.resetRun(profile.$xid+':busy',function(profile,key,subId){
                    // destroyed
                    if(!profile.box)return;

                    var keys=profile.keys,node;
                    key=keys[key]||keys['BORDER']||keys['PANEL']||keys['KEY'];
                    var parentNode=profile.getSubNode(key,subId);
                    if(parentNode.isEmpty())
                        return;

                    if(!profile.$busy||profile.$busy.isEmpty()){
                        node=profile.$busy=xui.create('<button class="xui-node xui-node-div xuicon xui-icon-loading xui-cover xui-custom" style="position:absolute;text-align:center;left:0;top:0;z-index:10;border:0;padding:0;margin:0;width:100%;height:100%;"><div class="xui-node xui-node-div xui-coverlabel xui-custom"></div></button>');
                    }
                    node=profile.$busy;

                    node.first().html(html,false);

                    parentNode.append(node);

                    node.removeClass(/^xui-rand-css-/);
                    node.query('style').remove(false);
                    if(bgStyle){
                        var clsName="xui-rand-css-" + xui.rand();
                        node.addClass(clsName);
                        xui.CSS._appendSS(node.get(0), "." + clsName + ":before{" + bgStyle + "}", clsName,true);
                    }
                    var pn=parentNode.get(0);
                    node._parentOST = pn.scrollTop||0;
                    node._parentOSL = pn.scrollLeft||0;
                    node._parentOverflow = pn.style.overflow||'';
                    node._busyP = parentNode.xid();

                    pn.scrollTop=pn.scrollLeft=0;
                    pn.style.overflow='hidden';

                },50,[profile,key,subId]);
            });
        },
        free:function(){
            xui.Dom.free();
            return this.each(function(profile){
                xui.resetRun(profile.$xid+':busy');
                if(node=profile.$busy){
                    var pn=xui(node._busyP).get(0);
                    if(pn){
                        pn.scrollTop = node._parentOST||0;
                        pn.scrollLeft = node._parentOSL||0;
                        pn.style.overflow=node._parentOverflow||'';
                    }
                    node._parentOST=node._parentOSL=node._parentOverflow=node._busyP=null;
                    node.remove();
                    delete profile.$busy;
                }
            });
        },
        adjustSize:function(useProp, asy, flag){
            return this.each(function(prf){
                prf.adjustSize(useProp, asy, flag);
            });
        },
        reLayout:function(force){
            return this.each(function(o){
                if(!o.renderId)return;

                // have to refresh this
                delete o._nodeEmSize;

                var p=o.properties;

                if((!o.$noB) && p.border && o.boxing()._border)
                    o.boxing()._border(null,false);
                o.$forceRelayout=1;
                if(p.position=='absolute' && p.dock && p.dock!='none'){
                    o.boxing().adjustDock(force);
                }else{
                    if(force){
                        o._resize_h=o._resize_w=-1;
                    }
                    xui.UI.$tryResize(o,p.width,p.height,force);
                }
                delete o.$forceRelayout;
            });
        },
        toHtml:function(force){
            var a=[];
            xui.arr.each(this._nodes,function(o){
                a[a.length]=o.toHtml(force);
            });
            return a.join('');
        },
        render:function(triggerLayOut){
            var ns=this, arr=[], i, l, o, n=ns._nodes, matrix, a=[],byId=xui.Dom.byId;

            xui.UI.$applyCSS();

            //get those no-html items
            for(i=0;o=n[i++];)
                if(!o.renderId && !xui.Dom.byId(o.domId) && !xui.Dom.byId(o.$domId))
                    arr[arr.length]=o;

            //build html and to dom
            if(l=arr.length){
                for(i=0;i<l;i++)
                    if(o=arr[i].toHtml())
                        a[a.length]=o;
                if(a.length)
                    xui.UI.$toDom(ns.get(0)/*first represents all*/,a.join(''));
            }

            //render all UIProfiles
            for(i=0;o=n[i++];)
                o._render(triggerLayOut);

            a.length=arr.length=0;
            return ns;
        },
        renderOnto:function(node, host, alias){
            node=xui(node);
            if(node.isEmpty())return this;

            var self=this,
                pro=self.get(0),
                me=arguments.callee,
                paras=me.paras||(me.paras=function(node){
                    var r = node.cssRegion();
                    r.tabindex=node.attr('tabIndex');
                    if(r.tabindex<=0)delete r.tabindex;
                    r.zIndex=node.css('zIndex');
                    r.position=node.css('position');
                    return r;
                }),
                CS=node.attr('style').replace(/\s*(left|top|width|height|right|bottom|position|z-index)\s*\:\s*[\w-.]+\s*/g,''),
                CC=node.attr('class'),
                id=node.id();

            xui.merge(pro.properties, paras(node),'all');
            pro.properties.dock='none';

            if(CS)self.setCustomStyle('KEY',CS);
            if(CC)self.setCustomClass('KEY',CC);
            
            if(id) self.setDomId(id);
            if(alias||id) self.setHost(host||window, alias||id);
            
            self.render(true);
            node.replace(self.getRoot());

            return self;
        },
        setDomId:function(id){
            this.get(0).setDomId(id);
            return this;
        },
        hide:function(ignoreEffects){
            return this.each(function(o){
                if(o.renderId){
                    var t=o.properties,a=ignoreEffects?null:xui.Dom._getEffects(t.hideEffects,0);
                    o.getRoot().hide(function(){
                        t.top=t.left=Math.round(parseFloat(xui.Dom.HIDE_VALUE)||0);
                        t.dockIgnore=true;
                    },a);
                }
            });
        },
        popUp:function(pos, type, parent, trigger, group){
            var prf=this.get(0), t=prf.getRoot();
            if(t=t.get(0)){
                xui(t).pop(pos, type, parent, trigger, group);
            }
        },
        show:function(parent,subId,left,top,ignoreEffects){
            return this.each(function(o){
                var t=o.properties,
                    ins=o.boxing(),
                    b,
                    root=o.getRoot();
                left=(left||left===0)?(left||0):null;
                top=(top||top===0)?(top||0):null;
                if(left!==null)t.left=left;
                if(top!==null)t.top=top;
                if(xui.getNodeData(o.renderId,'_xuihide')){
                    b=1;
                    t.dockIgnore=false;
                    root.show(left&&o.$forceu(left), top&&o.$forceu(top),null,ignoreEffects);
                    if(t.position=='absolute' && t.dock && t.dock!='none')
                        xui.UI.$dock(o,false,true);
                //first call show
                }else{
                    parent = parent || o.parent;
                    if(!parent && (!o.renderId || (o.getRootNode().id || "").indexOf(xui.Dom._emptyDivId)===0))
                        parent=xui('body');
                }
                var p=parent,n;
                if(p){
                    if(p['xui.UIProfile']){n=p.renderId;p=p.boxing()}
                    else if(p['xui.UI'])n=(n=p.get(0))&&n.renderId;
                    else n=(p=xui(p))&&p._nodes[0];
                    if(n){
                        p.append(ins,subId);
//                        if(t.visibility=="hidden")ins.setVisibility("",true);
//                        if(t.display=="none")ins.setDisplay("",true);
                        if(!b)root.show(left&&o.$forceu(left), top&&o.$forceu(top));
                    }
                }
            });
        },
        clone:function(){
            return arguments.callee.upper.apply(this,["domId"]);
        },
        refresh:function(remedy){
            var paras,node,b,p,s,$xid,serialId,mcls,mxid,ar,fun,box,children,uiv,ns=this;
            return ns.each(function(o,i){
                if(!o.renderId)return;

                box=o.box;

                var host=o.host,
                    alias=o.alias;
                if(o.host&&o.host['xui.Module']){
                    o.host.$ignoreAutoDestroy=true;
                }
                //save related id
                $xid=o.$xid;

                serialId=o.serialId;
                mcls = o.moduleClass;
                mxid = o.moduleXid;
                ar=o.$afterRefresh;

                if(typeof o.boxing().getUIValue=='function'){
                    uiv=o.boxing().getUIValue();
                    if((o.boxing().getValue() + " ")==(uiv+" "))
                        uiv=null;
                }

                //keep parent
                if(b=!!o.parent){
                    p=o.parent.boxing();
                    paras=o.childrenId;
                }else
                    p=o.getRoot().parent();

                //protect children's dom node
                //no need to trigger layouttrigger here
                //for example: if use getGhostDiv, upload input cant show file name
                node=remedy?xui.Dom.getEmptyDiv(o.$inDesign).get(0):xui.$getGhostDiv();
                o.boxing().getChildren().reBoxing().each(function(v){
                    node.appendChild(v);
                });
                node=null;

                //keep children
                children = xui.copy(o.children);
                o.boxing().removeChildren();

                //unserialize
                s = o.serialize(false, true);
                fun = o.$refreshTrigger;

                //replace
                var replace = xui.create('span');
                o.getRoot().replace(replace);

                //destroy it
                //avoid reclaiming serialId
                o.$noReclaim=1;

                // keep cache refrence
                var _c=o.Instace;
                o.boxing().destroy(true,true);

                //set back
                xui.merge(o,s,'all');
                // notice: remove destroyed here
                delete o.destroyed;
                o.$xid=$xid;
                o.serialId=serialId;
                o.moduleClass=mcls;
                o.moduleXid=mxid;

                //create
                var n=new box(o).render();

                // set cache refrence
                if(_c){
                    xui.merge(_c,n,'all');
                    n.get(0).Instace=_c;
                    // must reset it to keep memory pointer
                    n=_c;
                }
                ns[i]=n.get(0);

                //for functions like: UI refresh itself
                if(fun)
                    fun.call(fun.target,n.get(0));

                //add to parent, and trigger RenderTrigger
                if(b)
                    p.append(n,paras);
                else
                    p.append(n);

                if(host)n.setHost(host,alias);

                //restore children
                xui.arr.each(children,function(v){
                    delete v[0].$dockParent;
                    n.append.apply(n,v);
                });

                //back to original position
                replace.replace(n.get(0).getRoot());
                replace.remove();
                replace=null;

                if(uiv)
                    n.setUIValue(uiv,true,null,'refresh');

                if(ar){
                    n.get(0).$afterRefresh=ar;
                    ar(n.get(0));
                }
                if(n.host&&n.host['xui.Module']){
                    delete n.host.$ignoreAutoDestroy;
                }
            });
        },
        append:function(target, subId, pre, base){
            var pro=this.get(0),prop=pro.properties;
            // default is append to last
            var index,baseN,
                inParent=arguments[4],
                parentNode=arguments[5];
            // add to first, or previous of base
            pre=!!pre;
            if(base){
                if(base['xui.UI']){
                    base=base.get(0);
                }
                xui.arr.each(pro.children,function(o,i){
                    if(o[0]===base){
                        index=i;
                        return false;
                    }
                });
                if(xui.isNumb(index)){
                    index=pre?index:(index+1);
                    baseN=base.getRoot();
                    if(baseN.isEmpty())baseN=null;
                }
            }else{
                index=pre?0:-1;
            }

            if(xui.isHash(target) || xui.isStr(target))
                target=xui.create(target);
            if(target['xui.UIProfile'])target=target.boxing();

            if(pro.beforeAppend && false===this.beforeAppend(pro,target,subId,pre,base))
                return;

            if(target['xui.Module']){
                if(subId!==false){
                    var i=index;
                    target.getUIComponents().each(function(profile){
                        profile.linkParent(pro,subId,base?(i++):i);
                    });
                }
                if(pro.renderId){
                    parentNode=inParent?parentNode:pro.getContainer(subId);
                    if(parentNode && (!parentNode.isEmpty()) && (!prop.lazyAppend || parentNode.css('display')!='none')){
                        if(!base){
                            parentNode[pre?'prepend':'append'](target);
                        }else if(baseN){
                            baseN[pre?'addPrev':'addNext'](target);
                        }
                    }
                }
                else{
                    xui.arr.insertAny(pro.exmodules||(pro.exmodules=[]),[target,subId],index,true);
                }
            }else{
                if(subId!==false){
                    if(target['xui.UI']){
                        var i=index;
                        target.each(function(profile){
                             if(profile.linkParent)profile.linkParent(pro,subId,base?(i++):i);
                        });
                    }
                }
                if(pro.renderId){
                    var oldp;
                    parentNode=inParent?parentNode:pro.getContainer(subId);
                    if(parentNode && (!parentNode.isEmpty()) && (!prop.lazyAppend || parentNode.css('display')!='none')){
                        if(pro.parent && xui.get(pro,["properties","dock"])!='none' && 'absolute'==xui.get(pro,["properties","position"]) && !xui.get(pro,["properties","dockIgnore"]) && !xui.get(pro,["properties","dockFloat"])){
                            if(target['xui.absBox'])
                                oldp=target.reBoxing().parent();
                        }
                        if(!base){
                            parentNode[pre?'prepend':'append'](target);
                        }else if(baseN){
                            baseN[pre?'addPrev':'addNext'](target);
                        }
                        //adjust old parent
                        if(oldp&&oldp.get(0))
                            oldp.onSize();
                        }
                }else{
                    if(!target['xui.UI']){
                        xui.arr.insertAny(pro.exchildren||(pro.exchildren=[]),[target,subId],index,true);
                    }
                }
            }

            if(pro.afterAppend)
                this.afterAppend(pro,target,subId,pre,base);
            return this;
        },
        getParent:function(){
            var prf=this.get(0);
            if(prf)return prf.parent && prf.parent.boxing();
        },
        getChildrenId:function(){
            var prf=this.get(0);
            if(prf)return prf.childrenId;
        },
        // type: [true]/penetrate, all even in sub moudles
        // type: [false]/include, with moudles
        // type: [other], ignore moudles
        getChildren:function(subId, type){
            // return array only, don't recursive call in any module
            if(type===false || type=="include"){
                var prf=this.get(0),
                    moduleHash={},
                    a=[],z,
                    moduleClass=prf.moduleClass,
                    moduleXid=prf.moduleXid,
                    getModlue=function(p){
                        if(p.moduleClass && p.moduleXid){
                            // exclude the container's module
                            if(p.moduleClass!==moduleClass && p.moduleXid!==moduleXid){
                                // got it already
                                if(moduleHash[z=p.moduleClass+"'"+p.moduleXid+"]"]){
                                    return null;
                                }else{
                                    moduleHash[z]=1;
                                    var q = p.getModule();
                                    // module in module, we use the top mudule only( exclude the container's module )
                                    // look up toward top layer
                                     if(q && q.moduleClass && q.moduleXid && q.moduleClass!==moduleClass && q.moduleXid!==moduleXid){
                                        return getModlue(q);
                                     }else if(q){
                                        return q;
                                     }
                                }
                            }
                        }
                        return p;
                    },
                    f=function(p){
                        xui.arr.each(p.children,function(v,t){
                            t=getModlue(v[0]);
                            if(t){
                                a.push(t);
                                if(t['xui.UIProfile'] && t.children && t.children.length)
                                    f(t);
                            }
                        });
                    };
                xui.arr.each(prf.children,function(v,t){
                    if((subId&&typeof(subId)=="string")?v[1]===subId:1){
                        t=getModlue(v[0]);
                        if(t){
                            a.push(t);
                            if(t['xui.UIProfile'] && t.children && t.children.length)
                                f(t);
                        }
                    }
                });
                // return array only
                return a;
            }else{
                var a=[],f=function(prf){
                    xui.arr.each(prf.children,function(v){
                        a.push(v[0]);
                        if(v[0].children && v[0].children.length)
                            f(v[0]);
                    });
                };
                xui.arr.each(this.get(0).children,function(v){
                    if((subId&&typeof(subId)=="string")?v[1]===subId:1){
                        a.push(v[0]);
                        if((type===true ||type=="penetrate") && v[0].children && v[0].children.length)
                            f(v[0]);
                    }
                });
                return xui.UI.pack(a);
            }
        },
        /**
        * subId:
        *     "id1"
        *     ["id1","id2"]
        *     ["id1;id2"]
        *     [xui.UIProfile]
        *     [xui.UIProfile, [xui.UIProfile]
        *     [xui.UI]
        *     [xui.UI, [xui.UI]
        **/
        removeChildren:function(subId, bDestroy, purgeNow){
            return this.each(function(o){
                var c=xui.copy(o.children),
                    s=o.box.$DataModel.valueSeparator||";",
                    b,arr;
                xui.arr.each(c,function(v){
                    b=0;
                    if(!subId || subId===true){
                        b=1;
                    }else{
                        if(xui.isStr(subId) || xui.isArr(subId)) {
                            arr = xui.isArr(subId)?subId:(subId+"").split(s);
                            b=xui.arr.indexOf(arr, v[1])!=-1 || xui.arr.indexOf(arr, v[0])!=-1 || xui.arr.indexOf(arr, v[0].boxing())!=-1;
                        }else{
                            b=v[0]==subId["xui.UI"]?subId.get(0):subId;
                        }
                    }
                    if(b){
                        if(o.beforeRemove && false===o.boxing().beforeRemove(o,v[0],v[1],bDestroy))
                            return;

                        v[0].unlinkParent();

                        if(o.afterRemove)
                            o.boxing().afterRemove(o,v[0],v[1],bDestroy);

                        if(bDestroy && !v[0].destroyed)
                            v[0].boxing().destroy(true, purgeNow);
                    }
                });
            });
        },
        draggable:function(dragKey, dragData, key, options, target){
            return this.each(function(o){
                o.getSubNode(o.keys[key] || 'KEY', true)
                .beforeMousedown(dragKey?function(pro,e,src){
                    if(xui.Event.getBtn(e)!="left")return;
                    if(pro.properties.disabled)return;

                    var target=target?typeof(target)=="function"?xui.tryF(getTarget,[],o):xui(target):null;
                    if(!target || !target.get(0)){
                        target=xui(src);
                    }

                    options=options||{};
                    options.dragKey=dragKey;
                    options.dragData=typeof dragData == 'function'?dragData():dragData;
                    xui.merge(options,{
                        dragCursor:'pointer',
                        dragType:'icon',
                        dragDefer:2
                    });
                    target.startDrag(e, options);
                }:null,'_d',-1)
                .beforeDragbegin(dragKey?function(profile, e, src){
                    xui.use(src).onMouseout(true,{$force:true}).onMouseup(true);
                }:null,'_d',-1);
                if(!dragKey)
                    o.clearCache();
            });
        },
        setCustomFunction:function(key, value){
            return this.each(function(o){
                if(typeof key=='string'){
                    if(value) o.CF[key]=value;
                    else delete o.CF[key];
                }else
                    o.CF=key||{};
            });
        },
        setCustomClass:function(key, value){
            var me=arguments.callee,
                fun=(me.fun||(me.fun=function(pro,i, h, flag){
                    if(!h[i])return;
                    var node=pro.getSubNode(i,true),b;
                    if(!node.isEmpty())
                        xui.arr.each(h[i].split(/\s+/),function(o){
                            node[flag?'removeClass':'addClass'](o);
                        });
                }));
            return this.each(function(o){
                var bak = xui.copy(o.CC),t;

                //set key and value
                if(typeof key=='string'){
                    t=key;
                    key=xui.copy(o.CC);
                    key[t]=value;
                }
                xui.filter(key,function(o,i){
                    if(!/^[A-Z][A-Z0-9]*$/.test(i)){
                        t=key.KEY=key.KEY||{};
                        if(!(i in t))t[i]=o;
                        return false;
                    }
                    if(!o)return false;
                });
                if(key && typeof key=='object'){
                    if(o.renderId){
                        for(var i in bak)
                            fun(o, i, bak, true);
                        for(var i in key)
                            fun(o, i, key);
                    }
                    o.CC=key;
                //clear all
                }else{
                    if(o.renderId)
                        for(var i in bak)
                            fun(o, i, bak, true);
                    o.CC={};
                }
                delete o._nodeEmSize;
            });
        },
        setCustomAttr:function(key,value,nodes){
            var me=arguments.callee,
                fun=(me.fun||(me.fun=function(pro,key,CAObj,clear,nodes){
                    if(!CAObj[key])return;
                    var hkey=pro.keys[key] || key,
                        tnodes,b;
                    // get target nodes fromin given nodes
                    if(nodes){
                        tnodes=nodes.query('*', 'id', hkey==pro.keys.KEY?pro.domId:new RegExp('^'+hkey+':'+pro.serialId));
                    }
                    // get target nodes from the whole widget
                    else{
                        tnodes=pro.getSubNode(key,true);
                    }
                    if(!tnodes.isEmpty()){
                        if(xui.isHash(CAObj[key])){
                            xui.each(CAObj[key],function(o,i){
                                tnodes.attr(i, clear?'':(o && typeof o=="string")?xui.adjustRes(o,0,1):o);
                            });
                        }
                    }
                }));
            return this.each(function(o){
                var bak = xui.copy(o.CA),t;
                if(typeof key=='string'){
                    t=key;
                    key=xui.copy(o.CA);
                    key[t]=value;
                }
                xui.filter(key,function(o,i){
                    if(!/^[A-Z][A-Z0-9]*$/.test(i)){
                        t=key.KEY=key.KEY||{};
                        if(!(i in t))t[i]=o;
                        return false;
                    }
                    if(!o)return false;
                });
                //set key and value
                if(!!key && typeof key=='object'){
                    if(key){
                        xui.filter(key,function(o,i){
                            return i!='id' && i!='class' && i!='style' && i!='$xid'
                        });
                    }
                    if(o.renderId){
                        for(var i in key)
                            fun(o, i, bak, true, nodes);
                        for(var i in key)
                            fun(o, i, key, false, nodes);
                    }
                    o.CA=key;
                //clear all
                }else{
                    if(o.renderId)
                        for(var i in bak)
                            fun(o, i, bak, true, nodes);
                    o.CA={};
                }
            });
        },
        setCustomStyle:function(key,value,nodes){
            var me=arguments.callee,
                fun=(me.fun||(me.fun=function(prf,key,CSObj,clear,nodes){
                    if(!CSObj[key])return;
                    var hkey=prf.keys[key] || key,
                        tnodes,b;
                    // get target nodes fromin given nodes
                    if(nodes){
                        tnodes=nodes.query('*', 'id', hkey==prf.keys.KEY?prf.domId:new RegExp('^'+hkey+':'+prf.serialId));
                    }
                    // get target nodes from the whole widget
                    else{
                        tnodes=prf.getSubNode(key,true);
                    }
                    if(!tnodes.isEmpty()){
                        if(xui.isStr(CSObj[key]))
                            xui.arr.each(CSObj[key].split(';'),function(o,i){
                                if((b=o.split(':')).length>=2){
                                    i=b.shift();o=b.join(':');
                                    i=i.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()});
                                    tnodes.css(i, (clear?'':(o && typeof o=="string")?xui.adjustRes(o,0,1):o)||"");
                                }
                            });
                         else if(xui.isHash(CSObj[key]))
                            xui.each(CSObj[key],function(v,i){
                                if(xui.isStr(v)){
                                    // "cursor":"point"
                                    if(i.indexOf('background')===0||v.indexOf(';')==-1){
                                         tnodes.css(i, (clear?'':(v && typeof v=="string")?xui.adjustRes(v,0,1):v)||"");
                                    }
                                    // "overflow":"overflow-x:auto;overflow-y:hidden"
                                    else{
                                        xui.arr.each(v.split(';'),function(o){
                                            if((b=o.split(':')).length>=2){
                                                i=b.shift();o=b.join(':');
                                                i=i.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()});
                                                tnodes.css(i, (clear?'':(o && typeof o=="string")?xui.adjustRes(o,0,1):o)||"");
                                            }
                                        });
                                    }
                                }else{
                                    i=i.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()});
                                    tnodes.css(i, (clear?'':(v && typeof v=="string")?xui.adjustRes(v,0,1):v)||"");
                                }
                            });
                    }
                }));
            return this.each(function(o){
                var bak = xui.copy(o.CS),t;

                if(typeof key=='string'){
                    t=key;
                    key=xui.copy(o.CS);
                    key[t]=value;
                }
                xui.filter(key,function(o,i){
                    if(!/^[A-Z][A-Z0-9]*$/.test(i)){
                        t=key.KEY=key.KEY||{};
                        if(!(i in t))t[i]=o;
                        return false;
                    }
                    if(!o)return false;
                });
                //set hash dir
                if(!!key && typeof key=='object'){
                    if(o.renderId){
                        for(var i in bak)
                            fun(o, i, bak, true, nodes);
                        for(var i in key)
                            fun(o, i, key, false, nodes);
                    }
                    o.CS=key;
                //clear all
                }else{
                    if(o.renderId)
                        for(var i in bak)
                            fun(o, i, bak, true, nodes);
                    o.CS={};
                }
                delete o._nodeEmSize;
            });
        },
        setCustomBehavior:function(key, value){
            return this.each(function(o){
                if(typeof key=='string'){
                    if(o.keys[key])
                        o.CB[key]=value||{};
                }else
                    o.CB=key||{};
                if(o.CB.KEY){
                    xui.merge(o.CB, o.CB.KEY, 'all');
                    delete o.CB.KEY;
                }
                o.clearCache();
            });
        },
        adjustDock:function(force){
            return this.each(function(o){
                if(!o.renderId)return;
                var prop=o.properties;
                if(prop.conDockRelative||prop.conLayoutColumns){
                    o.boxing().adjustSize();
                } 
                // adjust self
                if(prop.position=='absolute'){
                    if('dock' in prop && prop.dock && prop.dock!='none' && o.renderId){
                        var n=o.getRootNode();
                        // ensure display
                        if(n && n.clientHeight){
                            if(force){
                                // ensure force 1
                                n.style.width = ((parseFloat(o.$px(n.style.width))||0)+1)+'px';
                                n.style.height = ((parseFloat(o.$px(n.style.height))||0)+1)+'px';
                                // ensure force 
                                o._resize_h=o._resize_w=-1;
                            }
                            xui.UI.$dock(o,true,true);
                        }
                    }
                }else{
                    if(xui.get(o,['parent','properties','conDockRelative'])||xui.get(o,['parent','properties','conLayoutColumns'])){
                        var pp=o.parent;
                        xui.UI._adjustConW(pp, pp.getRoot(), o.getRoot().parent().width(), o.getRootNode());
                    }
                }
                // adjust children
                if(o.$onDock){
                    var n =o.boxing().getContainer(true);
                    if(n&&n.onSize&&n.get(0))n.onSize();
                }
            });
        }
    },
    Initialize:function(){
        var ns=this.prototype;
        xui.arr.each('getSubNode,getSubNodes,getDomId,getRootNode,getRoot,getContainer'.split(','),function(o){
            if(!ns[o])
                ns[o]=function(){
                    var p=this.get(0);
                    return p ? p[o].apply(p,arguments) : null;
                };
                ns[o].$original$='xui.UI';
                ns[o].$type$='instance';
                ns[o].$name$=o;
        });

        var self=this, hash={};
        xui.each(xui.UI.$ps,function(i,o){
            hash[o] = {
                $spaceunit:1,
                ini:'auto',
                action:function(value){
                    var self=this,
                        p=self.properties,b=false,
                        args;
                    self.getRoot()[o]?self.getRoot()[o](value):xui.Dom._setUnitStyle(self.getRootNode(),o,value);
                    if(o=='width'||o=='height'){
                        // for no _onresize widget only
                        if(!self.box._onresize && self.onResize)
                            self.boxing().onResize(self,o=='width'?value:null,o=='height'?value:null)
                    }else{
                        if(self.onMove)
                            self.boxing().onMove(self,o=='left'?value:null,o=='top'?value:null,o=='right'?value:null,o=='bottom'?value:null)
                    }

                    if(p.position=='absolute' && p.dock!='none'){
                            args={
                            $type:p.dock,
                            $dockid:xui.arr.indexOf(['width','height','fill','cover'],p.dock)!=-1?self.$xid:null
                        };
                        switch(p.dock){
                            case 'middle':
                                if(o!='height'&&o!='top')return;
                                args.top=args.height=1;
                                break;
                            case 'center':
                                if(o!='width'&&o!='left')return;
                                args.left=args.width=1;
                                break;
                            case 'top':
                                if(o!='height'&&o!='top')return;
                                args.width=args.height=1;
                                break;
                            case 'bottom':
                                if(o!='height'&&o!='bottom')return;
                                args.width=args.height=1;
                                break;
                            case 'left':
                                if(o!='width'&&o!='left')return;
                                args.width=args.height=1;
                                break;
                            case 'right':
                                if(o!='width'&&o!='right')return;
                                args.width=args.height=1;
                                break;
                            case 'width':
                                if('width'==o)return;
                                args.width=1;
                                break;
                            case 'height':
                                if('height'==o)return;
                                args.height=1;
                                break;
                            case 'fill':
                            case 'cover':
                                if(o=='width'&&o=='height')return;
                                args.width=args.height=1;
                                break;
                        }
                        var pp = xui.UIProfile.getFromDom(self.$dockParent);
                        if(pp)pp.boxing().adjustDock(true);
                    }
                }
            }
        });
        xui.merge(hash,{
            renderer:{
                ini:null
            },
            //invalid after dom dom Node
            zIndex:{
                ini:1,
                action:function(value){
                    this.getRoot().css('zIndex',value);
                }
            },
            tabindex:{
                ini:1,
                action:function(value){
                    var ns=this,
                        reg=new RegExp("^"+ns.key+"[-\\w]*"+":"+ns.serialId+":");
                    ns.getRoot().query("*",function(n){
                        return n.id && reg.test(n.id) && n.getAttribute('tabIndex');
                    }).attr('tabIndex',value);
                }
            },
            position:{
                ini : 'absolute',
                listbox:['','static','relative','absolute'],
                action:function(value){
                    var prf=this, prop=prf.properties;
                    prf.getRoot().css('position',value);
                    if(('dock' in prf.box.$DataModel) && prop.dock!='none' && !prop.dockIgnore){
                        value = prop.dock;
                        prop.dock='none';
                        prf.boxing().adjustDock(true);
                        prop.dock = value;
                    }
                }
            },
            visibility:{
                listbox:['','visible','hidden'],
                action:function(value){
                    this.getRoot().css('visibility',value);
                    // special for resizer
                    if(this.$resizer){
                        if(value=='hidden')
                            this.$resizer.hide();
                        else
                            this.$resizer.show();
                    }

                    xui.setNodeData(this.getRootNode(),'_setVisibility',1);
                }
            },
            display:{
                listbox:['','none','block','inline','inline-block'],
                action:function(value){
                    if(value=='inline-block')
                        this.getRoot().setInlineBlock();
                    else
                        this.getRoot().css('display',value);
                }
            },
            selectable:{
                ini:false,
                action:function(value){
                    this.getRoot().setSelectable(!!value);
                }
            }
        });

        self.setDataModel(hash);

        xui.UI.$cache_css += xui.UI.buildCSSText({
            '.xui-css-viewport':{
                '-webkit-text-size-adjust': '100%',
                '-ms-text-size-adjust': '100%',
                '-ms-overflow-style': 'scrollbar',
                '-webkit-tap-highlight-color': 'transparent',
                'font-size':'62.5%'
            },
            '.xui-css-viewport, .xui-css-viewport body':{
                height:'100%',
                border:'0 none',
                margin:'0',
                padding:'0'
            },
            '.xui-css-viewport body':{
                'font-size': '1rem'
            },
            '@-ms-viewport': {
                width: 'device-width'
            },
            '.xui-ui-draggable':{},
            '.xui-inline-block':{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie?1:null
            },
            ".xui-ui-input":{
                background:'#fff'
            },
            '.xui-ui-shadow-input':{
               '-moz-box-shadow': 'inset 2px 2px 2px #EEEEEE',
               '-webkit-box-shadow': 'inset 2px 2px 2px #EEEEEE',
               'box-shadow': 'inset 2px 2px 2px #EEEEEE'
            },
            '.xui-ui-shadow':{
                '-moz-box-shadow': '2px 2px 4px #CCC',
                '-webkit-box-shadow': '2px 2px 4px #CCC',
                'box-shadow': '2px 2px 4px #CCC',
                /* For IE 8 */
                '-ms-filter': (xui.browser.ie&&xui.browser.ver==8)?"progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#9f9f9f')":null,
                /* For IE 5.5 - 7 */
                'filter': (xui.browser.ie&&xui.browser.ver<=8)?"progid:DXImageTransform.Microsoft.Shadow(Strength=4, Direction=135, Color='#9f9f9f')":null
             },
            '.xui-ui-shadow-r':{
                '-moz-box-shadow': '1px 0  1px #CCC',
                '-webkit-box-shadow': '1px 0  1px #CCC',
                'box-shadow': '1px 0  1px #CCC',
                'z-index':10
            },
            '.xui-ui-shadow-b':{
                '-moz-box-shadow': '0 1px 1px #CCC',
                '-webkit-box-shadow': '0 1px 1px #CCC',
                'box-shadow': '0 1px 1px #CCC',
                'z-index':10
            },
            '.xui-ui-image':{
                'vertical-align':'middle',
                width:'1.3333333333333333em',
                height:'1.3333333333333333em',
                'background-repeat':'no-repeat'
            },
            '.xui-uicmd-none, .xui-display-none':{
                display:'none'
            },
            ".xui-uitembg":{
                padding:'.25em .5em',
                'background-color':'transparent',
                border:'solid 1px transparent'
            },
            ".xui-uitembg-hover":{
                $order:1,
                'background-color':'#E0E0E0',
                'border-color':'#CDCDCD'
            },
            ".xui-uitembg-active":{
                $order:2,
                'background-color':'#CDCDCD',
                'border-color':'B6B6B6'
            },
            ".xui-uitembg-checked":{
                $order:3,
                'background-color':'#CDCDCD',
                'border-color':'B6B6B6'
            },

            ".xui-uicell":{
                "background-color": "#F9F9FB"
            },
            ".xui-uicell-hover":{
                 $order:1,
                "background-color": "#d9e8fb"
            },
            ".xui-uicell-checked":{
                 $order:2,
                "background-color":"#ABABAB",
                color:"#fff"
            },
            ".xui-uicell-alt":{
                 $order:3,
                "background-color":"#FDF8D2"
            },
            '.xui-special-icon':{
                color:'#3393D2',
                'text-shadow': '1px 1px 4px #ccc'
            },
            '.xui-uibar-top, .xui-uibar-bottom, .xui-uibar-top-s, .xui-uibar-bottom-s':{
                position:'relative',
                //for avoiding extra space after table in IE
                'vertical-align':'baseline'
            },
            '.xui-uibar-top td, .xui-uibar-top-s td, .xui-uibar-bottom td, .xui-uibar-bottom-s td':{
            },
//uibar-top
            '.xui-uibar-top':{
            },
            '.xui-uibar-top .xui-uibar-tdl':{
                $order:1,
                position:'absolute',
                width:'12px',
                left:0,
                top:0,
                height:'100%'
            },
            '.xui-uibar-top .xui-uibar-tdm':{
                $order:1,
                position:'absolute',
                top:0,
                left:'12px',
                right:'12px',
                height:'100%',
                width: xui.browser.ie&&xui.browser.ver<=7? "expression((this.parentNode.offsetWidth - 24)+'px')": null
            },
            '.xui-uibar-top .xui-uibar-tdr':{
                $order:1,
                position:'absolute',
                width:'12px',
                top:0,
                right:0,
                height:'100%'
            },
            '.xui-uibar-top .xui-uibar-tdlt':{
                $order:1,
                position:'absolute',
                width:'12px',
                left:0,
                top:0,
                height:'1.5em'
            },
            '.xui-uibar-top .xui-uibar-tdmt':{
                $order:1,
                position:'absolute',
                top:0,
                left:0,
                right:0,
                height:'1.5em',
                width: xui.browser.ie&&xui.browser.ver<=7? "expression((this.parentNode.offsetWidth)+'px')": null
            },
            '.xui-uibar-top .xui-uibar-tdrt':{
                $order:1,
                position:'absolute',
                width:'12px',
                right:0,
                top:0,
                height:'1.5em'
            },
            '.xui-uibar-focus, .xui-uibar-top-focus .xui-uibar-tdl, .xui-uibar-top-focus .xui-uibar-tdm, .xui-uibar-top-focus .xui-uibar-tdr':{
                'background-color':'#B6B6B6'
            },
            '.xui-uibar-top-focus .xuifont, .xui-uibar-top-focus .xuicon, .xui-uibar-top-focus .xui-uicaption':{
            },
            '.xui-uibar-top .xui-uibar-cmdl':{
                overflow:'hidden',
                position:'relative',
                'padding':'.75em 0 .5em .5em',
                'white-space': 'nowrap'
            },
            '.xui-uibar-top2 .xui-uibar-cmdr':{
                position:'absolute',
                top:'-.334em',
                right:'0',
                'text-align':'right'
            },
            '.xui-uibar-top .xui-uibar-cmdr':{
                position:'absolute',
                top:'.75em',
                right:'.5em',
                'text-align':'right'
            },
            '.xui-uibar-top .xui-uibar-tdb':{
                position:'relative',
                display:'none',
                margin:'.16667em .16667em 0 .16667em'
            },
            '.xui-uicon-main':{
                position:'relative',
                'padding-left':'.3333em',
                'z-index':1,
                overflow:'visible'
            },
            '.xui-uicon-maini':{
                'padding-right':'.3333em'
            },
//uibar-bottom
            '.xui-uibar-bottom':{
                'padding':'3px 0'
            },
            '.xui-uibar-bottom .xui-uibar-tdl':{
                $order:1,
                position:'absolute',
                width:'12px',
                left:0,
                bottom:0,
                height:'100%'
            },
            '.xui-uibar-bottom .xui-uibar-tdm':{
                $order:1,
                position:'absolute',
                bottom:0,
                left:'12px',
                right:'12px',
                height:'100%',
                width: xui.browser.ie&&xui.browser.ver<=7? "expression((this.parentNode.offsetWidth - 24)+'px')": null
            },
            '.xui-uibar-bottom .xui-uibar-tdr':{
                $order:1,
                position:'absolute',
                width:'12px',
                right:0,
                bottom:0,
                height:'100%'
            },
//uibar-top-s
            '.xui-uibar-top-s, .xui-uibar-bottom-s, .xui-uibar-top-s .xui-uibar-t':{
                $order:3,
                height:'5px'
            },
            '.xui-uibar-top-s .xui-uibar-tdl':{
                $order:3,
                position:'absolute',
                width:'12px',
                left:0,
                top:0,
                height:'100%'
            },
            '.xui-uibar-top-s .xui-uibar-tdm':{
                $order:3,
                position:'absolute',
                top:0,
                left:'12px',
                right:'12px',
                height:'100%',
                width: xui.browser.ie&&xui.browser.ver<=7? "expression((this.parentNode.offsetWidth - 24)+'px')": null
            },
            '.xui-uibar-top-s .xui-uibar-tdr':{
                $order:3,
                position:'absolute',
                width:'12px',
                top:0,
                right:0,
                height:'100%'
            },
            '.xui-uibar-top-s .xui-uibar-cmdl':{
                $order:3,
                display:'none'
            },
            '.xui-uibar-top-s .xui-uibar-cmdr':{
                $order:3,
                display:'none'
            },
//uibar-bottom-s
            '.xui-uibar-bottom-s .xui-uibar-tdl':{
                $order:3,
                position:'absolute',
                width:'12px',
                left:0,
                bottom:0,
                height:'100%'
            },
            '.xui-uibar-bottom-s .xui-uibar-tdm':{
                $order:3,
                position:'absolute',
                bottom:0,
                left:'12px',
                right:'12px',
                height:'100%',
                width: xui.browser.ie&&xui.browser.ver<=7? "expression((this.parentNode.offsetWidth - 24)+'px')": null
            },
            '.xui-uibar-bottom-s .xui-uibar-tdr':{
                $order:3,
                position:'absolute',
                width:'12px',
                right:0,
                bottom:0,
                height:'100%'
            }
        })
        + xui.UI.buildCSSText({
            '.xui-ui-unselectable':{
                $order:0,
                '-moz-user-select': xui.browser.gek?'-moz-none':null,
                '-khtml-user-select': xui.browser.kde?'none':null,
                '-webkit-user-select': xui.browser.kde?'none':null,
                '-o-user-select':xui.browser.opr?'none':null,
                '-ms-user-select':(xui.browser.ie||xui.browser.newie)?'none':null,
                'user-select':'none'
            },
            '.xui-ui-selectable':{
                $order:1,
                '-moz-user-select': xui.browser.gek?'text':null,
                '-khtml-user-select': xui.browser.kde?'text':null,
                '-webkit-user-select': xui.browser.kde?'text':null,
                '-o-user-select':xui.browser.opr?'text':null,
                '-ms-user-select':(xui.browser.ie||xui.browser.newie)?'text':null,
                'user-select':'text'
            },
            '.xui-uiw-shell':{
//                background:'transparent',
                display:xui.$inlineBlock,
                zoom:xui.browser.ie&&xui.browser.ver<=7?1:null,
                //overflow:'hidden',
                /*opera must be 0 not 'none'*/
                border:0,
                padding:0,
                margin:0
            },
            /*span*/
            '.xui-uiw-frame':{
                $order:1,
                display:'block',
                position:'relative',
                //overflow:'hidden',
                border:0,
                padding:0,
                margin:0,
                width:'100%',
                height:'100%',
                '-moz-box-flex':'1'
            },
            /*span*/
            '.xui-uiw-border':{
                $order:2,
                display:'block',
                //position:'absolute',
                // modify to relative for 'auto' height
                position:'relative',
                border:0,
                padding:0,
                margin:0,
                left:0,
                top:0,
                width:'100%',
                height:'100%'
            }
        })
        + xui.UI.buildCSSText({
            '.xui-uibase':{
                'background-color':'#FFFFFF'
            },
            '.xui-uicontainer':{
            },
            '.xui-uibar':{
                'background-color':'#E0E0E0'
            },
            '.xui-uibar-hover':{
                $order:1,
                'background-color':'#CDCDCD'
            },
            ".xui-uibar-active, .xui-uibar-checked, .xui-uibar-expand, .xui-uimenu-hover, .xui-uimenu-active":{
                $order:2,
                 "background-color":"#ABABAB"
            },
            ".xui-ui-ctrl-highlight, .xui-node-highlight, .xui-uibar-checked,  .xui-uibar-expand, .xui-uimenu-hover, .xui-uimenu-active":{
                $order:3,
                color:"#FFF"
            },
            ".xui-ui-btn::-moz-focus-inner":{
                $order:3,
                padding: "0 !important",
                border: "0 none !important"
            },
            ".xui-uigradient":{
                $order:4,
                border: 'solid 1px #B6B6B6',
                color: "#333",
                'text-shadow': '0px 1px 1px rgba(255,255,255,1)',
                'text-decoration': 'none',
                'white-space':'nowrap',
                'background-image_1': "linear-gradient(top,  #FFF 5%,  #CDCDCD 100%)",
                'background-image_2': "-webkit-gradient(linear, 0% 0%, 0% 100%, from(0.05, #FFF), to(1, #CDCDCD))",
                'background-image_3': "-webkit-linear-gradient(top,  #FFF 5%,  #CDCDCD 100%)",
                'background-image_4': "-moz-linear-gradient(top,  #FFF 5%,  #CDCDCD 100%)",
                'background-image_5': "-o-linear-gradient(top,  #FFF 5%,  #CDCDCD 100%)",
                'background-image_6': "-ms-linear-gradient(top,  #FFF 5%,  #CDCDCD 100%)",

                // for IE6789
                '-ms-filter': (xui.browser.ie&&xui.browser.ver==8)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFF', endColorstr='#CDCDCD', GradientType=0)":null,
                filter: (xui.browser.ie&&xui.browser.ver<=9)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFF', endColorstr='#CDCDCD', GradientType=0)":null
            },
            ".xui-uigradient-hover, .xui-uigradient:hover":{
                $order:5,
                'background-image_1': "linear-gradient(top,  #FFF 5%,  #EEE 100%)",
                'background-image_2': "-webkit-gradient(linear, 0% 0%, 0% 100%, from(0.05, #FFF), to(1, #EEE))",
                'background-image_3': "-webkit-linear-gradient(top,  #FFF 5%,  #EEE 100%)",
                'background-image_4': "-moz-linear-gradient(top,  #FFF 5%,  #EEE 100%)",
                'background-image_5': "-o-linear-gradient(top,  #FFF 5%,  #EEE 100%)",
                'background-image_6': "-ms-linear-gradient(top,  #FFF 5%,  #EEE 100%)",

                // for IE6789
                '-ms-filter': (xui.browser.ie&&xui.browser.ver==8)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFF', endColorstr='#CDCDCD', GradientType=0)":null,
                filter: (xui.browser.ie&&xui.browser.ver<=9)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#FFFFFF', endColorstr='#CDCDCD', GradientType=0)":null
            },
            ".xui-uigradient-active, .xui-uigradient-checked, .xui-uigradient-expand, .xui-uigradient:active, .xui-uigradient-active:hover, .xui-uigradient-checked:hover, .xui-uigradient-expand:hover":{
                $order:6,
                'background-image_1': "linear-gradient(top,  #CDCDCD 5%,  #FFF)",
                'background-image_2': "-webkit-gradient(linear, 0% 0%, 0% 100%, from(0.05, #CDCDCD), to(1, #FFF))",
                'background-image_3': "-webkit-linear-gradient(top,  #CDCDCD 5%,  #FFF 100%)",
                'background-image_4': "-moz-linear-gradient(top,  #CDCDCD 5%,  #FFF 100%)",
                'background-image_5': "-o-linear-gradient(top,  #CDCDCD 5%,  #FFF 100%)",
                'background-image_6': "-ms-linear-gradient(top,  #CDCDCD 5%,  #FFF 100%)",
                // for IE6789
                '-ms-filter':(xui.browser.ie&&xui.browser.ver==8)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#CDCDCD', endColorstr='#FFFFFF', GradientType=0)":null,
                filter: (xui.browser.ie&&xui.browser.ver<=9)?"progid:DXImageTransform.Microsoft.gradient(startColorstr='#CDCDCD', endColorstr='#FFFFFF', GradientType=0)":null
            },
            ".xui-ui-btn":{
                $order:7,
                padding: ".334em",
                'white-space': 'normal',
                cursor: 'pointer',
                'border': 'solid 1px #B6B6B6',
                display: xui.$inlineBlock,
                'text-align': 'center',
                'line-height': '1',
                zoom:xui.browser.ie?1:null,
                // for IE6
                'width_1':(xui.browser.ie&&xui.browser.ver<=7)?'auto':null,
                'overflow':(xui.browser.ie&&xui.browser.ver<=7)?'visible':null
            },
            ".xui-ui-btn:hover, .xui-ui-btn-hover":{
                $order:8,
                'border-color': '#B5B5B5'
            },
            '.xui-uiborder-l':{
                'border-left-style':'solid',
                'border-left-width':'1px',
                'border-left-color':'#F6F6F6'
            },
            '.xui-uiborder-r':{
                'border-right-style':'solid',
                'border-right-width':'1px',
                'border-right-color':'#B6B6B6'
            },
            '.xui-uiborder-t':{
                'border-top-style':'solid',
                'border-top-width':'1px',
                'border-top-color':'#F6F6F6'
            },
            '.xui-uiborder-b, .xui-uitem-split':{
                'border-bottom-style':'solid',
                'border-bottom-width':'1px',
                'border-bottom-color':'#B6B6B6'
            },
            '.xui-uiborder-nob':{
                $order:1,
                'border-bottom-width':0,
                'border-bottom-style':'none'
            },
            '.xui-uiborder-hidden':{
                border:'solid 1px transparent',
                background:'none'
            },
            '.xui-uiborder-hidden-active, .xui-uiborder-hidden-checked':{
                background:'#efefef'
            },
            '.xui-uiborder-flat':{
                border:'solid 1px #B6B6B6'
            },
            '.xui-uiborder-outset':{
                $order:8,
                border:'solid 1px',
                'border-color':'#F6F6F6 #B6B6B6 #B6B6B6 #F6F6F6'
            },
            '.xui-uiborder-inset, .xui-uiborder-hidden-active, .xui-uiborder-hidden-checked':{
                $order:10,
                border:'solid 1px',
                'border-color':'#B6B6B6 #F6F6F6 #F6F6F6 #B6B6B6'
            },
            '.xui-uiborder-dark, .xui-uiborder-flat-hover':{
                'border-color':'#B6B6B6'
            },
            '.xui-uiborder-light, .xui-uiborder-hidden-hover':{
                'border-color':'#efefef'
            },
            '.xui-uiborder-radius':{
                $order:11,
                'border-radius':'3px',
                '-moz-border-radius': '3px',
                '-webkit-border-radius': '3px',
                '-o-border-radius': '3px',
                '-ms-border-radius': '3px',
                '-khtml-border-radius': '3px'
            },
            '.xui-uiborder-radius-big':{
                $order:11,
                'border-radius':'6px',
                '-moz-border-radius': '6px',
                '-webkit-border-radius': '6px',
                '-o-border-radius': '6px',
                '-ms-border-radius': '6px',
                '-khtml-border-radius': '6px'
            },
            '.xui-uiborder-radius-tl':{
                $order:12,
                'border-top-left-radius':'3px',
                '-moz-border-top-left-radius': '3px',
                '-webkit-border-top-left-radius': '3px',
                '-o-border-top-left-radius': '3px',
                '-ms-border-top-left-radius': '3px',
                '-khtml-border-top-left-radius': '3px'
            },
            '.xui-uiborder-radius-tr':{
                $order:12,
                'border-top-right-radius':'3px',
                '-moz-border-top-right-radius': '3px',
                '-webkit-border-top-right-radius': '3px',
                '-o-border-top-right-radius': '3px',
                '-ms-border-top-right-radius': '3px',
                '-khtml-border-top-right-radius': '3px'
            },
            '.xui-uiborder-radius-br':{
                $order:12,
                'border-bottom-right-radius':'3px',
                '-moz-border-bottom-right--radius': '3px',
                '-webkit-border-bottom-right--radius': '3px',
                '-o-border-bottom-right--radius': '3px',
                '-ms-border-bottom-right--radius': '3px',
                '-khtml-border-bottom-right--radius': '3px'
            },
            '.xui-uiborder-radius-bl':{
                $order:12,
                'border-bottom-left-radius':'3px',
                '-moz-border-bottom-left-radius': '3px',
                '-webkit-border-bottom-left-radius': '3px',
                '-o-border-bottom-left-radius': '3px',
                '-ms-border-bottom-left-radius': '3px',
                '-khtml-border-bottom-left-radius': '3px'
            },
            '.xui-uiborder-radius-big-tl':{
                $order:13,
                'border-top-left-radius':'6px',
                '-moz-border-top-left-radius': '6px',
                '-webkit-border-top-left-radius': '6px',
                '-o-border-top-left-radius': '6px',
                '-ms-border-top-left-radius': '6px',
                '-khtml-border-top-left-radius': '6px'
            },
            '.xui-uiborder-radius-big-tr':{
                $order:13,
                'border-top-right-radius':'6px',
                '-moz-border-top-right-radius': '6px',
                '-webkit-border-top-right-radius': '6px',
                '-o-border-top-right-radius': '6px',
                '-ms-border-top-right-radius': '6px',
                '-khtml-border-top-right-radius': '6px'
            },
            '.xui-uiborder-radius-big-br':{
                $order:13,
                'border-bottom-right-radius':'6px',
                '-moz-border-bottom-right--radius': '6px',
                '-webkit-border-bottom-right--radius': '6px',
                '-o-border-bottom-right--radius': '6px',
                '-ms-border-bottom-right--radius': '6px',
                '-khtml-border-bottom-right--radius': '6px'
            },
            '.xui-uiborder-radius-big-bl':{
                $order:13,
                'border-bottom-left-radius':'6px',
                '-moz-border-bottom-left-radius': '6px',
                '-webkit-border-bottom-left-radius': '6px',
                '-o-border-bottom-left-radius': '6px',
                '-ms-border-bottom-left-radius': '6px',
                '-khtml-border-bottom-left-radius': '6px'
            },

            '.xui-uiborder-noradius':{
                $order:15,
                'border-radius':'0 !important',
                '-moz-border-radius': '0 !important',
                '-webkit-border-radius': '0 !important',
                '-o-border-radius': '0 !important',
                '-ms-border-radius': '0 !important',
                '-khtml-border-radius': '0 !important'
            },
            '.xui-uiborder-noradius-l':{
                $order:15,
                'border-top-left-radius':'0 !important',
                '-moz-border-top-left-radius': '0 !important',
                '-webkit-border-top-left-radius': '0 !important',
                '-o-border-top-left-radius': '0 !important',
                '-ms-border-top-left-radius': '0 !important',
                '-khtml-border-top-left-radius': '0 !important',

                'border-bottom-left-radius':'0 !important',
                '-moz-border-bottom-left-radius': '0 !important',
                '-webkit-border-bottom-left-radius': '0 !important',
                '-o-border-bottom-left-radius': '0 !important',
                '-ms-border-bottom-left-radius': '0 !important',
                '-khtml-border-bottom-left-radius': '0 !important'
            },
            '.xui-uiborder-noradius-r':{
                $order:15,
                'border-top-right-radius':'0 !important',
                '-moz-border-top-right-radius': '0 !important',
                '-webkit-border-top-right-radius': '0 !important',
                '-o-border-top-right-radius': '0 !important',
                '-ms-border-top-right-radius': '0 !important',
                '-khtml-border-top-right-radius': '0 !important',

                'border-bottom-right-radius':'0 !important',
                '-moz-border-bottom-right-radius': '0 !important',
                '-webkit-border-bottom-right-radius': '0 !important',
                '-o-border-bottom-right-radius': '0 !important',
                '-ms-border-bottom-right-radius': '0 !important',
                '-khtml-border-bottom-right-radius': '0 !important'
            },
            '.xui-uiborder-noradius-t':{
                $order:15,
                'border-top-left-radius':'0 !important',
                '-moz-border-top-left-radius': '0 !important',
                '-webkit-border-top-left-radius': '0 !important',
                '-o-border-top-left-radius': '0 !important',
                '-ms-border-top-left-radius': '0 !important',
                '-khtml-border-top-left-radius': '0 !important',

                'border-top-right-radius':'0 !important',
                '-moz-border-top-right-radius': '0 !important',
                '-webkit-border-top-right-radius': '0 !important',
                '-o-border-top-right-radius': '0 !important',
                '-ms-border-top-right-radius': '0 !important',
                '-khtml-border-top-right-radius': '0 !important'
            },
            '.xui-uiborder-noradius-b':{
                $order:15,
                'border-bottom-left-radius':'0 !important',
                '-moz-border-bottom-left-radius': '0 !important',
                '-webkit-border-bottom-left-radius': '0 !important',
                '-o-border-bottom-left-radius': '0 !important',
                '-ms-border-bottom-left-radius': '0 !important',
                '-khtml-border-bottom-left-radius': '0 !important',

                'border-bottom-right-radius':'0 !important',
                '-moz-border-bottom-right-radius': '0 !important',
                '-webkit-border-bottom-right-radius': '0 !important',
                '-o-border-bottom-right-radius': '0 !important',
                '-ms-border-bottom-right-radius': '0 !important',
                '-khtml-border-bottom-right-radius': '0 !important'
            },
            '.xui-ui-noshadow, .xui-ui-noshadow .xui-ui-shadow-input, .xui-ui-noshadow .xui-ui-shadow, .xui-ui-noshadow .xui-ui-shadow-b, .xui-ui-noshadow .xui-ui-shadow-r,  .xui-ui-disabled .xui-ui-shadow-input,  .xui-ui-readonly .xui-ui-shadow-input,  .xui-ui-inputreadonly .xui-ui-shadow-input':{
                $order:15,
               '-moz-box-shadow': 'none !important',
               '-webkit-box-shadow': 'none !important',
               'box-shadow': 'none !important'
            },
            '.xui-uiborder-circle':{
                $order:16,
                'border-radius':'50%',
                '-moz-border-radius': '50%',
                '-webkit-border-radius': '50%',
                '-o-border-radius': '50%',
                '-ms-border-radius': '50%',
                '-khtml-border-radius': '50%'
            },
            '.xui-uiflag-1':{
                $order:16,
                'border-radius':'50%',
                '-moz-border-radius': '50%',
                '-webkit-border-radius': '50%',
                '-o-border-radius': '50%',
                '-ms-border-radius': '50%',
                '-khtml-border-radius': '50%',

                width:xui.browser.contentBox?'1em':'1.625em',
                height:xui.browser.contentBox?'1em':'1.625em',
                padding: '.334em',
                'background-color': '#eb6e1a',
                color:'#fff !important',
                overflow:'hidden',
                'text-align': 'center'
            },
            '.xui-uiborder-none':{
                $order:20,
                border:'none'
            },
            '.xui-uisb':{
                position:'absolute'
            },
            '.xui-uisb-none':{
                display:'none'
            },
            '.xui-uisb-left':{
                left:0,
                top:0,
                width:'3em',
                height:'100%'
            },
            '.xui-uisb-right':{
                top:0,
                right:0,
                width:'3em',
                height:'100%'
            },
            '.xui-uisb-top':{
                left:0,
                top:0,
                width:'100%',
                height:'3em'
            },
            '.xui-uisb-bottom':{
                left:0,
                bottom:0,
                width:'100%',
                height:'3em'
            },
            '.xui-uisbbtn':{
                position:'absolute',
                cursor:'pointer',
                'z-index':1,
                width:'1em',
                height:'1em'
            },
            '.xui-uisb-left .xui-uisbbtn':{
                left:0,
                top:0
            },
            '.xui-uisb-right .xui-uisbbtn':{
                right:0,
                top:0
            },
            '.xui-uisb-top .xui-uisbbtn':{
                right:0,
                bottom:0
            },
            '.xui-uisb-bottom .xui-uisbbtn':{
                right:0,
                top:0
            },
            '.xui-uisbcap':{
               position:'relative',
               'text-align':'center',
               width:'100%',
               height:'100%'
            },
            '.xui-uisb-left .xui-uisbcap, .xui-uisb-right .xui-uisbcap':{
                'writing-mode': 'tb-rl',
                filter: 'flipv fliph'
            },
            '.xui-ltag-cmds':{
                margin:0,
                padding:0,
                'vertical-align':'middle'
            },
            '.xui-rtag-cmds':{
                margin:0,
                padding:0,
                'vertical-align':'middle'
            },
            '.xui-tag-cmd':{
                "margin":'0 .125em',
                "padding": '.1667em',
                'vertical-align':'middle'
            },
            '.xui-inline-object':{
                'vertical-align':'middle',
                'margin':'0 .16666667em'
            }
        });

        xui.UI.$cache_css2 += xui.UI.buildCSSText({
            '.xui-css-innerimage':{
                'vertical-align': 'middle'
            },
            '.xui-uitem-split':{
                display: 'block',
                position: 'relative',
                overflow: 'visible',
                'white-space': 'nowrap',
                margin: '2px 0',
                padding: 0
            },
            '.xui-css-noscroll, .xui-css-noscroll body':{
                overflow:'hidden',
                'overflow-x':'hidden',
                'overflow-y':'hidden'
            },
            '.xui-css-noscrollx, .xui-css-noscroll body':{
                'overflow-x':'hidden'
            },
            '.xui-css-noscrolly, .xui-css-noscroll body':{
                'overflow-y':'hidden'
            },
            '.xui-css-dockparent':{
                overflow:'hidden'
             },
            '.xui-ui-dirty':{
                $order:1,
                'background-image':'url(data:image/gif;base64,R0lGODlhBwAHAPcAAAAAADDSEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAP8ALAAAAAAHAAcAAAgYAAMIHPhvoMB/BQkiVLgwAMKHDh9KnBgQADs=)',
                'background-repeat':'no-repeat',
                'background-position':'left top'
            },
            '.xui-float-clear':{
                'clear':'both'
            },
            '.xui-float-left':{
                'float':'left'
            },
            '.xui-float-right':{
                'float':'right'
            },
            /*
            ".xui-ui-diry:after":{
                content: "";
                position: 'absolute',
                top: 0,
                left: 0,
                width: 0,
                height: '1px',
                'z-index':100,
                'border-top': '8px solid #f44',
                'border-right': '8px solid transparent'
            },*/
            '.xui-ui-ellipsis':{
                "max-width": "100%",
                "text-overflow": "ellipsis",
                "white-space": "nowrap",
                "overflow": "hidden"
            },
            '.xui-ui-ruler':{
                width:0,
                height:'1.22em',
                'vertical-align':'middle'
            },
            '.xui-nodatauri .xui-ui-dirty':{
                $order:2,
                'background-image':xui.UI.$oldBg('dirtymark.gif', 'no-repeat left top')
            },
            // Firefox will ignore input:read-only
            '.xui-ui-ctrl-readonly, .xui-node-readonly, input[readonly], textarea[readonly], input:read-only, textarea:read-only, .xui-ui-readonly, .xui-ui-itemreadonly, .xui-ui-readonly .xui-node, .xui-ui-itemreadonly .xui-node, xui-ui-inputreadonly input, xui-ui-inputreadonly textarea':{
                $order:2,
                color: '#666666 !important'
            },
            'button::-moz-focus-inner, input::-moz-focus-inner':{
                 padding: 0,
                 border: 0
             },
            '.xui-ui-ctrl-disabled, .xui-node-disabled, button:disabled, a:disabled, input:disabled, textarea:disabled,  .xui-ui-disabled,  .xui-ui-itemdisabled,  .xui-ui-disabled .xui-node, .xui-ui-itemdisabled .xui-node, .xui-uicell-disabled, .xui-uicell-disabled .xui-node':{
                $order:2,
                cursor:'not-allowed',
                color: '#808080 !important'
            },
            '.xui-ui-ctrl-disabled, .xui-node-disabled, button:disabled, a:disabled, input:disabled, textarea:disabled,  .xui-ui-disabled input,.xui-ui-disabled textarea, .xui-ui-itemdisabled input, .xui-ui-itemdisabled textarea, .xui-uicell-disabled':{
                $order:3,
                'background-color':'#eee !important'
            },
            '.xui-ui-invalid, .xui-ui-invalid .xui-node':{
                $order:1,
                'background-color': '#FFEBCD !important'
            },
            '.xui-item-row':{
                display:"block",
                'white-space': 'nowrap'
            },
            ".xui-required":{
                "color":"#ff0000 !important"
            },
            '.xui-alert':{
                'background-color':'#ff6600 !important'
            },
             ".xui-uisyle-mobile":{
                "background-clip": "padding-box",
                border: "10px solid #333333",
                "border-radius": "12px",
                "box-shadow": "0 0 15px rgba(0, 0, 0, 0.28), 0 1px 1px rgba(255, 255, 255, 0.45) inset, 0 0 2px rgba(255, 255, 255, 0.2) inset"
            },
            ".xui-uisyle-mobile, .xui-uisyle-mobile *, .xui-cursor-touch, .xui-cursor-touch *": {
                cursor: 'url('+xui.ini.img_touchcur+') 8 8,auto!important'
            },
            '.xui-icon-loading':{
                $order:7,
                width:(xui.browser.ie&&xui.browser.ver<=8)?'1em':null,
                height:(xui.browser.ie&&xui.browser.ver<=8)?'1em':null,
                'background-image': (xui.browser.ie&&xui.browser.ver<10)?'url('+xui.ini.img_busy+')':null,
                "background-repeat":(xui.browser.ie&&xui.browser.ver<10)?"no-repeat":null,
                "background-position":(xui.browser.ie&&xui.browser.ver<10)?"center center":null
            },
            ".xui-icon-loading:before":{
                $order:7,
                visibility:(xui.browser.ie&&xui.browser.ver<10)?'hidden':null
            },
            ".xui-load-error":{
                width:(xui.browser.ie&&xui.browser.ver<=8)?'1em':null,
                height:(xui.browser.ie&&xui.browser.ver<=8)?'1em':null,
                "background-image": (xui.browser.ie&&xui.browser.ver<=8)?"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAEgAAABIAEbJaz4AAAAJdnBBZwAAABAAAAAQAFzGrcMAAADdSURBVCjPfdGxTsJQGIbhpw20GgN1IZQBDQnGxvu/FEU3IjEBB5SKUsGkdTiCYeGb/pw803uixum1iMJ1KZdp40dpYQWNqBERuXItRY1YrPJspmm0wNAYlZkvdPR1jTVmtJAZgUhliaWFQs9IqYwxkKhUUnf64NuTD6kBMTK8mKgkigNZaGQBJGqfVh6PyFotCWC/NxMbiUL+/xhjJ9Y5kEriVk9HbBdAKZI7A+8ebLQVhigDmNvqKg7k3kZbamceOpSmbvSkXq1xIfSfKh2lPlf/pWa7Tx3A6c86vV+v4FNOkQDWwAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxMC0wMi0xMVQxMTo1MDowOC0wNjowMNYQZfsAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMDYtMDUtMDVUMTM6MjI6NDAtMDU6MDC/5P4aAAAAAElFTkSuQmCC)":null,
                "background-repeat": (xui.browser.ie&&xui.browser.ver<=8)?"no-repeat":null,
                "background-position": (xui.browser.ie&&xui.browser.ver<=8)?"center center":null
            },
            ".xui-load-error:before":{
                $order:7,
                visibility:(xui.browser.ie&&xui.browser.ver<=8)?'hidden':null
            },
            ".xui-ui-clear":{
                $order:10,
                border:'none',
                background:'none'
             }
        });
    },
    $End:function(){
        var hash={},keys=this.$Keys;
        xui.filter(this.getAppearance(),function(o,i){
            var arr1=i.split(/\s*,\s*/),arr2;
            for(var l=arr1.length-1;l>=0;l--){
                arr2=arr1[l].match(/[A-Z][A-Z0-9]*/g);
                if(arr2&&arr2.length){
                    for(var j=0,m=arr2.length;j<m;j++){
                        if(!keys[arr2[j]]){
                            arr1.splice(l,1);
                            break;
                        }
                    }
                }
            }
            if(arr1.length)hash[arr1.join(", ")]=o;
        });
        this.setAppearance(hash);
        xui.UI.$cache_css += this.buildCSSText(this.$Appearances);
    },
    Static:{
        $cache_css:'',
        $cache_css2:'',
        $css_tag_dirty: "xui-ui-dirty",
        $css_tag_invalid: "xui-ui-invalid",
        $tag_left:"{",
        $tag_right:"}",
        $tag_subId:"_serialId",
        $tag_subId_c:"_serialId_c",

        $x01:/\x01/img,
        $x01r:/ \x01 /img,

        $tag_special:'\x01',
        $ID:"\x01id\x01",
        $DOMID:'\x01domid\x01',
        $CLS:"\x01cls\x01",
        $MODULECLS:"\x01modulecls\x01",
        $TAGCLASS:"\x01tagcls\x01",
        $childTag:"<!--\x03{id}\x04-->",

        $onSize:function(profile,e){
            var style = profile.getRootNode().style;
            if(e.width||e.height)
                xui.UI.$tryResize(profile, style.width, style.height);
            style=null;
        },
        $ps:{left:1,top:1,width:1,height:1,right:1,bottom:1},
        objectProp:{},
        $toDom:function(profile, str, addEventHandler){
            if(addEventHandler===false)
                return xui.str.toDom(str);

            //must use empty div for RenderTriggers
            var matrix=xui.Dom.getEmptyDiv(profile.$inDesign).get(0), r=[];
            // for control size
            matrix.style.position='relative';
            matrix.style.display='none';
            matrix.innerHTML=str;
            //add event handlers
            this.$addEventsHanlder(profile, matrix);
            for(var i=0,t=matrix.childNodes,l=t.length;i<l;i++){
                //ensure the root nodes
                xui.$registerNode(t[i]);
                r[r.length]=t[i].$xid;
            }
            matrix.style.display='';
            matrix=null;
            return xui(r,false);
        },
        $evtsindesign:{
            "onload":1,
            "onerror":1,
            "onscroll":1,
            "onunload":1,
            "onsize":1,
            "onmousedown":1,
            "onmouseup":1
        },
        _handleEventConf:function(conf, args){
            var ns=this;
        },
        $addEventsHanlder:function(profile, node, includeSelf){
            var ch=xui.$cache.UIKeyMapEvents,
                eh=xui.Event._eventHandler,
                hash=this.$evtsindesign,
                handler=xui.Event.$eventhandler,
                children=xui.toArr(node.getElementsByTagName('*')),
                i,l,j,k,id,t,v;

            if(includeSelf)
                children.push(node);
            if(l=children.length){
                for(i=0;i<l;i++){
                    if((node=children[i]).nodeType!=1)continue;
                    if(id=node.id){
                        if(t = ch[id] || ch[id.substr(0,id.indexOf(':'))] ){
                            v=xui.$registerNode(node);
                            v=v.eHandlers||(v.eHandlers={});
                            for(j in t){
                                if(profile.$inDesign && !hash[j])continue;
                                //attach event handler to domPurgeData
                                v[j]=t[j];
                                //attach event handler to dom node
                                if(k=eh[j]){
                                    v[k]=node[k]=t[j];
                                    if(xui.browser.isTouch && k=='onmousedown'){
                                        xui.setNodeData(node, ['eHandlers', 'onxuitouchdown'], handler);
                                        if(node.addEventListener){
                                            node.addEventListener("xuitouchdown", handler,false);
                                        }else if(node.attachEvent){
                                            node.attachEvent("xuitouchdown", handler);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            children.length=0;
            node=t=null;
        },
        setDftProp:function(prop){
            this.__resetDftProp=prop;
            return this;
        },
        getFromDom:function(id){
            if(id=xui.UIProfile.getFromDom(id))
                return id.boxing();
        },
        _ensureValues:function(arr){
            var a=[],i=0,k=0,o,key=this.KEY,cache=xui.$cache.profileMap,getData=xui.getNodeData;
            if(arr['xui.absBox'])arr=arr._nodes;
            for(;o=arr[i++];)
                if((o.box && o.box[key]) || ((o=cache[getData(o.renderId?o.renderId:o,['element','id'])]) && o.box && o.box[key]))
                    a[k++]=o;
            return a.length<=1?a:this._unique(a);
        },

        __gc:function(){
            var self=this, k=self.$key, cache=xui.$cache;
            //clear templates memory in xui.$cache
            xui.breakO([cache.template[k], cache.reclaimId[k], self._cache, self._idCache, self.$DataModel, self.$Templates,  self.$Behaviors, self],2);
            delete xui.absBox.$type[k.replace("xui.UI.","")];
            delete xui.absBox.$type[k];
            xui.filter(xui.$cache.UIKeyMapEvents,function(o,i){
                return !(i==k||i.indexOf(k+'-')==0);
            });
            // add for base class
            Class.__gc(k);
        },
        _pickSerialId:function(){
            //get id from cache or id
            var arr = xui.$cache.reclaimId[this.$key];
            if(arr && arr[0])return arr.pop();
            return this._ctrlId.next();
        },
        $oldBg:function(path, paras, forceKey, root){
            return function(key){
                //xui.asyRun(function(){new Image().src=p;});
                return 'url(' + xui.ini.path + 'appearance/_oldbrowser/' + path +') '+ (paras||'');
            }
        },
        $ieOldBg:function(path){
            return function(key){
                //xui.asyRun(function(){new Image().src=p;});
                return 'progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+xui.ini.path + 'appearance/_oldbrowser/' + path+'",sizingMethod="crop")';
            }
        },
       /* deep template function
          template: string
          properties: hash

          $doTemplate("{a}{b}{c}{a}{b}{/c}", {a:'*',b:'#',c:[{a:'1',b:'.'},{a:'2',b:'.'},{a:'3',b:'.'},{a:'4',b:'.'}]})
              will return "*#1.2.3.4."
          doTemplate("{a}{b}{c}{}{/c}", {a:'*',b:'#',c:['1','2','3','4']})
              will return "*#1234"

          flag: default flase => no clear not mactched symbols
        */
        $doTemplate:function(profile, template, properties, tplTag, result, index, realTag){
            var self=xui.UI.$doTemplate,
                s,t,n,
                x01=xui.UI.$x01,
                x01r=' \x01 ',
                str='',
                isA = xui.isArr(properties),
                // this one maybe a fake tamplate tag, for switch function
                temp = template[tplTag||''],
                r = !result,
                result= result || [];
            // get the real tag
            tplTag = realTag||tplTag;
            if(isA){
                if(typeof temp != 'function')temp = self;
                for(var i=0;t=properties[i++];){
                    if(false===temp(profile, template, t, tplTag, result, i)){
                        break;
                    }
                }
            }else{
                if(t=properties.object){
                    //[properties] is for xui.Template
                    result[result.length]=t.toHtml();
                }else{
                    if(typeof temp == 'function'){
                        t=temp(profile, template, properties, tplTag, result);
                        if(t)tplTag=t;
                    }else{
                        tplTag = tplTag?tplTag+'.':'';
                        var a0=temp[0], a1=temp[1];
                        for(var i=0,l=a0.length;i<l;i++){
                            if(n=a1[i]){
                                if(n in properties){
                                    t=properties[n];
                                    if(n.substr(0,4)=="_fi_"){
                                        // for ie67 fonticon text
                                        if(xui.__iefix2 && (a0[i-1]=="_the_next_is_fonticon_" || n=="_fi_")){
                                            t = xui.str.trim(t).split(/\s+/).pop();
                                            t =  (t in xui.__iefix2) ? xui.__iefix2[t] : str;
                                        }else if(n=="_fi_"){
                                            t = str;
                                        }
                                    }
                                    //if sub template exists
                                    if(template[s=tplTag+n] && t)
                                        self(profile, template, t, s, result);
                                    else
                                        result[result.length]= (t===undefined || t===null || t===NaN)?str:typeof t=='string'?t.replace(x01,x01r):t;
                                }
                            }else
                                result[result.length]=(a0[i]===undefined || a0[i]===null || a0[i]===NaN)?str:a0[i];
                        }
                    }
                }
            }
            if(r)return result.join('');
        },
        /*
        set properties default map and set properties handler
        It's a merge function, not replace

        this.$DataStruct: {a:,b:,c}
        this.$DataModel: from hash, for example:
        hash:{
            key1:{
                ini:xx,
                set:fun..,
                get:fun..,
                action: fun
            },
            key2:null,
            key3:'abc
        }
        */
        $buildTemplate:function(profile, template, key, obj, arr){
            if(template && (template.tagName+"").toLowerCase()=='text'){
                arr[arr.length] = template.text;
                return;
            }
            var self =arguments.callee,
                behavior = profile.behavior?key?profile.behavior[key]:profile.behavior:null,
                prop=profile.properties,
                map1 = self.map1 ||(self.map1={tagName:1,text:1}),
                map2 = self.map2 ||(self.map2={image:1,input:1,br:1,meta:1,hr:1,abbr:1,embed:1}),
                map3 = self.map3 ||(self.map3={input:1,textarea:1,pre:1,code:1}),
                r2=self.r2||(self.r2=/[a-z]/),
                r3=self.r3 || (self.r3=/^(on|before|after)/),
                r7=self.r7 || (self.r7=/([^{}]*)\{([\w]+)\}([^{}]*)/g),
                first=false,
                u=xui.UI,
                ts=u.$tag_special,
                t, o , bak, tagN, cls1, lkey;

            if(!template)template=profile.template;
            lkey = key?profile.keys[key]:profile.key;

            //tagName
            if(!template.tagName)template.tagName="span";

            if(template.id!==null){
                //id
                template.id = key?lkey + ":" + u.$ID + ":" + u.$tag_left + (template.$customId?u.$tag_subId_c:u.$tag_subId) + u.$tag_right:u.$DOMID;
            }else
                delete template.id;

            if(template.className!==null){
                //save bak
                bak = template.className || '';
                if(!template._NativeElement){
                    //className
                    t = u.$CLS + (key?'-'+key.toLowerCase():'');
                    tagN = template.tagName.charAt(0)!="{"?template.tagName.toLowerCase():template.tagName;
                    cls1 = (tagN=="button"||tagN=="input"||tagN=="textarea"||tagN=="select"||tagN=="keygen")?'xui-ui-reset':'';

                    //default class first
                    template['class'] =  'xui-node'+(cls1?(' '+cls1):'')+' xui-node-'+tagN + (t?(' '+t):'') +
                        //custom class here
                        (bak?(' '+bak):'') +
                        (template.$fonticon?(' '+template.$fonticon):'') +
                        //add a special
                        (lkey==profile.key ? (' xui-ui-ctrl '+((xui.browser.ie && xui.browser.ver<10)?'':'{_selectable} ')) : '' );
                }else{
                    //default class first
                    template['class'] =  bak + ' ' +
                        //add a special
                        (lkey==profile.key ? ((xui.browser.ie && xui.browser.ver<10)?'':'{_selectable} ') : '' ) ;
                }
                template['class'] +=  ' ' +
                    //custom style
                    ts + (key||'KEY') + '_CT'+ts + ' ' +
                    //custom class
                    ts + (key||'KEY') + '_CC'+ts + ' '+
                    u.$MODULECLS + ' ' + u.$TAGCLASS + (prop._tagClass?' '+prop._tagClass:'') + " xui-custom"
            }
            delete template.className;

            template.style = (template.style?(template.style + ';'):'')
                + ts + (key||'KEY') + '_CS'+ts;

            var a=[], b={},
                tagName=template.tagName.charAt(0)!="{"?template.tagName.toLowerCase():template.tagName,
                text= template.text,
                sc=xui.absObj.$specialChars;

            for(var i in template){
                if(!template[i])continue;
                if(!sc[i.charAt(0)] && !map1[i]){
                    o=template[i];
                    if(!r2.test(i)){
                        // collect sub node
                        if(typeof o == 'object'){
                            if(!o.$order)o.$order=0;
                            o.$key=i;
                            a[a.length]=o;
                        }
                    }else
                        b[i]=o;
                }
            }
            // sort sub node
            xui.arr.stableSort(a,function(x,y){
                x=x.$order||0;y=y.$order||0;
                return x>y?1:x==y?0:-1;
            });

            //first
            if(!arr){
                first=true;
                arr=[];
            }
            //<span id="" style="">
            arr[arr.length]='<'+tagName+' ';

            for(var i in b)
                if(b[i])
                    arr[arr.length]=i+'="'+b[i]+'" ';

            //set className bak
            if(template.className!==null)
                template.className = bak;

            delete template['class'];

            arr[arr.length]= ts + (key||'KEY') + '_CA'+ts;
            arr[arr.length]='>';

            if(!map2[tagName] && text)
                arr[arr.length]=text;
            // for ie67
            if(template.$fonticon && xui.__iefix2){
                template.$fonticon=xui.str.trim(template.$fonticon);
                if(xui.__iefix2[template.$fonticon] )arr[arr.length]=xui.__iefix2[template.$fonticon];
                else if(/^\s*\{\s*_fi_[\w\s]+\}\s*$/.test(template.$fonticon))arr[arr.length]="{_the_next_is_fonticon_}"+template.$fonticon;
            }
            delete template.$fonticon;

            // add sub node
            for(var i=0,l=a.length;i<l;){
                o=a[i++];
                self(profile, o, o.$key, obj, arr)
            }
            if(!map2[tagName])
                arr[arr.length]='</'+tagName+'>';

            if(first){
                var a0=obj[0],a1=obj[1],str=arr.join(''),has=false;
                str.replace(r7,function(a,b,c,d){
                    if(b)a0[a0.length]=b;
                    a1[a0.length]=a0[a0.length]=c;
                    if(d)a0[a0.length]=d;
                    has=true;
                    return '';
                });
                if(!has){a0[0]=str;}
            }
        },
        _rpt:function(profile,temp){
            var me=arguments.callee,
                host = profile.host,
                moduleCls = (host&&host['xui.Module']&&host.customStyle&&!xui.isEmpty(host.customStyle))?(" xui-module-"+host.$xid):null,
                ui=xui.UI,
                tag=ui.$tag_special,
                ca=function(h,s,i){
                    s="";
                    for(i in h)s+= (i+'="'+h[i]+'" ');
                    return s;
                },
                r=me._r||(me._r=new RegExp( tag+'([0-9A-Z_]+)_C([CTA])'+tag + '|'+ tag+'([\\w_\\-\\.]*)'+tag, 'img')),
                h1={
                    id:profile.serialId,
                    cls:profile.getClass('KEY'),
                    domid:profile.$domId,
                    modulecls:moduleCls,
                    tagcls:(profile.tagcls||'')
                },
                h2={
                    A:profile.CA,
                    C:profile.CC,
                    T:profile._CT
                };
            return temp.replace(r, function(a,b,c,d){
                return h1[d] || (h2[c]? (c=="A"?ca(h2[c][b]) : (h2[c][b]||"")):'');
            }).replace(ui.$x01r,'\x01');
        },
        _build:function(profile, data){
            var template, t, m,
                u=xui.UI,
                temp=[[],[]],
                self=this,
                key=self.KEY,
                cache=xui.$cache.template,
                hash = profile._hash =
                    'b:' + (profile.template._subid||'') + ';' +
                    '!' + (profile._exhash||'');

            //build custom theme hash here
            if(typeof profile.theme == "string"){
                var h=profile._CT={},
                    pre=profile.key.replace(/\./g,'-').toLowerCase().replace('xui-ui','xui')+"-";
                xui.each(profile.keys,function(o,i){
                    if(i.charAt(0)!='$')
                        h[i]=pre + profile.theme + "-" + i.toLowerCase();
                });
            }
            //get template
            if(!(template = xui.get(cache,[key, hash]))){

                //get main template
                u.$buildTemplate(profile,null,null,temp);
                //split sub template from main template

                //set main template
                xui.set(cache, [key, hash, ''], temp);
                //set sub template
                if(t=profile.template.$submap)
                    for(var i in t){
                        if(typeof (m=t[i])!='function'){
                            var temp=[[],[]];
                            for(var j in m)
                                if(typeof m[j] == 'object')
                                    u.$buildTemplate(profile, m[j], j, temp);
                            m=temp;
                        }
                        xui.set(cache, [key,hash,i], m);
                    }

                template = xui.get(cache,[key, hash]);
            }
            if(!template)return '';

            //replace main template
            return self._rpt(profile, u.$doTemplate(profile, template, data));
        },
        /*
        allow function input, for some css bug
        */
        _setDefaultBehavior:function(hash){
            var self=this,
                me=arguments.callee,
                map=me._m||(me._m={'':1,KEY:1,$key:1}),
                f=me._f1||(me._f1=function(arr, type, mode){
                    var fun = function(profile, e, src){
                        var t,
                            id=xui.use(src).id(),
                            item,
                            cid = profile.getSubId(id),
                            prop = profile.properties,nodes,funs,box;
                        if(prop.disabled || prop.readonly)return;
                        item = profile.SubSerialIdMapItem && profile.SubSerialIdMapItem[cid];
                        if(item && item.disabled)return;
                        if(item && item.readonly)return;
                        switch(typeof arr){
                            case 'string':
                                nodes=profile.getSubNode(arr,cid)._get();
                                break;
                            case 'function':
                                funs=[arr];
                                break;
                            case 'object':
                                nodes=[];funs=[];
                                for(var o,i=0,l=arr.length;i<l;i++){
                                    o=arr[i];
                                    if(typeof o=='string')
                                        nodes.push.apply(nodes,profile.getSubNode(o,cid)._get());
                                    else
                                        funs.push(o);
                                }
                        }

                        if(nodes&&nodes.length){
                            nodes=xui(nodes);
                            box=profile.boxing();
                            if(mode==1){
                                if(!xui.browser.fakeTouch && xui.browser.deviceType != 'touchOnly'&& type=='mouseover'){
                                    if(profile.$beforeHover && false == profile.$beforeHover(profile, item, e, src, 'mouseover'))
                                        return;
                                    if(prop.disableHoverEffect===true)return;
                                    if(prop.disableHoverEffect && (new RegExp("\\b"+profile.getKey(src,true)+"\\b")).test(prop.disableHoverEffect||""))return;
                                    if(profile.beforeHoverEffect && false === box.beforeHoverEffect(profile, item, e, src, 'mouseover'))
                                        return;
                                }
                                if(type=='mousedown'){
                                    if(profile.$beforeClick&& false==profile.$beforeClick(profile, item, e, src, 'mousedown'))
                                        return;
                                    if(prop.disableClickEffect)
                                        return;
                                    if(profile.beforeClickEffect && false === box.beforeClickEffect(profile, item, e, src, 'mousedown'))
                                        return;
                                }

                                //default action
                                nodes.tagClass('-'+((!xui.browser.fakeTouch && xui.browser.deviceType != 'touchOnly') && type=='mouseover'?'hover':type=='mousedown'?'active':type));
                            }else{
                                if(type=='mouseup'){
                                    if(profile.$beforeClick&& false==profile.$beforeClick(profile, item, e, src, 'mouseup'))
                                        return;
                                    if(prop.disableClickEffect)
                                        return;
                                    if(profile.beforeClickEffect && false === box.beforeClickEffect(profile, item, e, src, 'mouseup'))
                                        return;
                                    nodes.tagClass('-active', false);
                                }else{
                                    if(profile.$beforeHover && false == profile.$beforeHover(profile, item, e, src, 'mouseout'))
                                        return;
                                    if(prop.disableHoverEffect===true)return;
                                    if(prop.disableHoverEffect && (new RegExp("\\b"+profile.getKey(src,true)+"\\b")).test(prop.disableHoverEffect||""))return;

                                    if(profile.beforeHoverEffect && false === box.beforeHoverEffect(profile, item, e, src, 'mouseout'))
                                        return;
                                    nodes.tagClass('(-hover|-active)', false);
                                }
                            }
                        }
                        if(funs&&funs.length){
                            xui.arr.each(funs,function(o){
                                xui.tryF(o,[profile],profile)
                            });
                            funs.length=0;
                        }
                   };
                    return fun;
                }),
                hls={},t;
            if(!xui.SC.get('xui.absContainer'))
                xui.Class('xui.absContainer','xui.absObj',{
                    Instance:{
                        addPanel:function(paras, children, item){
                            var pro = xui.clone(xui.UI.Panel.$DataStruct,true);
                            xui.merge(pro, paras, 'with');
                            xui.merge(pro,{
                                dock:'fill',
                                tag:paras.tag||paras.id
                            },'all');

                            var pb = new xui.UI.Panel(pro),arr=[];
                            this.append(pb, item&&item.id);
                            xui.arr.each(children,function(o){
                                arr.push(o[0]);
                            });
                            pb.append(xui.UI.pack(arr,false));
                            return this;
                        },
                        removePanel:function(){
                            this.destroy(true);
                        },
                        getPanelPara:function(){
                            return xui.clone(this.get(0).properties,true);
                        },
                        dumpContainer:function(subId,purgeNow){
                            return this.each(function(profile){
                               var dm = profile.box.$DataModel,
                                    s = dm.valueSeparator||";",
                                    p = profile.properties,
                                    hasitems='items' in p,
                                    b,id,arr,con;
                                if(!hasitems){
                                    if(con=profile.boxing().getContainer())con.html("",true,false,purgeNow);
                                }else{
                                    xui.arr.each(p.items, function(item){
                                        id = item.id;
                                        if(!subId || subId===true){
                                            b=1;
                                        }else{
                                            arr = xui.isArr(subId)?subId:(subId+"").split(s);
                                            b=xui.arr.indexOf(arr, id)!=-1;
                                        }
                                        if(b){
                                            if(con=profile.boxing().getContainer(id))con.html("",true,false,purgeNow);
                                        }
                                    });
                                }
                            });
                        },
                        getPanelChildren:function(){
                            return this.get(0).children;
                        },
                        getFormValues:function(dirtiedOnly, subId, penetrate, withCaption, withCaptionField){
                            var hash={};
                            this.getFormElements(false,subId,penetrate).each(function(prf){
                                var p=prf.properties, key = p.name || prf.alias, keys,
                                    ins = prf.boxing(),
                                    // maybe return array
                                    uv = ins.getUIValue();
                                // v and uv can be object(Date,Number)
                                if(!dirtiedOnly || (uv+" ")!==(ins.getValue()+" ")){
                                    if(ins.getCaption && (withCaption || withCaptionField)){
                                        if(withCaptionField && key.indexOf(":")!=-1){
                                            keys=key.split(':');
                                        }
                                        if(keys && keys[0] && keys[1]){
                                            hash[keys[0]]=uv;
                                            hash[keys[1]]=ins.getCaption();
                                        }else if(withCaption){
                                            hash[key]={
                                                value : uv,
                                                caption : ins.getCaption()
                                            };
                                        }else{
                                            hash[key]=uv;
                                        }
                                    }else{
                                        hash[key.split(':')[0]]=uv;
                                    }
                                }
                            });
                            return hash;
                        },
                        setFormValues:function(values, subId, penetrate){
                            if(!xui.isEmpty(values)){
                                this.getFormElements(false,subId,penetrate).each(function(prf){
                                    var prop=prf.properties, ins=prf.boxing(),key=prop.name || prf.alias,keys,cap;
                                    if(typeof(ins.setCaption)=="function" && key.indexOf(":")!=-1){
                                        keys=key.split(':');
                                        if(keys && keys[0] && keys[1]){
                                            key=keys[0];
                                            cap=keys[1];
                                        }
                                    }
                                    var v=values[key],b=xui.isHash(v) ;
                                    if('value' in prop && key in values){
                                        ins.setValue((b && ('value' in v)) ? v.value : v, true,'form');
                                    }
                                    if(typeof(ins.setCaption)=="function"){
                                        if(cap in values)
                                            ins.setCaption(values[cap], null, true,'form');
                                        else if(b && ('caption' in v))
                                            ins.setCaption(v.caption, null, true,'form');
                                    }
                                });
                            }
                            return this;
                        },
                        getFormElements:function(dirtiedOnly, subId, penetrate){
                            var a=this.getChildren(subId, penetrate!==false),
                                elems = xui.absValue.pack(a);
                            xui.filter(elems._nodes, function(prf){
                                return prf._isFormField ? prf._isFormField(prf) : !!xui.get(prf,['properties','isFormField']);
                            });
                            if(dirtiedOnly){
                                var arr=[],ins,t;
                                elems.each(function(p,z){
                                    ins = p.boxing();
                                    if( (ins.getUIValue()+" ")!==(ins.getValue()+" ")){
                                        arr.push(p);
                                    }
                                });
                                return xui.absValue.pack(arr);
                            }
                            return elems;
                        },
                        isDirtied:function(subId,penetrate){
                           var elems = this.getFormElements(false,subId,penetrate).get();
                           for(var i=0,l=elems.length;i<l;i++){
                                var profile=elems[i],ins;
                                if(profile.box["xui.absValue"]){
                                    ins = profile.boxing();
                                    if((ins.getUIValue()+" ")!==(ins.getValue()+" ")){
                                        return true;
                                    }
                                }
                            }
                            return false;
                        },
                        checkValid:function(ignoreAlert, subId, penetrate){
                            var ns=this, profile=ns.get(0), result=true;
                            // check required first
                            if(!ns.checkRequired(ignoreAlert, subId, penetrate)){
                                return false;
                            }
                            ns.getFormElements(false,subId, penetrate).each(function(prf){
                                var prop=prf.properties, ins=prf.boxing();
                                if(!ins.checkValid(ignoreAlert, subId, penetrate)){
                                    if(!ignoreAlert){
                                        if(!profile.beforeInputAlert || false!==profile.boxing().beforeInputAlert(profile, prf, 'invalid')){
                                            xui.alert('$inline.invalid',xui.getRes('$inline.invalid2') + (prop.labelCaption?(" : " +prop.labelCaption):"")  , function(){
                                                if(prf&&prf.renderId)
                                                       ins.activate();
                                            });
                                        }
                                        return result=false;
                                    }
                                     result=false;
                                }
                            });
                            return result;
                        },
                        checkRequired:function(ignoreAlert, subId, penetrate){
                            var profile=this.get(0), result=true;
                            this.getFormElements(false,subId, penetrate).each(function(prf, i){
                                var prop=prf.properties, ins=prf.boxing();
                                if(prop.required && (!(i=ins.getUIValue())) && i!==0){
                                    if(!ignoreAlert){
                                        if(!profile.beforeInputAlert || false!==profile.boxing().beforeInputAlert(profile, prf, 'required')){
                                            xui.alert('$inline.required',xui.getRes('$inline.required2') + (prop.labelCaption?(" : " +prop.labelCaption):"")  , function(){
                                                if(prf&&prf.renderId)
                                                       ins.activate();
                                            });
                                        }
                                        return result=false;
                                    }
                                    result=false;
                                }
                            });
                            return result;
                        },
                        formClear:function(subId, penetrate){
                            return this.each(function(prf){
                                prf.boxing().getFormElements(false,subId, penetrate).resetValue(null);
                            });
                        },
                        formReset:function(subId, penetrate){
                            return this.each(function(prf){
                                var p = prf.properties,
                                     elems = prf.boxing().getFormElements(false,subId, penetrate);
                                if(prf.beforeFormReset && false===prf.boxing().beforeFormReset(prf, elems, subId, penetrate)){
                                        return;
                                }
                                elems.each(function(p,i){
                                    if((i=p.properties.value) !== p.properties.$UIvalue)
                                        p.boxing().resetValue(i);
                                });
                                if(prf.afterFormReset){
                                        prf.boxing().afterFormReset(prf, elems, subId, penetrate);
                                }
                            });
                        },
                        updateFormValues:function(subId, penetrate){
                            this.getFormElements(false,subId, penetrate).updateValue();
                        },
                        formSubmit:function(ignoreAlert, subId, penetrate, withCaption, withCaptionField){
                            var ns=this;
                            // check valid first
                            if(!ignoreAlert && !ns.checkValid(false, subId, penetrate)){
                                return;
                            }
                            var prf=ns.get(0),
                              p = prf.properties, f,
                              data = ns.getFormValues(false, subId, penetrate, withCaption, withCaptionField),
                              apicaller;
                            // call before event
                            if(prf.beforeFormSubmit && false===prf.boxing().beforeFormSubmit(prf, data, subId, penetrate, withCaption, withCaptionField)){
                                    return;
                            }

                            if(p.formTarget=="Alert"){
                                data = xui.stringify(data);
                                if(xui.Coder && xui.Coder.formatText)
                                    data = xui.Coder.formatText(data);
                                alert(data);
                            }else if(/^\s*\{[^}]+\}\s*$/.test(p.formTarget)){
                                f=xui.adjustVar(p.formTarget);
                                f(data);
                            }else if(/^((\s*function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)(\{([^\{\}]*)\}))\s*$/.test(p.formTarget)){
                                if(f=xui.unserialize(p.formTarget)){
                                    f(data);
                                }
                            }
                            else{
                                // try to get APICaller
                                if(xui.APICaller && xui.arr.indexOf(['_blank','_self','_parent','_top'],p.formTarget)==-1) {
                                    apicaller = xui.APICaller.getFromName(p.formTarget);
                                }
                                if(apicaller){
                                    apicaller.setQueryData(data,p.formDataPath);
                                    apicaller.invoke();
                                }else{
                                    xui.Dom.submit(p.formAction, data, p.formMethod, p.formTarget, p.formEnctype);
                                }
                            }
                            // update UI
                            ns.getFormElements(dirtiedOnly, subId, penetrate).updateValue();

                            if(prf.afterFormSubmit)prf.boxing().afterFormSubmit(prf, data, subId, penetrate, withCaption, withCaptionField);
                        },
                        // use refrence to keep the Class's function mark
                        _e1:function(profile, item, e, src, type){},
                        _e2:function(profile, keyboard, e, src){},
                        _e3:function(profile, e, shiftKey, src){},
                        _e4:function(profile, e, src, dragKey, dragData, item){},
                        _e5:function(profile, e, src){},
                        _e6:function(profile, ctrlPrf, type){},
                        _e7:function(profile, elems, subId){},
                        _e8:function(profile, data, subId){}
                    },
                    Static:{
                        $abstract:true,
                        DataModel:{
                            dragKey:'',
                            dropKeys:'',
                            overflow:{
                                ini:xui.browser.deviceType=="touchOnly"?'auto':undefined,
                                combobox:['','visible','hidden','scroll','auto','overflow-x:hidden;overflow-y:auto','overflow-x:auto;overflow-y:hidden'],
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        var node=prf.getSubNode(k,true);
                                        if(v){
                                            if(v.indexOf(':')!=-1){
                                                xui.arr.each(v.split(/\s*;\s*/g),function(s){
                                                    var a=s.split(/\s*:\s*/g);
                                                    if(a.length>1)node.css(xui.str.trim(a[0]),xui.str.trim(a[1]||''));
                                                });
                                                return;
                                            }
                                        }
                                        node.css('overflow',v||'');
                                    });
                                }
                            },
                            panelBgClr:{
                                type:'color',
                                ini:"",
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        prf.getSubNode(k,true).css('background-color',v);
                                    });
                                }
                            },
                            panelBgImg:{
                                format:'image',
                                ini:"",
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        prf.getSubNode(k,true).css('background-image',v?('url('+xui.adjustRes(v||'')+')'):'');
                                    });
                                }
                            },
                            panelBgImgPos:{
                                ini:"",
                                combobox:["","top left","top center","top right","center left","center center","center right","bottom left","bottom center","bottom right","0% 0%","-0px -0px"],
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        prf.getSubNode(k,true).css('background-position',v);
                                    });
                                }
                            },
                            panelBgImgRepeat:{
                                ini:"",
                                combobox:["","repeat","repeat-x","repeat-y","no-repeat"],
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        prf.getSubNode(k,true).css('background-repeat',v);
                                    });
                                }
                            },
                            panelBgImgAttachment:{
                                ini:"",
                                combobox:["","scroll","fixed"],
                                action:function(v){
                                    var prf=this;
                                    xui.arr.each(prf.box.$Behaviors.PanelKeys,function(k){
                                        prf.getSubNode(k,true).css('background-attachment',v);
                                    });
                                }
                            },
                            conLayoutColumns:{
                                ini:0,
                                action:function(){
                                    this.adjustSize();
                                }
                            },
                            conDockRelative:{
                                hidden:true,
                                ini:false,
                                get:function(){
                                    return this.boxing().getConLayoutColumns();
                                },
                                set:function(value){
                                    return this.boxing().setConLayoutColumns(value?1:0);
                                }
                            },
                            conDockPadding:{
                                ini:{left:0,top:0,right:0,bottom:0},
                                action:function(){
                                    this.boxing().adjustDock(true);
                                }
                            },
                            conDockSpacing:{
                                ini:{width:0,height:0},
                                action:function(){
                                    this.boxing().adjustDock(true);
                                }
                            },
                            conDockFlexFill:{
                                ini:"",
                                combobox:['none','width','height','both'],
                                action:function(){
                                    this.boxing().adjustDock(true);
                                }
                            },
                            conDockStretch:{
                                ini:"",
                                combobox:['fixed','forward','rearward','stretch','0.25','0.33','0.5','0.25,0.5,0.25'],
                                action:function(){
                                    this.boxing().adjustDock(true);
                                }
                            },
                            sandboxTheme:{
                                ini:"",
                                action:function(v,ov,force,tag1, tag2){
                                    xui.UI._refreshSBTheme(this, v, tag1, tag2);
                                }
                            },
                            formMethod:{
                                ini:'get',
                                listbox:['get','post']
                            },
                            formTarget:{
                                ini:'Alert',
                                combobox:['Alert','_blank','_self','_parent','_top','[framename]','[APICaller]','function(d){xui.log(d)}']
                            },
                           formDataPath:"",
                           formAction:"",
                           formEnctype:{
                                ini:'application/x-www-form-urlencoded',
                                listbox:['application/x-www-form-urlencoded','multipart/form-data','text/plain']
                            }
                        }
                    }
                });
            var src=xui.absContainer.prototype;

            if(hash.HoverEffected){
                xui.each(hash.HoverEffected,function(o,i){
                    t=map[i]?hash:(hash[i]||(hash[i]={}));
                    if(!o)
                        t.afterMouseover = t.afterMouseout = null;
                    else{
                        t.afterMouseover = f(o,'mouseover', 1);
                        t.afterMouseout = f(o,'mouseout', 2);
                    }
                });
                hls.beforeHoverEffect=src._e1;
            }
            if(hash.ClickEffected){
                xui.each(hash.ClickEffected,function(o,i){
                    t=map[i]?hash:(hash[i]||(hash[i]={}));
                    if(!o)
                        t.afterMousedown = t.afterMouseup = null;
                    else{
                        t.afterMousedown = f(o,'mousedown', 1);
                        t.afterMouseup = f(o,'mouseup', 2);
                    }
                });
                hls.beforeClickEffect=src._e1;
            }

            if(hash.HotKeyAllowed){
                //for onHotKey
                xui.merge(hash,{
                    beforeKeydown:function(profile, e, src){
                        if(profile.onHotKeydown)
                            return false !== profile.boxing().onHotKeydown(profile,xui.Event.getKey(e),e, src);
                    },
                    beforeKeypress:function(profile, e, src){
                        if(profile.onHotKeypress)
                            return false !== profile.boxing().onHotKeypress(profile,xui.Event.getKey(e),e, src);
                    },
                    beforeKeyup: function(profile, e, src){
                        if(profile.onHotKeyup)
                            return false !== profile.boxing().onHotKeyup(profile,xui.Event.getKey(e),e, src);
                    }
                });

                hls.onHotKeydown=hls.onHotKeypress=hls.onHotKeyup=src._e2;
            }

            //for focus action
            if(hash.NavKeys){
                xui.each(hash.NavKeys,function(o,i){
                    var map=arguments.callee, k, m1=map.m1||(map.m1={KEY:1,$key:1});
                    if(m1[i])return;
                    var m2=map.m2||(map.m2={input:1,textarea:1}),
                    m3=map.m3||(map.m3={tab:1,enter:1,up:1,down:1,left:1,right:1}),
                    m4=map.m4||(map.m4={tab:1,up:1,down:1,left:1,right:1}),
                    t=hash[i]||(hash[i]={});

                    var t=hash[i]||(hash[i]={});

                    if(null===o)
                        t.afterKeydown = null;
                    else{
                        t.afterKeydown = function(profile, e, src){
                            var k=xui.Event.getKey(e), key = k.key, ctrl=k.ctrlKey, shift=k.shiftKey, alt=k.altKey, b=false, smartnav=profile._smartnav;
                            if(smartnav){
                                var node=xui.use(src).get(0);
                                if(m2[k=node.tagName.toLowerCase()]){
                                    if(key && k=="input" && node.type.toLowerCase()!='text'&& node.type.toLowerCase()!='password'){
                                        b=true;
                                    }else if(m3[key]){
                                        var reg = xui.use(src).caret(),txt=xui.use(src).get(0).value;

                                        switch(key){
                                            case 'up':
                                                if(!/[\n\r]/.test(txt.substr(0,reg[0]))) b=true;
                                                break;
                                            case 'left':
                                                if(!shift && (ctrl || (reg[0]===0 && (reg[1]!==txt.length || reg[1]===0)))) b=true;
                                                break;
                                            case 'down':
                                                if(!/[\n\r]/.test(txt.substr(reg[1],txt.length))) b=true;
                                                break;
                                            case 'right':
                                                if(!shift && (ctrl || (reg[1]===txt.length && (reg[0]!==0 || reg[1]===0)))) b=true;
                                                break;
                                            case 'enter':
                                                if(k=='input' || alt)b=true;
                                                break;
                                            case "tab":
                                                b=true;
                                                break;
                                        }
                                    }
                                }else{
                                    if(m4[key])
                                        b=true;
                                }
                               node=null;
                            }else
                                b=key==='tab';

                            //hanlder focus
                            if(b){
                                //export event
                                if(profile.beforeNextFocus && false === profile.boxing().beforeNextFocus(profile,e,k.shiftKey,src)){
                                    // fake a tab key, to envoke onHotKeydown/onHotKeyup
                                    switch(k.key){
                                        case 'tab':
                                        case 'enter':
                                            if(profile.onHotKeydown)profile.boxing().onHotKeydown(profile,xui.Event.getKey(e),e, src);
                                        case 'esc':
                                            if(profile.onHotKeyup)profile.boxing().onHotKeyup(profile,xui.Event.getKey(e),e, src);
                                            break;
                                    }
                                    return false;
                                }

                                if(smartnav){
                                    if(key!='tab')
                                        xui.use(src).nextFocus(('up'==key || 'left'==key)?false:true);
                                }
                            }
                        }
                    }
                });
                hls.beforeNextFocus=src._e3;
            }
            if((t=hash.DroppableKeys) && t.length){
                xui.arr.each(t,function(o){
                    self._droppable(o)
                });

                t=self.prototype;
                xui.arr.each('getDropKeys,setDropKeys'.split(','),function(o){
                    if(!t[o])t[o]=src[o];
                });
                if(hash.PanelKeys){
                    xui.arr.each('addPanel,removePanel,dumpContainer,getPanelPara,getPanelChildren,getFormValues,setFormValues,getFormElements,isDirtied,checkValid,checkRequired,formClear,formReset,updateFormValues,formSubmit'.split(','),function(o){
                        if(!t[o])t[o]=src[o];
                    });
                }
                self.$DataModel.dropKeys=self.$DataStruct.dropKeys='';
                hls.onDragEnter=hls.onDragLeave=hls.beforeDrop=hls.onDrop=hls.afterDrop=hls.onDropTest=hls.onDropMarkShow=hls.onDropMarkClear=src._e4;
            }
            if((t=hash.DraggableKeys)&& t.length){
                xui.arr.each(t,function(o){
                    self._draggable(o)
                });
                t=self.prototype;
                xui.arr.each('getDragKey,setDragKey'.split(','),function(o){
                    if(!t[o])t[o]=src[o];
                });
                self.$DataModel.dragKey=self.$DataStruct.dragKey='';
                hls.onGetDragData=hls.onStartDrag=hls.onDragStop=src._e5;
            }
            if((t=hash.NoDraggableKeys)&& t.length){
                self.NoDraggableKeys=t;
            }
            if((t=hash.NoDroppableKeys) && t.length){
                self.NoDroppableKeys=t;
            }
            if((t=hash.PanelKeys) && t.length){
                t=self.prototype;
                xui.arr.each('overflow,panelBgClr,panelBgImg,panelBgImgPos,panelBgImgRepeat,panelBgImgAttachment,conDockRelative,conLayoutColumns,conDockPadding,conDockSpacing,conDockFlexFill,conDockStretch,sandboxTheme,formMethod,formTarget,formDataPath,formAction,formEnctype'.split(','),function(o){
                    var f='get'+xui.str.initial(o),dm;
                    if(!t[f])t[f]=src[f];
                    f='set'+xui.str.initial(o);
                    if(!t[f])t[f]=src[f];
                    dm=xui.absContainer.$DataModel[o];
                    self.$DataStruct[o]=xui.isSet(dm.ini)?xui.copy(dm.ini):"";
                    self.$DataModel[o]=xui.copy(dm);
                });

                 xui.merge(hls, xui.absContainer.$EventHandlers);
                // form

                hls.beforeInputAlert=src._e6;
                hls.beforeFormReset=hls.afterFormReset=src._e7;
                hls.beforeFormSubmit=hls.afterFormSubmit=src._e8;

                 self['xui.absContainer']=true;
            }
            self.setEventHandlers(hls);
        },

        addTemplateKeys:function(arr){
            var self=this, key=self.KEY, me=arguments.callee, reg=me._reg||(me._reg=/\./g);
            xui.arr.each(arr,function(i){
                self.$cssKeys[i]=(self.$Keys[i]=i=='KEY'?key:key+"-"+i).replace(reg,'-').toLowerCase().replace('xui-ui','xui');
            });
            return self;
        },
        _refreshSBTheme:function(profile, cssSetting, tag, callback){
            var domId=profile.getDomId(),
                id=domId+"sandboxtheme",
                // escape special char
                prevId=this._getThemePrevId(profile),
                old=xui(id).get(0),
                applyCss=function(css){
                    xui.CSS._appendSS(profile.getRootNode(), xui.UI._adjustCSS(css,prevId,tag), id, true);

                    if(profile.$inDesign){
                        profile.boxing().reLayout(true)
                            .getChildren(true, "penetrate").reLayout(true);
                    }
                };
            if(old){
                old.disabled=true;
                xui(id).remove(false);
            }
            if(cssSetting){
                if(/^[a-zA-Z-]+$/.test(cssSetting+'') && (cssSetting+'')!=='default'){
                    var path=xui.getPath('xui.appearance.' + cssSetting,'');
                    xui.getFileAsync(path+'theme.css', function(rsp){
                        applyCss(rsp.replace(/\.setting-uikey\{[^}]+\}/,'').replace(/url\(([^)]+)\)/g, "url("+path+"$1)"));
                        xui.tryF(callback,[profile, cssSetting]);
                    });
                }else{
                    applyCss(cssSetting+'');
                }
            }
        },
        _getThemePrevId:function(profile/*UIProfile or dom id*/){
            return profile?'#' + (profile['xui.UIProfile'] ? profile.getDomId() : profile).replace(/([.:])/g,"\\$1"):"";
        },
        _adjustCSS:function(css, prevId, tag){
            prevId=prevId||"";
            if(tag){
                css = xui.replace(css, [
                    [/(\/\*[^*]*\*+([^\/][^*]*\*+)*\/)/,'$0'],
                    [/\{[^}]*\}/,'$0'],
                    [/([^\/{},]+)/, function(a){
                        return a[0].replace(/([^\s>]+)/,"$1"+tag)
                    }]
                ]);
            }
            return css
                .replace(/(\/\*[^*]*\*+([^\/][^*]*\*+)*\/)/g,'')
                .replace(/^\s*(\.)/,function(a,b){
                    return prevId + " " + b;
                }).replace(/([},])\s*(\.)/g,function(a,b,c){
                    return b + "\n" + prevId + " " + c;
                }).replace(/([{;])\s*(.)/g,function(a,b,c){
                    return b + '\n' + (c=='}'?'':'    ') + c;
                }).replace(/url\(([^)]+)\)/g, function(a,b){
                    return "url("+xui.adjustRes(b,0,1)+")";
                });
        },
        setAppearance:function(hash){
            xui.merge(this.$Appearances,hash,'all');
            return this;
        },
        getAppearance:function(){
            return this.$Appearances;
        },
        /*replace mode*/
        setTemplate:function(hash, cacheId){
            if(hash){
                var self=this,
                    tagNames=self.$tagName||(self.$tagName={}),
                    me=arguments.callee,
                    r2=me.r2||(me.r2=/[a-z]/),
                    sc=xui.absObj.$specialChars,
                    _ks=['KEY'],
                    fun = me._fun || (me._fun=function(hash, arr, tagNames){
                        var o,i;
                        for(i in hash){
                            if(!sc[i.charAt(0)])
                                if(!r2.test(i)){
                                    arr[arr.length]=i;
                                    o=hash[i];
                                    if(o && typeof o == 'object'){
                                        tagNames[i]=o.tagName||'';
                                        arguments.callee(o, arr, tagNames);
                                    }
                                }
                        };
                    })
                    ,t;
                tagNames.KEY=hash.tagName||'';
                fun(hash,_ks, tagNames);
                self.addTemplateKeys(_ks);

                t = self.$Templates;

                // for sub template,
                if(typeof cacheId=='string'){
                    hash._subid = cacheId;
                    t[cacheId]=hash;
                }else
                    t._=hash;

                //set sub
                if(t=hash.$submap)
                    for(var i in t)
                        for(var j in t[i])
                            me.call(self, t[i], j);
            }
            return this;
        },
        getTemplate:function(cacheId){
            return this.$Templates[cacheId||'_'];
        },
        /*replace mode*/
        setBehavior:function(hash){
            if(hash){
                var self=this,
                    ch=xui.$cache.UIKeyMapEvents,
                    skey=self.$key,
                    check=xui.absObj.$specialChars,
                    handler = xui.Event.$eventhandler,
                    eventType=xui.Event._eventMap,
                    me=arguments.callee,
                    r1=me.r1||(me.r1=/[a-z]/),
                    r2=me.r2||(me.r2=/^(on|before|after)/),
                    t= self.$Behaviors,
                    m,i,j,k,o,v, type;
                //set shortcut first
                self._setDefaultBehavior(hash);
                //merge KEY
                if(hash.KEY){
                    xui.merge(hash, hash.KEY, 'all');
                    delete hash.KEY;
                }

                //merge hash
                for(i in hash){
                    o=hash[i];
                    if(!check[i.charAt(0)]){
                        //only two layer
                        if(!r1.test(i)){
                            m=t[i]||(t[i]={});
                            for(j in o){
                                v=o[j];
                                if(!check[j.charAt(0)]){
                                    /*set to behavior*/
                                    if(v)
                                        m[j]=v;
                                    else
                                        delete m[j];
                                }
                            }
                        }else if(r2.test(i)){
                            /*set to behavior*/
                            if(o)
                                t[i]=o;
                            else
                                delete t[i];
                        //for those special keys
                        }else
                            t[i]=o;
                    }
                }

                //remove all handler cache
                xui.filter(ch,function(o,i){
                    return !(i==skey||i.indexOf(skey+'-')==0);
                });
                //add handler cache
                for(i in t){
                    o=t[i];
                    if(!check[i.charAt(0)]){
                        //only two layer
                        if(!r1.test(i)){
                            for(j in o){
                                if(!check[j.charAt(0)] && o[j]){
                                    k=skey+'-'+i;
                                    (ch[k]||(ch[k]={}))['on'+eventType[j]]=handler;
                                }
                            }
                        }else if(r2.test(i) && o){
                            k=skey;
                            (ch[k]||(ch[k]={}))['on'+eventType[i]]=handler;
                        }
                    }
                }
            }

            return self;
        },
        getBehavior:function(){
            return this.$Behaviors;
        },
        $applyCSS:function( ){
            var self=xui.UI, cache1=self.$cache_css, cache2=self.$cache_css2;
            if(!self.$cssNo){
                self.$cssNo=1;
                var b=xui.browser;
                xui('body').addClass(
                          (b.ie ? ("xui-css-ie xui-css-ie" + b.ver + " ") :
                           b.gek ? ("xui-css-gek xui-css-gek" + b.ver + " ") :
                           b.kde ? ("xui-css-kde xui-css-kde" + b.ver + " ") :
                           b.opr ? ("xui-css-opr xui-css-opr" + b.ver + " ") : "")
                        + (b.isSafari ? "xui-css-safari ": b.isChrome ? "xui-css-chrome " :"")
                        + (b.isMac ? "xui-css-mac": b.isLinux ? "xui-css-linux " :"")
                );
                xui('html').addClass("xui-css-base xui-css-viewport xui-uicontainer" + (b.isStrict?" xui-css-strict":""));
            }
            if(cache1){
                xui.CSS.includeLink(xui.ini.path+"iconfont/iconfont.css", 'xui-font-icon', true);

                xui.CSS.addStyleSheet(cache1, 'xui.UI-CSS'+(self.$cssNo++));
                xui.UI.$cache_css='';
            }
            if(cache2){
                xui.CSS.addStyleSheet(cache2, 'xui.UI-CSS'+(self.$cssNo++),true);
                xui.UI.$cache_css2='';
            }
        },
        buildCSSText:function(hash){
            var self=this,
                r1=/(^|\s|,)([0-9A-Z_]+)/g,
                h=[], r=[],
                browser=xui.browser,
                ie6=browser.ie6,
                ie=browser.ie,
                gek=browser.gek,
                ks=self.$cssKeys,
                t,v,o;

            for(var i in hash){
                if(o=hash[i]){
                    t=i.replace(r1,function(a,b,c){return  b + '.' + (ks[c]||c)}).toLowerCase();
                    o.$order=parseInt(o.$order,10)||0;
                    o.$=t;
                    h[h.length]=o;
                }
            };
            xui.arr.stableSort(h,function(x,y){
                x=x.$order||0;y=y.$order||0;
                return x>y?1:x==y?0:-1;
            });

            for(var i=0,l=h.length;i<l;){
                o=h[i++];
                r[r.length]=o.$+"{";
                if(t=o.$before)r[r.length]=t;
                if(t=o.$text)r[r.length]=t;
                for(var j in o){
                    if(j.charAt(0)=='$')continue;
                    //neglect '' or null
                    if((v=o[j])||o[j]===0){
                        j=j.replace(/_[0-9]+$/,'');
                        //put string dir
                        switch(typeof v){
                        case 'string':
                        case 'number':
                            r[r.length]=j+":"+v+";";break;
                        case 'function':
                            r[r.length]=j+":"+v(self.KEY)+";";break;
                        //arrray
                        default:
                            xui.arr.each(v,function(k){
                                //neglect '' or null
                                if(k)r[r.length]=j+":"+k+";";
                            });
                        }
                    }
                }
                if(v=o.$after)r[r.length]=v;
                r[r.length]="}";
            }
            return r.join('');
        },
        _prepareCmds:function(profile, item, filter){
            var ns=this,
                p=profile.properties,
                cmds = item.tagCmds || xui.clone(p.tagCmds,true);
            if(cmds && cmds.length){
                var sid=xui.UI.$tag_subId,a=[],b=[],c;
                for(var i=0,t=cmds,l=t.length;i<l;i++){
                    if(typeof t[i]=='string')c={id:t[i]};
                    else c = xui.clone(t[i]);

                    if(filter && xui.isFun(filter)){
                        if(!filter(c)){
                            continue;
                        }
                    }else{
                        if(item.tag && item.tag.match((new RegExp("\\b" + "no~" + c.id + "\\b"))) )
                            continue;
                    }

                    if('id' in c)c.id+='';else c.id='cmds'+profile.$xid+i;
                    if(c.object){
                        c.object = ns._prepareInlineObj(profile, c, p.tabindex);
                        c.type='profile';
                    }else{
                        if(!'caption' in c)c.caption=c.id;
                        if(!('tips' in c))c.tips=c.caption;

                        c.id=c.id.replace(/[^0-9a-zA-Z]/g,'');
                        if(!c.type)c.type="text";
                        
                        if(c.caption)c.caption=xui.adjustRes(c.caption);
                        if(c.tips)c.tips=xui.adjustRes(c.tips);
                        if(c.image)c.image=xui.adjustRes(c.image)||xui.ini.img_bg;
                        c._style="";
                        if('width' in c)c._style+=c.width + (xui.isFinite(c.width) &&"px") + ";";
                        if('height' in c)c._style+=c.height + (xui.isFinite(c.height) &&"px")+ ";";
                        c[sid]=(item[sid]?item[sid] :"") + '_' + c.id;
                    }
                    if(c["location"]=="left")
                        b.push(c);
                    else{
                        a.push(c);
                        if(c['locaton']=='right-float')
                            c._exstyle='float:right;';
                    }
                }
                item.ltagCmds=b
                item.rtagCmds=a;
            }
            item._ltagDisplay= item.ltagCmds?'':'display:none';
            item._rtagDisplay= item.rtagCmds?'':'display:none';
        },
        $getTagCmdsTpl:function(key){
            var tpl={
                'ltagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"tagCmds"+(map[v.type]||'.button'),result)
                },
                'rtagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"tagCmds"+(map[v.type]||'.button'),result)
                },
                'tagCmds.text':{
                    CMD:{
                        tagName:"span",
                        title:"{tips}",
                        style:'{_style}{itemStyle}',
                        className:'xui-node xui-tag-cmd {itemClass}',
                        tabindex: '{_tabindex}',
                        text:"{caption}"
                    }
                },
                'tagCmds.button':{
                    CMD:{
                        tagName:"button",
                        title:"{tips}",
                        style:'{_style}{itemStyle}',
                        className:'xui-node xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius xui-list-cmd xui-tag-cmd {itemClass}',
                        tabindex: '{_tabindex}',
                        text:"{caption}"
                    }
                },
                'tagCmds.image':{
                    CMD:{
                        tagName:"image",
                        title:"{tips}",
                        src:"{image}",
                        border:"0",
                        style:'{_style}{itemStyle}',
                        className:'xui-node xui-tag-cmd {itemClass}',
                        tabindex: '{_tabindex}',
                        alt:"{caption}"
                    }
                }
            };
            return key?tpl['tagCmds.'+key]:tpl;
        },
        _droppable:function(key){
            var self=this,
                h2=xui.Event.$eventhandler2,
                o=self.$Behaviors,
                v=key=='KEY'?o:(o[key]||(o[key]={})),
                handler=xui.$cache.UIKeyMapEvents,
                k2=key=='KEY'?self.KEY:(self.KEY+'-'+key),
                ch=handler[k2]||(handler[k2]={});

            //attach Behaviors
            xui.merge(v, {
                beforeMouseover:function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.disabled||prop.readonly)return;

                    // avoid no droppable keys
                    if(profile.behavior.NoDroppableKeys){
                        var sk = profile.getKey(xui.Event.getSrc(e).id || "").split('-')[1];
                        if(sk && xui.arr.indexOf(profile.behavior.NoDroppableKeys, sk)!=-1)return;
                    }

                    var ns=src, t,
                        dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        isPanelN=(t=profile.box.$Behaviors.PanelKeys) && xui.arr.indexOf(t, profile.getKey(src,true))!==-1,
                        item,box,args;

                    //not include the dragkey
                    if(data && 
                        (
                          (prop.dragSortable && profile.$xid==xui.get(data,['profile','$xid']) && !isPanelN ) || 
                          (key && (new RegExp('\\b'+key+'\\b')).test(profile.box.getDropKeys(profile, ns)))
                        )
                    ){
                        box=profile.boxing();
                        if(box.getItemByDom)
                            item=box.getItemByDom(src);

                        args=[profile, e, ns, key, data, item];
                        if((t=profile.onDropTest) && (false===box.onDropTest.apply(box,args)))
                            return;
                        if((t=profile.box._onDropTest) && (false===t.apply(profile.host||profile, args)))
                            return;
                        //for trigger onDrop
                        dd.setDropElement(src);
                        if(profile.onDropMarkShow && (false===box.onDropMarkShow.apply(box,args))){}
                        else if((t=profile.box._onDropMarkShow) && (false===t.apply(profile.host||profile, args))){}
                        else
                            //show region
                            xui.resetRun('setDropFace', dd.setDropFace, 0, [ns], dd);

                        if(t=profile.box._onDragEnter)t.apply(profile.host||profile, args);
                        if(profile.onDragEnter)box.onDragEnter.apply(box,args);
                        //dont return false, multi layer dd wont work well
                        //return false;
                    }
                },
                beforeMouseout:function(profile, e, src){
                    if(profile.properties.disabled||profile.properties.readonly)return;
                    var dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        item, box, args;

                    //not include the dragkey
                    if(pp.dropElement==src){
                        box=profile.boxing();
                        if(box.getItemByDom)
                            item=box.getItemByDom(src);

                        args=[profile, e, src, key, data, item];
                        if(profile.onDropMarkClear && (false===box.onDropMarkClear.apply(box,args))){}
                        else if((t=profile.box._onDropMarkClear) && (false===t.apply(profile.host||profile, args))){}
                        else xui.resetRun('setDropFace', dd.setDropFace, 0, [null], xui.DragDrop);

                        if(t=profile.box._onDragLeave)t.apply(profile.host||profile, args);
                        if(profile.onDragLeave)box.onDragLeave.apply(box,args);
                        dd.setDropElement(null);
                    }
                    //return false;
                },
                beforeDrop:function(profile, e, src){
                    var dd = xui.DragDrop,
                        pp = dd.getProfile(),
                        key = pp.dragKey,
                        data = pp.dragData,
                        item,t,args,
                        box=profile.boxing();
                    if(box.getItemByDom)
                        item=box.getItemByDom(src);
                    args=[profile, e, src, key, data, item];

                    if(profile.onDropMarkClear && (false===box.onDropMarkClear.apply(box,args))){}
                    else if((t=profile.box._onDropMarkClear) && (false===t.apply(profile.host||profile, args))){}

                    if(profile.beforeDrop && (false===box.beforeDrop.apply(box,args)))
                        return;

                    if( !profile.onDrop || (profile.onDrop && false===box.onDrop.apply(box,args)) ){
                        if(profile.box._onDrop)
                            profile.box._onDrop.apply(profile.host||profile, args);
                    }

                    if(profile.afterDrop)
                        box.afterDrop.apply(box,args);
                }
            }, 'all');

            xui.merge(ch,{
                onmouseover:h2,
                onmouseout:h2,
                ondrop:h2,
                afterDrop:h2,
                beforeDrop:h2
            });
            return self;
        },
        _draggable:function(key){
            var self=this,
                h2=xui.Event.$eventhandler2,
                o=self.$Behaviors,
                v=key=='KEY'?o:(o[key]||(o[key]={})),
                handler=xui.$cache.UIKeyMapEvents,
                k2=key=='KEY'?self.KEY:(self.KEY+'-'+key),
                ch=handler[k2]||(handler[k2]={});
            //attach Behaviors
            xui.merge(v, {
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    var prop=profile.properties;
                    if(prop.disabled)return;
                    // not resizable or drag
                    if(!(prop.dragSortable || prop.dragKey))return;

                    // avoid nodraggable keys
                    if(profile.behavior.NoDraggableKeys){
                        var sk = profile.getKey(xui.Event.getSrc(e).id || "").split('-')[1];
                        if(sk && xui.arr.indexOf(profile.behavior.NoDraggableKeys, sk)!=-1)return;
                    }

                    var pos=xui.Event.getPos(e),box=profile.boxing(),args=[profile,e,src],t;
                    if(profile.onStartDrag && (false===box.onStartDrag.apply(box,args))){}
                    else if((t=profile.box._onStartDrag) && (false===t.apply(profile.host||profile, args))){}
                    else{
                        var con=profile.box;
                        xui.use(src).startDrag(e, {
                            dragType:'icon',
                            targetLeft:pos.left+12,
                            targetTop:pos.top+12,
                            dragCursor:'pointer',
                            dragDefer:2,
                            dragKey: con.getDragKey(profile, src),
                            dragData: con.getDragData(profile, e, src)
                        });
                    }
                },
                beforeDragbegin:function(profile, e, src){
                    xui.use(src).onMouseout(true,{$force:true}).onMouseup(true);
                },
                beforeDragstop:function(profile, e, src){
                    var t;
                    if(profile.onDragStop)profile.boxing().onDragStop(profile.e,src);
                    if(t=profile.box._onDragStop)t.apply(profile.host||profile, arguments);
                }
            }, 'all');
            xui.merge(ch,{
                onmousedown:h2,
                ondragbegin:h2
            });

            return self;
        },
        //for relative , static children
        _adjustConW:function(profile, panel, parentW, cur){
            var prop = profile.properties,cols;
            if(!(cols = prop.conLayoutColumns))
                cols=prop.conDockRelative?1:0;
            if(!cols)return;

            var pad = prop.conDockPadding,
                  spc = prop.conDockSpacing,
                  c = panel.children(),
                  l = c.size(),off,pw,w,tw,index=0,ww,rowtotal=0,
                 scrollw,changed;
            if(!l)return;
            // ensure inline block
            c.each(function(n,i,prf,p){
                if(cur && n!=cur)return;
                if(n.id && (prf=xui.$cache.profileMap[n.id]) && prf.Class && prf.Class['xui.UIProfile']){
                    p=xui(n).css('position');
                    if(p=='relative'||p=='static')
                        xui(n).setInlineBlock();
                }
            });
            // calculate width
            scrollw =  (panel.isScrollBarShowed('y')?xui.Dom.getScrollBarSize():0);
            off = pad.left + pad.right + (cols -1) * spc.width + scrollw;
            pw = profile.$px(parentW) - off;
            // It must be integer
            w = Math.floor(pw/cols);
            // set width
            c.each(function(n,i,prf,p){
                if(cur && n!=cur)return;
                if(n.id && (prf=xui.$cache.profileMap[n.id]) && prf.Class && prf.Class['xui.UIProfile']){
                    p=xui(n).css('position');
                    if(p=='relative'||p=='static'){
                        if(prf){
                            xui(n).css({
                                position:'relative',
                                left:'auto',
                                top:'auto',
                                right:'auto',
                                bottom:'auto',
                                'margin-left': (i===0 ? pad.left : spc.width)+'px',
                                'margin-top': (i===0 ? pad.top : spc.height)+'px'
                            });
                            ww=prf.$forceu( w );
                            if((index+1)%cols===0){
                                ww=prf.$forceu( pw -  rowtotal);
                                rowtotal=0;
                            }else{
                                rowtotal += w;
                                ww=prf.$forceu( w );
                            }
                            // to trigger onsize
                            xui(n).width( prf.properties.width = ww );
                            index++;
                        }
                    }
                }
            });

            if(cur){
                if(scrollw && !profile._scrollY){
                    profile._scrollY=1;
                    changed=1;
                }
                if(!scrollw && profile._scrollY){
                    delete profile._scrollY;
                    changed=1;
                }
                if(changed){
                    xui.UI._adjustConW(profile, panel, parentW, null);
                }
            };
        },
        /*copy item to hash, use 'without'
        exception: key start with $
        value(start with $) get a change to get value from setting
        */
        adjustData:function(profile, hashIn, hashOut, type){
            if(!hashOut)hashOut={};

            var box=profile.box, dm = box.$DataModel,i,o;

            for(i in hashIn){
                if(i.charAt(0)=='$')continue;
                if(hashIn.hasOwnProperty(i) &&  !hashOut.hasOwnProperty(i)){
                    hashOut[i] = typeof (o=hashIn[i])=='string' ? i=='html' ? xui.adjustRes(o,0,1,false,null,null,type=='sub'&&hashIn) : xui.adjustRes(o,true,false,null,null,type=='sub'&&hashIn) : o;
                }
            }
            if('hidden' in hashIn)
                hashOut.hidden=hashIn.hidden;
            // filter: hidden
            var itemFilter=hashIn.itemFilter||profile.$itemFilter;
            if(itemFilter)hashOut.hidden = !!itemFilter(hashIn,'prepareItem',profile);

            hashOut._itemDisplay=hashIn.hidden?'display:none;':'';

            if('disabled' in dm)
                hashOut.disabled= (xui.isSet(hashOut.disabled) && hashOut.disabled) ?'xui-ui-itemdisabled':'';
            if('readonly' in dm)
                hashOut.readonly= (xui.isSet(hashOut.readonly) && hashOut.readonly) ?'xui-ui-itemreadonly':'';

            //todo:remove the extra paras
            hashOut.imageDisplay = (hashOut.imageClass||hashOut.image||hashOut.iconFontCode)?'':'display:none';
            var ifc;
            if(hashOut.iconFontCode){
                // iconFontCode + imageClass
                if(hashOut.imageClass){
                    // filter built-in class
                    var arr=hashOut.imageClass.split(/\s+/);
                    xui.filter(arr,function(s){
                        return !xui.builtinFontIcon[s];
                    });
                    hashOut.imageClass = arr.join(' ');
                }
            }else{
                // for ie687
                if(hashOut.imageClass){
                    var arr=hashOut.imageClass.split(/\s+/);
                    xui.arr.each(arr,function(s){
                        if(xui.builtinFontIcon[s]){
                            ifc=xui.builtinFontIcon[s];
                            return;
                        }
                    },null,true);

                    if(ifc && xui.__iefix2){
                        hashOut.iconFontCode=ifc;
                        xui.filter(arr,function(s){
                            return !xui.builtinFontIcon[s];
                        });
                    }
                    hashOut.imageClass = arr.join(' ');
                }
                if(!ifc){
                    hashOut.picClass = 'xui-css-innerimage';
                    // imageClass + image
                    if(hashOut.image){
                        hashOut.imageClass='xui-icon-placeholder';
                        hashOut.backgroundImage="background-image:url("+ hashOut.image +");";
                    }
                    if(hashOut.imagePos)
                        hashOut.backgroundPosition='background-position:'+hashOut.imagePos+';';
                    else if(hashOut.image)
                        hashOut.backgroundPosition='background-position:center;';

                    if(hashOut.imageBgSize)
                        hashOut.backgroundSize='background-size:'+hashOut.imageBgSize+';';
                    else if(hashOut.image)
                        hashOut.backgroundSize='background-size:initial;';

                    if(hashOut.imageRepeat)
                        hashOut.backgroundRepeat='background-repeat:'+hashOut.imageRepeat+';';
                    else if(hashOut.image)
                        hashOut.backgroundRepeat='background-repeat:no-repeat;';
                }
            }
            if(hashOut.iconFontSize)
                hashOut.iconFontSize='font-size:'+hashOut.iconFontSize+';';
            //must be here
            //Avoid Empty Image src
            // ensoure to trigger load event of img
            if(!hashOut.image && box.IMGNODE)hashOut.image=xui.ini.img_blank;

            if((typeof (o=hashOut.renderer)=='function') || (typeof (o=hashIn.renderer)=='function'))
                hashOut.caption=xui.adjustRes(o.call(profile,hashIn,hashOut));

            return hashOut;
        },
        $iconAction:function(profile,key,oldImageClass){
            var p=profile.properties,
                icon=profile.getSubNode(key||'ICON'),
                dispaly = (p.imageClass||p.image||p.iconFontCode)?'':'display:none',
                ifc;

            // clear all first
            icon.css('backgroundImage',"none");
            icon.removeClass('xui-icon-placeholder');
            if(p.imageClass)icon.removeClass(p.imageClass);
            if(oldImageClass)icon.removeClass(oldImageClass);
            icon.html('');

            if(p.iconFontCode){
                icon.html(p.iconFontCode);
                // iconFontCode + imageClass
                if(p.imageClass){
                    // filter built-in class
                    var arr=p.imageClass.split(/\s+/);
                    xui.filter(arr,function(s){
                        return !xui.builtinFontIcon[s];
                    });
                    icon.addClass(arr.join(' '));
                }
            }else{
                // for ie687
                if(p.imageClass){
                    var arr=p.imageClass.split(/\s+/);
                    xui.arr.each(arr,function(s){
                        if(xui.builtinFontIcon[s]){
                            ifc=xui.builtinFontIcon[s];
                            return;
                        }
                    },null,true);
                    if(ifc && xui.__iefix2){
                        p.iconFontCode=ifc;
                        xui.filter(arr,function(s){
                            return !xui.builtinFontIcon[s];
                        });
                    }
                    icon.addClass(arr.join(' '));
                }
                if(p.iconFontCode){
                    icon.html(p.iconFontCode);
                }
                if(!ifc){
                    // imageClass + image
                    if(p.image){
                        icon.addClass('xui-icon-placeholder');
                        icon.css('backgroundImage', 'url('+xui.adjustRes(p.image)+')');
                    }
                }
            }
            icon.css('display',dispaly);
        },
        cacheData:function(key, obj){
            xui.set(xui.$cache,['UIDATA', key], obj);
            return this;
        },
        getCachedData:function(key){
            var r = xui.get(xui.$cache,['UIDATA', key]);
            if(typeof r == 'function')r=r();
            return r;
        },

        Behaviors:{
            HotKeyAllowed:true,
            onContextmenu:function(profile, e, src){
                if(profile.onContextmenu)
                    return profile.boxing().onContextmenu(profile, e, src)!==false;
            }
        },
        DataModel:{
            autoTips:true,
            "className":{
                ini:"",
                action:function(v,ov){
                    if(ov)
                        this.getRoot().removeClass(ov);
                    this.getRoot().addClass(v);
                    delete this._nodeEmSize;
                }
            },
            disableClickEffect:false,
            disableHoverEffect:false,
            disableTips:false,
            disabled:{
                ini:false,
                action: function(v){
                    var i=this.getRoot();
                    if(v)
                        i.addClass('xui-ui-disabled');
                    else
                        i.removeClass('xui-ui-disabled');
                }
            },
            spaceUnit:{
                listbox:['','px','em'],
                action:function(){
                        this.boxing().reLayout(true).getChildren(true, "penetrate").reLayout(true);
                }
            },
            defaultFocus:false,
            hoverPop:{
                ini:'',
                action:function(v,ov){
                     var ns=this,b=ns.boxing(),p=ns.properties,t;
                     if(!ns.destroyed && ns.host){
                         if(ov && (t=ns.host[ov]) && (t=t.get(0)) && t.renderId&& !t.destroyed)
                            b.hoverPop(t,null);
                         if(v && (t=ns.host[v]) && (t=t.get(0)) && t.renderId&& !t.destroyed)
                            b.hoverPop(t, p.hoverPopType, function(){
                                t.properties.tagVar.hoverFrom=arguments;
                            },function(){
                                delete t.properties.tagVar.hoverFrom;
                            },t.getRoot().parent(),v);
                     }
                }
            },
            hoverPopType:{
                ini:'outer',
                dftWidth:180,
                listbox:['outer','inner',
                'outerleft-outertop','left-outertop','center-outertop','right-outertop','outerright-outertop',
                'outerleft-top','left-top','center-top','right-top','outerright-top',
                'outerleft-middle','left-middle','center-middle','right-middle','outerright-middle',
                'outerleft-bottom','left-bottom','center-bottom','right-bottom','outerright-bottom',
                'outerleft-outerbottom','left-outerbottom','center-outerbottom','right-outerbottom','outerright-outerbottom'
                ]
            },
            locked:{
                ini:false,
                action:function(){
                    if(this.$inDesign){
                            this.boxing().refresh(true);
                    }
                }
            },
            dock:{
                ini:'none',
                listbox:['none','top','bottom','left','right','center','middle','origin','width','height','fill','cover'],
                action:function(v){
                    xui.UI.$dock(this,true,true);
                }
            },
            dockIgnore:{
                ini:false,
                action:function(v){
                    var self=this;
                    if(self.properties.dock!='none')
                        xui.UI.$dock(self,true,true);
                }
            },
            dockFloat:{
                ini:false,
                action:function(v){
                    var self=this;
                    if(self.properties.dock!='none')
                        xui.UI.$dock(self,true,true);
                }
            },
            dockOrder:{
                ini: 1,
                action:function(v){
                    var self=this;
                    if(self.properties.dock!='none')
                        xui.UI.$dock(self,true,true);
                }
            },
            showEffects:"",
            hideEffects:"",
            dockMargin:{
                ini:{left:0,top:0,right:0,bottom:0},
                action:function(v){
                    var self=this;
                    v=v||{};
                    v.left=v.left||0;v.top=v.top||0;v.right=v.right||0;v.bottom=v.bottom||0;
                    if(self.properties.dock!='none')
                        xui.UI.$dock(self,true,true);
                }
            },

            dockMinW:{
                $spaceunit:1,
                ini:0
            },
            dockMinH:{
                $spaceunit:1,
                ini:0
            },
            dockMaxW:{
                $spaceunit:1,
                ini:0
            },
            dockMaxH:{
                $spaceunit:1,
                ini:0
            },

            // to stop conDockFlexFill
            dockIgnoreFlexFill:{
                ini:false,
                action:function(v){
                    var self=this;
                    if(self.properties.dock!='none')
                        xui.UI.$dock(self,true,true);
                }
            },
            // for top/left/right/bottom only
            // "" can be reset by container's conDockStretch
            dockStretch:{
                ini:"",
                combobox:['fixed','forward','rearward','stretch','0.25','0.33','0.5'],
                set:function(value){
                    var o=this, t=o.properties;
                    t.dockStretch=value;
                    if(t.dock == "fill"||t.dock == "cover"||t.dock == "width"||t.dock == "height"){
                        if(value!='forward'&&value!='rearward'&&value!='stretch'){
                            t.dockStretch="stretch";
                        }
                    }
                    if(o.rendered && t.dock!='none'){
                        xui.UI.$dock(o,true,true);
                    }
                }
            },
            tips:{
                ini:'',
                action:function(v){
                    var t=xui.Tips;
                    if(t&&t._showed){
                        if(xui.UIProfile.getFromDom(t._markId)==this){
                            t.setTips(v, true);
                        }
                    }
                }
            },
            rotate:{
                ini:0,
                action:function(v){
                    var root=this.getRoot(),ins=this.boxing();
                    v=parseFloat(v)||0;
                    v=v%360;
                    if(v<0)v=v+360;
                    if(this.box['xui.svg']){
                        ins.setAttr("KEY", {transform:'r'+v}, false);
                    }else{
                        root.rotate(v);
                    }
                }
            },
            activeAnim:{
                ini:"",
                action:function(key){
                    if(key)this._activeAnim = this.boxing().animate(key).id;
                    else delete thie._activeAnim;
                }
            }
        },
        EventHandlers:{
            beforeRender:function(profile){},
            onRender:function(profile){},
            onLayout:function(profile){},
            onResize:function(profile,width,height){},
            onMove:function(profile,left,top,right,bottom){},
            onDock:function(profile,region){},
            beforePropertyChanged:function(profile,name,value,ovalue){},
            afterPropertyChanged:function(profile,name,value,ovalue){},
            beforeAppend:function(profile,child){},
            afterAppend:function(profile,child){},
            beforeRemove:function(profile,child,subId,bdestroy){},
            afterRemove:function(profile,child,subId,bdestroy){},
            onDestroy:function(profile){},
            beforeDestroy:function(profile){},
            afterDestroy:function(profile){},
            onShowTips:function(profile, node, pos){},
            onContextmenu:function(profile, e, src, item){}
        },
        RenderTrigger:function(){
            var prf=this, b=prf.boxing(),p=prf.properties,t,
                node=prf.getRootNode(),
                style=node.style;

            if(p.sandboxTheme){
                xui.UI._refreshSBTheme(prf, p.sandboxTheme);
            }

            if(prf.box._onresize){
                //avoid UI blazzing
                if(!prf._syncResize && !prf.box._syncResize){
                    var style=prf.getRootNode().style,t
                    if((t=style.visibility)!='hidden'){
                       prf._$visibility=t;
                       style.visibility='hidden';
                    }
                    style=null;
                }
                xui.UI.$tryResize(prf,p.width,p.height);
            }
            if(p.disabled) b.setDisabled(true,true);
            if(p.rotate) b.setRotate(p.rotate,true);
             if(!prf.$inDesign && p.hoverPop){
                xui.asyRun(function(){
                    b.setHoverPop(p.hoverPop,true);
                });
            }
            // set dataBinder for container
            if(prf.behavior.PanelKeys){
                if(t=p.dataBinder)b.setDataBinder(t,true);
            }

            // attention animation
            if(p.activeAnim){
                xui.asyRun(function(){
                    if(prf && !prf.destroyed)
                        prf.boxing().setActiveAnim(p.activeAnim, true);
                });
            }
            (prf.$beforeDestroy=(prf.$beforeDestroy||{}))["activeAnim"]=function(t){
                if(t = prf._activeAnim)
                    xui.Thread(t).abort();
            }

            prf._inValid=1;
        },
        $doResize:function(profile,w,h,force,key){
            if(force || ((w||h) && (profile._resize_w!=w || profile._resize_h!=h))){
                //destroyed before resize
                if(!profile.getRootNode())return false;

                profile._resize_w=w;
                profile._resize_h=h;
                xui.tryF(profile.box._onresize,[profile,w,h,force,key],profile.box);

                // for have _onresize widget only
                if(profile.onResize)
                    profile.boxing().onResize(profile,w,h);
            }

            //some control will set visible to recover the css class
            if('_$visibility' in profile){
                var node=profile.getRootNode(),
                    style=node.style;
                if(style.visibility!='visible' && !xui.getNodeData(node,'_setVisibility'))
                    style.visibility=profile._$visibility;
                node=style=null;
                xui.clearTimeout(profile._$rs_timer);
                delete profile._$rs_timer;
                delete profile._$rs_args;
                delete profile._$visibility;
            }
        },
        $tryResize:function(profile,w,h,force,key){
            var s=profile.box,t=s._onresize;
            if(t&&(force||w||h)){
                //adjust width and height
                //w=parseFloat(w)||null;
                w=((w===""||w=='auto')?"auto":((xui.isFinite(w)||profile.$isPx(w))?(parseFloat(w)||0):w))||null
                h=((h===""||h=='auto')?"auto":  ((xui.isFinite(h)||profile.$isPx(h))?(parseFloat(h)||0):h))||null;

                //if it it has delay resize, overwrite arguments
                if('_$visibility' in profile){
                    var args=profile._$rs_args;
                    // asyrun once only
                    if(!args){
                        args=profile._$rs_args=[profile,null,null];
                        profile._$rs_timer=xui.asyRun(function(){
                            // destroyed
                            if(!profile.box)return;
                            if(profile && profile._$rs_args)
                                xui.UI.$doResize.apply(null,profile._$rs_args);
                        });
                    }
                    //keep the last one, neglect zero and 'auto'
                    args[1]=w;
                    args[2]=h;
                    args[3]=force;
                    args[4]=key;
                //else, call resize right now
                }else{
//for performance checking
//console.log('resize',profile.$xid,w,h,force,key);
                    xui.UI.$doResize(profile,w,h,force,key);
                }
            }
        },
        LayoutTrigger:function(){
            var self=this, b=self.boxing(),p=self.properties;
            // have to refresh this
            delete self._nodeEmSize;

            if(p.position=='absolute'){
                if(p.dock && p.dock != 'none'){
                    //first time, ensure _onresize to be executed.
                    if(!self.$laidout){
                        self.$laidout=1;
                        var stl=self.getRootNode().style,
                            wu = 0+self.$picku(stl.width),
                            hu = 0+self.$picku(stl.height);
                        switch(p.dock){
                            case 'top':
                            case 'bottom':
                            case 'width':
                                stl.width = 0;
                                break;
                            case 'left':
                            case 'right':
                            case 'height':
                                stl.height = 0;
                                break;
                            default:
                                stl.width = 0;
                                stl.height = 0;
                        }
                    }
                    xui.UI.$dock(this,false,true);
                }
            }else{
                if(xui.get(self,['parent','properties','conDockRelative'])||xui.get(self,['parent','properties','conLayoutColumns'])){
                    var pp=self.parent;
                    xui.UI._adjustConW(pp, self.getRoot().parent(), self.getRoot().parent().width(), self.getRootNode());
                }
            }
        },
        $dock_args:['top','bottom','left','right','center','middle','width','height'],
        $dock_map:{middle:1,center:1},
        $dock:function(profile, force, trigger){
            var node = profile.getRoot(),
                isSVG = profile.box['xui.svg'],
                ins = profile.boxing(),
                i1=-1,i2=-1,i3=-1,i4=-1,
                p=xui((node.get(0) && node.get(0).parentNode)||profile.$dockParent),
                //for ie6 1px bug
                _adjust=function(v){return xui.browser.ie&&xui.browser.ver<=6?v-v%2:v},
                adjustOverflow=function(p,isWin){
                    var f,t,c,x,y;
                    if(isWin){
                        f=xui.win.$getEvent('onSize','dock');
                    }else if(p && p.get(0)){
                        f=p.$getEvent('onSize','dock');
                    }

                    if(f && f.dockall && f.dockall.length){
                        for(var i=0,l=f.dockall.length,s; i<l; i++){
                            s=f.dockall[i].$dockType;
                            switch(s){
                                case "fill":
                                case "cover":
                                    x=y=1;
                                break;
                                case "top":
                                case "bottom":
                                case "width":
                                    x=1;
                                break;
                                case "left":
                                case "right":
                                case "height":
                                    y=1;
                                break;
                            }
                        }
                    }
                    if(x&&y){
                        c="xui-css-noscroll";
                    }else if(x){
                        c="xui-css-noscrollx";
                    }else if(y){
                        c="xui-css-noscrolly";
                    }
                    if(isWin){
                        xui('html').removeClass(/^xui-css-noscroll(x|y)?$/);
                        t=xui('body').get(0);
                        if(t)t.scroll='';
                        if(c){
                            if(x)xui.win.scrollLeft(0);
                            if(y)xui.win.scrollTop(0);
                            xui('html').addClass(c);
                            if(x && y && t){
                                t.scroll='no';
                            }
                        }
                    }else{
                        p.removeClass(/^xui-css-noscroll(x|y)?$/);
                        if(c){
                            if(x)p.scrollLeft(0);
                            if(y)p.scrollTop(0);
                            p.addClass(c);
                        }
                    }
                },
                // adjust min/max
                checkLimits = function(profile, prop, dir, value){
                    var t;
                    if(parseFloat(prop['dockMin'+dir])&&(t=profile.$px(prop['dockMin'+dir]))) value = _adjust(t<=value?value:t);
                    if(parseFloat(prop['dockMax'+dir])&&(t=profile.$px(prop['dockMax'+dir]))) value = _adjust(t<=value?t:value);
                    return value;
                },
                apply2Ctrl = function(profile, isSvg, ins, node, style, region){
                    var us = xui.$us(profile),
                        adjustunit = function(v){return profile.$forceu(v, us>0?'em':'px', null, true)};
                    // apply to UI
                    if(('left' in region) && profile.$px(style.left)!==region.left)region.left=adjustunit(region.left);
                    if(('top' in region) && profile.$px(style.top)!==region.top)region.top=adjustunit(region.top);
                    if(('right' in region) && profile.$px(style.right)!==region.right)region.right=adjustunit(region.right);
                    if(('bottom' in region) && profile.$px(style.bottom)!==region.bottom)region.bottom=adjustunit(region.bottom);
                    if(('width' in region) && profile.$px(style.width)!==region.width)region.width=adjustunit(region.width);
                    if(('height' in region) && profile.$px(style.height)!==region.height)region.height=adjustunit(region.height);
                    if(!xui.isEmpty(region)){
                        if(isSVG)  ins._setBBox(region);
                        else node.cssRegion(region,true);
                    }
                },
                applyPrevLine=function(obj, space/*spaceW*/, all/*obj.ww*/, p2/*width*/, p3/*dockMaxW*/, p4/*left*/, p5/*right*/){
                    if(!obj.prevLine.length)return;
                    var pct=[], size, t, l, region, node, prop, margin, style,
                        ll=obj.prevLine.length-1, preAll = 0,
                        start=obj[p4],
                        css=xui.CSS;

                    all -= ll*space;
                    // get [all] available
                    xui.arr.each(obj.prevLine,function(n){
                        if(n.pct){
                            pct.push(n);
                        }else{
                            all -= n.region[p2] + n.margin[p4] + n.margin[p5];
                        }
                    });

                    // determine pct's size
                    if(l=pct.length){
                        // sum pct
                        var pctSum=0;
                        xui.arr.each(pct,function(n,i){
                            pctSum += n.pct;
                        });
                        xui.arr.each(pct,function(n,i){
                            prop=n.prop;
                            region=n.region;
                            nodefz=n.nodefz;

                            // recaculate pct
                            n.pct = n.pct / pctSum;

                            // caculate size
                            size = all*n.pct - n.margin[p4] - n.margin[p5];
                            // adjust max only
                            if(parseFloat(prop[p3])&&(t=css.$px(prop[p3],nodefz))) size = _adjust(t<=size?t:size);
                            if(i==l-1){
                                size = all - preAll;
                                // adjust max only
                                if(parseFloat(prop[p3])&&(t=css.$px(prop[p3],nodefz))) size = _adjust(t<=size?t:size);
                                region[p2]=size;
                            }else{
                                preAll += (region[p2]=parseInt(size,10));
                            }
                        });
                    }

                    // determine pct's start pos, and set to UI
                    xui.arr.each(obj.prevLine,function(n,i){
                        region=n.region;
                        // left, top, bottom, right
                        region[p4]=parseInt(start  + n.margin[p4], 10);
                        start +=  region[p2] + n.margin[p4] + n.margin[p5] + space ;
                        apply2Ctrl(n.profile, n.isSVG, n.ins, n.node, n.style, region);
                    });
                    // rest the prev line
                    obj.prevLine=[];
                };

            if(!p.get(0))
                return;
            var prop = profile.properties,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate, true)},
                margin=prop.dockMargin,
                auto = 'auto',
                value = prop.dock || 'none',
                pid=xui.Event.getId(p.get(0)),
                order=function(x,y){
                    x=parseInt(x.properties.dockOrder,10)||0;y=parseInt(y.properties.dockOrder,10)||0;
                    return x>y?1:x==y?0:-1;
                },
                region,
                inMatrix='$inMatrix',
                f,t,isWin,
                rootfz = node._getEmSize(),
                umargin={
                    top:adjustunit(margin.top||0,rootfz),
                    left:adjustunit(margin.left||0,rootfz),
                    right:adjustunit(margin.right||0,rootfz),
                    bottom:adjustunit(margin.bottom||0,rootfz)
                };

            if(isSVG){
                var bbox=ins._getBBox();
                prop.left=bbox.x;
                prop.top=bbox.y;
                prop.width=bbox.width;
                prop.height=bbox.height;
            }
            if(p.get(0)===document.body || p.get(0)===document || p.get(0)===window){
                pid='!document';
                isWin=true;
            }

            //attached to matrix
            if(pid && (pid==xui.Dom._ghostDivId || xui.str.startWith(pid,xui.Dom._emptyDivId)))
                return;

            if(profile.$dockParent!=pid || profile.$dockType != value || force){
                profile.$dockParent=pid;
                profile.$dockType = value;

                //unlink first
                i1=profile.unLink('$dockall');
                i2=profile.unLink('$dock');
                i3=profile.unLink('$dock1');
                i4=profile.unLink('$dock2');

                //set the fix value first
                switch(value){
                    case 'middle':
                        region={right:prop.right==auto?auto:(prop.right||''), bottom:auto,left:prop.left==auto?auto:(prop.left||''),width:prop.width||'',height:prop.height||''};
                        break;
                    case 'center':
                        region={right:auto, bottom:prop.bottom==auto?auto:(prop.bottom||''),top:prop.top==auto?auto:(prop.top||''),width:prop.width||'',height:prop.height||''};
                        break;
                    case 'origin':
                        region={right:auto, bottom:auto,width:prop.width||'',height:prop.height||''};
                        break;
                    case 'top':
                        region={left:umargin.left, right:umargin.right, bottom:auto, height:prop.height||''};
                        //width top
                        break;
                    case 'bottom':
                        region={left:umargin.left, right:umargin.right, top:auto, height:prop.height||''};
                        //width bottom
                        break;
                    case 'left':
                        region={right:auto,width:prop.width||''};
                        //height top left
                        break;
                    case 'right':
                        region={left:auto,width:prop.width||''};
                        //height top right
                        break;
                    case 'width':
                        region={bottom:auto,height:prop.height||'',top:prop.top||''};
                        //width left
                        break;
                    case 'height':
                        region={right:auto,width:prop.width||'',left:prop.left||''};
                        //height top
                        break;
                    case 'fill':
                    case 'cover':
                        region={right:auto,bottom:auto};
                        break;
                    case 'none':
                        region={left:prop.left, top:prop.top, width:prop.width||'',height:prop.height||''};
                        break;
                }
                if(node.get(0)){
                    if(isSVG)
                        ins._setBBox(region);
                    else
                        node.cssRegion(region,true);
                }
                //if in body, set to window
                if(isWin){
                    p=xui.win;
                    if(!xui.$cache._resizeTime)xui.$cache._resizeTime=1;
                }
                //set dynamic part
                if(value != 'none'){
                    f = p.$getEvent('onSize','dock');
                    if(!f){
                        f=function(arg){
                            //get self vars
                            var me=arguments.callee,
                                css=xui.CSS,
                                map=xui.UI.$dock_map,
                                arr=xui.UI.$dock_args,
                                rePos=me.rePos,
                                pid=me.pid,
                                // the dock parent is window
                                isWin= me.pid=="!window" || me.pid=="!document",
                                pprf = isWin?0:xui.UIProfile.getFromDom(pid),
                                pprop = pprf && pprf.properties,
                                proot = pprf && pprf.getRoot(),
                                pstyle = proot && proot.get(0) && proot.get(0).style,
                                prootfz = pstyle && proot._getEmSize(),
                                conDockSpacing=(pprop && ('conDockSpacing' in pprop))?pprop.conDockSpacing:{width:0,height:0},
                                conDockPadding=(pprop && ('conDockPadding' in pprop))?pprop.conDockPadding:{left:0,top:0,right:0,bottom:0},
                                conDockFlexFill=(pprop && ('conDockFlexFill' in pprop))?pprop.conDockFlexFill:'',
                                conDockStretch=(pprop && ('conDockStretch' in pprop))?pprop.conDockStretch.split(/[,;\s]+/):[],
                                perW=conDockFlexFill=="width"||conDockFlexFill=="both",
                                perH=conDockFlexFill=="height"||conDockFlexFill=="both",
                                node=isWin?xui.win:xui(pid);

                             if(!node.get(0))
                                return;

                             var pn=node.get(0),
                                style=pn.style,
                                us = xui.$us(prop),
                                nodefz = node._getEmSize(),
                                adjustunit = function(v,emRate){return css.$forceu(v, us>0?'em':'px', emRate||nodefz)},
                                obj,i,k,o,key,target,
                                ofs = isWin ? xui('body').get(0).style : style,
                                old_of=ofs.overflow,
                                old_ofx=ofs.overflowX,
                                old_ofy=ofs.overflowY;

                            // 1. set overflow for size
                            if(style)style.overflow=style.overflowX=style.overflowY="hidden";


                            //2. get width / height
                            var width=(style&&css.$px(style.width,nodefz))||node.width()||0,
                                height=(style&&css.$px(style.height,nodefz))||node.height()||0;
                            if(width=='auto')width=0;
                            if(height=='auto')height=0;
                            //width=Math.max( node.scrollWidth()||0,  (style&&css.$px(style.width,nodefz))||node.width()||0);
                            //height=Math.max( node.scrollHeight()||0, (style&&css.$px(style.height,nodefz))||node.height()||0);

                            // 3.reset overflow
                           if(style){
                               style.overflow = old_of;
                               style.overflowX = old_ofx;
                               style.overflowY = old_ofy;
                           }
                            conDockSpacing={
                                width:css.$px(conDockSpacing.width||0,prootfz),
                                height:css.$px(conDockSpacing.height||0,prootfz)
                            };
                            conDockPadding={
                                left:css.$px(conDockPadding.left||0,prootfz),
                                top:css.$px(conDockPadding.top||0,prootfz),
                                right:css.$px(conDockPadding.right||0,prootfz),
                                bottom:css.$px(conDockPadding.bottom||0,prootfz)
                            };

                            //window resize: check time span, for window resize in firefox
                            //force call when input $dockid
                            //any node resize
                            if( arg.$dockid || !isWin || ((xui.stamp() - xui.$cache._resizeTime) > 50)){
                                //recruit call, give a short change
                                obj = {
                                    // padding
                                    left: conDockPadding.left,
                                    top: conDockPadding.top,
                                    right: conDockPadding.right,
                                    bottom: conDockPadding.bottom,
                                    // size
                                    width: width,
                                    height: height
                                };
                                obj.preX = obj.oX = obj.left;
                                obj.preY = obj.oY = obj.top;
                                obj.prevLine=[];
                                // space avaiable
                                obj.ww = obj.width - obj.left - obj.right;
                                obj.hh = obj.height - obj.top - obj.bottom;
                                obj.leftHolder=obj.topHolder=obj.rightHolder=obj.bottomHolder=0;


                                // adjust  aother dimension first
                                if(perW || perH){
                                    var wCount=0,wSum=0,hCount=0,hSum=0,tmp,hMax=0,adjustMM=function(prf,direction,numb,prop,t){
                                        prop=prf.properties;
                                        if(parseFloat(t=prop['dockMin'+direction]))numb=Math.max(prf.$px(t),numb);
                                        if(parseFloat(t=prop['dockMax'+direction]))numb=Math.min(prf.$px(t),numb);
                                        return numb;
                                    };
                                    // collect controls (w/h) to be percentaged, no dockIgnore
                                    for(k=0;key=arr[k++];){
                                        target = me[key];
                                        if(target.length){
                                            for(i=0;o=target[i++];){
                                                if(!(o.properties.position!='absolute' || o.properties.dockIgnore || o.properties.dockIgnoreFlexFill)){
                                                    var node = o.getRoot();
                                                    if(perW && (key=='left'||key=='right'||key=='width')){
                                                        wCount++;
                                                        tmp= adjustMM(o,"W", node.width()) ;
                                                        wSum +=tmp;
                                                        if(o.properties.dock!="fill"){
                                                            hMax = Math.max(hMax, adjustMM(o,"H", node.height()));
                                                        }
                                                    }
                                                    if(perH && (key=='top'||key=='bottom'||key=='height')){
                                                        hCount++;
                                                        hSum += adjustMM(o,"H", node.height());
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if(hSum&&hMax){
                                        hSum += hMax;
                                    }
                                    // for w percent
                                    if(wCount>=1 && wSum && obj.width){
                                        var innerW = obj.width - conDockPadding.left - conDockPadding.right - (wCount-1)*conDockSpacing.width;
                                        for(k=0;key=arr[k++];){
                                            target = me[key];
                                            if(target.length){
                                                for(i=0;o=target[i++];){
                                                    if(o.properties.position=='absolute' && !o.properties.dockIgnore && o.properties.dockIgnoreFlexFill){
                                                        var node = o.getRoot();
                                                        if(key=='left'||key=='right'||key=='width'){
                                                            innerW -= adjustMM(o,"W", node.width());
                                                            innerH -= conDockSpacing.width;
                                                        }
                                                    }
                                                }
                                                for(i=0;o=target[i++];){
                                                    if(!(o.properties.position!='absolute'|| o.properties.dockIgnore || o.properties.dockIgnoreFlexFill)){
                                                        var node = o.getRoot();
                                                        if(key=='left'||key=='right'||key=='width'){
                                                            node.width(adjustunit( adjustMM(o,"W",Math.min(1, ( node.width()) / wSum) * innerW)) );
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    // for h percent
                                    if(hCount>=1  && hSum && obj.height){
                                        var innerH = obj.height - conDockPadding.top - conDockPadding.bottom - (hCount-1)*conDockSpacing.height;
                                        for(k=0;key=arr[k++];){
                                            target = me[key];
                                            if(target.length){
                                                for(i=0;o=target[i++];){
                                                    if(o.properties.position=='absolute' && !o.properties.dockIgnore && o.properties.dockIgnoreFlexFill){
                                                        var node = o.getRoot();
                                                        if(key=='top'||key=='bottom'||key=='height'){
                                                            innerH -= adjustMM(o,"H",  node.height());
                                                            innerH -= conDockSpacing.height;
                                                        }
                                                    }
                                                }
                                                for(i=0;o=target[i++];){
                                                    if(!(o.properties.position!='absolute' || o.properties.dockIgnore || o.properties.dockIgnoreFlexFill)){
                                                        var node = o.getRoot();
                                                        if(key=='top'||key=='bottom'||key=='height'){
                                                            node.height(adjustunit( adjustMM(o,"H",Math.min(1, ( node.height())/ hSum) * innerH)) );
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    if(pprf&&perW)pprf._conDockFlexFillW=1;
                                    if(pprf&&perH)pprf._conDockFlexFillH=1;
                                }
                                if(conDockFlexFill!="both"){
                                    for(k=0;key=arr[k++];){
                                        target = me[key];
                                        if(target.length){
                                            for(i=0;o=target[i++];){
                                                if(!(o.properties.position!='absolute' || o.properties.dockIgnore || o.properties.dockIgnoreFlexFill)){
                                                    var node = o.getRoot();
                                                    if(pprf&&pprf._conDockFlexFillW && !perW && (key=='left'||key=='right'||key=='width')){
                                                        node.width(adjustunit(o.properties.width)) ;
                                                    }
                                                    if(pprf&&pprf._conDockFlexFillH && !perH && (key=='top'||key=='bottom'||key=='height')){
                                                        node.height(adjustunit(o.properties.height));
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                if(pprf&&pprf._conDockFlexFillW)delete pprf._conDockFlexFillW;
                                if(pprf&&pprf._conDockFlexFillH)delete pprf._conDockFlexFillH;

                                // repos && resize
                                for(k=0;key=arr[k++];){
                                    obj.preX = obj.oX;
                                    obj.preY = obj.top;

                                    target = me[key];
                                    var ii=0,ll;
                                    if(ll=target.length){
                                        if(!map[key])arg.width=arg.height=1;
                                        for(i=0;o=target[i++];){
                                            if(o.properties.position=='absolute' && !o.properties.dockIgnore){
                                                rePos(o, ii++, ll, obj, key, arg.$dockid, isWin||arg.width, isWin||arg.height, conDockSpacing.width, conDockSpacing.height, conDockStretch);
                                            }
                                        }
                                    }
                                }

                                if(obj.later){
                                    xui.each(obj.later, function(o){
                                        var profile;
                                        //for safari
                                        try{
                                            if(o.isSVG)
                                                o.ins._setBBox(o);
                                            else
                                                o.node.cssRegion(o, true);
                                            if(profile=xui.UIProfile.getFromDom(o.node.get(0))){
                                                delete o.node;
                                                // for no _onresize widget only
                                                if(!profile.box._onresize && profile.onResize && (o.width!==null||o.height!==null))
                                                    profile.boxing().onResize(profile,o.width,o.height);
                                                if(profile.onDock)profile.boxing().onDock(profile,o);
                                                if(profile.$onDock)profile.$onDock(profile,o);
                                            }
                                        }catch(e){
                                            xui.asyRun(function(){
                                                // destroyed
                                                if(!o.node)return;

                                                var ow=o.width,
                                                    oh=o.height;
                                                o.width=((parseFloat(o.width)||0)+1)+xui.CSS.$picku(o.width);
                                                o.height=((parseFloat(o.width)||0)+1)+xui.CSS.$picku(o.height);

                                                if(o.isSVG) o.ins._setBBox(o);
                                                else o.node.cssRegion(o);

                                                o.width=ow;o.height=oh;

                                                if(o.isSVG)o.ins._setBBox(o);
                                                else o.node.cssRegion(o, true);

                                                if(profile=xui.UIProfile.getFromDom(o.node.get(0))){
                                                    delete o.node;
                                                    // for no _onresize widget only
                                                    if(!profile.box._onresize && profile.onResize && (o.width!==null||o.height!==null))
                                                        profile.boxing().onResize(profile,o.width,o.height);
                                                    if(profile.onDock)profile.boxing().onDock(profile,o);
                                                    if(profile.$onDock)profile.$onDock(profile,o);
                                                }
                                            })
                                        }
                                    });
                                }
                                // for those are not in obj.later
                                for(k=0;key=arr[k++];){
                                    target = me[key];
                                    if(target.length){
                                        for(i=0;o=target[i++];){
                                            if(o.properties.position=='absolute' && !o.properties.dockIgnore){
                                                if(!obj.later || !obj.later[o.$xid]){
                                                    if(o.onDock)o.boxing().onDock(o);
                                                    if(o.$onDock)o.$onDock(o);
                                                }
                                            }
                                        }
                                    }
                                }

                                //if window resize, keep the timestamp
                                if(isWin)
                                    xui.$cache._resizeTime = xui.stamp();
                            }

                            me=rePos=node=style=null;
                        };
                        f.pid=pid;
                        xui.arr.each(xui.UI.$dock_args,function(key){
                            f[key]=[];
                        });
                        f.dockall=[];
                        f.rePos=function(profile, index, ll, obj, value, id, w, h, spaceW, spaceH, conDockStretch){
                            //if $dockid input, and not the specific node, return
                            var flag=false;
                            if(id && profile.$xid!=id)flag=true;
                            var prop = profile.properties,
                                css=xui.CSS,
                                flt=prop.dockFloat,
                                margin = prop.dockMargin,
                                stretch=prop.dockStretch,
                                sStart,sEnd,noStretch,pct,isCover,
                                tempW=0,tempH=0,
                                node = profile.getRoot(),
                                ins = profile.boxing(),
                                root = node.get(0),
                                style = root.style,
                                us = xui.$us(prop),
                                nodefz = node._getEmSize(),
                                adjustunit = function(v){return css.$forceu(v, us>0?'em':'px', nodefz)},
                                left, top, right, bottom,temp, other,
                                x = css.$px(prop._dockBorderWidth,nodefz) || 0,
                                y = css.$px(prop._dockBorderHeight,nodefz) || 0,
                                region={}, t,
                                isSVG=profile.box['xui.svg'],bbox;

                            // caculate with px
                            margin.top = css.$px(margin.top,nodefz);
                            margin.left = css.$px(margin.left,nodefz);
                            margin.right = css.$px(margin.right,nodefz);
                            margin.bottom = css.$px(margin.bottom,nodefz);

                            if(isSVG){
                                bbox=ins._getBBox();
                                prop.left=bbox.x;
                                prop.top=bbox.y;
                                prop.width=bbox.width;
                                prop.height=bbox.height;
                            }

                            if(style.display=='none')
                                return;
                            switch(value){
                                case 'middle':
                                case 'center':
                                    sStart = sEnd = 0;
                                    break;
                                default:
                                    // flow stretch can be copy from container
                                    stretch = stretch || ((value=="width"||value=="height")?"":conDockStretch[index % conDockStretch.length]) || "stretch";

                                    // width/height support 3 only:
                                    if(value=="width" || value=="height"){
                                        if(stretch!="stretch" && stretch!="forward" && stretch!="rearward"){
                                            stretch='stretch';
                                        }
                                    }
                                    switch(stretch){
                                        case 'stretch':
                                            sStart=1;
                                            sEnd=1;
                                            noStretch=0;
                                        break;
                                        case 'forward':
                                            sStart=1;
                                            sEnd=0;
                                            noStretch=0;
                                        break;
                                        case 'rearward':
                                            sStart=0;
                                            sEnd=1;
                                            noStretch=0;
                                        break;
                                        case 'fixed':
                                            noStretch=1;
                                        break;
                                        default:
                                            noStretch=1;
                                            pct = Math.min(1, Math.max(0, parseFloat(stretch)||0 ));
                                    }
                            }

                            isCover = prop.dock=='cover';
                            //top/bottom/left/right must be set by order first
                            switch(value){
                                case 'middle':
                                    //use height() is ok
                                    if(isSVG)
                                        ins.setTop(Math.max(0,(obj.height - bbox.height)/2));
                                    else
                                        node.top(adjustunit(Math.max(0,(obj.height - node.height())/2)));
                                    break;
                                case 'center':
                                    if(isSVG)
                                        ins.setLeft(Math.max(0,(obj.width - bbox.width)/2));
                                    else
                                        node.left(adjustunit(Math.max(0,(obj.width - node.width())/2)));
                                    break;
                                case 'top':
                                    if(!flag){
                                        if(noStretch){
                                            // calculate width
                                            temp =  pct ? (parseFloat(obj.ww*pct)||0)  : _adjust(isSVG ? bbox.width : css.$px(prop.width,nodefz)) + margin.left + margin.right;
                                            if(pct){
                                                temp -= spaceW;
                                                tempW = checkLimits(profile, prop, 'W', temp - margin.left - margin.right);
                                                temp = tempW + margin.left + margin.right;
                                            }

                                            // if overflow, wrap to new line
                                            if((obj.preX + temp - obj.oX) > obj.ww){
                                                // new line
                                                obj.top += obj.topHolder;
                                                obj.topHolder=0;
                                                obj.preX = obj.oX;

                                                applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');
                                            }

                                            obj.prevLine.push({
                                                profile:profile,
                                                prop:prop,
                                                node:node,
                                                style:style,
                                                isSVG:isSVG,
                                                ins:ins,
                                                pct:pct,
                                                margin:margin,
                                                region:{
                                                    top:obj.top + margin.top,
                                                    width:temp
                                                }
                                            });

                                            // keep for next calculation
                                            obj.preX += temp + spaceW;
                                            obj.topHolder = Math.max(obj.topHolder, (isSVG ? bbox.height : node.offsetHeight()) + margin.top + margin.bottom + spaceH);
                                        }else{
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');

                                            if(obj.topHolder){
                                                obj.top += obj.topHolder;
                                                obj.preX = obj.oX;
                                            }
                                            left = sStart ? ((flt?0:obj.left)+margin.left) : css.$px(prop.left,nodefz);
                                            right = sEnd ? ((flt?0:obj.right)+margin.right) : (obj.width-css.$px(prop.width,nodefz)-css.$px(prop.left,nodefz));
                                            top=(flt?0:obj.top)+margin.top;

                                            temp = checkLimits(profile, prop, 'W', obj.width - left - right - x);

                                            apply2Ctrl(profile, isSVG, ins, node, style, {
                                                left:left,
                                                top:top,
                                                width:_adjust(temp)
                                            });

                                            if(!flt)
                                                obj.top += (isSVG ? bbox.height : node.offsetHeight()) + margin.top + margin.bottom + spaceH;
                                        }
                                        // the last pct one
                                        if(ll==index+1){
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');
                                        }
                                    }
                                    break;
                                case 'bottom':
                                    if(!flag){
                                        if(noStretch){
                                            // calculate width
                                            temp =  pct ? (parseFloat(obj.ww*pct)||0)  : _adjust(isSVG ? bbox.width : css.$px(prop.width,nodefz)) + margin.left + margin.right;
                                            if(pct){
                                                temp -= spaceW;
                                                tempW = checkLimits(profile, prop, 'W', temp - margin.left - margin.right);
                                                temp = tempW + margin.left + margin.right;
                                            }

                                            // if overflow, wrap to new line
                                            if((obj.preX + temp - obj.oX) > obj.ww){
                                                // new line
                                                obj.bottom += obj.bottomHolder;
                                                obj.bottomHolder=0;
                                                obj.preX = obj.oX;

                                                applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');
                                            }

                                            obj.prevLine.push({
                                                profile:profile,
                                                prop:prop,
                                                node:node,
                                                style:style,
                                                isSVG:isSVG,
                                                ins:ins,
                                                pct:pct,
                                                margin:margin,
                                                region:{
                                                    bottom:obj.bottom + margin.bottom,
                                                    width:temp
                                                }
                                            });

                                            // keep for next calculation
                                            obj.preX += temp + spaceW;
                                            obj.bottomHolder = Math.max(obj.bottomHolder, (isSVG ? bbox.height : node.offsetHeight()) + margin.top + margin.bottom + spaceH);
                                        }
                                        else{
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');

                                            if(obj.bottomHolder){
                                                obj.bottom += obj.bottomHolder;
                                                obj.bottomHolder=0;
                                                obj.preX = obj.oX;
                                            }
                                            left=sStart?((flt?0:obj.left)+margin.left):css.$px(prop.left,nodefz);
                                            right=sEnd?((flt?0:obj.right)+margin.right):(obj.width-css.$px(prop.width,nodefz)-css.$px(prop.left,nodefz));
                                            bottom=(flt?0:obj.bottom)+margin.bottom;

                                            temp=checkLimits(profile, prop, 'W', obj.width - left - right);
 
                                            apply2Ctrl(profile, isSVG, ins, node, style, {
                                                left:left,
                                                bottom:bottom,
                                                width:_adjust(temp)
                                            });

                                            if(!flt)
                                                obj.bottom += (isSVG?bbox.height:node.offsetHeight()) + margin.top + margin.bottom + spaceH;
                                        }
                                        // the last pct one
                                        if(ll==index+1){
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.ww, 'width', 'dockMaxW', 'left', 'right');
                                        }
                                    }
                                    break;
                                case 'left':
                                    if(!flag){
                                        if(obj.topHolder){
                                            obj.top += obj.topHolder + spaceH;
                                            obj.topHolder=0;
                                            // reset preY
                                            obj.oY = obj.preY = obj.top;
                                        }
                                        if(obj.bottomHolder){
                                            obj.bottom += obj.bottomHolder + spaceH;
                                            obj.bottomHolder = 0;
                                        }
                                        // reset hh
                                        obj.hh = obj.height - obj.top - obj.bottom ;
                                        if(obj.hh<=0)return;

                                        if(noStretch){
                                            // calculate height
                                            temp =  pct ? (parseFloat(obj.hh*pct)||0)  : _adjust(isSVG ? bbox.height : css.$px(prop.height,nodefz)) + margin.top + margin.bottom;
                                            if(pct){
                                                temp -= spaceH;
                                                tempH = checkLimits(profile, prop, 'H', temp - margin.top - margin.bottom);
                                                temp = tempH + margin.top + margin.bottom;
                                            }

                                            // if overflow, wrap to new line
                                            if((obj.preY + temp - obj.oY) > obj.hh){
                                                // new line
                                                obj.left += obj.leftHolder;
                                                obj.leftHolder=0;
                                                obj.preY = obj.oY;

                                                applyPrevLine(obj, spaceH, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');
                                            }

                                            obj.prevLine.push({
                                                profile:profile,
                                                prop:prop,
                                                node:node,
                                                style:style,
                                                isSVG:isSVG,
                                                ins:ins,
                                                pct:pct,
                                                margin:margin,
                                                region:{
                                                    left:obj.left + margin.left,
                                                    height:temp
                                                }
                                            });

                                            // keep for next calculation
                                            obj.preY += temp + spaceH;
                                            obj.leftHolder = Math.max(obj.leftHolder, (isSVG ? bbox.width : node.offsetWidth()) + margin.left + margin.right + spaceW);
                                        }
                                        else{
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');

                                            if(obj.leftHolder){
                                                obj.left += obj.leftHolder;
                                                obj.leftHolder=0;
                                                obj.preY = obj.top;
                                            }

                                            left=(flt?0:obj.left)+margin.left;
                                            top=sStart?((flt?0:obj.top)+margin.top):css.$px(prop.top,nodefz);
                                            bottom=sEnd?((flt?0:obj.bottom)+margin.bottom):(obj.height-css.$px(prop.height,nodefz)-css.$px(prop.top,nodefz));

                                            temp=checkLimits(profile, prop, 'H', obj.height - top - bottom - y);

                                            apply2Ctrl(profile, isSVG, ins, node, style, {
                                                left:left,
                                                top:top,
                                                height:_adjust(temp)
                                            });

                                            if(!flt)
                                                obj.left += (isSVG?bbox.width:node.offsetWidth()) + margin.left + margin.right + spaceW;
                                        }
                                        // the last pct one
                                        if(ll==index+1){
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');
                                        }
                                    }
                                    break;
                                case 'right':
                                    //if no top/bottom and change w only
                                    if(!flag){
                                        if(obj.topHolder){
                                            obj.top += obj.topHolder;
                                            obj.topHolder=0;
                                            // reset preY
                                            obj.oY = obj.preY = obj.top;
                                        }
                                        if(obj.bottomHolder){
                                            obj.bottom += obj.bottomHolder;
                                            obj.bottomHolder = 0;
                                        }
                                        // reset hh
                                        obj.hh = obj.height - obj.top - obj.bottom ;

                                        if(obj.hh<=0)return;

                                        if(noStretch){
                                            // calculate height
                                            temp =  pct ? (parseFloat(obj.hh*pct)||0)  : _adjust(isSVG ? bbox.height : css.$px(prop.height,nodefz)) + margin.top + margin.bottom;
                                            if(pct){
                                                temp -= spaceH;
                                                tempH = checkLimits(profile, prop, 'H', temp - margin.top - margin.bottom);
                                                temp = tempH + margin.top + margin.bottom;
                                            }

                                            // if overflow, wrap to new line
                                            if((obj.preY + temp - obj.oY) > obj.hh){
                                                // new line
                                                obj.right += obj.rightHolder;
                                                obj.rightHolder=0;
                                                obj.preY = obj.oY;

                                                applyPrevLine(obj, spaceH, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');
                                            }

                                            obj.prevLine.push({
                                                profile:profile,
                                                prop:prop,
                                                node:node,
                                                style:style,
                                                isSVG:isSVG,
                                                ins:ins,
                                                pct:pct,
                                                margin:margin,
                                                region:{
                                                    right:obj.right + margin.right,
                                                    height:temp
                                                }
                                            });

                                            // keep for next calculation
                                            obj.preY += temp + spaceH;
                                            obj.rightHolder = Math.max(obj.rightHolder, (isSVG ? bbox.width : node.offsetWidth()) + margin.left + margin.right + spaceW);
                                        }
                                        else{
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');

                                            if(obj.rightHolder){
                                                obj.right += obj.rightHolder;
                                                obj.rightHolder=0;
                                                obj.preY = obj.top;
                                            }

                                            right=(flt?0:obj.right)+margin.right;
                                            top=sStart?((flt?0:obj.top)+margin.top):(css.$px(prop.top,nodefz));
                                            bottom=sEnd?((flt?0:obj.bottom)+margin.bottom):(obj.height-css.$px(prop.height,nodefz)-css.$px(prop.top,nodefz));

                                            temp=checkLimits(profile, prop, 'H', obj.height - top - bottom - y);

                                            apply2Ctrl(profile, isSVG, ins, node, style, {
                                                right:right,
                                                top:top,
                                                height:_adjust(temp)
                                            });

                                            if(!flt)
                                                obj.right += (isSVG?bbox.width:node.offsetWidth()) + margin.left + margin.right + spaceW;
                                        }
                                        // the last pct one
                                        if(ll==index+1){
                                            // new line
                                            applyPrevLine(obj, spaceW, obj.hh, 'height', 'dockMaxH', 'top', 'bottom');
                                        }
                                    }
                                    break;
                                case 'width':
                                    //if no top/bottom/left/right and change h only
                                    if(!w)return;
                                    if(obj.leftHolder){
                                        obj.left += obj.leftHolder;
                                        obj.leftHolder=0;
                                    }
                                    if(obj.rightHolder){
                                        obj.right += obj.rightHolder;
                                        obj.rightHolder=0;
                                    }

                                    left = sStart?((isCover?0:(flt?0:obj.left)) + margin.left):css.$px(prop.left,nodefz);
                                    right = sEnd?((isCover?0:(flt?0:obj.right))  + margin.right):(obj.width-css.$px(prop.width,nodefz)-css.$px(prop.left,nodefz));
                                    top = prop.dock=='width'?(css.$px(prop.top,nodefz) || 0):(sStart?((isCover?0:(flt?0:obj.top)) + margin.top):css.$px(prop.top,nodefz));
                                    //later call for w/h change once
                                    temp=checkLimits(profile, prop, 'W', obj.width - left - right - x);

                                    obj.later=obj.later||{};
                                    obj.later[profile.$xid] = obj.later[profile.$xid] || {};
                                    xui.merge(obj.later[profile.$xid],{
                                        isSVG:isSVG,
                                        ins:ins,
                                        node:node,
                                        width: adjustunit(temp),
                                        left: adjustunit(left),
                                        top: adjustunit(top)
                                    },'all');
                                    break;
                                case 'height':
                                    //if no top/bottom/left/right and change w only
                                    if(!h)return;
                                    if(obj.topHolder){
                                        obj.top += obj.topHolder;
                                        obj.topHolder=0;
                                        obj.preX = obj.oX;
                                    }
                                    if(obj.bottomHolder){
                                        obj.bottom += obj.bottomHolder;
                                        obj.bottomHolder=0;
                                        obj.preX = obj.oX;
                                    }

                                    top = sStart?((isCover?0:(flt?0:obj.top)) + margin.top):css.$px(prop.top,nodefz);
                                    bottom = sEnd?((isCover?0:(flt?0:obj.bottom))  + margin.bottom):(obj.height-css.$px(prop.height,nodefz)-css.$px(prop.top,nodefz));
                                    left = prop.dock=='height'?(css.$px(prop.left,nodefz) || 0):(sStart?((isCover?0:(flt?0:obj.left)) + margin.left):css.$px(prop.left,nodefz));
                                    
                                    //later call for w/h change once
                                    temp=checkLimits(profile, prop, 'H', obj.height - top - bottom - y);

                                    obj.later=obj.later||{};
                                    obj.later[profile.$xid] = obj.later[profile.$xid] || {};
                                    xui.merge(obj.later[profile.$xid],{
                                        isSVG:isSVG,
                                        ins:ins,
                                        node:node,
                                        height: adjustunit(temp),
                                        left: adjustunit(left),
                                        top: adjustunit(top)
                                    },'all');

                                    break;
                            }
                        };

                        //add handler to window or node
                        p.onSize(f,'dock');
                    }
                    //set link to node
                    if(value=='fill' || value=='cover'){
                        profile.link(f.height, '$dock1',null,i3);
                        profile.link(f.width, '$dock2',null,i4);
                        xui.arr.stableSort(f.height,order);
                        xui.arr.stableSort(f.width,order);
                    }else if(value=='origin'){
                        profile.link(f.center, '$dock1',null,i3);
                        profile.link(f.middle, '$dock2',null,i4);
                    }else{
                        profile.link(f[value], '$dock',null,i2);
                        xui.arr.stableSort(f[value],order);
                    }
                    profile.link(f.dockall, '$dockall',null,i1);

                    //
                    xui.$cache._resizeTime=1;

                    //set shortuct
                    profile.$dockFun=f;
                }

                // adjust dock parent's overflow
                adjustOverflow(p, isWin);

                if(value != 'none'){
                    (profile.$beforeDestroy=(profile.$beforeDestroy||{}))["releaseDock"]=function(){
                        profile.unLink('$dockall');
                        profile.unLink('$dock');
                        profile.unLink('$dock1');
                        profile.unLink('$dock2');
                        adjustOverflow(p,isWin);
                        
                        if( p && p.get(0) && (p=xui.UIProfile.getFromDom(p.id())) ){
                            // affect dock parent
                            p.boxing().adjustDock();
                            xui.tryF(p.clearCache,[],p);
                        }
                        profile=p=null;
                    }
                }else{
                    if(profile.$beforeDestroy)
                         delete profile.$beforeDestroy["releaseDock"];
                }

            }

            //run once now
            if(trigger)
                p.onSize();
        },

        _beforeSerialized:function(profile){
            var b,t,r,o={};
            xui.merge(o, profile, 'all');
            var p = o.properties = xui.clone(profile.properties,true),
                ds = o.box.$DataStruct, t,
                dm = o.box.$DataModel;

            for(var i in xui.UI.$ps){
                if((i in p) && p[i]==='')p[i]='auto';
            }

            // *** force to rem/px
            for(var i in dm){
                if(dm[i].ini===p[i]) delete p[i];
                else if(dm[i] && dm[i]['$spaceunit']){
                    if( (dm[i].ini===0||dm[i].ini==='0'||dm[i].ini==='0px'||dm[i].ini==='0em')
                        && (p[i]===0||p[i]==='0'||p[i]==='0px'||p[i]==='0em') ) delete p[i];
                    else if( (dm[i].ini + (xui.isFinite(dm[i].ini)?'px':'')) == (p[i] + (xui.isFinite(p[i])?'px':'')) ) delete p[i];
                    else if(p[i] != 'auto'){
                        t=xui.$us(p);
                        p[i]=profile.$forceu(p[i],t==2?'em':t==-2?'px':null);
                    }
                }
            }
            if(p.position=='absolute'){
                switch(p.dock){
                    case 'top':
                    case 'bottom':
                        delete delete p.top;delete p.bottom;delete p.right;
                        break;
                    case 'left':
                    case 'right':
                        delete p.left;delete p.right;delete p.bottom;
                        break;
                }
            }
            for(var i in xui.UI.$ps){
                if((i in p) && xui.isNaN(p[i]))delete p[i];
            }

            if(p.items && p.items.length){
                t=xui.absObj.$specialChars;
                p.items = xui.clone(p.items,function(o,i,d){
                    return !t[((d===1?o.id:i)+'').charAt(0)] && o!=undefined;
                });
            }
            if(p.tagCmds && p.tagCmds.length){
                t=xui.absObj.$specialChars;
                p.tagCmds = xui.clone(p.tagCmds,function(o,i,d){
                    return !t[((d===1?o.id:i)+'').charAt(0)] && o!=undefined;
                });
            }
            // for empty object
            for(var i in profile.box._objectProp)
                if((i in p) && p[i] && (xui.isHash(p[i])||xui.isArr(p[i])) && xui.isEmpty(p[i]))delete p[i];
            // special for tagVar
            var i='tagVar';
            if((i in p) && p[i] && (xui.isHash(p[i])||xui.isArr(p[i])) && xui.isEmpty(p[i]))delete p[i];

            xui.arr.each(["dockMargin","conDockPadding","conDockSpacing","sandboxTheme","propBinder"],function(key){
                if(t=p[key]){
                    if(!xui.isHash(t)){
                        return;
                    }
                    r=ds[key];
                    for(var i in t){
                        if(r[i]!==t[i]){
                            return;
                        }
                    }
                    delete p[key];
                }
            });

            if(xui.isEmpty(p.resizerProp))
                delete p.resizerProp;
            if(p.items&&(p.items.length==0||p.listKey))
                delete p.items;
            if(p.tagCmds&&(p.tagCmds.length==0||p.listKey))
                delete p.tagCmds;

            return o;
        },
        getDropKeys:function(profile,node){
            return profile.properties.dropKeys;
        },
        getDragKey:function(profile,node){
            return profile.properties.dragKey || (profile.properites.dragSortable&&(profile.key+":"+profile.$xid));
        },
        getDragData:function(profile,event,node){
            return {
                profile:profile,
                domId:xui.use(node).id(),
                data: profile.onGetDragData ? profile.boxing().onGetDragData(profile,event,node) : null
            };
        },
        _prepareData:function(profile, data){
            var prop = profile.properties,
                dm = this.$DataModel,
                me = arguments.callee,
                map = me.map || (me.map=xui.toArr('left,top,bottom,right,width,height')),
                a=[],
                box=profile.box,
                ajd=profile.box.adjustData,
                t;
            data = data||{};
            //can't input id in properties
            if(prop.id)delete prop.id;

            if('required' in dm)
                prop._required=prop.required?"xui-required":"";

            // cant null
            if('nodeName' in dm && !prop.nodeName)
                prop.nodeName="xui";

            //give default caption
            if('caption' in dm && prop.caption!==null)
                prop.caption = prop.caption===undefined ? profile.alias : prop.caption;

            if('html' in dm && prop.html)
                data.html = xui.adjustRes(prop.html,0,1);
            if('src' in dm && prop.src)
                data.src = xui.adjustRes(prop.src,0,1);

            // *** force to em
             xui.each(prop,function(o,i){
                if(dm[i] && dm[i]['$spaceunit']){
                    if(xui.$us(prop)>0)
                        if(prop[i]===0||prop[i]=='0')prop[i]='0em';
                    else
                        if(prop[i]===0||prop[i]=='0')prop[i]='0px';
                }
             });

            //give border width
            if('$hborder' in dm && dm.$hborder){
                if(profile.$isEm(prop.width)){
                    data.bWidth = profile.$px2em( profile.$em2px(prop.width) - prop.$hborder*2 ,null, true) + 'em';
                }else{
                    data.bWidth = (parseFloat(prop.width)||0) - prop.$hborder*2;
                }
            }
            if('$vborder' in dm && dm.$vborder){
                if(profile.$isEm(prop.height)){
                    data.bHeight = profile.$px2em( profile.$em2px(prop.height) - prop.$vborder*2 ,null,true) + 'em';
                }else{
                    data.bHeight = (parseFloat(prop.height)||0) - prop.$vborder*2;
                }
            }
            //set left,top,bottom,right,width,height
            for(var j=0,i;i=map[j];j++){
                var t=(i in data)?data[i]:prop[i];
                if(t || t===0){
                    if(t!='auto')a[a.length]=i+':'+profile.$addu(t);
                }
            }
            // position,z-index,visibility,display
            if(prop.position)a[a.length] = 'position:'+prop.position;
            if(prop.visibility)a[a.length]= 'visibility:'+prop.visibility;
            if('zIndex' in prop)a[a.length]= 'z-index:'+prop.zIndex;
            if(prop.display)a[a.length]= prop.display=='inline-block'? ('display:' + xui.$inlineBlock.join('; display:') + ';') :('display:' + prop.display);

           data._style = a.join(';') + ';';
           if(box.$Behaviors.PanelKeys && !box["xui.absList"]){
                a=[];
                if(prop.panelBgClr)a[a.length] = 'background-color:'+prop.panelBgClr;
                if(prop.panelBgImg)a[a.length] = 'background-image:url('+xui.adjustRes(prop.panelBgImg)+')';
                if(prop.panelBgImgPos)a[a.length] = 'background-position:'+prop.panelBgImgPos;
                if(prop.panelBgImgRepeat)a[a.length] = 'background-repeat:'+prop.panelBgImgRepeat;
                if(prop.panelBgImgAttachment)a[a.length] = 'background-attachment:'+prop.panelBgImgAttachment;
                data._panelstyle=a.join(';');
            }

            if('className' in dm)
                data._className=prop.className||"";

            if('readonly' in dm)data.readonly=prop.readonly?"xui-ui-readonly":"";
            if('href' in dm)data.href = prop.href || xui.$DEFAULTHREF;
            if('tabindex' in dm)data.tabindex = prop.tabindex || '-1';
            if('items' in dm){
                profile.ItemIdMapSubSerialId = {};
                profile.SubSerialIdMapItem = {};

                prop.items=profile.box._adjustItems(prop.items);
                data.items = this._prepareItems(profile, prop.items);
            }

            if('selectable' in dm)
                data._selectable=(xui.browser.ie && xui.browser.ver<10)
                    ? ""
                    : (prop.selectable?"xui-ui-selectable":"xui-ui-unselectable");

            //default prepare
            data =  ajd(profile, prop, data);

            profile.prepared=true;
            return data;
        },
        _prepareInlineObj:function(profile, item, tabindex){
            var obj=item.object;
            obj=obj['xui.absBox']?obj.get(0):obj['xui.UIProfile']?obj:xui.create(obj).get(0);
            if(obj.destroyed)return null;
            if(obj['xui.UIProfile']){
                obj.properties.position='relative';
                if('tabindex' in obj.properties)obj.properties.tabindex=tabindex;
                var addcls='xui-inline-object', cck = obj.CC.KEY || (cck=obj.CC.KEY='');
                if(cck.indexOf(addcls)===-1) obj.CC.KEY = cck + " " + addcls;
            }
            item.$xid=obj.$xid;
            item.$inlineobj=obj;
            obj.$conf=item;
            obj.$holder=profile;
            if(obj.alias && (!obj.host||obj.host===obj))obj.boxing().setHost(profile.host,obj.alias);
            (profile.$attached||(profile.$attached=[])).push(obj);
            return obj;
        },
        _prepareItems:function(profile, items, pid, mapCache, serialId){
            var ns=this,
                result=[],
                item,dataItem,t,
                SubID=xui.UI.$tag_subId,id ,
                tabindex = profile.properties.tabindex,
                ajd=profile.box.adjustData,
                itemFilter=profile.$itemFilter;
            if(itemFilter)itemFilter('begin','prepareItem',profile);

            //set map
            for(var i=0,l=items.length;i<l;i++){
                if(xui.isHash(items[i])){}
                else if(xui.isArr(items[i])){
                    items[i]={id:items[i][0]};
                    if(items.length>1)items[i].caption=items[i][1];
                }else{
                    items[i]={id:items[i]};
                }

                if(items[i].id==='?')items[i].id = xui.rand();
                
                item = items[i];

                if(profile.beforePrepareItem && false===profile.boxing().beforePrepareItem(profile, item, pid, mapCache, serialId)){
                    continue;
                }

                if(!item.hasOwnProperty('caption'))item.caption=item.id;

                dataItem={id: item.id};
                if(pid)dataItem._pid = pid;

                id=dataItem[SubID]=typeof serialId=='string'?serialId:profile.pickSubId('items');

                if(false!==mapCache){
                    profile.ItemIdMapSubSerialId[item.id] = id;
                    profile.SubSerialIdMapItem[id] = item;
                }
                if(item.object){
                    dataItem.object = ns._prepareInlineObj(profile, item, tabindex);
                }else{
                    dataItem._tabindex=tabindex;

                    //others
                    ajd(profile, item, dataItem, 'sub');
                    if(ns._prepareItem)
                        ns._prepareItem(profile, dataItem, item, pid, i,l,mapCache, serialId);
                }
                result.push(dataItem);
            }

            if(itemFilter)itemFilter('end','prepareItem',profile);
            return result;
        },
        _showTips:function(profile, node, pos){
            if(profile.properties.disableTips)return;
            if(profile.onShowTips)
                return profile.boxing().onShowTips(profile, node, pos);
        }
    }
});

//absList Class
xui.Class("xui.absList", "xui.absObj",{
    Instance:{
        activate:function(){
            var profile = this.get(0),
                items = profile.getSubNode('ITEM',true);
            if(!items.isEmpty())
                items.focus(true);
            return this;
        },
        /*
        [x] ,valid id   ,true  => insert [x] before node
        [x] ,valid id   ,false => insert [x ]after node
        [x] ,null ,true  => insert [x ] to head
        [x] ,null ,false => insert [x ] to tail
        */
        insertItems:function(arr, base/*true: the current item*/, before, all){
            var node,arr2,
                items, index, r, v, prop,
                data,box,
                ns=this,
                b=ns._afterInsertItems;
            return this.each(function(profile){
                box=profile.box;
                arr2=box._adjustItems(arr);
                prop = profile.properties;

                if(base===true){
                        v=prop.$UIvalue||prop.value;
                        if(v)v=(v+'').split(prop.valueSeparator);
                        k=profile.getItemByItemId(v[0]);
                        base=k?k.id:null;
                }

                items = profile.properties.items;
                index = xui.arr.subIndexOf(items,'id',base);

                //if in dom, create it now
                if(profile.renderId){
                    // prepare properties format
                    data = box._prepareItems(profile, arr2);

                    r=profile._buildItems('items', data);

                    // try to render inner xui.UI
                    if(profile.$attached){
                        for(var i=0,v;v=profile.$attached[i++];){
                            if(v._render)v._render(true);
                        }
                        delete profile.$attached;
                    }

                    if(index==-1){
                        //if no base specified
                        node = profile.getSubNode(box._ITEMSKEY || profile.keys.ITEMS || profile.keys.KEY);
                        //items.length==1 for that one have fake item(for example: editable poll)
                        if(before)
                            node.prepend(r);
                        else
                            node.append(r);
                    }else{
                        node=profile.getSubNodeByItemId(box._ITEMKEY || 'ITEM', base);
                        if(before)
                            node.addPrev(r);
                        else
                            node.addNext(r);
                    }
                }

                //must be here
                if(index==-1){
                    xui.arr.insertAny(items,arr2, before?0:-1);
                }else
                    xui.arr.insertAny(items,arr2, before?index:index+1);

                if(b)
                    profile.boxing()._afterInsertItems(profile, data, base, before);

                // try to hide ui-no-children node
                // logic must same to doFilter
                if(profile.$itemFilter){
                    var hideItems=[];
                    xui.arr.each(arr,function(item){
                       if(item.sub && !item.hidden){
                        //  if(!item._checked && item.id)
                        //      ns.toggleNode(item.id, true, false, true);
                           if(true!==profile.$itemFilter(item,'checkSub',profile)){
                                var flag;
                                for(var i=0,l=item.sub.length;i<l;i++){
                                   if( !item.sub[i].hidden){
                                       flag=1;break;
                                   }
                               }
                               if(!flag)hideItems.push(item.id);
                           }else{
                               hideItems.push(item.id);
                           }
                       }
                    });
                    if(hideItems.length)ns.showItems(hideItems,false);
                }
            });
        },
        removeItems:function(arr/*default is the current*/, key, purgeNow){
            var obj,v,
                b=this._afterRemoveItems;
                remove=function(profile, arr, target, data, ns, force){
                    var self=arguments.callee;
                    if(!ns)ns=xui();
                    xui.filter(arr,function(o){
                        var serialId,b;
                        if(force || (b=(xui.arr.indexOf(target,o.id)!=-1))){
                            if(profile.renderId){
                                if(serialId=profile.ItemIdMapSubSerialId[o.id]){
                                    data.push(xui.copy(profile.SubSerialIdMapItem[serialId]));
                                    // clear maps
                                    delete profile.SubSerialIdMapItem[serialId];
                                    delete profile.ItemIdMapSubSerialId[o.id];
                                    profile.reclaimSubId(serialId, 'items');

                                    //parent node is deleted
                                    if(!force){
                                        if(!(obj = profile.getSubNode(profile.keys[key]?key:(profile.box._ITEMKEY||'ITEM'), serialId) ).isEmpty() )
                                            ns.merge(obj);
                                        //for inner template or xui.UI
                                        if(o.$xid)ns.get().push(xui.getObject(o.$xid).getRootNode());
                                    }
                                }
                            }
                        }
                        //check sub
                        if(o.sub)self(profile, o.sub,target,  data, ns, force || b);
                        //filter it
                        if(b){
                            for(var i in o)o[i]=null;
                            return false;
                        }
                    });
                    ns.remove(true, purgeNow);
                };
            return this.each(function(profile){
                var p=profile.properties,data=[];
                 arr = xui.isHash(arr)?[arr.id]:xui.isArr(arr)?arr:arr===0?[0]:arr?(arr+"").split(p.valueSeparator):null;
                if(!arr)arr=((p.$UIvalue||p.value)+"").split(p.valueSeparator);
                xui.arr.each(arr,function(o,i){
                    arr[i]='' + (xui.isNumb(o)?p.items&&p.items[o].id:xui.isHash(o)?o.id:o)
                });
                // clear properties
                remove(profile, p.items, arr, data);
                // clear value
                if(v=p.$UIvalue){
                    if((v=(''+v).split(p.valueSeparator)).length>1){
                        xui.filter(v,function(o){
                            return xui.arr.indexOf(arr,o)==-1;
                        });
                        p.$UIvalue=v.join(p.valueSeparator);
                    }else{
                        if(xui.arr.indexOf(arr,p.$UIvalue)!=-1)
                            p.$UIvalue=null;
                    }
                }
                if(b && profile.renderId)
                    profile.boxing()._afterRemoveItems(profile, data);
            });
        },
        clearItems:function(purgeNow){
            return this.each(function(profile){
                var prop=profile.properties;
                if(profile.SubSerialIdMapItem){
                    //empty dom
                    if(profile.renderId){
                        profile.getSubNode(profile.keys[profile.box._ITEMKEY||'ITEM'], true).remove(true, purgeNow);
                    }
                    //save subid
                    xui.each(profile.SubSerialIdMapItem, function(o,serialId){
                        profile.reclaimSubId(serialId, 'items');
                    });
                    //clear cache
                    profile.SubSerialIdMapItem={};
                    profile.ItemIdMapSubSerialId={};
                }

                //delete items
                prop.items.length=0;
                prop.$UIvalue=null;
                //keep the value
                //prop.value=null;
            });
        },
        updateItem:function(itemId/*default is the current*/,options){
            var self=this,
                profile=self.get(0), v, 
                prop=profile.properties;

            itemId=xui.isHash(itemId)?itemId.id:itemId===0?0:itemId?(itemId+''):null;
            if(xui.isNumb(itemId))itemId=xui.get(prop.items,[itemId,"id"]);
            if(!itemId){
                v=prop.$UIvalue||prop.value;
                if(v)v=(v+'').split(prop.valueSeparator);
                v=profile.getItemByItemId(v[0]);
                itemId=v?v.id:null;
            }
            var box=profile.box,
                items=prop.items,
                rst=profile.queryItems(items,function(o){return typeof o=='object'?o.id===itemId:o==itemId},true,true,true),
                nid,item,serialId,arr,node,oldsub,t;
            if(!xui.isHash(options))options={caption:options+''};

            if(rst && rst.length){
                rst=rst[0];
                if(typeof rst[0]!='object')
                    item=rst[2][rst[1]]={id:rst[0]};
                else
                    item=rst[0];

                // [[modify id
                if(xui.isSet(options.id))options.id+="";
                if(options.id && itemId!==options.id){
                    nid=options.id;
                    var m2=profile.ItemIdMapSubSerialId, v;
                    if(!m2[nid]){
                        if(v=m2[itemId]){
                            m2[nid]=v;
                            delete m2[itemId];
                            profile.SubSerialIdMapItem[v].id=nid;
                        }else{
                            item.id=nid;
                        }
                    }
                }
                delete options.id;
                // modify id only
                if(xui.isEmpty(options))
                    return self;
                //]]

                //in dom already?
                node=profile.getSubNodeByItemId('ITEM',nid || itemId);
                if(!node.isEmpty()){
                    //for the sub node
                    if('sub' in options){
                        delete item._created;
                        delete item._checked;
                        delete item._inited;

                        // destroy all sub dom
                        if(item.sub){
                            var sub=[];
                            xui.arr.each(item.sub,function(o){
                                sub.push(o.id);
                            });
                            self.removeItems(sub);
                        }
                    }
                    // keep sub nodes
                    else if(item.sub){
                        oldsub=profile.getSubNodeByItemId('SUB',nid || itemId);
                    }

                    //merge options
                    xui.merge(item, options, 'all');
                    //prepared already?
                    serialId=xui.get(profile,['ItemIdMapSubSerialId',nid || itemId]);
                    arr=box._prepareItems(profile, [item],item._pid,false, serialId);
                    node.replace(profile._buildItems(arguments[2]||'items', arr),false);

                    // restore sub nodes
                    if(oldsub && !oldsub.isEmpty()){
                        if(!(t=profile.getSubNodeByItemId('SUB',nid || itemId)).isEmpty())
                            t.replace(oldsub);
                    }
                    if(typeof self.setUIValue=='function'){
                        var uiv=prop.$UIvalue||"", arr=(''+uiv).split(prop.valueSeparator);
                        if(arr.length && xui.arr.indexOf(arr, itemId)!=-1){
                            if(nid){
                                xui.arr.removeValue(arr,itemId);
                                arr.push(item.id);
                                // id changed
                                self.setUIValue(arr.join(prop.valueSeparator), true,null,'update');
                            }else{
                                // id didn't change, but item refreshed
                                self._setCtrlValue(uiv)
                            }
                        }
                    }
                }else{
                    //merge options
                    xui.merge(item, options, 'all');
                }

                if(box.$Behaviors.PanelKeys){
                    var hash={};
                    if(options.hasOwnProperty('panelBgClr'))hash["background-color"]=options.panelBgClr;
                    if(options.hasOwnProperty('panelBgImg')){
                        hash["background-image"]=options.panelBgImg?("url("+xui.adjustRes(options.panelBgImg)+")"):"";
                    }
                    if(options.hasOwnProperty('panelBgImgPos'))hash["position-color"]=options.panelBgImgPos;
                    if(options.hasOwnProperty('panelBgImgRepeat'))hash["background-repeat"]=options.panelBgImgRepeat;
                    if(options.hasOwnProperty('panelBgImgAttachment'))hash["background-attachment"]=options.panelBgImgAttachment;
                    if(options.hasOwnProperty('overflow')){
                        var v=options.overflow;
                        if(v){
                            if(v.indexOf(':')!=-1){
                                xui.arr.each(v.split(/\s*;\s*/g),function(s){
                                    var a=s.split(/\s*:\s*/g);
                                    if(a.length>1){
                                        hash[xui.str.trim(a[0])]=xui.str.trim(a[1]||'');
                                    }
                                });
                            }
                        }
                        hash.overflow=v||"";
                    }
                    if(!xui.isEmpty(hash)){
                        xui.arr.each(box.$Behaviors.PanelKeys,function(k){
                            panel=profile.getSubNode(k,nid || itemId).css(hash);
                        });
                    }
                }
            }
            return self;
        },
        // filter: [true] => filter out
        doFilter:function(itemFilter, helper, reLayout){
            var ns=this,
                profile=ns.get(0);
            if(profile){
                if(!itemFilter){
                    delete profile.$itemFilter;
                    itemFilter=function(){return false};
                }else if(xui.isFun(itemFilter)){
                    profile.$itemFilter=itemFilter;
                }else if(itemFilter===true){
                    itemFilter=profile.$itemFilter;
                }
                xui.resetRun(profile.$xid+':itemFilter',function(){
                    itemFilter('begin','doFilter',profile)

                    var prop=profile.properties,
                        items=prop['rows']||prop['items'],
                        showItems=[],
                        hideItems=[],
                        f1=function(items, showItems, hideItems){
                            var count=0,rtn;
                            xui.arr.each(items,function(item){
                                if(item.sub){
                                    // check parent node first
                                    if(true===itemFilter(item, helper, profile)){
                                        count++;
                                        if(item.hidden)showItems.push(item.id);
                                    }else{
                                        // ensure open all tree nodes
                                        //if(!item._checked && item.id)
                                        //    (ns['toggleRow']||ns['toggleNode']).call(ns, item.id, true, false, true);
                                        // check sub showed count next
                                        if(f1(item.sub, showItems, hideItems)){
                                            count++;
                                            if(item.hidden)showItems.push(item.id);
                                        }else{
                                            if(!item.hidden)hideItems.push(item.id);
                                        }
                                    }                                       
                                }else{
                                    if(itemFilter(item, helper, profile)){
                                        if(!item.hidden)hideItems.push(item.id);
                                    }else{
                                        count++;
                                        if(item.hidden)showItems.push(item.id);
                                    }
                                }
                            });
                            return count;
                        };
                    f1(items, showItems, hideItems);
                    itemFilter('end','doFilter',profile)

                    // reflect to dom 
                    if(showItems.length)(ns['showRows']||ns['showItems']).call(ns,showItems);
                    if(hideItems.length)(ns['showRows']||ns['showItems']).call(ns,hideItems,false);
                    if(reLayout!==false)ns.reLayout(true);
                });
            }
            return this;
        },
        showItems:function(itemId,/*default is the current*/ show){
           var ns=this,
                profile = ns.get(0), 
                showNodes=xui(),
                hideNodes=xui(),
                prop = profile.properties;
            itemId = xui.isHash(itemId) ? itemId.id : xui.isArr(itemId) ? itemId : itemId===0 ? [0] : itemId ? (itemId+"").split(prop.valueSeparator):null;
            if(!itemId)itemId=((prop.$UIvalue||prop.value)+"").split(prop.valueSeparator);
            if(itemId&&itemId.length){
                xui.arr.each(itemId, function(r, item){
                    if(item=ns.getItemByItemId(r)){
                        if(show===false){
                            if(!item.hidden)hideNodes.merge(ns.getSubNodeByItemId('ITEM',item.id));
                        }else{
                            if(item.hidden)showNodes.merge(ns.getSubNodeByItemId('ITEM',item.id));
                        }
                        item.hidden=show===false;
                    }
                });
            }
            // reflect to dom 
            if(!showNodes.isEmpty())showNodes.css('display','');
            if(!hideNodes.isEmpty())hideNodes.css('display','none');
            return this;
        },
        getItems:function(type, v){
            v=v||this.get(0).properties.items;
            if(type=='data')
                return xui.clone(v,true);
            else if(type=='min'){
                var a=xui.clone(v,true),b;
                xui.arr.each(a,function(o,i){
                    a[i]=o.id;
                });
                return a;
            }else
                return v;
        },
        focusItem:function(itemId){
            this.getSubNodeByItemId(this.constructor._focusNodeKey, itemId).focus(true);
            return this;
        },
        scrollIntoView:function(itemId){
            itemId=this.getSubNodeByItemId(this.constructor._focusNodeKey, itemId);
            if(itemId=itemId.get(0))itemId.scrollIntoView();
            return this;
        },
        selectItem:function(itemId){
            return this.fireItemClickEvent(itemId);
        },
        fireItemClickEvent:function(itemId){
            this.getSubNodeByItemId(this.constructor._focusNodeKey, itemId).onClick();
            return this;
        },
        editItem:function(itemId/*default is the current*/){
            var profile=this.get(0),
                prop=profile.properties,
                item,source,v;
            if(profile&&profile.renderId&&!profile.destroyed){
                itemId=xui.isHash(itemId)?itemId.id:itemId===0?0:itemId?(itemId+''):null;
                if(xui.isNumb(itemId))itemId=xui.get(prop.items,[itemId,"id"]);
                if(!itemId){
                    v=prop.$UIvalue||prop.value;
                    if(v)v=(v+'').split(prop.valueSeparator);
                    v=profile.getItemByItemId(v[0]);
                    itemId=v?v.id:null;
                }
                if(itemId){
                    if(item=profile.getItemByItemId(itemId)){
                        source = profile.getSubNodeByItemId('ITEMCAPTION',itemId);
                        if(source.isEmpty())source = profile.getSubNodeByItemId('CAPTION',itemId);
                        if(!source.isEmpty()){
                            var pp=source.parent(),
                            cb=xui.browser.contentBox,
                            pos = source.offset(null,pp.get(0)),
                            size = source.cssSize(),
                            pos2 = pp.offset(),
                            size2 = pp.cssSize();

                            // adjust
                            pos2.left += !cb?0:source._paddingW('left');
                            pos2.top += !cb?0:source._paddingH('top');
                            size2.height += !cb?0:source._paddingH();

                            var editor;
                            if(profile.beforeIniEditor){
                                editor=profile.boxing().beforeIniEditor(profile, item, source);
                                if(editor===false)
                                    return;
                            }

                            if(!editor || !editor['xui.UI']){
                                var editor=new xui.UI.ComboInput({type:"input"});
                                editor.setWidth(Math.max(size2.width-pos.left,40))
                                    .setHeight(Math.max(size2.height, 20))
                                    .setResizer(true)
                                    .setValue(item.caption||"");
                                if(profile.onBeginEdit)profile.boxing().onBeginEdit(profile,item,editor);
                                var undo=function(){
                                    // ays is a must
                                    xui.resetRun('absList_editor_reset', function(){
                                        if(editor&&!editor.isDestroyed()){
                                            editor.getRoot().setBlurTrigger("absList_editor_blur",null);
                                            editor.destroy();
                                            editor=null;
                                        }
                                    });
                                };
                                editor.beforeUIValueSet(function(prf, ov, nv, force, tag){
                                    if(false!==(profile.beforeEditApply&&profile.boxing().beforeEditApply(profile, item, nv, editor, tag))){
                                        profile.boxing().updateItem(item.id, {caption:nv});
                                        if(profile.onEndEdit)profile.boxing().onEndEdit(profile,item,editor);
                                        undo();
                                    }
                                }).onCancel(function(){
                                    undo();
                                });
                                xui('body').append(editor);
                                var root=editor.getRoot();

                                root.popToTop({
                                    left:pos.left+pos2.left,
                                    top:pos2.top
                                });
                                // For scroll to undo
                                root.setBlurTrigger("absList_editor_blur",function(){
                                    undo();
                                });
                                editor.activate();
                            }
                        }
                    }
                }
            }
            return this;
        },
        getSelectedItem:function(){
            var uiv=this.getUIValue(true),
                prf=this.get(0),
                items=[],
                item;
            if(xui.isArr(uiv)){
                if(uiv.length){
                    xui.arr.each(uiv,function(id){
                        if(item=prf.getItemByItemId(id)){
                            items.push(item);
                        }
                    });
                    return items;
                }
            } else if (uiv){
                return prf.getItemByItemId(uiv);
            }
        }
    },
    Initialize:function(){
        var o=this.prototype;
        xui.arr.each(xui.toArr('getItemByItemId,getItemByDom,getSubIdByItemId,getSubNodeByItemId'),function(s){
            o[s]=function(){
                var t=this.get(0);
                return t[s].apply(t,arguments);
            };
            xui.Class._fun(o[s],s,o.KEY,null,'instance');
        });
    },
    Static:{
        _focusNodeKey:'ITEM',
        $abstract:true,
        // for item in box array
        _ensureValues:xui.UI._ensureValues,

        DataModel:{
            listKey:{
                set:function(value){
                    var o=this,
                        t = o.box.getCachedData(value);
                    if(t)
                        o.boxing().setItems(xui.clone(t));
                    else
                        o.boxing().setItems(o.properties.items);
                    o.properties.listKey = value;
                }
            },
            items:{
                ini:[],
                set:function(value){
                    var o=this,
                        ins=o.boxing(),
                        items=o.properties.items,
                        children,ia,bv;

                    //bak value
                    if(typeof ins.setValue=='function'){
                        bv=o.properties.value;
                        if(bv && value && value.length){
                            var i=xui.arr.indexOf(value,bv);
                            if(i===-1)
                                i=xui.arr.subIndexOf(value,"id",o.properties.value);
                        //    if(i===-1)
                         //       bv=value?value[0]?value[0].id?value[0].id:value[0]:"":"";
                        }
                    }

                    // keep children objects
                    if(items && items.length){
                        if(o.children && o.children.length){
                            // use UIProfile's serialize function for module case
                            xui.arr.each(children = o.serialize(false, true).children, function(arr){
                                if(arr[1]){
                                    var i=xui.arr.indexOf(items,arr[1]);
                                    if(i===-1)
                                        i=xui.arr.subIndexOf(items,"id",arr[1]);
                                    if(i!==-1)
                                        arr[2]=i;
                                }
                            });
                            // destroy all
                            ins.removeChildren(true,true,true);
                        }
                        ins.clearItems(true, true);
                    }

                    ins.insertItems(value?xui.copy(value):null,null,null,true);

                    // restore children
                    if(value && value.length && children){
                        var hash={},rhash={},len=value.length;
                        xui.arr.each(value,function(item,i){
                            hash[item.id||item]=i;
                            rhash[i]=item.id||item;
                        });
                        xui.arr.each(children,function(arr){
                            var added,t;
                            if(xui.isSet(arr[1])){
                                // add by id
                                if(xui.isSet(hash[arr[1]])){
                                    t=xui.create(arr[0]);
                                    if(o.$panelRestore)o.$panelRestore(t.get(0));
                                    ins.append(t,arr[1]);
                                    added=1;
                                }else{
                                    // add by index
                                    if(rhash[arr[2]]){
                                        t=xui.create(arr[0]);
                                        if(o.$panelRestore)o.$panelRestore(t.get(0));
                                        ins.append(t,rhash[arr[2]]);
                                        added=1;
                                    }
                                }
                            }
                            if(!added){
                                t=xui.create(arr[0]);
                                if(o.$panelRestore)o.$panelRestore(t.get(0));
                                ins.append(t,bv);
                            }
                        });
                    }

                    //try to set value
                    if(xui.isSet(bv)){
                        ins.setValue(bv,true,'items');
                    }

                    if(o.renderId){
                        o.adjustSize();
                    }
                }
            },
            dragSortable:false,
            valueSeparator:';'
        },
        RenderTrigger:function(){
            this.destroyTrigger=function(){
                xui.each(this.SubSerialIdMapItem,function(o){
                    xui.breakO(o)
                });
                this.properties.items.length=0;
            };
        },
        EventHandlers:{
            beforePrepareItem:function(profile, item, pid){},
            beforeIniEditor:function(profile, item, captionNode){},
            onBeginEdit:function(profile, item, editor){},
            beforeEditApply:function(profile, item, caption, editor, tag){},
            onEndEdit:function(profile, item, editor){}
        },
        getDropKeys:function(profile,node){
            var item=profile.getItemByDom(node);
            return (item&&item.dropKeys) ||profile.properties.dropKeys;
        },
        getDragKey:function(profile,node){
            var item=profile.getItemByDom(node);
            return (item&&item.dragKey) || profile.properties.dragKey || (profile.properties.dragSortable&&(profile.key+":"+profile.$xid));
        },
        _adjustItems:function(arr){
            if(!xui.isSet(arr))arr=[];
            if(!xui.isArr(arr))arr=[arr];
            var a=xui.copy(arr),m;
            xui.arr.each(a,function(o,i){
                if(xui.isArr(o) && o.length){
                    a[i]={id:o[0]};
                    a[i].id=xui.isSet(a[i].id)?(a[i].id+''):xui.id();
                    if(xui.isSet(o[1]))a[i].caption=o[1]+'';
                }else if(xui.isHash(o)){
                    a[i]=xui.copy(o);
                    a[i].id=xui.isSet(a[i].id)?(a[i].id+''):xui.id();
                }else
                    a[i]={id:o+''};
            });
            return a;
        },
        //
        _showTips:function(profile, node, pos){
            if(profile.properties.disableTips)return;
            if(profile.onShowTips)
                return profile.boxing().onShowTips(profile, node, pos);
            if(!xui.Tips)return;

            var t=profile.properties,
                id=node.id,
                sid=profile.getSubId(id),
                map=profile.SubSerialIdMapItem,
                item=map&&map[sid];

            if(item && ('tips' in item)){
                if(item.tips)xui.Tips.show(pos, item);
                else xui.Tips.hide();
                return false;
            }else if(profile.properties.autoTips && item && 'caption' in item){
                if(item.caption||item.comment)xui.Tips.show(pos, {tips: xui.adjustRes((item.caption||'') + (item.caption||item.comment?'<br/>':'') + (item.comment||''), true,false,null,null,item) });
                else xui.Tips.hide();
                return false;
            }else
                return true;
        }
    }
});

//absValue Class
xui.Class("xui.absValue", "xui.absObj",{
    Instance:{
        /*
        getUIValue:         return $UIvalue
        setUIValue:         set $UIvalue,and _setCtrlValue                   beforeUIValueSet/afterUIValueSet
        getValue:           return value
        setValue:           set value, set $UIvalue, and _setCtrlValue       beforeValueSet/afterValueSet
        resetValue:         reset value,UIvalue,Ctrlvalue not trigger event
        updateValue:        set $UIvalue to value

        _setCtrlValue:      change control value                *need to be overwritten
        _getCtrlValue:      get value from control              *need to be overwritten
        _setDirtyMark:      mark UI ctrl when value!==UIvalue   *need to be overwritten
        */
        _getCtrlValue:function(){return this.get(0).properties.$UIvalue},
        _setCtrlValue:function(value){return this},
        _setDirtyMark:function(key){
          return this.each(function(profile){
                if(!profile.renderId)return;
                var properties = profile.properties,
                    flag=properties.value !== properties.$UIvalue,
                    o=profile.getSubNode(key||profile.box.DIRYMARKICON||"KEY"),
                    d=xui.UI.$css_tag_dirty;
                if(profile._dirtyFlag!==flag){
                    if(properties.dirtyMark && properties.showDirtyMark){
                        if(profile.beforeDirtyMark && false===profile.boxing().beforeDirtyMark(profile,flag)){}
                        else{
                            if(flag) o.addClass(d);
                            else o.removeClass(d);
                        }
                    }
                    profile._dirtyFlag=flag;
                }
            });
        },
        getValue:function(returnArr){
            var prf=this.get(0),
                prop=prf.properties,
                v=prop.value;

            if(prf.box.$valuemode=='multi')
                if(returnArr)
                    if(xui.isStr(v))
                        v=v.split(prop.valueSeparator);

            if(prf.box.$DataModel.selMode && (prop.selMode=='multi'||prop.selMode=='multibycheckbox') && returnArr){
                if(xui.isStr(v))
                    v=v.split(prop.valueSeparator);
                if(v && xui.isArr(v) && v.length>1)
                    v.sort();
            }
            return v;
        },
        getUIValue:function(returnArr){
            var prf=this.get(0),
                prop=prf.properties;

            if(!prf.renderId)
                return prop&&prop.value;

            var cv=this._getCtrlValue(),v;
            if(!prf.box._checkValid || false!==prf.box._checkValid(prf,cv))
                prop.$UIvalue=cv;
            v=prop.$UIvalue;

            if(prf.box.$valuemode=='multi')
                if(returnArr)
                    if(xui.isStr(v))
                        v=v.split(prop.valueSeparator);

            if(prf.box.$DataModel.selMode && (prop.selMode=='multi'||prop.selMode=='multibycheckbox') && returnArr){
                if(xui.isStr(v))
                    v=v.split(prop.valueSeparator);
                if(v && xui.isArr(v) && v.length>1)
                    v.sort();
            }
            return v;
        },
        resetValue:function(value){
            var self=this;
            self.each(function(profile){
                var r,pro=profile.properties,ins=profile.boxing(),
                        v=typeof (r=profile.box._ensureValue)=='function'?r.call(profile.box, profile, value):value;
                if(pro.value !== v || pro.$UIvalue!==v){
                    if(profile.box._beforeResetValue)profile.box._beforeResetValue(profile);
                    if(typeof(r=profile.$onValueSet)=='function'){
                        r=r.call(profile,pro.value,v);
                        if(xui.isSet(r))v=r;
                    }

                    // _setCtrlValue maybe use $UIvalue
                    profile.boxing()._setCtrlValue(pro.value = v);
                    // So, maintain $UIvalue during _setCtrlValue call
                    pro.$UIvalue = v;
                }
                profile._inValid=1;
                ins._setDirtyMark();
            });
            return self;
        },
        setUIValue:function(value, force, triggerEventOnly, tag){
            var self=this;
            this.each(function(profile){
                var prop=profile.properties, r,
                    ovalue = prop.$UIvalue,
                    box = profile.boxing();
                if(force || (ovalue !== value)){
                    if(
                        (profile.box._checkValid && false===profile.box._checkValid(profile, value)) ||
                        (profile.beforeUIValueSet && false===(r=box.beforeUIValueSet(profile, ovalue, value, force, tag)))
                      )
                        return;

                    //can get return value
                    if(r!==undefined && typeof r!=='boolean')value=r;
                    //before _setCtrlValue
                    if(profile.box && (typeof (r=profile.box._ensureValue)=='function'))
                        value = r.call(profile.box, profile, value);
                    if(typeof(r=profile.$onUIValueSet)=='function'){
                        r=r.call(profile,value,force,tag);
                        if(xui.isSet(r))value=r;
                    }

                    //before value copy
                    var cv;
                    if(profile.renderId && !triggerEventOnly){
                        cv=1;
                        box._setCtrlValue(value);
                    }

                    //value copy
                    prop.$UIvalue = value;

                    if(profile.renderId && !triggerEventOnly)box._setDirtyMark();

                    if(profile.afterUIValueSet)box.afterUIValueSet(profile, ovalue, value, force, tag);
                    if(profile._onChange)box._onChange(profile, ovalue, value, force, tag);
                    if(profile.onChange)box.onChange(profile, ovalue, value, force, tag);

                    if(!prop.dirtyMark)
                        box.setValue(value,false,'uiv',cv || triggerEventOnly);

                    if(prop.excelCellId && box.notifyExcel){
                        box.notifyExcel(false);
                    }
                }
            });
            return this;
        },
        updateValue:function(){
            return this.each(function(profile){
                var prop = profile.properties;
                if(prop.value!==prop.$UIvalue){
                    var ins=profile.boxing();
                    if(ins.checkValid()){
                        // prop.value = ins.getUIValue();
                        ins.setValue(ins.getUIValue(),true,'update');
                        ins._setDirtyMark();
                    }
                }
            });
        },
        isDirtied:function(){
            var dirtied=false;
            this.each(function(profile){
                var p=profile.properties;

                // inner value is alway string
                dirtied = (p.value+" ") !== (p.$UIvalue+" ");
                if(dirtied)
                    return false;
            });
            return dirtied
        },
        checkValid:function(value){
            var prop,tr,r=true,outv=xui.isSet(value);
            this.each(function(profile){
                prop=profile.properties;
                tr=true;

                // for checking html ctrl valid, <input> only
                if(profile.box._checkValid2)
                    // r must be at the end
                    r = (tr=profile.box._checkValid2(profile)) && r;
                if(tr && profile.box._checkValid)
                    //r must be at the end
                    r = profile.box._checkValid(profile, outv?value:prop.$UIvalue) && r;

                if(!outv && profile.renderId)
                    profile.boxing()._setDirtyMark();
            });
            return r;
        }
    },
    Static:{
        $abstract:true,
        DataModel:{
            readonly:{
                ini:false,
                action: function(v){
                    var i=this.getRoot();
                    if(v)
                        i.addClass('xui-ui-readonly');
                    else
                        i.removeClass('xui-ui-readonly');
                }
            },
            required:{
                ini:false,
                // mark required
                action:function(v){
                    if(this.keys['LABEL']){
                        var node = this.getSubNode('LABEL');
                        if(v)node.addClass('xui-required');
                        else node.removeClass('xui-required');
                    }
                }
            },
            // setValue and getValue
            value:{
                ini:null,
                set:function(value, force, tag, triggerEventOnly){
                    var profile=this,
                        p=profile.properties,r,
                        ovalue=p.value,
                        box=profile.boxing();

                    //check format
                    if(profile.box._checkValid && profile.box._checkValid(profile, value)===false)return;
                    //if return false in beforeValueSet, not set
                    if(profile.beforeValueSet && false=== (r=box.beforeValueSet(profile, ovalue, value,force, tag)))return;
                    // can get return value
                    if(r!==undefined)value=r;
                    //before _setCtrlValue
                    //ensure value
                    if(typeof (r=profile.box._ensureValue)=='function')
                        value = r.call(profile.box, profile, value);

                    if(typeof(r=profile.$onValueSet)=='function'){
                        r=r.call(profile,ovalue,value,force,tag);
                        if(xui.isSet(r))value=r;
                    }

                    //before value copy
                    if(profile.renderId && !triggerEventOnly)box._setCtrlValue(value);
                    //value copy
                    p.value = p.$UIvalue = value;

                    if(!profile._inValid)profile._inValid=1;
                    if(profile.renderId)box._setDirtyMark();
                    if(profile.afterValueSet)box.afterValueSet(profile, ovalue, value, force, tag);
                    if(profile.onValueChange)box.onValueChange(profile, ovalue, value, force, tag);
                }
            },
            isFormField:true,
            dirtyMark:true,
            showDirtyMark:true
        },
        // for item in box array
        _ensureValues:xui.UI._ensureValues,
        // for value
        _ensureValue:function(profile,value){
            var prop=profile.properties;
            if(profile.box.$DataModel.selMode && (prop.selMode=='multi'||prop.selMode=='multibycheckbox')){
                if(!xui.isArr(value)){
                    value = (value?(''+value):'').split(prop.valueSeparator);
                }
                value.sort();
                return value.join(prop.valueSeparator);
            }else
                return xui.isArr(value)?value[0]:value;
        },
        EventHandlers:{
           //real value set
            beforeValueSet:function(profile, oldValue, newValue,force, tag){},
            afterValueSet:function(profile, oldValue, newValue,force, tag){},
            onValueChange:function(profile, oldValue, newValue, force, tag){},

            //ui value set
            beforeUIValueSet:function(profile, oldValue, newValue, force, tag){},
            afterUIValueSet:function(profile, oldValue, newValue, force, tag){},
            onChange:function(profile, oldValue, newValue, force, tag){},
            _onChange:function(profile, oldValue, newValue, force, tag){},

            beforeDirtyMark:function(profile, dirty){}
        },
        RenderTrigger:function(){
            var self=this, b=self.boxing(),p=self.properties,t;
            // disable dataField for container control
            if(!self.behavior.PanelKeys){
                if(t=p.dataBinder)b.setDataBinder(t,true);
                if(t=p.dataField)b.setDataField(t);
            }

            if(p.value!==undefined){
                if(typeof (t=self.box._ensureValue)=='function'){
                    p.value = t.call(self.box, self, p.value);
                    if(p.$UIvalue)
                        p.$UIvalue = t.call(self.box, self, p.$UIvalue);
                }
                if(!p.$UIvalue)
                    p.$UIvalue=p.value;
                b._setCtrlValue(p.$UIvalue,true);
            }
        }
    }
});

xui.Class("xui.UI.Widget", "xui.UI",{
    Static:{
        Appearances:{
            KEY:{
            },
            IE67_SHADOW:(xui.browser.ie && xui.browser.ver <=8)?{
                'z-index':'-1',
                position:'absolute',
                left:0,
                top:0,
                width:'100%',
                height:'100%',
                overflow:'visible'
            }:null
        },
        Templates:{
            className:'xui-uiw-shell {_className}',
            style:'{_style}',

            IE67_SHADOW:(xui.browser.ie && xui.browser.ver <=8)?{}:null,
            FRAME:{
                $order:2,
                className:'xui-uiw-frame ',
                BORDER:{
                    $order:1,
                    style:'width:{bWidth};height:{bHeight};',
                    className:'xui-uiw-border'
                }
            }
        },
        Behaviors:{
            onSize:xui.UI.$onSize
        },
        DataModel:{
            width:{
                $spaceunit:1,
                ini:'10em'
            },
            height:{
                $spaceunit:1,
                ini:'10em'
            },
            shadow:{
                ini:false,
                action: function(v){
                    if(xui.browser.ie && xui.browser.ver <=8){
                        var node=this.getSubNode('IE67_SHADOW');
                        if(v) node.addClass('xui-ui-shadow xui-uiborder-r xui-uiborder-b xui-uiborder-radius-br');
                        else node.removeClass('xui-ui-shadow xui-uiborder-r xui-uiborder-b xui-uiborder-radius-br');
                    }else{
                        var node=this.getSubNode('BORDER');
                        if(v) node.addClass('xui-ui-shadow');
                        else node.removeClass('xui-ui-shadow');
                    }
                }
            },
            //hide props( with px)
            $hborder:0,
            $vborder:0
        },
        RenderTrigger:function(){
            var self=this, p=self.properties, o=self.boxing();

            if(self.renderId)
                if((!self.$noB) && p.border && o._border)o._border();

            if((!self.$noR) && p.resizer && o.setResizer)o.setResizer(p.resizer,true);
            if((!self.$noS) && p.shadow && o.setShadow)o.setShadow(true,true);
        },
        _onresize:function(profile,width,height){
            var prop = profile.properties,
                border = profile.getSubNode('BORDER'),
                cb=border.contentBox(),
                shadow = (xui.browser.ie && xui.browser.ver <=8)?profile.getSubNode('IE67_SHADOW'):null,
                region,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                //caculate with px
                ww=profile.$px(width),
                hh=profile.$px(height),
                left=!cb?0:Math.max(0, (prop.$b_lw||0)-(prop.$hborder||0)),
                top=!cb?0:Math.max(0, (prop.$b_tw||0)-(prop.$vborder||0));

            if(ww&&'auto'!==ww){
                ww -= !cb?0:Math.max((prop.$hborder||0)*2, (prop.$b_lw||0)+(prop.$b_rw||0));
                /*for ie6 bug*/
                /*for example, if single number, 100% width will add 1*/
                /*for example, if single number, attached shadow will overlap*/
                if(xui.browser.ie&&xui.browser.ver<=6)ww=(profile.$px(ww/2))*2;
            }
            if(hh&&'auto'!==hh){
                hh -= !cb?0:Math.max((prop.$vborder||0)*2, (prop.$b_lw||0) + (prop.$b_rw||0));

                if(xui.browser.ie&&xui.browser.ver<=6)hh=(profile.$px(hh/2))*2;
                /*for ie6 bug*/
                if(xui.browser.ie&&xui.browser.ver<=6&&null===width){
                    border.ieRemedy();
                    if(shadow)shadow.ieRemedy();
                }
            }
            region={
                left:adjustunit(left),
                top:adjustunit(top),
                width:adjustunit(ww),
                height:adjustunit(hh)
            };
            border.cssRegion(region);
            if(shadow)shadow.cssRegion(region);

            /*for ie6 bug*/
            if((profile.$resizer) && xui.browser.ie){
                border.ieRemedy();
                if(shadow)shadow.ieRemedy();
            }
            return region;
        }
    }
});

xui.Class("xui.UI.Link", "xui.UI",{
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        }
    },
    Static:{
        Appearances:{
            KEY:{
               cursor:'pointer'
            }
        },
        Templates:{
            tagName:'a',
            className:'{_className}',
            style:'{_style}',
            href :"{href}",
            target:'{target}',
            tabindex: '{tabindex}',
            text:'{caption}'
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY'},
            ClickEffected:{KEY:'KEY'},
            onClick:function(profile, e, src){
                var r;
                if(!profile.properties.disabled && profile.onClick)
                    r = profile.boxing().onClick(profile, e, src);
                //**** if dont return false, this click will break jsonp in IE
                //**** In IE, click a fake(javascript: or #) href(onclick not return false) will break the current script downloading
                var href=xui.use(src).attr('href');
                return typeof r=='boolean'?r:(href.indexOf('javascript:')===0||href.indexOf('#')===0)?false:true;
            }
        },
        DataModel:{
            caption:{
                ini:undefined,
                action:function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getRoot().html(xui.adjustRes(v,true));
                }
            },
            href:{
                ini:xui.$DEFAULTHREF,
                action:function(v){
                    this.getRoot().attr('href',v);
                }
            },
            target:{
                action:function(v){
                    this.getRoot().attr('target',v);
                }
            }
        },
        EventHandlers:{
            onClick:function(profile, e){}
        }
    }
});

xui.Class("xui.UI.Element", "xui.UI",{
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        }
    },
    Static:{
        _objectProp:{attributes:1},
        Templates:{
            _NativeElement:true,
            tagName:'{nodeName}',
            // dont set class to HTML Element
            className:'xui-node xui-wrapper {_className}',
            style:'{_style};',
            //for firefox div focus bug: outline:none; tabindex:'-1'
            tabindex: '{tabindex}',
            text:'{html}'+xui.UI.$childTag
        },
        DataModel:{
            width:{
                $spaceunit:1,
                ini:'8em'
            },
            height:{
                $spaceunit:1,
                ini:'1em'
            },
            nodeName:{
                ini:"xui",
                action:function(v){
                    this.boxing().refresh();
                }
            },
            selectable:true,
            html:{
                html:1,
                action:function(v,ov,force){
                    this.getRoot().html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            attributes:{
                ini:{},
                action:function(v,ov){
                    var root=this.getRoot();
                    if(!xui.isEmpty(ov)){
                        xui.each(ov,function(o,i){
                            root.attr(i,null);
                        });
                    }
                    if(!xui.isEmpty(v)){
                        xui.each(v,function(o,i){
                            root.attr(i,o);
                        });
                    }
                }
            },
            tabindex:-1
        },
        Appearances:{
            KEY:{
                'line-height':'normal'
            }
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY'},
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            }
        },
        EventHandlers:{
            onClick:function(profile, e, value){}
        },
        RenderTrigger:function(){
            var v=this.properties.attributes;
            if(!xui.isEmpty(v)){
                var root=this.getRoot();
                xui.each(v,function(o,i){
                    root.attr(i,o);
                });
            }
        }
    }
});

xui.Class("xui.UI.Icon", "xui.UI",{
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        }
    },
    Static:{
        Templates:{
            className:'xui-node xui-wrapper {_className}  {picClass}',
            style:'{_style};',
            ICON:{
                className:'xuicon {imageClass}',
                style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{imageDisplay}{_fontsize}{_fontclr}{iconStyle}',
                text:'{iconFontCode}'
            }
        },
        DataModel:{
            selectable:null,
            html:null,
            attributes:null,
            renderer:null,
            defaultFocus:null,
            tabindex:-1,
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(v){
                    this.getSubNode('ICON').css('backgroundPosition', v||'center');
                }
            },
            imageBgSize:{
                action: function(v){
                    this.getSubNode('ICON').css('backgroundSize', v||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            iconFontSize:{
                action:function(v){
                    this.getSubNode('ICON').css('fontSize', v||'');
                }
            },
            iconColor:{
                type:'color',
                action:function(v){
                    this.getSubNode('ICON').css('color', v||'');
                }
            }
        },
        Appearances:{
            KEY:{
                'overflow':'visible'
            },
            ICON:{
                'position':'relative',
                display:xui.$inlineBlock,
                zoom:xui.browser.ie?1:null
            }
        },
        Behaviors:{
            HoverEffected:{ICON:'ICON'},
            ClickEffected:{ICON:'ICON'},
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            }
        },
        EventHandlers:{
            onClick:function(profile, e, value){}
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            if(data.iconFontSize)data._fontsize = data.iconFontSize+';';
            if(data.iconColor)data._fontclr = 'color:'+data.iconColor+';';
            return data;
        }
    }
});

xui.Class("xui.UI.HTMLButton", "xui.UI.Element",{
    Instance:{
        activate:function(){
            this.getRoot().focus(true);
            return this;
        }
    },
    Static:{
        Templates:{
            tagName:'button',
            className:'xui-ui-unselectable xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius {_className}',
            style:'{_style};',
            tabindex: '{tabindex}',
            text:'{html}'+xui.UI.$childTag
        },
        Appearances:{
            KEY:{
                cursor:'pointer',
                padding:'.334em'
            }
        },
        DataModel:{
            nodeName:null,
            tabindex:1,
            width:'auto',
            height:'auto',
            disabled:{
                ini:false,
                action: function(v){
                    var i=this.getRoot(),
                        cls="xui-ui-disabled";

                    if(v)this.getRoot().addClass(cls);
                    else this.getRoot().removeClass(cls);
                    i.attr('disabled',v?"1":null);
                }
            },
            shadow:{
                ini:false,
                action: function(v){
                    var node=this.getRoot();
                    if(v) node.addClass('xui-ui-shadow');
                    else node.removeClass('xui-ui-shadow');
                }
            },
            fontColor:{
                ini:'',
                type:"color",
                action: function(value){
                    this.getRoot().css('color', value);
                }
            },
            fontSize:{
                combobox:["","14px","18px","22px","30px"],
                action: function(value){
                    this.getRoot().css('fontSize', value);
                }
            },
            fontWeight:{
                combobox:["","normal","bolder","bold","lighter","100","200","300","400","500","600","700","800","900"],
                action: function(value){
                    this.getRoot().css('fontWeight', value);
                }
            },
            fontFamily:{
                combobox:["","arial","sans-serif","comic","courier new","monospace","serif","times new roman","wingdings"],
                action: function(value){
                    this.getRoot().css('fontFamily', value);
                }
            }
        },
        RenderTrigger:function(){
            var self=this, p=self.properties, o=self.boxing();
            if((!self.$noS) && p.shadow && o.setShadow)o.setShadow(true,true);
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY'}
        }
    }
});

xui.Class("xui.UI.Button", ["xui.UI.HTMLButton","xui.absValue"],{
    Initialize:function(){
        // compitable
        xui.UI.SButton = xui.UI.Button;
        var key="xui.UI.SButton";
        xui.absBox.$type[key.replace("xui.UI.","")]=xui.absBox.$type[key]=key;
        this.$activeClass$='xui.UI.Button';
    },
    Instance:{
        activate:function(){
            this.getRoot().focus(true);
            return this;
        },
        _setCtrlValue:function(value){
            if(xui.isNull(value) || !xui.isDefined(value))value=false;
            return this.each(function(profile){
                var pp=profile.properties;
                if(pp.type!='status')return;
                profile.getRoot().tagClass('-checked', value);
            });
        },
        resetValue:function(value){
            this.each(function(p){
                if(p.properties.type=='drop')
                    p.boxing().setCaption("",true);
            });
            var upper=arguments.callee.upper,
                rtn=upper.apply(this,xui.toArr(arguments));
            upper=null;
            return rtn;
        },
        setUIValue:function(value, force){
            this.each(function(profile){
                var p=profile.properties;
                if(p.$UIvalue!==value && p.type=='drop')
                    profile.boxing().setCaption("",true);
            });
            var upper=arguments.callee.upper,
                rtn=upper.apply(this,xui.toArr(arguments));
            upper=null;
            return rtn;
        }
    },
    Static:{
        //for IE67 and dirtymark
        DIRYMARKICON:"BACKGROUND",
        Templates:{
            tagName:'button',
            className:'xui-ui-unselectable xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius {_className}',
            style:'{_style};{_align}',
            tabindex: '{tabindex}',
            BACKGROUND:{
                tagName:'div'
            },
            ICON:{
                $order:1,
                className:'xuicon {imageClass}  {picClass}',
                style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                text:'{iconFontCode}'
            },
            CAPTION:{
                $order:2,
                className:'',
                text:'{caption}'
            },
            DROP:{
                $order: 3,
                className: 'xuifont xui-special-icon',
                style: '{_showDrop}',
                $fonticon:'xui-uicmd-arrowdrop'
            }
        },
        Appearances:{
            //for IE67 and dirtymark
            BACKGROUND:{
                'z-index':-1,
                position:'absolute',
                left:0,
                top:0,
                width:'100%',
                height:'100%'
            },
            DROP:{
                'vertical-align': 'middle',
                'padding-left':'.66667em'
            }
        },
        Behaviors:{
            HoverEffected:{KEY:['KEY','DROP']},
            NavKeys:{KEY:1},
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                var b=profile.boxing();
                if(p.type=='status'){
                    if(p.readonly)return false;
                    b.setUIValue(!p.$UIvalue,null,null,'click');
                    if(profile.onChecked)
                        b.onChecked(profile, e, p.$UIvalue);
                }
                //onClick event
                if(profile.onClick)
                    return b.onClick(profile, e, src, p.$UIvalue);
                if(p.type=='drop' && profile.onClickDrop)
                    return b.onClickDrop(profile, e, src, p.$UIvalue);
            },
            onKeydown:function(profile, e, src){
                var keys=xui.Event.getKey(e), key = keys.key;
                if(key==' '||key=='enter'){
                    profile.getSubNode('KEY').afterMousedown();
                    profile.__fakeclick=1;
                }
            },
            onKeyup:function(profile, e, src){
                var keys=xui.Event.getKey(e), key = keys.key;
                if(key==' '||key=='enter'){
                    profile.getSubNode('KEY').afterMouseup();
                    if(profile.__fakeclick)
                        xui.use(src).onClick();
                }
                delete profile.__fakeclick;
            }
        },
        DataModel:{
            html:null,
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            caption:{
                ini:undefined,
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('CAPTION').html(xui.adjustRes(v,0,1));
                }
            },
            hAlign:{
                ini:'center',
                listbox:['left','center','right'],
                action: function(v){
                    this.getRoot().css('textAlign',v);
                }
            },
            vAlign:{
                ini:'middle',
                listbox:['top','middle','bottom'],
                action: function(v){
                    //todo
                }
            },
            value:{
                ini:false
            },
            fontColor:{
                action: function(value){
                    this.getSubNode("CAPTION").css('color', value);
                }
            },
            fontSize:{
                combobox:["","14px","18px","22px",".75em","1.5em","2em","3em"],
                action: function(value){
                    this.getSubNode("CAPTION").css('fontSize', value);
                }
            },
            fontWeight:{
                action: function(value){
                    this.getSubNode("CAPTION").css('fontWeight', value);
                }
            },
            fontFamily:{
                action: function(value){
                    this.getSubNode("CAPTION").css('fontFamily', value);
                }
            },
            type:{
                ini:'normal',
                listbox:['normal','status','drop'],
                action:function(value){
                    var self=this,
                        drop=self.getSubNode('DROP');
                    if(value=='drop'){
                        drop.css('display','');
                    }
                    else{
                        drop.css('display','none');
                    }
                }
            }
        },
        _isFormField:function(profile){
            return profile.properties.type=="status";
        },
        _ensureValue:function(profile,value){
            if(profile.properties.type=="status")
                return !!value;
            else
                return value;
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            data._align = 'text-align:'+data.hAlign+';';
            data._showDrop = data.type=='drop'?'':'display:none';
            return data;
        },
        RenderTrigger:function(){
            var self=this,p = self.properties, o=self.boxing();
            //set value later
            if(p.type=='status' && p.value)
                o.setValue(true, true, 'render');
        },
        EventHandlers:{
            onClick:function(profile, e, src, value){},
            onClickDrop:function(profile, e, src, value){},
            onChecked:function(profile, e, value){}
        }
    }
});

xui.Class("xui.UI.Span", "xui.UI",{
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        }
    },
    Static:{
        Templates:{
            className:'{_className}',
            style:'{_style};{_overflow};',
            //for firefox div focus bug: outline:none; tabindex:'-1'
            tabindex: '{tabindex}',
            text:'{html}'+xui.UI.$childTag
        },
        DataModel:{
            width:{
                $spaceunit:1,
                ini:'2em'
            },
            height:{
                $spaceunit:1,
                ini:'1em'
            },
            selectable:true,
            html:{
                html:1,
                action:function(v,ov,force){
                    this.getRoot().html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            overflow:{
                ini:xui.browser.deviceType=="touchOnly"?'auto':undefined,
                combobox:['','visible','hidden','scroll','auto','overflow-x:hidden;overflow-y:auto','overflow-x:auto;overflow-y:hidden'],
                action:function(v){
                    var node=this.getContainer();
                    if(v){
                        if(v.indexOf(':')!=-1){
                            xui.arr.each(v.split(/\s*;\s*/g),function(s){
                                var a=s.split(/\s*:\s*/g);
                            if(a.length>1)node.css(xui.str.trim(a[0]),xui.str.trim(a[1]||''));
                            });
                            return;
                        }
                    }
                    node.css('overflow',v||'');
                }
            },
            tabindex:-1
        },
        Appearances:{
            KEY:{
                'line-height':'normal'
            }
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY',ICON:'ICON'},
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            }
        },
        EventHandlers:{
            onClick:function(profile, e, value){}
        },
        _prepareData:function(profile,data){
            data=arguments.callee.upper.call(this, profile,data);
            if(xui.isStr(data.overflow))
                data._overflow = data.overflow.indexOf(':')!=-1?(data.overflow):(data.overflow?("overflow:"+data.overflow):"");
            return data;
        }
    }
});

xui.Class("xui.UI.Div", "xui.UI",{
    Initialize:function(){
        // compitable
        xui.UI.Pane = xui.UI.Div;
        var key="xui.UI.Pane";
        xui.absBox.$type[key.replace("xui.UI.","")]=xui.absBox.$type[key]=key;
        this.$activeClass$='xui.UI.Div';
    },
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        }
    },
    Static:{
        Appearances:{
            KEY:{
               // overflow:(xui.browser.gek && !xui.browser.gek3)?'auto':null,
                outline:xui.browser.gek?'none':null, 
                zoom:(xui.browser.ie && xui.browser.ver<9)?'1':null,
                background:xui.browser.ie?'url('+xui.ini.img_bg+') no-repeat left top':null,
                'line-height':'normal'
            }
        },
        Templates:{
            tagName:'div',
            className:'xui-uicontainer {_className}',
            style:'{_style};{_panelstyle};{_overflow};',
            //for firefox div focus bug: outline:none; tabindex:'-1'
            tabindex: '{tabindex}',
            text:'{html}'+xui.UI.$childTag
        },
        DataModel:{
            iframeAutoLoad:{
                ini:"",
                action:function(){
                    this.box._applyAutoLoad(this);
                }
            },
            ajaxAutoLoad:{
                ini:"",
                action:function(){
                    this.box._applyAutoLoad(this);
                }
            },
            width:{
                $spaceunit:1,
                ini:'10em'
            },
            height:{
                $spaceunit:1,
                ini:'10em'
            },
            selectable:true,
            html:{
                html:1,
                action:function(v,ov,force){
                    this.getRoot().html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            overflow:{
                ini:xui.browser.deviceType=="touchOnly"?'auto':undefined,
                combobox:['','visible','hidden','scroll','auto','overflow-x:hidden;overflow-y:auto','overflow-x:auto;overflow-y:hidden'],
                action:function(v){
                    var node=this.getContainer();
                    if(v){
                        if(v.indexOf(':')!=-1){
                            xui.arr.each(v.split(/\s*;\s*/g),function(s){
                                var a=s.split(/\s*:\s*/g);
                            if(a.length>1)node.css(xui.str.trim(a[0]),xui.str.trim(a[1]||''));
                            });
                            return;
                        }
                    }
                    node.css('overflow',v||'');
                }
            },
            tabindex:-1
        },
        RenderTrigger:function(){
            // only div
            var ns=this;
            if(ns.box.KEY=="xui.UI.Div")
                if(ns.properties.iframeAutoLoad||ns.properties.ajaxAutoLoad)
                    ns.box._applyAutoLoad(this);
        },
        Behaviors:{
            DroppableKeys:['KEY'],
            PanelKeys:['KEY'],
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            }
        },
        EventHandlers:{
            onClick:function(profile, e, value){}
        },
        _prepareData:function(profile,data){
            data=arguments.callee.upper.call(this, profile,data);
            if(xui.isStr(data.overflow))
                data._overflow = data.overflow.indexOf(':')!=-1?(data.overflow):(data.overflow?("overflow:"+data.overflow):"");
            return data;
        },
        _applyAutoLoad:function(prf){
            var prop=prf.properties, ins=prf.boxing();
            if(prop.iframeAutoLoad){
                ins.getContainer().css('overflow','hidden');
                var _if=typeof prop.iframeAutoLoad=='string'?{url:prop.iframeAutoLoad}:xui.clone(prop.iframeAutoLoad,true),
                    id="biframe_"+xui.stamp(),
                    e=xui.browser.ie && xui.browser.ver<9,
                    ifr=document.createElement(e?"<iframe name='"+id+"'>":"iframe");

                _if.url=xui.adjustRes(_if.url,false,true);

                ifr.id=ifr.name=id;
                if(xui.isHash(prop.iframeAutoLoad))prop.iframeAutoLoad.frameName=id;
                prop._frameName=id;

                if(!_if.query)_if.query={};
                _if.query._rand=xui.rand();
                ifr.frameBorder='0';
                ifr.marginWidth='0';
                ifr.marginHeight='0';
                ifr.vspace='0';
                ifr.hspace='0';
                ifr.allowTransparency='true';
                ifr.width='100%';
                ifr.height='100%';
                ins.getContainer().html("",false);
                ins.append(ifr);

                if((_if.method||"").toLowerCase()=="post")
                    xui.Dom.submit(_if.url, _if.query, "post", id, _if.enctype);
                else
                    ifr.src=_if.url;
            }else if(prop.ajaxAutoLoad){
                var _ajax=typeof prop.ajaxAutoLoad=='string'?{url:prop.ajaxAutoLoad}:xui.clone(prop.ajaxAutoLoad,true),
                    options={rspType:"text"};
                if(!_ajax.query)_ajax.query={};
                _ajax.query._rand=xui.rand();
                xui.merge(options, _ajax.options);
                ins.busy();
                var node=ins.getContainer();
                xui.Ajax(xui.adjustRes(_ajax.url,false,true), _ajax.query, function(rsp){
                    node.html(rsp,true,true);
                    ins.free();
                }, function(err){
                    node.html("<div>"+err+"</div>",true,false);
                    ins.free();
                }, null, options).start();
            }
        },
        _onresize:function(profile,width){
            if(width)xui.UI._adjustConW(profile, profile.getRoot(), width);
        }
    }
});

xui.Class("xui.UI.CSSBox","xui.UI.Span",{
    Instance:{
        fireClickEvent:null,        
        adjustDock:null,
        draggable:null,
        busy:null,
        free:null
    },
    Static:{
        $initRootHidden:true,
        _objectProp:{normalStatus:1,hoverStatus:1,activeStatus:1,focusStatus:1},
        Templates:{
            style:'left:'+xui.Dom.HIDE_VALUE+';top:'+xui.Dom.HIDE_VALUE+';width:12.5em;height:5em;visibility:hidden;display:none;position:absolute;z-index:0;',
            className:'{_className}',
            text:'{_html}'
        },
        DataModel:{
            className:{
                ini:null,
                action:function(){
                    this.box._refreshCSS(this);
                }
            },
            sandbox:{
                ini:"",
                action:function(v){
                    this.box._refreshCSS(this);
                }
            },
            normalStatus:{
                ini:{},
                action:function(v){
                    this.box._refreshCSS(this);
                }
            },
            hoverStatus:{
                ini:{},
                action:function(v){
                    this.box._refreshCSS(this);
                }
            },
            activeStatus:{
                ini:{},
                action:function(v){
                    this.box._refreshCSS(this);
                }
            },
            focusStatus:{
                ini:{},
                action:function(v){
                    this.box._refreshCSS(this);
                }
            },
            spaceUnit:null,
            showEffects:null,
            hideEffects:null,
            position:null,
            display:null,
            visibility:null,
            zIndex:null,
            left:null,
            top:null,
            width:null,
            height:null,
            right:null,
            bottom:null,
            rotate:null,
            activeAnim:null,
            hoverPop:null,
            hoverPopType:null,
            dock:null,
            dockStretch:null,
            dockIgnoreFlexFill:null,
            renderer:null,
            display:null,
            html:null,
            selectable:null,
            overflow:null,
            tabindex:null,
            autoTips:null,
            disableClickEffect:null,
            disableHoverEffect:null,
            disableTips:null,
            disabled:null,
            defaultFocus:null,
            dockStretch:null,
            dockIgnore:null,
            dockOrder:null,
            dockMargin:null,
            dockFloat:null,
            dockMinW:null,
            dockMinH:null,
            dockMaxW:null,
            dockMaxH:null,
            tips:null
        },
        $adjustProp:function(profile,force){
            var prop=profile.properties,cls = (!force && prop.className) || ('xui-css-'+profile.$xid),
                ko,i=1,hash={};
            profile.box.getAll().each(function(prf){
                if(prf!==profile)hash[prf.properties.className]=1;
            });
            while(hash[cls])cls = cls + (i++);
            prop.className=cls;
        },
        RenderTrigger:function(){
            var prf=this;
            if(!prf.$inDesign){
                xui('body').append(prf.getRoot());
            }
        },
        _prepareData:function(profile,data){
            data=arguments.callee.upper.call(this, profile,data);
            var css=this._getCon(profile);
            data._html = "Text"+(css?("<"+"style id='"+profile.getDomId()+"cssnode' type='text/css'>"+css+"<"+"/style>"):"");
            return data;
        },
        _getCon:function(prf){
                var css="", prevId="", t,
                    prop=prf.properties,
                    cls=prop.className,
                    hash1=prop.normalStatus,
                    hash2=prop.hoverStatus,
                    hash3=prop.activeStatus,
                    hash4=prop.focusStatus;
                if(hash1&&!xui.isEmpty(hash1)){
                    css+="."+cls+"{"+xui.Dom.$adjustCss(hash1,true)+"}\n";
                    if(hash1.color)css+="."+cls+" .xui-node{color:"+hash1.color+"}";
                }
                if(hash2&&!xui.isEmpty(hash2)){
                    css+="."+cls+":hover, ."+cls+"-hover{"+xui.Dom.$adjustCss(hash2,true)+"}\n";
                    if(hash2.color)css+="."+cls+" .xui-node{color:"+hash2.color+"}";
                }
                // cover :hover effect for -chekced / -active
                if(hash3&&!xui.isEmpty(hash3)){
                    css+="."+cls+":active, ."+cls+":checked, ."+cls+"-active, ."+cls+"-checked, ."+cls+"-checked:hover, ."+cls+"-active:hover{"+xui.Dom.$adjustCss(hash3,true)+"}";
                    if(hash3.color)css+="."+cls+" .xui-node{color:"+hash3.color+"}";
                }
                if(hash4&&!xui.isEmpty(hash4)){
                    css+="."+cls+":focus, ."+cls+"-focus{"+xui.Dom.$adjustCss(hash4,true)+"}";
                    if(hash4.color)css+="."+cls+" .xui-node{color:"+hash4.color+"}";
                }

                if(t=prop.sandbox){
                    // alias or domId
                    t=(prf.host && prf.host[t] && prf.host[t].get(0)) || (xui(t).get(0) && t);
                    if(t)prevId=xui.UI._getThemePrevId(t);
                }else if(prf.$inDesign){
                    // the canvas
                    if(t=prf.parent)prevId=xui.UI._getThemePrevId(t);
                }

                return  xui.UI._adjustCSS(css, prevId);
        },
        _refreshCSS:function(prf){
            var ns=this;
            xui.resetRun(prf.key+":"+prf.$xid,function(){
                if(prf.destroyed)return;
                var id=prf.getDomId()+"cssnode",
                    prop=prf.properties,
                    root=prf.getRoot(),
                    css=ns._getCon(prf);

                root.query('style').remove(false);

                xui.Dom._setClass(root.get(0), prop.className);
                if(css)xui.CSS._appendSS(root.get(0), css, id,false);
            });
        },
        EventHandlers:{
            beforeInputAlert:null,
            onContextmenu:null,
            onClick:null,
            onDock:null,
            onLayout:null,
            onMove:null,
            onRender:null,
            onResize:null,
            onShowTips:null,
            beforeHoverEffect:null,
            beforeAppend:null,
            afterAppend:null,
            beforeRender:null,
            afterRender:null,
            beforeRemove:null,
            afterRemove:null,
            onHotKeydown:null,
            onHotKeypress:null,
            onHotKeyup:null
        }
    }
});

xui.Class("xui.UI.MoudluePlaceHolder", "xui.UI.Div",{
    Instance:{
        destroy:function(ignoreEffects, purgeNow){
            var o=this.get(0);
            if(!o)return;
            (o.$afterDestroy=(o.$afterDestroy||{}))["destroyAttachedModule"]=function(){
                if(!this._replaced && this._module){
                    this._module.destroy(ignoreEffects, purgeNow);
                }
            };
            return arguments.callee.upper.apply(this,[ignoreEffects, purgeNow]);
        },
        adjustDock:null,
        draggable:null,
        busy:null,
        free:null,
        // for Module
        setProperties:function(key,value){
            var self=this.get(0);
            if(!self._properties)self._properties={};
            if(!key)self._properties={};
            else if(typeof key=='string') self._properties[key]=value;
            else xui.merge(self._properties, key, 'all');
            return this;
        },
        getValue:function(){
            return xui.get(this.get(0), ['_properties','value']);
        },
        setValue:function(value){
            xui.set(this.get(0), ['_properties','value'],value);
            return this;
        },
        getUIValue:function(){
            return this.get(0)._$UIvalue;
        },
        setUIValue:function(value){
            this.get(0)._$UIvalue=value;
            return this;
        },
        getProperties:function(key){
            var self=this.get(0);
            if(!self._properties)self._properties={};
            return key?self._properties[key]:self._properties;
        },
        setEvents:function(key,value){
            var self=this.get(0);
            if(!self._events)self._events={};
            if(!key)
                self._events={};
            else if(typeof key=='string')
                self._events[key]=value;
            else
                xui.merge(self._events, key, 'all');
            return this;
        },
        getEvents:function(key){
            var self=this.get(0);
            if(!self._events)self._events={};
            return key?this._events[key]:this._events;
        },
        replaceWithModule:function(module){
            var self=this,
                prf=self.get(0),
                m,t,parent,subId;

            if(!prf || prf.destroyed || prf._replaced || !prf.getRootNode())return;
            prf._replaced=1;

            if(prf.$beforeReplaced)prf.$beforeReplaced.call(module);
            // host and alias
            if(prf.host || prf.alias)module.setHost(prf.host, prf.alias);
            if('_$UIvalue' in prf)module.$UIvalue=prf._$UIvalue;
            if(t=prf._events)module.setEvents(t);
            if(t=prf._properties)module.setProperties(t);
            // maybe in other module
            if(prf.moduleClass && prf.moduleXid){
                if(m = xui.Module.getInstance(prf.moduleClass, prf.moduleXid)){
                    m.AddComponents(module);
                }
            }
            if(parent = prf.parent){
                subId = prf.childrenId;
                module.show(function(){
                    if(prf.$afterReplaced)prf.$afterReplaced.call(module);
                    // Avoid being removed from host
                    prf.alias=null;
                    prf._module=null;
                    if(prf.box)prf.boxing().destroy();
                },parent,subId);
            }else if(prf.rendered && (parent = prf.getRoot().parent()) && !parent.isEmpty()){
                module.show(function(){
                    if(prf.$afterReplaced)prf.$afterReplaced.call(module);
                    // Avoid being removed from host
                    prf.alias=null;
                    prf._module=null;
                    if(prf.box)prf.boxing().destroy();
                },parent);
            }

            if(prf.$afterReplaced)prf.$afterReplaced.call(module);
            // Avoid being removed from host
            prf.alias=null;
            prf._module=null;
            self.destroy();
        }
    },
    Static:{
        Templates:{
            tagName:'div',
            style:'left:0;top:0;width:0;height:0;visibility:hidden;display:none;position:absolute;z-index:0;'
        },
        DataModel:{
            showEffects:null,
            hideEffects:null,
            activeAnim:null,
            hoverPop:null,
            hoverPopType:null,
            dock:null,
            dockStretch:null,
            renderer:null,
            html:null,
            disableClickEffect:null,
            disableHoverEffect:null,
            disableTips:null,
            disabled:null,
            defaultFocus:null,
            dockStretch:null,
            dockIgnore:null,
            dockOrder:null,
            dockMargin:null,
            dockFloat:null,
            dockMinW:null,
            dockMinH:null,
            dockMaxW:null,
            dockMaxH:null,
            tips:null
        },
        EventHandlers:{
            onContextmenu:null,
            onDock:null,
            onLayout:null,
            onMove:null,
            onRender:null,
            onResize:null,
            onShowTips:null,
            beforeAppend:null,
            afterAppend:null,
            beforeRender:null,
            afterRender:null,
            beforeRemove:null,
            afterRemove:null,
            onHotKeydown:null,
            onHotKeypress:null,
            onHotKeyup:null
        },
        // for parent UIProfile toHtml case
        RenderTrigger:function(){
            var prf=this;
            if(prf && !prf._replaced && prf._module){
                prf.boxing().replaceWithModule(prf._module);
            }
        }
    }
});

xui.Class("xui.AnimBinder","xui.absObj",{
    Instance:{
        _ini:xui.Timer.prototype._ini,
        _after_ini:function(profile,ins,alias){
             if(!profile.name)profile.Instace.setName(alias);
        },
        getParent:xui.Timer.prototype.getParent,
        getChildrenId:xui.Timer.prototype.getChildrenId,
        destroy:function(){
            this.each(function(profile){
                var box=profile.box,name=profile.properties.name;
                //delete from pool
                delete box._pool[name];
                //free profile
                profile.__gc();
            });
        },
        setHost:function(value, alias){
            var self=this;
            if(value && alias)
                self.setName(alias);
            return arguments.callee.upper.apply(self,arguments);
        },
        apply:function(node, onEnd){
            var prf=this.get(0), fs=prf.properties['frames'], arr=[], frame, frame1, frame2, endpoints;
            for(var i=0,l=fs.length;i<l-1;i++){
                endpoints={};
                frame1 = fs[i];
                frame2 = fs[i+1];
                frame = xui.copy(frame2);
                delete frame.status;
                for(var j in frame2.status)endpoints[j]=frame2.status[j];
                frame.endpoints=endpoints;
                frame['start']=frame1;
                frame['end']=frame2;
                arr.push(frame);
            }
            var fun = function(){
                if(!arr.length){
                    if(prf.onEnd)prf.boxing().onEnd(prf);
                    if(xui.isFun(onEnd))xui.tryF(onEnd);
                    return ;
                }
                var frame = arr.shift();
                if(prf.beforeFrame&&false===prf.boxing().beforeFrame(prf, frame))return;

                return xui(node).animate(frame.endpoints, null, fun, frame.duration, frame.step, frame.type, null, null, frame.restore, frame.times).start();
            };
            return fun();
        }
    },
    Static:{
        _objectProp:{tagVar:1,propBinder:1,"frames":1},
        _beforeSerialized:xui.Timer._beforeSerialized,
        $nameTag:"ani_",
        _pool:{},
        destroyAll:function(){
            this.pack(xui.toArr(this._pool,false),false).destroy();
            this._pool={};
        },
        getFromName:function(name){
            var o=this._pool[name];
            return o && o.boxing();
        },
        DataModel:{
            dataBinder:null,
            dataField:null,
            "name":{
                set:function(value){
                    var o=this,
                        ovalue=o.properties.name,
                        c=o.box,
                        _p=c._pool,
                        _old=_p[ovalue],
                        _new=_p[value],
                        ui;

                    //if it exists, overwrite it dir
                    //if(_old && _new)
                    //    throw value+' exists!';

                    _p[o.properties.name=value]=o;

                    //pointer _old the old one
                    if(_new && !_old) o._n=_new._n;
                    //delete the old name from pool
                    if(_old)delete _p[ovalue];
                }
            },
            "frames":{
                ini:[]
            }
        },
        EventHandlers:{
            beforeFrame:function(profile, frame){},
            onEnd:function(profile){}
        }
    }
});xui.Class("xui.UI.Image", "xui.UI",{
    Initialize:function(){
        var ns=this;
        ns._adjustItems = xui.absList._adjustItems;
        ns.prototype._prepareItems  = function(a){return a;};
    },
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        },
        getRate:function(){
            return parseFloat(this.get(0)._rate) || 1;
        }
    },
    Static:{
        IMGNODE:1,
        Templates:{
            tagName:'img',
            style:'cursor:{cursor};{_style}',
            className:'{_className}',
            border:"0",
            src:xui.ini.img_bg,
            alt:"{alt}"
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY'},
            ClickEffected:{KEY:'KEY'},
            DraggableKeys:["KEY"],
            onError:function(profile, e, src){
                profile.boxing().onError(profile);
            },
            onLoad:function(profile, e, src){
                var img=xui.use(src).get(0),path;
                // for IE8 bug
                try{path=img.src;}catch(e){
                    return;
                }
                if(path!=xui.ini.img_bg){
                    var i=new Image();
                    i.onload=function(){
                        if(!profile||profile.destroyed)return;
                        var prop=profile.properties,
                            size=profile.box._adjust(profile, (prop.width===""||prop.width=="auto")?i.width:prop.width, (prop.height===""||prop.height=="auto")?i.height:prop.height);
                        if(profile.$afterLoad)profile.$afterLoad.apply(profile.host, [profile, path, size[0], size[1]]);
                        profile.boxing().afterLoad(profile, path, size[0], size[1]);
                        if(prop.dock!='none')
                            profile.boxing().adjustDock();
                       i.onload=null;
                    }
                    // must after onload for IE<8 fix
                    i.src=path;
                   xui.Dom.fixPng(img);
                }
            },
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            },
            onDblclick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onDblclick)
                    profile.boxing().onDblclick(profile, e, src);
            }
        },
        RenderTrigger:function(){
            var self=this, pro=self.properties,
                  v=pro.src, v2=pro.activeItem;
            if(v2 && -1!=xui.arr.subIndexOf(pro.items,"id",v2)){
                self.boxing().setActiveItem(v2, true);
            }else if(v)self.boxing().setSrc(v, v!=xui.ini.img_bg);
        },
        EventHandlers:{
            onClick:function(profile, e, src){},
            onDblclick:function(profile, e, src){},
            onError:function(profile){},
            beforeLoad:function(profile){},
            afterLoad:function(profile, path, width, height){}
        },
        _adjust:function(profile,width,height){
            var prop=profile.properties,
                src=profile.getRootNode(),
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)};

            width=width?profile.$px(width, null, true):width;
            height=height?profile.$px(height, null, true):height;

            src.style.width=src.style.height='';
            if(width>0 && height>0){
                var r1=prop.maxWidth/width, 
                    r2=prop.maxHeight/height,
                    r= r1<r2?r1:r2;
                if(r>=1)r=1;
                profile._rate=r;
                return [src.width=width*r, src.height=height*r];
            }
            return [0,0];
        },
        DataModel:{
            maxWidth:{
                ini:800,
                action:function(v){
                    var src=this.getRootNode(),prop=this.properties;
                    this.box._adjust(this, (prop.width===""||prop.width=="auto")?src.width:prop.width, (prop.height===""||prop.height=="auto")?src.height:prop.height);
                }
            },
            maxHeight:{
                ini:600,
                action:function(v){
                    var src=this.getRootNode(),prop=this.properties;
                    this.box._adjust(this, (prop.width===""||prop.width=="auto")?src.width:prop.width, (prop.height===""||prop.height=="auto")?src.height:prop.height);
                }
            },
            width:{
                ini:'auto',
                action:function(v){
                    var src=this.getRootNode(),
                        prop=this.properties,
                        i=new Image();
                    i.src=src.src;
                    this.box._adjust(this, (v===""||v=="auto")?i.width:v, (prop.height===""||prop.height=="auto")?i.height:prop.height);
                }
            },
            height:{
                ini:'auto',
                action:function(v){
                    var src=this.getRootNode(),
                        prop=this.properties,
                        i=new Image();
                    i.src=src.src;
                    this.box._adjust(this, (prop.width===""||prop.width=="auto")?i.width:prop.width, (v===""||v=="auto")?i.height:v);
                }
            },
            src:{
                format:'image',
                ini:xui.ini.img_bg,
                linkage:["activeItem"],
                //use asyn mode
                action:function(v){
                    var self=this;
                    if(false!==self.boxing().beforeLoad(this))
                        xui.asyRun(function(){self.getRoot().attr({width:'0',height:'0',src:xui.adjustRes(v)})});
                    if(!self.$inner)
                        self.properties.activeItem="";
                }
            },
            alt:{
                ini:"",
                action:function(v){
                    this.getRoot().attr('alt',v);
                }
            },
            items:{
                ini:[]
            },
            activeItem:{
                ini:"",
                linkage:["src","alt","tips"],
                action:function(v){
                    var items=this.properties.items,
                        i=xui.arr.subIndexOf(items,"id",""+v),
                        item,ins=this.boxing(),
                        src,alt,tips;
                    if((i!=-1) && (item=items[i])){
                        src=item.image||xui.ini.img_bg;
                        alt=item.alt||"";
                        tips=item.tips||"";
                    }
                    this.$inner=1;
                    ins.setSrc(src||xui.ini.img_bg, true);
                    delete this.$inner;
                    ins.setAlt(alt||"");
                    ins.setTips(tips||"");
                }
            },
            cursor:{
                ini:"auto",
                combobox:["","default","text","pointer","move","crosshair","wait","help","e-resize","ne-resize","nw-resize","n-resize","se-resize","sw-resize","s-resize","w-resize"],
                action:function(v){
                    this.getRoot().css('cursor',v);
                }
            }
        }
    }
});xui.Class("xui.UI.Flash", "xui.UI",{
    Instance:{
        refreshFlash:function(){
            var html='', cls=this.constructor;
            return this.each(function(profile){
                xui.resetRun(profile.domId,function(){
                    // clear first
                    cls._clearMemory(profile);
    
                    // build and set flash
                    if(profile.properties.src)
                        cls._drawSWF(profile);
                });
            });
        },
        // Return the flash object
        getFlash:function(){
            return this.constructor._getSWF(this.get(0));
        }
    },
    Static:{
        Appearances:{
            KEY:{
                overflow:'hidden'
            },
            BOX:{
                position:'absolute',
                left:0,
                top:0,
                'z-index':1
            },
            COVER:{
                position:'absolute',
                left:'-1px',
                top:'-1px',
                width:0,
                height:0,
                'z-index':4
            }
        },
        Templates:{
            tagName:'div',
            className:'{_className}',
            style:'{_style}',
            BOX:{
                tagName:'div'
            },
            COVER:{
                tagName:'div',
                style:"background-image:url("+xui.ini.img_bg+");"
            }
        },
        Behaviors:{
            onSize:xui.UI.$onSize
        },
        DataModel:{
            selectable:true,
            width:{
                $spaceunit:1,
                ini:'30em'
            },
            height:{
                $spaceunit:1,
                ini:'25em'
            },
            cover:false,
            src:{
                format:'media',
                ini:'',
                action:function(v){
                    this.boxing().refreshFlash();
                }
            },
            parameters:{
                ini:{},
                action:function(v){
                    this.boxing().refreshFlash();
                }
            },
            flashvars:{
                ini:{},
                action:function(v){
                    this.boxing().refreshFlash();
                }
            }
        },
        RenderTrigger:function(){
            (this.$beforeDestroy=(this.$beforeDestroy||{}))["flashClearMem"]=function(){
                if(this.box)
                    this.box._clearMemory(this);
            };
            // add swf
            this.boxing().refreshFlash();
        },
        getFlashVersion:function(){
          if(xui.browser.ie){
            try {
              var axo = new ActiveXObject('ShockwaveFlash.ShockwaveFlash.6');
              try{axo.AllowScriptAccess='always'}catch(e){return '6,0,0'}
            }catch(e){}finally{
                try{
                    return new ActiveXObject('ShockwaveFlash.ShockwaveFlash').GetVariable('$version').replace(/\D+/g, ',').match(/^,?(.+),?$/)[1];
                }catch(e){}
            }
          }else{
            try {
              if(navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin){
                return (navigator.plugins["Shockwave Flash 2.0"] || navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g, ",").match(/^,?(.+),?$/)[1];
              }
            }catch(e){}
          }
          return '0,0,0';
        },
        _getSWF:function(profile){
            var id= xui.isStr(profile)?profile:(this._idtag + profile.serialId);
            return (xui.browser.ie ? window[id] : ((document.embeds && document.embeds[id])||window.document[id])) || document.getElementById(id);
        }, 
        _clearMemory:function(profile){
            var id=this._idtag + profile.serialId;
            var _e=xui.fun(), chart = profile.box._getSWF(profile);
            if(chart){
                chart.style.display = 'none';
                if(xui.browser.ie){
                    for(var x in chart )
                        if(typeof chart[x]=='function')
                            chart[x]=_e;                        
                    if(window[id])
                        window[id]=undefined;
                }else{
                    if(document.embeds && document.embeds[id])
                        document.embeds[id]=undefined;
                    if(window.document[id])
                        window.document[id]=undefined;
                }
               chart=_e=null;
            }
        }, 
        _drawSWF:function(profile){
            var ns=this;
            var prop=profile.properties,
                serialId=profile.serialId,
                src=xui.adjustRes(prop.src),
                parameters=prop.parameters,
                options = xui.copy(prop.flashvars),
                xml="";

            options.DOMId = profile.box._idtag + profile.serialId;
            options.chartWidth=prop.width;
            options.chartHeight=prop.height;

            if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){
                xml += '<embed type="application/x-shockwave-flash" src="'+ src +'?'+xui.urlEncode(parameters)+'" ';
                xml += 'width="'+prop.width+'" height="'+prop.height+'" ';
                xml += 'id="'+ options.DOMId +'" name="'+ options.DOMId +'" ';
                xml += 'wmode="opaque" ';
                xml += 'flashvars="'+ xui.urlEncode(options) +'" ';
                xml +=  '/>';
            }else{
                xml += '<object id="'+ options.DOMId +'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" '
                xml += 'width="'+prop.width+'" height="'+prop.height+'">';
                xml += '<param name="movie" value="'+ src +'?'+xui.urlEncode(parameters)+'" />';
                xml += '<param name="wmode" value="opaque" />';
                xml += '<param name="flashvars" value="'+ xui.urlEncode(options) +'" />';
                xml += '</object>';
            }
            profile.getSubNode('BOX').html(xml, false);
        },
        _onresize:function(profile,width,height){
            var prop=profile.properties,
                us=xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                size = profile.getSubNode('BOX').cssSize(),

                // caculate by px
                ww=width?profile.$px(width):width, 
                hh=height?profile.$px(height):height;

            if( (width && !xui.compareNumber(size.width,ww,6)) || (height && !xui.compareNumber(size.height,hh,6)) ){
                // reset here
                if(width)prop.width=adjustunit(ww);
                if(height)prop.height=adjustunit(hh);

                size={
                    width:width?prop.width:null,
                    height:height?prop.height:null
                };
                profile.getSubNode('BOX').cssSize(size,true);
                if(profile.$inDesign || prop.cover){
                    profile.getSubNode('COVER').cssSize(size,true);
                }
                profile.boxing().refreshFlash();
            }
        }
    }
});xui.Class("xui.UI.Audio", "xui.UI",{
    Instance:{
        play:function(){
            var v = this.getSubNode("H5"), vn = v.get(0);if(vn&&this.getSrc())vn.play();
        },
        pause:function(){
            var v = this.getSubNode("H5"), vn = v.get(0);if(vn&&this.getSrc())vn.pause();
        },
        load:function(){
            var v = this.getSubNode("H5"), vn = v.get(0);if(vn&&this.getSrc())vn.load();
        },
        canPlayType:function(type){
            var v = this.getSubNode("H5"), vn = v.get(0);if(vn) return vn.canPlayType(type);
        }
    },
    Static:{
        Appearances:{
            KEY:{
                overflow:'hidden'
            },
            H5:{
                position:'absolute',
                left:0,
                top:0,
                'z-index':1
            },
            COVER:{
                position:'absolute',
                left:'-1px',
                top:'-1px',
                width:0,
                height:0,
                'z-index':4
            }
        },
        Templates:{
            tagName:'div',
            className:'{_className}',
            style:'{_style}',
            H5:{
                tagName:'audio',
                crossOrigin:  'anonymous',
                autoplay:'{_autoplay}',
                controls:'{_controls}',
                loop:'{_loop}',
                muted:'{_muted}',

                preload:'{preload}',
                volume:'{volume}',
                src:'{src}',
                text:'Your browser does not support the audio element.'
            },
            COVER:{
                tagName:'div',
                style:"background-image:url("+xui.ini.img_bg+");"
            }
        },
        Behaviors:{
            HotKeyAllowed:false,
            onSize:xui.UI.$onSize
        },
        DataModel:{
            selectable:true,
            width:{
                $spaceunit:1,
                ini:'18em'
            },
            height:{
                $spaceunit:1,
                ini:'5em'
            },
            src:{
                format:'media',
                ini:'',
                action:function(v){
                    this.getSubNode("H5").attr("src", xui.adjustRes(v));
                }
            },
            cover:false,
            controls:{
                ini: true,
                action:function(v){
                    this.getSubNode("H5").attr("controls", v?'controls':null);
                }
            },
            preload:{
                ini: "none",
                listbox:["none", "metadata", "auto" ],
                action:function(v){
                    this.getSubNode("H5").attr("preload", (!v||v=='none')?null:v);
                }
            },
            loop:{
                ini: false,
                action:function(v){
                    this.getSubNode("H5").attr("loop", v?'loop':null);
                }
            },
            muted:{
                ini: false,
                action:function(v){
                    this.getSubNode("H5").attr("muted", v?'muted':null);
                }
            },
            volume:{
                ini: 1,
                action:function(v){
                    this.getSubNode("H5").attr("volume", v);
                }
            },
            autoplay:{
                ini: false,
                action:function(v){
                    this.getSubNode("H5").attr("autoplay", v?'autoplay':null);
                }
            }
        },
        RenderTrigger:function(){
            var prf = this,
                H5 = prf.getSubNode('H5'),
                prop = prf.properties,
                ef = function(){
                    if(prf.onMediaEvent){
                        prf.boxing().onMediaEvent(prf, event,  arguments);
                    }
                },t;
   
            xui.arr.each("loadstart progress durationchange seeked seeking timeupdate playing canplay canplaythrough volumechange ratechange loadedmetadata loadeddata play pause ended".split(" "), function(event, i){
                if(i = H5&&H5.get(0)){
                    if(i.addEventListener){
                        i.addEventListener(event, ef,false);
                    }else if(i.attachEvent){
                        i.attachEvent(event, ef);
                    }                
                }
            });
            
            (prf.$beforeDestroy=(prf.$beforeDestroy||{}))["detachEvents"]=function(){
                xui.arr.each("loadstart progress durationchange seeked seeking timeupdate playing canplay canplaythrough volumechange ratechange loadedmetadata loadeddata play pause ended".split(" "),function(event, i){
                    if(i=H5&&H5.get(0)){
                        if(i.removeEventListener){
                            i.removeEventListener(event, ef, false);  
                        }else if(i.detachEvent){
                            i.detachEvent(event, ef);
                        }
                    }   
                });
            };

            if(!prop.controls)H5.attr("controls",null);
            if(!prop.loop)H5.attr("loop",null);
            if(!prop.muted)H5.attr("muted",null);

            if(!prop.autoplay)H5.attr("autoplay",null);
            else xui.asyRun(function(t){
                if(prf.$inDesign)return;
                if(prop.src && xui.isStr(prop.src) && (t=H5.get(0)))t.play();}
            );
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            if(data.autoplay)data._autoplay = "autoplay";
            if(data.controls)data._controls = "controls";
            if(data.loop)data._loop = "loop";
            if(data.muted)data._muted = "muted";
            return data;
        },
        EventHandlers:{
            onMediaEvent:function(profile, eventType, params){}
        },
        _onresize:function(profile,width,height){
            var H5=profile.getSubNode('H5'), 
                size=H5.cssSize(),
                prop=profile.properties,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                // caculate by px
                ww=width?profile.$px(width):width, 
                hh=height?profile.$px(height):height;

            if( (width && !xui.compareNumber(size.width,ww,6)) || (height && !xui.compareNumber(size.height,hh,6)) ){
                // reset here
                if(width){
                    H5.attr("width", ww).width(prop.width=adjustunit(ww));
                }
                if(height){
                    H5.attr("height", hh).height(prop.height=adjustunit(hh));
                }
                if(profile.$inDesign || prop.cover){
                    profile.getSubNode('COVER').cssSize({
                        width:width?prop.width:null,
                        height:height?prop.height:null
                    },true);
                }
            }
        }
    }
});xui.Class("xui.UI.Video", "xui.UI.Audio",{
    Instance:{
    },
    Static:{
        Templates:{
            tagName:'div',
            crossOrigin:  'anonymous',
            className:'{_className}',
            style:'{_style}',
            H5:{
                tagName:'video',
                autoplay:'{_autoplay}',
                controls:'{_controls}',
                loop:'{_loop}',
                muted:'{_muted}',

                preload:'{preload}',
                volume:'{volume}',
                src:'{src}',

                width:'{width}',
                height:'{height}',
                text:'Your browser does not support the audio element.'
            },
            COVER:{
                tagName:'div',
                style:"background-image:url("+xui.ini.img_bg+");"
            }
        },
        DataModel:{
            width:{
                $spaceunit:1,
                ini:'34em'
            },
            height:{
                $spaceunit:1,
                ini:'25em'
            },
            poster:{
                format:'image',
                ini: '',
                action:function(v){
                    this.getSubNode("H5").attr("poster", v||null);
                }
            }
        },
        RenderTrigger:function(){
            var prf=this,
                H5 = prf.getSubNode('H5'),
                prop = prf.properties,
                t;
            if(t=prop.poster)H5.attr("poster",t);
        }
    }
});//resizer class, add a plug in to xui.Dom
xui.Class("xui.UI.Resizer","xui.UI",{
    Instance:{
        _attachTo:function(target, parent){
            var self=this, v=self.get(0);

            //set target first
            v._target= xui(target);
            v._parent= parent || xui('body');

            //add to dom
            v._parent.append(self);

            v.$resizeId = xui(target).id();

            return self;
        },
        show:function(){
            var self=this;
            self.each(function(o){
                o.getRoot().css('display','');
            });
            if(xui.browser.ie)
                self.reBoxing().ieRemedy();
            return self;
        },
        hide:function(){
            var self=this;
            self.reBoxing().css('display','none');
            return self;
        }
    },
    Initialize:function(){
        this.addTemplateKeys(['HANDLER','HIDDEN','MOVE','CONF1','CONF2','ROTATE','L','R','T','B','LT','RT','LB','RB','REGION']);
        xui.each({
            // add resizer to xui.Dom plugin
            addResizer:function(properties, onUpdate, onChange){
                var target=xui([this.get(0)]);
                properties=properties||{};
                xui.merge(properties,{
                    _attached:true
                });

                var r = new xui.UI.Resizer(properties)._attachTo(target, target);

                //set event
                if(onUpdate) r.onUpdate(onUpdate);
                if(onChange) r.onChange(onChange);
                return r;
            },
            removeResizer:function(){
                var s = this.id();
                xui.arr.each(xui.UI.Resizer._cache,function(o){
                    if(o && o.$resizeId==s)
                        o.boxing().destroy(true);
                });
                return this;
            },
            $getResizer:function(){
                var s = this.id(), b;
                xui.arr.each(xui.UI.Resizer._cache,function(o){
                    if(o && o.$resizeId==s){b=o;return false;}
                });
                return b && b.boxing();
            }
        },function(o,i){
            xui.Dom.plugIn(i,o);
        });

        //for xui.UI.Widget
        xui.each({
            _resizer:function(key, args){
                return this.each(function(o){
                    var target = o.getSubNode('BORDER'),
                        d = o.properties;
                    if(target.$getResizer())return;
                    args = args || {};
                    var update = function(pro, target, size, cssPos){
                        var profile=arguments.callee.profile,
                            node=profile.getRoot(),
                            instance=profile.boxing(),
                            prop=profile.properties,
                            svg=profile.box['xui.svg'],
                            t;
                        if(size){
                            var w=null,h=null,l=null,t=null;
                            if(t=size.width){
                                node.widthBy(t);
                                prop.width = w = profile.$forceu(svg?instance.getWidth():node.width());
                            }
                            if(t=size.height){
                                node.heightBy(t);
                                prop.height = h = profile.$forceu(svg?instance.getHeight():node.height());
                            }
                            xui.UI.$tryResize(profile,w,h,true);

                            // for no _onresize widget only
                            if(!profile.box._onresize && profile.onResize && (w!==null||h!==null))
                                instance.onResize(profile,w,h);
                        }
                        if(cssPos){
                            if((t=cssPos.left) && !(prop.left=='auto'&&Math.round(parseFloat(prop.right))>=0)){
                                node.leftBy(t);
                                prop.left= l = profile.$forceu(svg?instance.getLeft():node.left());
                            }
                            if((t=cssPos.top) && !(prop.top=='auto'&&Math.round(parseFloat(prop.bottom))>=0)){
                                node.topBy(t);
                                prop.top = t = profile.$forceu(svg?instance.getTop():node.top());
                            }
                            if(profile.onMove && (l!==null||t!==null))
                                instance.onMove(profile,l,t,null,null);
                        }
                        return false;
                    };
                    update.profile = o;

                    o.$resizer = target.addResizer(args, update);

                    o.$resizer.get(0).$parentUIProfile=o;
                    
                    // hide resizer
                    if(d.visibility=='hidden'){
                        o.$resizer.hide();
                    }
                });
            },
            _unResizer:function(){
                return this.each(function(o){
                    var target = o.getSubNode('BORDER');
                    if(!target.$getResizer())return;
                    target.removeResizer();
                    delete o.$resizer;
                });
            }
        },function(o,i){
            xui.UI.Widget.plugIn(i,o);
        });
        xui.UI.Widget.setDataModel({
            resizer:{
                ini:false,
                action: function(v){
                    var b=this.boxing();
                    if(v){
                        var t = this.properties,
                            arg={};
                        xui.each('minHeight,minWidth,maxHeight,maxWidth'.split(','),function(i){
                            if(i in t)arg[i]=t[i];
                        });
                        
                        if(t.resizerProp && !xui.isEmpty(t.resizerProp)){
                            xui.merge(arg,t.resizerProp,'all');
                        }
                        if(t.tagVar.resizerProp){
                            xui.merge(arg,t.tagVar.resizerProp,'all');
                        }
                        b._resizer(v,arg);
                        if(this.$inDesign){
                            this.$resizer.get(0).$inDesign=1;
                        }
                    }else
                        b._unResizer();
                }
            },
            resizerProp:{
                ini:{}
            }
        });
    },
    Static:{
        Templates:{
            tagName:'div',
            className:'{_disabled}',
            style:'{_style};'
        },
        Appearances:{
            KEY:{
                position:'absolute',
                margin:'0 -1px -1px 0',
                visibility: 'visible',

                //for ie
                background: (xui.browser.ie&&!xui.browser.newie)?('url('+xui.ini.img_bg+')'):'',
                /*for get top Index, when it's static*/
                'z-index':60,
                cursor:'move'
            },
            "KEY.readonly, KEY.disabled":{
                background: "url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' preserveAspectRatio='none' viewBox='0 0 400 400'><rect x='0' y='0' width='400' height='400' stroke='#666666' fill='#bbbbbb' opacity='0.3' stroke-width='1'></rect><path d='M400 0 L0 400 ' stroke='#666666' stroke-width='1'/><path d='M0 0 L400 400 ' stroke='#666666' stroke-width='1'/></svg>\")",
                'background-repeat':'no-repeat',
                'background-position':'center center',
                'background-size':'100% 100%, auto'
            },
            "KEY.readonly.active, KEY.disabled.active":{
                background: "url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' preserveAspectRatio='none' viewBox='0 0 400 400'><rect x='0' y='0' width='400' height='400' stroke='#666666' fill='#eeeeee' opacity='0.3' stroke-width='1'></rect><path d='M400 0 L0 400 ' stroke='#666666' stroke-width='1'/><path d='M0 0 L400 400 ' stroke='#666666' stroke-width='1'/></svg>\")"
            },
            "KEY.readonly div, KEY.disabled div":{
                display:'none'
            },
            "KEY.readonly CONF1, KEY.readonly CONF2":{
                $order:10,
                opacity: 1,
                display:'block'
            },
            MOVE:{
                position:'absolute',
                display:'block',
                'z-index':100,
                visibility: 'visible'
            },
            'CONF1, CONF2, ROTATE':{
                position:'absolute',
                display:'block',
                'z-index':100,
                visibility: 'visible',
                cursor:'pointer'
            },
            ROTATE:{
                $order:1,
                cursor:'crosshair'
            },
             HANDLER:{
                $order:0,
                position:'absolute',
                display:'block',
                border:'solid 1px',
                'z-index':100,
                visibility: 'visible'
            },
            T:{
               $order:1,
               left:'50%',
               cursor: 'n-resize'
            },
            RT:{
               $order:1,
               cursor: 'ne-resize',
               'z-index': 110
            },
            R:{
               $order:1,
               top:'50%',
               cursor: 'e-resize'
            },
            RB:{
               $order:1,
                cursor: 'se-resize',
                'z-index': 110
            },
            B:{
               $order:1,
                left:'50%',
                cursor: 's-resize'
            },
            LB:{
               $order:1,
                cursor: 'sw-resize',
                'z-index': 110
            },
            L:{
               $order:1,
                top:'50%',
                cursor: 'w-resize'
            },
            LT:{
               $order:1,
                cursor: 'nw-resize',
                'z-index': 110
            },
            //must after HANDLER
            HIDDEN:{
                $order:10,
                'background-color':'transparent',
                'border-width': 0
            }
        },
        Behaviors:{
            beforeMousedown:function(profile, e, src){
                if(profile.properties.readonly||profile.properties.disabled)return false;
                profile.box._onMousedown(profile, e, src, "move");
            },
            onDragbegin:function(profile, e, src){
                if(profile.properties.readonly||profile.properties.disabled)return false;
                profile.box._onDragbegin(profile, e, src,"move");
            },
            onDrag:function(profile, e, src){
                profile.box._onDrag(profile, e, src, "move");
            },
            onDragstop:function(profile, e, src){
                profile.box._onDragstop(profile, e, src, "move");
            },
            onDblclick:function(profile, e, src){
                if(profile.onDblclick)profile.boxing().onDblclick(profile, e, src);
            },
            CONF1:{
                onMouseover:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src, 'left','mouseover');
                    return false;
                },
                onMousedown:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src,'left','mousedown');
                    return false;
                },
                onClick:function(profile,e,src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src,'left','click');
                    return false;
                }
            },
            CONF2:{
                onMouseover:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src,'right','mouseover');
                    return false;
                },
                onMousedown:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src,'right','mousedown');
                    return false;
                },
                onClick:function(profile,e,src){
                    if(profile.properties.disabled)return false;
                    if(profile.onConfig)
                        return profile.boxing().onConfig(profile,e,src,'right','click');
                    return false;
                }
            },
            ROTATE:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src, "rotate");
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src, "rotate");
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src, "rotate");
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src, "rotate");
                } 
            },
            LT:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src,'nw');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'nw');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src, 'nw');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src, 'nw');
                }
            },
            RT:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src, 'ne');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src, 'ne');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src, 'ne');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src, 'ne');
                }
            },
            LB:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src, 'sw');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src, 'sw');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src, 'sw');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src, 'sw');
                }
            },
            RB:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src, 'se');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'se');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src, 'se');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src, 'se');
                }
            },
            L:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src, 'w');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'w');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src,'w');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src,'w');
                }
            },
            T:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src,'n');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'n');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src,'n');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src,'n');
                }
            },
            R:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src,'e');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'e');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src,'e');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src,'e');
                }
            },
            B:{
                beforeMousedown:function(profile, e, src){
                    profile.box._onMousedown(profile, e, src,'s');
                    return false;
                },
                onDragbegin:function(profile, e, src){
                    profile.box._onDragbegin(profile, e, src,'s');
                },
                onDrag:function(profile, e, src){
                    profile.box._onDrag(profile, e, src,'s');
                },
                onDragstop:function(profile, e, src){
                    profile.box._onDragstop(profile, e, src,'s');
                }
            }
        },
        DataModel:{
            // attached to a dom node for resizer function.
            _attached:false,

//<< can be used in addResizer({*})
            // handler visible?
            forceVisible:false,
            // movable
            forceMovable:'',

            // only show right/bottom handlers
            singleDir:false,
            // can change width
            vertical :true,
            // can chang height
            horizontal :true,

            minHeight: 12,
            minWidth: 12,
            maxHeight: 5000,
            maxWidth: 5000,

            // with px (base: 1em=12px)
            handlerSize: xui.browser.contentBox?8:12,
            // border 1
            handlerOffset: xui.browser.contentBox?1:0,
            readonly:{
                ini:false,
                action:function(v){
                     if(v)this.getRoot().addClass("readonly");
                     else this.getRoot().removeClass("readonly");
                }
            },
            disabled:{
                ini:false,
                action:function(v){
                     if(v)this.getRoot().addClass("disabled");
                     else this.getRoot().removeClass("disabled");
                }
            },
            leftConfigBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('CONF1').css('display',v?'':'none');
                }
            },
            rightConfigBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('CONF2').css('display',v?'':'none');
                }
            },
            rotatable:{
                ini:false,
                action:function(v){
                    if(v && xui.browser.ie&&xui.browser.ver<=8)
                        v = false;
                    this.getSubNode('ROTATE').css('display',v?'':'none');
                }
            },
//>>

            left: 100,
            top: 100,
            height: 100,
            width: 100,
            position:'absolute',
            display:'block'
        },
        EventHandlers:{
            onDblclick:function(profile, e, src){},
            onUpdate:function(profile, target, size, cssPos, rotate){},
            onChange:function(profile, proxy){},
            onConfig:function(profile, e, src,pos,type){}
        },
        _dynamicTemplate:function(profile){
            var pro = profile.properties,size,pos,temp,
                hash = profile._exhash =
                    "$" +
                    '_attached:' + pro._attached + ';' +
                    'forceVisible:' + pro.forceVisible + ';' +
                    'singleDir:' + pro.singleDir + ';' +
                    'vertical:' + pro.vertical + ';' +
                    'horizontal:' + pro.horizontal + ';' +
                    'forceMovable:' + pro.forceMovable + ';'
            ;

            var map= arguments.callee.map || (arguments.callee.map={
                //move icon size 13*13
                MOVE: {tagName:'div', className:'xuifont',$fonticon:'xui-icon-dragmove', style:'font-size: 1.5em;top:50%;left:50%;margin-left:-0.5em;margin-top:-0.5em;'},
                CONF1:{tagName:'div', className:'xuifont',$fonticon:'xui-icon-star', style:'font-size: 1.5em;top:-1.125em;left:-1.125em;{_leftCofigBtn};'},
                CONF2:{tagName:'div', className:'xuifont',$fonticon:'xui-uicmd-opt', style:'font-size: 1.5em;top:-1.125em;left:auto;right:-1.125em;{_rightCofigBtn};'},
                ROTATE:{tagName:'div', className:'xuifont',$fonticon:'xui-icon-circle', style:'font-size: 1.5em;top:-1.25em;left:50%;margin-left:-0.5em;{_rotateBtn};'},
                T:{tagName:'div', style:'top:-{_extend};margin-left:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                RT:{tagName:'div', style:'top:-{_extend};right:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                R:{tagName:'div', style:'right:-{_extend};margin-top:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                RB:{tagName:'div', style:'bottom:-{_extend};right:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                B:{tagName:'div', style:'bottom:-{_extend};margin-left:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                LB:{tagName:'div',style:'bottom:-{_extend};left:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                L:{tagName:'div', style:'left:-{_extend};margin-top:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                LT:{tagName:'div', style:'left:-{_extend};top:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                cover:{
                    T:{tagName:'div', style:'width:100%;left:0em;top:-{_extend};height:{_handlerSize};'},
                    RT:{tagName:'div', style:'top:-{_extend};right:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                    R:{tagName:'div', style:'height:100%;top:0em;right:-{_extend};width:{_handlerSize};' },
                    RB:{tagName:'div', style:'right:-{_extend};bottom:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                    B:{tagName:'div', style:'width:100%;left:0em;bottom:-{_extend};height:{_handlerSize};'},
                    LB:{tagName:'div', style:'left:-{_extend};bottom:-{_extend};width:{_handlerSize};height:{_handlerSize};'},
                    L:{tagName:'div', style:'height:100%;top:0em;left:-{_extend};width:{_handlerSize};' },
                    LT:{tagName:'div', style:'top:-{_extend};left:-{_extend};width:{_handlerSize};height:{_handlerSize};'}
                }
            });

            /* dynamic template set here
                template._id is main id, which can input by create arg
                template._did is sub id, which must be built on fly, and cached
            */
            var template = profile.box.getTemplate(hash);
            // set template dynamic
            if(!template){
                var t,n;
                template = xui.clone(profile.box.getTemplate());

                // cover or not?
                t = pro._cover?map.cover:map;
                // can move?
                if(pro._move)template.MOVE = map.MOVE;

                template.CONF1 = map.CONF1;
                template.CONF2 = map.CONF2;
                template.ROTATE = map.ROTATE;

                // change height only
                if(pro.vertical){
                    if(!pro.singleDir)
                        template.T = t.T;
                    template.B = t.B;
                }
                // change width only
                if(pro.horizontal){
                    if(!pro.singleDir)
                        template.L = t.L;
                    template.R = t.R;
                    // change height and width
                    if(pro.vertical){
                        if(!pro.singleDir){
                            template.LB = t.LB;
                            template.RT = t.RT;
                            template.LT = t.LT;
                        }
                        template.RB = t.RB;
                    }
                }

                n = profile.getClass('KEY', '-handler') + " ";
                if(t=template.T)t.className = n;
                if(t=template.RT)t.className = n;
                if(t=template.R)t.className = n;
                if(t=template.RB)t.className = n;
                if(t=template.B)t.className = n;
                if(t=template.LB)t.className = n;
                if(t=template.L)t.className = n;
                if(t=template.LT)t.className = n;

                // if hidden
                if(!pro._visible){
                    n = profile.getClass('KEY', '-hidden') + " ";
                    if(t=template.T)t.className += n;
                    if(t=template.RT)t.className += n;
                    if(t=template.R)t.className += n;
                    if(t=template.RB)t.className += n;
                    if(t=template.B)t.className += n;
                    if(t=template.LB)t.className += n;
                    if(t=template.L)t.className += n;
                    if(t=template.LT)t.className += n;

                }
                // set template
                profile.box.setTemplate(template, hash);
            }
            profile.template = template;
        },
        _prepareData:function(profile){
            var t = profile.properties;
            //default is true
            t._visible=true;
            t._cover=false;
            t._move=true;
            // for _attached type
            if(t._attached){
                t._visible=false;
                t._cover=true;
                t._move=false;

                t.position = 'static';
                if(xui.browser.ie67)t.display = 'inline';
                t.left = t.top = t.width = t.height = 0;
            }
            if(t.forceVisible){
                t._visible=true;
                t._cover=false;
            }
            if(typeof t.forceMovable=="boolean")
                t._move=t.forceMovable;

            t.extend =  (parseFloat(t.handlerSize)||0)/2 + (parseFloat(t.handlerOffset)||0);
            t._handlerSize =  profile.$em(t.handlerSize)+'em';
            t._extend =  profile.$em(t.extend)+'em';

            t._leftCofigBtn = t.leftConfigBtn?'':'display:none';       
            t._rightCofigBtn = t.rightConfigBtn?'':'display:none';
            
            var r=t.rotatable;
            if(r && xui.browser.ie&&xui.browser.ver<=8)
                r=false;
            t._rotateBtn = r?'':'display:none';
            t._disabled = t.disabled?"disabled":"";
            return arguments.callee.upper.call(this, profile);
        },
        RenderTrigger:function(){
            var self=this;
            xui.setNodeData(self.renderId,'zIndexIgnore',1);
            self.box._tryCursors(self);
        },
        _onUpdate:function(profile, target, size, cssPos, rotate){
            if(target){
                if(size)target.widthBy(size.width,true).heightBy(size.height,true);
                if(cssPos){
                    var t=target.get(0).style;
                    if(t.left=='auto'&&(Math.round(parseFloat(t.right))>=0)){}else
                    target.leftBy(cssPos.left)
                    if(t.top=='auto'&&(Math.round(parseFloat(t.bottom))>=0)){}else
                    target.topBy(cssPos.top);
                }
                if(xui.isDefined(rotate)){
                    target.rotate(rotate);
                }
            }
        },
        //
        _switchAxis : function (axis, angle, dir4) {
            var a = (angle + 360 ) % 360,
                axisArray = ["n", "ne", "e", "se", "s", "sw", "w", "nw"],
                // 0 .. 7
                octant = Math.round(a /45),
                oindex = xui.arr.indexOf(axisArray, axis),
                index = oindex + octant,
                naxis = axisArray[index % 8];
            if(dir4 && index%2 == 1){
                if(a < octant*45){
                    naxis = axisArray[(index-1) % 8];
                }else{
                    naxis = axisArray[(index+1) % 8];
                }
            }
            return naxis;
        },
        _tryCursors : function(profile){
               var a = (profile.getRoot().rotate() + 360 ) % 360,
                    f = this._switchAxis,
                    hash = {T:"n", RT:"ne", R:"e", RB:"se", B:"s", LB:"sw", L:"w", LT:"nw"},n;
                xui.each(hash,function(k,i){
                    if((n=profile.getSubNode(i)).get(0)){
                        n.css('cursor', f(k, a)+"-resize");
                    }
                });
        },
        _getDDParas:function(angle, axis, switched){
            switch(axis){
            case "move":
                return {move:true};
            case "rotate":
                return {rotate:true};
            case "nw":
                return {left:true, top:true};
            case "ne":
                return {right:true, top:true};
            case "sw":
                return {left:true, bottom:true};
            case "se":
                return {right:true, bottom:true};
            case "w":
                return {left:true};
            case "n":
                return {top:true};
            case "e":
                return {right:true};
            case "s":
                return  {bottom:true};
            }
        },
        _onMousedown:function(profile, e, src, axis){
            if(profile.$inDesign)return;
            if(profile.properties.disabled)return false;

            var ddparas=this._getDDParas(0, axis);
            if(xui.Event.getBtn(e)!="left")return;
            var puip=profile.$parentUIProfile;
            if(puip && puip['xui.UIProfile'] && puip.beforeResizerDrag && false=== xui.tryF(puip.beforeResizerDrag,[puip,profile,ddparas],puip.boxing()))
                return;

            var pos=xui.Event.getPos(e);
            xui.use(src).startDrag(e,{
                dragDefer:2,
                targetReposition:false,
                dragType:'blank',
                dragCursor:true,
                targetLeft:pos.left,
                targetTop:pos.top
            });
        },
        _onDragbegin:function(profile, e, src, axis){
            var prop=profile.properties,
                rotatable = prop.rotatable,
                //set target to specific target
                //or, set target to resizer
                o = profile.properties._attached?profile._target:xui([profile.renderId]),
                w = o.width(),
                h = o.height(),
                pos = o.offset(),
                rotate;
            if(rotatable){
                rotate = o.rotate();
                if(o.get(0).getBoundingClientRect){
                    var rect = o.get(0).getBoundingClientRect();
                    profile.o_center = {
                        x : (rect.right + rect.left)/2,
                        y : (rect.bottom + rect.top)/2
                    };
                }else{
                    profile.o_center = {
                        x : pos.left +  w/2,
                        y : pos.top + w/2
                    };
                }
            }

            if(profile.properties._attached){
                //custom proxy
                profile.proxy = xui.Dom.getEmptyDiv();
                profile.proxy
                    .html(' ',false)
                    .css({border:'1px dashed',visibility:'visible',position:'absolute'})
                    .offset(pos)
                    .width(w)
                    .height(h)
                    .css('zIndex',xui.Dom.TOP_ZINDEX+20);
                if(rotate)
                    profile.proxy.rotate(rotate);
            }else
                //set proxy to itself
                profile.proxy = o;


            //get current w h from target
            profile.o_w2 =profile.o_w =w;
            profile.o_h2 =profile.o_h = h;
            //get pos for target and proxy
            profile.o_pos = profile.proxy.cssPos();
            profile.o_size = {width:w, height:h};
            profile.o_rotate = rotate;
            if(profile.regions){
                profile.o_regions=[];
                profile.regions.each(function(n){
                    profile.o_regions.push(xui(n).cssSize());
                });
            }

            profile.$onDrag = true;
        },
        _onDrag:function(profile, e, src, axis){
            var args=this._getDDParas(profile.o_rotate, axis);

            //get dragdop off set
            profile.oos = profile.oos ||{};
            var dd = xui.DragDrop.getProfile(),
                t=profile.properties,
                elemAngle = profile.o_rotate,
                cs = profile.o_size, 
                sp = profile.o_pos,    
                os = dd.offset,
                dx = os.x,
                dy = os.y,
                x,y,w,h,rotate,
                data={};

            // no move
            if(dx===0 && dy===0)return;
            // for rotate
            if(elemAngle && !(args.move || args.rotate)){
                var adjustAngle = function(a){return (a + 360 ) % 360;},
                    distance = Math.pow(Math.pow(dx, 2)+ Math.pow(dy,2),.5),
                    mouseAngle = adjustAngle(Math.atan2(dx, -dy) * 180 /Math.PI),
                    offAngle = elemAngle  + 90 - mouseAngle,
                    flagX = (adjustAngle(mouseAngle - elemAngle) <  180) ? 1 : -1,
                    flagY = (adjustAngle(mouseAngle - elemAngle) < 90 || adjustAngle(mouseAngle - elemAngle) > 270) ? -1 : 1;

                dx = distance * Math.abs(Math.cos(offAngle * Math.PI/180)) * flagX;
                dy = distance * Math.abs(Math.sin(offAngle* Math.PI/180)) * flagY;
            } 
            // no data
            if(dx == profile.oos.width && dy == profile.oos.height)return;
            profile.oos={width:dx, height:dy};

            // pos and size
            if(args.left){
                // width of proxy
                w = profile.o_w - dx;
                // left of proxy
                x = sp.left + dx;
                if(w<t.minWidth){
                    w=t.minWidth;
                    x = profile.o_w+sp.left - w;
                }else if(w>t.maxWidth){
                    w=t.maxWidth;
                    x= profile.o_w+sp.left - w;
                }
                xui.merge(data,{width:w,left:x});
            }else if(args.right){
                w = profile.o_w + dx;
                if(w<t.minWidth)w=t.minWidth;
                else if(w>t.maxWidth)w=t.maxWidth;
                xui.merge(data,{width:w});
            }
            if(args.top){
                h = profile.o_h - dy;
                y = sp.top + dy;
                if(h<t.minHeight){
                    h=t.minHeight;
                    y=profile.o_h+sp.top - h;
                }else if(h>t.maxHeight){
                    h=t.maxHeight;
                    y=profile.o_h+sp.top - h;
                }
                xui.merge(data,{height:h,top:y});
            }else if(args.bottom){
                h= profile.o_h + dy;
                if(h<t.minHeight)h=t.minHeight;
                else if(h>t.maxHeight)h=t.maxHeight;
                xui.merge(data,{height:h});
            }

            if(elemAngle && !(args.move || args.rotate)){
                delete data.left;
                delete data.top;

               var xRate = Math.abs (Math.cos(elemAngle * Math.PI/180)),
                    yRate = Math.abs(Math.sin(elemAngle * Math.PI/180)),
                    // old bbox
                    oldBBoxCX = sp.left + cs.width/2,
                    oldBBoxCY = sp.top + cs.height/2,
                    oldBboxW = cs.width * xRate + cs.height * yRate,
                    oldBboxH = cs.width * yRate + cs.height * xRate,
                    oldBboxL = oldBBoxCX - oldBboxW/2,
                    oldBboxT = oldBBoxCY - oldBboxH/2,
                    
                    // new bbox
                    newBboxCX = (data.left||sp.left) +  (data.width||cs.width)/2,
                    newBboxCY = (data.top||sp.top) +  (data.height||cs.height)/2,
                    newBboxW = (data.width||cs.width) * xRate + (data.height||cs.height) * yRate,
                    newBboxH = (data.width||cs.width) * yRate + (data.height||cs.height) * xRate,
                    newBboxL = newBboxCX - newBboxW/2,
                    newBboxT = newBboxCY - newBboxH/2,
                    offW = (newBboxW-oldBboxW)/2,
                    offH =  (newBboxH-oldBboxH)/2,
                    //two original points offset
                    offCX =  newBboxCX - oldBBoxCX,
                    offCY =  newBboxCY - oldBBoxCY;

                //Alignment by origin point
                data.left =  sp.left - offCX;
                data.top =  sp.top - offCY;

                // find the direction
                var naxis = this._switchAxis (axis, elemAngle,true);

                switch(naxis){
                    case "e":
                        if(elemAngle < 90 ){
                            data.top -= ((data.height||cs.height)*xRate - newBboxH/2) - (cs.height* xRate - oldBboxH/2);
                        }else if(elemAngle > 90 && (elemAngle < 180)){
                            data.top -= ((data.width||cs.width)*yRate - newBboxH/2) - (cs.width* yRate - oldBboxH/2);
                        }else if(elemAngle > 180 && (elemAngle < 270)){
                            data.top += ((data.width||cs.width)*yRate - newBboxH/2) - (cs.width* yRate - oldBboxH/2);
                        }else{
                            data.top += ((data.height||cs.height)*xRate - newBboxH/2) - (cs.height* xRate - oldBboxH/2);
                        }
                        data.left += offW;
                        break;
                    case "s":
                        if(elemAngle < 90 ){
                            data.left -= ((data.height||cs.height)*yRate - newBboxW/2) - (cs.height* yRate - oldBboxW/2);
                        }else if(elemAngle > 90 && (elemAngle < 180)){
                            data.left -= ((data.width||cs.width)*xRate - newBboxW/2) - (cs.width* xRate - oldBboxW/2);
                        }else if(elemAngle > 180 && (elemAngle < 270)){
                            data.left += ((data.width||cs.width)*xRate - newBboxW/2) - (cs.width* xRate - oldBboxW/2);
                        }else{
                            data.left += ((data.height||cs.height)*yRate - newBboxW/2) - (cs.height* yRate - oldBboxW/2);
                        }
                        data.top += offH;
                        break;
                    case "w":
                        if(elemAngle < 90 ){
                            data.top += ((data.height||cs.height)*xRate - newBboxH/2) - (cs.height* xRate - oldBboxH/2);
                        }else if(elemAngle > 90 && (elemAngle < 180)){
                            data.top += ((data.width||cs.width)*yRate - newBboxH/2) - (cs.width* yRate - oldBboxH/2);
                        }else if(elemAngle > 180 && (elemAngle < 270)){
                            data.top -= ((data.width||cs.width)*yRate - newBboxH/2) - (cs.width* yRate - oldBboxH/2);
                        }else{
                            data.top -= ((data.height||cs.height)*xRate - newBboxH/2) - (cs.height* xRate - oldBboxH/2);
                        }
                        data.left -= offW;
                        break;
                    case "n":
                        if(elemAngle < 90 ){
                            data.left += ((data.height||cs.height)*yRate - newBboxW/2) - (cs.height* yRate - oldBboxW/2);
                        }else if(elemAngle > 90 && (elemAngle < 180)){
                            data.left += ((data.width||cs.width)*xRate - newBboxW/2) - (cs.width* xRate - oldBboxW/2);
                        }else if(elemAngle > 180 && (elemAngle < 270)){
                            data.left -= ((data.width||cs.width)*xRate - newBboxW/2) - (cs.width* xRate - oldBboxW/2);
                        }else{
                            data.left -= ((data.height||cs.height)*yRate - newBboxW/2) - (cs.height* yRate - oldBboxW/2);
                        }
                        data.top -= offH;
                        break;
                }
            }
            // for inner region
            if(args.left || args.right){
                //resize inner region block
                if(profile.regions && "width" in data && data.width!==cs.width){
                    var offw=data.width-cs.width;
                    profile.regions.each(function(n,i){
                        xui(n).width(profile.o_regions[i].width + offw);
                    });
                }
            }

            if(args.top || args.bottom){
                //resize inner region block
                if(profile.regions && "height" in data && data.height!==cs.height){
                    var offh=data.height-cs.height;
                    profile.regions.each(function(n,i){
                        xui(n).height(profile.o_regions[i].height + offh);
                    });
                }
            }

            if(args.move){
                x = sp.left + dx;
                y = sp.top + dy;
                xui.merge(data,{top:y,left:x});
            }
            if(args.rotate){
                rotate =  (180 - Math.atan2( dd.x - profile.o_center.x, dd.y - profile.o_center.y ) * 180 / Math.PI );
                if(rotate<0)rotate+=360;
                xui.merge(data,{rotate:rotate});
            }
            
            if(!xui.isEmpty(data)){
                xui.each(data,function(o,i){
                    data[i]=Math.round(parseFloat(o))+'px';
                });
                profile.proxy.css(data);

                if(profile.onChange)
                    profile.boxing().onChange(profile,profile.proxy);
            }
        },
        _onDragstop:function(profile, e, src, axis){
            var cssSize, cssPos,
                offsize, offpos,
                rotate,
                cs = profile.o_size, 
                sp = profile.o_pos,    
                o = profile.proxy,
                args = this._getDDParas(profile.o_rotate, axis);

            if(!args.move && !args.rotate){
                cssSize = o.cssSize();
                offsize = {
                    width : cssSize.width - cs.width, 
                    height : cssSize.height - cs.height
                };
               if(offsize.width===0 && offsize.height===0)offsize=null;
            }
            
            cssPos = o.cssPos();
            offpos = {
                left : cssPos.left - sp.left,  
                top : cssPos.top - sp.top
            };
           if(offpos.left===0 && offpos.top===0)offpos=null;
            
            if(args.rotate)
                rotate=o.rotate();

            if(profile.onUpdate && false===profile.boxing().onUpdate(profile, profile._target, offsize, offpos, rotate)){}
            else{
                profile.box._onUpdate(profile, profile._target, offsize, offpos, rotate);
            }

            if(profile.properties._attached){
                if(xui.browser.ie6)profile._target.ieRemedy();
                profile.proxy.html('',false).css({visibility:'hidden',border:'none',zIndex:'0',width:'0',height:'0',rotate:0});
            }
            //profile.boxing().active();
            profile.$onDrag = false;
            delete profile.o_rotate;
            
            profile.box._tryCursors(profile);
        }
    }
});xui.Class("xui.UI.Block", "xui.UI.Widget",{
    Initialize:function(){
        var self=this,
            t = self.getTemplate();
        //modify
        t.className += ' {_sidebarStatus}';
        xui.merge(t.FRAME.BORDER,{
            className:'xui-uiw-border {clsBorderType1}',
            SIDEBAR:{
                tagName:'div',
                className:'xui-uisb xui-uibar {_sidebar}',
                SBCAP:{
                    className:'xui-uisbcap xui-title-node',
                    text:'{sideBarCaption}'
                },
                SBBTN:{
                    $order:1,
                    className:'xui-uisbbtn xuifont',
                    $fonticon:'{_fi_btn}'
                }
            },
            PANEL:{
                tagName:'div',
                className:'xui-uibar xui-uicontainer {clsBorderType2}',
                style:'{_panelstyle};{background};{_overflow};',
                text:'{html}'+xui.UI.$childTag
            }
        },'all');
        //set back
        self.setTemplate(t);

        //get default Appearance
        t = self.getAppearance();
        //modify
        xui.merge(t,{
            PANEL:{
                position:'relative',
                overflow:'auto'
            },
            SBBTN:{
                'z-index':2,
                margin:'0.33333em'
            }
        });
        //set back
        self.setAppearance(t);
    },
    Static:{
        Behaviors:{
            HoverEffected:{SBBTN:'SBBTN',SBCAP:null},
            ClickEffected:{SBBTN:'SBBTN'},
            DroppableKeys:['PANEL'],
            PanelKeys:['PANEL'],
            PANEL:{
                onClick:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled)return false;
                    if(profile.onClickPanel)
                        return profile.boxing().onClickPanel(profile, e, src);
                }
            },
            SBBTN:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                        a=p.sideBarType,
                        b=p.sideBarStatus,
                        c;
                    if(p.disabled)return false;
                    profile.boxing().setSideBarStatus(c  = b=='fold'?'expand':'fold');                    
                }
            },
            SIDEBAR:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                        btn=profile.getSubNode('SBBTN');
                    if(p.disabled)return false;
                    if(xui.Event.getSrc(e).$xid!=btn.xid()){
                        if(p.sideBarStatus=='fold'){
                            btn.onClick(true);
                        }
                    }
                }
            }
        },
        EventHandlers:{
            onClickPanel:function(profile, e, src){}
        },
        DataModel:{
            //delete those properties
            disabled:null,
            tips:null,
            rotate:null,
            iframeAutoLoad:{
                ini:"",
                action:function(){
                    xui.UI.Div._applyAutoLoad(this);
                }
            },
            ajaxAutoLoad:{
                ini:"",
                action:function(){
                    xui.UI.Div._applyAutoLoad(this);
                }
            },
            selectable:true,
            html:{
                html:1,
                action:function(v,ov,force){
                    this.getSubNode('PANEL').html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            borderType:{
                ini:'outset',
                listbox:['none','flat','inset','outset','groove','ridge'],
                action:function(v){
                    var ns=this,
                        p=ns.properties,
                        type=p.sideBarType,
                        n1=ns.getSubNode('BORDER'), n2=ns.getSubNode('PANEL'),
                        reg=/^xui-uiborder-/,
                        b='xui-uiborder-',
                        r=b+'radius',
                        i=b+'inset',
                        o=b+'outset',
                        f=b+'flat',
                        ibr = type=='left'?r+'-tr '+r+'-br':type=='top'?r+'-bl '+r+'-br':type=='right'?r+'-tl '+r+'-bl':type=='bottom'?r+'-tl '+r+'-tr':r,
                        flat=f+' ' +r,
                        ins=i+' '+r,
                        outs=o+' ' +r,
                        ins2=i + ' '+ibr,
                        outs2=o+' '+ibr,
                        root=ns.getRoot();
                    n1.removeClass(reg);
                    n2.removeClass(reg);
                    switch(v){
                        case 'flat':
                        n1.addClass(flat);
                        n2.addClass(ibr);
                        break;
                        case 'inset':
                        n1.addClass(ins);
                        n2.addClass(ibr);
                        break;
                        case 'outset':
                        n1.addClass(outs);
                        n2.addClass(ibr);
                        break;
                        case 'groove':
                        n1.addClass(ins);
                        n2.addClass(outs2);
                        break;
                        case 'ridge':
                        n1.addClass(outs);
                        n2.addClass(ins2);
                        break;
                    }

                    //force to resize
                    ns.box._setB(ns);
                    ns.adjustSize();
                }
            },

            // for side bar
            sideBarType:{
                ini:'none',
                listbox:['none','left','top','right','bottom'],
                action:function(v){
                    var ns=this, 
                        prop=ns.properties,
                        reg=/^xui-uisb-/,
                        node=ns.getSubNode('SIDEBAR');
                    
                    node.removeClass(reg).addClass('xui-uisb-'+v);

                    ns.box._sbicon(ns,true);

                    ns.boxing().setBorderType(prop.borderType,true);

                    if(prop.dock=='none')
                        ns.adjustSize();
                    else
                        ns.boxing().adjustDock(true);
                }
            },
            sideBarCaption:{
                ini:'',
                action:function(v){
                    this.getSubNode("SBCAP").html(v);
                }
            },
            sideBarStatus:{
                ini:'expand',
                listbox:['expand','fold'],
                action:function(v){
                    var ns=this, 
                        prop=ns.properties;
                    ns.getRoot().tagClass('-fold', v!='expand');

                    ns.box._sbicon(ns,true);

                    // use sync way
                    xui.UI.$doResize(ns, prop.width, prop.height,true);
                    ns.boxing().adjustDock(true);
                }
            },
            sideBarSize:{
                ini:'2em',
                action:function(v){
                    var ns=this, 
                        prop=ns.properties;
                    if(prop.dock=='none')
                        ns.adjustSize();
                    else
                        ns.boxing().adjustDock(true);
                }
            },

            background:{
                format:'color',
                ini:'',
                action:function(v){
                    this.getSubNode('PANEL').css('background',v);
                }
            },
            width:{
                $spaceunit:1,
                ini:'10em'
            },
            height:{
                $spaceunit:1,
                ini:'10em'
            }
        },
        Appearances:{
            KEY:{
                'line-height':'normal'
            },
            'KEY-fold PANEL':{
                display:'none'
            },
            'KEY-fold SIDEBAR':{
                cursor:'pointer'
            }
        },
        RenderTrigger:function(){
            // only div
            var ns=this;
            if(ns.box.KEY=="xui.UI.Block")
                if(ns.properties.iframeAutoLoad||ns.properties.ajaxAutoLoad)
                    xui.UI.Div._applyAutoLoad(this);
        },
        _sbicon:function(profile, ui){
            var p=profile.properties,
                a=p.sideBarType,
                target=p.sideBarStatus=='fold'
                ? a=='left'?'left':a=='right'?'right':a=='top'?'up':'down'
                : a=='left'?'right':a=='right'?'left':a=='top'?'down':'up';
            return ui ? profile.getSubNode('SBBTN').replaceClass(/(xui-icon-double)[\w]+/g,'$1' + target) : 'xui-icon-double'+target;
        },
        _setB:function(profile){
            var p=profile.properties,
                type=p.borderType,
                nd=profile.getSubNode("BORDER"),
                w=nd._borderW('left');
            p.$hborder=p.$vborder=p.$iborder=0;

            if(type=='flat'||type=='inset'||type=='outset'){p.$hborder=p.$vborder=w;p.$iborder=0;}
            else if(type=='groove'||type=='ridge'){p.$hborder=p.$vborder=p.$iborder=w;}
        },
        LayoutTrigger:function(){
            var prop=this.properties,
                m=prop.sideBarStatus,
                v=prop.borderType;
            if(v!='none')this.boxing().setBorderType(v,true);
            if(m=='fold')this.boxing().setSideBarStatus('fold',true);
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile),
                a=data.sideBarType,
                b=data.sideBarStatus;
            data.background= data.background?'background:'+data.background:'';
            if(xui.isStr(data.overflow))
                data._overflow = data.overflow.indexOf(':')!=-1?(data.overflow):(data.overflow?("overflow:"+data.overflow):"");
            
            data._sidebar = 'xui-uisb-' + a;
            data._sidebarStatus = b=='fold'?profile.getClass('KEY','-fold'):'';

            data._fi_btn =  profile.box._sbicon(profile);

            return data;
        },        
        _onresize:function(profile,width,height){
            var size = arguments.callee.upper.apply(this,arguments),
                root=profile.getRoot(),
                border=profile.getSubNode('BORDER'),
                panel=profile.getSubNode('PANEL'),
                sidebar=profile.getSubNode('SIDEBAR'),
                sbcap=profile.getSubNode('SBCAP'),
                prop=profile.properties,
                sbs=prop.sideBarStatus,
                sbtype=prop.sideBarType,
                cb1=border.contentBox(),
                bv=cb1?0:(prop.$vborder||0)*2,
                bh=cb1?0:(prop.$hborder||0)*2,
                
                cb2=panel.contentBox(),
                b2=(prop.$iborder||0)*2,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                fzrate=profile.getEmSize()/root._getEmSize(),
                panelfz = panel._getEmSize(fzrate),

                // caculate by px
                ww=width?profile.$px(size.width):size.width, 
                hh=height?profile.$px(size.height):size.height,
                sbsize=profile.$px(prop.sideBarSize),
                sbsize2=adjustunit(sbsize);

            size.left=size.top=0;
            if(sbtype && sbtype!='none'){
                sbcap.css('line-height',adjustunit(sbsize - 2));
                if(sbtype=='left'||sbtype=='right'){
                    sidebar.width(sbsize2);
                    if(height&&'auto'!==height)
                        sidebar.height(adjustunit(hh-bv));
                }else{
                    sidebar.height(sbsize2);
                    sidebar.width(adjustunit(ww-bh));
                }

                if(sbs=='fold'){
                    if(sbtype=='left'||sbtype=='right'){
                        root.width(adjustunit(sbsize+bh+b2));
                        border.width(adjustunit(sbsize+bv));
                    }else{
                        root.height(adjustunit(sbsize+bv+b2));
                        border.height(adjustunit(sbsize+bv));
                    }
                    return;
                }else{
                    if(sbtype=='left'||sbtype=='right'){
                        root.width(adjustunit(width));
                        border.width(adjustunit(width-(cb1?bh:0)));
                    }else{
                        root.height(adjustunit(height));
                        border.height(adjustunit(height-(cb1?bv:0)));
                    }
                    switch(sbtype){
                        case 'left':
                            ww-=sbsize;
                            size.left=sbsize;
                            break;
                        case 'right':
                            ww-=sbsize;
                            break;
                        case 'top':
                            hh-=sbsize;
                            size.top=sbsize;
                            break;
                        case 'bottom':
                            hh-=sbsize;
                            break;
                    }
                }
            }
            if(size.width) size.width = adjustunit(ww -bh - (!cb2?0:b2), panelfz);
            if(size.height&&'auto'!==size.height)
                size.height = adjustunit(hh - bv- (!cb2?0:b2), panelfz);
            panel.cssRegion(size,true);

            if(size.width){
                xui.UI._adjustConW(profile, panel, size.width);
            }
        },
        _showTips:function(profile, node, pos){
            var p=profile.properties;
            if(p.disableTips)return;
            if(profile.onShowTips)
                return profile.boxing().onShowTips(profile, node, pos);

            if(!xui.Tips)return;
            if(p.sideBarType=='none')return;

            var id=node.id, ks=profile.keys;
            if(p.sideBarStatus=="fold" && (id.indexOf(ks.SBCAP)===0||id.indexOf(ks.SBBTN)===0)){
                xui.Tips.show(pos, {tips: xui.wrapRes('$inline.Expand')});
                return false;
            }else if(p.sideBarStatus=="expand" && id.indexOf(ks.SBBTN)===0){
                xui.Tips.show(pos, {tips: xui.wrapRes('$inline.Fold')});
                return false;
            }
        }
    }
});

xui.Class("xui.UI.Label", "xui.UI",{
    Initialize:function(){
        // compitable
        xui.UI.SLabel = xui.UI.Label;
        var key="xui.UI.SLabel";
        xui.absBox.$type[key.replace("xui.UI.","")]=xui.absBox.$type[key]=key;
    },    
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        },
        // calculate the formula, and apply to the control
        _applyExcelFormula:function(cellsMap){
            var profile=this.get(0), prop=profile.properties,f,value;
            if(f = prop.excelCellFormula){
                value = xui.ExcelFormula.calculate(f, cellsMap);
                if(xui.isSet(value)){
                    if(profile.beforeApplyExcelFormula && false===profile.beforeApplyExcelFormula(profile, prop.excelCellFormula, value)){}else{
                        this.setCaption(value, true);
                        if(profile.afterApplyExcelFormula)profile.afterApplyExcelFormula(profile, prop.excelCellFormula, value);
                    }
                }
           }
        }
    },
    Static:{
        Templates:{
            tagName:"label",
            className:'{_className}',
            style:'{_style};text-align:{hAlign}',
            ICON:{
                $order:0,
                className:'xuicon {imageClass}  {picClass}',
                style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                text:'{iconFontCode}'
            },
            CAPTION:{
                text : '{caption}',
                style:'{_fc}{_fw}{_fs}{_ff}',
                'font-size':'1em',
                $order:1
            }
        },
        Appearances:{
        },
        DataModel:{
            selectable:true,
            caption:{
                ini:undefined,
                action: function(v){
                    var prf=this;
                    if(!prf.properties.clock){
                        v=(xui.isSet(v)?v:"")+"";
                        prf.getSubNode("CAPTION").html(xui.adjustRes(v,true));
                    }
                }
            },
            clock:{
                ini:'',
                combobox:['hh : mm : ss','hh - mm : ss'],
                action:function(v){
                    var prf=this,timer;
                    if(v && !prf._timer){
                        timer = prf._timer=new xui.Timer();
                        var f = timer.get(0).$onTime=function(){
                            if(!prf.destroyed)
                                prf.getSubNode("CAPTION").html(xui.Date.format(new Date,prf.properties.clock));
                        };
                        f();
                    }else if(!v &&prf._timer){
                        prf._timer.destroy();
                        prf._timer=null;
                        prf.boxing().setCaption(prf.properties.caption,true);
                    }
                }
            },
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            hAlign:{
                ini:'right',
                listbox:['left','center','right'],
                action: function(v){
                    this.getRoot().css('textAlign',v);
                }
            },
            vAlign:{
                hidden:true
            },
            fontColor:xui.UI.Button.$DataModel.fontColor,
            fontSize:xui.UI.Button.$DataModel.fontSize,
            fontWeight:xui.UI.Button.$DataModel.fontWeight,
            fontFamily:xui.UI.Button.$DataModel.fontFamily,
            excelCellFormula:{
                ini:"",
                action:function(v){
                    var prf=this,m,
                        prop=prf.properties;
                    if(v && xui.ExcelFormula.validate(v)){
                        if(prf.host && (m=prf.host['xui.Module'])){
                            m.applyExcelFormula(prf);
                        }
                   }
                }
            }
        },
        Behaviors:{
            HoverEffected:{KEY:'KEY',ICON:'ICON'},
            onClick:function(profile, e, src){
                var p=profile.properties;
                if(p.disabled)return false;
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            }
        },
        EventHandlers:{
            onClick:function(profile, e, src){},
            beforeApplyExcelFormula:function(profile, excelCellFormula, value){},
            afterApplyExcelFormula:function(profile, excelCellFormula, value){}
        },
        RenderTrigger:function(){
            var prf=this,t;
            (prf.$beforeDestroy=(prf.$beforeDestroy||{}))["timerClear"]=function(){
                if(prf._timer){
                    prf._timer.destroy();
                    delete prf._timer;
                }
            };
            if(t=prf.properties.clock){
                prf.boxing().setClock(t,true);
            }
        },
        _prepareData:function(profile, data){
            data=arguments.callee.upper.call(this, profile,data);
            if(data.clock)data.caption='';
            data._fs = 'font-size:' + data.fontSize + ';';
            data._fw = 'font-weight:' + data.fontWeight + ';';
            data._fc = 'color:' + data.fontColor + ';';
            data._ff = 'font-family:' + data.fontFamily + ';';
            return data;
        }        
    }
});
xui.Class("xui.UI.ProgressBar", ["xui.UI.Widget","xui.absValue"] ,{
    Instance:{
        _setCtrlValue:function(value){
            return this.each(function(profile){
                var type=profile.properties.type,
                    inn=profile.getSubNode('FILL');
               if(type=="horizontal"){
                    inn.width(value+"%");
                }else{
                    inn.top((100-value)+"%").height(value+"%");
                }
                profile.getSubNode('CAP').text(profile.properties.captionTpl.replace(/\{value\}|\*/g,value));
            });
        }
    },
    Initialize:function(){
        var self=this,
            t = self.getTemplate();
        //modify
        xui.merge(t.FRAME.BORDER,{
            className:"xui-uiborder-flat xui-uiborder-radius xui-uibase",
            FILL:{
                tagName:'div',
                style:'{fillBG}',
                className:'xui-uibar',
                text:'{html}'+xui.UI.$childTag
            },
            INN:{
                $order:2,
                tagName:'div',
                CAP:{
                    tagName:'div'
                }
            }
        },'all');
        //set back
        self.setTemplate(t);

        //get default Appearance
        t = self.getAppearance();
        //modify
        xui.merge(t,{
            BORDER:{
                overflow:'hidden'
            },
            INN:{
                display:'table',
                position:'absolute',
                left:0,
                top:0,
                width:'100%',
                height:'100%'
            },
            CAP:{
                'text-align':'center'
            },
            FILL:{
                border:'none',
                position:'relative',
                width:0,
                height:0,
                left:0,
                top:0
            }
        });
        //set back
        self.setAppearance(t);
    },
    Static:{
        DataModel:{
            value:0,
            width:{
                $spaceunit:1,
                ini:'25em'
            },
            height:{
                $spaceunit:1,
                ini:'1.5em'
            },
            captionTpl:{
                ini:'* %',
                action:function(){
                    this.boxing()._setCtrlValue(this.properties.$UIvalue);
                }
            },
            type:{
                listbox:['vertical', 'horizontal'],
                ini:'horizontal',
                action:function(v){
                    var w=this.properties.width,h=this.properties.height;
                    this.properties.height=w;this.properties.width=h;
                    this.boxing().refresh();
                }
            },
            fillBG:{
                ini:'',
                format:'color',
                action:function(v){
                    this.getSubNode('FILL').css('background',v);
                }
            },
            $hborder:1,
            $vborder:1
        },
        LayoutTrigger:function(){
            var v=this.properties,nd=this.getSubNode("BORDER");
            v.$hborder=v.$vborder= nd._borderW('left');
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            data.fillBG = data.fillBG?'background:'+data.fillBG:'';
            return data;
        },
        _ensureValue:function(profile,value){
            return Math.max(0, Math.min(100, ((/^\s*\=/.test(value||"")) ? xui.ExcelFormula.calculate(value||"") : parseInt(value,10)) || 0));
        },
        _onresize:function(profile,width,height){
            var size = arguments.callee.upper.apply(this,arguments),v,
                p=profile.properties,
                us = xui.$us(p),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot(),
                inn = profile.getSubNode('INN'),
                cap = profile.getSubNode('CAP'),
                fill = profile.getSubNode('FILL'),
                
                fzrate=profile.getEmSize()/root._getEmSize(),
                innfz=inn._getEmSize(fzrate),
                capfz=cap._getEmSize(fzrate),
                fillfz=fill._getEmSize(fzrate);
                
            // caculate by px
            if(size.width && size.width!='auto')size.width=profile.$px(size.width);
            if(size.height && size.height!='auto')size.height=profile.$px(size.height);

            if(p.type=="horizontal"){
                if(size.height){
                    v=adjustunit(size.height, innfz);
                    inn.css({'line-height':v});
                    
                    v=adjustunit(size.height, fillfz);
                    fill.css({height:v,'line-height':v});
                    
                    v=adjustunit(size.height, capfz);
                    cap.css({height:v,'line-height':v});
                }
            }else{
                if(size.width){
                    //inn.css({width:adjustunit(size.width, innfz)});                   
                    fill.css({width:adjustunit(size.width, fillfz)});
                    cap.css({width:adjustunit(size.width, capfz)});
                }
                if(size.height){
                    inn.css({'line-height':adjustunit(size.height, innfz)});
                    fill.css({'line-height':adjustunit(size.height, fillfz)});
                    cap.css({'line-height':adjustunit(size.height, capfz)});
                }
            }
        }
    }
});xui.Class("xui.UI.Slider", ["xui.UI","xui.absValue"],{
    Instance:{
        _setCtrlValue:function(value){
            return this.each(function(profile){
                var p=profile.properties,
                    steps=p.steps,
                    fun=function(k){return profile.getSubNode(k)},
                    a=fun('IND1'),
                    b=fun('IND2'),
                    c=fun('BG'),
                    v=p.type=='vertical',
                    arr = profile.box._v2a(profile,value),
                    ori = v?'top':'left',
                    orj = v?'height':'width',
                    label, cap=xui.adjustRes(p.labelCaption,true)||"";
                if(p.isRange){
                    a[ori](arr[0]+'%');
                    b[ori](arr[1]+'%');
                    c[ori](arr[0]+'%')[orj]((arr[1]-arr[0])+'%');
                    label = (p.numberTpl+"")
                        .replace(/[*12]/g,function(a){
                            return a=='1'?xui.formatNumeric(arr[0],p.precision||0,null,null,true):
                            a=='2'? xui.formatNumeric(arr[1],p.precision||0,null,null,true)
                            : cap;
                        });
                }else{
                    a[ori](arr[0]+'%');
                    c[orj](arr[0]+'%');
                    label = (p.numberTpl+"")
                        .replace(/1[^2]*2/, '1' )
                        .replace('1', xui.formatNumeric(arr[0],p.precision||0,null,null,true) );
                    if(label.indexOf('*')!=-1)
                        label=label.replace('*', cap);
                    else label += cap;
                }
                if(p.labelPos!='none'&&parseFloat(p.labelSize)){
                    profile.getSubNode('LABEL').html(label );
                }
            });
        },
        _setDirtyMark:function(){
            return arguments.callee.upper.apply(this,['BOX']);
        }
    },
    Static:{
        Templates:{
            style:'{_style}',
            className:'{_className} xui-ui-ellipsis {_cls}',
            LABEL:{
                className:'{_required}',
                style:'{labelShow};width:{_labelSize};{labelHAlign}',
                text:'{labelCaption}'
            },
            BOX:{
                tagName:'div',
                RULER:{
                    $order:1,
                    tagName:'div',
                    className:'xui-uiborder-flat xui-uibase xui-uiborder-radius',
                    BG:{
                        tagName:'div',
                        className:'xui-uibar xui-uiborder-radius'
                    }
                },
                IND:{
                    $order:2,
                    IND1:{
                        tagName:'span',
                        className:'xui-uibar xui-uigradient xui-ui-btn xui-uiborder-circle xuicon xui-icon-placeholder',
                        style:'{_showD}',
                        tabindex:'{tabindex}'
                    },
                    IND2:{
                        tagName:'span',
                        className:'xui-uibar xui-uigradient xui-ui-btn xui-uiborder-circle xuicon xui-icon-placeholder',
                        style:'{_showD2}',
                        tabindex:'{tabindex}'
                    }
                },
                DECREASE:{
                    style:'{_showDes}',
                    className:'xuifont',
                    $fonticon:'{_fi_decls}',
                    tabindex:'{tabindex}'
                },
                INCREASE:{
                    style:'{_showIns}',
                    className:'xuifont',
                    $fonticon:'{_fi_incls}',
                    tabindex:'{tabindex}'
                }
            }
        },
        Appearances:{
            'IND, BT, RULER, IND1, IND2, DECREASE, INCREASE':{
                position:'absolute'
            },
            LABEL:{
               'z-index':1,
               top:0,
               left:0,
               position:'absolute',
               'padding-top':'.5em'
            },
            BOX:{
                position:'absolute',
                left:0,
                top:0,
                width:'100%',
                height:'100%'
            },
            'KEY-h BOX':{
                $order:1,
                height:'2em'
            },
            'KEY-v BOX':{
                $order:2,
                width:'2em'
            },
            'KEY-v LABEL':{
                'writing-mode': 'tb-rl',
                filter: 'flipv fliph'
            },
            'KEY-h DECREASE, KEY-h INCREASE':{
                top:'50%',
                'margin-top':'-.5em'
            },            
            'KEY-h IND1,KEY-h IND2, KEY-v IND1,KEY-v IND2':{
                padding:0,
                margin:0
            },
            'KEY-h DECREASE':{
                $order:1,
                left:0
            },
            'KEY-h INCREASE':{
                $order:1,
                right:0
            },
            BG:{
                position:'absolute',
                left:0,
                top:0,
                height:'100%',
                width:'100%'
            },
            'KEY-h IND':{
                'z-index':1,
                top:'50%',
                height:xui.browser.contentBox?'2px':'4px',
                'margin-top':'-1px'
            },
            'KEY-h RULER':{
                $order:2,
                top:'50%',
                height:xui.browser.contentBox?'2px':'4px',
                'margin-top':'-2px'
            },
            'KEY-v DECREASE, KEY-v INCREASE':{
                $order:10,
                left:'50%',
                'margin-left':'-.5em'
            },            
            'KEY-v DECREASE':{
                $order:10,
                top:0
            },
            'KEY-v INCREASE':{
                $order:10,
                bottom:0
            },
            'KEY-v IND':{
                $order:10,
                'z-index':1,
                left:'50%',
                width:xui.browser.contentBox?'2px':'4px',
                'margin-left':'-1px'
            },
            'KEY-v RULER':{
                $order:10,
                'z-index':1,
                left:'50%',
                width:xui.browser.contentBox?'2px':'4px',
                'margin-left':'-2px'
            },
            'KEY-h IND1,KEY-h IND2':{
                $order:1,
                'z-index':2,
                left:0,
                top:0,
                cursor:'e-resize',
                'margin-top':'-.5em',
                'margin-left':'-.5em'
            },
            'KEY-v IND1,KEY-v IND2':{
                $order:10,
                'z-index':2,
                left:0,
                top:0,
                cursor:'n-resize',
                'margin-top':'-.5em',
                'margin-left':'-.5em'
            }
        },
        Behaviors:{
            HoverEffected:{IND1:'IND1',IND2:'IND2',DECREASE:'DECREASE',INCREASE:'INCREASE'},
            ClickEffected:{IND1:'IND1',IND2:'IND2',DECREASE:'DECREASE',INCREASE:'INCREASE'},
            onSize:xui.UI.$onSize,
            IND:{
                onClick:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return false;
                    var p1=xui.use(src).offset(),
                        p2=xui.Event.getPos(e),
                        arr=profile.box._v2a(profile,profile.properties.$UIvalue),
                        i1,i2,
                        type=p.type=='vertical',
                        k1=type?'top':'left',
                        k2=type?'top':'left',
                        k3=type?'height':'width',
                        cur=p2[k1]-p1[k1],
                        v=(cur/xui.use(src)[k3]())*100;
                    if(!p.isRange)
                        arr[0]=v;
                    else{
                        i1=profile.getSubNode('IND1')[k2](),
                        i2=profile.getSubNode('IND2')[k2]();
                        if(Math.abs(i1-cur)<Math.abs(i2-cur))
                            arr[0]=v;
                        else arr[1]=v;
                    }
                    profile.boxing().setUIValue(profile.box._adjustValue(profile,arr),null,null,'click');
                }
            },
            IND1:{
                onKeydown:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return;
                    var type=p.type=='vertical',
                        key=xui.Event.getKey(e).key;
                    if(key==(type?'up':'left'))
                        profile.box._auto(profile, false);
                    if(key==(type?'down':'right'))
                        profile.box._auto(profile, true);
                },
                onKeyout:function(profile){
                    xui.Thread.abort(profile.$xid+':auto');
                },
                onKeyup:function(profile){
                    xui.Thread.abort(profile.$xid+':auto');
                },
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return;
                    var type=p.type=='vertical',
                        k2=type?'top':'left',
                        k3=type?'height':'width',
                        box=profile.box;
                    xui.use(src).startDrag(e,{
                        widthIncrement:p.steps?profile._size/p.steps:null,
                        dragType:'none',
                        targetReposition:true,
                        horizontalOnly:type?true:null,
                        verticalOnly:type?null:true,
                        maxLeftOffset: xui.use(src)[k2](),
                        maxRightOffset: xui.use(src).parent()[k3]()-xui.use(src)[k2](),
                        dragCursor:'default'
                    });

                    xui.use(src).css('zIndex',10).focus(true);
                    profile.getSubNode('IND2').css('zIndex',5);
                },
                beforeDragbegin:function(profile, e, src){
                    var type=profile.properties.type=='vertical';
                    xui(src)[type?'top':'left'](profile.__x=profile.$px(xui.use(src)[type?'top':'left']()));
                },
                onDrag:function(profile, e, src){
                    var offset=xui.DragDrop.getProfile().offset,
                        type=profile.properties.type=='vertical',
                        arr=profile.box._v2a(profile,profile.properties.$UIvalue);
                    arr[0]=((profile.__x+offset[type?'y':'x'])/xui.use(src).parent()[type?'height':'width']())*100;
                    profile.boxing().setUIValue(profile.box._adjustValue(profile,arr),null,null,'drag');
                },
                onDragstop:function(profile, e, src){
                    xui(src).onMouseout(true,{$force:true}).onMouseup(true);
                },
                onClick:function(){return false}
            },
            IND2:{
                onKeydown:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return;
                    var type=p.type=='vertical',
                        key=xui.Event.getKey(e).key;
                    if(key==(type?'up':'left'))
                        profile.box._auto(profile, false);
                    if(key==(type?'down':'right'))
                        profile.box._auto(profile, true);
                },
                onKeyout:function(profile){
                    xui.Thread.abort(profile.$xid+':auto');
                },
                onKeyup:function(profile){
                    xui.Thread.abort(profile.$xid+':auto');
                },
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return;
                    var type=p.type=='vertical',
                        k2=type?'top':'left',
                        k3=type?'height':'width',
                        box=profile.box;
                    xui.use(src).startDrag(e,{
                        widthIncrement:p.steps?profile._size/p.steps:null,
                        dragType:'none',
                        targetReposition:true,
                        horizontalOnly:type?true:null,
                        verticalOnly:type?null:true,
                        maxLeftOffset: xui.use(src)[k2](),
                        maxRightOffset: xui.use(src).parent()[k3]()-xui.use(src)[k2](),
                        dragCursor:'default'
                    });

                    xui.use(src).css('zIndex',10).focus(true);
                    profile.getSubNode('IND1').css('zIndex',5);
                },
                beforeDragbegin:function(profile, e, src){
                    var type=profile.properties.type=='vertical';
                    xui(src)[type?'top':'left'](profile.__x=profile.$px(xui.use(src)[type?'top':'left']()));
                },
                onDrag:function(profile, e, src){
                    var offset=xui.DragDrop.getProfile().offset,
                        type=profile.properties.type=='vertical',
                        arr=profile.box._v2a(profile,profile.properties.$UIvalue);
                    arr[1]=((profile.__x+offset[type?'y':'x'])/xui.use(src).parent()[type?'height':'width']())*100;
                    profile.boxing().setUIValue(profile.box._adjustValue(profile,arr),null,null,'drag2');
                },
                onDragstop:function(profile, e, src){
                    xui(src).onMouseout(true,{$force:true}).onMouseup(true);
                },
                onClick:function(){return false}
            },
            DECREASE:{
                onMousedown:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    profile.box._auto(profile, false);
                },
                onMouseout:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    xui.Thread.abort(profile.$xid+':auto');
                },
                onMouseup:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    xui.Thread.abort(profile.$xid+':auto');
                }
            },
            INCREASE:{
                onMousedown:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    profile.box._auto(profile, true);
                },
                onMouseout:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    xui.Thread.abort(profile.$xid+':auto');
                },
                onMouseup:function(profile){
                    if(profile.properties.disabled || profile.properties.readonly)return;
                    xui.Thread.abort(profile.$xid+':auto');
                }
            },
            LABEL:{
                onClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelClick)
                        profile.boxing().onLabelClick(profile, e, src);
                },
                onDblClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelDblClick)
                        profile.boxing().onLabelDblClick(profile, e, src);
                },
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    if(profile.properties.disabled)return false;
                     if(profile.onLabelActive)
                        profile.boxing().onLabelActive(profile, e, src);
                }
            }
        },
        DataModel:{
            position:'absolute',
            width:{
                $spaceunit:1,
                ini:'15em'
            },
            height:{
                $spaceunit:1,
                ini:'4em'
            },
            precision:0,
            numberTpl:'* - 1% ~ 2%',
            steps:0,
            value:'0:0',
            type:{
                listbox:['vertical', 'horizontal'],
                ini:'horizontal',
                action:function(v){
                    this.boxing().refresh();
                }
            },
            isRange:{
                ini:true,
                action:function(v){
                    this.boxing().refresh();
                }
            },
            showIncreaseHandle:{
                ini:true,
                action:function(v){
                    this.adjustSize();
                }
            },
            showDecreaseHandle:{
                ini:true,
                action:function(v){
                    this.adjustSize();
                }
            },
            // label
            labelSize:{
                $spaceunit:2,
                ini:0,
                action: function(v){
                    this.getSubNode('LABEL').css({display:v?'':'none'});
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelPos:{
                ini:"left",
                listbox:['none','left','top', 'right', 'bottom'],
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }                
            },
            labelGap:{
                $spaceunit:2,
                ini:4,
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelCaption:{
                ini:"",
                action: function(v){
                     var p=this.properties;
                     if(p.labelPos!='none'&& parseFloat(p.labelSize))
                        this.getSubNode('LABEL').html(xui.adjustRes((xui.isSet(v)?v:"")+"", true));
                }
            },
            labelHAlign:{
                ini:'right',
                listbox:['','left','center','right'],
                action: function(v){
                    this.getSubNode('LABEL').css('textAlign',v);
                }
            }
        },
        EventHandlers:{
            onLabelClick:function(profile, e, src){},
            onLabelDblClick:function(profile, e, src){},
            onLabelActive:function(profile, e, src){}
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile),
                N='display:none',t;
            d._showDes=d.showDecreaseHandle?'':N,
            d._showIns=d.showIncreaseHandle?'':N,
            d._showD2=d.isRange?'':N;
            d._cls=profile.getClass('KEY',d.type=='vertical'?'-v':'-h');
            d.labelHAlign=d.labelHAlign?("text-align:" + d.labelHAlign):"";
            d.labelShow=d.labelPos!='none'&&d.labelSize&&d.labelSize!='auto'?"":"display:none";
            d._labelSize=d.labelSize?'':0+profile.$picku();

            // adjustRes for labelCaption
            if(d.labelPos!='none'&& d.labelSize && d.labelCaption)
                d.labelCaption=xui.adjustRes(d.labelCaption,true);

            d._fi_decls = 'xui-icon-single'+(d.type=='vertical'?'up':'left');
            d._fi_incls = 'xui-icon-single'+(d.type=='vertical'?'down':'right');
            return d;
        },
        _adjustValue:function(profile,value){
            var p = profile.properties,
                b=[];
            b[0]=parseFloat(value[0])||0;
            b[1]=parseFloat(value[1])||0;
            if(p.steps){
                value=100/p.steps;
                b[0]=Math.ceil(b[0]/value);
                if(p.isRange)
                    b[1]=Math.ceil(b[1]/value);
            }
            return p.isRange?b.join(':'):(b[0]+'');
        },
        _ensureValue:function(profile, value){
            var p = profile.properties,
                a = String(value).split(':'),
                min=0,
                max=p.steps?p.steps:100,
                b=[],
                f1=function(a){return parseFloat(a)||0},
                f2=function(a){return Math.min(max, Math.max(min,a))};
            b[0]= f1(a[0]);
            if(p.isRange){
                b[1]= f1(a[1]);
                if(b[0]>b[1]){
                    a=b[1];
                    b[1]=b[0];
                    b[0]=a;
                }
            }
            b[0]= f2(b[0]);
            if(p.isRange)
                b[1]= f2(b[1]);
            return p.isRange?b.join(':'):(b[0]+'');
        },
        _v2a:function(profile,v){
            var steps=profile.properties.steps,t;
            v = typeof v == 'string'? v.split(':') : v;
            v[0]=parseFloat(v[0])||0;v[1]=parseFloat(v[1])||0;
            if(steps)v[0]=v[0]*100/steps;
            if(steps)v[1]=v[1]*100/steps;
            if(v[0]>v[1]){
                t=v[0];
                v[1]=v[0];
                v[0]=t;
            }
            return v;
        },
        _auto:function(profile, flag){
            var id=profile.$xid+':auto';
            if(xui.Thread.isAlive(id))return;
            var p=profile.properties,t,
                //%
                off=(p.steps?100/p.steps:1)*(flag?1:-1),
                task={delay:300},
                arr=profile.box._v2a(profile,p.$UIvalue),
                fun=function(){
                    arr[0] += off;
                    if(p.isRange)
                        arr[1] += off;
                    profile.boxing().setUIValue(profile.box._adjustValue(profile,arr),null,null,'auto');
                    task.delay *=0.8;
                };
            task.task=fun;
            xui.Thread(id,[task],500,null,fun,null,true).start();
        },
        _onresize:function(profile, width, height){
            var prop=profile.properties,
                type=prop.type,
                f=function(k){return profile.getSubNode(k)},
                root = f('KEY'),
                ruler = f('RULER'),
                ind = f('IND'),
                indb = f('IND1'),
                offset = profile.$px('.75em'),
                box = f('BOX'),
                label = f('LABEL'),
                cmd1 = f('INCREASE'),
                cmd2 = f('DECREASE'),
                cb=xui.browser.contentBox,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                fzrate=profile.getEmSize()/root._getEmSize(),
                labelfz=label._getEmSize(fzrate),
                rulerfz = ruler._getEmSize(fzrate),
                indfz = ind._getEmSize(fzrate),

                label = profile.getSubNode('LABEL'),
                labelPos=prop.labelPos,
                labelSize=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelSize,labelfz)||0,
                labelGap=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelGap)||0,
                ll, tt, ww, hh;

            // calculate by px
            if(width && width!='auto')width=profile.$px(width);
            if(height && height!='auto')height=profile.$px(height);

            box.cssPos({
                left : adjustunit(ll = labelPos=='left'?labelSize:0),
                top : adjustunit(tt = labelPos=='top'?labelSize:0)
            });
            cmd2.css('display',prop.showDecreaseHandle?'':'none');
            cmd1.css('display',prop.showIncreaseHandle?'':'none');

            if(type=='vertical'){
                box.cssSize({
                    width : '',
                    height : adjustunit(hh = height===null?null:Math.max(0,(height - ((labelPos=='top'||labelPos=='bottom')?labelSize:0))))
                });
                var w=profile.$px('1em'),
                    w1=prop.showIncreaseHandle?w:0,
                    w2=prop.showDecreaseHandle?w:0,
                    w3=xui.browser.contentBox?indb._borderH('top'):0;
                if(hh){
                    ruler.top(adjustunit(w1+offset,rulerfz))
                        .height(adjustunit(hh-w1-w2-2*offset,rulerfz));
                    ind.top(adjustunit(w1+offset-w3,indfz))
                        .height(adjustunit(hh-w1-w2-2*offset,indfz));
                }

            if(labelSize)
                label.cssRegion({
                    left: adjustunit(width===null?null:Math.max(0,labelPos=='right'?(box.width()+labelGap):0),labelfz),
                    top:  adjustunit(height===null?null:Math.max(0,labelPos=='bottom'?(height-labelSize+labelGap):0),labelfz), 
                    width: '',
                    height: adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):height)),labelfz)
                });
            }else{
                box.cssSize({
                    width : adjustunit(ww = width===null?null:Math.max(0,(width - ((labelPos=='left'||labelPos=='right')?labelSize:0)))),
                    height : ''
                });
                var w=profile.$px('1em'),
                    w1=prop.showDecreaseHandle?w:0,
                    w2=prop.showIncreaseHandle?w:0,
                    w3=!cb?0:indb._borderW('left');
                if(ww){
                    ruler.left(adjustunit(w1+offset, rulerfz))
                        .width(adjustunit(ww-w1-w2-2*offset,rulerfz));
                    ind.left(adjustunit(w1+offset-w3, indfz))
                        .width(adjustunit(ww-w1-w2-2*offset,indfz));
                }

            if(labelSize)
                label.cssRegion({
                    left: adjustunit(width===null?null:Math.max(0,labelPos=='right'?(width-labelSize+labelGap):0),labelfz),
                    top:  adjustunit(height===null?null:Math.max(0,labelPos=='bottom'?(box.height()+labelGap):0),labelfz), 
                    width: adjustunit(width===null?null:Math.max(0,((labelPos=='left'||labelPos=='right')?(labelSize-labelGap):width)),labelfz),
                    height: adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):height)),labelfz)
                });

            }
        }
    }
});xui.Class("xui.UI.Input", ["xui.UI.Widget","xui.absValue"] ,{
    Instance:{
        _setTB:function(type){
            var profile=this.get(0), p=profile.properties, o, t;
            if(!profile.host|| !p.tipsBinder)return;
            var ot=profile.tips;
            t = profile.tips = profile.tips||p.tips||'';
            o = xui.getObject(p.tipsBinder)|| ((o=profile.host[p.tipsBinder]) &&o.get(0) );
            if(o && (o.key=='xui.UI.Span'||o.key=='xui.UI.Div'||o.key=='xui.UI.SLabel')){
                if(o.renderId){
                    //use innerHTML, not setHtml
                    o.getRootNode().innerHTML =  t.charAt(0)=='$'?xui.wrapRes(t):t;
                    o.getRoot().css('color', type==1?'gray':type==2?'red':'#000');
                }
            }
            if(ot!==profile.tips && xui.Tips && xui.Tips.getTips())xui.Tips.setTips(profile.tips);
        },
        activate:function(select){
            var profile = this.get(0);
            if(profile&&profile.renderId){
                var node=profile.getSubNode('INPUT').get(0);
                if(node){
                    try{
                        node.focus(); 
                        if(select || (!xui.browser.fakeTouch && xui.browser.deviceType!='touchOnly')){
                            try{
                                if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                                else xui(node).caret(0,0);
                            }catch(e){}
                        }
                    }catch(e){}
                    delete profile._justFocus;
                }
            }
            return this;
        },
        _setCtrlValue:function(value){
            if(xui.isNull(value) || !xui.isDefined(value))value='';
            return this.each(function(profile){
                if(profile.$Mask && !value){
                    value=profile.$Mask;
                }
                profile.$_inner=1;
                profile.getSubNode('INPUT').attr('value',value+"");
                delete profile.$_inner;
            });
        },
        _getCtrlValue:function(){
            var node=this.getSubNode('INPUT'),
                v= (node&&!node.isEmpty()) ? this.getSubNode('INPUT').attr('value') : "";
            if(v.indexOf("\r")!=-1)v=v.replace(/(\r\n|\r)/g, "\n");
            if(this.get(0).$Mask && this.get(0).$Mask==v){
                v="";
            }
            return v;
        },
        _setDirtyMark:function(){
            return this.each(function(profile){
                var properties = profile.properties,
                    o=profile.getSubNode('INPUT'),
                    cls=profile.box,
                    box=profile.boxing(),
                    d=xui.UI.$css_tag_dirty,
                    v=xui.UI.$css_tag_invalid,
                    flag=properties.value !== properties.$UIvalue;
                var ot=profile.tips;
                if(profile._inValid==2){
                    //display tips
                    profile.tips = properties.tipsErr || properties.tips;
                }else{
                    if(profile._inValid==1)
                        profile.tips = properties.tips;
                    else{
                        profile.tips = properties.tipsOK || properties.tips;
                    }
                }
                if(ot!==profile.tips && xui.Tips && xui.Tips.getTips())xui.Tips.setTips(profile.tips);
                
                if(profile._dirtyFlag!==flag){
                    if(properties.dirtyMark && properties.showDirtyMark){
                        if(profile.beforeDirtyMark && false===box.beforeDirtyMark(profile,flag)){}
                        else{
                            if(profile._dirtyFlag=flag) o.addClass(d);
                            else o.removeClass(d);
                        }
                    }
                    profile._dirtyFlag=flag
                }
                
                //format statux
                if(profile.beforeFormatMark && false===box.beforeFormatMark(profile, profile._inValid==2)){}
                else{
                    var err = profile.getSubNode('ERROR');
                    if(profile._inValid==2){
                        o.addClass(v);
                        err.css('display','block');
                    }else{
                        o.removeClass(v);
                        err.css('display','none');
                    }
                }
                box._setTB(profile._inValid);
            });
        },
        // notify the modification to fake excel ( in module )
        notifyExcel:function(refreshAll){
            return this.each(function(prf){
                var prop=prf.properties, ID='triggerExcelFormulas:';
                if(prop.excelCellId){
                    if(prf.host && prf.host['xui.Module']){
                        ID=ID+prf.host.xid;
                        if(refreshAll===false){
                            if(!xui.resetRun.exists(ID))
                                 if(prf && prf.host)prf.host.triggerExcelFormulas(prf);
                        }else
                            xui.resetRun(ID,function(){
                                if(prf && prf.host)prf.host.triggerExcelFormulas(null);
                            });
                    }
               }
            });
        },
        // get control's fake cexcel cell value
        getExcelCellValue:function(){
            var profile=this.get(0), prop=profile.properties,value,v2;
            if(prop.excelCellId){
                value = this.getUIValue();
                if(xui.isSet( v2 = (profile.onGetExcelCellValue && profile.onGetExcelCellValue(profile, prop.excelCellId, value))))
                    value=v2;
           }
            return value;
        },
        // calculate the formula, and apply to the control
        _applyExcelFormula:function(cellsMap){
            var profile=this.get(0), prop=profile.properties,f,value;
            if(f = prop.excelCellFormula){
                value = xui.ExcelFormula.calculate(f, cellsMap);
                if(xui.isSet(value)){
                    if(profile.beforeApplyExcelFormula && false===profile.beforeApplyExcelFormula(profile, prop.excelCellFormula, value)){}else{
                        this.setUIValue(value, true,null,'formula');
                        if(profile.afterApplyExcelFormula)profile.afterApplyExcelFormula(profile, prop.excelCellFormula, value);
                    }
                }
           }
        }
    },
    Initialize:function(){
        //modify default template fro shell
        var t = this.getTemplate();
        xui.merge(t.FRAME.BORDER,{
            style:'',
            LABEL:{
                className:'{_required} xui-ui-ellipsis',
                style:'{labelShow};width:{_labelSize};{labelHAlign}',
                text:'{labelCaption}'
            },
            BOX:{
                className:'xui-ui-input xui-ui-shadow-input xui-uiborder-flat xui-uiborder-radius xui-uibase',
                WRAP:{
                    tagName : 'div',
                    INPUT:{
                        $order:10,
                        className:'xui-ui-ellipsis',
                        tagName : 'input',
                        type : '{_inputtype}',
                        maxlength:'{maxlength}',
                        tabindex:'{tabindex}',
                        placeholder:"{placeholder}",
                        style:'{_css};{hAlign};'
                    }
                }
            }
        },'all');
        t.FRAME.ERROR = {
            className:'xuifont',
            $fonticon:'xui-icon-error'
        };
        this.setTemplate(t)
    },
    Static:{
        _syncResize:true,
        _maskMap:{
            '~':'[+-]',
    		'1':'[0-9]',
    		'a':'[A-Za-z]',
    		'u':'[A-Z]',
    		'l':'[a-z]',
    		'*':'[A-Za-z0-9]'
        },
        _maskSpace:'_',
        Appearances:{
            KEY:{
                position:'relative'
            },
            BORDER:{
            },
            WRAP:{
                left:0,
                //for firefox bug: cursor not show
                position:'absolute',
                overflow:(xui.browser.gek&&xui.browser.ver<3)?'auto':'visible'
            },
            BOX:{
                left:0,
                top:0,
                position:'absolute',
                overflow:'hidden',
                'z-index':10
            },
            LABEL:{
               $order:100,
               'z-index':1,
               top:0,
               left:0,
               position:'absolute',
               //don't change it in custom class or style
               'padding-top':'4px',
               'padding-bottom':'4px'            
            },
            INPUT:{
               $order:100,
               //don't change it in custom class or style
               'padding-top':'4px',
               'padding-left':'4px',
               'padding-right':'4px',
               'padding-bottom':'4px',

               "background-color":"transparent",
               //"background-image":xui.browser.ie687?'url(.)':null,
               border:0,
               margin:0,
               // default
               'text-align':'left',

               'margin-top':xui.browser.ie67?'-1px':null,
               position:'relative',
               'z-index':10,
               //give default size
               width:'8.5em',

               overflow:xui.browser.ie678?'hidden':'auto',
               'overflow-y':xui.browser.ie678?'hidden':'auto',
               'overflow-x':xui.browser.ie678?'hidden':'hidden',
               resize:'none'
            },
            ERROR:{
                position:'absolute',
                right:'.25em',
                top:'.25em',
                display:'none',
                'z-index':20
            }
        },
        Behaviors:{
            HoverEffected:{BOX:['BOX']},
            NavKeys:{INPUT:1},
            LABEL:{
                onClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelClick)
                        profile.boxing().onLabelClick(profile, e, src);
                },
                onDblClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelDblClick)
                        profile.boxing().onLabelDblClick(profile, e, src);
                },
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    if(profile.properties.disabled)return false;
                     if(profile.onLabelActive)
                        profile.boxing().onLabelActive(profile, e, src);
                }
            },
            INPUT:{
                onChange:function(profile, e, src){
                    if(profile.$_onedit||profile.$_inner||profile.destroyed||!profile.box)return;
                    var p=profile.properties,b=profile.box,
                        o=profile._inValid,
                        instance=profile.boxing(),
                        value=xui.use(src).get(0).value;
                    
                    if(profile.$Mask && profile.$Mask==value){
                        value="";
                    }

                    // trigger events
                    instance.setUIValue(value,null,null,'onchange');
                    // input/textarea is special, ctrl value will be set before the $UIvalue
                    if(p.$UIvalue!==value)instance._setCtrlValue(p.$UIvalue);
                    if(o!==profile._inValid) if(profile.renderId)instance._setDirtyMark();

                    b._asyCheck(profile);
                },
                //if properties.mask exists, onHotKeyxxx wont be tigger any more
                onKeydown:function(profile, e, src){
                   var p=profile.properties,b=profile.box,
                        m=p.multiLines,
                        evt=xui.Event,
                        k=evt.getKey(e);
                    if(p.disabled || p.readonly)return;

                    //fire onchange first
                    if(k.key=='enter'&& (!m||k.altKey))
                        xui.use(src).onChange();

                    b._asyCheck(profile);

                    if(p.mask){
                        if(k.key.length>1)profile.$ignore=true;
                        else delete profile.$ignore;
                        switch(k.key){
                            case 'backspace':
                                b._changeMask(profile,xui.use(src).get(0),'',false);
                                return false;
                            case 'delete':
                                b._changeMask(profile,xui.use(src).get(0),'');
                                return false;
                        }
                    }
                },
                onKeypress:function(profile, e, src){
                    var p=profile.properties,
                    b=profile.box,
                    cls=profile.box,
                    map=cls._maskMap,
                    k=xui.Event.getKey(e),t,
                    caret=xui.use(src).caret();
                    
                    if(profile.beforeKeypress && false===profile.boxing().beforeKeypress(profile,caret, k,e,src))
                        return false;
                    t=profile.CF.beforeKeypress||profile.$beforeKeypress;
                    if(t && false===t(profile,caret,k,e,src))
                        return false;

                    b._asyCheck(profile);

                    if(p.mask){
                        if(profile.$ignore){
                            delete profile.$ignore;
                            return true;
                        }
                        if(k.ctrlKey||k.altKey)return true;

                        cls._changeMask(profile,xui.use(src).get(0),k.key,true);
                        return false;
                    }
                },
                onKeyup:function(profile, e, src){
                    var p=profile.properties,b=profile.box;
                    // must be key up event
                    if(xui.Event.getKey(e).key=='esc'){
                        profile.boxing()._setCtrlValue(p.$UIvalue);
                        if(profile.onCancel)
                            profile.boxing().onCancel(profile);
                    }

                    if(p.dynCheck){
                        var value=xui.use(src).get(0).value;
                        profile.box._checkValid(profile, value);
                        profile.boxing()._setDirtyMark();
                    }
                    b._asyCheck(profile);
                },
                onMousedown:function(profile, e, src){
                    profile._mousedownmark=1;
                    xui.asyRun(function(){if(profile)delete profile._mousedownmark;});
                },
                onMouseup:function(profile, e, src){
                    if(profile.properties.selectOnFocus && profile._justFocus){
                        var node=xui.use(src).get(0);
                        if(!node.readOnly && node.select){
                            profile.$mouseupDelayFun=xui.asyRun(function(){
                                delete profile.$mouseupDelayFun;
                                if(!xui.browser.fakeTouch && xui.browser.deviceType!='touchOnly'){
                                    if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                                }
                            })
                        }
                        delete profile._justFocus;
                    }
                    if(profile._activedonmousedown){
                        delete profile._activedonmousedown;
                        var node=xui.use(src).get(0);
                        if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                    }
                },
                onFocus:function(profile, e, src){
                    if(profile.$ignoreFocus)return false;
                    if(profile.beforeFocus && false===profile.boxing().beforeFocus(profile)){
                        profile.$ignoreBlur=1;
                        xui(src).blur();
                        delete profile.$ignoreBlur;
                        return false;
                    }
                    var p=profile.properties,b=profile.box;
                    if(p.disabled || p.readonly)return false;
                    if(profile.onFocus)profile.boxing().onFocus(profile);
                    profile.getSubNode('BOX').tagClass('-focus');
                    
                    var node=xui.use(src).get(0);
                                        
                    //if no value, add mask
                    if(p.mask){
                        var value=node.value;
                        if(!value){
                            profile.$focusDelayFun=xui.asyRun(function(){
                                // destroyed
                                if(!profile.box)return;
                                delete profile.$focusDelayFun;
                                profile.$_inner=true;
                                node.value=profile.$Mask;
                                delete profile.$_inner;
                                b._setCaret(profile,node);
                            });
                        }
                    }
                    if(p.selectOnFocus && !node.readOnly && node.select){
                        if(xui.browser.kde){
                            profile.$focusDelayFun2=xui.asyRun(function(){
                                delete profile.$focusDelayFun2;
                                if(!xui.browser.fakeTouch && xui.browser.deviceType!='touchOnly'){
                                    if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                                }
                            });
                        }else{
                            if(!xui.browser.fakeTouch && xui.browser.deviceType!='touchOnly'){
                                if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                            }
                        }
                        // if focus was triggerred by mousedown, try to stop mouseup's caret
                        if(profile._mousedownmark)profile._justFocus=1;
                    }
                    //show tips color
                    profile.boxing()._setTB(3);

                    b._asyCheck(profile);
                },
                onBlur:function(profile, e, src){
                    if(profile.$ignoreBlur)return false;
                    xui.resetRun(profile.$xid+":asycheck");
                    if(profile.$focusDelayFun)xui.clearTimeout(profile.$focusDelayFun);
                    if(profile.$focusDelayFun2)xui.clearTimeout(profile.$focusDelayFun2);
                    if(profile.$focusDelayFun2)xui.clearTimeout(profile.$mouseupDelayFun);

                    var p=profile.properties,b=profile.box;
                    if(p.disabled || p.readonly)return false;                    
                    if(profile.onBlur)profile.boxing().onBlur(profile);
                    
                    // allow destory control inonBlur event
                    if (profile.destroyed) return false;
                     
                    profile.getSubNode('BOX').tagClass('-focus',false);
                    var value=xui.use(src).get(0).value;
                    if(profile.$Mask && profile.$Mask==value){
                        value="";
                    }
                    //onblur check it
                    if(p.$UIvalue==value)
                        profile.box._checkValid(profile, value);

                    profile.boxing()._setDirtyMark();
                    b._asyCheck(profile,false);
                }
            }
        },
        DataModel:{
            selectable:true,

            tipsErr:'',
            tipsOK:'',

            dynCheck:false,
            selectOnFocus:true,
            placeholder: {
                ini: '',
                action: function (value) {
                    this.getSubNode('INPUT').attr('placeholder', value);
                }
            },
            // label
            labelSize:{
                $spaceunit:2,
                ini:'0',
                action: function(v){
                    this.getSubNode('LABEL').css({display:v?'':'none'});
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelPos:{
                ini:"left",
                listbox:['none','left','top', 'right', 'bottom'],
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }                
            },
            labelGap:{
                $spaceunit:2,
                ini:'4',
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelCaption:{
                ini:"",
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('LABEL').html(xui.adjustRes(v,true));
                }
            },
            labelHAlign:{
                ini:'right',
                listbox:['','left','center','right'],
                action: function(v){
                    this.getSubNode('LABEL').css('textAlign',v);
                }
            },

            valueFormat:{
                helpinput:[
                    {caption : 'required', id: "[^.*]"},
                    {caption : 'email',id:"^[\\w\\.=-]+@[\\w\\.-]+\\.[\\w\\.-]{2,4}$"},
                    {caption : 'charOnly',id:"^[a-zA-Z]*$"},
                    {caption : 'words',id:"^[\\w ]*$"},
                    {captoin :  'size',id:"^(([1-9]\d*\.\d+)|([1-9]\d*)|(\.\d\d*))\s*(px|em)?$"},
                    {caption : 'integer',id:"^-?\\d\\d*$"},
                    {caption : 'positiveInteger',id:"^\\d\\d*$"},
                    {caption : 'number',id:"^-?(\\d\\d*\\.\\d*$)|(^-?\\d\\d*$)|(^-?\\.\\d\\d*$)"},
                    {caption : 'filepath',id:"([\\/]?[\\w_]+)+\\.\\w{1,9}$"},
                    {caption : 'URL', id:"^(http|https|ftp)\\:\\/\\/[\\w\\-\\_\\.]+[\\w\\-\\_](:[\\w]*)?\\/?([\\w\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*$"},
                    {caption : 'color',id:"^\\#[0-9A-Fa-f]{6}$"},
                    {caption : "HH:MM", id:"^\(\([0-1][0-9]\)|\([2][0-3])\)\:\([0-5][0-9]\)$"},
                    {caption : "HH:MM:SS", id:"^\(\([0-1][0-9]\)|\([2][0-3])\)\:\([0-5][0-9]\)\\:\([0-5][0-9]\)$"},
                    {caption : "YYYY-MM-DD",id:"^\([0-9]{4}\)\\-\(\([0][0-9]\)|\([1][0-2]\)\)\\-\([0-3][0-9]\)$"},
                    {caption : "DD/MM/YYYY",id:"^\(\([0-2][0-9]\)|\([3][0-1]\)\)\/\(\([0][0-9]\)|\([1][0-2]\)\)\/\([0-9]{4}\)$"}
                ]
            },
            mask:{
                action:function(value){
                    var ns=this,
                        b=ns.box;
                    if(value){
                        ns.$MaskFormat=function(ns, v){
                            var m=ns._maskMap,a=[],r=/[A-Za-z0-9]/;
                            xui.arr.each(v.split(''),function(o,i){
                                a.push(m[o]||(r.test(o)?"":"\\")+o)
                            });
                            return '^'+a.join('')+'$';
                        }(b, value);
                        ns.$Mask = function(ns, v){
                            var m=ns._maskMap,a=[],s=ns._maskSpace;
                            xui.arr.each(v.split(''),function(o,i){
                                a.push(m[o]?s:o);
                            });
                            return  a.join('');
                        }(b,value);
                        var uiv=ns.properties.$UIvalue;
                        uiv=xui.isSet(uiv)?(uiv+""):"";
                        //visibility mask string
                        ns.boxing()._setCtrlValue(uiv + ns.$Mask.slice(uiv.length));
                   }else{
                        delete ns.$MaskFormat;
                        delete ns.$Mask;
                   }
                }
            },
            value:'',
            width:{
                $spaceunit:1,
                ini:'10em'
            },
            height:{
                $spaceunit:1,
                ini:'auto'
            },
            hAlign:{
                ini:'',
                listbox:['','left','center','right'],
                action: function(v){
                    this.getSubNode("INPUT").css('textAlign',v);
                }
            },
            disabled:{
                ini:false,
                action: function(v){
                    this.box._handleInput(this, "xui-ui-disabled", v);
                }
            },
            readonly:{
                ini:false,
                action: function(v){
                    this.box._handleInput(this, "xui-ui-readonly", v);
                }
            },
            type:{
                ini:'text',
                listbox:['text','password'],
                set:function(value){
                    var pro=this;
                    pro.properties.type=value;
                    if(pro.renderId)
                        pro.boxing().refresh(true);
                }
            },
            maxlength:{
            	ini:-1,
            	action: function(value){
                  this.getSubNode('INPUT').attr('maxlength',value);
                }
            },
            multiLines:{
                ini:false,
                action: function(value){
                    this.boxing().refresh();
                }
            },
            tipsBinder:{
                ini:'',
                set:function(value){
                    if(value['xui.UIProfile'])
                        value=value.$xid;
                    if(value['xui.UI'] && (value=value.get(0)))
                        value=value.$xid;
                    this.properties.tipsBinder = value +'';
                }
            },
            excelCellId:{
                ini:"",
                action:function(){
                    this.boxing().notifyExcel(false);
                }
            },
            excelCellFormula:{
                ini:"",
                action:function(v){
                    var prf=this,m,
                        prop=prf.properties;
                    if(v && xui.ExcelFormula.validate(v)){
                        if(prf.host && (m=prf.host['xui.Module'])){
                            m.applyExcelFormula(prf);
                        }
                   }
                }
            }
        },
        EventHandlers:{
            beforeFocus:function(profile){},
            onFocus:function(profile){},
            onBlur:function(profile){},
            onCancel:function(profile){},
            beforeFormatCheck:function(profile, value){},
            beforeFormatMark:function(profile, formatErr){},
            beforeKeypress:function(profile,caret,keyboard,e,src){},
            
            onLabelClick:function(profile, e, src){},
            onLabelDblClick:function(profile, e, src){},
            onLabelActive:function(profile, e, src){},

            onGetExcelCellValue:function(profile, excelCellId, dftValue){},
            beforeApplyExcelFormula:function(profile, excelCellFormula, value){},
            afterApplyExcelFormula:function(profile, excelCellFormula, value){}
        },
        _handleInput:function(prf,cls, v){
            var i=prf.getSubNode('INPUT');                        
            if((""+i.get(0).type).toLowerCase()!='button'){
                if(!v && (prf.properties.disabled||prf.properties.readonly))
                    v=true;
                prf.getRoot()[v?'addClass':'removeClass'](cls);
                i.attr('readonly',v);
            }
        },
        _prepareData:function(profile){
            var data={},prop=profile.properties,t
            if(prop.height=='auto'){
                data.height  = '1.83em';
            }
            var d=arguments.callee.upper.call(this, profile, data);

            d._inputtype = d.type || '';
            if(d.maxlength<0)d.maxlength="";
            
            if(xui.browser.kde)
                d._css='resize:none;';
            d.hAlign=d.hAlign?("text-align:" + d.hAlign):"";
            
            d.labelHAlign=d.labelHAlign?("text-align:" + d.labelHAlign):"";
            d.labelShow=d.labelPos!='none'&&d.labelSize&&d.labelSize!='auto'?"":"display:none";
            d._labelSize=d.labelSize?'':0+profile.$picku();
    
            // adjustRes for labelCaption
            if(d.labelCaption)
                d.labelCaption=xui.adjustRes(d.labelCaption,true);

            return d;
        },
        _dynamicTemplate:function(profile){
            var properties = profile.properties,t,
                hash = profile._exhash = "$" +'multiLines:'+properties.multiLines,
                template = profile.box.getTemplate(hash);

            properties.$UIvalue = properties.value;

            // set template dynamic
            if(!template){
                template = xui.clone(profile.box.getTemplate());
                if(properties.multiLines){
                    t=template.FRAME.BORDER.BOX.WRAP.INPUT;
                    t.tagName='textarea';
                    t.className='';
                    delete t.type;
                }

                // set template
                profile.box.setTemplate(template, hash);
            }
            profile.template = template;
        },
        _ensureValue:function(profile, value){
            // ensure return string
            return ""+(xui.isSet(value)?value:"");
        },
        RenderTrigger:function(){
            var ns=this,p=ns.properties;
            xui.asyRun(function(){
                if(ns.box)
                    ns.boxing()._setTB(1);
            });
            ns.getSubNode('WRAP').$firfox2();
            if(p.readonly)
                ns.boxing().setReadonly(true,true);
            if(p.tipsBinder)
                ns.boxing().setTipsBinder(p.tipsBinder,true);
            if(p.excelCellId)
                ns.boxing().notifyExcel();
            //add event for cut/paste text
            var ie=xui.browser.ie,
                src=ns.getSubNode('INPUT').get(0),
                b=ns.box,
                f=function(o){
                    if(ie && ('propertyName' in o) && o.propertyName!='value')return;
                    b._asyCheck(ns,false);
                };
            if(ie && src.attachEvent){
                src.attachEvent("onpropertychange",f);
                src.attachEvent("ondrop",f);
                ns.$ondestory=function(){
                    var src=this.getSubNode('INPUT').get(0);
                    if(src){
                        src.detachEvent("onpropertychange",f);
                        src.detachEvent("ondrop",f);
                    }
                    src=f=null;
                }
            }else{
                src.addEventListener("input",f,false);
                src.addEventListener("drop",f,false);
                //Firefox earlier than version 3.5
                if(xui.browser.gek)
                    src.addEventListener("dragdrop",f,false);

                ns.$ondestory=function(){
                    var src=this.getSubNode('INPUT').get(0);
                    if(src){
                        src.removeEventListener("input",f,false);
                        src.removeEventListener("drop",f,false);
                        if(xui.browser.gek)
                            src.removeEventListener("dragdrop",f,false);
                    }
                    src=f=null;
                }
            }
            src=null;
        },
        LayoutTrigger:function(){
            var p = this.properties;
            if(p.mask)this.boxing().setMask(p.mask,true);
        },
    //v=value.substr(0,caret);
    //i=v.lastIndexOf(ms);

        _changeMask:function(profile,src,v,dir,resetCaret){
            if(false!==resetCaret){
                var ns=this,
                    p=profile.properties,
                    map=ns._maskMap,
                    ms=ns._maskSpace,
                    maskTxt=p.mask,
                    maskStr = profile.$Mask,
                    input = xui(src),
                    caret = input.caret();
                //for backspace
                if(dir===false && caret[0]==caret[1] && caret[0]>0)
                    input.caret(caret[0]-1,caret[0]);
    
                //for delete
                if(dir===undefined && caret[0]==caret[1])
                    input.caret(caret[0],caret[0]+1);
    
                //for caret is from a fix char, nav to the next 'input allow' char
                if(dir===true){
                    if(maskStr.charAt(caret[0])!=ms){
                        var from = caret[0] + maskStr.substr(caret[0],maskStr.length).indexOf(ms);
                        input.caret(from,Math.max(caret[1],from))
                    }
                }
    
                var caret = input.caret(),
                    value=src.value,
                    cc=p.mask.charAt(caret[0]),
                    reg = ns._maskMap[cc],
                    i,t;
    
                if(reg && v && v.length==1){
                    if(cc=='l')
                        v=v.toLowerCase();
                    else if(cc=='u')
                        v=v.toUpperCase();
                }

                if(reg && new RegExp('^'+reg+'$').test(v) || v==''){
                    t=value;
                    //if select some text
                    if(caret[0]!=caret[1])
                        t=t.substr(0,caret[0]) + maskStr.substr(caret[0],caret[1]-caret[0]) + t.substr(caret[1],t.length-caret[1]);
                    //if any char input
                    if(v)
                        t=t.substr(0,caret[0])+v+t.substr(caret[0]+1,t.length-caret[0]-1);
    
                    //get corret string according to maskTxt
                    var a=[];
                    xui.arr.each(maskTxt.split(''),function(o,i){
                        a.push( map[o]?(((new RegExp('^'+map[o]+'$')).test(t.charAt(i))) ? t.charAt(i) : maskStr.charAt(i)) : maskStr.charAt(i))
                    });
    
                    //if input visible char
                    if(dir===true){
                        v=maskStr.substr(caret[0]+1,value.length-caret[0]-1);
                        i=v.indexOf(ms);
                        i=caret[0] + (i==-1?0:i) + 1;
                    }else
                        i=caret[0];
                    //in opera, delete/backspace cant be stopbubbled
                    //add a dummy maskSpace
                    if(xui.browser.opr){
                        //delete
                        if(dir===undefined)
                            xui.arr.insertAny(a,ms,i);
                        //backspace
                        if(dir===false)
                            xui.arr.insertAny(a,ms,i++);
                    }
                    value=a.join('');
                    src.value=value;
                    // maybe cant fire _setCtrlValue
                    profile.boxing().setUIValue(value==maskStr?"":value,null,null,'mask');
                    ns._setCaret(profile,src,i);
                }
            }else{
                var ns=this,
                    p=profile.properties,
                    map=ns._maskMap,
                    maskTxt=p.mask,
                    maskStr=profile.$Mask,
                    t=src.value,
                    a=[];
                //get corret string according to maskTxt
                xui.arr.each(maskTxt.split(''),function(o,i){
                    a.push( (new RegExp('^'+(map[o]?map[o]:'\\'+o)+'$').test(t.charAt(i))) ? t.charAt(i) : maskStr.charAt(i))
                });
                value=a.join('');
                src.value=value;
                // maybe cant fire _setCtrlValue
                profile.boxing().setUIValue(value==maskStr?"":value,null,null,'mask');
            }

        },
        _setCaret:function(profile, src, pos){
            if(profile.properties.mask){
                if(typeof pos !='number')
                    pos=src.value.indexOf(this._maskSpace);
                xui(src).caret(pos,pos);
            }
        },
        // for checking html <input>
        _checkValid2:function(profile){
            if(!profile.renderId)return true;
            return this._checkValid(profile, profile.getSubNode('INPUT').get(0).value);
        },
        //check valid manually
        _checkValid:function(profile, value){
            var p=profile.properties,
                vf1 = (p.mask&&profile.$MaskFormat) ,
                vf2 = p.valueFormat || profile.$valueFormat;
            
            if(profile.boxing()._toEditor)value=profile.boxing()._toEditor(value);

            if( (profile.beforeFormatCheck && (profile.boxing().beforeFormatCheck(profile, value)===false)) ||
                // if inputs, check mask valid, or don't
                (((value&&value.length) && profile.$Mask!==value) && (vf1 && typeof vf1=='string' && !(new RegExp(vf1)).test((value===0?'0':value)||''))) ||
                (vf2 && typeof vf2=='string' && !(new RegExp(vf2)).test((value===0?'0':value)||''))
            ){
                profile._inValid=2;
                return false;
            }{
                profile._inValid=3;
                return true;
            }
        },
        _asyCheck:function(profile,resetCaret){
            if(profile.destroyed)return;
            if(!profile.properties.dynCheck && !profile.properties.mask)return;

            xui.resetRun(profile.$xid+":asycheck",function(){
                if(!profile.renderId)return;

                var input=profile.getSubNode("INPUT"),
                    src=input.get(0);
                if(!src)return;
                    
                //for mask
                if(profile.properties.mask){
                    if(src.value.length != profile.$Mask.length)
                        profile.box._changeMask(profile,src,'',true,resetCaret);
                }

                //for onchange event
                if(profile.properties.dynCheck){
                    var v=src.value;
                    if(profile.$Mask && profile.$Mask==v){
                        v="";
                    }
                    // dont trigger _setContrlValue
                    profile.boxing().setUIValue(v,false,true,'asycheck');
                }
            });
        },
        _onresize:function(profile,width,height){
            if(profile._$ignoreonsize)return;

            var prop = profile.properties,
                // if any node use other font-size which does not equal to xui-node, use 'px' 
                f=function(k){if(!k) return null; k=profile.getSubNode(k); return k;},
                root=f('KEY'),
                v1=f('INPUT'),
                box = f('BOX'),
                label = f('LABEL'),

                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                fzrate=profile.getEmSize()/root._getEmSize(),
                v1fz=v1._getEmSize(fzrate),
                labelfz=label._getEmSize(fzrate),

                $hborder, $vborder,

                clsname='xui-node xui-input-input',
                cb=xui.browser.contentBox,
                paddingH=!cb?0:Math.round(v1._paddingH()/2)*2,
                paddingW=!cb?0:Math.round(v1._paddingW()/2)*2,
                autoH,
                boxB=box._borderW();
            
            $hborder=$vborder=!cb?0:boxB/ 2;
            
            // calculate by px
            if(height)height = (autoH=height=='auto') ? profile.$em2px(!cb?1.6666667:1,null,true) + paddingH + boxB : profile.$isEm(height) ? profile.$em2px(height,null,true) : height;
            if(width)width = profile.$isEm(width) ? profile.$em2px(width,null,true) : width;

            // for auto height
            if(autoH){
                profile._$ignoreonsize=1;
                root.height(adjustunit(height));
                delete profile._$ignoreonsize;
            }

            var labelPos=prop.labelPos,
                labelSize=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelSize,labelfz)||0,
                labelGap=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelGap)||0,

                ww=width,
                hh=height,
                left=Math.max(0, (prop.$b_lw||0)-$hborder),
                top=Math.max(0, (prop.$b_tw||0)-$vborder);
            if(null!==ww){
                ww -= Math.max($hborder*2, (prop.$b_lw||0)+(prop.$b_rw||0));
                /*for ie6 bug*/
                /*for example, if single number, 100% width will add 1*/
                /*for example, if single number, attached shadow will overlap*/
                if(xui.browser.ie6)ww=(Math.round(parseFloat(ww/2)))*2;
            }
            if(null!==hh){
                hh -=Math.max($vborder*2, (prop.$b_lw||0) + (prop.$b_rw||0));

                if(xui.browser.ie6)hh=(Math.round(parseFloat(hh/2)))*2;
                /*for ie6 bug*/
                if(xui.browser.ie6&&null===width)box.ieRemedy();
            }
            var iL=left + (labelPos=='left'?labelSize:0),
                iT=top + (labelPos=='top'?labelSize:0),
                iW=ww===null?null:Math.max(0,ww - ((labelPos=='left'||labelPos=='right')?labelSize:0)),
                iH=hh===null?null:Math.max(0,hh - ((labelPos=='top'||labelPos=='bottom')?labelSize:0)),
                iH2=hh===null?null:Math.max(0,height - ((labelPos=='top'||labelPos=='bottom')?labelSize:0));

            if(null!==iW && iW-paddingW>0)
                v1.width(adjustunit(Math.max(0,iW-paddingW),v1fz));
            if(null!==iH && iH-paddingH>0)
                v1.height(adjustunit(Math.max(0,iH-paddingH),v1fz));

            box.cssRegion({
                left:adjustunit(iL),
                top:adjustunit(iT),
                width:adjustunit(iW),
                height:adjustunit(iH)
            });
            
            if(labelSize)
                label.cssRegion({
                    left:adjustunit(ww===null?null:labelPos=='right'?(ww-labelSize+labelGap+$hborder*2):0,labelfz),
                    top: adjustunit(height===null?null:labelPos=='bottom'?(height-labelSize+labelGap):0,labelfz), 
                    width:adjustunit(ww===null?null:Math.max(0,((labelPos=='left'||labelPos=='right')?(labelSize-labelGap):ww)),labelfz),
                    height:adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):height)-paddingH),labelfz)
                });

            iL += (iW||0) + $hborder*2;

            /*for ie6 bug*/
            if((profile.$resizer) && xui.browser.ie){
                box.ieRemedy();
            }
        }
    }
});xui.Class("xui.UI.CheckBox", ["xui.UI","xui.absValue"],{
    Initialize:function(){
        // compitable
        xui.UI.SCheckBox = xui.UI.CheckBox;
        var key="xui.UI.SCheckBox";
        xui.absBox.$type[key.replace("xui.UI.","")]=xui.absBox.$type[key]=key;
    },
    Instance:{
        fireClickEvent:function(){
            this.getRoot().onClick();
            return this;
        },
        activate:function(){
            this.getSubNode('FOCUS').focus(true);
            return this;
        },
        _setCtrlValue:function(value){
            return this.each(function(profile){
               profile.getSubNode('MARK').tagClass('-checked', !!value);
            });
        },
        //update UI face
        _setDirtyMark:function(){
            return arguments.callee.upper.apply(this,['CAPTION']);
        },
        notifyExcel:xui.UI.Input.prototype.notifyExcel,
        // get control's fake cexcel cell value
        getExcelCellValue:xui.UI.Input.prototype.getExcelCellValue
    },
    Static:{
        Templates:{
            className:'{_className} ',
            style:'{_style} {_align}',
            FOCUS:{
                tabindex: '{tabindex}',
                MARK:{
                    $order:0,
                    className:'{_iconPosCls} xuifont',
                    $fonticon:'xui-uicmd-check'
                },
                ICON:{
                    $order:1,
                    className:'xuicon {imageClass}  {picClass}',
                    style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                    text:'{iconFontCode}' 
                },
                CAPTION:{
                    $order:2,
                    text:'{caption}'
                }
            }
        },
        Appearances:{
            KEY:{
                overflow:'visible'
            },
            MARK:{
               cursor:'pointer',
               margin: '0 .334em 0 .1667em',
               'vertical-align':'middle'
            },
            FOCUS:{
                cursor:'default',
                'vertical-align':'middle',
                padding:'.1667em 0'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            }
        },
        Behaviors:{
            HoverEffected:{KEY:'MARK',ICON:'ICON'},
            ClickEffected:{KEY:'MARK'},
            NavKeys:{FOCUS:1},
            onClick:function(profile, e, src){
                var p=profile.properties,b=profile.boxing();
                if(p.disabled)return false;
                if(p.readonly)return false;
                b.setUIValue(!p.$UIvalue,null,null,'click');
                if(profile.onChecked)b.onChecked(profile, e, p.$UIvalue);
                profile.getSubNode('FOCUS').focus(true);
            },
            FOCUS:{
                onKeydown:function(profile, e, src){
                    var key = xui.Event.getKey(e).key;
                    if(key ==' ' || key=='enter'){
                        profile.getRoot().onClick(true);
                        return false;
                    }
                }
            }
        },
        DataModel:{
            value:false,
            hAlign:{
                ini:'left',
                listbox:['left','center','right'],
                action: function(v){
                    this.getRoot().css('textAlign',v);
                }
            },
            iconPos:{
                ini:'left',
                listbox:['left','right'],
                action:function(v){
                    this.getSubNode("MARK").removeClass('xui-float-left xui-float-right').addClass('xui-float-'+v);
                }
            },
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            caption:{
                ini:undefined,
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('CAPTION').html(xui.adjustRes(v,true));
                }
            },
            excelCellId:{
                ini:"",
                action:function(){
                    this.boxing().notifyExcel(false);
                }
            }
        },
        EventHandlers:{
            onChecked:function(profile, e, value){},
            onGetExcelCellValue:function(profile, excelCellId, dftValue){}
        },
        RenderTrigger:function(){
            var ns=this,p=ns.properties;
            if(p.excelCellId)
                ns.boxing().notifyExcel();
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            data._align = 'text-align:'+data.hAlign+';';
            data._iconPosCls = 'xui-float-'+data.iconPos;
            return data;
        },
        _ensureValue:function(profile, value){
            return value==="0"?false:!!value;
        }
    }
});
xui.Class("xui.UI.HiddenInput", ["xui.UI", "xui.absValue"] ,{
    Instance:{
        activate:function(){
            return this;
        },
        _setCtrlValue:function(value){
            if(xui.isNull(value) || !xui.isDefined(value))value='';
            return this.each(function(profile){
                profile.getSubNode('KEY').attr('value',value+"");
            });
        },
        _getCtrlValue:function(){
            var node=this.getSubNode('KEY');
            if(v.indexOf("\r")!=-1)v=v.replace(/(\r\n|\r)/g, "\n");
            return v;
        }
    },
    Static:{
        $initRootHidden:true,
        Templates:{
            className:'xui-display-none',
            style:'display:none',
            tagName:'input',
            type:'hidden'
        },
        DataModel:{
            locked:null,
            required:null,
            dataBinder:null,
            dataField:null,
            display:null,
            visibility:null,
            position:null,
            left:null,
            top:null,
            right:null,
            bottom:null,
            width:null,
            height:null,
            rotate:null,
            showEffects:null,
            hideEffects:null,
            activeAnim:null,
            tabindex:null,
            zIndex:null,
            defaultFocus:null,
            hoverPop:null,
            hoverPopType:null,
            disabled:null,
            readonly:null,
            disableClickEffect:null,
            disableHoverEffect:null,
            dock:null,
            dockOrder:null,
            dockMargin:null,
            dockMinW:null,
            dockMinH:null,
            dockMaxW:null,
            dockMaxH:null,
            dockFloat:null,
            dockIgnore:null,
            dirtyMark:null,
            showDirtyMark:null,
            selectable:null,
            autoTips:null,
            tips:null,
            disableTips:null,
            renderer:null,
            className:null
        },
        EventHandlers:{
            beforeDirtyMark:null,
            onContextmenu:null,
            onDock:null,
            onLayout:null,
            onMove:null,
            onRender:null,
            onResize:null,
            onShowTips:null,
            beforeAppend:null,
            afterAppend:null,
            beforeRender:null,
            afterRender:null,
            beforeRemove:null,
            afterRemove:null,
            onHotKeydown:null,
            onHotKeypress:null,
            onHotKeyup:null
        },
        _ensureValue:function(profile, value){
            // ensure return string
            return ""+(xui.isSet(value)?value:"");
        }
    }
});xui.Class("xui.UI.RichEditor", ["xui.UI","xui.absValue"],{
    Initialize:function(){
        this.addTemplateKeys(['TOOLBARBTN']);
    },
    Instance:{
        getEditorWin:function(){
            return this.get(0).$win;
        },
        getEditorDoc:function(){
            return this.get(0).$doc;
        },
        getEditorBody:function(){
            var doc=this.get(0).$doc;
            return doc && (doc.body||doc.documentElement);
        },
        _setCtrlValue:function(value){
            if(!xui.isSet(value))value='';
            return this.each(function(profile){
                var sp=window['/'];
                if(sp && sp.indexOf(':/')!=-1)
                    value=value.replace(/{\/}/g,sp);
                var html=profile.$useOriginalText?value:xui.adjustRes(value,0,1);
                if(!profile.$inDesign){
                    var doc=profile.$doc, body=doc && (doc.body||doc.documentElement);
                    if(body){
                        body.innerHTML=html;
                        return;
                    }
                }
                 profile.getSubNode("EDITOR").html(html);
            });
        },
        _getCtrlValue:function(){
            var profile=this.get(0);
            if(!profile.$inDesign){
                var doc=profile.$doc,
                    body=doc && (doc.body||doc.documentElement);
                 if(body){
                    var v=body.innerHTML,sp=window['/'];
                    if(sp && sp.indexOf(':/')!=-1)
                        v=v.replace(new RegExp(sp,'g'), '{/}');
                    return v;
                }else
                    return '';
            }else{
                return profile.getSubNode("EDITOR").html();
            }
        }
    },
    Static:{
        DIRYMARKICON:"DIRTYMARK",
        Templates:{
            tagName:'div',
            style:'{_style}',
            className:'{_className} xui-ui-selectable',
            LABEL:{
                className:'{_required} xui-ui-ellipsis',
                style:'{labelShow};width:{_labelSize};{labelHAlign}',
                text:'{labelCaption}'
            },
            BOX:{
                EDITOR:{
                    tagName:'div',
                    className:'xui-uiborder-flat xui-uiborder-radius xui-uibase'
                },
                DIRTYMARK:{},
                POOL:{}
            }
        },
        DataModel:{
            selectable:true,
            value:{
                ini:'',
                html:1
            },
            width:{
                $spaceunit:1,
                ini:'32em'
            },
            height:{
                $spaceunit:1,
                ini:'25em'
            },
            frameTemplate:{
                ini:'<html style="-webkit-overflow-scrolling: touch;padding:0;margin:0;">'+
                        '<head>'+
                            '<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+
                            '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\">'+
                            '<style type="text/css">'+
                                'body{height: 100%;-webkit-overflow-scrolling: touch;border:0;padding:0;margin:.5em;cursor:text;color:#000;font-family:sans-serif,Arial,Verdana,"Trebuchet MS";font-style:normal;font-weight:normal;font-size:12px;line-height:1.22em}'+
                                'div, p{margin:0;padding:0;} '+
                                'body, p, div{word-wrap: break-word;} '+
                                'img, input, textarea{cursor:default;}'+
                            '</style>'+
                        '</head>'+
                        '<body scroll="auto" spellcheck="false"></body>'+
                    '</html>',
                action:function(){
                    this.boxing().refresh();
                }
            },
            frameStyle:"",
            cmdList:{
                ini:'font1;font2;align;list;font4;font3;insert;clear;html',
                action:function(v){
                    var ns=this;
                    if(!ns.properties.disabled && !ns.properties.readonly)
                        ns.box._iniToolBar(ns);
                }
            },
            cmdFilter:{
                ini:''
            },
            disabled:{
                ini:false,
                action: function(disabled){
                    var disabled=this.properties.disabled||this.properties.readonly,
                        doc=this.$doc;
                    if(doc){
                        if (doc.body.contentEditable != undefined && xui.browser.ie)
                           doc.body.contentEditable = disabled?"false":"true";
                        else
                           doc.designMode=disabled?"off":"on";
                        
                        this.box._iniToolBar(this, !disabled);
                    }
                }
            },
            readonly:{
                ini:false,
                action: function(v){
                    this.boxing().setDisabled(v);
                }
            },
           // label
            labelSize:{
                $spaceunit:2,
                ini:0,
                action: function(v){
                    this.getSubNode('LABEL').css({display:v&&v!='auto'?'':'none'});
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelPos:{
                ini:"left",
                listbox:['none','left','top', 'right', 'bottom'],
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }                
            },
            labelGap:{
                $spaceunit:2,
                ini:4,
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelCaption:{
                ini:"",
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('LABEL').html(xui.adjustRes(v,true));
                }
            },
            labelHAlign:{
                ini:'right',
                listbox:['','left','center','right'],
                action: function(v){
                    this.getSubNode('LABEL').css('textAlign',v);
                }
            }
        },
        Appearances:{
            KEY:{
                overflow:"hidden"
            },
            BOX:{
                left:0,
                top:0,
                width:'100%',
                position:'absolute',
                overflow:'hidden'
            },
            POOL:{
                position:'absolute',
                display:'none'
            },
            DIRTYMARK:{
                position:'absolute',
                width:"1em",
                height:"1em"
            },
            TOOLBARBTN:{
            },
            LABEL:{
               'z-index':1,
               top:0,
               left:0,
               position:'absolute',
               'padding-top':'.5em'
            },
            EDITOR:{
                position:'absolute',
                display:'block',
                left:0,
                top:0,
                width:'100%',
                height:'100%',
                padding:0,
                margin:0,
                'z-index':'10'
            }
        },
        Behaviors:{
            onSize:xui.UI.$onSize,
            LABEL:{
                onClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelClick)
                        profile.boxing().onLabelClick(profile, e, src);
                },
                onDblClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelDblClick)
                        profile.boxing().onLabelDblClick(profile, e, src);
                },
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    if(profile.properties.disabled)return false;
                     if(profile.onLabelActive)
                        profile.boxing().onLabelActive(profile, e, src);
                }
            }
        },
        EventHandlers:{
            onInnerEvent : function(profile, type, node, e){},
            onUpdateToolbar : function(profile, etype, doc){},
            onReady : function(profile){},
            
            onLabelClick:function(profile, e, src){},
            onLabelDblClick:function(profile, e, src){},
            onLabelActive:function(profile, e, src){}
        },
        $cmds:{
            //font style
            font1:[
                 {id:'bold',command:'Bold',statusButton:true,imageClass:'xuifont xui-icon-bold',_fi_:'xui-icon-bold'},
                 {id:'italic',command:'Italic',statusButton:true,imageClass:'xuifont xui-icon-italic',_fi_:'xui-icon-italic'},
                 {id:'underline',command:'Underline',statusButton:true,imageClass:'xuifont xui-icon-underline',_fi_:'xui-icon-underline'},
                 {id:'strikethrough',command:'strikeThrough',statusButton:true,imageClass:'xuifont xui-icon-strikethrough',_fi_:'xui-icon-strikethrough'}
            ],
            font2:[
                {id:'subscript',command : 'subscript',statusButton:true,imageClass:"xuifont xui-icon-sub",_fi_:'xui-icon-sub'},
                {id:'superscript',command : 'superscript',statusButton:true,imageClass:"xuifont xui-icon-super",_fi_:'xui-icon-super'}
            ],
            font3:[
                {id:'forecolor',command:'custom',imageClass:"xuifont xui-icon-forecolor",_fi_:'xui-icon-forecolor'},
                {id:'bgcolor',command:'custom',imageClass:"xuifont xui-icon-bgcolor",_fi_:'xui-icon-bgcolor'}
            ],
            font4:[
                {id:'fontsize',command:'custom',caption:'$editor.fontsize',dropButton:true},
                {id:'fontname',command:'custom',caption:'$editor.fontname',dropButton:true},
                {id:'formatblock',command:'custom',caption:'$editor.formatblock',dropButton:true}
            ],
            align:[
                {id:'left',command:'justifyleft',imageClass:"xuifont xui-icon-alignleft",_fi_:'xui-icon-alignleft'},
                {id:'center',command:'justifycenter',imageClass:"xuifont xui-icon-aligncenter",_fi_:'xui-icon-aligncenter'},
                {id:'right',command:'justifyright',imageClass:"xuifont xui-icon-alignright",_fi_:'xui-icon-alignright'},
                {id :'justify', command : 'justifyfull',imageClass:"xuifont xui-icon-alignjustify",_fi_:'xui-icon-alignjustify'}
            ],
            list:[
                {id:'indent', command:'indent',imageClass:"xuifont xui-icon-indent",_fi_:'xui-icon-indent'},
                {id:'outdent',command:'outdent',imageClass:"xuifont xui-icon-outdent",_fi_:'xui-icon-outdent'},
                {id:'ol',command:'insertorderedlist',imageClass:"xuifont xui-icon-number",_fi_:'xui-icon-number'},
                {id:'ul',command:'insertunorderedlist',imageClass:"xuifont xui-icon-bullet",_fi_:'xui-icon-bullet'}
            ],
            insert:[
                {id:'hr',command:'insertHorizontalRule',imageClass:"xuifont xui-icon-inserthr",_fi_:'xui-icon-inserthr'},
                {id:'insertimage',command:'custom',imageClass:"xuifont xui-icon-picture",_fi_:'xui-icon-picture'},
                {id:'createlink',command:'custom',imageClass:"xuifont xui-icon-link",_fi_:'xui-icon-link'},
                {id:'unlink',command:'unlink',imageClass:"xuifont xui-icon-breaklink",_fi_:'xui-icon-breaklink'}
            ],
            clear:[
                {id:'removeformat',command:'removeformat',imageClass:"xuifont xui-icon-formatclear",_fi_:'xui-icon-formatclear'}
            ],
            html:[
                {id:'html',command:'custom', imageClass:"xuifont xui-icon-html",_fi_:'xui-icon-html'}
            ]
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile),t;
            d.labelHAlign=d.labelHAlign?("text-align:" + d.labelHAlign):"";
            d.labelShow=d.labelPos!='none'&&d.labelSize&&d.labelSize!='auto'?"":"display:none";
            d._labelSize=d.labelSize?'':0+profile.$picku();
            // adjustRes for labelCaption
            if(d.labelCaption)
                d.labelCaption=xui.adjustRes(d.labelCaption,true);
            return d;
        },
        _updateToolbar:function(domId, clear,etype){
            var profile=xui.$cache.profileMap[domId],toolbar;
            if(!profile)return;

            if(profile.properties.disabled || profile.properties.readonly)return;

            if(profile && (toolbar=profile.$toolbar)){
                var doc=profile.$doc,
                    bold=clear?false:doc.queryCommandState('bold'),
                    italic=clear?false:doc.queryCommandState('italic'),
                    underline=clear?false:doc.queryCommandState('underline'),
                    strikethrough=clear?false:doc.queryCommandState('strikethrough'),
                    subscript=clear?false:doc.queryCommandState('subscript'),
                    superscript=clear?false:doc.queryCommandState('superscript'),

                    tb=toolbar.boxing();

                tb.updateItem('bold',{value:bold})
                tb.updateItem('italic', {value:italic})
                tb.updateItem('underline', {value:underline})
                tb.updateItem('strikethrough', {value:strikethrough})
                tb.updateItem('subscript', {value:subscript})
                tb.updateItem('superscript', {value:superscript})

                if(profile.onUpdateToolbar){
                    profile.boxing().onUpdateToolbar(profile, etype, doc);
                }
                doc=null;
            }
        },
        RenderTrigger:function(){
            var self=this;

            if(!self.properties.disabled && !self.properties.readonly)
                self.box._iniToolBar(self);

            if(!self.$inDesign){
                var div=self.getSubNode('EDITOR').get(0),
                    domId=self.$domId,
                    htmlTpl=self.properties.frameTemplate,
                    style=self.properties.frameStyle,
                    id=div.id;
                if(style){
                    htmlTpl = htmlTpl.replace(/<\s*\/\s*head\s*>/,"<style>" + (style||"") + "</style></head>");
                }
                // rendered already
                if(!self.$once){
                    self.$once=true;
                    try{
                        var iframe = self.$ifr=document.createElement("IFRAME");
                    }catch(e){
                        var iframe = self.$ifr=document.createElement("<iframe name='"+id+"' id='"+id+"'></iframe>");
                    }
                    //_updateToolbar event
                    var kprf=this,
                        eventOutput =self._eventOutput=function(e){
                            if(kprf && (kprf.properties.disabled||kprf.properties.readonly))return;
                            if(kprf.onInnerEvent)
                                return kprf.boxing().onInnerEvent(kprf, e.type, xui.Event.getSrc(e), e);
                        },
                        event=self._event=function(e){
                            if(kprf && (kprf.properties.disabled||kprf.properties.readonly))return;
                            var etype = e.type; 
                            if(etype !== "mouseover" && etype !== "mouseout"){
                                xui.resetRun('RichEditor:'+domId, function(){
                                    // destroyed
                                    if(!kprf.box)return;
                                    xui.UI.RichEditor._updateToolbar(domId, false,etype)
                                },100);
                                 if(etype=='mousedown'){
                                    if(xui.browser.applewebkit && e.target.tagName=="IMG"){
                                            var sel = self.$win.getSelection(), range = self.$doc.createRange();
                                            range.selectNode(e.target);
                                            sel.removeAllRanges();
                                            sel.addRange(range);
                                    }

                                    //for BlurTrigger
                                    xui.doc.onMousedown(true);
                                 }  
                            }
                            if(kprf.onInnerEvent)
                                return kprf.boxing().onInnerEvent(kprf, etype, xui.Event.getSrc(e), e);
                        },
                        event2=self._event2=function(e){
                            if(kprf && (kprf.properties.disabled||kprf.properties.readonly))return;
                            if(kprf.onInnerEvent){
                                var etype=e.type;
                                xui.resetRun(kprf.$xid+":frmInnerAsyEvent", function(){
                                    if(kprf && !kprf.destroyed)
                                        kprf.boxing().onInnerEvent(kprf, etype, xui.Event.getSrc(e), e);
                                });
                            }
                        },
                        _focus=function(e){
                            if(!kprf)return;
                            if(kprf.properties.disabled||kprf.properties.readonly)return;
                            kprf.box._onchange(kprf);
                        },
                        _blur=function(e){
                            if(!kprf)return;
                            if(kprf.properties.disabled||kprf.properties.readonly)return;
                            
                            xui.resetRun('RichEditor:'+domId, function(){
                                // destroyed
                                if(!kprf.box)return;
                                xui.UI.RichEditor._updateToolbar(domId, true, 'blur')
                            },100);

                            if(kprf._onchangethread){
                                clearInterval(kprf._onchangethread);
                                kprf._onchangethread=null;
                                // check again
                                if(kprf && kprf.box)
                                    kprf.box._checkc(kprf);
                            }
                            
                            var v=kprf.boxing()._getCtrlValue();
                            // here: dont trigger setCtrlValue
                            kprf.boxing().setUIValue(v,null,true,'blur');
                        },
                        gekfix=function(e){
                            // to fix firefox appendChid's bug: refresh iframe's document
                            if(kprf){
                                var ins=kprf.boxing();
                                xui.asyRun(function(){
                                    // destroyed
                                    if(!kprf.box)return;
                                    ins.refresh(); 
                                });
                            }
                        },
                        doc,win,
                        checkF = function(){
                            xui.setTimeout(function(){
                                // removed from DOM already
                                if(!frames[id])return;
                                // not ready
                                if(!frames[id].document)return;
                                
                                if(self.$win!=frames[id].window){
                                    win=self.$win=frames[id].window;
    
                                    doc=self.$doc=win.document;
                                    
                                    doc.open();
                                    doc.write(htmlTpl);
                                    doc.close();
                                    
                                    //if(xui.browser.isTouch && (xui.browser.isAndroid||||xui.browser.isBB)){
                                    //    xui(doc.body).$touchscroll('xy');
                                    //}
        
                                    try{doc.execCommand("styleWithCSS", 0, false)}catch(e){
                                        try {doc.execCommand("useCSS", 0, true)}catch(e){}
                                    }
        
                                    var disabled=self.properties.disabled||self.properties.readonly;
        
                                    if (doc.body.contentEditable != undefined && xui.browser.ie)
                                       doc.body.contentEditable = disabled?"false":"true";
                                    else
                                       doc.designMode=disabled?"off":"on";
                                    
                                    // ensure toolbar disable
                                    if(disabled){
                                        self.box._iniToolBar(self, false);
                                    }
        
                                    win._gekfix=gekfix;
        
                                    if(xui.browser.ie && doc.attachEvent){
                                        doc.attachEvent("unload",gekfix);
        
                                        if(!disabled){
                                            doc.attachEvent("onmousedown",event);
                                            doc.attachEvent("ondblclick",event);
                                            doc.attachEvent("onclick",event);
                                            doc.attachEvent("oncontextmenu",eventOutput);
                                            doc.attachEvent("onkeyup",event);
                                            doc.attachEvent("onkeydown",event);
                                            
                                            doc.attachEvent("onmouseover",event);
                                            doc.attachEvent("onmouseout",event);
                                            doc.attachEvent("onmousemove",event2);
                                            
                                            win.attachEvent("onfocus",_focus);
                                            win.attachEvent("onblur",_blur);
                                            (self.$beforeDestroy=(self.$beforeDestroy||{}))["ifmClearMem"]=function(){
                                                var win=this.$win,
                                                    doc=this.$doc,
                                                    event=this._event,
                                                    event2=this._event2;
                                                if(this._onchangethread){
                                                    clearInterval(this._onchangethread);
                                                    this._onchangethread=null;
                                                }
    
                                                // crack for ie7/8 eat focus
                                                // error raise in ie6
                                                try{
                                                    var status=doc.designMode;
                                                    doc.designMode="off";
                                                    doc.designMode="on";
                                                    doc.designMode=status;
                                                }catch(e){}
    
                                                win._gekfix=undefined;
    
                                                try{doc.detachEvent("unload",win._gekfix);}catch(e){}
    
                                                if(!this.properties.disabled && !this.properties.readonly){
                                                    doc.detachEvent("onmousedown",event);
                                                    doc.detachEvent("ondblclick",event);
                                                    doc.detachEvent("onclick",event);
                                                    doc.detachEvent("oncontextmenu",eventOutput);
                                                    doc.detachEvent("onkeyup",event);
                                                    doc.detachEvent("onkeydown",event);

                                                    doc.detachEvent("onmouseover",event);
                                                    doc.detachEvent("onmouseout",event);
                                                    doc.detachEvent("onmousemove",event2);

                                                    win.detachEvent("onfocus",_focus);
                                                    win.detachEvent("onblur",_blur);
                                                }
                                                win=doc=event=event2=null;
                                            };
                                        }
                                    }else{
                                        var prf=self;
                                        // for opera
                                        if(xui.browser.opr || !win.addEventListener){
                                            prf.$repeatT=xui.Thread.repeat(function(){
                                                if(!frames[id])
                                                    return false;
                                                else{
                                                    if(!prf.$win.document || !prf.$win.document.defaultView)
                                                        prf.boxing().refresh(); 
                                                }
                                            }, 99);
                                        }else
                                            win.addEventListener("unload",gekfix,false);
    
                                        if(!disabled){
                                            doc.addEventListener("mousedown",event,false);
                                            doc.addEventListener("dblclick",event,false);
                                            doc.addEventListener("click",event,false);
                                            doc.addEventListener("contextmenu",eventOutput,false);
                                            doc.addEventListener("keyup",event,false);

                                            doc.addEventListener("mouseover",event,false);
                                            doc.addEventListener("mouseout",event,false);
                                            doc.addEventListener("mousemove",event2,false);

                                            if(xui.browser.gek || !win.addEventListener){
                                                doc.addEventListener("focus",_focus,false);
                                                doc.addEventListener("blur",_blur,false);
                                                doc.addEventListener("keypress",event,false);
                                            }else{
                                                win.addEventListener("focus",_focus,false);
                                                win.addEventListener("blur",_blur,false);
                                                doc.addEventListener("keydown",event,false);
                                            }
                                        }
        
                                        //don't ues $ondestory, opera will set doc to null
                                        (self.$beforeDestroy=(self.$beforeDestroy||{}))["ifmClearMem"]=function(){
                                            var win=this.$win,
                                                doc=this.$doc,
                                                ifr=this.$ifr,
                                                event=this._event,
                                                event2=this._event2;
                                            // for opera
                                            if(xui.browser.opr)
                                                if(prf.$repeatT)prf.$repeatT.abort();
                                            
                                            if(ifr.detachEvent){
                                                ifr.detachEvent('onload',checkF);
                                            }else{
                                                ifr.onload=null;
                                            }
    
                                            try{win.removeEventListener("unload",win._gekfix,false);}catch(e){}
    
                                            win._gekfix=undefined;
        
                                            //for firefox
                                            delete frames[this.$frameId];
        
                                            if(!this.properties.disabled && !this.properties.readonly && doc.removeEventListener){
                                                doc.removeEventListener("mousedown",event,false);
                                                doc.removeEventListener("dblclick",event,false);
                                                doc.removeEventListener("click",event,false);
                                                doc.removeEventListener("contextmenu",eventOutput,false);
                                                doc.removeEventListener("keyup",event,false);

                                                doc.removeEventListener("mouseover",event,false);
                                                doc.removeEventListener("mouseout",event,false);
                                                doc.removeEventListener("mousemove",event2,false);

                                                if(xui.browser.gek || !win.removeEventListener){
                                                    doc.removeEventListener("focus",_focus,false);
                                                    doc.removeEventListener("blur",_blur,false);
                                                    doc.removeEventListener("keypress",event,false);
                                                }else{
                                                    win.removeEventListener("focus",_focus,false);
                                                    win.removeEventListener("blur",_blur,false);
                                                    doc.removeEventListener("keydown",event,false);
                                                }
                                            }
                                            prf=gekfix=event=event2=win=doc=null;
                                        };
                                    }
                                    
                                    self.boxing()._setCtrlValue(self.properties.$UIvalue||"");
                                    
                                    iframe.style.visibility='';
                                    iframe.style.overflow='auto';

                                    if(self.onReady)self.boxing().onReady(self);
                                }
                            });
                        };
                    self.$frameId=id;
                    iframe.id=iframe.name=id;
                    iframe.className=div.className;
                    iframe.src="about:blank";
                    iframe.frameBorder=0;
                    iframe.border=0;
                    iframe.scrolling='yes';
                    iframe.marginWidth=0;
                    iframe.marginHeight=0;
                    iframe.tabIndex=-1;
                    iframe.allowTransparency="allowtransparency";
                    iframe.style.visibility='hidden';
                    
                    //replace the original one
                    xui.$cache.domPurgeData[iframe.$xid=div.$xid].element=iframe;
                    div.parentNode.replaceChild(iframe,div);

                    if(iframe.attachEvent){
                        iframe.attachEvent('onload',checkF);
                    }else{
                        iframe.onload=checkF;
                    }
                }
            }else{
                 self.boxing()._setCtrlValue(self.properties.value||"");
            }
        },
        _checkc:function(profile){
            if(profile && profile.$doc){
                var doc=profile.$doc, body=doc && (doc.body||doc.documentElement);
                if(!profile.__oldv)
                    profile.__oldv=body.innerHTML;
                if(body.innerHTML!=profile.__oldv){
                    var ov=profile.__oldv;
                    profile.__oldv=body.innerHTML;
                    profile.boxing().onChange(profile,ov,body.innerHTML);
                }
            }
        },
        _onchange:function(profile){
            if(profile.onChange){
                if(profile._onchangethread){
                    clearInterval(profile._onchangethread);
                    profile._onchangethread=null;
                }
                profile._onchangethread=setInterval(function(){
                    if(profile && profile.box)
                        profile.box._checkc(profile);
                }, 500);
            }
        },
        _clearPool:function(profile){
            profile.getSubNode('POOL').empty();
            profile.$colorPicker=profile.$fontsizeList=profile.$fontnameList=profile.$formatblockList=profile.$htmlEditor=null;
        },
        _iniToolBar:function(profile, flag){
            var self=profile,
                pro=self.properties,
                cmdFilter=(pro.cmdFilter||'').split(/[\s,;]+/),
                tbH;
            if(self.$toolbar){
                self.$toolbar.boxing().destroy(true);
                delete self._$tb;
                delete self.$toolbar;
            }

            if(flag!==false){
                var t,v,o,items=[],
                    imageClass=self.getClass('TOOLBARBTN'),
                    arr=pro.cmdList.split(/[\s,;]+/),
                    h={};
                xui.arr.each(arr,function(i){
                    //filter
                    if((o=self.box.$cmds[i]) && !h[i]){
                        h[i]=1;
                        xui.filter(o,function(v){
                            if(xui.arr.indexOf(cmdFilter,v.id)!==-1)return false;
                            if(v.imagePos)
                                v.imageClass=imageClass;
                            v.tips=xui.wrapRes('editor.'+v.id);
                        });
                        items.push({id:i,sub:o});
                    }
                });
    
                //compose
                t=new xui.UI.ToolBar({selectable:false,handler:false,items:items,disabled:pro.disabled||pro.readonly});
                t.setCustomStyle('ITEMS','border:none');
                self.getSubNode('BOX').prepend(t);
                t.render(true);
                // keep toolbar's height number here
                profile.$_tbH=tbH=t.getRoot().offsetHeight();
                if(xui.browser.ie)
                    t.getSubNode('BOX').query('*').attr('unselectable','on');

                t = self._$tb = t.get(0);
    
                t.onClick=self.box._toolbarclick;
                v=self._$composed={};
                v[t.$xid]=t;
                self.$toolbar=t;
                t.$hostage=self;
            }
            profile.adjustSize(true);
            return tbH;
        },
        _toolbarclick:function(profile,item,group,e,src){
            var editor=profile.$hostage;
            if(!editor.$doc)return;

            var pro=editor.properties, first;
            editor.$win.focus();

            if(item.command=='custom'){
                var cmd=item.id,
                    o,_clear,node,
                    items, items2;

                //get the pop control
                switch(cmd){
                    case 'forecolor':
                    case 'bgcolor':
                        if(!editor.$colorPicker){
                            first=true;
                            editor.$colorPicker=(new xui.UI.ColorPicker({selectable:false,barDisplay:false})).render(true);
                        }
                        o=editor.$colorPicker;
                        break;
                    case 'fontsize':
                    case 'fontname':
                    case 'formatblock':
                        //if lang was changed, clear the pool first
                        if(editor.$lang!=xui.getLang())
                            editor.box._clearPool(editor);
                        editor.$lang=xui.getLang();

                        //font size
                        if(cmd=='fontsize'){
                            if(!editor.$fontsizeList){
                                items = xui.getRes('editor.fontsizeList');
                                items = items.split(';');
                                items2=[];
                                var t;
                                xui.arr.each(items,function(o){
                                    o=o.split(',');
                                    t=o[0]=='...'?'1':o[0];
                                    items2.push({id:o[0], caption:'<font size="'+o[0]+'" '+xui.$IEUNSELECTABLE()+'>'+o[1]+'</font>'});
                                });
                                first=true;
                                editor.$fontsizeList=(new xui.UI.List({selectable:false,height:'auto',items:items2,width:150})).render(true);
                            }
                            o=editor.$fontsizeList;
                        //font family
                        }else if(cmd=='fontname'){
                            if(!editor.$fontnameList){
                                items = xui.getRes('editor.fontnameList');
                                items = items.split(';');
                                items2=[];
                                var t;
                                xui.arr.each(items,function(o){
                                    t=o=='...'?'':o;
                                    items2.push({id:o, caption:'<span style="font-family:'+o+'" '+xui.$IEUNSELECTABLE()+'>'+o+'</span>'});
                                });
                                first=true;
                                editor.$fontnameList=(new xui.UI.List({selectable:false,height:'auto',items:items2})).render(true);
                            }
                            o=editor.$fontnameList;
                        //font format
                        }else if(cmd=='formatblock'){
                            if(!editor.$formatblockList){
                                items = xui.getRes('editor.formatblockList');
                                items = items.split(';');
                                items2=[];
                                var t;
                                xui.arr.each(items,function(o){
                                    o=o.split(',');
                                    t=o[0]=='...'?'span':o[0];
                                    items2.push({id:o[0], caption:'<'+t+' style="display:inline;padding:0;margin:0" '+xui.$IEUNSELECTABLE()+'>'+o[1]+'</'+t+'>'});
                                });
                                first=true;
                                editor.$formatblockList=(new xui.UI.List({selectable:false,height:'auto',items:items2})).render(true);
                            }
                            o=editor.$formatblockList;
                        }
                        break;
                    case 'html':
                        if(!editor.$htmlEditor){
                            first=true;
                            editor.$htmlEditor=new xui.UI.Input({multiLines:true,width:400,height:300,resizer:true});
                        }
                        o=editor.$htmlEditor;
                        break;
                }
                //pop the control and set clear funciton
                if(o){
                    var sid=profile.key+":"+editor.$xid;
                    _clear=function(){
                        o.beforeUIValueSet(null);
                        editor.getSubNode('POOL').append(o.getRoot());
                        node.setBlurTrigger(sid);
                        xui.Event.keyboardHook('esc',0,0,0,sid);
                        xui.asyRun(function(){
                            // destroyed
                            if(!editor||!editor.$win)return;
                            editor.$win.focus()
                        });
                    };

                    o.setValue('',true,'clear');
                    node=o.reBoxing();

                    if(editor.$htmlEditor==o){
                        var root=editor.getRoot(),ifr=editor.getSubNode("EDITOR");
                        o.setLeft(ifr.left()).setTop(ifr.top()).setWidth(ifr.offsetWidth()).setHeight(ifr.offsetHeight());
                        o.setZIndex(10);
                        editor.getSubNode('BOX').append(node);
                    }else{
                        node.popToTop(src);
                    }

                    if(first && xui.browser.ie)
                        o.getSubNode('BOX').query('*').attr('unselectable','on');
                    
                    xui.tryF(o.activate,[],o);

                    //for on blur disappear
                    node.setBlurTrigger(sid, function(){
                        //force to trigger beforeUIValueSet event
                        if(o==editor.$htmlEditor)
                            var v=o._getCtrlValue(); 
                            // here: dont trigger setCtrlValue
                            o.setUIValue(v,null,true,'blur');
                         _clear();
                    });
                    //for esc
                    xui.Event.keyboardHook('esc',0,0,0,function(){
                        _clear();
                    },sid,null,null,profile.domId);
                }
                //set beforeUIValueSet function
                switch(cmd){
                    case 'forecolor':
                    case 'bgcolor':
                        o.beforeUIValueSet(function(p,o,v){
                            _clear();
                            var doc=editor.$doc;
                            if(cmd=='bgcolor' && xui.browser.gek){
                                doc.execCommand('useCSS',0,false);
                                doc.execCommand('hilitecolor',false, '#'+v);
                                doc.execCommand('useCSS',0,true);
                            }else{
                                if(cmd=='bgcolor')
                                    cmd=xui.browser.opr?'hilitecolor':'backcolor';
                                doc.execCommand(cmd,false, xui.browser.kde?('#'+v):v)  ;
                            }
                            doc=null;
                            return false;
                        });
                        break;
                    case 'fontsize':
                    case 'fontname':
                    case 'formatblock':
                        o.beforeUIValueSet(function(p,o,v){
                            _clear();
                            //store range for IE
                            if(xui.browser.ie && (v=='...' ||cmd=='formatblock' )){
                                var selection=editor.$doc.selection,
                                    range=selection?selection.createRange():null;
                                if(range && range.parentElement().ownerDocument!=editor.$doc)
                                    range=selection=null;
                            }
                            var f=function(cmd,v){
                                    var doc=editor.$doc;

                                    //for formatblock in IE
                                    //reset range for IE
                                    if(range){
                                        editor.$win.focus();
                                        if(cmd=='formatblock' && v){
                                            var p=range.parentElement(),html;
                                            if(p.ownerDocument==doc){
                                                if(/^\s*</.test(range.htmlText)){
                                                    //affect the first block only
                                                    range.collapse(true);
                                                    p=range.parentElement();
                                                    if(p.tagName=='BODY'){
                                                        html=p.innerHTML;
                                                        p.innerHTML = "<"+v+">"+html+"</"+v+">"
                                                    }else{
                                                        html=p.outerHTML;
                                                        html=html.replace(/\<[\w]+/,'<'+v).replace(/[\w]+\>$/,v+'>');
                                                        p.outerHTML=html;
                                                    }
                                                }else{
                                                    range.pasteHTML("<"+v+">"+range.htmlText+"</"+v+">")
                                                }
                                            }
                                            p=null;
                                        }
                                        range.select();
                                        selection=range=null;
                                    }

                                    doc.execCommand(cmd,false,v);
                                    doc=null;
                                };
                            if(v=='...'){
                                var str=xui.getRes('editor.'+cmd);
                                xui.UI.Dialog.prompt(str,str,"",function(v){
                                    if(v){
                                        f(cmd,v);
                                    }
                                },function(){
                                    //reset range for IE
                                    if(xui.browser.ie){
                                        if(range){
                                            editor.$win.focus();
                                            range.select();
                                        }
                                        selection=range=null
                                    }
                                });
                            }else
                                f(cmd,v);
                        });
                        break;
                    case 'insertimage':
                    case 'createlink':
                        var str=xui.getRes('editor.'+cmd),
                            str2=xui.getRes('editor.'+cmd+'2');
                        //store range for IE
                        if(xui.browser.ie){
                            var selection=editor.$doc.selection,
                                range=selection?selection.createRange():null;
                                if(range && range.parentElement().ownerDocument!=editor.$doc)
                                    range=selection=null;
                        }
                        xui.UI.Dialog.prompt(str,str2,"http:/"+'/',function(v){
                            //reset range for IE
                            if(xui.browser.ie){
                                if(range){
                                    editor.$win.focus();
                                    range.select();
                                }
                                selection=range=null
                            }
                            if(v){
                                var doc=editor.$doc;
                                doc.execCommand(cmd,false,xui.adjustRes(v,0,1));
                                doc=null;
                            }
                        },function(){
                            //reset range for IE
                            if(xui.browser.ie){
                                if(range){
                                    editor.$win.focus();
                                    range.select();
                                }
                                selection=range=null
                            }
                        });
                        break;
                     case 'html':
                         var v=editor.boxing().getUIValue();
                         if(xui.Coder)v=xui.Coder.formatText(v,'html');
                         o.setValue(v,true,'editor');
                         o.beforeUIValueSet(function(p,o,v){
                            _clear();
                            // here: trigger setCtrlValue
                            editor.boxing().setUIValue(v,null,null,'html');
                        });
                        break;
                }
            }else{
                editor.$doc.execCommand(item.command,false,item.commandArgs||null);

                if(item.id=='removeformat')
                    xui.UI.RichEditor._updateToolbar(editor.$domId,true,'none')
                editor.$win.focus();
            }
        },
        _ensureValue:function(profile, value){
            var p=xui.$getGhostDiv();
            p.innerHTML=(xui.isSet(value)?value:'')+"";
            value=p.innerHTML;
            p.innerHTML="";
            return value;
        },
        _onresize:function(profile,width,height){
            if(width || height){
                if(!height)
                    height=profile.properties.height;

                var prop = profile.properties,
                    root = profile.getRoot(),
                    box = profile.getSubNode('BOX'),
                    label = profile.getSubNode('LABEL'),

                    us = xui.$us(prop),
                    adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                    fzrate=profile.getEmSize()/root._getEmSize(),
                    labelfz=label._getEmSize(fzrate),

                    labelPos=prop.labelPos,
                    labelSize=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelSize,labelfz)||0,
                    labelGap=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelGap)||0,
                    ll, tt, ww, hh;

                // caculate by px
                if(width && width!='auto')width=profile.$px(width);
                if(height && height!='auto')height=profile.$px(height);

                box.cssRegion({
                    left : adjustunit(ll = labelPos=='left'?labelSize:0),
                    top : adjustunit(tt = labelPos=='top'?labelSize:0),
                    width : adjustunit(ww = width===null?null:Math.max(0,(width - ((labelPos=='left'||labelPos=='right')?labelSize:0)))),
                    height : adjustunit(hh = height===null?null:Math.max(0,(height - ((labelPos=='top'||labelPos=='bottom')?labelSize:0))))
                });
                if(labelSize){
                    label.cssRegion({
                        left: adjustunit(width===null?null:Math.max(0,labelPos=='right'?(width-labelSize+labelGap):0),labelfz),
                        top:  adjustunit(height===null?null:Math.max(0,labelPos=='bottom'?(height-labelSize+labelGap):0),labelfz), 
                        width: adjustunit(width===null?null:Math.max(0,((labelPos=='left'||labelPos=='right')?(labelSize-labelGap):width)),labelfz),
                        height: adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):height)),labelfz)
                    });
                }
                xui.asyRun(function(){
                    if(!profile.renderId)return;

                    // calculate toolbar's height
                    var itb=profile._$tb,
                        size={},
                        _top=0,
                        tbh;
                    if(itb){
                        // here, do resize first
                        itb.getRoot().width(adjustunit(ww,itb.getRoot()));
                        tbh=itb.getRoot().offsetHeight(true);
                        if(tbh)
                            profile.$_tbH=tbh;
                        else
                            tbh=profile.$_tbH;
                    }
                    _top=(itb?(tbh-1):0);
                    
                    size.height=hh - _top -2;
                    if(ww) size.width = ww - 2;

                    if(size.width<0)size.width=0;
                    if(size.height<0)size.height=0;

                    if(ww||hh){
                        if(profile&&profile.renderId){
                            // non-sence for setting fontSize for EDITOR or MARK
                            size.width=adjustunit(size.width);
                            size.height=adjustunit(size.height);

                            profile.getSubNode('EDITOR').top(adjustunit(_top)).cssSize(size,true);
                            profile.getSubNode('DIRTYMARK').left(0+profile.$picku()).top(adjustunit(_top+1));
                        }
                    }
                }, 100/*greater than 16*/);
            }
        }
    }
});

xui.Class("xui.UI.ComboInput", "xui.UI.Input",{
    /*Instance*/
    Instance:{
        _adjustV:function(v){
            var profile=this.get(0),p=profile.properties;
            if(profile.$isNumber){
                v=(''+v).replace(/[^\d.-]/g,'');
                v=xui.isNumb(parseFloat(v))?xui.toFixedNumber(v,p.precision):null;
            }else if(profile.properties.type=='date'||profile.properties.type=='datetime'){
                v=xui.isDate(v)?v:xui.isFinite(v)?new Date(parseInt(v,10)):null;                
            }else if(typeof v=="string" && v.indexOf("\r")!=-1){
                v=v.replace(/(\r\n|\r)/g, "\n");
            }
            return v;
        },
        getValue:function(){
            var upper=arguments.callee.upper,
                v = upper.apply(this,xui.toArr(arguments));
            upper=null;
            return this._adjustV(v);
        },
        getUIValue:function(){
            var upper=arguments.callee.upper,
                v = upper.apply(this,xui.toArr(arguments));
            upper=null;
            return this._adjustV(v);
        },
        _getCtrlValue:function(){
            return this.get(0).properties.$UIvalue;
            //return this._fromEditor(this.getSubNode('INPUT').attr('value'));
        },
        _setCtrlValue:function(value){
            var ns=this,me=arguments.callee, r1=me._r1||(me._r1=/\</),r2=me._r2||(me._r2=/\<\/?[^>]+\>/g);
            return this.each(function(profile){
                if(!profile.$typeOK)
                    profile.box._iniType(profile);
                var o=profile.getSubNode('INPUT'), type=profile.properties.type;

                value=profile.$_onedit
                    // for enter/esc key, show editMode value
                    ? ns._toEditor(value)
                    : ns.getShowValue(value);

                if(type!=='none'&& type!=='input'&& type!=='password' && !profile.properties.multiLines && typeof value=='string' && r1.test(value))value=value.replace(r2,'');
                
                if(profile.$Mask && !value){
                    value=profile.$Mask;
                }
                profile.$_inner=1;
                o.attr('value',value||'');
                delete profile.$_inner;
                if(type=='color'){
                    var clr=xui.UI.ColorPicker.getTextColor(value);
                    o.css({backgroundColor:value, color:clr});

                    if(profile.properties.showMode=='compact')
                        profile.getRoot().query('button').css('color',clr);
                }
            })
        },
        _compareValue:function(v1,v2){
            var profile=this.get(0),t;
            if(t= profile.CF.compareValue||profile.$compareValue)
                return t(profile, v1, v2);

            return v1===v2;
        },
        getShowValue:function(value){
            var profile=this.get(0),
                pro=profile.properties,v,t;
            if(!xui.isDefined(value))
                value=pro.$UIvalue;

            // try to give default caption
            if(t = profile.CF.getShowValue||profile.$getShowValue)
                v = t(profile, value);
            else{
                //get from items
                if('listbox'==pro.type){
                    var list = (pro.listKey)?xui.UI.getCachedData(pro.listKey):pro.items;
                    if( list && (t=xui.arr.subIndexOf(list,'id',value))!=-1){
                      v=list[t].caption+"";
                      if(v && v.length>0)v=xui.adjustRes(v);
                    }else
                        v=null;
                }else
                    v=profile.$showValue;
            }
            if(!xui.isSet(v) && (profile.$inputReadonly || pro.inputReadonly))
                v=xui.isSet(pro.caption)?pro.caption:null;
            return ""+( xui.isSet(v) ? v : xui.isSet(value) ? value : "");
        },
        _toEditor:function(value){
            var profile=this.get(0),
                pro=profile.properties,t;
                if(t= profile.CF.toEditor||profile.$toEditor)
                    return t(profile, value);
            return value;
        },
        _fromEditor:function(value){
            var profile=this.get(0),
                pro=profile.properties,t;

                if(t= profile.CF.fromEditor||profile.$fromEditor)
                    return t(profile, value);
            return value;
        },
        setPopWnd:function(drop){
            if(this.isDestroyed())return ;
            var profile=this.get(0);
            profile.$poplink=drop?drop['xui.Module']?drop.getRoot(true):drop['xui.UI']?drop.get(0):drop:null;
            (profile.$poplink.$beforeDestroy=(profile.$poplink.$beforeDestroy||{}))["$poplink_to"]=function(){
                delete profile.$poplink;
            };
            (profile.$beforeDestroy=(profile.$beforeDestroy||{}))["$poplink"]=function(){
                if(profile.$poplink){
                    xui.filter(profile.box.$drop,function(o){
                        return o!==profile.$poplink;
                    });
                    profile.$poplink.boxing().destroy();
                    profile.$poplink=null;
                }
            };
        },
        _cache:function(type, focus){
            if(this.isDestroyed())return ;
            var profile=this.get(0);
            
            var drop=profile.$poplink, cached=profile.properties.cachePopWnd;
            if(drop){
                if(!cached){
                    if(!drop.destroyed)
                        drop.boxing().destroy(true);
                    delete profile.$poplink;
                    if(focus)
                        profile.boxing().activate();
                }else{
                    if(!profile.__tryToHide){
                        profile.__tryToHide= xui.asyRun(function(){
                            // destroyed
                            if(!profile.box)return;
                            delete profile.__tryToHide;

                            if(!drop.destroyed){
                                if(xui.browser.opr)
                                    drop.getRoot().css('display','none');
                                if(drop.boxing()._clearMouseOver)drop.boxing()._clearMouseOver();
                                profile.getSubNode('POOL').append(drop.getRoot());
                            }                            
                            if(focus)
                                profile.boxing().activate();
                        });
                    }
                }
            }
            delete profile.$poplink;

            if(profile.afterPopHide)
                this.afterPopHide(profile, drop, type);
            return cached;
        },
        clearPopCache:function(){
            var profile=this.get(0);
            if(profile.renderId)
                profile.getSubNode('POOL').empty();
            delete profile.$poplink;
            return this;
        },
        setUploadObj:function(input){
            var profile=this.get(0),
                prop=profile.properties,
                c = xui(input).get(0);
            if(c.tagName && c.tagName.toLowerCase()=='input' && c.type=='file'){
                if(profile.renderId && prop.type=='file'){
                    var o = profile.getSubNode('FILE').get(0);
                    
                    xui.setNodeData(c.$xid=o.$xid,'element',c);
                    c.id=o.id;
                    c.onclick=o.onclick;
                    c.onchange=o.onchange;
                    o.$xid=null;                
                    o.id=o.onclick=o.onchange=null;
                    //a special node, must delete if from cache here:
                    delete profile.$_domid[profile.keys['FILE']];
                    xui([o]).addPrev(c).remove(false);
                    this.setUIValue(c.value||"",null,null,'setfile');
                }
            }
            return this;
        },
        //for upload ,special must get the original node
        getUploadObj:function(){
            var profile=this.get(0),prop=profile.properties;
            if(profile.renderId && prop.type=='file'){
                var o = profile.getSubNode('FILE').get(0);
                if(!o.value)
                    return null;
                    
                var c=o.cloneNode(false);
                c.value="";
                //inner replace
                xui.setNodeData(c.$xid=o.$xid,'element',c);
                c.onclick=o.onclick;
                c.onchange=o.onchange;

                //remove those
                //if(xui.browser.ie)
                //    o.removeAttribute('$xid');
                //else
                //    delete o.$xid;
                //**: "removeAttribute" doesn't work in IE9+
                o.$xid=null;
                
                o.id=o.onclick=o.onchange=null;

                //a special node, must delete if from cache here:
                delete profile.$_domid[profile.keys['FILE']];
                xui([o]).addPrev(c).remove(false);
                c=null;

                this.setUIValue(this.getValue(),null,null,'getfile');

                return o;
            }
        },
        popFileSelector:function(){
            var profile=this.get(0),prop=profile.properties;
            if(profile.renderId && prop.type=='file'){
                var fileInput = profile.getSubNode('FILE').get(0);
                // for IE11
                if (xui.browser.ie11)  {
                  var label=document.createElement( "div");
                  fileInput.appendChild(label);
                  label.click();
                  fileInput.removeChild(label);
                }else{
                  fileInput.click();
                }
            }
        },
        resetValue:function(value){
            this.each(function(p){
                if(p.properties.type=='file')
                    p.getSubNode('FILE').attr('value','');
            });
            var upper=arguments.callee.upper,
                rtn=upper.apply(this,xui.toArr(arguments));
            upper=null;
            return rtn;
        },
        _drop:function(e, src, baseNode,ignoreEvent){
            return this.each(function(profile){
                var pro = profile.properties, type=pro.type, cacheDrop=pro.cachePopWnd;
                if(pro.disabled||pro.readonly)return;

                //open already
                if(profile.$poplink)return;
                var o, v, drop,
                    box = profile.boxing(),
                    main = profile.getSubNode('BOX'),
                    btn = profile.getSubNode('RBTN'),
                    pos = main.offset();
                pos.top += main.offsetHeight();

                //special cmd type: getter, 'cmdbox' and 'popbox'
                if(( !ignoreEvent && profile.beforeComboPop && false===box.beforeComboPop(profile, pos, e, src)))
                    return;

                // for standard drop
                if(type=='combobox'||type=='listbox'||type=='helpinput'
                    ||type=='date'
                    ||type=='time'
                    ||type=='datetime'
                    ||type=='color'){

                    if(profile.__tryToHide){
                        xui.clearTimeout(profile.__tryToHide);
                        delete profile.__tryToHide;
                    }

                    //get cache key
                    var cachekey;
                    if(cacheDrop){
                        switch(type){
                            case 'time':
                            case 'date':
                            case 'datetime':
                            case 'color':
                                cachekey=type;
                                break;
                            default:
                                if(pro.listKey)
                                    //function no cache
                                    if(typeof xui.get(xui.$cache,['UIDATA', pro.listKey])=='function')
                                        drop = cachekey = null;
                                    else
                                        cachekey = "!"+pro.listKey;
                                else
                                    cachekey = "$"+profile.$xid;
                        }
                        //get from global cache
                        if(cachekey){
                            //filter first
                            xui.filter(profile.box.$drop,function(o){
                                return !!o.renderId;
                            });
                            drop = profile.box.$drop[cachekey];
                        }
                    }

                    //cache pop
                    if(!drop){
                        switch(type){
                            case 'combobox':
                            case 'listbox':
                            case 'helpinput':
                                o = xui.create('List');
                                o.setHost(profile).setDirtyMark(false).setItems(xui.copy(pro.items)).setListKey(pro.listKey||'');
                                if(pro.dropListWidth) o.setWidth(pro.dropListWidth);
                                else o.setWidth(profile.$forceu( main.offsetWidth() + btn.offsetWidth() ));

                                o.setHeight(pro.dropListHeight||'auto');

                                o.afterClick(function(){
                                    if(!this.destroyed)
                                        this.boxing()._cache('',true);
                                    else
                                        o.destroy(true);
                                    return false;
                                });
                                o.beforeUIValueSet(function(p, ovalue, value){
                                    var b2=this.boxing();
                                    if(type=='combobox'){
                                        var item=p.queryItems(p.properties.items,function(o){return o.id==value},false,true);
                                        if(item.length)
                                            value = item[0].caption;
                                    }
                                    //update value
                                    b2.setUIValue(value,null,null,'pick');

                                    //cache pop
                                    return b2._cache('',true);
                                });
                                break;
                            case 'time':
                                o = xui.create('TimePicker');
                                o.setHost(profile);
                                o.beforeClose(function(){
                                   if(!this.destroyed)
                                        this.boxing()._cache('',true);
                                    return false
                                });
                                o.beforeUIValueSet(function(p, o, v){
                                    var b2=this.boxing();
                                    //update value
                                    b2.setUIValue(v,null,null,'pick');
                                    return b2._cache('',true);
                                });
                                break;
                            case 'date':
                            case 'datetime':
                                o = xui.create('DatePicker');

                                if(type=='datetime')
                                    o.setTimeInput(true);

                                o.setHost(profile);
                                o.beforeClose(function(){
                                    if(!this.destroyed)
                                        this.boxing()._cache('',true);
                                    else
                                        o.destroy(true);
                                    return false
                                });
                                o.beforeUIValueSet(function(p, o, v){
                                    var b2=this.boxing();
                                    //update value
                                    b2.setUIValue(String(v.getTime()),null,null,'pick');
                                    return b2._cache('',true);
                                });

                                break;
                            case 'color':
                                o = xui.create('ColorPicker');
                                o.setHost(profile);
                                o.beforeClose(function(){
                                    if(!this.destroyed)
                                        this.boxing()._cache('',true);
                                    else
                                        o.destroy(true);
                                    return false
                                });
                                o.beforeUIValueSet(function(p, o, v){
                                    var b2=this.boxing();
                                    //update value
                                    b2.setUIValue((v=='transparent'?'':'#')+v,null,null,'pick');
                                    return b2._cache('',true);
                                });
                                break;
                        }
                        if(xui.isHash(pro.popCtrlProp) && !xui.isEmpty(pro.popCtrlProp))
                            o.setProperties(pro.popCtrlProp);
                        if(xui.isHash(pro.popCtrlEvents) && !xui.isEmpty(pro.popCtrlEvents))
                            o.setEvents(pro.popCtrlEvents);

                        drop = o.get(0);

                        //set to global cache
                        if(cachekey)
                            profile.box.$drop[cachekey]=drop;

                        o.render();
                    }

                    o=drop.boxing();
                    o.setHost(profile);

                    //set pop
                    switch(type){
                        case 'combobox':
                        case 'listbox':
                        case 'helpinput':
                        case 'time':
                            o.setValue(profile.properties.$UIvalue, true,'pop');
                            break;
                        case 'date':
                        case 'datetime':
                            var t = drop.properties;
                            if(t=profile.properties.$UIvalue)
                                o.setValue(new Date( parseInt(t,10)), true,'pop');
                            break;
                        case 'color':
                            o.setValue(profile.properties.$UIvalue.replace('#',''), true,'pop');
                            break;
                    }

                    profile.boxing().setPopWnd(o);

                    if(!ignoreEvent && profile.beforePopShow && false===box.beforePopShow(profile, drop, profile.properties.items))
                        return;
                    //pop
                    var node=o.reBoxing();
                    node.popToTop(baseNode||profile.getSubNode('BOX'),null,pro.parentID);

                    xui.tryF(o.activate,[],o);

                    //for on blur disappear
                    var sid=profile.key+":"+profile.$xid;
                    node.setBlurTrigger(sid, function(){
                        box._cache('blur');
                        xui.Event.keyboardHook('esc',0,0,0,sid);
                    });

                    //for esc
                    xui.Event.keyboardHook('esc',0,0,0,function(){
                        profile.$escclosedrop=1;
                        xui.asyRun(function(){
                            delete profile.$escclosedrop;
                        });

                        box.activate();
                        box._cache('esc',true);

                        //unhook
                        xui.Event.keyboardHook('esc',0,0,0,sid);
                        return false;
                    },sid,null,null,profile.domId);
                }else if(type=='file'){
                    profile.boxing().popFileSelector();
                }

                if(!ignoreEvent && profile.afterPopShow)
                    box.afterPopShow(profile, drop);
            });
        },
        expand:function(node, ignoreEvent, e){
            var profile=this.get(0);
            if(profile.renderId)
                profile.boxing()._drop(e,node,node,ignoreEvent);
        },
        collapse:function(){
            var profile=this.get(0);
            if(profile.renderId && profile.$poplink)
                profile.boxing()._cache('call');
        },
        getPopWnd:function(){
            var profile=this.get(0);
            if(profile && profile.$poplink)
                return profile.$poplink.boxing();
        }
    },
    /*Initialize*/
    Initialize:function(){
        var ns=this;
        ns.addTemplateKeys(['ICONB','ICON','UNIT','FILE','LMID','RMID','LBTN','RBTN','SPINBTN','R1','R1B','R2','R2B']);
        //modify default template for shell
        var t = ns.getTemplate();
        xui.merge(t.FRAME.BORDER,{
            LBTN:{},
            RBTN:{},
            SPINBTN:{R1:{},R2:{}},
            CMD:{
                $order:50,
                tagName:'button',
                className:'xui-ui-unselectable xui-uiborder-radius-tr xui-uiborder-radius-br xui-uiborder-noradius-l xui-nofocus xui-ui-btn xui-uibar xui-uigradient',
                style:"{_cmdDisplay}",
                SMID:{
                    className:"xuifont",
                    $fonticon:'{_fi_commandCls}'
                }
            }
        },'all');
        var box=t.FRAME.BORDER.BOX;
        box.className='xui-ui-input xui-ui-shadow-input xui-uiborder-flat xui-uibase {_radius_input} ';
        box.ICONB={
            tagName:'button',
            className:'xui-ui-unselectable xui-nofocus xui-ui-clear',
            tabindex: '-1',
            ICON:{
                className:'xuifont {imageClass}  {picClass}',
                //for cover xuicon
                style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                text:'{iconFontCode}'
            }
        };
        box.UNIT={
            tagName:'button',
            tabindex: '-1',
            className:'xui-ui-unselectable xui-nofocus',
            text:'{unit}'
        };

        t.FRAME.POOL={};
        t.className +=' {typecls}';

        ns.setTemplate(t);
        ns._adjustItems=xui.absList._adjustItems;

        var a=ns.prototype, b=xui.absList.prototype;
        a.getItems=b.getItems;
        a.getItemByItemId=b.getItemByItemId;
    },
    Static:{
        _beforeResetValue:function(profile){
            profile.properties.caption=undefined;
        },
        _iniType:function(profile){
            var pro=profile.properties, type=pro.type, c=profile.box;
            delete profile.$beforeKeypress;
            delete profile.$inputReadonly;
            delete profile.$isNumber;
            delete profile.$compareValue;
            delete profile.$getShowValue;
            delete profile.$toEditor;
            delete profile.$fromEditor;
            delete profile.$typeOK;

            if(type=='listbox'||type=='file'||type=='cmdbox'||type=='button'||type=='dropbutton')
                profile.$inputReadonly=true;

            if(type=='file')
                profile.$xuiFileCtrl=true;

            if(type!='listbox' && type!='combobox' && type!='helpinput')
                pro.items=[];

            if(type=='time'){
                var keymap={a:1,c:1,v:1,x:1};
                xui.merge(profile,{
                    $beforeKeypress : function(p,c,k){
                        return k.key.length!=1 || /[-0-9:]/.test(k.key)|| (k.ctrlKey&& !!keymap[k.key]);
                    },
                    $getShowValue : function(p,v){
                        return v?xui.UI.TimePicker._ensureValue(p,v):'';
                    },
                    $fromEditor : function(p,v){
                        if(v){
                            v = xui.UI.TimePicker._ensureValue(p,v);
                            if(v=='00:00')v=p.properties.$UIvalue;
                        }
                        return v;
                    }
                },'all');
            }else if(type=='date' || type=='datetime'){
                var date=xui.Date;
                var keymap={a:1,c:1,v:1,x:1};
                xui.merge(profile,{
                    $beforeKeypress : function(p,c,k){
                        return k.key.length!=1 || /[0-9:/\-_ ]/.test(k.key) ||(k.ctrlKey && !!keymap[k.key]);
                    },
                    $compareValue : function(p,a,b){
                        return (!a&&!b) || (String(a)==String(b))
                    },
                    $getShowValue : function(p,v){
                        if(p.properties.dateEditorTpl)
                            return v?date.format(v, p.properties.dateEditorTpl):'';
                        else
                            return v?date.getText(new Date(parseInt(v,10)), p.properties.type=='datetime'?'ymdhn':'ymd'):'';
                    },
                    $toEditor : function(p,v){
                        if(!v)return "";

                        v=new Date(parseInt(v,10)||0);
                        if(p.properties.dateEditorTpl)
                            return date.format(v, p.properties.dateEditorTpl);
                        else{
                            var m=(date.get(v,'m')+1)+'',d=date.get(v,'d')+'',h=date.get(v,'h')+'',n=date.get(v,'n')+'';
                            return date.get(v,'y')+'-'+(m.length==1?'0':'')+m+'-'+(d.length==1?'0':'')+d 
                            
                              +(p.properties.type=='datetime'?(" "+(h.length==1?'0':'')+h +":" +(n.length==1?'0':'')+n):"");
                        }
                    },
                    $fromEditor : function(p,v){
                        if(v){
                            if(p.properties.dateEditorTpl)
                                v=date.parse(v, p.properties.dateEditorTpl);
                            else
                                v=xui.Date.parse(v);
                            // set to old UIvalue
                            if(!v){
                                v=p.properties.$UIvalue;
                                if(xui.isFinite(v))v=new Date(parseInt(v,10));
                            }
                            if(v){
                                if(p.properties.type!='datetime')
                                    v=date.getTimSpanStart(v,'d',1);
                                // min/max year
                                if(v.getFullYear()<p.properties.min)
                                    v.setTime(p.properties.min);
                                if(v.getFullYear()>p.properties.max)
                                    v.setTime(p.properties.max);
                            }
                        }
                        return v?String(v.getTime()):'';
                    }
                },'all');
            }else if(type=='currency'){
                profile.$isNumber=1;
                var keymap={a:1,c:1,v:1,x:1};
                xui.merge(profile,{
                    $beforeKeypress : function(p,c,k){
                        return k.key.length!=1 || /[-0-9,. ]/.test(k.key) ||(k.ctrlKey && !!keymap[k.key]);
                    },
                    $compareValue : function(p,a,b){
                        return ((a===''&&b!=='')||(b===''&&a!==''))?false:p.box._number(p, a)==p.box._number(p, b)
                    },
                    $getShowValue : function(p,v){
                        var pp=p.properties;
                        if(xui.isSet(v)&&v!==""){
                            v=xui.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero,pp.trimTailZero);
                            if(p.properties.currencyTpl)
                                v=p.properties.currencyTpl.replace("*", v);
                        }else
                            v="";
                        return v;
                    },
                    $toEditor : function(p,v){
                        var pp=p.properties;
                        return (xui.isSet(v)&&v!=="")?xui.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero, pp.trimTailZero):"";
                    },
                    $fromEditor : function(p,v){
                        return (xui.isSet(v)&&v!=="")?p.box._number(p, v):"";
                    }
                },'all');
            }else if(type=='number' || type=='spin' || type=='counter'){
                profile.$isNumber=1;
                var keymap={a:1,c:1,v:1,x:1};
                xui.merge(profile,{
                    $beforeKeypress : function(p,c,k){
                        return k.key.length!=1 || /[-0-9. ]/.test(k.key)|| (k.ctrlKey && !!keymap[k.key]);
                    },
                    $compareValue : function(p,a,b){
                        return ((a===''&&b!=='')||(b===''&&a!==''))?false:p.box._number(p, a)==p.box._number(p, b)
                    },
                    $getShowValue : function(p,v){
                        var pp=p.properties;
                        v=(xui.isSet(v)&&v!=="")?xui.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero,pp.trimTailZero):"";
                        if(v!="" && p.properties.numberTpl)
                            v=p.properties.numberTpl.replace("*", v);
                        return v;
                    },
                    $toEditor : function(p,v){
                        var pp=p.properties;
                        return (xui.isSet(v)&&v!=="")?xui.formatNumeric(p.box._number(p, v), pp.precision, pp.groupingSeparator, pp.decimalSeparator, pp.forceFillZero,pp.trimTailZero):"";
                    },
                    $fromEditor : function(p,v){
                        return (xui.isSet(v)&&v!=="")?p.box._number(p, v):"";
                    }
                },'all');
            }

            if(pro.value)
                pro.$UIvalue=pro.value=c._ensureValue(profile,pro.value);

            profile.$typeOK=true;
        },
        $drop:{},
        Appearances:{
            POOL:{
                position:'absolute',
                left:0,
                top:0,
                width:0,
                height:0,
                display:'none',
                visibility:'hidden'
            },
            FILE:{
                visibility:'hidden',
                'z-index':30,
                border:0,
                width:'100%',
                height:'100%',
                position:'absolute',
                padding:0,
                top:0,
                right:0,
                cursor:'pointer',
                overflow:'hidden'
            },
            'KEY-type-number INPUT, KEY-type-spin INPUT, KEY-type-counter INPUT, KEY-type-currency INPUT':{
                $order:4,
                'text-align':'right'
            },
            'KEY-type-counter INPUT':{
                $order:4,
                'text-align':'center'
            },
            'KEY-type-file INPUT, KEY-type-button INPUT, KEY-type-dropbutton INPUT, KEY-type-cmdbox INPUT, KEY-type-listbox INPUT':{
                $order:4,
                cursor:'pointer',
                'text-align':'left',
                overflow:'hidden'
            },
            'KEY-type-button INPUT, KEY-type-dropbutton INPUT':{
                $order:5,
                'text-align':'center'
            },
            'LBTN,RBTN,SPINBTN,CMD':{
                display:'block',
                'z-index':20,
                cursor:'pointer',
                padding:0,
                position:'absolute',
                width:'1.5em',

                // for IE8
                overflow:'visible'
            },
            'ICONB, UNIT':{
                'z-index':20,
                cursor:'pointer',
                position:'absolute',
                padding:0,
                margin:0,
                border:0,
                background:'none',
                height:'100%',
                padding:'0 2px',

                // for IE67
                display: xui.$inlineBlock,
                zoom:xui.browser.ie67?1:null,
                width:(xui.browser.ie&&xui.browser.ver<=7)?'auto':null,
                'overflow':(xui.browser.ie&&xui.browser.ver<=7)?'visible':null
            },
            ICONB:{
                left:0,
                top:0
            },
            ICON:{
                // for right size in onresize
                width:'1em'
            },
            UNIT:{
                top:0,
                right:0
            },
            CMD:{
                $order:2,
                'z-index':22,
                padding:0
            },
            'R1,R2':{
                $order:1,
                display:'block',
                cursor:'pointer',
                padding:0,
                position:'absolute',
                height:'50%',
                width:'1.5em',

                // for IE8
                overflow:'visible'
            },
            R1:{
                top:0
            },
            R2:{
                bottom:0
            },
            'R1B,R2B':{
                cursor:'pointer',
                position:'absolute',
                left:0,
                top:'50%',
                height:'6px',
                'margin-top':'-2px',
                padding:0,
                'z-index':2
            },
            'SMID,LMID,RMID':{
                $order:2,
                cursor:'pointer',
                padding:0,
                left:0
            }
        },

        _objectProp:{popCtrlProp:1,popCtrlEvents:1},
        Behaviors:{
            HoverEffected:{BOX:'BOX',ICON:'ICON',ICONB:'ICONB'},
            ClickEffected:{BOX:'BOX'},
            ICONB:{
                onClick : function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    if(profile.onClickIcon)profile.boxing().onClickIcon(profile,src);
                }
            },
            UNIT:{
                onClick : function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    if(!prop.units)return;
                    var o = xui.create('List',{
                        dirtyMark:false,
                        items:prop.units.split(/[,;\:]/),
                        width:'auto',
                        height:'auto',
                        value:prop.unit
                    });
                    o.afterClick(function(){
                        o.destroy(true);
                        return false;
                    });
                    o.beforeUIValueSet(function(p, o, v){
                        profile.boxing().setUnit(xui.str.trim(v));
                    });
                    o.render();
                    //pop
                    var node=o.reBoxing();
                    node.popToTop(src,null,prop.parentID);
                    xui.tryF(o.activate,[],o);
                    var sid=profile.key+":unit:"+profile.$xid;
                    node.setBlurTrigger(sid, function(){
                        o.destroy();
                        xui.Event.keyboardHook('esc',0,0,0,sid);
                    });
                    xui.Event.keyboardHook('esc',0,0,0,function(){
                        o.destroy();
                        xui.Event.keyboardHook('esc',0,0,0,sid);
                        return false;
                    },sid,null,null,profile.domId);
                }
            },
            FILE:{
                onClick : function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    if(profile.onFileDlgOpen)profile.boxing().onFileDlgOpen(profile,src);
                },
                onChange:function(profile, e, src){
                    profile.boxing().setUIValue(xui.use(src).get(0).value+'',null,null,'onchange');
                }
            },
            LBTN:{
                onMousedown:function(profile){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    profile.box._spin(profile, false);
                },
                onMouseout:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                },
                onMouseup:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                }
            },
            RBTN:{
                onMousedown:function(profile){
                    var prop=profile.properties, type=prop.type;
                    if(type!='counter')return;

                    if(prop.disabled || prop.readonly)return;
                    profile.box._spin(profile, true);
                },
                onMouseout:function(profile){
                    if(profile.properties.type!='counter')return;
                    xui.Thread.abort(profile.$xid+':spin');
                },
                onMouseup:function(profile){
                    if(profile.properties.type!='counter')return;
                    xui.Thread.abort(profile.$xid+':spin');
                },
                onClick : function(profile, e, src){
                    var prop=profile.properties, type=prop.type;
                    if(type=='counter')return;

                    if(type=='popbox' || type=='cmdbox' || type=='getter' || type=='dropbutton'){
                        if(profile.onClick && false===profile.boxing().onClick(profile, e, src, 'right', prop.$UIvalue))
                            return;
                    }
                    if(type=='file'){
                        profile.boxing().popFileSelector();
                        return;
                    }

                    if(prop.disabled || prop.readonly)return;
                    profile.boxing()._drop(e, src);
                    return false;
                }
            },
            CMD:{
                onClick : function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    if(profile.onCommand && false===profile.boxing().onCommand(profile,src,prop.commandBtn))
                        return;
                    if(prop.commandBtn=='delete'||prop.commandBtn=='remove')
                        profile.boxing().setUIValue('',true,null,'cmd');
                }
            },
            BOX:{
                onClick : function(profile, e, src){
                    var prop=profile.properties;
                    if(prop.type=='cmdbox'||prop.type=='button'||prop.type=='dropbutton'){
                        if(profile.onClick)
                            profile.boxing().onClick(profile, e, src, 'left', prop.$UIvalue);
                    //DOM node's readOnly
                    }else if(prop.inputReadonly || profile.$inputReadonly){
                        if(prop.disabled || prop.readonly)return;
                        profile.boxing()._drop(e, src);
                    }
                }
            },
            INPUT:{
                onClick:function(p,e){
                    // for grid cell editor 'enter' bug: trigger list pop again
                    if(p.$cell){
                        e=xui.Event.getPos(e);
                        if(e.left===0&&e.top===0)return false;
                    }
                },
                onChange:function(profile, e, src){
                    if(profile.$_onedit||profile.$_inner||profile.destroyed||!profile.box)return;
                    var o=profile._inValid,
                        p=profile.properties,b=profile.box,
                        instance=profile.boxing(),
                        v = instance._fromEditor(xui.use(src).get(0).value),
                        uiv=p.$UIvalue;
                    if(!instance._compareValue(uiv,v)){
                        //give a invalid value in edit mode
                        if(v===null)
                            instance._setCtrlValue(uiv);
                        else{
                            // trigger events
                            instance.setUIValue(v,null,null,'onchange');
                            // input/textarea is special, ctrl value will be set before the $UIvalue
                            if(p.$UIvalue!==v)instance._setCtrlValue(p.$UIvalue);
                            if(o!==profile._inValid) if(profile.renderId)instance._setDirtyMark();
                        }
                    }
                    b._asyCheck(profile);
                },
                onKeyup:function(profile, e, src){
                    var p=profile.properties,b=profile.box,
                        key=xui.Event.getKey(e);
                    if(p.disabled || p.readonly)return false;
                    if(profile.$inputReadonly || p.inputReadonly)return;

                    // must be key up event
                    if(key.key=='esc'){
                        if(profile.$escclosedrop){
                            return;
                        }
                        
                        profile.boxing()._setCtrlValue(p.$UIvalue);
                        if(profile.onCancel)
                            profile.boxing().onCancel(profile);
                    }

                    if(p.dynCheck){
                        var value=xui.use(src).get(0).value;
                        profile.box._checkValid(profile, value);
                        profile.boxing()._setDirtyMark();
                    }
                    b._asyCheck(profile);

                    if(key.key=='down'|| key.key=='up'){
                        if(p.type=='spin'||p.type=='counter'){
                            xui.Thread.abort(profile.$xid+':spin');
                            return false;
                        }
                    }
                },
                onMousedown:function(profile, e, src){
                    profile._mousedownmark=1;
                    xui.asyRun(function(){if(profile)delete profile._mousedownmark;});
                },
                onMouseup:function(profile, e, src){
                    if(profile.properties.selectOnFocus && profile._stopmouseupcaret){
                        var node=xui.use(src).get(0);
                        if(!node.readOnly && node.select){
                            profile.$mouseupDelayFun=xui.asyRun(function(){
                                delete profile.$mouseupDelayFun;
                                if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                            })
                        }
                        delete profile._stopmouseupcaret;
                    }
                },
                onFocus:function(profile, e, src){
                    if(profile.$ignoreFocus)return false;
                    if(profile.beforeFocus && false===profile.boxing().beforeFocus(profile)){
                        profile.$ignoreBlur=1;
                        xui(src).blur();
                        delete profile.$ignoreBlur;
                        return false;
                    }
                    var p=profile.properties,b=profile.box;
                    if(p.disabled || p.readonly)return false;
                    if(profile.onFocus)profile.boxing().onFocus(profile);
                    if(profile.$inputReadonly || p.inputReadonly)return;
                    profile.getSubNode('BORDER').tagClass('-focus');
                    
                    var instance=profile.boxing(),
                        uiv=p.$UIvalue,
                        v=instance._toEditor(uiv),
                        node=xui.use(src).get(0),
                        nodev=node.value;

                    // if _toEditor adjust value, ensure node value
                    if(uiv!==v && nodev!==v){
                        profile.$_onedit=true;
                        node.value=v;
                        delete profile.$_onedit;
                    }

                    //if no value, add mask
                    if(p.mask){
                        var value=node.value;
                        if(!value){
                            profile.$focusDelayFun=xui.asyRun(function(){
                                // destroyed
                                if(!profile.box)return;
                                delete profile.$focusDelayFun;
                                profile.$_onedit=true;
                                profile.boxing()._setCtrlValue(value=profile.$Mask);
                                delete profile.$_onedit;
                                b._setCaret(profile,node);
                            });
                        }
                    }
                    if(p.selectOnFocus && !node.readOnly && node.select){
                        if(xui.browser.kde){
                            profile.$focusDelayFun2=xui.asyRun(function(){
                                delete profile.$focusDelayFun2;
                                if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                            });
                        }else{
                            if(node.tagName.toLowerCase()=="input" || !/[\n\r]/.test(node.value))node.select();
                        }
                        // if focus was triggerred by mousedown, try to stop mouseup's caret
                        if(profile._mousedownmark)profile._stopmouseupcaret=1;
                    }
                    //show tips color
                    profile.boxing()._setTB(3);   
                    
                    b._asyCheck(profile);             
                },
                onBlur:function(profile, e, src){
                    if(profile.$ignoreBlur)return false;
                    xui.resetRun(profile.$xid+":asycheck");
                    if(profile.$focusDelayFun)xui.clearTimeout(profile.$focusDelayFun);
                    if(profile.$focusDelayFun2)xui.clearTimeout(profile.$focusDelayFun2);
                    if(profile.$focusDelayFun2)xui.clearTimeout(profile.$mouseupDelayFun);
                    
                    var p=profile.properties;
                    if(p.disabled || p.readonly)return false;
                    if(profile.onBlur)profile.boxing().onBlur(profile);
                    if(profile.$inputReadonly || p.inputReadonly)return;

                    var b=profile.box,
                        instance=profile.boxing(),
                        uiv=p.$UIvalue,
                        v = xui.use(src).get(0).value;
                        
                    if(profile.$Mask && profile.$Mask==v){
                        v="";
                        uiv=profile.$Mask;
                    }
                    v=instance._fromEditor(v);

                    profile.getSubNode('BORDER').tagClass('-focus',false);

                    //onblur check it
                    if(instance._compareValue(p.$UIvalue,v)){
                        profile.box._checkValid(profile, v);
                        instance._setCtrlValue(uiv);
                    }
                    instance._setDirtyMark();
                    b._asyCheck(profile,false);
                },
                onKeydown : function(profile, e, src){
                   var  p=profile.properties;
                   if(p.disabled || p.readonly)return;
                   var b=profile.box,
                        m=p.multiLines,
                        evt=xui.Event,
                        k=evt.getKey(e);

                    //fire onchange first
                    if(k.key=='enter' && (!m||k.altKey) && !p.inputReadonly && !profile.$inputReadonly){
                        profile.$_onedit=true;
                        profile.boxing().setUIValue(profile.boxing()._fromEditor(xui.use(src).get(0).value),true,null,'enter');
                        profile.$_onedit=false;
                    }

                    b._asyCheck(profile);

                    if(p.mask){
                        if(k.key.length>1)profile.$ignore=true;
                        else delete profile.$ignore;
                        switch(k.key){
                            case 'backspace':
                                b._changeMask(profile,xui.use(src).get(0),'',false);
                                return false;
                            case 'delete':
                                b._changeMask(profile,xui.use(src).get(0),'');
                                return false;
                        }
                    }

                    if(k.key=='down'|| k.key=='up'){
                        if(p.type=='spin'||p.type=='counter'){
                            if(!k.ctrlKey){
                                profile.box._spin(profile, k.key=='up');
                                return false;
                            }
                        }else if(k.ctrlKey && p.type!='none' && p.type!='input' && p.type!='password'){
                            profile.boxing()._drop(e,src);
                            return false;
                        }
                    }
                },
                onDblclick:function(profile, e, src){
                    profile.getSubNode('RBTN').onClick(true);
                }
            },
            R1:{
                onMousedown:function(profile){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    profile.box._spin(profile, true);
                },
                onMouseout:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                },
                onMouseup:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                }
            },
            R2:{
                onMousedown:function(profile){
                    var prop=profile.properties;
                    if(prop.disabled || prop.readonly)return;
                    profile.box._spin(profile, false);
                },
                onMouseout:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                },
                onMouseup:function(profile){
                    xui.Thread.abort(profile.$xid+':spin');
                }
            }
        },
        EventHandlers:{
            onFileDlgOpen:function(profile, src){},
            onCommand:function(profile, src, type){},
            beforeComboPop:function(profile, pos, e, src){},
            beforePopShow:function(profile, popCtl, items){},
            afterPopShow:function(profile, popCtl){},
            afterPopHide:function(profile, popCtl, type){},
            onClick:function(profile, e, src, btn, value){},
            onClickIcon:function(profile, src){},
            beforeUnitUpdated:function(prfole,unit){},
            afterUnitUpdated:function(prfole,unit){}
        },
        DataModel:{
            cachePopWnd:true,
            // allowed: yyyy,mm,dd,y,m,d
            // yyyy-mm-dd
            // yyyy/mm/dd
            dateEditorTpl:"",
            groupingSeparator:",",
            decimalSeparator:".",
            forceFillZero:true,
            trimTailZero:false,
            parentID:"",
            popCtrlProp:{
                ini:{}
            },
            popCtrlEvents:{
                ini:{}
            },
            image:{
                format:'image',
                action: function(){
                    xui.UI.$iconAction(this);
                    this.boxing().reLayout(true);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                    this.boxing().reLayout(true);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                    this.boxing().reLayout(true);
                }
            },
            dropImageClass:{
                action:function(){
                    this.boxing().refresh();
                }
            },
            unit:{
                ini:"",
                set: function(v){
                    var ns=this;
                    if(ns.beforeUnitUpdated && false===ns.boxing().beforeUnitUpdated(ns, v))
                        return;
                    ns.properties.unit=v;
                    if(ns.renderId){
                        ns.getSubNode('UNIT').html(v);
                        ns.boxing().reLayout(true);
                    }
                    if(ns.afterUnitUpdated) ns.boxing().afterUnitUpdated(ns, v);
                }
            },
            units:'',
            numberTpl:{
                ini:"",
                action: function(){
                    this.boxing().setUIValue(this.properties.$UIvalue,true,null,'tpl');
                }
            },
            currencyTpl:{
                ini:"$ *",
                action: function(){
                    this.boxing().setUIValue(this.properties.$UIvalue,true,null,'tpl');
                }
            },
            listKey:{
                set:function(value){
                    var t = xui.UI.getCachedData(value),
                        o=this;
                    o.boxing().setItems(t?xui.clone(t):o.properties.items);
                    o.properties.listKey = value;
                }
            },
            dropListWidth:0,
            dropListHeight:0,
            items:{
                ini:[],
                set:function(value){
                    var o=this;
                    value = o.properties.items = o.box._adjustItems(value);
                    if(o.renderId){
                        //clear those
                        o.SubSerialIdMapItem={};
                        o.ItemIdMapSubSerialId={};
                        o.box._prepareItems(o, value);

                        // if popped
                        if(o.$poplink&&o.$poplink.box)
                            o.$poplink.boxing().setItems(value);
                        else
                            o.boxing().clearPopCache();
                    }
                }
            },
            type:{
                ini:'combobox',
                listbox:xui.toArr('none,input,password,combobox,listbox,file,getter,helpinput,button,dropbutton,cmdbox,popbox,date,time,datetime,color,spin,counter,currency,number'),
                set:function(value){
                    var pro=this;
                    pro.properties.type=value;
                    if(pro.renderId)
                        pro.boxing().refresh(true);
                }
            },
            showMode:{
                ini:'normal',
                listbox:['','normal','compact','transparent'],
                action:function(){
                    this.boxing().refresh()
                }
            },
            // for number&currency
            precision:2,
            increment:0.01,
            min:-Math.pow(10,15),
            // big number for date
            max:Math.pow(10,15),
            commandBtn:{
                ini:"none",
                combobox:xui.toArr("none,save,delete,add,remove,pop,select,search"),
                action:function(){
                    this.boxing().refresh();
                }
            },
            disabled:{
                ini:false,
                action: function(v){
                    this.box._handleInput(this,"xui-ui-disabled",v);
                }
            },
            inputReadonly:{
                ini:false,
                action: function(v){
                    this.box._handleInput(this,"xui-ui-inputreadonly",v);
                }
            },
            readonly:{
                ini:false,
                action: function(v){
                    this.box._handleInput(this,"xui-ui-readonly",v);
                }
            },
            // caption is for readonly comboinput(listbox/cmdbox are readonly)
            caption:{
                ini:null,
                set:function(v){
                    var p=this.properties;
                    p.caption=v;
                    
                    if(xui.isSet(v)){
                        v=v+"";
                        p.caption=xui.adjustRes(v,false);
                    }
                    if(this.renderId){
                        if(this.$inputReadonly || p.inputReadonly){
                            this.getSubNode('INPUT').attr("value",this.boxing().getShowValue());
                        }
                    }
                },
                get:function(){
                    return this.boxing().getShowValue();
                }
            }
        },
        RenderTrigger:function(){
            var self=this,
                instance=self.boxing(),
                p=self.properties;
            self.box._iniType(self);

            if(p.readonly)
                instance.setReadonly(true,true);
            else if(p.inputReadonly)
                instance.setInputReadonly(true,true);
        },
        _spin:function(profile, flag){
            if(profile.$inDesign)return;

            var id=profile.$xid+':spin';
            if(xui.Thread.isAlive(id))return;
            var prop=profile.properties,
                increment=Math.max( prop.increment, Math.pow(10, -prop.precision) ),
                off=increment*(flag?1:-1),
                task={delay:300},
                fun=function(){
                    if(profile.destroyed)return false;
                    var v=((+prop.$UIvalue)||0)+off;
                    v=(xui.isSet(v)&&v!=="")?xui.formatNumeric(profile.box._number(profile, v), prop.precision, prop.groupingSeparator, prop.decimalSeparator, prop.forceFillZero,prop.trimTailZero):"";
                    profile.boxing().setUIValue(v,null,null,'spin');
                    task.delay *=0.9;
                };
            task.task=fun;
            xui.Thread(id,[task],500,null,fun,null,true).start();
        },
        _dynamicTemplate:function(profile){
            var properties = profile.properties,
                type=properties.type,
                multiLines=properties.multiLines,
                showMode=properties.showMode,
                hash = profile._exhash = "$" +
                    'multiLines:'+multiLines+';'+
                    'type:'+type+';'+
                    'mode:'+showMode+';',
                template = profile.box.getTemplate(hash),
                adj = function(s){
                    return (!showMode || showMode=='normal') ? s : 'xui-ui-clear ' + s.replace(/\b(xui-ui-btn|xui-uibar|xui-uigradient|xui-uibase)\b/g,'') ;
                }

            properties.$UIvalue = properties.value;

            // set template dynamic
            if(!template){
                template = xui.clone(profile.box.getTemplate());
                var t=template.FRAME.BORDER, 
                     ip=t.BOX.WRAP.INPUT;

                delete t.LBTN;
                delete t.RBTN;
                delete t.SPINBTN;

                ip.tagName='input';
                ip.type='text';
                switch(type){
                    case "none":
                    case "input":
                    case "number":
                    case "currency":
                    break;
                    case 'button':
                        ip.type='button';
                    break;
                    case 'password':
                        ip.type='password';
                    break;
                    // spin has spin buttons
                    case 'spin':
                        t.SPINBTN={
                            $order:20,
                            className:'xui-ui-unselectable',
                            style:"{rDisplay}",
                            R1:{
                                tagName:'button',
                                className:adj('xui-ui-btn xui-uibar xui-uigradient xui-nofocus {_radius_dropt}'),
                                R1B:{
                                    className:'xuifont',
                                    $fonticon:'xui-icon-smallup'
                                }
                            },
                            R2:{
                                tagName:'button',
                                className:adj('xui-ui-btn xui-uibar xui-uigradient xui-nofocus {_radius_dropb}'),
                                R2B:{
                                    className:'xuifont',
                                    $fonticon:'xui-icon-smalldown'
                                }
                            }
                        };
                    break;
                    // following have RBTN button
                    case 'counter':
                        t.LBTN={
                            $order:1,
                            tagName:'button',
                            className:adj('xui-ui-unselectable xui-ui-btn xui-uibar xui-uigradient xui-nofocus {_radius_dropl}'),
                            style:"{_btnlDisplay}",
                            LMID:{
                                className:'xuifont',
                                $fonticon:'{_fi_btnlClass}',
                                style:'{_btnlStyle}'
                            }
                        };
                        break;
                    case 'file':
                        t.FILE={
                            $order:20,
                            className:'xui-ui-unselectable  {_radius_dropr}',
                            tagName:'input',
                            type:'file',
                            hidefocus:xui.browser.ie?"hidefocus":null,
                            size:'1'
                        };
                    case 'listbox':
                    case 'cmdbox':
                    case 'dropbutton':
                        t.className += ' xui-ui-noshadow';
                        ip.type='button';
                }
                if(type!='none'&&type!='input'&&type!='password'&&type!='button'&&type!='spin'&&type!='currency'&&type!='number'){
                    t.RBTN={
                        $order:20,
                        tagName:'button',
                        className:adj('xui-ui-unselectable xui-ui-btn xui-uibar xui-uigradient xui-nofocus {_radius_dropr}'),
                        style:"{_btnrDisplay}",
                        RMID:{
                            className:'xuifont',
                            $fonticon:'{_fi_btnrClass}'
                        }
                    };
                }
                if(type=='button'||type=='dropbutton'){
                    t.BOX.className += ' xui-uigradient';
                }

                if(multiLines){
                    switch(type){
                    case 'none':
                    case 'input':
                    case 'getter':
                    case 'helpinput':
                    case 'popbox':
                    case 'number':
                    case 'combobox':
                        ip.tagName='textarea';
                        ip.className='';
                        delete ip.type;
                    }
                }
                if(showMode && showMode!='normal'){
                    if(showMode=='transparent')t.BOX.className='{_radius_input} ';
                    t.CMD.className=adj(t.CMD.className);
                }
                // set template
                profile.box.setTemplate(template, hash);
            }
            profile.template = template;
        },
        _handleInput:function(prf,cls, v){
            var i=prf.getSubNode('INPUT');                        
            if((""+i.get(0).type).toLowerCase()!='button'){
                if(!v && (prf.properties.disabled||prf.properties.readonly||prf.$inputReadonly))
                    v=true;
                prf.getRoot()[v?'addClass':'removeClass'](cls);
                i.attr('readonly',v);
            }
        },
        _prepareData:function(profile){
            var data={},
                NONE='display:none',
                prop=profile.properties,
                type=prop.type,
                showMode=prop.showMode,
                arr=profile.box.$DataModel.commandBtn.combobox;
            data=arguments.callee.upper.call(this, profile, data);

            var tt=type,a,b,c=tt=='counter';
            tt=(tt=='combobox'||tt=='listbox'||tt=='dropbutton')?'arrowdrop':tt;

            data._fi_btnlClass = "xui-icon-singleleft" ;
            data._fi_btnrClass = tt=='counter'?'xui-icon-singleright':(data.dropImageClass||('xui-uicmd-' + tt));

            data._type="text";

            data._cmdDisplay = (a=(!data.commandBtn)||data.commandBtn=='none')?NONE:'';
            data._fi_commandCls = (xui.arr.indexOf(arr, data.commandBtn)!=-1?"xui-uicmd-":"") + data.commandBtn;

            data._btnrDisplay = (b=type=='none'||type=='input'||type=='password'||type=='currency'||type=='number'||type=='button')?NONE:'';
            data.typecls=profile.getClass('KEY','-type-'+data.type);
            if(!showMode || showMode=='normal'){
                data._radius_dropl='xui-uiborder-radius-tl xui-uiborder-radius-bl xui-uiborder-noradius-r';
                // lbtn + rbtn + cmd ?
                data._radius_input=(a&&b)?'xui-uiborder-radius':c?'xui-uiborder-noradius':'xui-uiborder-radius-tl xui-uiborder-radius-bl xui-uiborder-noradius-r';
                // rtbn?
                data._radius_dropr=a?'xui-uiborder-radius-tr xui-uiborder-radius-br xui-uiborder-noradius-l':'xui-uiborder-noradius';

                data._radius_dropt=a?'xui-uiborder-radius-tr xui-uiborder-noradius-l xui-uiborder-noradius-b':'xui-uiborder-noradius';
                data._radius_dropb=a?'xui-uiborder-radius-br xui-uiborder-noradius-l xui-uiborder-noradius-t':'xui-uiborder-noradius';
            }else if(showMode=='compact'){
                data._radius_input='xui-uiborder-radius';
            }
            return data;
        },
        _ensureValue:function(profile, value){
            var me=arguments.callee, prop=profile.properties;
            //if value is empty
            if(!xui.isSet(value) || value==='')return '';
            if(profile.$Mask && profile.$Mask==value){
                value='';
            }
            switch(profile.properties.type){
                case 'date':
                case 'datetime':
                    var d;
                    if(value){
                        if(xui.isDate(value))
                            d=value;
                        else if(xui.isFinite(value))
                            d=new Date(parseInt(value,10));
                        else
                            d=xui.Date.parse(value+"");
                    }
                    return d?String(profile.properties.type=='datetime'?d.getTime():xui.Date.getTimSpanStart(d,'d',1).getTime()):"";
                case 'color':
                    var c=xui.UI.ColorPicker._ensureValue(null,value);
                    return (c=="transparent"?'':'#')+c;
                case 'time':
                    return xui.UI.TimePicker._ensureValue(null,value);
                case 'currency':
                case 'number':
                case 'spin':
                case 'counter':
                    return this._number(profile, value);                
                default:
                    return typeof value=='string'?value:(value||value===0)?String(value):'';
            }
        },        
        _number:function(profile, value){
            var prop=profile.properties;
             if(/^\s*\=/.test(value||"")){
                 value = xui.ExcelFormula.calculate(value||"") || ""; 
             }
            value=xui.toNumeric(value, prop.precision, prop.groupingSeparator, prop.decimalSeparator, prop.forceFillZero,prop.trimTailZero);
            if(xui.isSet(prop.max))
                value=value>prop.max?prop.max:value;
            if(xui.isSet(prop.min))
                value=value<prop.min?prop.min:value;
            return value;
        },
        _onresize:function(profile,width,height){
            if(profile._$ignoreonsize)return;

            var prop=profile.properties,
                 type=prop.type,
                cmp=prop.showMode=='compact',
                // if any node use other font-size which does not equal to xui-node, use 'px' 
                f=function(k){if(!k) return null; k=profile.getSubNode(k); return k;},
                root=f('KEY'),
                v1=f('INPUT'),
                icb=f('ICONB'),
                ut=f('UNIT'),
                box = f('BOX'), 
                label = f('LABEL'),
                cmdbtn=f(prop.commandBtn!='none'?'CMD':null),
                lbtn=f(type=='counter'?'LBTN':null),
                rbtn=f(type=='spin'?'SPINBTN':(type=='none'||type=='input'||type=='password'||type=='currency'||type=='number'||type=='button')?null:'RBTN'),
                // determine em
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                fzrate=profile.getEmSize()/root._getEmSize(),
                v1fz=v1._getEmSize(fzrate),
                labelfz=label._getEmSize(fzrate),

                isB=v1.get(0).type.toLowerCase()=='button',
                $hborder, $vborder,
                
                clsname='xui-node xui-input-input',
                cb=xui.browser.contentBox,
                paddingH=!cb?0:isB?0:Math.round(v1._paddingH()/2)*2,
                paddingH2=!cb?0:Math.round(v1._paddingH()/2)*2,
                paddingW=0,

                autoH,icbw,utw,btnw, 
                pl=0,pr=0,
                boxB=box._borderW(),
                offset=boxB/2;

            $hborder=$vborder=!cb?0:offset;
            btnw=parseInt(profile.getEmSize() * 1.5,10);

            // calculate by px
            if(height)height = (autoH=height=='auto') ? profile.$em2px(!cb?1.6666667:1,null,true) + paddingH2 + boxB: profile.$isEm(height) ? profile.$em2px(height,null,true) : height;
            if(width)width = profile.$isEm(width) ? profile.$em2px(width,null,true) : width;

            // for auto height
            if(autoH){
                profile._$ignoreonsize=1;
                root.height(adjustunit(height));
                delete profile._$ignoreonsize;
            }

            var labelPos=prop.labelPos || 'left',
                // make it round to Integer
                labelSize=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelSize,labelfz,true)||0,
                labelGap=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelGap,null,true)||0,

                ww=width,
                hh=height,
                bwcmd=0,
                lbw=0,
                rbw=0,
                left=Math.max(0, (prop.$b_lw||0)-$hborder),
                top=Math.max(0, (prop.$b_tw||0)-$vborder);
            if(null!==ww){
                ww -= Math.max($hborder*2, (prop.$b_lw||0)+(prop.$b_rw||0));
                lbw=lbtn?btnw:0;
                rbw=rbtn?btnw:0;
                bwcmd=cmdbtn?btnw:0;
//                bwcmd=(cmdbtn?cmdbtn.offsetWidth:0);
//                rbw=(rbtn?rbtn.offsetWidth:0);
                /*for ie6 bug*/
                /*for example, if single number, 100% width will add 1*/
                /*for example, if single number, attached shadow will overlap*/
                if(xui.browser.ie6)ww=(Math.round(ww/2))*2;
            }
            if(null!==hh){
                hh -=Math.max($vborder*2, (prop.$b_lw||0) + (prop.$b_rw||0));

                if(xui.browser.ie6)hh=(Math.round(hh/2))*2;
                /*for ie6 bug*/
                if(xui.browser.ie6&&null===width)box.ieRemedy();
            }
            var iL=ww===null?null:left + (labelPos=='left'?labelSize:0),
                iT=hh===null?null:top + (labelPos=='top'?labelSize:0),
                iW=ww===null?null:Math.max(0,ww - ((labelPos=='left'||labelPos=='right')?labelSize:0)),
                iH=hh===null?null:Math.max(0,hh - ((labelPos=='top'||labelPos=='bottom')?labelSize:0)),
                iH2=hh===null?null:Math.max(0,height - ((labelPos=='top'||labelPos=='bottom')?labelSize:0)),
                iR=labelPos=='right'?labelSize:0;

            // label
            if(labelSize){
                label.css('display','');
                label.cssRegion({
                    left:adjustunit(ww===null?null:labelPos=='right'?(ww-labelSize+labelGap +$hborder*2):0,labelfz),
                    top: adjustunit(height===null?null:labelPos=='bottom'?(height-labelSize+labelGap):0,labelfz), 
                    width:adjustunit(ww===null?null:Math.max(0,((labelPos=='left'||labelPos=='right')?(labelSize-labelGap):ww)),labelfz),
                    height:adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):height)-paddingH),labelfz)
                });
            }else{
                label.css('display','none');
            }
            if(iW!==null){
                if(cmp){
                    pl += lbw;
                    pr += bwcmd + rbw;
                }else{
                    iW -= bwcmd + rbw + lbw;
                }
            }
            // left 1
            if(lbtn){
                if(iH2!==null)
                    lbtn.height(adjustunit(Math.max(0,iH2)));
                if(iW!==null)
                    lbtn.left(adjustunit(iL));
                lbtn.top(adjustunit(iT));
                if(!cmp){
                    iL+=lbw;
                }
                // for left offset 1px
                if(iW!==null){
                    iL -= offset;
                    iW += offset;
                }
            }
            //left 2
           if(prop.image||prop.imageClass){
                icb.setInlineBlock();
                if(icbw=icb.offsetWidth(true))
                    pl += icbw;
            }
            if(!icbw)icb.css('display','none');
            else if(cmp&&lbw)
                icb.left(adjustunit(lbw,icb));

            // right 1
            if(bwcmd){
                cmdbtn.top(adjustunit(iT));
                if(iH2!==null)
                    cmdbtn.height(adjustunit(Math.max(0,iH2)));
                if(iW!==null){
                    cmdbtn.css('right',adjustunit(iR));
                    iR += bwcmd - $hborder;

                    // for left offset 1px
                    iW += offset;
                }
            }

            // right 2
            if(rbw){
                rbtn.top(adjustunit(iT));
                if(iH2!==null)
                    rbtn.height(adjustunit(Math.max(0,iH2)));
                if(iW!==null){
                    rbtn.css('right',adjustunit(iR));
                    // for left offset 1px
                    iW += offset;
                }
               if(iH2!==null && prop.type=='spin'){
                    if(iH2/2-$vborder*2>0){
                        f('R1').height(adjustunit(iH2/2));
                        f('R2').height(adjustunit(iH2/2 + (Math.round(iH2) - Math.round(iH2/2)*2) ));
                    }
                }
            }
            // right 3
            if(prop.unit){
                ut.setInlineBlock();
                if(utw=ut.offsetWidth(true))
                    pr += utw;
            }
            if(!utw)ut.css('display','none');
            else if(cmp && (rbw||bwcmd))
                ut.css('right',adjustunit(rbw+bwcmd, ut));
                
            // box
            box.cssRegion({
                left:iW?adjustunit(iL):null,
                top:iH?adjustunit(iT):null,
                width:iW?adjustunit(iW):null,
                height:iH?adjustunit(iH):null
            });

            // input last
            if(pl)v1.css('paddingLeft',adjustunit(pl,icb));
            if(pr)v1.css('paddingRight',adjustunit(pr,ut));

            // must recalculate here
            paddingW = !cb?0:isB?0:v1._paddingW();
            if(null!==iW && iW-paddingW>0)
                v1.width(adjustunit(Math.max(0,iW-paddingW),v1fz));
            if(null!==iH && iH-paddingH>0)
                v1.height(adjustunit(Math.max(0,iH-paddingH),v1fz));

            /*for ie6 bug*/
            if((profile.$resizer) && xui.browser.ie){
                box.ieRemedy();
            }
        }
    }
});xui.Class('xui.UI.ColorPicker', ['xui.UI',"xui.absValue"], {
    Instance:{
        activate:function(){
            this.getSubNode('TOGGLE').focus(true);
            return this;
        },
        _setCtrlValue:function(value,inner){
            return this.each(function(profile){
                if(!profile.renderId)return;
                var cls = profile.box,
                    p = profile.properties;
                if(value && value.toLowerCase()=='transparent')value='transparent';

                var hex = profile.$hex = cls._to3(value),
                    hexs = profile.$hex.join(''),
                    rgb = profile.$rgb = cls.hex2rgb(value),
                    hsv = profile.$hsv = cls.rgb2hsv(rgb),
                    f=function(s,v){profile.getSubNode(s).get(0).firstChild.nodeValue=String(v)},
                    ff=function(v){return parseInt(v*100,10)};
                if(value=='transparent'){
                    hex=profile.$hex = ['00','00','00'];
                    rgb=profile.$rgb = [0,0,0];
                    hsv=profile.$hsv = [0,0,0];
                };

                f('R',rgb[0]);
                f('G',rgb[1]);
                f('B',rgb[2]);
                f('H',hex[0]);
                f('E',hex[1]);
                f('X',hex[2]);

                //dont update hsv UI again, if hsv value is the newest
                if(profile.$hexinhsv != hexs){
                    f('HH',hsv[0]);
                    f('S',ff(hsv[1]));
                    f('V',ff(hsv[2]));
                    delete profile.$hexinhsv;
                }
                cls._setClrName(profile,value=='transparent'?value:hexs);
                cls._updateDftTip(profile);
                //dont update adv UI again, if adv value is the newest
                if(p.advance && profile.$hexinadv != hexs){
                    cls._updateMarks(profile, value, true, hsv[0]);
                    delete profile.$hexinadv;
                }
                //from setUIValue/setValue
                if(inner!=false)
                    profile.getSubNode('CAPTION').html((value=='transparent'?'':'#')+value,false);
           });
        },
        getColorName:function(){
            return this.get(0).$clrN||'';
        }
    },
    Initialize:function(){
        var ns=this,
            id=xui.UI.$ID,
            cls=xui.UI.$CLS,
            tag=xui.UI.$tag_special,
            key=ns.KEY,
            list=ns._slist,
            l=list.length,
            i,data,
            arr=[],
            evs=xui.$IEUNSELECTABLE(),
            evs2='style="visibility:hidden;"',
            ddcls = 'xui-node xui-node-span xui-ui-draggable xui-uibase xui-uiborder-flat';

        ns.addTemplateKeys(['DD1', 'DD2', 'DD3','R','G','B','TXT','HH','S','V','H','E','X']);

        //simple list
        for(i=0;i<l;i++){
            arr.push('<span  '+'id="'+key+'-SC:'+id+':'+list[i]+'" style="background-color:#'+list[i]+'" '+evs+' class="xui-node xui-span xuicon xui-uiborder-flat xui-icon-placeholder">'+(xui.__iefix2&&xui.__iefix2['xui-icon-placeholder']||'')+'</span>');
            if((i+1)%17==0)arr.push('<br />');
        }
        //data
        data = '<div '+evs+'><span class="'+cls+'-txt"'+evs+'>R: </span><span '+'id="'+key+'-R:'+id+':" class="'+cls+'-dd2 '+ddcls+' '+tag+'DD2_CC'+tag+'" '+evs+'>R</span><span '+evs2+'>%</span><span class="'+cls+'-txt"'+evs+'>G: </span><span '+'id="'+key+'-G:'+id+':" class="'+cls+'-dd2 '+ddcls+'  '+tag+'DD2_CC'+tag+'" '+evs+'>G</span><span '+evs2+'>\xB0</span><span class="'+cls+'-txt"'+evs+'>B: </span><span '+'id="'+key+'-B:'+id+':" class="'+cls+'-dd2 '+ddcls+'  '+tag+'DD2_CC'+tag+'" '+evs+'>B</span></div>' +
                '<div '+evs+'><span class="'+cls+'-txt"'+evs+'>S: </span><span '+'id="'+key+'-S:'+id+':" class="'+cls+'-dd2 '+ddcls+'  '+tag+'DD2_CC'+tag+'"  '+evs+'>S</span><span '+evs+'>%</span><span class="'+cls+'-txt"'+evs+'>H: </span><span '+'id="'+key+'-HH:'+id+':" class="'+cls+'-dd2 '+ddcls+'  '+tag+'DD2_CC'+tag+'" '+evs+'>H</span><span '+evs+'>\xB0</span><span class="'+cls+'-txt"'+evs+'>V: </span><span '+'id="'+key+'-V:'+id+':" class="'+cls+'-dd2 '+ddcls+'  '+tag+'DD2_CC'+tag+'" '+evs+'>V</span><span '+evs+'>%</span></div>' +
               '<div '+evs+'><span class="'+cls+'-txt"'+evs+'>HEX: </span><span '+'id="'+key+'-H:'+id+':" class="'+cls+'-dd3 '+ddcls+'  '+tag+'DD3_CC'+tag+'" '+evs+'>H</span><span '+'id="'+key+'-E:'+id+':" class="'+cls+'-dd3 '+ddcls+'  '+tag+'DD3_CC'+tag+'" '+evs+''+evs+'>E</span><span '+'id="'+key+'-X:'+id+':" class="'+cls+'-dd3 '+ddcls+'  '+tag+'DD1_CC'+tag+'" '+evs+'>X</span></div>'
        ns.setTemplate({
            style:'{_style};height:auto;width:auto',
            tagName : 'div',
            onselectstart:'return false',
            BORDER:{
                tagName : 'div',
                className: 'xui-uiborder-outset xui-uiborder-box xui-uiborder-radius-big',
                BAR:{
                    tagName:'div',
                    className:'{classBar}',
                    BARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-tl',
                        BARTDLT:{
                            className:'xui-uibar-tdlt'
                        }
                    },
                    BARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar',
                        BARTDMT:{
                            className:'xui-uibar-tdmt'
                        }
                    },
                    BARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-tr',
                        BARTDRT:{
                            className:'xui-uibar-tdrt'
                        }
                    },
                    BARCMDL:{
                        $order:3,
                        tagName: 'div',
                        className:'xui-uibar-cmdl',
                        SPACE:{
                            className:'xuifont',
                            $fonticon:'xui-icon-placeholder'
                        }
                    },
                    BARCMDR:{
                        $order:4,
                        tagName: 'div',
                        className:'xui-uibar-cmdr',
                        CLOSE:{
                            className:'xuifont',
                            $fonticon:'xui-uicmd-close',
                            style:'{closeDisplay}'
                        }
                    },
                    TBARTDB:{
                        $order:5,
                        tagName: 'div',
                        className:'xui-uibar-tdb xui-uiborder-inset xui-uiborder-radius'
                    }
                },
                MAIN:{
                    $order:2,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    MAINI:{
                        tagName:'div',
                        className:'xui-uicon-maini xui-uibar',
                        CON:{
                            $order:1,
                            tagName:'div',
                            className:'xui-uiborder-inset xui-uiborder-radius',
                            SIMPLE:{
                                tagName:'div',
                                TOP:{
                                    $order:1,
                                    tagName:'div',
                                    DATA:{
                                        $order:0,
                                        tagName:'div',
                                        onselectstart:'return false',
                                        text:data
                                    },
                                    EXAM:{
                                        $order:3,
                                        tagName:'div',
                                        className:'xui-uiborder-inset xui-uiborder-radius'
                                    }
                                },
                                LIST:{
                                   $order:2,
                                   tagName:'div',
                                   text: arr.join('')
                                }
                            },
                            ADV:{
                                $order:2,
                                style:'{advDispay}',
                                tagName:'div',
                                ADVWHEEL:{
                                    $order:0,
                                    tagName:'div'
                                },
                                ADVCLR:{
                                    $order:1,
                                    tagName:'div'
                                },
                                ADVMARK1:{
                                    $order:3,
                                    tagName:'div'
                                },
                                ADVMARK2:{
                                    $order:4,
                                    tagName:'div'
                                }
                            }
                        }
                    }
                },
                TAIL:{
                    $order:3,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    TAILI:{
                        tagName:'div',
                        className:'xui-uibar xui-uicon-maini',
                        TRANS:{
                            className:'xuicon',
                            $fonticon:'xui-icon-transparent',
                            tabindex: '{tabindex}',
                            title:"{_transparent}"
                        },
                        CAPTION:{
                            text : '{caption}'
                        },
                        SET:{
                            tagName:"button",
                            className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                            tabindex: '{tabindex}',
                            text:"{_set}"
                        },
                        TOGGLE:{
                            $order:2,
                            className:'xuifont',
                            $fonticon:'xui-icon-doubleright',
                            tabindex: '{tabindex}'
                        }
                    }
                },
                BBAR:{
                    $order:4,
                    tagName:'div',
                    className:'xui-uibar-bottom-s',
                    BBARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-bl'
                    },
                    BBARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar'
                    },
                    BBARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-br'
                    }
                }
            }
        });
    },
    Static:{
        _radius:84,
        _square:100,
        _bigRadius:97,
        DataModel:{
            height:{
                ini:'auto',
                readonly:true
            },
            width:{
                ini:'auto',
                readonly:true
            },
            value:{
                ini:"FFFFFF",
                format:'color'
            },
            barDisplay : {
                ini:true,
                action:function(v){
                    if(v)
                        this.getSubNode('BAR').replaceClass('xui-uibar-top-s','xui-uibar-top');
                    else
                        this.getSubNode('BAR').replaceClass('xui-uibar-top','xui-uibar-top-s');
                }
            },
            closeBtn:{
                ini:true,
                action:function(v){
                    this.getSubNode('CLOSE').css('display',v?'':'none');
                }
            },
            advance:{
                ini:false,
                action:function(v){
                    var ns=this,
                        tg=ns.getSubNode('TOGGLE');
                    ns.getSubNode('ADV').css('display',v?'':'none');
                    ns.getSubNode('CON').css('padding-right',v?'205px':'0px');
                    if(xui.__iefix2){
                        tg.html(xui.__iefix2[v?'xui-icon-doubleleft':'xui-icon-doubleright']);
                    }else{
                        if(v) tg.removeClass('xui-icon-doubleright').addClass('xui-icon-doubleleft');
                        else tg.removeClass('xui-icon-doubleleft').addClass('xui-icon-doubleright');
                    }
                    if(v)
                        ns.box._updateMarks(ns,ns.properties.$UIvalue,true, ns.$hsv[0])
                }
            }
        },
        Appearances:{
            KEY:{
            },
            'TBART, BBART':{
                'border-spacing':0,
                'border-collapse':'separate'
            },
            MAINI:{
                'padding':'.5em .3333em .3333em 0'
            },
            CON:{
                padding:'.25em',
                position:'relative'
            },
            '.xui-uibar-top BARCMDL':{
                padding:".25em 0 0 0"
            },
            '.xui-uibar-top BARCMDR':{
                top:".3334em",
                right:".5em"
            },
            CMDL:{
                padding:".25em 0 .25em 0"
            },
            DATA:{
            },
            'DATA span':{
                'padding':'0 1px',
                'margin-left': '-1px',
                'margin-right':'1px',
                'width':'2em'
            },
            'DATA div':{
                'padding':'.5em 0'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            },
            EXAM:{
                padding:'.125em',
                position:'absolute',
                width:'5.5em',
                height:'5.5em',
                top:'.25em',
                right:'.25em',
                'white-space':'normal',
                'text-align':'center'
            },
            'DD1, DD2, DD3':{
                'padding-right':'2px',
                cursor:'e-resize',
                'text-align':'center'
            },
            TOP:{
                position:'relative'
            },
            LIST :{
                position:'relative',
                overflow:'hidden',
                padding:'.25em',
                'white-space': 'nowrap',
                'line-height':'1em'
            },
            TAILI:{
                position:'relative',
                 padding:'.5em 0 0 0',
                'text-align':'center'
            },
            SIMPLE:{
                position:'relative'
            },
            ADV:{
                position:'absolute',
                right:'4px',
                bottom:'4px',
                width:'195px',
                height:'195px'
            },
            'ADV div':{
                cursor:'crosshair',
                position:'absolute'
            },
            ADVCLR:{
                background: xui.browser.ie6?null:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGUAAABlCAYAAABUfC3PAAAABGdBTUEAANbY1E9YMgAAABh0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjIyt5EXfQAATvhJREFUeF7t3AeUl+Wd8P3ZfXaTbHo1xsQSY2JMjLFHjS32rih2EVEUFEQFkSoCAgKiSG/Se++9997bAMPMML333v7v55qd8UyIKVvenOe85zXnuwzGxPX34Xdd9/0H8i8TJkyInH/++VH+iIT88cXX4Yu6P1f77zX4a77064Z/rf+emi/562vq/gbhm9p/v+77f/b1l/w19f+5L/vP/9mfa/jf2+Drs/+a8P9/7Z+r++OLv//Z//n6v+Csv75+Vl/2nz/736ufYfj7NZznf/7D/+efrJ97+PdvjVq7dm3tgFStSpWrTKUqVqHylatsZSpdKUpWguJ1WqcUrWM6rAPap93aoa3apA0Kf+OVWq7FWqh5mqUZmqKJGqcxGqmhGqRP1V991Us91E2d1UHv6h29qTfUQs3VTE30nJ5WYzXSI3pQ9+lu3aHbdLNu0vW6VlfpCl2uy3SpLtHFulDn6zydq3P0Q31f39W39E19XV/TV/Xv+jf9q/4liPTt2/fT/6+hdPEP1xClje+3qqmpaaHmaqYX9byeVmM10iN6UPfpbt2h23SzbtIfdK2u0hW6XJdVV1dfqkt0sS7U+TpPP6mqqjpHP9T39d3KyspvV1RUfLO8vPzrZWVlXystLf1qcXHxV/Ly8v4tMSHxX7dv2/4v/x717/+JsmbNmoj/khqFPypVrjKVqliFyleuspWpdKUoWQmK12mdUrSO6bAOaJ92a4e2apM2aK1WabmWaKHmabZ/iBmaqkkarzEaqWEarIH6WH3VWz30gbqoo9obQlu1USu11Kt6WS8azvN6Rk/qcT1qWA/pft1jaHfqdt2qPxrgDbpO15SUlFxpmL/Tb4uKin6tXxUWFv6ioKDg5/n5+Rca8s9yc3PPy87O/nFmZuaPMtIzfpiWmvb9pMSk78THxX/r1MlT3zhy+MjX9+3d9x9bNm/56vx58/+9z4d9/k/jRo3/Fcq/fvTRR/+J4h+iRtWqVLnKVKpiFSpfucpWptKVomQlKF6ndUrROqYjOqh9BrFHO7VNm7VR67RKK7REizRfszVTUzVJ4/W5RmmYBhviQH2sfuqtnuquruqk9wy3rd5Sa7U03Ff1sprqBQN+Vk/pCT1m2A/rAd1r4HfpT7rV0G829Bt0vcFfY/BX6grDv9zwL8vJyfkVgEsAXJyRkXFhelr6+ampqT9NSko6NyEh4RwQPzodc/oHx48d/+6hg4e+vXvX7m9u2rjpG6tXrv6P+XPnf23E0BFfaf1663+77ebb/g+U/wNlYNTq1asj/kFrVK3wR7nKVKpiFSpfucpWpn/odKUoWQmKV6xidELHdUQHtV97tFPbDGizNmqdVmmFlmqR5muOoc3UNE3WBI3VaMMbriH6TAPU3xD76EN11/vqZJgd1E5vG+qbel2v6RXDfUlN9JwhP63GhtxIjxr0gwZ9v+4x7DsM+/asrKxbsjIzbzL0P6Snp19r6Fcb+u9TUlIuT05K/o2j59Iz8Wd+afi/MPyfnzxx8oIT0SfOP3rk6HkHDxw810acs3PHzh9t3LDx+ytXrPzuwvkLvz1tyrRvjh0z9hsDBwz8+rvvvPu1h+9/+Cu/+dVv/h3Kv/Xp02dg1KpVqyIGUaNqVSr8UaZSFatQ+co1mGxlKkOpSlGizihWMTqh4zqigwa3X3u0U9u0RRu1TqsNcaWWarEWaI5mGeg0TdEEjdVoQx2hoRqkT/Sx4X6kXuqhbobcWR0N+V29ozaG3UotDftVNTPwpnre0J8x9Cf1uKE/5kf6Q+npGfenpaXd68i5y/D/ZPi3Gv4fHT83+pF/PYBr4mLjroo9HXtFzKmYywFcZgsudSRdAuFiCBft2rnrgq1btv7URpy3bu26c2Gcs2Degh/OmDbj++M+H/fdQQMHfbtvn77f6tyh8zdfavLS12+58ZavXfSzi74K5Su9e/f+LGrlypURw6lRtSpVrjKFP4pVqHyDylWOspShVKUoUWcUqxid0HFDPKJDOqC92qXt2qJNBrpeq7VSS7XYUBdormZpuqYY8ESN0xiNMOShGqxP9bFh91Vvw+6pbupi4B3V3tDb6i1Db63XDf5VvWz4TfWCH/nPAnjK8BunpqQ2AvBISnLKg46e+2zA3QlnEu6AcBuEm23BTRD+YBOuiz4effWxo8euBPE7EL/dv2//rx1Lv9qxfccl7omfb1i/4cJVK1f9bOmSpT9duGDhT2bPnP3jKZOm/GjMqDE/+OzTz77fq0ev73bp2OU7jq1vNX6s8TeuvfLar//0xz/9DyhfgzKoFsUQa1StSpWrTKUqVqEKDDJPOcpShlKVokSdUaxidMKAj+uoDumA9mqXtmuLYW/Seq3RSi3TYkNfqLmaremaYvATNc7gx2ikhhn8YH2qAYbfV731IYAP1BVAJ7UH0E5vAWit1yG8BuEVvQSiCYTnIDxtExrbhEYgHgHxEIj7HUf3wLgTxu0u51tsxE0wboBxHYxr3A9XHdh/4Iq9e/ZebjMu27Z126WbN23+pc24GMhFSxYvOd8l/rNZM2adN3ni5HM/H/35OUMGDflhvz79ftC1U9fvtXu73XdfffnVbz/8wMPf/P1vf/+Nn/zwJ1+H8h+9evUaFLVixYqIQdWoWpUqV5lKVazwR4Gh5SlHWcpQqlKUqDOKNcQYnVS0juqQDmivwe7SDm3VZm3QGkNepWVaooUGPU+zNUNTDXuSxutzAx+l4Rpi6AP1iaH3Ux/1MvjuBv++Oht8B71r+G/bgjcBvJGcnNwCQHMAzQC8COB5AM/qKQhPOJIeg/CwjXjARtwL4S5H0x3uh9sOHzp8s624yVb8Yc/uPdeCuNpj7O9txu/cF7+FcRmMX9mOS2zHxbbjwqmTp54/fuz4n40cPvK8Af0H/NhT1jnvd37/h++0eecHLV9t+b3nnn7uu3fdfte3L/vlZd8853vnfAPKN6AMjlq+fHnE0GpUrUqVq8zASlWiIhUoTznKUoZSDTFFiUpQnE7rpGFG66gO66D2Gepu7dBWbTbYDVqr1Ya7XEu1yHDna45mGvI0TdYEgx6r0QY9QkMN+zN9auAfG/hHfsT3NvAe6mboXQ29o9obfFtDf8vQW/uR/7rBv2bwrxj8SzagieE/bwueNvwnbUEjW/AogIcA3A/gXptwl6PpTy7rW23DzRBudFf8Yf269detXrX66hXLV/zeVvzOnfGbubPnXubeuNRR9UubcfGIYSMuclxd0O+jfufDOM92nPtGizd+/HLTl3/07FPP/tCW/OCm62/63sUXXPydH3z7B9+G8q0Pe344JGrZsmURg6xRtSpVrjKVGmaJilSgPOUoSxkGm6YUJSlBcTptyCcVrWM6rIOGvU+7tUPbDHyLNmqtga/WCi0z9EWab+hzNUvTDX6KJhr+OMMfY/gjNczwByUlJQ8EMMDw+6oPgJ76AML7EDpBeA9COwhvQ3gTwhsQWkBobguagXgRxAsgngHxFIgnHEmPuawftg0P2Ib73BN3u7TvcDTd7q64Ze2atTfBuAHG9bbi2kULFl01b86838+cPvNym/Ebm/FrIL8aNmTYJQM/GXixC/2inh/0vKB92/Y/a9Wy1XnNXmx27jNPPvPjJx594px777z3R+6TH1z40wu/971vfv+7UL7Ts2fPoVFLly6NGGaNqlWpcpUZZqhERSpQnnJkrlkZSlOqkpSgOEM+rVM6oWMGfVgHtV97DHyntmmLgW/UOq0x9BVapsVaYPjzDH6WZmgqgEkaD2CM4Y/ScMMfrM8ADADQTx9B+BBCdwjvQ+isDiDeBfEOiDYQWkFo6Th6FcTL7oWXQDQB8RyIp0E0thWNbMWjjqaHYNxvK+61FXfC+BOM22DcvHTx0ptg/MF7xnVzZs25xnZc5d64wpPV5Y6qy9wdl37y8Se/BHIJkItd6he91fqt890hP3NknffoQ4+e6zH43DtuveOcKy+/8kfnn3v+D777je9+H8r3evToMawWxUBrVK1KlYcMtUwlKlKB8pSjLAPOVJpSlaQEg45XrE7phI4Z+BEd0n7D3qOd2q6tBr9J6wx9jVY675cb/BItNPx5mm34MzTV8CdpPIDPNQrAcABD9BmETyD0V18IvSD0gNANQhfb0BFEexBtQbwFojWI10G8BqI5iGaOpxdBPG8rnrEVTzminnBEPQbjYZvxoLviPhh3w7jDZty+eOHiWx1Vf3RU3Wg7rrcd104cP/Fq23ElkCsGfzb4t0Au692z96VAfulSv8SWXPz6a69f2PSFpuc/2ejJnz1wzwPnuUt+4lH43Mt/ffk5Pz3npz/6zte/80MoP+jRvcfwqCVLlkQMtUbVqlSFgZarTCUqUoHyDDdH2cpU+CNVSYacoHjFOmZOGfYJHdcRAz9k4Pu118B3abu2GvomrTf0tVpl6Mu1xNAXar7mGP5Mg5+myYY/QWMNf7Thj9RQAIMADATwMYB+6g3hQwjdIXR1JHWG0AFCOwjvuCPagGhlI1pCeNVGvAziJRBNQDwH4mkQT4J4fM3qNY96v3ho+bLlD7gz7rUZd9uMO2zGbTBugfHHSRMm3egl8PpRI0ZdO3Tw0KvcH1f279v/d70/7H25O+Syju07Xuoe+dWbb7x5iXvkYsfWRY8++OgFQH528w03//T6q68/zyX/E09eP/72f3z7HCg/6t69+4ioxYsXRwy2RtWqVIXhlqtMJSpSgWHnGXKuspWpNANPVfhXouINO1YxOmngx3VUhw39gPZql8Hv0DZD36wNBr9Wq7TC8Jca/CItMPy5mmX40zUFwEQA4zQGwkgAwwAMAfAZgAHqbxM+gtBLPSB0g9AFQkfb0B5EWxBvgWjtaHodxGsgmrsrmnl6etER9YIj6llb8ZStaLxs6bLHlixa8giMh2DcD+MeGHd5G78Dxm2Oqlu8d9zkMr/BdlxvO65xXF31YY8Pr+z+fvcrOrzb4beesi5zj1zq2PrV8888f8njjz5+sS256LY/3nbBH675w/lX/e6qn/3y57/86Y+//+OffOtr3zoXyo8/+OCDkVGLFi2KGGiNqlWpCkMtV5lKVKQC5RtwrrKVqXSlGnSyEhVv2LGK0UkdN/SjOmzgB7RPuw1+p7YZ/GZt0DrDX62Vhr/M8BdrgeHP1WwAMwBM1SQI4yGM1SgAwzXUNgyC8Ilt+BhEXxC9QPSE8IFjqSuIziDesxHtQLzjnmgDohWIlrbiVVvxiq14yeNskxXLVjwH4xkYT/o45HEYjzmmHobx4PSp0+9zb9wzYdyEOx1Vf7Idt9mOm23HTR53b/io90fX9+ze8xobclWn9zpdCeR3Xg5/C+Q3Lz7/4q+feuKpXz3y4COX3P2nuy/+4x/++PNrfn/NRY6uC35x4S/O9zj8UyjnQTmvW7duo6I8U0cMt0bVqjTcCpWrTCUqUqEh5ytX2co07HSlKVmJBn5G4V8xhn5S0QZ+VId10ND3abfB79R2g9+ijVpv+GsMf6WWG/4SLQQwz/Dn2ICZmgZgMoAJGgthDIQREIZBGAxhoG0YAKIfiD4QPoTQ3Ua8D6KLjegIoj2ItiDeAtEaxOu2ooUjqrkjqpn7oqn74gUYz8J42mY09uL3OIxHYTwE4wFH1X2jR46+e/jQ4Xfajts9Xd3muLrZcXVTjw963ADkehtyDZCrbcjvX3vltSt8jHK5x9/fPPbwY7+2JZf+6ZY//dKW/MIFf/Glv7j0op+f//OLfvidH17wza9+83woP3v//fdHRy1YsCBiyDWqVqUBV6hcZSpRkQoNO1+5ylaWoacrTcmGnqQzijP40zqlaMM/piM6aPj7DX+Pdmk7gK3aBGA9gDVaBWG5lkBYBGG+5kCYCWE6hCkQJmociDEgRoIYDmIwiM9sxCcw+oP4CEQvG9EDRjf3RFcYnRxP78FoB+NtW9EGRqvlS5e3hPHa4kWLX/GD8yUX+Is243kYz3iiesq98YSjqpHH3Edsx0O2436Puvf67Ooux9UdQG7v06vPrT269bjZhX6jO+QGd8h17pBrgFzlHrnyhWdfuOLJx5+8/MF7H/zNPXfc8+tbb7r1Uo/Bv7ziN1dc4ui62OPwz72jXPSNr3zjQigXvN/1/TFRPgqIGGyNqlVlsBUqV5lKVKxCQ85XrnKUZdDpSlOKgSfpjOIN/LROGfgJHdMRgz+k/Qa/V7sMfoe2Gv4mg9+gtVoNYAWApQAWawGAuQBmAZihqRAmQRgP4XMIoyCMsBFDQQwCMRDCxzaiH4g+NuJDEN3dE++D6AyiI4j2tqItiLccUW8uWrjoDZvR0nvGqzbjZRgv2YwmMJ6D8QyMJ23HEzAesx2PeNR9yHbc/3G/j+9xf9ztM6w7Puj6we1Abn2v3Xs3t32r7U1AbvC2fr0NucY9cvXTjZ++qtHDjX4P5PLbb779t14WL3OX/Pq3l/72UkfXL8/70XmXfP9b378Yys+h/Lxrl66fR82bOy9iyDWqNuAqVahcZSox6GIVKl+5Bp6jLGUYeLpSlGToCYo39NOKMfQTOq6jhn9IBwx+r3Yb/k7D36bNhr/R8NdpDYCVhr9MSwAsBDAPwGwAMzUNwmQIEyGMswljIIyEMAzCYNvwGYhPbEN/EH0dTb1A9ATxAYiu7opOnqI6OKLeBfGOI6qNrWjt45A33BmvwWjuTbwZjKYwmtiMZx1VT8N4Esbj7o7H3B0Pezt/0HF1v8fde4Hc7ZPeOzzy3u7IutUdcrM75KZXXnrlRiDX25BrGz3S6BrvJFd7J/k9kN954rrclvzm15f8+rKf/+znv/bk9avvffN7v/z6v3/9Eii/6NK5y9iouXPmRgy4RtWqMuAKlatMJSo27ELlK085hp6lDKUbeoqSDD1B8Yo1+Bid1HEARw3/sA4A2KfdAHZqG4QtADZqPYQ1EFZBWK6lEBZBmA9hDoRZmg5iiibBGA/jcxCjQIwAMUSDbMSnMD6G0c8TVB8YH9qK7rbifRhdYHSE0R5GOxhvw3gTRiub0RLGa943XvFU9ZKnqhe9czzvqHrW3fH0pwM+bQzkcdvxaK+evR52fzzYrUu3+4HcY0PuAnKHDbndhtzqyLq5yXNNbvL4e4OnreuBXHf/3fdf64nrqhuuveH3LvgrXPC/c59c7uj6zbk/OPcyL46XQvkVlF917tx5XNTs2bMjBl2jakOuUoXKVaZSAy9WofINPE85yjLwDKUr1eCTlWDwZxSrGMM/qWjDP2b4h3XQ8PdpD4BdALZrC4BNADZoLYTVEFYAWOo4WgxggeZCmA1hho2YCmIyiAmOprE2YgyIkSCGgRgMYiCIAbaiv634CERvj7Q93RUfOKK6wugMowOMd2G0hfGWS/xNl/gbMFrAeNVR9bLteMl2NLEdz7s7nnV3PPVRrz6NPe428rj7qOPqYU9YD9qQ+99+8+17gdzdonmLO2zI7Z60bnOx3/LEY0/80TvJjUD+4L3kei+K11531XVX+0T4Sj+h9ftLLrrkigt+csHvPA7/FspvoFwG5dedOnUaHzVr1qyIIdeo2oCrVKFylanUsItVqALDzlOOsg08Q+lKNfhkJRr8GcUZ/GmdNPxoHTP8IzoIYL/h79UuAOFfWyFshrABwjqthrASwjIIiyEshDAPwhwIM23DNBBTQEwEMQ7E5yBGgRgOYiiIQS7tT0EMsBX9bEUfGB+6L7q7L7q5vLt4z+jkmHrPZrSD8Q6MNjBaw3jDO0cLj7nNXeQv246m7o4mtuN5x9UzjqunHFeNfWTSyIX+qJ8xfBjIg46s+4HcC+RuIHcC+ZNj67ZHHnjkFpf7ze6Sm9wlNzi6rr/6iquvsyXX2JKr3SdX+Xjl9568rvA2/zsol0P5bceOHSdGzZw5M2LINapWlSFXqFxlKjXsYhWpwMDzlKtsQ89UhqGnKlmJBn9GcYZ/WqcM/4SOG/4RHQKwH8Be7QawE8A2AFu0EcJ6CGsgrNJyEEtALAIxH8RcELMgTHdHTNUkEONBjHU8jXY8jbAVw0AMthWfwfjEVvS3FX1tRW9b0RNGdxjvw+gMoyOM9jDawXgbRhtHVStH1esu8ha2o7m7o5knq6aOqyaerp5zXD3juHrKI29jT1iNgDwG5GEgDwK5H8i9Pte62y+AuNM9cgeQ23zgeOudt915iy35o7vkRo/Bf/AGf52nrms9Cl/r45WrPXld6W3+9//xb/9xBZQrOnboOClqxvQZEQOvUbVhV6lC5SFDL1Wxigy9QHmGnqtsZRp8hlINPkVJBp+geMOP1SnDP6HjAI4COKwDAPYB2KOdELYD2ApgE4ANWgthNYQVEJbahsUgFkCYZyNmg5gJYpqNmAxiIohxtuJzEKNADAcxxFYMshUDbcUAGP0cUX0cUb1g9IDxgaeprjA6w+gAoz2MtjDedlS9CaOV7WhpO16zHa94GWzmuGrquGriuHrO/fGMJ6ynfLjY2HvI40Aec4c87DOth4Dc7wXxPiD3uEfuuu+u++4Acrstuc2W3Oox+I8u+JtsyQ1A/uCnf6+Hcp0nr2u8OF4N5SooV3Z4r8PkqOnTpkcMu0bVBl2lCpWHDLxUxSoy9ALlK9fgs5Vp8BlKM/gUJRl+guINP1YxAE4qGsBRAId1EMI+CHsA7AKwXVshbIKwAcI6CKu1EsRyEEtALLIN830yOxfELBDTQUwFMQnEBMfTWBCjbcVIWzEMxmBb8RmMT2B87PLu62mqt834EEZ3GN1gdIHRyb3xnqPqXUdVWxf5W7bjTdvRyna0tB2vOa5eAdLMcdXU/dHEhf5cm1ZtnvFzIk8BaQzkcRvyGJBHgDzkYn/AsXWfl8R7HVt3A7nTZ1x/csHf7i651dF1y68u/tUfgdx4wXkX3OjJ6wZPXtdDuQ7KtVCuea/9e1Oipk6dGjHoGlUbdJUqVB4y8FKVqMjQC5Rv6LnKUabBZyjN4FOUZPiJijf8OMOP0UkA0ToG4QiAg9oPYS+EXRB2aBuEzRA2QlgPYY1tWAViuY1YCmIxiAUg5oGYrRkwptmKySAm2opxMMbAGAVjuCNqqK0YBGMgjAE2oz+Mj2D0htETRncY78Po4qjqCOM9F3k72/GO7Xjrw+4ftu7erfsb3s5buD9eBfKK+6MZkKYu9BeAPOfF8BlH1lM2pLFH38e9izwG5BEfyT8M5AFbcr8393u9KN5z43U33uWCv/N3l/3udkfXbS74Wy8878Kb3Sc3Q7nJJX8DlBug/AHK9e3fbT81asqUKRHDrlG1qgy7oq5yAy9ViYoMvUD5yjX4HGUZfqbSDD9VyYafqDMA4nQawCkAJ3QMwlEAh3QAwj4IuyHs1HYQW0BsArEexFqX9WoQK0Asc08sBrHQRswHMcdWzAIxHcQUEJMcUeNtxVgYY2CMdEQNgzEExmfeNT6F8TGMfp6o+rjEe8HoAeMDR1VXR1Vn29HRdrS3He086r5jO9oAae24esNx1cL98ar74xUgzYA0BfICkOeAPOtt/Wkgjd0jTzz20GONHFuPukce9vnWQ0Du9xnXfT5SudcFf7ctudPR9ScX/O1AbvPSeKvH4Vug/NFHLDd97f987UYoN77b7t3pUZMnT44Yeo2qDbxKFSFDL1epSgy+SIUGn6885Rh+ljINP12pAJKVCOCM4iCcBnAKwAkdh3AUwGEAB7Qfwh4IuxxL223DVhCbIWzQOhBrbMNKEMtBLAWxyFYsgDEXxmwQM2zFVBiTHVETbcU4GJ87okbBGGEzhsEY7F1jIIxPYPSH0de90dtR9SGMHrajmw8Ru9qOzu6ODo6r9i7zdo6rt4G0cVy1AvIGkBZAXvXzIa8AaebIagqkCZDnvYs8C+Rpn2s9CeQJj7+NgDxqSx5xbD3k2HrAltzvgr/XY/A9tuQu98mdP/vxz/5kS273OHw7lFuh3ALlZih/bNeu3YyoSRMnRQy8RtWGXaWKkIGXq9TAS1SkQkPPV56h5yhLmYafbvhpSjb8JCUAiAcQqxgAJwFE6xiEwzbhIIT9NmEvgN0AdmqbbdgCYhOE9VoLYhWIFRCW2YjFIBaCmAdiDohZIKaDmGorJoGYYCvGeQMfA2KkzRjumBrimBoEY6DNGGAz+juqPrIZvWF8CKO7945uMLrC6ASjg6er9p6u2jmu3nFctXGht/aE9YaXwpbe1F8F8oo7pJkjqymQF4G8YEOedY88A+Qp90hjII/bkkaOrUeBPGxLHnLBP+gN/n5bcq/75B4X/F225E6fDt/pcfhPUG6HchuUW9u2bTszKvxWCIOuCRlylSpVoXIDL1OJgRerUAWGnqdcg89WpsGnK83wU5Rk+AmGH6/YpYuXxAA4ZQuiIRyDcATAIR2AsA/CbtuwE8J2CFshbLYNG0CsA7EGxEoIy7UExCLH0wIY80DMthUzQEyzFVNsxUQY423FWFsxGsZIGMNgDIExyGZ8ajMGwOgH4yMYvR1VPT1ZdXdUdYPRxd3R2XHVwXa0B9LOdrztuGoDpHXzZs3f8HPrLYG8BqS5I+tlIC950noRyAvukeeAPOtp62kgT9qSxh6BH/f2/pgL/lFH1yMu+IdsyQNeGO+Hcp8tucc7yj1Q7vKOcieUO6Dc0fadtrOjxo8fHzH4GgMPValSFQZfrjKDL1GxCg2/QHmGn6tsAFnKAJDmGEqxBckQEiGcgRAH4TSAUzoB4TiEoxAO6yCIfSD2gNgFYgeIbSC2gNhoI9aDWOueWA1iBYhltmIxjIW2Yj6MObZiJowZMKbCmGQzJsIYB+Nzx9RoGCNsxjCbMdgl/pl74xMfIH7sJbCf7ehjO3rZjp6Oqu62433HVRePu51sRwcg7YG09YT1tg15C0hrIG8AaQnkNSDNgbwMpJn3kaYu9iZAnve09SyQZ2zJU0Aa++DxCRd8I0fXY46uR2zJw+6TB90nD9iS+72j3Ocd5V6X/N1Q7oZy1ztvvzMnatzYcRGDrgkZdJUqVaFyAy9TiaEXq9DgC5Rv+LmGn23wWcow/HSlGn6y4SfqjOIgnAYQA+AkgGgdhXAYwiEI+yHshbAbwk4I2yFssRGbQGwAsQ7EGhArQSwHsdRWLAKxAMQ8ELNBzLQZ071nTIExyWZMgDEWxhgYo2AMhzEUxiD3xkAYn7jIP4bRz3b0sR29bEdP29HddnTzuNvFcdXJ/dHB/dHehd4OyDs+y3rLY++bQFoBed2nvi2AvPrQfQ+9AqSZe+Qlx9aLtuQFIM/bkmeBPG1LnvJp8JMu+Cf8MqJGPut6zJY84uh6+Eff/dFD3lEegvIAlPuh3Aflvrffentu1NjPP48YfE3I4KtUafAVBl+uMsMv9SO/2PCLVKB8ALkAspVl+JlKB5AKIFmJEBIUDyEWQgyEkxCidQzEERCHQBwAsQ/EHhA7QewAsRXEZhAbHU/rYawFscpWrICxzF2xGMZCGPNtxRwYs23FDJf3VBhTHFMT+3/UbzyMsTBGO6pGesQdDmOIo2qQo2qgx9wBtqM/jL7ujj62o5fLvIft6O6F8H3HVRcgnYB08PF7eyDtgLwD5C0gb9qQVj7Teh1IC/fIa0Ca+wT4ZSAvedpq6mmriRfFF1zuzzm2nrElTzu6nnJ0NfZu8oQtaeToegzKo1AegfIwkAe/+q9ffRDKA2+1eWt+1JjRYyIGX2PYoSpVGnqFyg29TKUqNvgiFRh+vsHnKUfZhp9p+OlKBZACIEkJAOIBxOk0hFMQTkA4DuEohMMQDkLYD2EvhF3aCWKbjdgCYhOIDSDW2Yo1IFaCWG4rloJYbCsW2Ip5MObAmAVjus2Y6s6YBGMCjPE243NH1WgYI2AMsx1DbMcg2zHQUTXAdvS3HX0dV31sRy/HVU/HVXfHVTcXeldPWJ08YXUA0h5IOyDvAHkbSBsgrYG84R5pCeQ1x9arjq1XPG297HJ/yeX+osu9iS153pY85+h61tH1tKPrSU9djR1dT7hPHvfk1cg7ymNQHoXyCJSH27zZZkHU6FGjI4ZdEzLwKlUadkVdZb4tNfgSQy9SofINP085hp9t+JnKMPw0pQBIApCoMxDiIJyGcEonQUSDOAbiCIRDEPbbhn0gdoPYCWG7toLYbCs2glgPYq2tWAVjha1YBmMJiEWOqPku77kwZsOYCWO6d40pNmOSzZgAY5x7YwyMUTBGwBhmO4bYjkEwPoUxwHb0tx19HVd9bEcvF3pPx1V3IN2AdPXhYmdv6h194vsekHeBtAXyNpA2QN50j7QC8jqQlo6t1xxbzd0lrzi2mgFp6mXxRVvSxFPXC14Yn/Mo/AyUp23JU1CedMk3hvIElMehNILSqE3rNgujRo0cFTH0mpCBV6nSwCvqKjP4UpUYfJEKDb5AeYafo2zDzzL8DKUBSFUygCQAZwDEKxZCDISTEKIhHINwBMIh23BA+yHsgbDLRuwAsQ3EFhCbQGywFetArLEVq0AstxVLYSx2RC2EMd9WzPU0NctmzIAxzZ0xBcYkGONhjIUxBsYoGCMcVcMcVUPcHYNgfApjgO3obzv6Oq4+clz1cqH3dKF398jbDUhXIF3cIR3dIR2AtAfSDsg7QN4C0saHja19tvWGY+t1IC0cW6/akuaOrZdtSTNb8tLF51/c1FNXE0fX8+6T54E865J/FsrTUJ6C8iSUJ6E0frP1m4ujRgwfETH0mpChV6nS0CvqKvNtqeGXGH6RCg2/QPmGn6scAFnKgJAOIFXJEJIgJECIVyyI0yBOgTgB4bhtOAriMIiDIPaD2AtiN4idILaD2GorNsPYaCvWw1gLYrWtWAljua1YAmORzVgAYx6MOTZjFowZMKa6Nya7NyZ6qhrvqBrrqBpjO0bZjuG2YyiQwe6Oz2zHp7ZjgOOqP5C+7o8+QHoB6QmkO5BuNuR9G9IFSCcgHYC09/Mj7YC0dY+8DaSNY+tNx1Yrx9YbtqSlu6SF95JXfRrc3Ja84uhq5uh6yZa86D5pAuUFKC9Aec47yrNQnoHyDJSnW7dqvSRq+LDhEUOvCRl6lSoNvSJk6OUqVYnBF6vQ8AuUb/i5hp+jLACZhp+uVAApAJKUCOEMhDgIpyHEQDgJIRrCMR2BcEgHIOyDsAfCLhuxA8R2EFtsxWYQG0CssxVrQKwCscIRtQzEYhCLbMYCd8ZcGHNsxkybMR3GNBiTYUyEMR7GWBhjYIyyHSNsxzDbMcR2DHJcDXRcfeK4+tj90c/98ZGfD+nts6wPvRj2sCEfeOx9H0hXIJ1tSEcg7wFp72JvB6StY+ttIG1syZtAWtmSNxxbLW1JCxf8ay745p66XoHysvukGZCmLvmmLvkXoTSB8jyU56E81+qNVsuihg4dGjH0mpChV6kyZPAVKjf8UpUYfrHhF6pA+QByAeQoC0CmMiCkQUiBkKxEEGdAxIOIhRBjG05CiNZxEEdBHNZBEPu1F8RuEDttxXYY22BssRUbYayHsRbGai99K4Esh7HUZiyGsRDGfJsxF8ZsGDMdVdMdVVMdVZMcVRNc5OOAjLUdo23HSNsx3HYMtR2DHVeDgHwK5BMgHwPpZ0M+8tFJbxvyoQ3pCaS7z7S62ZCuHn07+6ndTu6RDu6R9kDe9bTV1iPwO46tt9wlbWxJa1vSypa8YUtaOrpaOLpedXS96j55BcjLLvlmUF6C8hKUF6G8CKXJG6+/sTxqyOAhEQOvCRl2tSoNPFShckMvU4mhF6vI4AuVb/h5yjX8bMPPUgaANACpAJKVBCEBQLwjKQ7CaZ2CcMJGREM4ZiOOgDgE4gCIfRD22IhdIHaC2A5iK4jNnqI2glgPYi2I1TZjpSNqOYylNmMxjIUw5tuMuTBmwZgJY7rtmApjMowJtmO87RhrO8bYjlG2Y4TjahiMIY6rQY6rgZ6wPnn8kcc/tiH9bUhfG9IHSC8b0tOG9ADygQ1534Z0BdLZPdIJSAcg7YG8a0vaudzfcZe8DaQNkDdtSWtHVysor9uSlo6uFlBec3S9CqW5t/lXoLwMpRmUZq+3fH1l1OBBgyOGX2PwoWqDr6yrwvDLVWb4pSoGUKRCAAXKg5ALIVtZEDIgpCsVRAqIJAiJEM4oDkQsiBgQJ0FEgzgO4qiNOAzjIIz9MPaC2O3i3uWu2AFjG4wtMDbB2ABjHYw1MFbBWAFjmUt8ic1YBGMBjHmOqjkwZtmOGR5zpwGZYjsm2Y4JtmOc7RhrO8bYjlFARgAZZjuGABnk/hgI5BMfLg4A0h9IXxvSx4b0AvKhDenhYu/uHukGpKt7pItjq5Njq6M39/dsSXtb8q4taetl8W0ob9mSNp663nR0tYbyBpTX/RxKSygtXPItoLwKpTmU5lBegbIq6rOBn0UMvCZk4NWqNPBQhcoNvkylBl9s8EUqVIHh5ykXQA6ALACZSgeQBiAFQLISISRAiIcQCyEGwimdgHAcwlEbcQTEIRAHQOwDsRfEbvfFThjbQWx1RG2GsdERtR7GWhCrbcYqm7ECxjIYi2EsgrHAZsxzb8yBMct2zLAd02BMsR2TbMcE2zHOZT7W4+4Yx9UoICMcV8OADHVcDQbyGZBPvakPsCEfA+kH5CMgfYD0AtITSA8gH3ja6gakqy3pAqSTLekI5D13SXt3ybseg9vZkrbuk7dd8G85utq4T96E0hpKKyhvQHkdSMsQlBYtW7RcHTXw04ERQ68JGXy1qgy9UhWGXq4ylRp+ieEXqdDwCww/LwQgR9kAMgFkAEhTKoRkCEkAEmzCGQhxOg0iBsRJENGOpmMQjkI4DOEghP02Yh+IPSB2gdgBYhuILbZiM4yNtmI9jLUu8NUwVsFYYSuWtmrZegmMhTAW2Ix5NmMOjFkwZsCYZjum2o7JtmMijPEwxtqOMS700bZjpONquPtjqA8XhwAZBGSgI+sTIAOA9AfSD8hHQHq7R3oB6QmkB5APHFvdgHR1bHUB0tnR1clHKh1syXu2pL2j610obW3JO46ut90nbzm62rhP3oTSGkirEJQ3WrzWYm3UJwM+iRh6Tcjgq1Vl8JWqMPxylakUQImKARQCKFA+hDwAOcqGkAUhQ+kgUkGkQEiCkKgzIOJBxNqIGBtxCsYJGMdhHIVxBMQhHQCxX3th7IaxE8YOW7ENxhZbsUkbYKyDscZmrLIZKx1Ty4EstRmLbcZCIAuAzHNUzQEyC8YM2zHNdkwBMgnIRNsx3naMBfI5kNFARgIZDmQYkCFABgH5DMinQAYA6e9Jqx+QvkD6uEd6e/z9EEgPW9LdsfWBLXkfSFdb0sWWdLYlHW1JB0fXe7bkXVvyri1pB6UtlHegvA3lLSBtQlDebPFqi3VRAz4eEDHsmpCBV6vKwCvrKjf4MpUafInBF6vI4AuVb/h5ygWQAyBLmQDSAaQBSFEyhEQICRDOQIiDcBpCjI04CSHaRhyHcNQ9cRjEIRAHQOwDsQfEbluxE8R2EFtBbHaBb7IZG2CsA7HGZqyCsRLGcpf4UhiLYSyEscBRNQ/GHBizYMxwmU+3HVNtx2QvhBMdVxMcV+McV5+7P8a4P0b5LGsEkOFAhgIZDGQQkIFAPgUyAEh/IP2A9HWP9AHS25Z86BG4py3pcfH5P//AlnSzJe/bkq62pIunrs5QOkLpAOU9R1d7KO2hvOvDyHZA2uodKO+81vy1DVH9+/WPGHpNyOCrVWXwlXVVGH6ZSg2/xPCLVWT4hYafHwKQqxwAWQAyHUkZENIhpEJIgZCkRBBnQMSBiAURA+IUiBMgokEcczQd0WEQB7UfxF5H1B4Yu0DssBXbYWy1FZthbISxwTG1DsYaGKtgrISxHMZSGIthLHRULXCRz4Mxx3bMhjHDdky3HVNtx2TbMcl2TAAy3naMdX+MATIayEggwz32DgMyBMggIJ950hroYv8EyAAg/W1JPyAfObb6AOltS3q53Hvakh5AutuSD2xJN0fX+46uLlA625JOQDq6Tzr69cMdoLwHpH0IyruvNn91Y1S/vv0ihl4TMvhqVRl8ZV0VAMpVBqDE8ItVpEIIBRDylQchB0I2hCxlQEiHkAYhBUKyEkEkgIgHEQfiNIhTNuIkiBO24jiIo7biMIxDMA7Yin0w9sLYDWMnjB0wtsHYAmMTjI2OqfUw1ro3VgNZ5d5Y4ahaBmOp7VhsOxYCWWA75gGZ491jlu2YaTum246pQKYAmQRkApDxPlwc68XwcyCjb77hllFARgAZBmQokMFABrlHBgL5FMgnXhI/dmz1tyX9gHzk2OpjS3rbkl5QetqSHraku6eu7kC62ZL3bUlXIF1CUDpD6QSkYwhKh+avNN8U5X+gJWLoNYYeqlaVoVeGDL5C5SqzAaUqAVDsBa7I8AuUDyAPQK6yIWQByASQrjQIqRCSISRBSIRwBkIchFgIMRBOQTgBIdpGHANxFMRhEAdBHHBE7QOxF8RuR9QuGDtAbLMZW0BsArHRZqy3GWthrIGxCsZKGMthLIWxGMZC27HAdswDMhfIbBgzYcxwXE0DMhXIZNsxEcgE7yHjbMhYIGOAjAYyEshwIMOADHWxDwYyCMhnQAYC+cSWDPAI3N+W9APS113yEZA+tqS3Lenl6PoQSg8o3aF88K2vfVvf6gblfShdgXQJQenc/OXmW6L69O4T8aO9xsBrDLzaj/gqVRp8paFXqNzgy1Rq8CUqNvwiwy8IGX6e4ecqB0BWCEIGhHQIqRBSlAwiEUKC4kHEgTgNIgbESRAnQBwHcQzEEVtxGMRBEAdA7LMVe0DsshU7YWyHsc1WbIGxyTG1EcR6rYOxBsYqGCthLIex1HYsgbEIxgLbMR/IXJf5HBizYMx0XE0HMtV2THF/TAYyEcgET1njgIwFMgbIaCAjbchwIMOBDAUyBMggl/tntmSgLfnUlnxy/k/O/9iW9IfSz5b0Ped7P/4ISh9PXb2h9ILyIZCeISg9oHQH8kEISrdXmr2yLap3r94Rg48Yeo2qVWXwoUrDr1C5ygCUAihRsYogFAIoUD6EPAg5ygaRBSETQrrSbEQKiGQQSSASQJwBEQ8iFsRpEKdAnAQRbSuOwzgK4wiMQ7bioPbD2AtjD4xdNmMnjO0wtmoLjE3ujY0w1sNY66lqDZBVQFb6dVjL3R1L3R2LgSyyHQttx3wgc4HMcVzNAjITyHQg07ypTwEyGchEIBOAjAMyFsgYGzIayiggI9wjw4EMAzLUhgwGMgjIZ7ZkIJBP3SWfAPnYlvR3dPV3n/QD8hGQPu6T3kB6A+nlyetDL449v/IvX+kBpLaXm728Pcr/wkHE0COGXqNqA6+qq9LgK1Ru8GUqNfwSFRt+keEXqgBAvvIA5ALIBpClTAgZENIhpEJIgZCsRBAJIM6AiAMRCyIGxCkQJ0BE24pjII6COAziEIgDIPbbjL2OqN0gdjmmdoLYbjO2wdgCYxOMjT4iWW8z1jqq1sBYZTtWwlhhO5bZjiUwFnu6Wmg7FsCY57ia67iabTtmAZnpo5PpQKYCmeIpaxKQiUAmABkHZKwnrc+BjHGxjwIy0oaMgDLcsTXUxylDHFuDoQyyJZ9BGQjkU1vyCZQBUD6G0h9IP09dfaF8BOUjKH2g9AbSK/TySy/viOrZo2fEwCOGXaNqVRl6qNLQK1QeMvjSkOGXGH6xigy/0PDzQwBylQMhG0IWgAylQ0iDkAohGUIShEQlQIiHEAvhNIQYx9NJECdAHAdxDMRREIdtxUEYB0DstxV7YeyBscvT1E4Y22FssxlbYGxyTG2EsR7GOhhrYKy2HatsxwoYy23HUtuxGMYi27HQdswHMs92zHF/zAYyy5v6DCDTPfZOBTIFyGRH1kQgE4CMBzLWlnzuHhkDZDSQUZ62RgAZDmQYkKHukiFABgMZBOQzR9dAKJ9C+QTKACgDoHwMpT+UflD6AqmtWdNmu6LcHRFDjxh4japVZfChSlUYfqgcQJlKAZQYfrGKABSqAEI+gDzlQMiBkAUhUxkg0iCk2YYUEMlKhJEA4oziQMQqBsYpECcVDeI4iGO24giMwzAOwjhgK/bB2AtjD4xdMHbA2O6Y2gpkC4xNjqqNMDbAWAdjre1YDWOV7VgBZDmQpbZjCZBFtmMhkAVA5gGZC2QOkFlAZnrsnQ5kGpCpQKYAmQRkog2ZAGScLRkH5HPH1hjH1mggoxxbI4GMsCXDoQyDMtQFPwTKYI/Cgxxdn0EZCGUgkE/dJ59AGQDlYyC1vdT0pd1RH3T7IGLoEQOvUbWhV9VV6dtKw69QueGXGX6pSgy/WEUACgEUKB9AHoBc5UDIhpAFIEPpENJsRCqEZBuRBCERQoKNiIcQp1hbEQPiFIgTigZxHMRRW3EExmEYB2EcALHPfbEXxm4Yu2zGThjbYWyzHVtgbHZUbYKxwXasB7IWxmrH1SrbsRLICtuxDMhSx9ViIIscVwuAzAcyD8hcGzIbyCwgM4FMBzINyFQgk4FMBjLRPTIBynjH1jhbMhbK57ZkDJDR7pJRQEbakhFQhtuSYbZkKJQhQAaHoAyC8hmUz6AMBPJp6KUXX9ob5XejRgw8VGPg1aoy8PoqDb5C5QZfZvClKgkZfpHhhwoAFBh+vnIB5ADIVhaETAgZENKV9lKTZikgkiEkQUi0EWdAxEOIsxGxIGJAnAJxAkQ0iOMgjtqKIzAOews/6L44YCv2w9gLYw+IXTZjJ4wdNmMbjK0wNtuMTTA22oz1MNbBWANjNYxVMFbAWG47lsFYAmOx+2MRjAU2ZL77Yx6QuS712UBmAZnpyJoBZDqQqUCmXPjTiyYDmQRkIpAJQMbbknFAxtqSz4GMATLaloyCMgrKSFsyAshwR9cwKMOgDIUyBMpgILU1bdJ0X5TfjRqBEDH4GlUbfqgqZPiVqgBQrjIApSEIJQCKVQShEECB8iHkQchVDoRs25CpDBDpINJApIJIAZEMIvH5p59LgHEGRjyMWBinYcTAOAnjBIxoGMdgHIVxBMYhGAdhHICxD8ZeGHtsxi4gO2HssBnbgGy1GZuBbAKy0VG1Hsg6IGuBrIaxynasBLLCE9YyIEuBLAGyyIYsBLIAyHwg84DMATIbyCwgM90jM2zIdCDTHFtToUxxbE2CMtGWTIAy3paMgzIWyFggn2uMLRkNZRSUUUBGagSUEVCGQxkGZGjoxSYvHojq0qlLxMAjhl2j6pChV9VVafAVKjf8spDhl6oEQLHhF6kQQIHyAeQByAWQo2wIWRAyIWQoHUQahBQIyRCSICRCSIAQrzgIsToNIsYRdRLECUdUNIhjII46oo7AOAzjIIwDMPbbjL0w9sDYBWOX7dgBYzuMrTC2wNgMY6O7Y4PtWA9k3fVXXbcGxmobsspxtRLIciDLbMhSIEuALAayEMgCIPOBzAMy14bMATLbPTITyEwg04FMAzLVlkwBMsWWTIYyyZZMhDLBXTLeloyDMhbK51A+BzImBGS0RkEZCaS2F1948WBUp46dIoYeMfAaVYcMvaquSsOvMPhQucoMv9TwS1QcMvwiFaoAQL7yAOQqB0I2hCwImRAylAYiFUQKhGTbkAQhEcIZCPGKc1fEgjhtK2JgnIJxAkQ0iOMgjoI4YisOwzgI4wCI/SD22Yy9MHbD2OWo2gljO4xtMLbaji1ANtmOjTA2wFhvO9YCWQNjte1YBWSl+2MFkGVeDJcCWQJksXtkEZCFQBYAmedJay6QOUBmO7ZmA5kJZAaQ6UCmAZlqS6YCmWJDJkOZBGUSkAlAJji6xgMZFwIyNgTlcyBjQk2eb3I4yu+xixh8xMBrVB0y+KqQoVeqImQDylVm+KUhW1CiYghFAApVACEfQh6EXOVAyIaQpUwQGSDSQaSBSFUKhCQlOp4SbMUZEPEg4kDE2ooYGKdgnIRxAkY0jGMwjsI4YjMOAzkI5ACM/TD2wdhrO3YD2QVjJ4wdMLbZjq1AtgDZDGQTjA22Yz2QdUDW2o41QFYDWQlkBZDlMJbZkKVAlgBZDGSRDVng2FoAZT6QebZkLpDZjq3ZUGYBmQlkhi2ZDmRaCMpUWzIFymQok6FMAjIxBGRC6Cv/8tXxQMaFoByJ8tu5IoYdqjHsUPWLzzetMvBQpaGHKgy9XGUGHyo1/BIVG35RCECh4RcoH0AegFwAOcoGkKVMG5EBId02pEFIhZACIUmJIBJAnAERDyIORCyI0yBiQJwEcQJENIjjII7ZjCMwDsM4BOMgjAM2Yx+MvTD2wNgNYxeMnTC2w9hmO7YC2QJjM4yNtmMjkPUw1jmu1gJZYztWA1kFZKX7YwWQ5UCWAVkKY4kNWQxkEZCFQBYAmQ9kHpC5mgNkti2ZDWQWkJm2ZAaUGVCmA5mmqUBqAzLFxyuTbcokILW98NwLR6P8dq6I4UcMvqauasMPVRl+ZV0VAMoNP1QGoFQlAELFEIpUCKIAQr7yIORCyAmByLYNWSAyHE3pMNJBpIJIAZEMIkmJMBJgnIERDyMORiyM0zBOwTgJ4wSMaBjHYRyDcRTGYRiHYByEcQDGfhj7YOyBsRvGLhg7YeywHduBbAOyBchm27EJyEYgG4CsB7IOyFoga4CsBrIKyEpH1gogy4EsA7IUyBLH1mIoi4AsdGwtADLflswHMk9zgcwBMhtIaBaUmUBmhIBMBxKaBmUqlKlApoSef+7541Hvtn03YuARw66pq9q31YZeFTL0SlWo3ODLDb5MpSHDLzH8YhUZfmEIQIFNyFcehFwAOcqGkAUhE0KG0iGkQUiFkAIhWUkQEiEk6AyIeBBxIGJBnAYRA+LkbTfdegJEtCPqOIxjMI7COALjMIxDMA56qjoAZB+MvdoDYzeMXTB2wthhO7YD2QZkK4wtjqtNQDYB2QhkgyNrPZC1QNbYkDVAVgFZCWQFkBVAlgNZZkuWQlkCZDGQRbZkEZCFtmQBlPlQ5gOZB2Suo2sOkDmeuGaHgMwKQZkJZSaQGaHnn30+OspvUokYeMTAa+qq9m21oVeFDL5SFSHDLzf4spDhl6rE8Itre+ixIhUCKACQH4KQp1wIORCyIWQpE0QGhHTbkAYiVSkgkkEkgUgEkQDiDIh4EHGKtRWnYcTAOAXjJIxoGNEwjsE4CuMIjMMwDtmOgzAOwNivfTD2wtgDYzeMXTB22o4dQLYD2QZkC4zNMDbbkE1ANgJZb0PWA1kHZC2QNUBWA1kFZCWQlUBW2JLlQJYBWRqCsgTIYiCLtBDKQigLgMwPAZkXAjI3BGSOZgOp7blnnjsZ5TepRAw8YuA1dVX7ttrgq0IGX1nbw40qVA6g3BFUZvildZUAKDb8IsMvrKsAQj6APAC5IQg5ELJCEDIhZEBIVxqIVBApIJKVBCMRRAKIMyDiQcSBiAVxGkQMiFM6CeMEiGgQx0Ec01EYRxxVh2EcgnEQxgEY+2Hsg7EXxh4Yu2HsgrHTduwAsh3INiBbgWwBstmFvgnIRiAbgKwHsg7IOiBrgawBshrIKluyCspKICtsyHIgy0JAlgJZAmSJLVkMZFEIyMIQkAUhIPNDQOaFoJyK8vshIoYeMeyauqp9W+1HfajK4CtDBl+h8hCAMsMvDRl+SV3FEIoAFAIoqCsfQh6EXAg5ALJDELKUCSIDQjqENKWCSAGRDCIJRCKIRBBnFA8jDkQsiFhbcRpGDIxTIE5cc8XVJ0BEgzjumDoG4yiMIzAOwzgE46AOwNgPYx+MvTD2wNgNYxeMnTB2wNjuuNoGZCuQrUC2ANkMZBOQjUA2AFkPY10IyFoga4CsBrIqBGQlkJVAVgBZHoKyDMhSd8lSIEtghBaHgCwKAVkYevbpZ2Oi/H6IiKFHDLumrmrfVht8qMrgK0MGX1FXueGHygCUGn5JXcUAigCECiEUKB9CPoA85ULIgZAdgpAFIRNChtJBpIFIBZGiZBBJIJJAJIJI0BkY8TDiYMTCOG0rYmCcgnESxgkY0ToO5BiQoyCO2IzDMA7BOATjoA4A2Q9kH5C9QPYA2Q1kF5CdMHbC2KHtMLZpK5AtQLYA2WxDNgHZCGQDkA1A1juy1gFZG4KyBspqGKtCQFaGoKyAsgLKchihZe6TZUCWhoAsCUGJjXqz1ZsRQ48YeE1d1b6tzeCrQoZfafAVdZX7thxAWQhAqeGXqDgEoQhAYQhCAYB85UEI5YLIgZANISsEIhNChtJBpIFIBZECIRlCUghEohJgnIERDyMORiyM0zBiQJwCEToJ44TtiAZyHMgxIEeBHIFxGMYhGIdgHIRxAMZ+GPtg7LUde4DshrErZEN2AtkBZDuMbSEgW4FsAbL5R9/54WYgm4BshBHaAGQ9kHW2ZB2QtSEga0JAVgNZFQKyMgRlJZAVISDLQ8889UxcVOs3WkcMPWLQNXVV+7Y2Q68KGXylgYcqQgZfrrKQ4ZcafqjE8IvrKgJQCKAAQCgfQB6AUC6AHGVDyIKQBSFTGSDSIaQpFUIqhBQlg0gCkQgiAUQCiDMg4hUHIhbEaRAxIE6BOKkTME7AiIZxHMYxGEdhHIFxBMZhGId0EMgBIPuB7IexD8ZeGHtg7LYdu2Hs0k4gO4DsALLdhmwDshVIaAuQzUA2A9kEZGMIyAYY60O2ZD2UdUDWhoCsCUFZA2R1CMiqEJT4qFavt4oYesSwa+qqNuz6qnxdZfCVIYOvCBl8eV1lhl8aAlASAlCsIgihQggFAEL5EPIg5IYg5CgbRFYIRCaIDAjpENJCIFJBpCgZRhKMRBAJIRhnYMTDiIMRCyJ0GkYMjFMwTsIInQASDeQ4kGNAjsI4AuOIp6vDQA75efWDQA4AOQBkP5B9QPaGgOwBshvILiC7gOwEsiMEZDuQbSEgW0NAtgDZHAKyKQRkI4wN9QFZH4KyDkhtQNaGnn7y6YSo11u8HjHwiGGHakIGXt2gKl9XGXyloYcqQgZfXleZ4ZeGAJQYfqgYQFEIQKEKABQYfr7yAOQCyAWQo+wQhCxlgsiAkHHV5Vemg0gDkQohBUIKhGQlgUgEkQAhdAZEPIg4ELEQTodAxIA4BeIkiNAJGNEwjoM4ZjNCR2EcgXEExmEdAnIQxkEYB2Dsh7EPRmgvkD0wQruB7IKxy4bshLEjBGQ7jNA227E1BCS0BcjmEIxN9cHYGIKxoT4oiVEtX2sZMfCIQYdqQoZd3aAqX1cZemXI4CtCBl8eMviyukoNP1QCoNjwQ0UAQoUqAJEfgpAHIBdAKAdCNoBQFoRMCKGMKy77XTqMNBCpIEIpMJJBJINIUiKMBBgJIM4oHkYcjFgYodMwYmCcCgE5CeQEjGgY0TCO6xiMYzCOwjgCI3QYyCEgB0NADgDZDyO0D8beEJA9MEK7gYR2AdkZArIjBGR7CMi2EJCt9QHZEgKyub6nGj+VFOXXrkYMuzbDrgkZdnWDqnxdZfCVIUMPVRh8qNzgQ2UqDRl+Scjwiw2/KASgMASgAEB+XXkQQrkgciBkhyBkQQhlQsiAkA4hlAYhVSkgQskwkkCEEmEkwDgDIhQPIw5EHIhYnYYR45iKgXEKxEmdgHECRnQIyHEYx2AcDcE4AiN0GMghGIdsx0EYoQNA9sMI7QsB2Qtjj+NqD4zQbhi76gOyMwRkR31AtoeAbKsPSkqUXyYZMezaDLumPgOvrqvKt7UZemXI0CtCBl8eMviyukoNP1QSglCsIgihQgCFAAqUDyAfQF5duRByQiCylQUjC0SmMkBkQEiHkBaCkAohJQQiWUkgEkEkgkgIgTgDIl5xNiMORqxOwzgNIwbEqRCMkzoB5ASM6BCQ4zCOwTgK4yiMIyEYh0NADoVgHNQBIAeA7AdSG5B92gukNhh7QjB21+c+2QWkNiA763vyiSdTo/yKvIhB12bQNQ2qvu6q6+u6rsrwQ5WGX5uhV9RVbvDlhl4WMvjSukp8WwKgOAShSIUQQgUAQvkA8gCEcgGEciBkh0BkKRNEKANGBoh0pYFIBRFKgZECIllJMEKJMBJgJIA4o3gYoTggcTBidRrGaRgxIE6BCJ2EcQJGKBpI6DiQ4zCOhWAc1REYocMwaoNxSAdh1AbjQF37gdQGYl9de2F8EZA99UFJi/Ir8iKGHTHoUE19Bl7doCpfVxl+qDIEoCJk8OUhgw+VGXyoNGT4JXUVAwgVQQgVQigAEMoHEMoDkGv4oRwAoWwAoSwImSEIGUoHkQ4hTakQQikgUkAkKwlEKBFEIogEnYEQigcRF4IRG4JxGkYoBkboFIyTMEInYISiYYSOwzgWsiHHgByFEToSAnI4BORQCEbooA05CORAfVD21wdkX32NH2+cHuUXf0UMuTZDrmmYYVc3qMrXVQZfWZ/BV4QMvjxk6GX1GXxpyPBLQoZfXFcRgFBhCEQBhPwQhLwQhNwQhJwQhGwIWSEImSEIGSEQ6RDSQhBSIaSEICSHbERSCEYiiIQQiDMhGPEhGHEgQrEwTodgxIRgnArBOBkCcSIEI7o+GMdDMI6FYBytD8iREJTDQGqDcahhQA7WByUzyi/+ihhybQZc0zCDrq7PsKsaVOnrUIXB12bw5XWVGX5thl4aMviSkMEX11Vk+KHCEICCEID8EIS8EIRc5UCoDUK2skBkQcgMgcgIgUhXGohQKohQCowUEMkhEEkhEIkhGAkhGGcUD6M2GHEgYiGETtuK2mDEhGCcquskjNpgnAjBiK4PxvH6YByrD8jRhgE5Uh+UrKimLzaNGHxthlzTMMOurs/Aq86q0vcrDb8iZPihcsMPlYUAhEoNPlRi8KFigw8VhQy/sD4ABXXlQwjlQQjlggjlgMjxFJUNIgtCKBNCbRAyQiDSlQYilAoilAIilAwilAQilAiiNhgJMM6EYMSHYITiYIRiYYROg6gvBkboVAjIyRCM0In6gETXB+R4w4Acq++JRk9kR/nVExHDrc1waxpmyDWqrs+gqxpU6evaDL6iPsMvDxl+WX2GXxoy/JL6DL84ZPBFIYMPFRp8qMDwQ/mGH8oLAcitKwdCKBtCKAtCbRAylQGhNgjpSoNQG4TUEIQUCKFkCKGkEIjEEIiE+mCcCcGIDwGJqw9EbH0wTodAnHZcxdQH41R9ME6eHZAT9UHJifIT9RFDr82Aaxpm0DWqrs+wqxpm6JUNqvB1heGHykMAQmUhAKUhAKGSEITiEIRQEYRQIYBQQQhCfghAKA9AKPcnPwz9JAdAKDsEISsEIZQJIZQBIZQegpEWghFKBRFKARFKDsFICoEIJYZgJIRghM6EYITiQzBCcSEocUBi6wNyuj4gpxXTMCCn6gs/jR7lJ+ojBl2bodacneFWN8yAqxpm0JUNqvB1bYZeXp/Bl4UMvvSLfnJBCYDaDL+4PgBFIQCF9UEoCEHIDwEI5YUg5IYg5IQgZIcAZNUHITMEIaM+EOkhCGn1gUitD0RKfTCSQyCS6gORWB+IhBCMBBBnGgYjvmEw4s4OSGx9jz/2eF6UnxOOGPIXGWjN2Rlu9VlVGfIXGXRlgyp8XWHYofKGGXxZXaUG/0WGXxIy+OIGFQEIFRp+fQUAagOQXx+EvBCE3Pog5NSVDaI2CFl1ZYKoLwNEbRDSG5QGojYQqQ1KgVEbiGQQXwQjqUGJMP4sGAlnB+NMw6AURPnpx4iBf5Fh13xJ1Qb95/3kgioD/yLDrqzPwCvOqtz36ysDUBuA0gaVAKgNQnF9AIrqg1BYVwGE+vJB1JcHor5cELWByKkPRnZdWSDqy4TxRSAy6kqH8UUg0kB8EZDU+mCkNAxIcsNgJH1ZQBIb1ujRRgVRfqYrcuF5F9Rm8BGDrvF085ede361oX+RIVerqmEGXdkwA69omIGXN6jM12WGHyoNGX59Jb4uARAqBlBfEYD6Cn1dCCFUYPj15fs6H0J9eRBCubV9/Tu5MHJCIOrLhlBfFojaIGTWByOjPhDpDYOR1jAYaUptGJCULwtIcsOgFEb5SZWIYX+RIdd8WYZdfXYGXq2qhhl0ZcMMu6I+g65QeX0GXq6yBpUCaFiJ75cYfqi4PghF9QEoUmEIRKigPgj59UHIVx6I+nJB1AYgpz4IOcquD0S2suqDkdkwGBkNA5Gh9LMDknZ2MNKU2jAoxVE+v48Y6p9lqDV/pWp/vtqQG1bl+1UG3bBK36807IZV+H6FIddX7utygw6V1WfYZSqtz7BLVVKfgZeouD5DL1ZRyNBDhfUBKFRBfQAKlF8fiHzlhSDUl+vrXAj15fg6B0TDsn0/G0bDsnw/C0bDMn0/E8aXlQHjL/KLWIqjfFQcMdQ/y0Br/laGW312Blx1dgZdeXaGXXF2Bl5+doZe1jBDL22YwZc0zOCLG2bwRQ0z+MKGGXzB2Rl+/tkZft7ZGX7u2Rl+ztnByP5bQck6u8ceeaw0yqeSEQP+iwy45m9l2NVfloFXfUmVhv4XGXrF2Rl8+VmVGf7ZlQL4swCUnFUxhLMrAvFnQSg8OwgFX1I+iL8IRN6XBSP3bwUj58v6T5THn4wY7pdVY7h/M4Ou/htVff+b36sy9LOrNPSzqzD4L6vc8P8iwy87OwClZweg5EsqhvAXQSj6kgpBfFkFIP5a+TD+ZjDy/lpQyqJ8ABYx/C/NwGv+XoZe/dcy/GpVnR2AKlWeHYBKVZwdgAqVnx2EcpU1DEKZSs8ORKlKzg5EiYrPDkaxis4ORpEK/1pACv5eQPL/Wo8+/Gh5lNf6iKH91Qyu5h/NMKv/VoZa9fcy4Mq/lkFX/LUMu/yvZeBlfy1DL/17ASj5W0Eo/kcCUayivxWUiii/XjhikH83w6z5r2Sw1f9Ihlz19zLsyr+XoVf8vQy//O9l+GX/SBBK/yuBKPlHglIZ5bk4Yth/NwOu+e9k4NX/aAZf9Y9k+JX/SAAq/pEglP+jgSj77wSk9B/pP1H84u5vfOWb+sZ/pRrD+59Ubaj/naoM+b9apYH/d6ow/P9J5RD+y/kdDVVRbvuIAf+3Mtia/40MukbV/5MMvup/EoDK/61gVPx3e+ShR6qjrEvEMP7XM6Caf2YGWv3PysCrVfX/RlBqovyfiOH9UzO8iGr+b+7fo75SUzf8APBP6wsUf9PIP6+v/BP/Xv/Mf67/nb9XWJLa3zT0yIOP/P/9XzKD4PH/ABYzZXBSXEBtAAAAAElFTkSuQmCC)",
                height:'101px',
                left:'47px',
                top:'47px',
                width:'101px'
            },
            ADVWHEEL:{
                background: xui.browser.ie6?null:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMMAAADDCAYAAAA/f6WqAAAAB3RJTUUH1gcOCDIojJpTggAALYlJREFUeNrtnXmYHUW58H9V1WdmMtlDQtijSSDKorLovRAWAwqyiBJugoCK6CfqRdSLityLkIsiF9SIyqIsRhZBlu+TK0JEQBBFUEAEZQ9LgkCABBPIJJnMdFd9f5wzM2d6qrqr+/SZmUy6nqef06e6z9Ld76/epd6qgrKUpSxlKUtZylKWspSlLGVxF1HeguKLAQmTp0JlOuitQU+BaHJ105NBj4JoDEQKolYwoxAmQtKBxKBYi6ITxWokK1GsQPI6ilcQLEWxjBfpFGDKu13CMBwEXsA2bTB+BzA7Qbgz6B0hmgl6GugxEAG6tkX0va/fr70XBhQgqb72bLb3kgjFy0ieQ/EUiscQPErAo/yNlaL6pWUpYWia8Cv4l21BzwYzG6K9IHo7mBarcPcTfG0BwROGNED67xsUy5E8gOSPBNyD5mH+VGqREoaGhX+/KSD3h+j9EL231uILt+AnaYACYcgCiKADxZ+R3IHgNlp4jFvpKuEoYUgBYL8A2mYB80AfDGZXiCp+gu8CwXY8AYaigHABInkJyW+R3Mga7uBu1pZglDDUAJinIJoOZh5ER0L0LjDSLsjaQ9BThN5VlwZDEUD0hwIkK1DcguQ61vN7cTPrShg2Sef3Q+Nh1GGgPwF6X9CV/K2/zghCThgaAUWmOuXLEPwcxZW8wBJxN2EJw4g3g6btCOLTEM0DPdXd6usMTnAW08hxrB4Gl3AH/YR3YF3Pq+08l3YIYucJulH8HskiWrlJXERHCcOIguC4NmjbB6KTQB8EumWgIOuMwp0Vjoww2IAIKN6UkgM0RP37JUguJeBKfshrI923ECMbghPaITgMzMmg31ONBLkEX3uaP41C4DgnDkMQa8HjMKiCwZBOvwIUKxFcTsAFLOQfI7UfQ4xMCL48GsLDgK+A3qNP2NNMH90kCNLMJgcMPj6ELxg2gQ88YOj/ugrJIgQX0MYL4syRBYUYWRCc1AptBwFngN7dHQnKA4GPo5xUlwJLEgxZBD5wCH1WcylZW6xCcAkB3xdn8koJw7CCYIGEaCcwZ4I+HLRyh0V9Wn2dQ6C1p4lUAAxJgGQxpdIiTK7XvnOXYvgGa7heLGTtxi5HcuMH4VtTQJ4N8o8gjwChqozXb5KBdSQcc21g/245NO2K628Iy99JuwwRuwyfWyh4CwGL2IxbzDnsba5HlTAMkUlk+NZc0PeA+BrIsenSkf50/QBwSdww1Pu+ly499utva/9z9kNwGy/wPfNttihhGDQIEIZzt4dtLgd5PcgdskGQZ8Mi/Hm+owmCPRSbDRbJKARfoMI95gfMNwtoK2Form/QBucdD8EfQH4EpHILv3S85tEOvsJdMBhZv6Z5gu7WEvE2SDEDyTVswU/NhWxbwtAUEH6wDUy+FOSlIKfadLW/VpANCn+jrX9B5lWjFl6WWyQTXgfWKeAjVLjL/ITDzAKCEoZCIJinDD/+AAR3gvgoSJluFskM2sH2HUU1szmBSPu478/JDIKfdgvTbqe0tkkzENzAWznHXMTEEoaGQLi4HQ78Ksj/C2p71x3P1pTZzofGfQhvqTZAN9AJrK1tbwJravvrgK5azNX9dUWYSdIRQUozh4SHU913bhuSLzOGX5irmDXc4w3DFISfbgFiIURHV9MojKW/QJPcsZanL8GzX8C5hRFE6yFcD3otRMsgeh7ClyH8J4SrIHoD9Bro6qyez3qgQkArCoVkDAHjUYwnYBIBUwiYRsAMFJuhaEPRTkCFAJHYv5Clv6K+r0KSrWNOpuz3ZMbC51DcJuZbYC9hsIFwza6gL4NoN7fw+/QupwHQQCdZddMQroNoNURPQPgg6Ceg+3nQS+GZ5YJiH7qZzngqbIdkOhVmongHinejmErAWAIquTvusiT3JeUyJQPSAfw3a7hQHE9nCYM7WiRh54MgvAz0VunCn0cz5Emr6N0MhJ0QrYDoftB3QfgIrH9M8MjqIbtv+xHQxUwUO6PYE8X+KKahGEeAStQasgEgkjTDQK1QX6cRXIThdHEEq0sYBoDwYAWWfRKib4MZlw5AxEDTqdG0bBcA0TqIXoDoFtC/gbV/EdyzatiamPsRUOHtVJhNhblI3oViEgHKy4RKy4LtEe7AA4Iks0lwM4bPig/yUglDLwg3tYM+tbZV0k2jpHyjJCiSxigPgKATwuerAES3QHS/4OaNblikAcFcZqI4AMlcAnZHMYGgFgBNM5V8/Qfbe5noP/TUP4Tgo+JAntjkYTDcNQY6zgZ9YnXscSMQZMlGtYKgQa+E6G4Ir4aOOwU3rWGEFAOSY9iJVo5EMg/FTBQtmf0IHxCUFwg9GmIJAUeJ9/LXTRYGw+3jofs8MJ/oP/CmZzMeplIaCF7aIaqZQdfChqsEVz3BCC/mWMYxhkNRnIDi3QS0o2qRKVfqt8wAhy8Q9ZEmwTHsx31DNaJODB0It04C9SPQ8/3MoiwOs7dmiEA/B9Fl0HWV4JLlbGLFzKOFrZiD4osE7ItktNOx9knz9neibdtyJB9nL347FECIoQHh9vGgLqmCYAoEwXuEmga9DKJFsP4ywUWvsIkXcwIVJvF+JCfXIlLtmUFQHjCkA/EaAUeKPbhnxMNg+NM46Dof9Mft5lBen8ErgmQgehX05dB5keB7/6As/Z/PSbQynkNp4atIdkfV9Vv4hliTzKN0cwkEL6GYL3bj3hELg+E3o2H098CcMBAA4wGAacA8CteCvhHEtwVn/L0U+5Rn9TXGM4GPIjkZyVt7e7obgcEHhD4gliGZK97JQyMOhmo/QvhNMKf0OcvGA4asKRgDHGZd7RXWC6Dzl4Izw1LUMzy3bzMDxQICjkTRnjjnUp6+BjsIPftP08LBYhbPjRgYqj3LH/wcmO+DDuwANAKDE4Q3wFwF684RfP2lUrRzPr+LqbCBuSjOQPE2VK2PwqdHOq926APiHhRzxQ6s2OhhqE7l+JcPgrgazJhk08jk1AoDHGYN0eNVLfT6bwRnlusVFPEsz2crWvgGAcegGOXVz5A9olSVStUPiJ8zhk+LLZs76cAgwPD4bhAthmiqn5/gA0RSx1vYCdENoE8TnFg6yM3QEq18FMkCJNv19k34RpOy+A19GsIgOJdlnC7mNG8OWNFcEJ6dCht+DXpXf7PIBwhnROk10N+AsZcK5neVotvEZ3s576CFHxKwNxLlBUNWEPqbSxsQfIptuUaI5vRBiOaB8GA7jF0E+qg+4faFISsQkQH9GIRfEHzirlJUBwmIq5lMC2ehOA5FW2KOUh4QBg4tXYnkELEVDzTjemRzQDASJn4J5Dz7lamMdyHxPA3yTlAfLkEY3CKOZSUv80UkZyB5I5ew26fHt4OkmIzgJ+bV5kxH06Rhny8cAPK06nhlm1clPO6KV1MSgrwO5NGCo58txXMIgPgiG/grCxGchOTV1MemUh6zcoLQE87dBcV3jaFl2JtJhqVbgrwLzCy3aZSlw81pGnXXcopOEczvKMVyGJhNt3EIkh+j2DZRoPOYSf3NpYiAzzCORUXmMMliQTAVqJwLalZygFmQX59KQG4AdR50fbkEYRhpiQNZjORjSJ5FYgqNLPUXJYXgf1jDTsPYTHrtGFBHu+cOSRsB4nVX1oH4FnScLpi/vhTBYQbE/tyN4WgUj6NiQLh6q33Npv7t6RQCLjCG0cPOTDL8cxroe6tjl02CWZQUUTIpppHeANHZIM4WzCnTKoazyXQ/uyK4DslMJKKBHuiBnXD9X79Che8VEW4VxYBgAlh9OZhj7RAYTxCiBP8h6gJzLrx8Vk8fgjGm7FkeIgXgPCBE7zHzAO8h4OcopjtGuKXHVUTKvmAVitlCND5stCAY3vww6BuAYKDwpznNPs6zCUFfDOu+IpjTO72IMaZrOFz/EP32UH7eCwYA8zD7U+FqJFvk6ltwOdK1VyPACBZLmCsEG4ZUGAxvbAbqPjDb24U/i3awwRLpaup15/GCvfuNRzbGrB3EaxcFnCMG+f8U9d+8/3scBgDzGEehuATFuLpVRf1iKo75XI3oe9WgNRzfKrhyyGAwGAFd3wR9mlsT2LSEC4q4mRSZ6voL+kjBbgOyFo0xqxoQNNEEYRVDCEqzrj9TnRUGEDzDSQjO7ddT7asZ7NogLllLu+A940T+7NYGYejcEeR91XmOkkwjHy1h1Q7PAIcKdnza+vvGrMhwTWIQIRGD9Ps+5zb7+0TMTJL2Z0XAUhYScGJvLpMtUzVhlu8ebaCFs4n9zhj4Wl5nWuQHwQTA9aCPSIYgyTxKNJlWgT5G8LZbnf/BmJcyPsyGH3ZOYRMb0ffn+S6RBgOAWck4urgBwfv7RZg8zCPTZxINkKq6/Y4QZk8S/G1QYejGHCzhJoEJql+SVytY07i7QP8nzDgvqYfRGLM06cEU8XBzfGeW80WD/6VZv5P7s0kwAJgXmEkri1Fs7wVB7dvi2iDBAP/VJDhCiOxz3IqcWqHSBXdK2Lsn3bz6ZYb8TrSp9xOuh67jBDskRgeMMUsyCE8RIOQVHFHQ8WYJtiiqLg0GAPMah1LhWiRjXH5CzEFOBaFOokIFcyaJ7LNr5IKhE3OogZskyP5T9Zve1+waofczS2D9+wQzXki9qcY8nvGBNyqAIid8RQleoYLr8epzLDsMBsEazkVwci21YgAIBn8QLFAsngqHZ9UOIo9WWAt3ippWsK9lUa8pMmmItaCPFWzxS6//YswjOYRBDJJgFfm5Is91fdanEUl69YYBwKxiAi3cgmLPHv/B5SBnAaFWFxrYf2vBH7LIdua1tt6EA4G96gEwdSBU90Vd0pOqQVF/po69CqqhYnE5XPirTK5L9pasaIHJKrB5fyuPgMbPNY738f363zEpdfWf92+FJ7LarOVkJL9GMdFYTKKsENTVBxr+0xj+KAS6KZrBYNQquF3AHJ8lhWXMfErWCtHTEOwnGOM9u50x5r6M2iDPa14zwxe0PN8lMv5n399Nq3Mdr3egMy2MbgxnaTjVgGoEBEtdGMLsGYL7m6IZVsBeAvZ1aYX6OtnvmKgBIeu0RD+tsAHU1wXtWad57M7Q0mcRwqyCluXz3oLlccz3901KnU+jaSz31hQQmfyuhkM07OobezR+YATAfxjDMb79Dt4wLMBIAyebatcIWACoh8JlOonavug7y4BcDC035orwNi6kaQLrC1bS7+eBQWT8ftt7E9tPOm6DxniYTA0VIVjdaTjDwPUaRukcELhMJgMffgpmAU8WaiYtx+xk4CEBLVmWDXavvdnrZP8T5P4C8UhmZ96YW5uh6nEvKisyAiRShDftu/N+n0i5bt/PCs//Vu9Aq+zPEdUB1xo4Uldbx8TwqQcEvceBC94mOKlQzRDCcS4Q4k2MTNAUfa8CAVohFuUBIaYZsgp9ViH0FTAfOLK+9xXGrIIsPZzjNIe5kKxfIYjWGM6MYH8NkzxCp17mUm37yNOG03YQvFkIDC9h2rvhWN81to0HJLXXVzfADxq4j905W/9mtqJ5W9ws/62+Tub8j9oRZRIpPoMrgtQQGGMFj64wXGPgRBPTDnm0Qt02eT0cAVyR9h+8YsKdVQdnqyyrISettRlVNY0O4ZLRiBcbhCFtCxPeh3Vbt2PftnUn1MUuc0Bd5FnnM0OCsfVaWupMhjrXhuUVhzOdq2j4voaVPstP+ixNWXdxn1xg0mU9lWaDEc/AzQIOyboAfXK4lZcE7DYW8Vrem2eM+VmDtrpPnSiotZc5fzvtPJnhs83aeq8tj8/QzwoxLNTwHz3awaYRyKYZalY+79xN8HhDZtKTsKWAA7LecekwnUxfJ+MVExsAoVa6ChTWLALo+9n649rzvKy32uQUXhP7vUb6pgrzH9bDjyvwSQMTsoRUiYFC/+OBgY8AZzRkJkUwV0OrzzKBOkF9xepWGbikgHvXnWNLM3fClM/4mlKhxUxy1UU5N98pyxOTwVLMpbgJFD9WqKk0U7Akgv8XgklamNhncYLYNv96g8qtGQxGPArzohzOsnBrBiPguimIZQXAEGYMS+Zp/X1b86Tv0I46mxbQHorWdcttXUDxvlBivyFjTrUcaMoPiDzFHehCx5ILuEDDRzSMzuEwD6C49vkdtoJdgQdzwfAIvEXAnjQgMZantl7CTwu6b90Z4+CNCr/M4A+k1aWZTtKjnZEOgdcOv0J71NmAMI4IeVNMpbfAI0/CHzUcaHJA4NgEcFRuGCI4TEDFN/aX9LTqDNS/bE1h63R1eQiqLxTS47hO+WzSucIhpGk2vchwjsvfMAxMLtYJmiEOhImBEBd+U6R2EALzqOEKA3M0VBqBIGbXfcgYTnGlZyTAYISBg4yj6ZUWMGwSEXtaoYFFAqEL1AxZW+8iIi8yQ4svE0wXFxw6BRjpMImwdO2kQU0KEMLiI8TrmjHlzk0hvGxgWh4AtCUWbGDGHbA98HQmGB6EURHs49IEJqWu3siseyKvATcWeMO6M9jwPnUyIxB4tPARfhkrLnPIODSCsfgCBnvOpIx1ssXNJCyaAIcTLYrWBLays6DjL4ZrIjiVujBr1s6Q2DGp4f2ZYeiCvYBxcS3gep8ERt3+r3dAvFHgPQubHGOXnsddLbm27MuYA+0j+PH38dBo/HbLmBYwlscU1xRxhU6d7yoHwzyymOk3aviSgVG+ppAjtFoPyYHAhZlgiOB9OLSASdEIWJ4w0CXgfwu+X12DJPhJpk7asA6RAIF2QCUTQLAlBUsGZs9Lh2kUb8fiZpELgDgEJmYuFQ7GUnhoK3gW2NnDH3Bpg/j+fosNrYdYZt8LXP5CBPvkyTwz7qZ6JVD0yjrdBdr5WTSCfbRr8nHtcaxeqHVCJ5kruiMtoU8bFDJmHtnqfGWsaZphviD6g+EXGnbq6ZHGw0ewmUx1x8dreBfwZy8YfgPtGnbzScK33X2Hl7p4d8TaYQCDSGjls9S5nF9bK+8KXwrHvq7TDjZzxWYyxf2GtDoXEMbS2rvqbB1yhZYQfmXgq9TGOvjAQLp22NsbBgF7aGhzAeBrMtVHkTTc0YTGo5viHN1GWn7XexcIwmLX21p9bdEA2qEdbEJvYvuqTm6wdNTVD04nBqgLCNFkLfFwBK8Ab9X+plCaQz0bWBj/IVc6xt6+XeEJ3d/1+QbrgN81CQafbFVbmoUt/SIpJSNL+kVaykZStmpIcpqGLRlYk57x6lp02zXs2KfjtynaoL7MEYQh3OFzM9Lq627WXrYs1sChmt5ta/mT6lL8i0dnI14dIs2Q1fzx0R6S9AF9OsEk0rFzjeO4TQu4Wn1jCY/aepJtDaC0aAzfKGbTp/XX8DsDx9fGNXs50ZCYXLX5DJgGPJ8CgxEadrGZRXFV4vIbLHD8sUn3qSgYpKf5IzPAIRMAS1q+Ly26Y1KO9dQpiwAnJWbGv98XjKZrhxDuN9XIYeDjJJMCRrWTm11SYVgMY7urOUkDhD5tigTHFBKhhD81EYYsznCaRiAmnHgKc2Spiwusy4GWFqfZJuz1Ah73H+LPXaaYwRY3sZ+fEAfL1gs9KCAAHA7P/gKWAzOSWn0PjVD/fhfgpkQYumFHXXcT07SCSIFBQOf6hOSogmDI6+SKlNbbt+X3eXUtyJTU0tvMJOlwklXsNa01t2mGJCjSvqdpUAiBud5wXxyGJMHXjj9WV79zqs/QBbu4Jh8yDhhSzKkXDod/DLKZJGksWlSE8MsEPyIu7PHlOXQCLEmmT1aNYNMOtkiWtsDBYJpLEdwr4JiehjpN8E1CzLd2MekwGNhe4zcHYhIMddri73X9JUMBQ5L5k0X4XX6AzZySHr6By0ewQSBJnxVFZdQEceWuU4AwGeSt8GLgqbAaYWvJoQUG/LkQZi4wyDPrpp8MLM7KdNdIDiyhA+k4Vvu8MSSPOx0EMylJ+NPMpEY1RBoItgVeXVDUH7OdB96ZzE67P2lGwqwTBBStGZ6Oqs/bG4YUWtu2hq2AF50waJhuPIWfBGh07zX4zWaWs3Q5hNRX+Mkh8FkiQ2mtv80kskWNkjrS6h+FItuQTNss0EkAJGmKppaPwUs/gVVQXQTdVz3phJsgYXoiDBFMT1oYIGl+QYs5FZpY+KoJmsFX+H3Mn0Yd4qSl+RTJS3271rGJawRXNoJ0+JQueUlacUg6zCWRYno1rwhMZFgCbJOh9U/09HUVht9bYfgpZoKGcSIh3ECC1rDMQBUKeKGJtygkexKdzOEwZzWFbFBoS51J0BhJGkHG4LBFler3SXhUrnTzeJdRnghV0Z1vzxmYYzyFPUkl1gh/i9OB7obNlaNHsSeYnhGGtR9vTs9zWj9DHi2RxfxpxDeIw5CkGWy+gcrQ+vtGkbAIvw8Ag6ohwioM/Xq9jR0aLxvRwBQnDBo2czUhUcpdtMFgmhdSTfIZfNIlmgmDzFCXpBHix5VFOxiHlqjvc3A5uq7Hlzbm2qSEe5vZ8r0o+oIJia2+cUel6vc3S4Jhiklu6Z130mZKGXi9yTB0F+An5DGRfPyEtDqfTVn6FOJ1PmaRSdEMPhDYhH9Qi4FV2gMGl3awhNDcmiGEKfEBtFlAIBaSYOhgyGMa5QmRpqxl3/BmUuqUBYI0c8k42jkXCPFxGTLFRGvmw14t6uTcpAh82p/SSTAIGOPzJcLjeA2mfzbfjMzkM8iMmsKnTnn6DMpyXFmO+8IQd55VgqaoN5mIWb1xS9g2e0fS4J9BC7GGsEp6wpCmHWplTJJmaBd+Qu7llQ0CDF0ZQqZJHWl5o0eupDtf/yAeMq2HQqXAYNMIqgEHuh4KYemDiHcADnrnWxesrtRk3PeHUhr3dicMUW0xEtedynqlBlYPIzMpr/BnjRjZWvk0bRDV7RuH8yxjEOAAIwkSm0kU1WkL11iMLDO0NLO8GTb4OzEbstUJgwEV75ExBf3wRghDI0BozwhRvIdZxLSFzVwyjqhSHJKefeVW3APg0HVQRHV19Vt8xr1B8xnWgWmluNFEJnZv4tGksUX2kWhYOwxgaDSvKClalOQfiDqhttW5IDEOAJKiS1giTGmCqiymURIIrmGgg1baYW036AK/MtFnKKwIiv3X1t8Q1WkqjTHC0cq6Jgo3jtbYNnAm3hoL0meOiMcZXIm9NoESObp00pa50ikhU+FpGhEDgsEGImrid8d9ho4Cv1tSS6rayMugjPMti5eZNNrkG6vhKmuSzKRQDAXuZSmLR+kEERT0XcISfY3D0FWUM1w7f0L5CMtSYBnXXR3Mn1lVO2zPDUkwrDN+Qp56Tm2bVD6/shQYLZkga2aSaACCumPrUn2GRoCIeYQlDGUprIQwUYIUHoIO9lXfY7La4YQhhBW+wWPjAYOwZMGWpSwNRDImRHUwJAFhG3IQ1xgGVjhhMLAi/gU6Iwyx8aglDGUprGiYSCyaJNyC7mM2rUjyGV7Pkh/uMcRu2/IRlqWo0gXbKA8YpKf/EB9iIGM+w2tR3fq78Vlssy5MHMLoT2Gmlo+xLAVphukhiLwLZlvqVjhh+AFitYY3fRahTlsgvbYFErYrH2NZCnKgp4f5hH7Ae1PdX5qoUSJ4rj4RxWf6b9vc6rX9IIS3lo+xLAV4z6Jngrs0INJAqJua/jmnz0DfCbu6/ACT7DDH/QcFvK18kmVptHwAtg5hou/M8Lb38c465QNDmmOcYWo/AexYPsqyNFoE7BBCRVqE3DXLQdLMkEDnLHg5EYYIluTQAE5IDOwCRjRxvtWybBJWErM0BMYTBkHyFKkCnqmfZ9XlM/zdZmuZDL5DbNvusDLEWpbGI0l7hSDzLGOlLT5DCI/Gf8M28fDjom4kU5oWSBsIq6EtgD1o7sx6ZRnhznMEe9q0QNos8HFtIfrkcgAMAzTD1bBGw1JfLZAUau2JKEXwr+UTLUvesi/MDGHLyDOSpD00h4G/p2oGEEZj/m5is3H7agTHvIezy0dalrwlgncLaPFYO3CABnDUmdACg3T8+AO2tVKT1lpN6X/Yef+yJ7os+WF4r65aGF5ZETZZjdW9djss84KhG+7J28XtOK9dwHvLx1qWHP5CEMH7fHqeM6QN3YsYmINqhWEtPKih00VXGomWLdDwvvLJliVr2RXeFcEWEf5awOXL1smndSlmKwy3w7oIHtIeP5ghxHrIOzCjy8dbliwlhA9G0JY3Mc8GRwj3eMNQdaL5g2/Sk6c3P3k0zCkfb1kymEhKw9zIkqmqM8hkTDu88Qo8nAEGCOGOPFohwZxq0fDh8gmXxbfsALtpmOHrC6TJaO393c+I/hMBpMKwEu4Na+ncOoXKDI7LwbtjxpePuSw+RcMRcRMpTdZ0SuPcDbe5fs8Jw19gvYY/pNlfaZGlWBRg8xCOKB9zWdLKFMOYCI6JEgbzJDXEDi2hu+D2zDCAMBH8JgsAOj36FETwKTCyfNxlSSqtcHgEW2VxmD3k89m/1RJRM8IAGm7W0K09QlgZPP3dZsFu5eMuS4LjLDQcF0El7xBPW8Mcwi8R7klfEmH4AywN4b5GQqqWPzVKw/HlEy+L00SCd4YwO0tOXJK5VNuMgeuSfjfFXBFGww05+hSSHBsRwVFvwUwrH3tZbCWEz2to90nP9oGkduzpR+GvDcAAG+AXEWxw+QRpuUsOWidqOKF87GWJl7GG7Q0cmda3kLUhDuF6RPKM9qkw/BWWR/Bbn8hRBnNKRnDcVMzm5eMvS393gc9GMD7J1HbJXEJiXmjg2rTf9ojqCKPhp0k/6mO3Weq2BP69fPxl6Y0gGWaE8DENIq1T1wWItoNy7zPwZAEwwKuwOISXfbSDT1Jf7ZjUcMIkzDalGJSl5it8ScPkLAN1fML7ISyyZanmgmE5Yp2Gq3WCNvDJUbJc2FQNXyzFoCwYdtaxTra0ccyefWAr18KNPn9B+v9XroigK01FaT8I6n2HT7Zj3llKwyYNggKxwMDEPONmUhroa/8peLNQGJ6AJzQsTnJefHunLZGlBWCCUio21aIOBnUoKEHNntGe1oUmscOtsxsu9P0XGdIihI5gYQRRXtPIEXUSGg5RZc7SpqoVJkDlG6BG1a8KbGpQRBmgsIDxv6/DU02AAZ6D+wz83icnJCkcZoGj1cBZYLYopWNTK2O/AuodVQjiW34oNITdcF5S+kVDMICIumGhri547kWo9gREw0wEXy+T+DYlrTD2X0D9OyhVD8DANePFgImw00x0Dbe/CQ9m+TuZBe8luE3DvQlEeneU9E4PLgCFRPEJWvhgKSWbAgjjJ0Dr90BN6A9B0tYfioSGOOyC//EJpzYEA4juLjgnimmHtE4Q2zFDrCFQjEbxHdpMuabDyPYTBIz6L1D/Ul2izaUVlONV9E536rBEbuuEe7P+rVwmyco67ZBmFrmAQFiuu7rNpMK3wbSWUjNSy9aHgPpcn3kkGQiESgGiCoVF3sKoqhWiQYEBRHcEZ2sIPXNDel+NsFxb/2sXKI5gIp+vnV2WEaUVtpkJwXmgxgzUADIHEH1Q1GRscQj35flruZ3VVXB7BL/yBaFXG7iut399CwGnMYWDSukZSSDMHAejLoRg5sBWUGY0ldQALWGgw8DpebRCQzCACDV8vX4NOBcIA7SBdJpI9dtEAs5nK7NDKUUjwk8IIPgmyAP6/ATpEGwfEGzniB9hmUN1EGCADngihPNdDnSvg5x0HQp3IxEwg4DL2MJMKaVpY3eYdzkR1Akglbt1lwnvU02lpWC+k6VfoVAYQJgNcF4ES5wmkXQArxLuRX//YTaj+RGzzNhSqjbWsut8kN8A1ebWCK79JEHq/R4NagGi/1K2gwwDgHhdwyk9znSiNvABYOB9kUg+BJzDNNNWCtbGphXesz+o70MwLtlOTmo1U0Ott0LndQ1LckFXHACXIzi2F2TXqxwQCPAAH5B0ITmXiLN4XHSVUrYxgPCv7wHxc9DTk3NLezbj2K9/b2L7ehVEsxEdTzT6dwtKfRAhcBqSl1Odf5ViMrn8CEULklNo49Qyw3VjAGHfXaHyM1Bvdbf8MqN2sGkJvgUdTxYixYXegIo5DsllCIIBrb5oSCvUb+tQnMMazi01xHAF4YB3g74czNtBC/dQMJOiHVzaovf1blhxKIK1ww8GTIVWfoLiY06hrzebVAoc7kDDBiQ/IOK/+ZNYX0rfcALhA/uB/gmY6RAJP/PIx1SKgxCtAPZHvPpoUX+9+B7edrMlkruQzLICIHNuAzVlN4pL0XyNu0VHKYXDAYRDDwF+DHpbv6kj8voMOoLoM7B8USOh1Cb5DHVlnViO5CQk65w97Ao/MzKpj0JSQXICLVzCB8p+iKGFAImZ+zGoLAK1rZ8vkGYPi6Rj18Lyq4oEoTmaoXp3JJM4Fck3kUjvaJJKMKHc7zWKu9B8hlvFs6VkDrpZ1ArjvwD6NIjGJw/Vr2/lXT6DTvIRAP13iA5ELHul6EtpYiKcaWdzfoLkI4l+gfBsQJL7JgySxwj4Ar8Qd5USOlggHD0Z1FkQHgemLXlmrSjFUfYymVZCeAji+QeacTnNzQrd3ExF8WsUu2aKIPmAYDefXkPyDeBSbigjTc0F4VPvgOiHoPeGSPkBkAWIATBsAP0peOqaos2jwYEBYEuzGwGLUUzNBYMrf8vdMdmJ4gYqnMbl4h+l1BYNwQkV4KNgFkC0XTV0GnkKvy8QA+oMROfCE6cjCJt1ac0fb7ycvwInIOjI5E8lgZD8mTYkx2JYzPHm4HJMdZEgnLgVVH4E6kKQ06rZp42qea8OqGuhclYzQRgczdDjUM/gc0i+j6x1yCkPLZElodFuOr1BwFUYzuFi8VIpzY1ogzFzITod9NtBS/c8FT7h1DTtUP8+ugfMXMTDK5p9mYM4ksxUmMU3UZyCROTqgfaBYWDqh0bxBJIFPMIvuVuEpXRneWxfmQFqAegjIWpPXrfJd1pqb4f5adAHIx58bjAudXCHVU41o5nMQhSfyeQ7pCU7puVBVffXIrkRwXf4rvhbKeVpEHxtPLR+FPTJEL21rzc5bUFknxU80mDQgFkGG+Yi/vLQYF3y4I8xnmnGMZrzkXy8KTAkgaEwKF5FcgVwId8qHeyBEPygFToOheiroHcHXUmd8N1r33iYT72pFi9CdBTivnsH89KHZsD97mY8cAmS+Q050T6v9jEjmoBlKBbRymWcIl4pIbi4Ah3vh+hkiPasmkQ+k/7oHBoicXsNuo9E/PGewb4FQzf7xI5mEmP4ESoBCIV/eobKAEPfFqF4DsllGH7G18TLmx4EC1pg8hzQXwS9L0Sjk9dj8lkZPC8I0XKIPga/u7NZfQnDE4YeDdHK91Ac3+tUZ8tPyqYVJBBYz4kI+AeKa5FcyYniiZEPwcXjQR4K0Qmg96g5xyLdJEozl9I63FwdbdEyMMcgbrt3qG7J0M9LtJ8Zg+FsJCfWhnjm8x3ShtbWw+AaVBSgkbyO4ncEXI3mTv6PWDOCtICE7XcCcySE80HPgKjFb7W+PP5CUii1X27SEgiPQtz616G8PcNjkq7dTTvjORXJqSgqDadlpDvS/evsgHQS8DyKW2jhFlq5n8PFuo0PAAT8aiZ0HwDhXAh3Bz0BIpm+IJSPv5AlH8m6PQTRsYibnxzqWzV8Zqzb3VSYxCeRfJuAcdbsVd/UjCwgpG8GxToULxBwCxVuw/Agh4lVwxeAuwII3w7de4M+AqJ3gZ4EofJbB8d3xbQsZpJthFt0M2z4LOKWYdEhOsymbzSSgzkIyWUotvLWCD490kEKIGlb0AtGJ4oVVHgAyV0EPIzgcfYZQjjMXQGMnQnrdwG9J0RzQE+DaFwVgKzLimfRCLk62zToi8B8HXHDG8NF+obnXKaHm10RXIZit960DZXDf0gPsbocahsItjpd0xpvEPAEAQ8geBLJc7SzlO1ZjhBRsYL/7HhgO+icDnp7CN8B+t0Qbg7hWIgq/QU1xHsxYnyXFvTRDM76DogWwMsXIe7uHE5iN3wn9j3EbMEoFqI4ul+kKW9vdJpjbRN86YAhSAQmQtFJhXW1Xu9lKJ6nhZeR/JOAVSjeoMIaJJ0ERFRYD90VoLWaDt01ttqqMx7CSRBOgXAaRDMg2gx0G4TtNcEX/YU6JB8MWcOoefoVomXQ/Tnovg1xQzTcRG54z3J9mGlnNCchOR3F6NwzEPoAoRJ8i8BTawQJwFToW5kpIKyFc6PauRFSi5pTK6A7AK2qYEQJQu1zLKtfkBY9ytvrHP2u6h9c/dRwFbfhnd58s1iH5rso/g3BEufEAj4Tl9XXxetdm8859ZuruRH93guggqANwWgEo4FxwFhgNNAOoqWGTsIX2Y75bDLjcdeNTdvvPb8TxELonDucQRj+MADcICJ+Jm5Fsz+CnyHQqc8r6bnLjLLhC4DrOwtX2PEfLwqSLDcnDYLeumdBzoOnTkVcs2q4i9rGM/DlavEihk8j+TSCV1PHhAjPBi1N0PPIkI+si0aAiJ+T96JkxgtMaoX6HYuqM1hEcxAX3oy4e6NIm9+4RoFdITq5lJ8C+yC4FkHopamFBxBpWiSTICfIrMj6wSwfEgVtPjfK2co8A+IYWH084kcbVVbwRjgkUhguFktQfALDUcDTTm2Q10zOoiFkgq8hizCZ6h+Va8ur2ijoJklArgfxQzD7IBZej7iic2OTrI13fPD5YgMXiF8QsTdwLoI1drO1yT7C8G44CtYYTrV7N5gD4ZmTEd/daNPhN/7B8ueLFYzmv4DZtZFsUaYGrSi/YVgIfpKN53uhMov2WArmk9BxKOJb9wzHvoOR08+QtZxkWpnAgQScgWSP1MxWnzEPPkl+efKeBnwuS85QWkeZz3FXz7JXZ9oqiC6B6DzEaa+OFPEZmUvLftmMZhKHIvkqkj1S0zTyJPVlzW+SRcGgyZdg10iaRVQHgV4E0fnQ8Q/EmXokic3IXmd5gWlnFIdR4WQk70HV0jp8YZAFgWFLEvSGIQ0Cn9Zfe9QlQrASwsthwwUjEYJNA4Y+KNqYyD4oTkJyUG0VIP90jaxp4ElawAmUT1pEoxAknWeFYQmYS2HdlfDF1xDCjGQx2TRg6IMiYHN2pMKngXkETE1cilfGWnJJtoFCSblNMg0G3YAfkPZdtvN684i6Qd9dNYc6foX4/Caz9sWmBUNvMYLzGM84DiPgEyj27R1h55vlakv/lp5aIBWGNBB8tUgmv2AZRD8HcSU8uQRx5iY32domCkNdud4oupmOZB6KI1G8C4nM5UNk9SlkVhiS6vOkYEcrILoFzHVQ+T3i8HWbsiiUMNSXu0zASmZR4d+QHFwbXFTJPAVNnjqpG2z5faZ7jAD9IoR3grkR1t4B89aOdF+ghKFhS8pIbmIKo9gfwfuRzEExDYXIPGCoKTB4j0/ugOjPYG6H7ttg1WMwv3so5iUqYRhJ5tQUtqXCbCSzUeyF5O0oWgoBIhEG7esgG9DLQd8P0b1g7oHoYdizs2z9SxiaqTkES2llFbNQ7ETAzkh2RDKzpkHGZAJEag8N0HssAv0yRM+Bfgq6HwPzKISPwo0rR2o/QAnDxmpiLWMqMJ1WtgamoJiMYjKSyQSMQjIGhULQhqINpaPqYHltIFoLUSdEq6sdXtEK0K9D9AqYpRAtQ2xXrn9dlrKUpSxlKUtZylKWwSj/HyHl/ePsagXCAAAAAElFTkSuQmCC)",
                height:'195px',
                width:'195px'
            },
            'ADVMARK1, ADVMARK2':{
                background:xui.browser.ie6?null:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAARCAYAAAA7bUf6AAAAK3RFWHRDcmVhdGlvbiBUaW1lAHZyIDE0IGp1bCAyMDA2IDEzOjMxOjIzICswMTAwHvJDZwAAAAd0SU1FB9YHDgsgJYiZ4bUAAAAJcEhZcwAALiIAAC4iAari3ZIAAAAEZ0FNQQAAsY8L/GEFAAAB5ElEQVR42q2Tz0sqURTH72Qq4mASSAoSIfSDdCEI8qJFLXSjLYSQNoGLINrI8/0ZD9q0KnDlKkIMebmP9xZRCEEiLQLBiMiNJDYq/Zg573vpCkM6CdGBD3Pn3OvXe77nDGPfENKwJBHx/CxYAtNAAVfgXJKk7khVCCyCP6ALVKAJXkEdbINxw5tgM4HHPphSFEUql8usXq8zWZZZKBRiPp+PH3sBx2Br4FbiBg+aplGxWKRgMPiMH1+YTKZDq9V64na7G+l0mprNJo7RG/g94IEoQSsUCuRyue6QToIJYAJWMA/Bo2QySZ1Ohws9gZBeZI570Gq1yO/395BKGJg+ZbFYznK5HAmf9vQiKW5iqVQim832Fyn5E+83Y7EYieAdY2Nig7dRqtVqrNfr3YiWGsVltVrtr2f0IrwEZrfbGeqWhQ9GMeFwOPprRS9SAWo4HGZOp/MH1l4DAS6+HolE+u9Xek9kcK+qKqVSKUL/s0hPDhFY83g8j5VKhcQg7nxs80/w0mg0KB6Pa2az+RTpDbDA3sd/lwvk8/l+Z7iS/FHEAor8H9rtNmWzWYpGo+T1eikQCFAmkyFxAy7AJ255aMHYcIID8d1oNBi8hGuwwkYFDq0CPlG3YsTb4B/4BRwjBb4S/wGzT16tu5THiAAAAABJRU5ErkJggg==)",
                height:'16px',
                margin:'-8px 0 0 -8px',
                overflow:'hidden',
                width:'16px'
            },
            ".xui-nodatauri ADVCLR":{
                background: xui.browser.ie6?null:xui.UI.$oldBg('clrbg.png', 'no-repeat left top'),
                //for ie6
                _filter: xui.UI.$ieOldBg('clrbg.png'),
                '-ms-filter': xui.browser.ie8?xui.UI.$ieOldBg('clrbg.png'):null
            },
            ".xui-nodatauri ADVWHEEL":{
                background: xui.browser.ie6?null:xui.UI.$oldBg('clr.png', 'no-repeat left top'),
                //for ie6
                _filter: xui.UI.$ieOldBg('clr.png'),
                '-ms-filter': xui.browser.ie8?xui.UI.$ieOldBg('clr.png'):null
            },
            '.xui-nodatauri ADVMARK1, .xui-nodatauri ADVMARK2':{
                background:xui.browser.ie6?null:xui.UI.$oldBg('picker.png', 'no-repeat left top'),
                //for ie6
                _filter: xui.UI.$ieOldBg('picker.png'),
                '-ms-filter': xui.browser.ie8?xui.UI.$ieOldBg('picker.png'):null
            },

            'LIST span':{
                overflow: 'hidden',
                margin: '0',
                cursor: 'pointer',
                margin:'0 -1px -1px 0',
                display: xui.$inlineBlock,
                'font-size': '1.18em'
            },
            TRANS:{
                position:'absolute',
                top:'.25em',
                left:'0',
                display:xui.$inlineBlock,
                cursor:'pointer'
            },
            SET:{
                position:'absolute',
                display:'none',
                top:'.125em',
                right:'2.5em'
            },
            TOGGLE:{
                position:'absolute',
                right:'.5em',
                top:'0.25em',
                display:xui.$inlineBlock,
                cursor:'default'
            }
        },
        Behaviors:{
            HoverEffected:{CLOSE:'CLOSE',SET:'SET',TRANS:'TRANS',TOGGLE:'TOGGLE'},
            ClickEffected:{CLOSE:'CLOSE',SET:'SET',TRANS:'TRANS',TOGGLE:'TOGGLE'},
            KEY:{onClick:function(){return false}},
            SC:{
                onMouseover:function(p,e,s){
                    p.box._setTempUI(p,p.getSubId(s));
                },
                onClick:function(p,e,s){
                    var sid=p.getSubId(s);
                    p.boxing()._setCtrlValue(p.$tempValue=sid,false);
                    p.box._vC(p);
                    if(!p.properties.advance)
                        p.boxing().setUIValue(sid,true,null,'click');
                        
                    return false;
                },
                onDblclick:function(p,e,s){
                    var sid=p.getSubId(s);
                    p.boxing()._setCtrlValue(p.$tempValue=sid,false);
                    p.box._vC(p);
                    p.boxing().setUIValue(sid,true,null,'dblclick');
                    return false;
                }
            },
            LIST:{
                onMouseout:function(p,e,s){
                    p.box._updateDftTip(p);
                }
            },
            SET:{
                onClick:function(p,e,src){
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue,true,null,'setbtn');
                }
            },
            TRANS:{
                onClick:function(p,e,src){
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue='transparent',true,null,'transbtn');
                }
            },
            CANCEL:{
                onClick:function(p,e,src){
                    p.getSubNode('CLOSE').onClick(true);
                }
            },
            TOGGLE:{
                onClick:function(p,e,src){
                    p.boxing().setAdvance(!p.properties.advance)
                }
            },
            R:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,0);
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,0);
                }
            },
            G:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,1);
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,1);
                }
            },
            B:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,2);
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,2);
                }
            },
            HH:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src,true);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,0,'hsv1');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,0,true,'hsv1');
                }
            },
            S:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src,true);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,1,'hsv2');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,1,true,'hsv2');
                }
            },
            V:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src,true);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,2,'hsv2');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,2,true,'hsv2');
                }
            },
            H:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,0,'hex');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,0);
                }
            },
            'E':{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,1,'hex');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,1);
                }
            },
            X:{
                beforeMousedown:function(p, e, src){
                    p.box._dd1(p,e,src);
                },
                onDrag:function(p, e, src){
                    p.box._dd2(p,e,src,2,'hex');
                },
                onDragstop:function(p, e, src){
                    p.box._dd3(p,e,src,2);
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        instance = profile.boxing();
                    if(properties.disabled||properties.readonly)return;
                    if(false===instance.beforeClose(profile)) return;
                    instance.destroy();
                }
            },
            ADVWHEEL:{
                beforeMousedown:function(p, e, src){
                    var cls=p.box;
                    cls._prepareAdv(p,e);
                    cls._updateClrByPos(p,e,true);
                    p.getSubNode('ADVMARK1').startDrag(e, {
                        dragType:'none'
                    });
                }
            },
            ADVMARK1:{
                beforeMousedown:function(p, e, src){
                    var cls=p.box;
                    cls._prepareAdv(p,e);
                    cls._updateClrByPos(p,e,true);
                    p.getSubNode('ADVMARK1').startDrag(e, {
                        dragType:'none'
                    });
                },
                onDrag:function(p, e, src){
                    var cls=p.box;
                    cls._updateClrByPos(p,e,true);
                },
                onDragstop:function(p, e, src){
                    p.box._updateValueByPos(p, e);
                },
                onDblclick:function(p,e,src){
                    p.box._updateValueByPos(p, e);
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue,true,null,'advdblclick');
                }
            },
            ADVCLR:{
                beforeMousedown:function(p, e, src){
                    var cls=p.box;
                    cls._prepareAdv(p,e);
                    cls._updateClrByPos(p,e);
                    p.getSubNode('ADVMARK2').startDrag(e, {
                        dragType:'none'
                    });
                    return false;
                }
            },
            ADVMARK2:{
                beforeMousedown:function(p, e, src){
                    var cls=p.box;
                    cls._prepareAdv(p,e);
                    cls._updateClrByPos(p,e);
                    p.getSubNode('ADVMARK2').startDrag(e, {
                        dragType:'none'
                    });
                    return false;
                },
                onDrag:function(p, e, src){
                    var cls=p.box;
                    cls._updateClrByPos(p, e);
                },
                onDragstop:function(p, e, src){
                    p.box._updateValueByPos(p, e);
                },
                onDblclick:function(p,e,src){
                    p.box._updateValueByPos(p, e);
                    p.box._vC(p);
                    p.boxing().setUIValue(p.$tempValue,true,null,'adv2dblclick');
                }
            }
        },
        _vC:function(profile){
            var pro=profile.properties,
                v=pro.$UIvalue,
                d=v==profile.$tempValue;
            profile.getSubNode('SET').css('display',d?'none':'block');
            profile.getSubNode('CAPTION').css('color',d?'#000':'#ff0000');
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            var nodisplay='display:none';
            data.classBar= data.barDisplay?'xui-uibar-top':'xui-uibar-top-s';
            data.closeDisplay = data.closeBtn?'':nodisplay;
            data.advDispay = data.advance?'':'display:none;';
            
            data._transparent = xui.getRes('inline.transparent');
            data._set = xui.wrapRes('inline.set');
            return data;
        },
        EventHandlers:{
            beforeClose:function(profile, src){}
        },
        RenderTrigger:function(){
            this.$onValueSet=this.$onUIValueSet=function(o,v){
                this.box._setClrName(this,v);
            };
        },
        _setClrName:function(profile,v){
            var p=profile,
                k='color.LIST.',
                vv=xui.getRes(k+v);
            if(vv==v)
                p.$clrN2 = p.$clrN = (v=='transparent'?'':'#')+v;
            else{
                p.$clrN = vv;
                p.$clrN2 = xui.wrapRes(k+v);
            }
        },
        _slist:"FFFFFF,FFFFF0,FFFFE0,FFFF00,FFFAFA,FFFAF0,FFFACD,FFF8DC,FFF5EE,FFF0F5,FFEFD5,FFEBCD,FFE4E1,FFE4C4,FFE4B5,FFDEAD,FFDAB9,FFD700,FFC0CB,FFB6C1,FFA500,FFA07A,FF8C00,FF7F50,FF69B4,FF6347,FF4500,FF1493,FF00FF,FF00FF,FF0000,FDF5E6,FAFAD2,FAF0E6,FAEBD7,FA8072,F8F8FF,F5FFFA,F5F5F5,F5DEB3,F4A460,F0FFFF,F0FFF0,F0F8FF,F0E68C,F08080,EEE8AA,EE82EE,E9967A,E6E6FA,E1FFFF,DEB887,DDA0DD,DCDCDC,DC143C,DB7093,DAA520,DA70D6,D8BFD8,D3D3D3,D2B48C,D2691E,CD853F,CD5C5C,C71585,C0C0C0,BDB76B,BC8F8F,BA55D3,B22222,B0E0E6,B0C4DE,AFEEEE,ADFF2F,ADD8E6,A9A9A9,A52A2A,A0522D,9932CC,98FB98,9400D3,9370DB,90EE90,8FBC8F,8B4513,8B008B,8B0000,8A2BE2,87CEFA,87CEEB,808080,808000,800080,800000,7FFFAA,7FFF00,7CFC00,7B68EE,778899,708090,6B8E23,6A5ACD,696969,6495ED,5F9EA0,556B2F,4B0082,48D1CC,483D8B,4682B4,4169E1,40E0D0,3CB371,32CD32,2F4F4F,2E8B57,228B22,20B2AA,1E90FF,191970,00FFFF,00FFFF,00FF7F,00FF00,00FA9A,00CED1,00BFFF,008B8B,008080,008000,006400,0000FF,0000CD,00008B,000080,000000".split(','),
        _C16:"0123456789ABCDEF",
        //for drag rgb span
        _dd1:function(profile, e, src, hsv){
            if(xui.Event.getBtn(e)!="left")return;
            var p=profile.properties,
                cls=profile.box,
                f=function(){var rgb = cls.hex2rgb(profile.$tempValue||p.$UIvalue); return hsv?cls.rgb2hsv(rgb):rgb;};

            xui.use(src).css('backgroundColor','red').startDrag(e, {
                dragType:'blank',
                targetReposition:false,
                widthIncrement:2,
                dragCursor:true
            });
            profile.$temp=0;
            profile.$start = f();
            profile.$temp2 = f();
        },
        _dd2:function(profile, e, src, i, type){
            var count,
                off = xui.DragDrop.getProfile().offset,
                p=profile.properties,
                old=profile.$temp2,
                cls=profile.box,
                rate = type=='hsv1'?361:type=='hsv2'?101:256,
                v;

            count = (type=='hsv2'?parseInt(profile.$start[i]*100,10):parseInt(profile.$start[i],10))+parseInt(off.x/2,10);

            count=(count%rate+rate)%rate;
            if(profile.$temp!=count){
                old[i]=profile.$temp = type=='hsv2'?count/100:count;
                v = (type=='hsv1'||type=='hsv2')?cls.hsv2rgb(old):old;
                v=cls.rgb2hex(v);
                cls._setTempUI(profile,v);
                xui.use(src).text(type=='hex'?cls._toFF(count):count);
            }
        },
        _dd3:function(profile, e, src, i, hsv){
            if(profile.$start[i] !== profile.$temp){
                var p=profile.properties,
                    cls=profile.box,
                    old=profile.$start,
                    v;
                old[i]=profile.$temp;
                v=hsv?cls.hsv2rgb(old):old;
                v=cls.rgb2hex(v);

                //set the cur hex value of hsv for preventing update adv UI again
                if(hsv)profile.$hexinhsv=v;
                profile.boxing()._setCtrlValue(profile.$tempValue=v,false);
                delete profile.$hexinhsv;
                profile.box._vC(profile);
            }
            xui.use(src).css('backgroundColor','');
            profile.$temp=profile.$start=0;
        },
        //set temp UI
        _setTempUI:function(p,v){
            var cls=this,
                rgb=cls.hex2rgb(v),
                b=p.boxing(),
                ex=b.getSubNode('EXAM'),
                hsv=cls.rgb2hsv(rgb),
                vv=xui.getRes('color.LIST.'+v),
                v1=(v=='transparent'?'':'#')+v;
            ex.css({backgroundColor: v1, color:hsv[2]>0.6?'#000':'#FFF'});
            ex.text(p.show_color = vv==v? v1 : vv);
        },
        //reset example block
        _updateDftTip:function(prf){
            var cls=prf.box,
                p=prf.properties,
                trans=(prf.$tempValue||p.$UIvalue)=='transparent',
                ex=prf.boxing().getSubNode('EXAM');
            ex.css({backgroundColor:trans?'transparent':'#'+prf.$hex.join(''), color:trans?'#000':prf.$hsv[2]>0.6?'#000':'#FFF'});
            ex.html(prf.$clrN2||'',false);
        },
        _to3:function(s){
            if(!s||s=="transparent")s="FFFFFF";
            return [s.substr(0, 2), s.substr(2, 2), s.substr(4, 2)];
        },
        //0...255 to 00...FF
        _toFF: function(n) {
            var C16=this._C16;
            n = parseInt(n,10)||0;
            n = (n>255||n<0)?0:n;
            return C16.charAt((n-n%16)/16) + C16.charAt(n%16);
        },
        // 00...FF to 0...255
        _to255: function(str) {
            var C16=this._C16, s=str.split('');
            return C16.indexOf(s[0].toUpperCase())*16 + C16.indexOf(s[1].toUpperCase());
        },
        _webSafe:function(r, g, b){
            //safe divisor is 51, smart divisor is 17
            var me=arguments.callee,f=me.f||(me.f=function(n){
                return parseInt(n/51,10)*51;
            });
            if(typeof r=='object'){
                g=r[1];b=r[2];r=r[0];
            }
            return [f(r),f(g),f(b)];
        },
        _updateMarks:function(profile, hex, forcePos, hsv0){
            var cls=this,
                rgb=cls.hex2rgb(hex),
                hsv=cls.rgb2hsv(rgb),
                angle=(hsv[0]/360)*6.28,
                clr=profile.getSubNode('ADVCLR');
            if(forcePos){
                var m1=profile.getSubNode('ADVMARK1'),
                    m2=profile.getSubNode('ADVMARK2');
                m1.cssPos({
                  left: Math.round(Math.sin(angle)*cls._radius+cls._bigRadius),
                  top: Math.round(-Math.cos(angle)*cls._radius+cls._bigRadius)
                });
                m2.cssPos({
                  left: Math.round(cls._square*(hsv[1]-0.5)+cls._bigRadius),
                  top: Math.round(cls._square*(0.5-hsv[2])+cls._bigRadius)
                });
            }

            if(hsv0 !== undefined)
                clr.css('backgroundColor', '#'+cls.rgb2hex(cls.hsv2rgb([hsv0, 1, 1])));
            cls._setTempUI(profile, hex);
        },
        //flag:change h
        _updateClrByPos:function(profile, e, flag){
            var cls=this,
                mPos=xui.Event.getPos(e),
                pos=profile.$tpos,
                left=mPos.left-pos.left,
                top=mPos.top-pos.top,
                angle,m1,m2,
                h,s,v,hsv,rgb,hex;
            ;
            if(flag){
                m1=profile.getSubNode('ADVMARK1');
                angle=Math.atan2(left, -top);
                m1.cssPos({
                  left: Math.round(Math.sin(angle)*cls._radius+cls._bigRadius),
                  top: Math.round(-Math.cos(angle)*cls._radius+cls._bigRadius)
                });
                h=Math.floor((angle/Math.PI)*180);
                if(h<0)h +=360;
                hsv=[h, profile.$hsv[1], profile.$hsv[2]];
                rgb = cls.hsv2rgb(hsv);
                hex = cls.rgb2hex(rgb);
                cls._updateMarks(profile, profile.$t_hex=hex, false, h);
            }else{
                m2=profile.getSubNode('ADVMARK2');
                s=Math.max(0, Math.min(1, (left/cls._square) + 0.5));
                v=Math.max(0, Math.min(1, 0.5 - (top/cls._square)));
                m2.cssPos({
                  left: Math.round(cls._square*(s-0.5)+cls._bigRadius),
                  top: Math.round(cls._square*(0.5-v)+cls._bigRadius)
                });
                hsv=[profile.$hsv[0], s, v];
                rgb = cls.hsv2rgb(hsv);
                hex = cls.rgb2hex(rgb);
                cls._updateMarks(profile, profile.$t_hex=hex);
            }
        },
        _updateValueByPos:function(profile, e){
            //set the cur hex value of adv for preventing update adv UI again
            profile.$hexinadv=profile.$t_hex;
            profile.boxing()._setCtrlValue(profile.$tempValue=profile.$t_hex,false);
            delete profile.$hexinadv;
            profile.box._vC(profile);
        },
        _prepareAdv:function(profile,e){
            var cls=this,
                pos=profile.getSubNode('ADVWHEEL').offset();
            profile.$tpos= { left:pos.left+cls._bigRadius, top:pos.top+cls._bigRadius };
        },
        _ensureValue:function(profile,v){
            var ns=this,me=arguments.callee,map=me.map||(me.map=(function(){
                var h={};
                xui.arr.each(ns._C16.split(''),function(o,i){
                    h[o]=1;
                });
                return h;
            }())),
            reg=me._r||(me._r=/rgb\(([^)]*)\)/);
            if(!v || typeof v !='string'||v=='transparent')return 'transparent';
            if(reg.test(v)){
                v=v.replace(reg,'$1');
                v=v.split(',');
                v[0]=parseInt(v[0],10)||0;
                v[1]=parseInt(v[1],10)||0;
                v[2]=parseInt(v[2],10)||0;
                v=ns.rgb2hex(v);
            }
            if(v.charAt(0)=='#')v=v.substr(1,v.length);
            var a='',k;
            for(var i=0;i<6;i++){
                k=v.charAt(i).toUpperCase();
                a += (map[k]?k:'F');
            }
           return a;
        },
        //HSV (h[0-360], s[0-1]), v[0-1] to RGB [255,255,255]
        hsv2rgb: function(h, s, v) {
            if(h instanceof Array) {
                s=h[1]; v=h[2]; h=h[0];
            }
            var me=arguments.callee, f = me.f ||
                (me.f=function(n) {
                    return Math.min(255, Math.round(n*256));
                }),
                r, g, b, i, k, p, q, t;
            if(s==0)
                return [v=f(v),v,v];
            else{
                i = Math.floor((h/60)%6);
                k = (h/60)-i;
                p = v*(1-s);
                q = v*(1-k*s);
                t = v*(1-(1-k)*s);
                switch(i) {
                    case 0: r=v; g=t; b=p; break;
                    case 1: r=q; g=v; b=p; break;
                    case 2: r=p; g=v; b=t; break;
                    case 3: r=p; g=q; b=v; break;
                    case 4: r=t; g=p; b=v; break;
                    case 5: r=v; g=p; b=q; break;
                }
                return s==0?[v=f(v),v,v]:[f(r), f(g), f(b)];
            }
        },
        // RGB [255,255,255] to HSV (h[0-360], s[0-1]), v[0-1]
        rgb2hsv: function(r, g, b) {
            if(r instanceof Array) {
                g=r[1];b=r[2];r=r[0];
            }
            r=r/255;g=g/255;b=b/255;
            var min=Math.min(r,g,b),
                max=Math.max(r,g,b),
                delta = max-min,
                s = (max===0)?0:1-(min/max),
                v = max,
                h;
            switch (max) {
                case min:
                    h=0;
                    break;
                case r:
                    h=60*(g-b)/delta;
                    if(g<b)h+=360;
                    break;
                case g:
                    h=(60*(b-r)/delta)+120;
                    break;
                case b:
                    h=(60*(r-g)/delta)+240;
                    break;
            }
            return [Math.round(h), s, v];
        },
        //rgb values into a hex string; 255,255,255 -> FFFFFF
        rgb2hex: function(r, g, b) {
            var ns=this;
            if(r instanceof Array) {
                g=r[1];b=r[2];r=r[0];
            }
            return ns._toFF(r) + ns._toFF(g) + ns._toFF(b);
        },
        // Converts a hex string to rgb
        hex2rgb: function(hex) {
            var ns=this;
            if(!hex || hex=="transparent")hex="FFFFFF";
            if(hex.charAt(0)=='#')hex=hex.slice(1);
            return [ns._to255(hex.substr(0, 2)), ns._to255(hex.substr(2, 2)), ns._to255(hex.substr(4, 2))];
        },
        getTextColor:function(value){
            var ns=this;
            value=ns._ensureValue(0,value);
            if(value && value.toLowerCase()=="transparent")return '#000000';

            value=ns.hex2rgb(value);
            value=ns.rgb2hsv(value);
            return (value&&value[2])>0.6?'#000000':'#FFFFFF';
        },
        _onresize:function(){}
    }
});xui.Class('xui.UI.DatePicker', ['xui.UI',"xui.absValue"], {
    Dependencies:['xui.Date'],
    Instance:{
        activate:function(){
            this.getSubNode('PRE').focus(true);
            return this;
        },
        _setCtrlValue:function(value){
            return this.each(function(profile){
                if(!profile.renderId)return;
                var cls = profile.box,
                    p = profile.properties;
                cls._to(profile,value,true);
                if(profile.keys.CAPTION)
                    profile.getSubNode('CAPTION').html(xui.Date.getText(value,'ymd',p.firstDayOfWeek),false);
            });
        },
        getDateFrom:function(){
            return this.get(0)._realstart;
        }
    },
    Initialize:function(){
        var self=this,
            id=xui.UI.$ID,
            tag=xui.UI.$tag_special,
            cls=xui.UI.$CLS,
            key=self.KEY;
            
        self.addTemplateKeys(['H', 'COL', 'W','TBODY', 'THEADER','TD']);
        var colgroup = '<colgroup id="'+key+'-COL:'+id+':"  class="'+tag+'COL_CS'+tag+' xui-custom {comcls}"  style="'+tag+'COL_CS'+tag+'"><col width="1px"/><col width=""/><col width=""/><col width=""/><col width=""/><col width=""/><col width=""/><col width=""/></colgroup>',
            thead1='<thead ID="'+key+'-THEADER:'+id+':" class="'+tag+'THEADER_CS'+tag+' xui-custom {comcls}"  style="'+tag+'THEADER_CS'+tag+'" ><tr height="1px"><th id="'+key+'-H:'+id+':7" class="xui-node  xui-node-th xui-uiborder-b xui-uiborder-r '+cls+'-h '+cls+'-w '+tag+'H_CC'+tag+' xui-custom {comcls}" style="'+tag+'H_CS'+tag+'"></th>',
            thead2='</tr></thead>',
            th='<th id="'+key+'-H:'+id+':@" class="xui-node xui-node-th xui-uiborder-b xui-uiborder-r '+cls+'-h '+tag+'H_CC'+tag+' xui-custom {comcls}"  style="'+tag+'H_CS'+tag+'">@</th>',
            tbody1 = '<tbody id="'+key+'-TBODY:'+id +':"  class="'+tag+'TBODY_CS'+tag+' xui-custom {comcls}"  style="'+tag+'TBODY_CS'+tag+'" >',
            tbody2 = '</tbody>',
            tr1='<tr>',
            tr2='</tr>',
            td1='<th id="'+key+'-W:'+id+':@"  class="xui-node xui-node-th xui-uiborder-b xui-uiborder-r '+cls+'-w '+tag+'W_CC'+tag+' xui-custom {comcls}"  style="'+tag+'W_CS'+tag+'">@</th>',
            td2='<td id="'+key+'-TD:'+id+':@" class="xui-node xui-uicell  xui-node-td xui-uiborder-b xui-uiborder-r '+cls+'-td '+tag+'TD_CC'+tag+' xui-custom {comcls}"  style="'+tag+'TD_CS'+tag+'" '+xui.$IEUNSELECTABLE()+' >'+
                '</td>',
            body,i,j,k,l,a=[],b=[];
        for(i=0;i<7;i++)
            b[b.length]= th.replace(/@/g,i);

        k=l=0;
        for(i=0;i<48;i++){
            j=i%8;
            a[a.length]= (j==0?tr1:'') + (j==0?td1:td2).replace(/@/g,j==0?l:k) + (j==7?tr2:'');
            if(j!==0)k++;
            else l++;
        }

        body=colgroup+thead1+b.join('')+thead2+tbody1+a.join('')+tbody2;

        self.setTemplate({
            tagName : 'div',
            style:'{_style};height:auto;',
            onselectstart:'return false',
            BORDER:{
                tagName : 'div',
                className: 'xui-uiborder-outset xui-uiborder-box xui-uiborder-radius-big',
                BAR:{
                    tagName:'div',
                    className:'xui-uibar-top',
                    style:'{barDisplay};',
                    BARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-tl',
                        BARTDLT:{
                            className:'xui-uibar-tdlt'
                        }
                    },
                    BARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar',
                        BARTDMT:{
                            className:'xui-uibar-tdmt'
                        }
                    },
                    BARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-tr',
                        BARTDRT:{
                            className:'xui-uibar-tdrt'
                        }
                    },
                    BARCMDL:{
                        $order:3,
                        tagName:'div',
                        className:'xui-uibar-cmdl',
                        PRE2:{
                            $order:0,
                            className:'xuifont',
                            $fonticon:'xui-icon-doubleleft',
                            tabindex: '{tabindex}'
                        },
                        PRE:{
                            $order:1,
                            className:'xuifont',
                            $fonticon:'xui-icon-singleleft',
                            tabindex: '{tabindex}'
                        },
                        YEAR:{
                            $order:2,
                            className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                        },
                        YTXT:{$order:3,text:'-'},
                        MONTH:{
                            $order:4,
                            className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                        },
                        MTXT:{$order:5,text:'-'},
                        DAY:{
                            $order:6,
                            className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                        },
                        NEXT:{
                            $order:7,
                            className:'xuifont',
                            $fonticon:'xui-icon-singleright',
                            tabindex: '{tabindex}'
                        },
                        NEXT2:{
                            $order:8,
                            className:'xuifont',
                            $fonticon:'xui-icon-doubleright',
                            tabindex: '{tabindex}'
                        }
                    },
                    BARCMDR:{
                        $order:4,                        
                        tagName: 'div',
                        className:'xui-uibar-cmdr',
                        CLOSE:{
                            className:'xuifont',
                            $fonticon:'xui-uicmd-close',
                            style:'{closeDisplay}'
                        }
                    },
                    TBARTDB:{
                        $order:5,
                        tagName: 'div',
                        className:'xui-uibar-tdb xui-uiborder-inset xui-uiborder-radius'
                    }
                },
                MAIN:{
                    $order:2,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    MAINI:{
                        tagName:'div',
                        className:'xui-uicon-maini xui-uicon-maini xui-uibar',
                        CON:{
                            tagName:'div',
                            className:'xui-uiborder-inset',
                            BODY:{
                                tagName:'table',
                                cellpadding:"0",
                                cellspacing:"0",
                                text:body
                            }
                        }
                    }
                },
                TAIL:{
                    $order:3,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    TAILI:{
                        tagName:'div',
                        className:'xui-uicon-maini xui-uibar',
                        CAPTION:{
                            tagName:'div',
                            style:'{_nocap}',
                            text : '{caption}',
                            $order:0
                        },
                        TIME:{
                            style:"{_timectrl}",
                            tagName:'div',
                            TPRE2:{
                                $order:0,
                                className:'xuifont',
                                $fonticon:'xui-icon-doubleleft',
                                tabindex: '{tabindex}'
                            },
                            TPRE:{
                                $order:1,
                                className:'xuifont',
                                $fonticon:'xui-icon-singleleft',
                                tabindex: '{tabindex}'
                            },
                            HOUR:{
                                $order:2,
                                className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                            },
                            MTXT:{$order:3,text:':'},
                            MINUTE:{
                                $order:4,
                                className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                            },
                            TNEXT:{
                                $order:6,
                                className:'xuifont',
                                $fonticon:'xui-icon-singleright',
                                tabindex: '{tabindex}'
                            },
                            TNEXT2:{
                                $order:7,
                                className:'xuifont',
                                $fonticon:'xui-icon-doubleright',
                                tabindex: '{tabindex}'
                            }
                        },
                        TODAY:{
                             tabindex: '{tabindex}',
                             className:'xuifont',
                            $fonticon:'xui-icon-date',
                             title:"{_todaytitle}"
                        },
                        SET:{
                            tagName:"button",
                            className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                            tabindex: '{tabindex}',
                            text:"{_set}"
                        }
                    }
                },
                BBAR:{
                    $order:4,
                    tagName:'div',
                    className:'xui-uibar-bottom-s',
                    BBARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-bl'
                    },
                    BBARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar'
                    },
                    BBARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-br'
                    }
                }
            }
        });
    },
    Static:{
        Appearances:{
            KEY:{
            },
            'TBART, BBART':{
                'border-spacing':0,
                'border-collapse':'separate'
            },
            BORDER:{
            },
            BODY:{
                position:'relative'
            },
            BARCMDL:{
                top:'.125em'
            },
            TAILI:{
                position:'relative',
                 padding:'.5em 0 0 0'
            },
            TIME:{
                'padding':'.25em 1.5em'
            },
            SET:{
                position:'absolute',
                display:'none',
                top:'.125em',
                right:'.5em'
            },
            TODAY:{
                position:'absolute',
                top:'.25em',
                left:'.125em',
                display:xui.$inlineBlock,
                cursor:'default'
            },
            'PRE,PRE2,NEXT,NEXT2,TPRE,TPRE2,TNEXT,TNEXT2':{
                $order:0,
                display:xui.$inlineBlock,
                position:'relative',
                margin:'0 .25em',
                'vertical-align': 'middle',
                cursor:'default'
            },
            'YEAR,MONTH,DAY,HOUR,MINUTE':{
                $order:4,
                'font-weight':'bold',
                'vertical-align': 'middle',
                cursor:'e-resize',
                margin:'0 .25em',
                'padding':'0 .25em'
            },
            YEAR:{
            },
            'MONTH, DAY,HOUR, MINUTE':{
            },
            CAPTION:{
                'text-align':'center',
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            },
            MAINI:{
                 'padding':'.5em .3333em .3333em 0'
            },
            BODY:{
                overflow: 'visible'
            },
            TD:{
                $order:1,
                'text-align':'center'
            },
            'TD-checked':{
                $order:4,
                'font-weight':'bold'
            },
            'W,H':{
                $order:3,
                'vertical-align':'middle',
                'text-align':'center',
                'padding':'.25em'
            },
            W:{
                $order:4,
                padding:'.125em'
            },
            H:{
                $order:4,
                padding:'.25em 0.6666667em'
            }
        },
        Behaviors:{
            HoverEffected:{CLOSE:'CLOSE',TD:'TD',PRE:'PRE',PRE2:'PRE2',NEXT:'NEXT',NEXT2:'NEXT2',TPRE:'TPRE',TPRE2:'TPRE2',TNEXT:'TNEXT',TNEXT2:'TNEXT2',SET:'SET', TODAY:'TODAY'},
            ClickEffected:{CLOSE:'CLOSE',TD:'TD',PRE:'PRE',PRE2:'PRE2',NEXT:'NEXT',NEXT2:'NEXT2',TPRE:'TPRE',TPRE2:'TPRE2',TNEXT:'TNEXT',TNEXT2:'TNEXT2',SET:'SET', TODAY:'TODAY'},
            KEY:{onClick:function(){return false}},
            TD:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                        id=profile.getSubId(src),
                        map=profile.$daymap,
                        v=map[id];
                    if(p.disabled||p.readonly)return false;

                    xui.use(src).onMouseout(true,{$force:true});

                    v = xui.Date.add(profile.$tempValue, 'd', xui.Date.diff(profile.$tempValue, v, 'd', p.firstDayOfWeek));
                    profile.box._to(profile,v);
                    
                    // set dir
                    if(!p.timeInput)
                        //onClick event
                        profile.boxing().setUIValue(v,null,null,'click');
                },
                onDblclick:function(profile,e,src){
                    var p=profile.properties;
                    if(p.timeInput){
                        xui.use(src).onMouseout(true,{$force:true});
                        profile.boxing().setUIValue(profile.$tempValue, true,null,'dblclick');
                    }
                }
            },
            TODAY:{
                onClick:function(profile,e,src){
                    xui.use(src).onMouseout(true,{$force:true});
                    profile.boxing().setUIValue(
                        profile.properties.timeInput ?
                        new Date :
                        xui.Date.getTimSpanStart(new Date,'d',1)
                    ,true,null,'today');
                }
            },
            SET:{
                onClick:function(profile,e,src){
                    xui.use(src).onMouseout(true,{$force:true});
                    profile.boxing().setUIValue(profile.$tempValue, true,null,'set');
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    var p = profile.properties,
                        instance = profile.boxing();
                    if(p.disabled||p.readonly)return;
                    if(false===instance.beforeClose(profile, src)) return;
                    instance.destroy(true);
                }
            },
            PRE:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'m',-1));
                }
            },
            NEXT:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'m',1));
                }
            },
            PRE2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'y',-1));
                }
            },
            NEXT2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'y',1));
                }
            },
            TPRE:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'n',-1));
                }
            },
            TNEXT:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'n',1));
                }
            },
            TPRE2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'h',-1));
                }
            },
            TNEXT2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    profile.box._to(profile,xui.Date.add(profile.$tempValue,'h',1));
                }
            },
            YEAR:{
                beforeMousedown:function(profile, e, src){
                    return profile.box._ondown(profile,e,src,10);
                },
                onDrag:function(profile, e, src){
                    var count,off = xui.DragDrop.getProfile().offset;
                    count=parseInt(profile.$year,10)+parseInt(off.x/10,10);
                    if(profile.$temp!=count){
                        profile.$temp2=parseInt(off.x/10,10);
                        profile.getSubNode('YEAR').html(count,false);
                    }
                },
                onDragstop:function(profile, e, src){
                    return profile.box._onds(profile,e,src,'y');
                }
            },
            MONTH:{
                beforeMousedown:function(profile, e, src){
                    return profile.box._ondown(profile,e,src,20);
                },
                onDrag:function(profile, e, src){
                    var count,off = xui.DragDrop.getProfile().offset;
                    count=parseInt(profile.$month,10)+(parseInt(off.x/20,10)%12);
                    count=(count%12+12)%12;
                    if(profile.$temp!=count){
                        profile.$temp=count;
                        profile.$temp2=count-profile.$month+1;
                        profile.getSubNode('MONTH').html(((count+1)<=9?"0":"")+(count+1),false);
                    }
                },
                onDragstop:function(profile, e, src){
                    return profile.box._onds(profile,e,src,'m');
                }
            },
            DAY:{
                beforeMousedown:function(profile, e, src){
                    return profile.box._ondown(profile,e,src,10);
                },
                onDrag:function(profile, e, src){
                    var date=new Date(profile.$year,profile.$month,0),
                        days=date.getDate();

                    var p=profile.properties,
                        count,
                        off = xui.DragDrop.getProfile().offset;
                    count=parseInt(profile.$day,10)+(parseInt(off.x/10,10)%days);
                    count=(count%days+days)%days + 1;
                    if(profile.$temp!=count){
                        profile.$temp=count;
                        profile.$temp2=count-profile.$day;
                        profile.getSubNode('DAY').html((count<=9?"0":"")+count,false);
                    }
                },
                onDragstop:function(profile, e, src){
                    return profile.box._onds(profile,e,src,'d');
                }
            },
            HOUR:{
                beforeMousedown:function(profile, e, src){
                    return profile.box._ondown(profile,e,src,20);
                },
                onDrag:function(profile, e, src){
                    return profile.box._ondrag(profile,20,24,'HOUR',profile.$hour);
                },
                onDragstop:function(profile, e, src){
                    return profile.box._onds(profile,e,src,'h');
                }
            },
            MINUTE:{
                beforeMousedown:function(profile, e, src){
                    return profile.box._ondown(profile,e,src,10);
                },
                onDrag:function(profile, e, src){
                    return profile.box._ondrag(profile,10,60,'MINUTE',profile.$minute);
                },
                onDragstop:function(profile, e, src){
                    return profile.box._onds(profile,e,src,'n');
                }
            }
        },
        DataModel:{
            timeInput:{
                ini:false,
                action:function(v){
                    this.getSubNode('CAPTION').css('display',v?'none':'block');
                    this.getSubNode('SET').css('display',v?'block':'none');
                    this.getSubNode('TIME').css('display',v?'block':'none');
                    this.getSubNode('TODAY').attr("title",xui.getRes(v?"inline.now":"inline.today"));
                }
            },
            height:{
                $spaceunit:1,
                ini:'auto',
                readonly:true
            },
            width:{
                $spaceunit:1,
                ini:'auto',
                readonly:true
            },
            value:{
                ini:new Date,
                format:'date'
            },
            closeBtn:{
                ini:true,
                action:function(v){
                    this.getSubNode('CLOSE').css('display',v?'':'none');
                }
            },
            firstDayOfWeek:{
                ini:0,
                action:function(){
                    this.boxing().refresh();
                }
            },
            offDays:{
                ini:'60',
                action:function(){
                    this.boxing().refresh();
                }
            },
            hideWeekLabels:{
                ini:false,
                action:function(){
                    this.boxing().refresh();
                }
            },
            dateInputFormat:{
                ini:"yyyy-mm-dd",
                listbox:["yyyy-mm-dd","mm-dd-yyyy","dd-mm-yyyy"],
                action:function(){
                    this.boxing().refresh();
                }
            }
        },
        EventHandlers:{
            beforeClose:function(profile, src){}
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            var nodisplay='display:none';
            data.closeDisplay = data.closeBtn?'':nodisplay;
            
            var none="display:none;";
            if(profile.properties.timeInput){
                data._todaytitle=xui.getRes("inline.now");
                data._nocap=none;
            }else{
                data._todaytitle=xui.getRes("inline.today");
                data._timectrl=none;
            }
            data._set = xui.wrapRes('inline.set');

            return data;
        },
        _ensureValue:function(profile, value){
            var d;
            if(value){
                if(xui.isDate(value))
                    d=value;
                else if(xui.isFinite(value))
                    d=new Date(parseInt(value,10));
            }
            d = d||new Date;
            if(!profile.properties.timeInput)
                d=xui.Date.getTimSpanStart(d,'d');
            return d;
        },
        RenderTrigger:function(){
            var self=this, p=self.properties, o=self.boxing(), b=self.box;
            b._setWeekLabel(self);
            
            var hash={yyyy:'YEAR',mm:'MONTH',dd:'DAY'},arr=p.dateInputFormat.split('-');
            if(hash[arr[0]] && hash[arr[1]] && hash[arr[2]]){
                self.getSubNode('YTXT').addPrev(self.getSubNode(hash[arr[0]]));
                self.getSubNode('MTXT').addPrev(self.getSubNode(hash[arr[1]]));
                self.getSubNode('MTXT').addNext(self.getSubNode(hash[arr[2]]));
            }
            
//            self.getSubNode('YTXT').html(xui.wrapRes('date.Y'),false);
//            self.getSubNode('MTXT').html(xui.wrapRes('date.M'),false);
        },
        _getWeekNodes:function(profile){
            return profile.$weeks || (profile.$weeks=profile.getSubNode('W',true));
        },
        _getTDNodes:function(profile){
            return profile.$tds || (profile.$tds=profile.getSubNode('TD',true));
        },
        _getLabelNodes:function(profile){
            return profile.$days || (profile.$days=profile.getSubNode('TD',true));
        },
        _getHeaderNodes:function(profile){
            return profile.$header || (profile.$header=profile.getSubNode('H',true));
        },
        _setWeekLabel:function(profile){
            var p=profile.properties;

            // for week
            var fw=p.firstDayOfWeek,
                f=function(id){
                id=profile.getSubId(id); 

                // The special one
                if(id=='7')return id;
                
                id=(parseInt(id,10)+fw);
                return id<7?id:(id-7);
            };

            profile.box._getHeaderNodes(profile).each(function(node,i){
                node.innerHTML=xui.wrapRes('date.WEEKS.'+f(node.id))
            });
            
            // for weeklable
            if(p.hideWeekLabels){
                profile.getSubNode('BODY').query('TR').first().remove();
                profile.getSubNode('COL').first().remove();
            }

            // for free days            
            var cls2="xui-uicell-alt",
                fdmap={};
            if(p.offDays){
                xui.arr.each(p.offDays.split(""),function(i){
                    i=parseInt(i,10);
                    if(i>=0 && i<=6)
                        fdmap[i]=1;
                });
                profile.box._getTDNodes(profile).each(function(node,i){
                    i = ((i+fw) - 7*parseInt((i+fw)/7,10)) ;
                    if(fdmap[i])node.className=node.className + " " +cls2;
                    else node.className=node.className.replace(cls2,"");
                });
            }
            
        },
        _setBGV:function(profile, v, m){
            var date=xui.Date,
                p=profile.properties,
                daymap=profile.$daymap||(profile.$daymap=[]),
                t,n;
            profile.box._getLabelNodes(profile).each(function(node,i){
                n=date.add(v,'d',i);
                daymap[i]=n;
                t=date.get(n,'m')==m?'#':'<p class="xui-node xui-node-p xui-ui-readonly xui-custom {comcls}">#</p>';
                n=date.get(n,'d');
                node.innerHTML = t.replace('#',n);
            });

            if(!p.hideWeekLabels)
                profile.box._getWeekNodes(profile).each(function(node,i){
                    node.innerHTML=date.get(date.add(v,'ww',i),'ww',p.firstDayOfWeek);
                });
        },
        _to:function(profile, time, force){
            var p = profile.properties,
                fw = p.firstDayOfWeek,
                date=xui.Date,
                keys=profile.keys,
                uiv=p.$UIvalue,
                index=-1,
                node,
                temp,
                _realstart = date.getTimSpanStart(date.getTimSpanStart(time,'m'),'ww',1,fw),
                m=date.get(time,'m',fw);

            profile.$tempValue=time;
            this._setBGV(profile, profile._realstart=_realstart, m);

            //remove checked css class
            if(profile.$selnode)
                profile.$selnode.tagClass('-checked',false);
            //[[add cecked css class
            xui.arr.each(profile.$daymap,function(o,i){
                if(date.get(o,'m',fw)+'-'+date.get(o,'d',fw)==date.get(time,'m',fw)+'-'+date.get(time,'d',fw)){
                    index=i;
                    return false;
                }
            });
            node=this._getTDNodes(profile).get()[index];
            (profile.$selnode=xui([node]).tagClass('-checked'));
            //]]
            
            //[[ show dirty
            profile.getSubNode('SET').css('display',(force||uiv.getTime()==time.getTime())?'none':'block');
            profile.getSubNode('CAPTION').css('color',(force||uiv.getTime()==time.getTime())?'':'#ff0000');
            //]]

            temp=date.get(time,'y',fw);
            if(profile.$year!=temp){
                profile.$year=temp;
                profile.getSubNode('YEAR').html(temp,false);
            }
            temp=date.get(time,'m',fw)+1;
            if(profile.$month!=temp){
                profile.$month=temp;
                profile.getSubNode('MONTH').html((temp<=9?"0":"")+temp,false);
            }
            temp=date.get(time||time,'d',fw);
            if(profile.$day!=temp){
                profile.$day=temp;
                profile.getSubNode('DAY').html((temp<=9?"0":"")+temp,false);
            }
            temp=date.get(time,'h',fw);
            if(profile.$hour!=temp){
                profile.$hour=temp;
                profile.getSubNode('HOUR').html((temp<=9?"0":"")+temp,false);
            }
            temp=date.get(time,'n',fw);
            if(profile.$minute!=temp){
                profile.$minute=temp;
                profile.getSubNode('MINUTE').html((temp<=9?"0":"")+temp,false);
            }
        },
        _ondown:function(profile, e, src,increment){
            if(xui.Event.getBtn(e)!="left")return;
            xui.use(src).startDrag(e, {
                dragType:'blank',
                targetReposition:false,
                widthIncrement:increment,
                dragCursor:true
            });
            profile.$temp=profile.$temp2=0;
        },
        _ondrag:function(profile,increment,max,key,data){
            var p=profile.properties,
                count,
                off = xui.DragDrop.getProfile().offset;
            count=parseInt(data,10)+(parseInt(off.x/increment,10)%max);
            count=(count%max+max)%max;
            if(profile.$temp!=count){
                profile.$temp=count;
                profile.$temp2=count-data;
                profile.getSubNode(key).html((count<=9?"0":"")+count,false);
            }
        },
        _onds:function(profile, e, src, type){
            if(profile.$temp2){
                var p=profile.properties,
                    v = xui.Date.add(profile.$tempValue,type,profile.$temp2);
                profile.box._to(profile,v);
            }
            profile.$temp=profile.$temp2=0;
        },
        _onresize:function(){}
    }
});xui.Class('xui.UI.TimePicker', ['xui.UI',"xui.absValue"], {
    Dependencies:['xui.Date'],
    Instance:{
        activate:function(){
            this.getSubNode('PRE').focus(true);
            return this;
        },
        _setCtrlValue:function(value){
            return this.each(function(profile){
                if(!profile.renderId)return;

                var cls = profile.box,
                    arr2=cls._v2a(value);
                profile.$hour=arr2[0];
                profile.$minute=arr2[1];
                
                profile.getSubNode('HI',true).removeClass(cls._excls_c3).removeClass(cls._excls_mo3);
                profile.getSubNode('HI',arr2[0]).addClass(cls._excls_c3);

                profile.getSubNode('MI',true).removeClass(cls._excls_c).removeClass(cls._excls_mo);
                profile.getSubNode('MI',arr2[1]).addClass(cls._excls_c);

                profile.getSubNode('HOUR').html(arr2[0],false);
                profile.getSubNode('MINUTE').html(arr2[1],false);
                profile.getSubNode('CAPTION').html(profile.box._showV(profile,profile.box._v2a(arr2)),false);
            });
        }
    },
    Initialize:function(){
        this.addTemplateKeys(['HI','MI']);

        var a,i,h,m,cls,cls2,id,t;

        cls=this._excls3;
        cls2=this._excls4;
        id=xui.UI.$ID;
        t='<span id="'+this.KEY+'-HI:'+id+':@" class="xui-node xui-node-span '+cls+' !" '+xui.$IEUNSELECTABLE()+' >@</span>';
        a=[];
        for(i=0;i<24;i++){
            a[a.length]=t.replace(/@/g,i<10?('0'+i):i).replace('!',((i%6===0)?cls2:'')+" xui-custom {comcls}");
             if(i+1==12)a[a.length]='<br />';
        }
        h=a.join('');
        a.length=0;

        cls=this._excls;
        cls2=this._excls2;
        id=xui.UI.$ID;
        t='<span id="'+this.KEY+'-MI:'+id+':@" class="xui-node xui-node-span '+cls+' !" '+xui.$IEUNSELECTABLE()+' >@</span>';
        a=[];
        for(i=0;i<60;i++){
            a[a.length]=t.replace(/@/g,i<10?('0'+i):i).replace('!',((i%5===0)?cls2:'') +" xui-custom {comcls}");
            if((i+1) % 10 ===0 && i!=59 )a[a.length]='<br />';
        }
        m=a.join('');
        a.length=0;
        
        this.setTemplate({
            tagName : 'div',
            onselectstart:'return false',
            style:'{_style};height:auto;',
            BORDER:{
                tagName : 'div',
                className: 'xui-uiborder-outset xui-uiborder-box xui-uiborder-radius-big',
                BART:{
                    tagName:'div',
                    className:'xui-uibar-top',
                    style:'{barDisplay};',
                    BARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-tl',
                        BARTDLT:{
                            className:'xui-uibar-tdlt'
                        }
                    },
                    BARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar',
                        BARTDMT:{
                            className:'xui-uibar-tdmt'
                        }
                    },
                    BARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-tr',
                        BARTDRT:{
                            className:'xui-uibar-tdrt'
                        }
                    },
                    BARCMDL:{
                        $order:3,
                        tagName: 'div',
                        className:'xui-uibar-cmdl',
                        PRE2:{
                            $order:0,
                            className:'xuifont',
                            $fonticon:'xui-icon-doubleleft',                                                        
                            tabindex: '{tabindex}'
                        },
                        PRE:{
                            $order:1,
                            className:'xuifont',
                            $fonticon:'xui-icon-singleleft',                                                        
                            tabindex: '{tabindex}'
                        },
                        HOUR:{
                            $order:2,
                            className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                        },
                        MTXT:{$order:3,text:':'},
                        MINUTE:{
                                $order:4,
                                className:'xui-ui-draggable xui-uibase xui-uiborder-flat xui-uiborder-radius'
                            },
                        NEXT:{
                            $order:6,
                            className:'xuifont',
                            $fonticon:'xui-icon-singleright',                            
                            tabindex: '{tabindex}'
                        },
                        NEXT2:{
                            $order:7,
                            className:'xuifont',
                            $fonticon:'xui-icon-doubleright',                            
                            tabindex: '{tabindex}'
                        }
                    },
                    BARCMDR:{
                        $order:4,
                        tagName: 'div',
                        className:'xui-uibar-cmdr',
                        CLOSE:{
                            className:'xuifont',
                            $fonticon:'xui-uicmd-close',
                            style:'{closeDisplay}'
                        }
                    },
                    TBARTDB:{
                        $order:5,
                        tagName: 'div',
                        className:'xui-uibar-tdb xui-uiborder-inset xui-uiborder-radius'
                    }
                },
                MAIN:{
                    $order:2,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    MAINI:{
                        tagName:'div',
                        className:'xui-uibar xui-uicon-maini xui-uibar',
                        CONH:{
                            tagName:'div',
                            className:'xui-uibase xui-uiborder-flat',
                            text:h
                        },
                        CONM:{
                            $order:2,
                            tagName:'div',
                            className:'xui-uibase xui-uiborder-flat',
                            text:m
                        }
                    }
                },
                TAIL:{
                    $order:3,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    TAILI:{
                        tagName:'div',
                        className:'xui-uibar xui-uicon-maini',
                        CAPTION:{
                            text : '{caption}'
                        },
                        SET:{
                            tagName:'button',
                            className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                            tabindex: '{tabindex}',
                            text:"{_set}"
                        }
                    }
                },
                BBAR:{
                    $order:4,
                    tagName:'div',
                    className:'xui-uibar-bottom-s',
                    BBARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-bl'
                    },
                    BBARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar'
                    },
                    BBARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-br'
                    }
                }
            }
        });
    },
    Static:{
        _excls:'xuiex-timepicker xui-uicell',
        _excls2:'xuiex-timepicker xui-uicell xui-uicell-alt ',
        _excls3:'xuiex-timepicker3 xui-uicell',
        _excls4:'xuiex-timepicker xui-uicell xui-uicell-alt',

        _excls_mo:'xui-uicell-hover',
        _excls_c:'xui-uicell-checked',
        _excls_mo3:'xui-uicell-hover',
        _excls_c3:'xui-uicell-checked',
        _mover:function(src, type){
            var b=this,cn=src.className;
            if(type==2){
                if(cn.indexOf(b._excls_mo3)==-1)
                    src.className=cn + ' ' + b._excls_mo3;
            }else{
                if(cn.indexOf(b._excls_mo)==-1)
                    src.className=cn + ' ' + b._excls_mo;
            }
            src=null;
        },
        _mout:function(src,type){
            var b=this,cn=src.className;
            if(type==2){
                if(cn.indexOf(b._excls_mo3)!=-1)
                    src.className=cn.replace(b._excls_mo3,'');
            }else{
                if(cn.indexOf(b._excls_mo)!=-1)
                    src.className=cn.replace(b._excls_mo,'');
            }
            src=null;
        },
        Appearances:{
            KEY:{
            },
            'TBART, BBART':{
                'border-spacing':0,
                'border-collapse':'separate'
            },
            MAINI:{
                'padding':'.5em .3333em .3333em 0'
            },
            CONH:{
                'white-space': 'nowrap',
                'text-align':'center'
            },
            CONM:{
                'margin-top':'.5em',
                'white-space': 'nowrap',
                'text-align':'center'
            },
            BARCMDL:{
                top:'.125em'
            },
            'PRE,PRE2,NEXT,NEXT2':{
                position:'relative',
                margin:'0 .25em',
                'vertical-align': 'middle',
                cursor:'default'
            },
            'HOUR, MINUTE':{
                $order:3,
                'font-weight':'bold',
                'vertical-align': 'middle',
                cursor:'e-resize',
                margin:'0 .25em',
                'padding':'0 .25em'
            },
            SET:{
                position:'absolute',
                display:'none',
                top:'.125em',
                right:'.5em'
            },
            TAILI:{
                position:'relative',
                padding:'.5em 0 0 0',
                'text-align':'center'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            },
            '.xuiex-timepicker':{
                width:'2em',
                'text-align':'center',
                padding:'.25em 0',
                margin:0
            },
            '.xuiex-timepicker3':{
                width:'1.6666em',
                'text-align':'center',
                'font-weight':'bold',
                padding:'.25em 0',
                margin:0
            }
        },
        Behaviors:{
            HoverEffected:{CLOSE:'CLOSE',PRE:'PRE',NEXT:'NEXT',PRE2:'PRE2',NEXT2:'NEXT2',SET:'SET'},
            ClickEffected:{CLOSE:'CLOSE',PRE:'PRE',NEXT:'NEXT',PRE2:'PRE2',NEXT2:'NEXT2',SET:'SET'},
            KEY:{onClick:function(){return false}},
            HOUR:{
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    xui(src).startDrag(e, {
                        dragType:'blank',
                        targetReposition:false,
                        widthIncrement:5,
                        dragCursor:true
                    });
                    profile.$temp2=0;
                },
                onDrag:function(profile, e, src){
                    var count,off = xui.DragDrop.getProfile().offset,v=profile.properties.$UIvalue,a=v.split(':');
                    a[0]=Math.round( (parseFloat(a[0])||0)+parseInt(off.x/10) );
                    a[0]=(a[0]%24+24)%24;
                    profile.$temp2=(a[0]<=9?'0':'')+a[0];

                    if(v[0]!=profile.$temp2)
                        profile.getSubNode('HOUR').html(profile.$temp2,false);
                },
                onDragstop:function(profile, e, src){
                    if(profile.$temp2){
                        profile.$hour=profile.$temp2;
                        profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    }
                    profile.$temp2=0;
                    profile.box._hourC(profile);
                }
            },
             MINUTE:{
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    xui(src).startDrag(e, {
                        dragType:'blank',
                        targetReposition:false,
                        widthIncrement:5,
                        dragCursor:true
                    });
                    profile.$temp2=0;
                },
                onDrag:function(profile, e, src){
                    var count,off = xui.DragDrop.getProfile().offset,v=profile.properties.$UIvalue,a=v.split(':');
                    a[0]=Math.round( (parseFloat(a[0])||0) + parseFloat(off.x/20) );
                    a[0]=(a[0]%60+60)%60;
                    profile.$temp2=(a[0]<=9?'0':'')+a[0];

                    if(v[0]!=profile.$temp2)
                        profile.getSubNode('MINUTE').html(profile.$temp2,false);
                },
                onDragstop:function(profile, e, src){
                    if(profile.$temp2){
                        profile.$minute=profile.$temp2;
                        profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    }
                    profile.$temp2=0;
                    profile.box._hourC(profile);
                }
            },
            SET:{
                onClick:function(profile){
                    var pro=profile.properties,
                        v=pro.$UIvalue,
                        a=v.split(':');
                    a[0]=profile.$hour;
                    a[1]=profile.$minute;
                    profile.boxing().setUIValue(a.join(':'),true,null,'click');
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            HI:{
                onMouseover:function(profile, e, src){
                    if(profile.properties.disableHoverEffect)return;
                    profile.box._mover(xui.use(src).get(0),2);
                },
                onMouseout:function(profile, e, src){
                    if(profile.properties.disableHoverEffect)return;
                    profile.box._mout(xui.use(src).get(0),2);
                },
                onClick:function(profile, e, src){
                    profile.$hour=profile.getSubId(src);
                    profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    if(profile.box)profile.box._hourC(profile);
                },
                onDblclick:function(profile, e, src){
                    profile.$hour=profile.getSubId(src);
                    profile.boxing().setUIValue(profile.$hour+":"+profile.$minute,true,null,'dblclick');
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            MI:{
                onMouseover:function(profile, e, src){
                    if(profile.properties.disableHoverEffect)return;
                    profile.box._mover(xui.use(src).get(0));
                },
                onMouseout:function(profile, e, src){
                    if(profile.properties.disableHoverEffect)return;
                    profile.box._mout(xui.use(src).get(0));
                },
                onClick:function(profile, e, src){
                    profile.$minute=profile.getSubId(src);
                    profile.boxing().setUIValue(profile.$hour+":"+profile.$minute,true,null,'click2');
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            PRE:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    var v=profile.$minute;
                    v=(parseFloat(v)||0)-1;
                    v=(v%60+60)%60;
                    profile.$minute=v=(v<=9?'0':'')+v;
                    profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            NEXT:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    var v=profile.$minute;
                    v=(parseFloat(v)||0)+1;
                    v=(v%60+60)%60;
                    profile.$minute=v=(v<=9?'0':'')+v;
                    profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            PRE2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    var v=profile.$hour;
                    v=(parseFloat(v)||0)-1;
                    v=(v%24+24)%24;
                    profile.$hour=v=(v<=9?'0':'')+v;
                    profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            NEXT2:{
                onClick:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled||p.readonly)return;
                    var v=profile.$hour;
                    v=(parseFloat(v)||0)+1;
                    v=(v%24+24)%24;
                    profile.$hour=v=(v<=9?'0':'')+v;
                    profile.boxing()._setCtrlValue(profile.$hour+":"+profile.$minute);
                    if(profile.box)profile.box._hourC(profile);
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        instance = profile.boxing();
                    if(properties.disabled||properties.readonly)return;
                    if(false===instance.beforeClose(profile, src)) return;
                    instance.destroy(true);
                }
            }
        },
        DataModel:{
            height:{
                ini:'auto',
                readonly:true
            },
            width:{
                ini:'auto',
                readonly:true
            },
            value:{
                ini:'00:00',
                format:'time'
            },
            closeBtn:{
                ini:true,
                action:function(v){
                    this.getSubNode('CLOSE').css('display',v?'':'none');
                }
            }
        },
        EventHandlers:{
            beforeClose:function(profile, src){}
        },
        _hourC:function(profile){
            var pro=profile.properties,
                v=pro.$UIvalue,
                a=v.split(':'),
                d = (a[0]+"")==(profile.$hour+"") && (a[1]+"")==(profile.$minute+"");
            profile.getSubNode('SET').css('display',d?'none':'block');
            profile.getSubNode('CAPTION').css('color',d?'':'#ff0000');
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            var nodisplay='display:none';
            data.closeDisplay = data.closeBtn?'':nodisplay;
            data._set = xui.wrapRes('inline.set');
            return data;
        },
//        RenderTrigger:function(){
//            this.getSubNode('HOURTXT').html(xui.wrapRes('date.H'),false);
//        },
        _ensureValue:function(profile, value){
            var a,b=[];
            if(value&& typeof value == 'string')
                a=value.split(':')
            else if(value && typeof value=='object' && xui.isArr(value))
                a=value;
            else a=[];

            b[0]= parseFloat(a[0])||0;
            b[1]=parseFloat(a[1])||0;
            if(b[0]<0)b[0]=0;
            if(b[0]>23)b[0]=23;
            if(b[1]<0)b[1]=0;
            if(b[1]>59)b[1]=59;

            b[0]=(b[0]<=9?'0':'')+b[0];
            b[1]=(b[1]<=9?'0':'')+b[1];

            return b.join(':');
        },
        formatValue:function(value){
            return value.join(':');
        },
        _v2a:function(v){
            return typeof v == 'string'? v.split(':') : v;
        },
        _showV:function(profile, a){
            var f=profile.CF;
            if(typeof f.formatCaption == 'function')
                return f.formatCaption(a);
            else
                return a.join(':');
        },
        _onresize:function(){}
    }
});xui.Class("xui.UI.List", ["xui.UI", "xui.absList","xui.absValue" ],{
    Instance:{
        _setCtrlValue:function(value){
            return this.each(function(profile){
                if(!profile.renderId)return;

                var box=profile.box,
                    uiv=profile.boxing().getUIValue(),
                    p=profile.properties,
                    item=box._ITEMKEY || 'ITEM',
                    k=box._DIRTYKEY || 'ITEM',
                    mk='MARK',
                    getN=function(k,i){return profile.getSubNode(k,i)},
                    getI=function(i){return profile.getSubIdByItemId(i)};
                if(p.selMode=='single'){
                    var itemId = getI(uiv);
                    if(uiv!==null && itemId){
                        getN(item,itemId).tagClass('-checked',false).tagClass('-hover',false);
                        getN(mk, itemId).tagClass('-checked',false); 
                    }

                    itemId = getI(value);
                    if(itemId){
                        getN(item,itemId).tagClass('-checked');
                        getN(mk,itemId).tagClass('-checked');
                    }

                    //scroll
                    if(itemId){
                        var o = getN(item,itemId);
                        if(o){
                            var items = profile.getSubNode('ITEMS'),
                                offset = o.offset(null, items),
                                top = offset?offset.top:0,
                                height = o.offsetHeight(),
                                sh=items.scrollHeight(),
                                st=items.scrollTop(),
                                hh=items.height();
                            if(sh > hh)
                                if(top<st || (top+height)>(st+hh))
                                    items.scrollTop(top);
                        }
                    }
                }else if(p.selMode=='multi'||p.selMode=='multibycheckbox'){
                    uiv = uiv?uiv.split(p.valueSeparator):[];
                    value = value?value.split(p.valueSeparator):[];
                    //check all
                    xui.arr.each(uiv,function(o){
                        getN(item, getI(o)).tagClass('-checked',false).tagClass('-hover',false);
                        getN(mk, getI(o)).tagClass('-checked',false); 
                    });
                    xui.arr.each(value,function(o){
                        getN(item, getI(o)).tagClass('-checked');
                        getN(mk, getI(o)).tagClass('-checked');
                    });
                }
            });
        },
        _clearMouseOver:function(){
            var box=this.constructor,
                item=box._ITEMKEY || 'ITEM';
            this.getSubNode(item, true).tagClass('-hover',false);
        },
        adjustSize:function(){
            return this.each(function(profile){
                var root = profile.getRoot(),
                    items = profile.getSubNode('ITEMS'),
                    pp=profile.properties,
                    mh=pp.maxHeight,
                    h_em=profile.$isEm(pp.height),
                    h,flag;

                if(profile.$isEm(mh))mh=profile.$em2px(mh, items,true);

                if(root.css('display')=='none'){
                    flag=1;
                    root.css('visibility','hidden');
                }
                items.height('auto');
                if(profile.properties.height!='auto'){
                    h=Math.min(mh, items.offsetHeight());                    
                    if(h_em)h=profile.$px2em(h, items)+'em';
                    items.height(pp.height=h);
                }else{
                    h=items.offsetHeight();
                    if(h>mh){
                        items.height(pp.maxHeight);
                        profile.getRoot().height(pp.maxHeight);
                    }
                }
                if(flag){
                    root.css('visibility','');
                    root.css('display','none');
                }
                profile.getRoot().height('auto');
            });
        },
        activate:function(){
            return xui.absList.prototype.activate.call(this);
        },
        getShowValue:function(value){
            var profile=this.get(0),
                pro=profile.properties,v,t;
            if(!xui.isDefined(value))
                value=pro.$UIvalue;
            if( (v=xui.arr.subIndexOf(pro.items,'id',value))!=-1){
                v=pro.items[v].caption;
                v=v.charAt(0)=='$'?xui.getRes(v.slice(1)):v;
            }else
                v='';
            return v;
        },
        _setDirtyMark:function(){
            return arguments.callee.upper.apply(this,['ITEMS']);
        }
    },
    Static:{
        _DIRTYKEY:'ITEM',
        Templates:{
            tagName : 'div',
            style:'{_style}',
            className:'{_className}',
            LABEL:{
                className:'{_required} xui-ui-ellipsis',
                style:'{labelShow};width:{_labelSize};{labelHAlign}',
                text:'{labelCaption}'
            },
            ITEMS:{
               $order:10,
               tagName:'div',
               className:'xui-uibase {_cmdsalign} {_bordertype} {_itemscls1}',
               text:"{items}"
            },
            $submap:{
                items:{
                    ITEM:{
                        className:'xui-uitembg xui-uiborder-radius xui-showfocus {_itemRow} {_split} {itemClass} {disabled} {readonly}',
                        style:'{itemStyle}{_itemDisplay}',
                        tabindex:'{_tabindex}',
                        LTAGCMDS:{
                            $order:2,
                            tagName:'span',
                            style:'{_ltagDisplay}',
                            text:"{ltagCmds}"
                        },
                        MARK:{
                            $order:5,
                            className:'xuifont',
                            $fonticon:'xui-uicmd-check',
                            style:"{_cbDisplay}"
                        },
                        ICON:{
                            $order:10,
                            className:'xuicon {imageClass}  {picClass}',
                            style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                            text:'{iconFontCode}'
                        },
                        CAPTION:{
                            style:'{_capDisplay}',
                            text : '{caption}',
                            $order:20
                        },
                        EXTRA:{
                            style:'{_extraDisplay}',
                            text : '{ext}',
                            $order:30
                        },
                        RTAGCMDS:{
                            $order:40,
                            tagName:'span',
                            style:'{_rtagDisplay}',
                            text:"{rtagCmds}"
                        },
                        OPT:{
                            $order:50,
                            style:'{_optDisplay}',
                            className:'xuifont',
                            $fonticon:'{_fi_optClass}'
                        }
                    }
                },
                'items.ltagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.rtagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.tagCmds.text':xui.UI.$getTagCmdsTpl('text'),
                'items.tagCmds.button':xui.UI.$getTagCmdsTpl('button'),
                'items.tagCmds.image':xui.UI.$getTagCmdsTpl('image')
            }
        },
        Appearances:{
            KEY:{
            },
            LABEL:{
               'z-index':1,
               top:0,
               left:0,
               position:'absolute',
               'padding-top':'.333em'
            },
            EXTRA:{
                display:'none'
            },
            ITEMS:{
                position:'relative',
                overflow:'auto',
                'overflow-x': 'hidden'
            },
            ITEM:{
                display:'block',
                zoom:xui.browser.ie?1:null,
                cursor:'pointer',
                position:'relative',
                'white-space': 'nowrap'
            },
            MARK:{
               $order:1,
               cursor:'pointer',
               'vertical-align':'middle'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                padding:'.167em',
                'font-size':'1em',
                'white-space': 'normal'
            },
            OPT:{
                $order:10,
                position:'absolute',
                left:'auto',
                top:'50%',
                'margin-top':'-0.5em',
                right:'.167em',
                display:'none'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            'ITEMS-tagcmdleft RTAGCMDS':{
                "padding-right":'.333em',
                "float":"left"
            },
            'ITEMS-tagcmdfloatright RTAGCMDS':{
                "padding-right":'.333em',
                "float":"right"
            }
        },
        Behaviors:{
            HoverEffected:{ITEM:'ITEM', OPT:'OPT',CMD:'CMD',ICON:'ICON'},
            ClickEffected:{ITEM:'ITEM', OPT:'OPT',CMD:'CMD'},
            DraggableKeys:["ITEM"],
            DroppableKeys:["ITEM","ITEMS"],
            onSize:xui.UI.$onSize,
            ITEM:{
                onDblclick:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src);
                    profile.boxing().onDblclick(profile, item, e, src);
                },
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId =profile.getSubId(src),
                        box = profile.boxing(),
                        ks=xui.Event.getKey(e);

                    if(profile.beforeClick && false===box.beforeClick(profile,item,e,src))return false;

                    if(properties.disabled||item.disabled || item.type=='split')return false;

                    if(profile.onClick)
                        box.onClick(profile,item,e,src);

                    xui.use(src).focus(true);

                    switch(properties.selMode){
                    case 'none':
                        box.onItemSelected(profile, item, e, src, 0);
                        break;
                    case 'multibycheckbox':
                        if(properties.readonly|| item.readonly)return false;
                        if(profile.keys.MARK){
                            if(profile.getKey(xui.Event.getSrc(e).id||"")!=profile.keys.MARK){
                                box.onItemSelected(profile, item, e, src, 0);
                                break;
                            }
                        }
                    case 'multi':
                        if(properties.readonly|| item.readonly)return false;
                        var value = box.getUIValue(),
                            arr = value?value.split(properties.valueSeparator):[],
                            checktype=1;

                        if(arr.length&&(ks.ctrlKey||ks.shiftKey||properties.noCtrlKey||properties.$checkbox)){
                            //for select
                            if(ks.shiftKey){
                                var items=properties.items,
                                    i1=xui.arr.subIndexOf(items,'id',profile.$firstV.id),
                                    i2=xui.arr.subIndexOf(items,'id',item.id),
                                    i;
                                arr.length=0;
                                for(i=Math.min(i1,i2);i<=Math.max(i1,i2);i++)
                                    arr.push(items[i].id);
                            }else{
                                if(xui.arr.indexOf(arr,item.id)!=-1){
                                    xui.arr.removeValue(arr,item.id);
                                    checktype=-1
                                }else
                                    arr.push(item.id);
                            }

                            arr.sort();
                            value = arr.join(properties.valueSeparator);

                            //update string value only for setCtrlValue
                            if(box.getUIValue() !== value){
                                box.setUIValue(value,null,null,'click');
                                if(box.get(0) && box.getUIValue() == value)
                                    box.onItemSelected(profile, item, e, src, checktype);
                            }
                            break;
                        }
                    case 'single':
                        if(properties.readonly|| item.readonly)return false;
                        if(box.getUIValue() !== item.id){
                            profile.$firstV=item;
                            box.setUIValue(item.id,null,null,'click');
                            if(box.get(0) && box.getUIValue() == item.id)
                                box.onItemSelected(profile, item, e, src, 1);
                        }

                        break;
                    }
                    if(profile.afterClick)box.afterClick(profile,item,e,src);
                },
                onKeydown:function(profile, e, src){
                    var keys=xui.Event.getKey(e), key = keys[0], shift=keys[2],
                    cur = xui(src),
                    first = profile.getRoot().nextFocus(true, true, false),
                    last = profile.getRoot().nextFocus(false, true, false);

                    switch(xui.Event.getKey(e)[0]){
                        case 'tab':
                            if(shift){
                                if(cur.get(0)!=first.get(0)){
                                    first.focus(true);
                                    return false;
                                }
                            }else{
                                if(cur.get(0)!=last.get(0)){
                                    last.focus(true);
                                    return false;
                                }
                            }
                            break;
                        case 'left':
                        case 'up':
                            var next = cur.nextFocus(false, true, false);
                            if(cur.get(0)==first.get(0))
                                last.focus(true);
                            else
                                cur.nextFocus(false);
                            return false;
                            break;
                        case 'right':
                        case 'down':
                            var next = cur.nextFocus(true, false, false);
                            if(cur.get(0)==last.get(0))
                                first.focus(true);
                            else
                                cur.nextFocus();
                            return false;
                            break;
                        case 'enter':
                            cur.onClick(true);
                            break;
                    }
                },
                onContextmenu:function(profile, e, src){
                    if(profile.onContextmenu)
                        return profile.boxing().onContextmenu(profile, e, src,profile.getItemByDom(src))!==false;
                },
                onMouseover:function(profile, e, src){
                    if(xui.browser.fakeTouch || xui.browser.deviceType == 'touchOnly')return;
                    var item = profile.getItemByDom(src);
                    if(!item)return;
                    if(!profile.properties.optBtn && !item.optBtn)return;
                    profile.getSubNode('OPT',profile.getSubId(src)).setInlineBlock();
                },
                onMouseout:function(profile, e, src){
                    if(xui.browser.fakeTouch || xui.browser.deviceType == 'touchOnly')return;
                    var item = profile.getItemByDom(src);
                    if(!item)return;
                    if(!profile.properties.optBtn && !item.optBtn)return;
                    profile.getSubNode('OPT',profile.getSubId(src)).css('display','none');
                }
            },
            OPT:{
                onClick:function(profile, e, src){
                    if(profile.onShowOptions){
                        var item = profile.getItemByDom(src);
                        if(!item)return;
                        if(!profile.properties.optBtn && !item.optBtn)return;
                        profile.boxing().onShowOptions(profile, item, e, src);
                    }
                    return false;
                },
                onDblclick:function(profile, e, src){
                    return false;
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var prop=profile.properties,
                        item=profile.getItemByDom(xui.use(src).parent().get(0));
                    if(!item)return false;

                    if(prop.disabled|| item.disabled || item.type=='split')return false;
                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,item, xui.use(src).id().split('_')[1],e,src);
                    return false;
                }
            },
            LABEL:{
                onClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelClick)
                        profile.boxing().onLabelClick(profile, e, src);
                },
                onDblClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    if(profile.onLabelDblClick)
                        profile.boxing().onLabelDblClick(profile, e, src);
                },
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    if(profile.properties.disabled)return false;
                     if(profile.onLabelActive)
                        profile.boxing().onLabelActive(profile, e, src);
                }
            }
        },
        DataModel:{
            selMode:{
                ini:'single',
                listbox:['single','none','multi','multibycheckbox'],
                action:function(value){
                    if(!this.box._ITEMMARKED)
                        this.getSubNode('MARK',true).css('display',(value=='multi'||value=='multibycheckbox')?'':'none');
                }
            },
            borderType:{
                ini:'flat',
                listbox:['none','flat','inset','outset'],
                action:function(v){
                    var ns=this,
                        p=ns.properties,
                        node=ns.getSubNode('ITEMS'),
                        reg=/^xui-uiborder-/,
                        pretag='xui-uiborder-',
                        root=ns.getRoot();
                    node.removeClass(reg);
                    node.addClass(pretag+v);

                    //force to resize
                    ns.adjustSize();
                }
            },
            noCtrlKey:true,
            width:{
                $spaceunit:1,
                ini:'10em'
            },
            height:{
                $spaceunit:1,
                ini:'15em'
            },
            maxHeight:420,
            itemRow:{
                ini:false,
                action:function(v){
                    var ns=this.getSubNode('ITEM',true);
                    if(v)ns.addClass('xui-item-row');else ns.removeClass('xui-item-row');
                }
            },
            optBtn:{
                ini:"",
                combobox:xui.toArr("xui-uicmd-opt,xui-icon-singleright"),
                action:function(){
                    this.boxing().refresh();
                }
            },
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            },
            tagCmdsAlign:{
                ini:"right",
                listbox:['left','right','floatright'],
                action:function(v){
                    var profile=this,box=profile.getSubNode("ITEMS"),cls=profile.getClass('ITEMS','-tagcmd');
                    box.removeClass(new RegExp(cls+'[\w]*')).addClass(profile.getClass('ITEMS','-tagcmd'+v));
                }
            },
            // label
            labelSize:{
                $spaceunit:2,
                ini:0,
                action: function(v){
                    this.getSubNode('LABEL').css({display:v?'':'none'});
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelPos:{
                ini:"left",
                listbox:['none','left','top', 'right', 'bottom'],
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }                
            },
            labelGap:{
                $spaceunit:2,
                ini:4,
                action: function(v){
                    xui.UI.$doResize(this,this.properties.width,this.properties.height,true);
                }
            },
            labelCaption:{
                ini:"",
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('LABEL').html(xui.adjustRes(v,true));
                }
            },
            labelHAlign:{
                ini:'right',
                listbox:['','left','center','right'],
                action: function(v){
                    this.getSubNode('LABEL').css('textAlign',v);
                }
            }
        },
        EventHandlers:{
            onClick:function(profile, item, e, src){},
            onCmd:function(profile,item,cmdkey,e,src){},
            beforeClick:function(profile, item, e, src){},
            afterClick:function(profile, item, e, src){},
            onDblclick:function(profile, item, e, src){},
            onShowOptions:function(profile, item, e, src){},
            onItemSelected:function(profile, item, e, src, type){},

            onLabelClick:function(profile, e, src){},
            onLabelDblClick:function(profile, e, src){},
            onLabelActive:function(profile, e, src){}
        },
        _onStartDrag:function(profile, e, src, pos){
            var pos=xui.Event.getPos(e);
            xui.use(src).startDrag(e, {
                dragSource:profile.$xid,
                dragType:'icon',
                shadowFrom:src,
                targetLeft:pos.left+12,
                targetTop:pos.top+12,
                dragCursor:'pointer',
                dragDefer:2,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false;
        },
        _onDropTest:function(profile, e, src, key, data, item){
            var fid=data&&data.domId, tid=xui.use(src).id();
            if(fid){
                if(fid==tid)return false;
                if(xui.get(xui.use(src).get(0),['previousSibling','id'])==fid)return false;
            }
        },
        _onDrop:function(profile, e, src, key, data, item){
            var k=profile.getKey(xui.use(src).id()),
                po=data.profile,
                ps=data.domId,
                oitem,
                t=xui.absObj.$specialChars,
                uiv=profile.properties.$UIvalue;
            //remove
            oitem=xui.clone(po.getItemByDom(ps),function(o,i){return !t[(i+'').charAt(0)]});
            po.boxing().removeItems([oitem.id]);

            if(k==profile.keys.ITEM)
                profile.boxing().insertItems([oitem], item.id, true);
            else
                profile.boxing().insertItems([oitem]);

            if(oitem.id==uiv)
                profile.boxing().setUIValue(oitem.id,true,null,'drop');
            
            data._new = oitem;
            return false;
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile),t;
            d._bordertype='xui-uiborder-'+d.borderType;
            d.labelHAlign=d.labelHAlign?("text-align:" + d.labelHAlign):"";
            d.labelShow=d.labelPos!='none'&&d.labelSize&&d.labelSize!='auto'?"":"display:none";
            d._labelSize=d.labelSize?'':0+profile.$picku();
            // adjustRes for labelCaption
            if(d.labelCaption)
                d.labelCaption=xui.adjustRes(d.labelCaption,true);
            d._cmdsalign=profile.getClass('ITEMS','-tagcmd'+profile.properties.tagCmdsAlign);
            return d;
        },
        _prepareItem:function(profile, item){
            var p=profile.properties,m=p.selMode;
            item._cbDisplay = (m=='multi'||m=='multibycheckbox')?'':'display:none;';
            item._itemRow = profile.properties.itemRow?'xui-item-row':'';

            if(xui.browser.fakeTouch || xui.browser.deviceType !== 'mouseOnly'){
                item._optDisplay = p.optBtn?'display:block;':'';
            }

            item._fi_optClass = p.optBtn;
            
            if(item.type=='split'){
                item._split='xui-uitem-split';
                item._ltagDisplay=item._rtagDisplay=item.imageDisplay=item._cbDisplay=item._capDisplay=item._extraDisplay=item._optDisplay='display:none;';
            }
            this._prepareCmds(profile, item);
        },
        RenderTrigger:function(){
            if(this.key!="xui.UI.List")return;

            var p=this.properties;
            xui.UI.$doResize(this,p.width,p.height);
        },
        _onresize:function(profile,width,height){
            var prop=profile.properties,
                // compare with px
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot(),
                cb=xui.browser.contentBox,

                f=function(k){return profile.getSubNode(k)},
                items = f('ITEMS'),
                label = f('LABEL'),

                fzrate=profile.getEmSize()/root._getEmSize(),
                itemsfz=items._getEmSize(fzrate),
                labelfz=label._getEmSize(fzrate),

                border=!cb?0:prop.borderType!='none'?items._borderW():0,
                dock=prop.dock,
                max=prop.maxHeight,

                labelPos=prop.labelPos,
                labelSize=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelSize,labelfz)||0,
                labelGap=(labelPos=='none'||!labelPos)?0:profile.$px(prop.labelGap)||0,
                ll, tt, ww, hh;

            // caculate by px
            if(width && width!='auto')width = profile.$px(width);
            if(height && height!='auto')height = profile.$px(height);

            items.cssRegion({
                left : adjustunit(ll = labelPos=='left'?labelSize:0, itemsfz),
                top : adjustunit(tt = labelPos=='top'?labelSize:0, itemsfz),
                width : adjustunit(ww = width===null?null:width=='auto'?width:Math.max(0,(width - (!cb?0:items._paddingW('both')) - ((labelPos=='left'||labelPos=='right')?labelSize:0) - border)), itemsfz),
                height : adjustunit(hh = height===null?null:height=='auto'?height:Math.max(0,(height - (!cb?0:items._paddingH('both')) - ((labelPos=='top'||labelPos=='bottom')?labelSize:0)- border)), itemsfz)
            });


            if(height=="auto"){
                if(dock!="fill"&&dock!="cover"&&dock!="height"&&dock!="left"&&dock!="right"){
                    if(items.height()>max){
                        items.height(adjustunit(max, itemsfz));
                        root.height('auto');
                    }
                }
            }
            if(labelSize){
                if(width=='auto')ww=items.offsetWidth();
                if(height=='auto')hh=items.offsetHeight();
                label.cssRegion({
                    left: adjustunit(width===null?null:Math.max(0,labelPos=='right'?((width=='auto'?ww:(width-labelSize))+labelGap):0),labelfz),
                    top:  adjustunit(height===null?null:Math.max(0,labelPos=='bottom'?((height=='auto'?hh:(height-labelSize))+labelGap):0),labelfz), 
                    width: adjustunit(width===null?null:Math.max(0,((labelPos=='left'||labelPos=='right')?(labelSize-labelGap):(width=='auto'?ww:width))),labelfz),
                    height: adjustunit(height===null?null:Math.max(0,((labelPos=='top'||labelPos=='bottom')?(labelSize-labelGap):(height=='auto'?hh:height))),labelfz)
                });
            }
        }
    }
});xui.Class("xui.UI.Gallery", "xui.UI.List",{
    Instance:{
        getStatus:function(id){
            var item=this.get(0).getItemByItemId(id);
            return (item && item._status)||'ini';
        },
        _afterInsertItems:function(profile){
            profile.getSubNodes("IMAGE",true).each(function(o){
                if(o.src==xui.ini.img_bg){
                    // bug fix for firefox
                    if(xui.browser.isFF)o.src='';
                    o.src=o.title;
                    o.title='';
                }
            });
        }
    },
    Initialize:function(){
        //modify default template fro shell
        var t = this.getTemplate();
        t.$submap={
            items:{
                ITEM:{
                    tabindex:'{_tabindex}',
                    className:'xui-uitembg xui-uiborder-radius xui-showfocus {itemClass} {disabled} {readonly}',
                    style:'padding:{itemPadding};margin:{itemMargin};{_itemSize};{itemStyle}',
                    ITEMFRAME:{
                        style:'{_inneritemSize}',
                        CAPTION:{
                            tagName : 'div',
                            className:'xui-ui-ellipsis',
                            style:'{capDisplay}',
                            text: '{caption}',
                            $order:0
                        },
                        CONTENT:{
                                tagName : 'div',
                                $order:1,
                                style:'{_loadbg}',
                                ICON:{
                                    className:'xuifont {_imageClass}',
                                    style:"{_fontSize}",
                                    text:'{iconFontCode}'
                                },
                                IMAGE:{
                                    tagName : 'img',
                                    src:xui.ini.img_bg,
                                    title:'{image}',
                                    style:'{imgStyle}'
                                }
                        },
                        COMMENT:{
                            tagName : 'div',
                            className:'xui-ui-ellipsis',
                            text: '{comment}',
                            style:'{commentDisplay}',
                            $order:2
                        }
                    },
                    FLAG:{
                        $order:20,
                        className:'xui-display-none {flagClass}',
                        style:'{_flagStyle};{flagStyle}',
                        text:'{flagText}'
                    },
                    EXTRA:{
                        text : '{ext}',
                        $order:30
                    }
                }
            }
        };
        this.setTemplate(t);

        // compitable
        xui.UI.IconList = xui.UI.Gallery;
        var key="xui.UI.IconList";
        xui.absBox.$type[key.replace("xui.UI.","")]=xui.absBox.$type[key]=key;
    },
    Static:{
        IMGNODE:1,
        Appearances:{
            EXTRA:{
                display:'none'
            },
            KEY:{
                overflow:'visible'
            },
            ITEMS:{
                position:'relative',
                overflow:'auto',
                'overflow-x': 'hidden',
                zoom:xui.browser.ie6?1:null
            },
            'ITEMS-nowrap':{
                'white-space':'nowrap'
            },
            ITEM:{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie67?1:null,
                position:'relative',
                cursor:'pointer',
                'vertical-align':'top',
                margin:0
            },
            ITEMFRAME:{
                display:xui.browser.ie67?xui.$inlineBlock:'block',
                zoom:xui.browser.ie67?1:null,
                position:'relative',
                overflow:'hidden',
                border:0,
                padding:0,
                margin:0,
//                width:'100%',
//                height:'100%',
                '-moz-box-flex':'1'
            },
            IBWRAP:{
            },
            IMAGE:{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie6?1:null,
                visibility:'hidden',
            	'vertical-align': 'middle'
            },
            CAPTION:{
            	'text-align': 'center',
                overflow:'hidden',
                'white-space':'nowrap',
                'font-weight':'bold',
                'font-size':'1em'
            },
            CONTENT:{
            	'text-align': 'center',
                'white-space':'nowrap',
                'background-repeat':'no-repeat',
                'background-position':'center center',
                'font-size':'1em'
            },
            COMMENT:{
                display:'block',
                margin:'.25em',
                'text-align':'center',
                'font-size':'1em'
            },
            FLAG:{
                top:'-.5em',
                right:'-.5em',
                position:'absolute',
                'z-index':10
            }
        },
        Behaviors:{
            IMAGE:{
                onLoad:function(profile,e,src){
                    var img=xui.use(src).get(0),path=img.src;
                    if(path!=xui.ini.img_bg){
                            var p=profile.properties,
                                  nn=xui.use(src),
                                  node=nn.get(0),
                                  item=profile.getItemByDom(src);
                            if(!item)return;
                            var icon=profile.getSubNodeByItemId('ICON',item.id);
                            if(item.autoImgSize||p.autoImgSize){
                                nn.attr('width','');nn.attr('height','');
                            }else{
                                nn.attr('width',item.imgWidth);nn.attr('height',item.imgWidth);
                            }

                            icon.removeClass('xui-icon-loading');
                            // hide
                            if(!item.iconFontCode && !item.imageClass){
                                icon.addClass("xui-display-none"); 
                            }
                            nn.onLoad(null).onError(null).$removeEventHandler('load').$removeEventHandler('error');

                            item._status='loaded';
                            // don't show img_blank
                            if(xui.ini.img_blank==path){
                                node.style.visibility="hidden";
                                node.style.display="none";
                            }else{
                                node.style.visibility="visible";
                                node.style.display="";
                            }
                    }
                },
                onError:function(profile,e,src){
                    var item=profile.getItemByDom(src);
                    if(item._status=='error')return;

                    var p=profile.properties,
                          nn=xui.use(src),
                          node=nn.get(0),
                          icon=profile.getSubNodeByItemId('ICON',item.id);

                    icon.removeClass('xui-icon-loading xui-display-none').addClass('xui-load-error');
                    nn.onLoad(null).onError(null).$removeEventHandler('load').$removeEventHandler('error');
                    node.style.visibility="hidden";
                    node.style.display="none";
                    item._status='error';
                }
            },
            FLAG:{
                onClick:function(profile, e, src){
                    var item = profile.getItemByDom(src),
                        box = profile.boxing();

                    if(profile.onFlagClick){
                        box.onFlagClick(profile,item,e,src);
                        return false;
                    }
                }
            }
        },
        DataModel:{
            tagCmds:null,
            tagCmdsAlign:null,
            autoImgSize:{
                ini:false,
                action:function(){
                    this.boxing().refresh();
                }
            },
            autoItemSize:{
                ini:true,
                action:function(){
                    this.boxing().refresh();
                }
            },
            iconOnly:{
                ini:false,
                action:function(){
                    this.boxing().refresh();
                }
            },
            iconFontSize:{
                ini:'',
                action:function(v){
                    this.getSubNode('ICON',true).css('font-size',v);
                }
            },
            itemMargin:{
                ini:6,
                action:function(v){
                    this.getSubNode('ITEM',true).css('margin',v||0);
                }
            },
            itemPadding:{
                ini:2,
                action:function(v){
                    this.getSubNode('ITEM',true).css('padding',v||0);
                }
            },
            itemWidth:{
                $spaceunit:1,
                ini:32,
                action:function(v){
                    this.getSubNode('ITEMFRAME',true).width(v||'');
                }
            },
            itemHeight:{
                $spaceunit:1,
                ini:32,
                action:function(v){
                    this.getSubNode('ITEMFRAME',true).height(v||'');
                }
            },
            imgWidth:{
                ini:16,
                action:function(v){
                    this.getSubNode('IMAGE',true).width(v||'');
                }
            },
            imgHeight:{
                ini:16,
                action:function(v){
                    this.getSubNode('IMAGE',true).height(v||'');
                }
            },
            width:{
                $spaceunit:1,
                ini:'16rem'
            },
            height:{
                $spaceunit:1,
                ini:'16rem'
            },
            columns:{
                ini:0,
                action:function(){
                    this.boxing().refresh();
                }
            },
            rows:{
                ini:0,
                action:function(){
                    this.boxing().refresh();
                }
            }
        },
        EventHandlers:{
            onCmd:null,
            onFlagClick:function(profile,item,e,src){}
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile), p=profile.properties;
            if(p.cols)d._itemscls1=profile.getClass('ITEMS','-nowrap');
            return d;
        },
        _prepareItem:function(profile, item){
            var p = profile.properties,
                cols=p.columns,
                rows=p.rows,
                auto=item.autoItemSize||p.autoItemSize,
                t;

            xui.arr.each(xui.toArr('itemWidth,itemHeight,imgWidth,imgHeight,itemPadding,itemMargin,iconFontSize,autoItemSize'),function(i){
                item[i] = xui.isSet(item[i])?item[i]:p[i];
            });
            item.itemWidth=(!auto&&(t=item.itemWidth))?profile.$forceu(t):'';
            item.itemHeight=(!auto&&(t=item.itemHeight))?profile.$forceu(t):'';
            item.itemMargin=(t=item.itemMargin)?profile.$forceu(t):0;
            item.itemPadding=(t=item.itemPadding)?profile.$forceu(t):0;
            item._tabindex = p.tabindex;

            if(t=item.iconFontSize)item._fontSize="font-size:"+t;
            item._imageClass='';
            if(!item.iconFontCode && !item.imageClass)item._imageClass += 'xui-icon-loading';
            if(item.imageClass)item._imageClass +=' ' + item.imageClass;

            if(item.flagText||item.flagClass)item._flagStyle='display:block';
            if(!item.flagClass)item.flagClass='xui-uiflag-1';

            if(p.iconOnly){
                delete item.caption;
                delete item.comment;
            }

            if(( item.caption = item.caption || '')==='')item.capDisplay='display:none;';
            if((item.comment = item.comment || '')==='')item.commentDisplay='display:none;';
            item._itemSize='';
            if(cols)
                item._itemSize+='width:'+(100/cols+'%') +';border:0;margin-left:0;margin-right:0;padding-left:0;padding-right:0;';
            if(rows)
                item._itemSize+='height:'+(100/rows+'%')+';border:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;';

            if(!auto){
                item._inneritemSize=(!cols&&item.itemWidth?('width:'+item.itemWidth+';'):'') + 
                    (!rows&&item.itemHeight?('height:'+item.itemHeight):'');
            }
        },
        RenderTrigger:function(){
            this.boxing()._afterInsertItems(this);
        }
    }
});
xui.Class("xui.UI.Panel", "xui.UI.Div",{
    Instance:{
        activate:function(){
            var profile = this.get(0);
            profile.getSubNode('CAPTION').focus(true);
            return this;
        },
        resetPanelView:function(removeChildren,destroyChildren){
            if(!xui.isSet(removeChildren))removeChildren=true;
            if(!xui.isSet(destroyChildren))destroyChildren=true;
            var ins;
            return this.each(function(profile){
                if(profile.renderId){
                    delete profile.$ini;
                    if(removeChildren){
                        ins=profile.boxing();
                        ins.removeChildren(true,destroyChildren);
                    }
                    if(profile.properties.toggle)
                        ins.setToggle(false);
                }
            });
        },
        iniPanelView:function(){
            return this.each(function(profile){
                if(!profile.$ini){
                    profile.$ini=true;
                    var p=profile.properties;
                    if(profile.onIniPanelView)profile.boxing().onIniPanelView(profile);
                    if(p.iframeAutoLoad||p.ajaxAutoLoad)
                        xui.UI.Div._applyAutoLoad(profile);
                }
            });
        }
    },
    Static:{
        Templates:{
            tagName : 'div',
            style:'{_style}',
            className:'{_className}',
            BORDER:{
                tagName:'div',
                className: 'xui-uiborder-outset xui-uiborder-box xui-uiborder-radius-big',
                TBAR:{
                    tagName:'div',
                    className:'xui-uibar-top',
                    BARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-tl',
                        BARTDLT:{
                            className:'xui-uibar-tdlt'
                        }
                    },
                    BARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar',
                        BARTDMT:{
                            className:'xui-uibar-tdmt'
                        }
                    },
                    BARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-tr',
                        BARTDRT:{
                            className:'xui-uibar-tdrt'
                        }
                    },
                    BARCMDL:{
                        $order:3,
                        tagName: 'div',
                        className:'xui-uibar-cmdl',
                        style:'{_align}',
                        LTAGCMDS:{
                            tagName:'span',
                            className:'xui-ltag-cmds',
                            style:'{_ltagDisplay}',
                            text:"{ltagCmds}"
                        },
                        TOGGLE:{
                            $order:1,
                            className: 'xuifont',
                            $fonticon:'{_fi_toggleCls2}',
                            style:'{toggleDisplay}',
                            $order:0
                        },
                        ICON:{
                            $order:2,
                            className:'xuicon {imageClass}  {picClass}',
                            style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                            text:'{iconFontCode}'
                        },
                        CAPTION:{
                            tabindex: '{tabindex}',
                            className:"xui-title-node",
                            text : '{caption}',
                            $order:3
                        }
                    },
                    BARCMDR:{
                        $order:4,
                        tagName: 'div',
                        className:'xui-uibar-cmdr',
                        RTAGCMDS:{
                            $order:0,
                            tagName:'span',
                            className:'xui-rtag-cmds',
                            style:'{_rtagDisplay}',
                            text:"{rtagCmds}"
                        } ,
                        INFO:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-info',
                            style:'{infoDisplay}',
                            $order:1
                        },
                        OPT:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-opt',
                            style:'{optDisplay}',
                            $order:2
                        },
                        POP:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-pop',
                            style:'{popDisplay}',
                            $order:3
                        },
                        REFRESH:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-refresh',
                            style:'{refreshDisplay}',
                            $order:4
                        },
                        CLOSE:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-close',
                            style:'{closeDisplay}',
                            $order:5
                        }
                    }
                },
                MAIN:{
                    $order:2,
                    tagName:'div',
                    className:'xui-uicon-main xui-uibar',
                    style:"{_leftp}",
                    MAINI:{
                        tagName:'div',
                        className:'xui-uicon-maini xui-uibar',
                        style:"{_rightp}",
                        PANEL:{
                            tagName:'div',
                            className:'xui-uibase xui-uicontainer {_bordertype}',
                            style:'{panelDisplay};{_panelstyle};{_overflow};',
                            text:'{html}'+xui.UI.$childTag
                        }
                    }
                },
                BBAR:{
                    $order:3,
                    tagName:'div',
                    className:'xui-uibar-bottom-s',
                    style:"{_bbarDisplay}",
                    BBARTDL:{
                        className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-bl'
                    },
                    BBARTDM:{
                        $order:1,
                        className:'xui-uibar-tdm xui-uibar'
                    },
                    BBARTDR:{
                        $order:2,
                        className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-br'
                    }
                }
            },
            $submap:xui.UI.$getTagCmdsTpl()
        },
        Appearances:{
            KEY:{
                background:'transparent'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            'KEY BORDER':{
                zoom:xui.browser.ie6?1:null
            },
            'TBART, BBART':{
                'border-spacing':0,
                'border-collapse':'separate'
            },
            PANEL:{
                position:'relative',
                left:0,
                top:0,
                overflow:'auto',
                'line-height':'normal',
                zoom:xui.browser.ie6?1:null
            },
            CAPTION:{
                display:'inline',
                padding:'.25em',
                'vertical-align':xui.browser.ie6?'baseline':'middle'
            }
        },
        Behaviors:{
            DroppableKeys:['PANEL'],
            PanelKeys:['PANEL'],
            DraggableKeys:['TBAR'],
            NavKeys:{CAPTION:1},
            NoDraggableKeys:['INFO','OPT','CLOSE','POP','REFRESH','TOGGLE','CMD','TOGGLE'],
            HoverEffected:{INFO:'INFO',OPT:'OPT', CLOSE:'CLOSE',POP:'POP', REFRESH:'REFRESH',CMD:'CMD',TOGGLE:'TOGGLE',ICON:'ICON'},
            ClickEffected:{INFO:'INFO',OPT:'OPT', CLOSE:'CLOSE',POP:'POP', REFRESH:'REFRESH',CMD:'CMD',TOGGLE:'TOGGLE'},
            onSize:xui.UI.$onSize,
            TOGGLE:{
                onClick:function(profile, e, src){
                    if(profile.properties.toggleBtn){
                        profile.box._toggle(profile, !profile.properties.toggle);
                        return false;
                    }
                }
            },
            CAPTION:{
                onClick:function(profile, e, src){
                    if(!profile.onClickBar || false===profile.boxing().onClickBar(profile,src))
                        return xui.Event.getKey(e).shiftKey;
                }
            },
            PANEL:{
                onClick:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled)return false;
                    if(profile.onClickPanel)
                        return profile.boxing().onClickPanel(profile, e, src);
                }
            },

            INFO:{
                onClick:function(profile, e, src){
                    profile.boxing().onShowInfo(profile, e, src);
                }
            },
            OPT:{
                onClick:function(profile, e, src){
                    profile.boxing().onShowOptions(profile, e, src);
                }
            },
            REFRESH:{
                onClick:function(profile, e, src){
                    profile.boxing().onRefresh(profile);
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    var properties = profile.properties;
                    if(properties.disabled)return;
                    var instance = profile.boxing();

                    if(false===instance.beforeClose(profile)) return;

                    instance.destroy();
                }
            },
            POP:{
                onClick:function(profile, e, src){
                    var properties=profile.properties;
                    if(properties.disabled)return;
                    var pos = profile.getRoot().offset(), size=profile.getRoot().cssSize(),
                        options={parent:null,host:null,properties:null,events:null,CS:null,CC:null,CB:null,CF:null,init:null};

                    if(profile.beforePop && false==profile.boxing().beforePop(profile,options,e,src))
                        return false;

                    var pro = xui.copy(xui.UI.Dialog.$DataStruct),
                        events={};
                    xui.merge(pro, properties, 'with');
                    xui.merge(pro,{
                        dock:'none',
                        width:Math.max(size.width,200),
                        height:Math.max(size.height,100),
                        left:pos.left,
                        top:pos.top,
                        landBtn:true
                    },'all');
                     if(options.properties)
                        xui.merge(pro, options.properties, 'with');

                    if(options.events)
                        xui.merge(events, options.events, 'all');

                    var dialog = new xui.UI.Dialog(pro,events,options.host||profile.host,options.CS||null,options.CC||null,options.CB||null,options.CF||null);

                    if(xui.isFun(options.init) && false===options.init(dialog,profile,options)){
                    }else{
                        dialog.show(options.parent||xui('body'));
                        var arr=[];
                        xui.arr.each(profile.children,function(o){
                            arr.push(o[0]);
                        });
                        if(arr.length){
                            dialog.append(xui.UI.pack(arr,false));
                        }
                        profile.boxing().removeChildren().destroy(true);
                    }
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var prop=profile.properties;
                    if(prop.disabled)return false;
                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,xui.use(src).id().split('_')[1],e,src);
                    return false;
                }
            }
        },
        DataModel:{
            rotate:null,
            selectable:true,
            dock:'fill',
            caption:{
                ini:undefined,
                // ui update function when setCaption
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('CAPTION').html(xui.adjustRes(v,true));
                }
            },
            html:{
                action:function(v,ov,force){
                    this.getSubNode('PANEL').html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            toggle:{
                ini:true,
                action:function(v){
                    this.box._toggle(this, v);
                }
            },
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            borderType:{
                ini:'inset',
                listbox:['none','flat','inset','outset'],
                action:function(v){
                    var ns=this,
                        p=ns.properties,
                        node=ns.getSubNode('PANEL'),
                        reg=/^xui-uiborder-/,
                        pretag='xui-uiborder-',
                        root=ns.getRoot();
                    node.removeClass(reg);
                    node.addClass(pretag+v);

                    //force to resize
                    ns.adjustSize();
                }
            },
            noFrame:{
                ini:false,
                action:function(v){
                    var ns=this,root=ns.getRoot();
                    ns.getSubNode('BBAR').css('display',v?'none':'');
                    ns.getSubNode('MAIN').css('paddingLeft',v?'0':'');
                    ns.getSubNode('MAINI').css('paddingRight',v?'0':'').css('backgroundImage',v?'none':'');
                    //force to resize
                    ns.adjustSize();
                }
            },
            hAlign:{
                ini:'left',
                listbox:['left','center','right'],
                action: function(v){
                    this.getSubNode("BARCMDL").css('textAlign',v);
                }
            },
            toggleIcon:{
                listbox:['xui-uicmd-toggle','xui-uicmd-check'],
                ini:'xui-uicmd-toggle',
                action:function(v,ov){
                    this.getSubNode('TOGGLE').replaceClass(new RegExp("\\b"+ov,'img'), v);
                }
            },

            infoBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('INFO').css('display',v?'':'none');
                }
            },
            optBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('OPT').css('display',v?'':'none');
                }
            },
            toggleBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('TOGGLE').css('display',v?'':'none');
                }
            },
            closeBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('CLOSE').css('display',v?'':'none');
                }
            },
            refreshBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('REFRESH').css('display',v?'':'none');
                }
            },
            popBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('POP').css('display',v?'':'none');
                }
            },
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            }
        },
        LayoutTrigger:function(){
            var self=this, t=self.properties;
            if(!t.toggle){
                self.box._toggle(self,false,true);
            }else{
                // for default expand container
                self.boxing().iniPanelView();
            }
        },
        EventHandlers:{
            onIniPanelView:function(profile){},
            beforeFold:function(profile){},
            beforeExpand:function(profile){},
            afterFold:function(profile){},
            afterExpand:function(profile){},
            onClickBar:function(profile, src){},
            onClickPanel:function(profile, e, src){},

            beforePop:function(profile, options,e,src){},
            beforeClose:function(profile){},
            onShowInfo:function(profile, e, src){},
            onShowOptions:function(profile, e, src){},
            onRefresh:function(profile){},
            onCmd:function(profile,cmdkey,e,src){}
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile),
                  nodisplay='display:none';

            data._bordertype='xui-uiborder-'+data.borderType;
            data._bbarDisplay=data.noFrame?nodisplay:"";
            data._leftp=data.noFrame?"padding-left:0;":"";
            data._rightp=data.noFrame?"padding-right:0;background-image:none;":"";

            data.toggleDisplay = data.toggleBtn?'':nodisplay;
            data.panelDisplay = data.toggleBtn&&!data.toggle?nodisplay:'';
            data._fi_toggleCls2 = data.toggleIcon + (data.toggleBtn&&data.toggle?' xuifont-checked ' + data.toggleIcon + '-checked':'');
            profile._toggle = !!data.toggle;

            data.infoDisplay = data.infoBtn?'':nodisplay;
            data.optDisplay = data.optBtn?'':nodisplay;
            data.closeDisplay = data.closeBtn?'':nodisplay;
            data.popDisplay = data.popBtn?'':nodisplay;
            data.refreshDisplay= data.refreshBtn?'':nodisplay;

            data._align = 'text-align:'+data.hAlign+';';

            if(!xui.isEmpty(data.tagCmds))
                this._prepareCmds(profile, data);

            return data;
        },
        _toggle:function(profile, value, ignoreEvent){
            var p=profile.properties, ins=profile.boxing();

            //event
            if(value){
                ins.iniPanelView();
            }
            if(ignoreEvent || profile._toggle !== !!value){
                //set toggle mark
                profile._toggle = p.toggle = !!value;
                if(!ignoreEvent){
                    if(value){
                        if(ins.beforeExpand && false===ins.beforeExpand(profile))return;
                    }else{
                        if(ins.beforeFold && false===ins.beforeFold(profile))return;
                    }
                }
                //chang toggle button
                if(p.toggleBtn)
                    profile.getSubNode('TOGGLE').tagClass('-checked', !!value);

                // use onresize function
                profile.adjustSize(true);

                if(!ignoreEvent){
                    if(value){
                        if(ins.afterExpand)
                            ins.afterExpand(profile);
                    }else{
                        if(ins.afterFold)
                            ins.afterFold(profile);
                    }
                }
                // try redock
                if(p.dock && p.dock!='none'){
                    ins.adjustDock(true);
                }
            }
        },
        _onresize:function(profile,width,height){
           var prop=profile.properties,
                // compare with px
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot();

            var isize={},
                noFrame=prop.noFrame,
                border=profile.getSubNode('BORDER'),
                v1=profile.getSubNode('TBAR'),
                panel=profile.getSubNode('PANEL'),
                v4=profile.getSubNode('BBAR'),
                v5=profile.getSubNode('MAIN'),
                v6=profile.getSubNode('MAINI'),
                fzrate=profile.getEmSize()/root._getEmSize(),
                panelfz=panel._getEmSize(fzrate),

                cb1 = border.contentBox(),
                h0=border._borderH(),
                cb2 = panel.contentBox(),
                bordersize=profile.properties.borderType!='none'?panel._borderW():0,
                h1,h4,t;

            // caculate by px
            if(width && width!='auto')width=profile.$px(width,null, true);
            if(height && height!='auto')height=profile.$px(height,null, true);

            if(height){
                if(profile._toggle){
                    panel.css('display','');
                }else{
                    panel.css('display','none');
                }
                if(height=='auto'){
                    root.height(isize.height='auto');
                }else{
                    if(profile._toggle){
                        //force to get height
                        h1=v1.offsetHeight(true);
                        h4=noFrame?0:v4.offsetHeight(true);
                        if((t=height-h0-h1-h4)>0)
                            isize.height=adjustunit(t-(cb2?bordersize:0), panelfz);

                        border.height(adjustunit(height-(cb1?h0:0), border));
                        root.height(adjustunit(height));
                    }else{
                        border.height('auto');
                        root.height('auto');
                    }
                }
            }
            if(width){
                isize.width=adjustunit(width
                    -(noFrame?0:(Math.round(parseFloat(v6.css('paddingRight')))||0))
                    -(noFrame?0:(Math.round(parseFloat(v5.css('paddingLeft')))||0))
                    -h0
                    -bordersize
                    -(v5._borderW())
                    -(v6._borderW())
                    , panelfz);
            }

            if(profile._toggle){
                panel.cssSize(isize, true);
                if(width){
                    xui.UI._adjustConW(profile, panel, isize.width);
                }
            }
        }
    }
});xui.Class("xui.UI.Group", "xui.UI.Panel",{
    Static:{
        Templates:{
            tagName : 'div',
            style:'{_style}',
            className:'{_className}',
            BORDER:{
                tagName : 'fieldset',
                className: '{_fieldCls} xui-uibar-top2',
                TBAR:{
                    tagName : 'legend',
                    style:'{_align}',
                    BARCMDL:{
                        LTAGCMDS:{
                            tagName:'span',
                            className:'xui-ltag-cmds',
                            style:'{_ltagDisplay}',
                            text:"{ltagCmds}"
                        },
                        TOGGLE:{
                            $order:1,
                            className: 'xuifont',
                            $fonticon:'{_fi_toggleCls2}',
                            style:'{toggleDisplay}',
                            $order:0
                        },
                        ICON:{
                            $order:2,
                            className:'xuicon {imageClass}  {picClass}',
                            style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                            text:'{iconFontCode}'
                        },
                        CAPTION : {
                            tabindex: '{tabindex}',
                            className:"xui-title-node",
                            text:   '{caption}',
                            $order:3
                        }
                    },
                    BARCMDR:{
                    $order:4,
                        tagName: 'div',
                        className:'xui-uibar-cmdr xui-uibase',
                        RTAGCMDS:{
                            $order:0,
                            tagName:'span',
                            className:'xui-rtag-cmds',
                            style:'{_rtagDisplay}',
                            text:"{rtagCmds}"
                        } ,
                        INFO:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-info',
                            style:'{infoDisplay}',
                            $order:1
                        },
                        OPT:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-opt',
                            style:'{optDisplay}',
                            $order:2
                        },
                        POP:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-pop',
                                style:'{popDisplay}',
                            $order:3
                        },
                        REFRESH:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-refresh',
                            style:'{refreshDisplay}',
                            $order:4
                        },
                        CLOSE:{
                            className:'xuicon',
                            $fonticon:'xui-uicmd-close',
                            style:'{closeDisplay}',
                            $order:5
                        }
                    }
                },
                PANEL:{
                    $order:1,
                    tagName:'div',
                    style:'{panelDisplay};{_panelstyle};{_overflow};',
                    className:'xui-uicontainer xui-uiborder-radius-bl xui-uiborder-radius-br',
                    text:'{html}'+xui.UI.$childTag
                }
            },
            $submap:xui.UI.$getTagCmdsTpl()
        },
        Appearances:{
            KEY:{
                zoom:xui.browser.ie6?"1":null
            },
            BORDER:{
                position:'relative',
                overflow:'visible',
                zoom:xui.browser.ie6?"1":null
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            TBAR:{
                width: 'auto',
                padding: '0 0 .1666667em 0',
                margin: '0 0 0 .5em',
                border: 0,
                'font-size': 'inherit'
            },
            'BORDER-checked TBAR':{
                'margin-left':'-.5em'
            },
            'BORDER-checked BARCMDL':{
                'padding-left':'1em'
            },
            BARCMDL:{
                cursor:'default',
                'padding-right':'.25em',
                display:xui.$inlineBlock
            },
            PANEL:{
                position:'relative',
                overflow:'auto',
                'line-height':'normal',
                 background:xui.browser.ie?'url('+xui.ini.img_bg+') no-repeat left top':null
            },
            CAPTION:{
                display:'inline',
                'vertical-align':xui.browser.ie6?'baseline':'middle'
            },
            TOGGLE:{
                padding:'0 .334em 0 0'
            }
        },
        DataModel:{
            dock:'none',
            noFrame:null,
            borderType:null,
            toggleBtn:{
                ini:true
            },
            $hborder:1,
            $vborder:1
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            if(!profile.properties.toggle)data.height="auto";
            data._fieldCls = data.toggleBtn&&!data.toggle?' xui-uiborder-t':' xui-uiborder-flat xui-uiborder-radius';
            return data;
        },
        _toggle:function(profile, value, ignoreEvent){
            var p=profile.properties, ins=profile.boxing();

            //event
            if(value){
                ins.iniPanelView();
            }
            if(ignoreEvent || profile._toggle !== !!value){
                //set toggle mark
                profile._toggle = p.toggle = !!value;
                if(!ignoreEvent){
                    if(value){
                        if(ins.beforeExpand && false===ins.beforeExpand(profile))return;
                    }else{
                        if(ins.beforeFold && false===ins.beforeFold(profile))return;
                    }
                }
                //chang toggle button
                if(p.toggleBtn)
                    profile.getSubNode('TOGGLE').tagClass('-checked', !!value);
                
                var border=profile.getSubNode('BORDER')
                if(value)
                    border.removeClass('xui-uiborder-t').addClass('xui-uiborder-flat xui-uiborder-radius');
                else
                    border.removeClass('xui-uiborder-flat xui-uiborder-radius').addClass('xui-uiborder-t');

                // use onresize function
                profile.adjustSize(true);

                if(!ignoreEvent){
                    if(value){
                        if(ins.afterExpand)
                            ins.afterExpand(profile);
                    }else{
                        if(ins.afterFold)
                            ins.afterFold(profile);
                    }
                }
                // try redock
                if(p.dock && p.dock!='none'){
                    ins.adjustDock(true);
                }
            }
        },
        _onresize:function(profile,width,height){
            var prop=profile.properties,
                
                // compare with px
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},

                border = profile.getSubNode('BORDER'),
                panel =profile.getSubNode('PANEL'), 
                root = profile.getRoot(),
                cb = border.contentBox(),
                h0=border._borderH(),
                // caculate by px
                ww=width?profile.$px(width):null, 
                hh=height?profile.$px(height):null;
            if(height){
                if(profile._toggle){
                    panel.css('display','');
                }else{
                    panel.css('display','none');
                }
                if(height=='auto'){
                    panel.height('auto');
                    border.height('auto');
                    root.height('auto');
                }else{
                    if(profile._toggle){
                        panel.height(adjustunit(hh - profile.getSubNode('TBAR').offsetHeight(true) - h0/2, panel));
                        border.height(adjustunit(hh - (cb?h0:0), border));
                        root.height(adjustunit(hh));
                    }else{
                        // here, panel's display is 'none'
                        border.height('auto');
                        root.height('auto');
                    }
                }
            }

            if(width && width!='auto' && ww>=2 && profile._toggle){
                panel.width(ww = adjustunit(ww-2));
                xui.UI._adjustConW(profile, panel, ww);
            }
        }
    }
});xui.Class("xui.UI.PageBar",["xui.UI","xui.absValue"] ,{
    Instance:{
        _setCtrlValue:function(value){
            return this.each(function(profile){
                if(!profile.renderId)return;
                var t,
                    prop = profile.properties,
                    hidemore = !prop.showMoreBtns,
                    arr = profile.box._v2a(value),
                    min=arr[0],
                    cur=arr[1],
                    max=arr[2],
                    keys = profile.keys,
                    fun = function(p,k){return p.getSubNode(k)},

                    first = fun(profile, 'FIRST'),
                    prev = fun(profile, 'PREV'),
                    prem = fun(profile, 'PREM'),
                    current = fun(profile, 'CUR'),
                    next = fun(profile, 'NEXT'),
                    nextm = fun(profile, 'NEXTM'),
                    last = fun(profile, 'LAST'),

                    change = function(n,i,j,k,t){
                        if(i){
                            n.attr('href', prop.uriTpl.replace('*',i));
                            n.attr('title', i);
                        }else if(t){
                            n.attr('title', t);                        
                        }
                        if(xui.isSet(j))
                            n.html(prop.textTpl.replace('*',j),false);
                        
                        if(xui.isSet(k))
                            n.get(0)._real_page=k;
                    },
                    display = function(n,f){n.css('display',f?'':'none')}
                    ;
                //change href and text
                change(first, min, min);
                change(prem, '','..' + xui.str.repeat('.',String(cur-1-min).length) , 1, (min+1) + "~" + (cur-2));
                change(prev, cur-1, prop.prevMark||(cur-1));
                current.get(0).value = cur+"";
                change(next, cur+1, prop.nextMark||(cur+1));
                change(nextm, '','..' + xui.str.repeat('.',String(max-cur-1).length) , 1, (cur+2) + "~" + (max-1));
                change(last, max, max);

                //show or hide
                if((t=cur-min)<=0){
                    display(first,0);display(prem,0);display(prev,0);
                }else if(t==1){
                    display(first,1);display(prem,0);display(prev,0);
                }else if(t==2){
                    display(first,1);display(prem,0);display(prev,1);
                    change(prev, cur-1, cur-1);
                }else{
                    display(first,1);display(prem,hidemore?0:1);display(prev,1);
                    if(t==3){
                        change(prev, cur-1, cur-1);
                        change(prem, cur-2, cur-2, 0);
                    }
                }
                if((t=max-cur)<=0){
                    display(last,0);display(nextm,0);display(next,0);
                }else if(t==1){
                    display(last,1);display(nextm,0);display(next,0);
                }else if(t==2){
                    display(last,1);display(nextm,0);display(next,1);
                    change(next, cur+1, cur+1);
                }else{
                    display(last,1);display(nextm,hidemore?0:1);display(next,1);
                    if(t==3){
                        change(next, cur+1, cur+1);
                        change(nextm, cur+2, cur+2, 0);
                    }
                }
            });
        },
        setPage:function(value, force, type){
            return this.each(function(o){
                if(!/^[1-9]\d*$/.test(value+""))return;

                var p=o.properties,
                    pc = p.pageCount, 
                    v=(p.$UIvalue||p.value||"")+"",
                    a=v.split(':'),
                    b=parseInt(a[1],10);

                if(value > parseInt(a[2],10))return;
                a[1]=parseInt(value,10) || b;

                if(force || a[1]!==b){
                    o.boxing().setUIValue(a.join(':'),false,false,'page');
                    if(o.onPageSet)o.boxing().onPageSet(o, a[1], (a[1]-1)*pc, pc, type||"code", b, (b-1)*pc);
                }
            });
        },
        getPage:function(total){
            var o=this.get(0),
                p=o.properties,
                v=(p.$UIvalue||p.value||"")+"",
                a=v.split(':');
            return a[total?2:1];
        },
        getTotalPages:function(){
            return this.getPage(true);
        },
        setTotalCount:function(count){
            if(!/^[1-9]\d*$/.test(count+""))return this;
            count=parseInt(count,10);
            return this.each(function(o){
                var p=o.properties,
                    pc=parseInt(p.pageCount,10),
                    max = parseInt((count + pc -1) /pc,10),
                    v=(p.$UIvalue||p.value||"")+"",
                    a=v.split(':');

                a[2]=max;
                if(parseInt(a[1],10)>max)a[1]=1;

                o.boxing().setUIValue(a.join(':'),false,false,'settotal');
            });
        }
    },
    Static:{
        Templates:{
            style:'{_style}',
            className:'{_className}',
            POOL:{
                style:'position:absolute;display:none;',
                POP:{
                    tagName:'div',
                    className:'xui-uibase xui-ui-reset xui-ui-ctrl'
                }
            },
            LABEL:{
                text:'{caption}'
            },
            FIRST:{
                $order:1,
                tagName:"a",
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                href:'#',
                tabindex: '{tabindex}'
            },
            PREM:{
                $order:2,
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                style:'{_css2}',
                tagName:'a',
                href:'#',
                tabindex: '{tabindex}'
            },
            PREV:{
                $order:3,
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                tagName:'a',
                href:'#',
                tabindex: '{tabindex}',
                text:'{prevMark}'
            },
            CUR:{
                $order:4,
                className:'xui-ui-input xui-ui-shadow-input xui-uiborder-flat xui-uiborder-radius xui-uibase',
                tagName : 'input',
                tabindex:'{tabindex}',
                style:'{_css}'
            },
            NEXT:{
                $order:5,
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                tagName:'a',
                href:'#',
                tabindex: '{tabindex}',
                text:'{nextMark}'
            },
            NEXTM:{
                $order:6,
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                style:'{_css2}',
                tagName:'a',
                href:'#',
                tabindex: '{tabindex}'
            },
            LAST:{
                $order:7,
                className:'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius',
                tagName:'a',
                href:'#',
                tabindex: '{tabindex}'
            }
        },
        Appearances:{
            LABEL:{
                padding:'.25em .5em 0 .5em',
                'vertical-align':'top',                
                'white-space':'nowrap'
            },
            KEY:{
                display:'inline',
                overflow:'visible'
            },
            'KEY a:focus, POP a:focus':{
                'outline-offset':'',
                '-moz-outline-offset': (xui.browser.gek && xui.browser.ver<3)?'':null
            },
            'KEY .xui-ui-btn, KEY .xui-ui-input, POP .xui-ui-btn':{
                'margin-right':'.25em'
            },
            CUR:{
                'font-weight' : 'bold',
                'text-align':'center',
                padding:'.25em',
                'width':'2em',
                'margin-top':'-1px'
            },
            POP:{
                border:'dotted 1px gray',
                position:'absolute',
                padding:'.25em',
                'line-height':'2.25em'
            }
        },
        Behaviors:{
            HoverEffected:{FIRST:'FIRST',PREM:'PREM',PREV:'PREV',NEXT:'NEXT',NEXTM:'NEXTM',LAST:'LAST',POPI:'POPI',CUR:'CUR'},
            ClickEffected:{FIRST:'FIRST',PREM:'PREM',PREV:'PREV',NEXT:'NEXT',NEXTM:'NEXTM',LAST:'LAST',POPI:'POPI'},
            POP:{
                onClick:function(profile, e, src){
                    var o=xui(src),
                        r = xui.Event.getSrc(e)
                        ;
                    o.setBlurTrigger(profile.key+":"+profile.$xid, null);
                    profile.getSubNode('POOL').append(o);
                    if(r.tagName.toLowerCase()=='a' || ((r=r.firstChild)&&(r.tagName.toLowerCase()=='a')) || ((r=r.firstChild)&&(r.tagName.toLowerCase()=='a')) || ((r=r.firstChild)&&(r.tagName.toLowerCase()=='a')))
                        return profile.box._click(profile,r);
                }
            },
            FIRST:{
                onClick:function(profile, e, src){
                    return profile.box._click(profile,src);
                }
            },
            PREM:{
                onClick:function(profile, e, src){
                    if(xui.use(src).get(0)._real_page){
                        profile.box._show(profile,e,src,0);
                        return false;
                    }else{
                        return profile.box._click(profile,src);
                    }
                }
            },
            PREV:{
                onClick:function(profile, e, src){
                    return profile.box._click(profile,src);
                }
            },
            CUR:{
                onKeypress:function(profile, e, src){
                    var k=xui.Event.getKey(e),
                        caret=xui.use(src).caret();
                    // if not positive integer, set back
                    if(!/^\d$/.test(k.key)){
                        return false;
                    }
                    if(k.key==='0' && caret[0]===0){
                        return false;
                    }
                },
                onChange:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled || p.readonly)return;

                    var v=(p.$UIvalue||p.value||"")+"",
                        a=v.split(':'),
                        cur=parseInt(a[1]||"",10),
                        max=parseInt(a[2]||"",10),
                        value=xui.use(src).get(0).value||"";

                    // if not positive integer, set back
                    if(!/^[1-9]\d*$/.test(value)){
                        xui(src).attr('value',cur+"");
                        return;
                    }

                    value = parseInt(value,10);
                    if(cur!==value){
                        value =value > max ? max : value;
                        xui(src).attr('value', value+"");
                        profile.boxing().setPage(value,false,'input');
                    }
                },
                onKeydown:function(profile, e, src){
                   var p=profile.properties,b=profile.box,
                        evt=xui.Event,
                        k=evt.getKey(e);
                    if(p.disabled || p.readonly)return;

                    //fire onchange
                    if(k.key=='enter')
                        xui.use(src).onChange();
                }
            },
            NEXT:{
                onClick:function(profile, e, src){
                    return profile.box._click(profile,src);
                }
            },
            NEXTM:{
                onClick:function(profile, e, src){
                    if(xui.use(src).get(0)._real_page){
                        profile.box._show(profile,e,src,1);
                        return false;
                    }else{
                        return profile.box._click(profile,src);
                    }
                }
            },
            LAST:{
                onClick:function(profile, e, src){
                    return profile.box._click(profile,src);
                }
            }
        },
        DataModel:{
            dataField:null,
            dataBinder:null,
            autoTips:false,
            dirtyMark:false,
            showDirtyMark:false,
            parentID:'',
            isFormField:{
                hidden:true,
                ini:false
            },
            caption:{
                ini:' Page: ',
                action:function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('LABEL').html(xui.adjustRes(v,true));
                }
            },
            showMoreBtns:{
                ini:true,
                action:function(v){
                    this.getSubNodes(['PREM','NEXTM']).css('display', v?'':'none');
                }
            },
            pageCount:20,
            disabled:{
                ini:false,
                action: function(v){
                    var i=this.getSubNode('CUR'),
                        cls="xui-ui-disabled";
                    
                    if(v)this.getRoot().addClass(cls);
                    else this.getRoot().removeClass(cls);
                        
                    if(!v && this.properties.readonly)
                        v=true;
                    // use 'readonly'(not 'disabled') for selection
                    i.attr('readonly',v);
                }
            },
            readonly:{
                ini:false,
                action: function(v){
                    var i=this.getSubNode('CUR'),
                        cls="xui-ui-readonly";
                    
                    if(v)this.getRoot().addClass(cls);
                    else this.getRoot().removeClass(cls);

                    if(!v && this.properties.disabled)
                        v=true;
                    // use 'readonly'(not 'disabled') for selection
                    i.attr('readonly',v);
                }
            },
            value:"1:1:1",
            uriTpl:"#*",
            textTpl:"*",
            prevMark:'',
            nextMark:'',
            _moreStep:30
        },
        EventHandlers:{
            onClick:function(profile, page){},
            onPageSet:function(profile, page, start, count, eventType, opage, ostart){}
        },
        RenderTrigger:function(){
            var ns=this,p=ns.properties,a=((p.value||"")+"").split(':');
            if(p.readonly)
                ns.boxing().setReadonly(true,true);
            if(!ns.$inDesign)
                ns.boxing().setPage(a[1]||a[0],true,'inited');
        },
        _ensureValue:function(profile,value){
            value=value+'';
            var a = value.split(':'),
                p=profile.properties,
                b=[],
                fun=function(a){return parseInt(a,10)||1};
            if(a.length<3){
                b=((p.$UIvalue||p.value||'')+'').split(':');
                a[1]=a[0];
                a[0]=b[0];
                a[2]=b[2];
            }
            b[0]=fun(a[0]);
            b[1]=fun(a[1]);
            b[2]=fun(a[2]);

            b[0] = Math.max(b[0],1);
            b[0] = Math.min(b[0],b[1]);
            b[2] = Math.max(b[1],b[2]);

            return b.join(':');
        },
        _v2a:function(v){
            v = typeof v == 'string'? v.split(':') : v;
            v[0]=parseInt(v[0],10);v[1]=parseInt(v[1],10);v[2]=parseInt(v[2],10);
            return v;
        },
        _click:function(profile, src){
            var p=profile.properties;
            if(p.disabled||p.readonly)return false;
            var b=profile.boxing(),
                a=(p.$UIvalue||p.value||"").split(':'),
                nv=parseInt(xui(src).attr('href').split('#')[1],10)||a[1]||a[0];

            var r = b.onClick(nv);

            // if didn't call setPage  in onclick event, setPage here
            if(!a.length || (nv+"")!==(a[1]+"")){
                b.setPage(nv,false,'click');
            }

            return typeof r=="boolean"?r:false;
        },
        _show:function(profile, e, src, flag){
            var prop=profile.properties;
            if(prop.disabled||prop.readonly)return false;

            var prop = profile.properties,
                arr = profile.box._v2a(prop.value),
                min=arr[0],
                cur=arr[1],
                max=arr[2],

                keys = profile.keys,
                fun = function(p,k){return p.getSubNode(k)},
                pool = fun(profile, 'POOL'),
                pop = fun(profile, 'POP'),
                ceil = function(n){return Math.ceil((n+1)/10)*10},
                a=[],
                t,m,n,i,l
                ;

            if(flag){
                if((t=max-1-cur)<=0)return;
                n=cur + 1;
                l=max;
            }else{
                if((t=cur-1-min)<=0)return;
                n=1;
                l=cur-1;
            }
            m=Math.ceil(t/prop._moreStep);
            if(m>10){
                n=ceil(n);
                l=ceil(l)-1;
                m=ceil(m);
            }else
                n=n+m;
            //
            var _id=profile.keys.POPI+':'+profile.serialId+':';
            while(n<l){
                //margin-top for ie6
                a.push('<a style="margin-top:.25em;" id="'+_id+n+'" class="xui-node xui-node-span xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius" href="'+prop.uriTpl.replace('*',n)+'">'+prop.textTpl.replace('*',n)+'</a>')
                n=n+m;
            }
            pop.width('auto');
            pop.html(a.join(' '));
            xui('body').append(pop);
            if(pop.width()>300)pop.width(300);
            pop.popToTop(src,null,prop.parentID?xui(prop.parentID):null);
            pop.setBlurTrigger(profile.key+":"+profile.$xid, function(){
                pool.append(pop);
            });
        },
        _prepareData:function(profile){
            var data=arguments.callee.upper.call(this, profile);
            data._css=xui.browser.kde?'resize:none;':'';
            data._css2 = data.showMoreBtns?'':'display:none;';
            return data;
        }   
    },
    Initialize:function(){
        this.addTemplateKeys(['POPI']);
    }
});
xui.Class("xui.UI.Tabs", ["xui.UI", "xui.absList","xui.absValue"],{
    Instance:{
        _setCtrlValue:function(value){
            this.each(function(profile){
                var id=profile.domId,
                    box = profile.boxing(),
                    uiv = box.getUIValue(),
                    prop = profile.properties,
                    dm=profile.box.$DataModel,
                    mcap=profile.getSubNode('MENUCAPTION'),
                    mcls=profile.getSubNode('MENUCLOSE'),
                    fold=function(itemId, arr){
                        var subId = profile.getSubIdByItemId(itemId),
                            item = profile.getItemByItemId(itemId);
                        if(subId){
                            arr.push(subId);
                            
                            if(!dm.hasOwnProperty("noPanel") || !prop.noPanel){
                                // hide pane
                                //box.getPanel(itemId).hide();
                                var pn=box.getPanel(itemId).get(0);
                                if(pn && (item._scrollTop=pn.scrollTop||0))
                                    pn.scrollTop=0;

                                box.getPanel(itemId).css('display','none');
                            }
                        }
                    },
                    expand = function(itemId, arr){
                        var subId = profile.getSubIdByItemId(itemId),
                            item=profile.getItemByItemId(itemId);
                        if(subId){
                            arr.push(subId);
                            mcap.html(item.caption);
                            mcls.css('display',item.closeBtn?'':'none');
                            profile._menuId = item.id;
                            if(!dm.hasOwnProperty("noPanel") || !prop.noPanel){
                                // show pane
                                //box.getPanel(value).css('position','relative').show('auto','auto');
                                box.getPanel(itemId).css('display','block');
                                if(item._scrollTop)
                                    box.getPanel(itemId).get(0).scrollTop=item._scrollTop;

                                profile.adjustSize(false, false, value);

                                profile.box._forLazyAppend(profile, item, value);
                                profile.box._forIniPanelView(profile, item);
                            }
                        }
                    };
                var arr1=[],arr2=[];
                if(dm.hasOwnProperty("selMode") &&
                    dm.hasOwnProperty("noPanel") &&
                    prop.noPanel &&
                    prop.selMode=="multi"){

                    uiv = uiv?uiv.split(prop.valueSeparator):[];
                    xui.arr.each(uiv,function(key){
                        fold(key, arr1);
                    });
                    value = value?value.split(prop.valueSeparator):[];
                    var lastV="";
                    xui.arr.each(value,function(key){
                        var l=arr2.length;
                        expand(key, arr2);
                        // the last one
                        if(l<arr2.length)
                            lastV=key;
                    });
                }else{
                    fold(uiv, arr1);
                    expand(value, arr2);
                }

                if(arr1.length){
                    profile.getSubNodes(['ITEM','TOGGLE'],arr1).tagClass('-checked',false);
                    profile.getSubNodes('ITEM',arr1).tagClass('-checked',false);
                }
                if(arr2.length){
                    profile.getSubNodes(['ITEM','TOGGLE'],arr2).tagClass('-checked');
                    profile.getSubNodes('ITEM',arr2).tagClass('-checked');
                }

            });
        },
        append:function(target,subId, pre, base){
            var p=this.get(0).properties;
            if(subId=subId||p.$UIvalue||p.value)
                arguments.callee.upper.call(this, target, subId+'', pre, base);
            return this;
        },
        getCurPanel:function(){
            var profile = this.get(0),
                dm=profile.box.$DataModel,
                v=profile.properties.$UIvalue;
            if(dm.hasOwnProperty("noPanel") && dm.hasOwnProperty("selMode") && profile.properties.selMode=='multi'){
                v=v.split(prop.valueSeparator);
                v=v[0]||null;
            }
            return v?this.getPanel(v):null;
        },
        // get pane in page views
        getPanel:function(subId){
            var profile = this.get(0);
            return profile.getSubNodeByItemId('PANEL', subId+'');
        },
        ////
        addPanel:function(paras, children, item){
            var ns=this,
                i={}, arr=[],
                id = item&&item.id,
                items = ns.getItems(),
                id2=paras.id||paras.tag;
            if(items.length){
                if(-1!=xui.arr.subIndexOf(items,'id',id2))
                    return false;
            }

            xui.merge(i, {
                caption:paras.caption,
                image:paras.image,
                closeBtn:paras.closeBtn || false,
                popBtn:paras.popBtn || false,
                optBtn:paras.optBtn || false,
                imagePos:paras.imagePos,
                imageBgSize:paras.imageBgSize,
                dragKey:paras.dragKey,
                dropKeys:paras.dropKeys,
                id : paras.id || paras.tag || xui.id()
            });

            if(id) ns.insertItems([i], id, true);
            else ns.insertItems([i]);
            
            xui.arr.each(children,function(o){
                arr.push(o[0]);
            });
            ns.append(xui.UI.pack(arr,false), i.id);

            return ns;
        },
        removePanel:function(domId){
            var self=this,
                item = self.getItemByDom(domId);
            return self.removeItems([item.id]);
        },
        getPanelPara:function(domId){
            var profile=this.get(0),
                pp=profile.properties,
                item = profile.getItemByDom(domId),
                paras = xui.clone(item,false);
            if(!paras.dragKey)paras.dragKey=pp.dragKey;
            if(!paras.dropKeys)paras.dropKeys=pp.dropKeys;
            return paras;
        },
        getPanelChildren:function(domId){
            var profile=this.get(0),
                id = profile.getItemIdByDom(domId),
                arr=[];
            if(id)
                xui.arr.each(profile.children,function(o){
                    if(o[1]==id)arr.push(o);
                });
            return arr;
        },

        resetPanelView:function(subId, removeChildren, destroyChildren){
            if(!xui.isSet(removeChildren))removeChildren=true;
            if(!xui.isSet(destroyChildren))destroyChildren=true;
            var ins,item;
            return this.each(function(profile){
                if(profile.renderId){
                    xui.arr.each(profile.properties.items,function(o){
                        if(subId===true || (subId+'')===o.id)
                            delete o._$ini;
                    });
                    if(removeChildren)
                        profile.boxing().removeChildren(subId,destroyChildren)
                }
            });
        },
        iniPanelView:function(subId){
            return this.each(function(profile){
                if(subId){
                    if(subId=profile.getItemByItemId(subId+'')){
                        profile.box._forIniPanelView(profile, subId);
                    }
                }else{
                    xui.arr.each(profile.properties.items,function(item){
                        profile.box._forIniPanelView(profile, item);
                    });
                }
            });
        },
        
        ////
        fireItemClickEvent:function(subId){
            var node=this.getSubNodeByItemId('ITEM', subId+''),ev=xui.Event;
            node.onClick(true);

            //if(ev.__realtouch)ev.__simulatedMousedown=1;
            //node.onMousedown(true).onMouseup(true);
            //if(ev.__realtouch)ev.__simulatedMousedown=0;
            return this;
        },
        /* insert some views to pageView widgets
            arr: hash(view properties) or array of hash
            before: views will insert before it, string
        */
        _afterInsertItems:function(profile, data){
            if(!profile.renderId)return;
            var box=profile.box,obj,v,pp=profile.properties;
            if(obj=profile.getSubNode(profile.keys.BOX||profile.keys.KEY)){
                // add panels anyway
                obj.append(profile._buildItems('panels', data));
                // for stacks only
                if(!profile.box.$DataModel.hasOwnProperty("noPanel") ){
                    if(!(v=this.getUIValue()))
                        this.fireItemClickEvent((v=pp.items[0]) && v.id);
                }
                profile.adjustSize();
            }
        },
        /*  remove some views from pageView
            arr: array for id
        */
        removeItems:function(arr/*default is the current*/,purgeNow){
            var self=this,
                p,obj,serialId;
            self.each(function(profile){
                var p=profile.properties;
                arr = xui.isSet(arr)?xui.isArr(arr)?arr:(arr+"").split(p.valueSeparator):null;
                if(!arr)arr=((p.$UIvalue||p.value)+"").split(p.valueSeparator);
                if(!profile.box.$DataModel.hasOwnProperty("noPanel") || !profile.properties.noPanel)
                    xui.arr.each(arr,function(o){
                        // get ui serial id
                        serialId=profile.getSubIdByItemId(o+"");
                        if(serialId && !(obj = profile.getSubNode('PANEL', serialId) ).isEmpty() ){
                            // remove ui
                            obj.remove(true, purgeNow);
                        }
                    });
            });
            arguments.callee.upper.apply(self,arguments);

            self.each(function(profile){
                if(!profile.boxing().getUIValue()){
                    xui.asyRun(function(){
                        if(!profile || !profile.renderId || !profile.properties || !profile.properties.items.length)return;
                        var i;
                        profile.boxing().fireItemClickEvent((i=profile.properties.items[0]) && i.id);
                    });
                }

                profile.adjustSize();
            });

            return self;
        },
        clearItems:function(purgeNow){
            var self=this;
            self.each(function(profile){
                if(!profile.box.$DataModel.hasOwnProperty("noPanel") || !profile.properties.noPanel)
                    profile.getSubNode('PANEL',true).remove(true, purgeNow);
            });
            self.setValue(null,true,'clear');
            arguments.callee.upper.apply(self,arguments);
            return self;
        },
        markItemCaption:function(subId, mark, force, tag, cls){
            var profile = this.get(0);
            subId=profile.getItemByItemId(subId+'');

            if((subId._dirty !=mark) || force){
                var id = subId.id,
                    item = profile.getItemByItemId(id),
                    caption = item.caption,
                    node = profile.getSubNodeByItemId('CAPTION', id);
                if(tag){
                    if(xui.isFun(tag)){
                        item.caption = tag(profile, item, mark);
                        node.html(item.caption);
                    }else
                        node.html(item.caption = mark ? tag+caption : caption.replace(new RegExp("^"+tag),''));
                }else 
                    node.html(item.caption = mark ? '*'+caption : caption.replace(/^\*/,''));
                if(cls){
                    if(mark)node.addCalss(cls);
                    else node.removeCalss(cls);
                }else
                    node.css({'font-weight':mark?'bold':'','font-style':mark?'italic':''});

                subId._dirty=mark;
            }
            return this;
        }
    },
    Static:{
        Templates:{
            tagName : 'div',
            style:'{_style};',
            className:'{_className}',
            LIST:{
                $order:1,
                tagName : 'div',
                style:'{_liststyle}',
                LISTBG:{
                     $order:0,
                     className:'xui-uiborder-t xui-uiborder-b xui-uiborder-dark xui-uibar-checked'
                },
                MENU:{
                    className:'xui-ui-unselectable xui-uiborder-hidden xui-uiborder-radius',
                    MENUICON:{
                        className:'xuicon',
                        $fonticon:'xui-icon-menu'
                    },
                    MENUCAPTION:{},
                    MENUCLOSE:{
                        className:'xuifont',
                        $fonticon:'xui-uicmd-close',
                        $order:2
                    }
                },
                MENU2:{
                    tagName:'div',
                    className:'xui-ui-unselectable',
                    MENUICON2:{
                        className:'xui-uiborder-hidden xui-uiborder-radius xuicon {_iconChecked}',
                        $fonticon:'xui-icon-menu'
                    }
                },
                ITEMS:{
                    tagName : 'div',
                    className:'xui-ui-unselectable {_specialIconCls}',
                    text:"{items}",
                    style:'{HAlign}'
                }
            },
            PNAELS:{
                $order:2,
                tagName:'text',
                text:'{panels}'
            },
            $submap:{
                items:{
                    ITEM:{
                        className:'xui-uiborder-flat xui-uiborder-nob xui-uiborder-box xui-uiborder-radius-big-tl xui-uiborder-radius-big-tr xui-uibar {itemClass} {disabled} {readonly}',
                        style:'{_itemDisplay} {itemStyle}',
                        ITEMI:{
                            ITEMC:{
                                HANDLE:{
                                    tabindex: '{_tabindex}',
                                    className:'xui-showfocus',
                                    IBWRAP:{
                                        tagName:'div',
                                        style:"white-space:nowrap;",
                                        RULER:{},
                                        LTAGCMDS:{
                                            $order:1,
                                            tagName:'span',
                                            className:'xui-ltag-cmds',
                                            style:'{_ltagDisplay}',
                                            text:"{ltagCmds}"
                                        },
                                        ICON:{
                                            $order:2,
                                            className:'xuicon {imageClass}  {picClass}',
                                            style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                                            text:'{iconFontCode}'
                                        },
                                        CAPTION:{
                                            $order:3,
                                            text: '{caption}',
                                            className:"xui-title-node",
                                            style:'{itemWidth};{itemAlign}'
                                        },
                                        CMDS:{
                                            $order:4,
                                            RTAGCMDS:{
                                                $order:0,
                                                tagName:'span',
                                                className:'xui-rtag-cmds',
                                                style:'{_rtagDisplay}',
                                                text:"{rtagCmds}"
                                            },
                                            OPT:{
                                                $order:1,
                                                className:'xuifont',
                                                $fonticon:'xui-uicmd-opt',
                                                style:'{_opt}'
                                            },
                                            POP:{
                                                className:'xuifont',
                                                $fonticon:'xui-uicmd-pop',
                                                style:'{popDisplay}',
                                                $order:1
                                            },
                                            CLOSE:{
                                                className:'xuifont',
                                                $fonticon:'xui-uicmd-close',
                                                style:'{closeDisplay}',
                                                $order:2
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                panels:{
                    PANEL:{
                        tagName : 'div',
                        className:'xui-uibase xui-uicontainer',
                        style:"{_overflow};{_bginfo}",
                        text:'{html}'+xui.UI.$childTag
                    }
                },
                'items.ltagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.rtagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.tagCmds.text':xui.UI.$getTagCmdsTpl('text'),
                'items.tagCmds.button':xui.UI.$getTagCmdsTpl('button'),
                'items.tagCmds.image':xui.UI.$getTagCmdsTpl('image')
            }
        },
        Appearances:{
            KEY:{
                position:'absolute',
                overflow:'hidden'
            },
            LIST:{
                position:'relative',
                overflow:'hidden',
                left:0,
                width:'100%',
                padding:'.25em .25em 0 .25em ',
                'white-space': 'nowrap'
            },
            LISTBG:{
                position:'absolute',
                overflow:'hidden',
                left:0,
                bottom:0,
                height:'3px',
                width:'100%'                
            },
            MENU:{
                display:'none',
                margin:'.25em',
                padding:'.16667em',
                cursor:'pointer'
            },
            MENU2:{
                display:'none'
            },
            MENUCAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                margin:'0 4px',
                'font-size':'1em' 
            },
            ITEMS:{
                padding:xui.browser.contentBox?'0 0 4px 0':'0 0 2px 0',
                position:'relative',
                left:0,
                top:0,
                'white-space':'nowrap'
            },
            'ITEMS-icon CAPTION, ITEMS-icon OPT, ITEMS-icon POP, ITEMS-icon2 CAPTION, ITEMS-icon2 OPT, ITEMS-icon2 POP':{
                display:'none'
            },
            'ITEMS-menu ITEM':{
                display:'none'
            },
            ITEM:{
                $order:0,
                cursor:'pointer',
                'padding':'0 .5em 0 0',
                'vertical-align':'top',
                'margin':'0 .25em',
                'border-bottom':0,
                'border-radius':'6px 6px 0 0',
                '-moz-border-radius': '6px 6px 0 0',
                '-webkit-border-radius': '6px 6px 0 0',
                '-o-border-radius': '6px 6px 0 0',
                '-ms-border-radius': '6px 6px 0 0',
                '-khtml-border-radius': '6px 6px 0 0'
            },
            ITEMI:{
                $order:0,
                'padding-left':'.5em',
                //keep this same with ITEM
                'vertical-align':'top'
            },
            ITEMC:{
                $order:0,
                padding:'.33333333em',
                //keep this same with ITEM
                'vertical-align':'top',
                'text-align': 'center'
            },
            HANDLE:{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie6?1:null,
                cursor:'pointer',
                'vertical-align':'middle',
                padding:0
            },
            'ITEM-checked HANDLE':{
                'padding-bottom':'1px'
            },
            RULER:{
                height:'1.5em',
                width:'0',
                'vertical-align':'middle'
            },
            PANEL:{
                position:'relative',
                //visibility:'hidden',
                //top:'-10000px',
                //left:'-10000px',
                display:'none',
                width:'100%',
                overflow:'auto'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                margin:'0 4px',
                overflow: 'hidden'
            },
            CMDS:{
                'vertical-align':'middle'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            CMD:{
                padding:0,
                margin:0
            }
        },
        Behaviors:{
            NOTIPS:["GROUP","HANDLER"],
            DroppableKeys:['PANEL','LIST', 'ITEM'],
            PanelKeys:['PANEL'],
            DraggableKeys:['ITEM'],
            HoverEffected:{ITEM:'ITEM',MENU:'MENU',MENU2:'MENU2',MENUICON2:'MENUICON2',OPT:'OPT',CLOSE:'CLOSE',MENUCLOSE:'MENUCLOSE',POP:'POP',ICON:'ICON',CMD:'CMD'},
            ClickEffected:{ITEM:'ITEM',MENU:'MENU',MENU2:'MENU2',MENUICON2:'MENUICON2',OPT:'OPT',CLOSE:'CLOSE',MENUCLOSE:'MENUCLOSE',POP:'POP',CMD:'CMD'},
            onSize:xui.UI.$onSize,
            CAPTION:{
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        box = profile.boxing();

                    if(properties.disabled || item.disabled)return false;
                    if(properties.readonly || item.readonly)return false;
                    if(box.getUIValue() == item.id){
                         if(profile.onCaptionActive)
                            profile.boxing().onCaptionActive(profile, profile.getItemByDom(src), e, src);
                    }
                }
            },
            ITEM:{
                onClick:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return false;
                    var t;
                    if((t=xui.Event.getSrc(e).parentNode) && t.id && (profile.getKey(t.id))==profile.keys.CMDS)return false;

                    var prop = profile.properties,
                        dm=profile.box.$DataModel,
                        itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src),
                        box = profile.boxing();

                    if(prop.disabled || item.disabled)return false;
                    if(prop.readonly || item.readonly)return false;

                    //for some input onblur event
                    //profile.getSubNode('HANDLE', itemId).focus(true);

                    if(dm.hasOwnProperty("selMode") &&
                        dm.hasOwnProperty("noPanel") &&
                        prop.noPanel &&
                        prop.selMode=="multi"){

                        var value = box.getUIValue(),
                            arr = value?value.split(prop.valueSeparator):[],
                            checktype=1,
                            rt=false,
                            rt2=false;
                        // for multi selection
                        if(arr.length){
                            //for select
                            if(xui.arr.indexOf(arr,item.id)!=-1){
                                xui.arr.removeValue(arr,item.id);
                                checktype=-1
                            }else
                                arr.push(item.id);

                            arr.sort();
                            value = arr.join(prop.valueSeparator);

                            //update string value only for setCtrlValue
                            if(box.getUIValue() == value)
                                rt=false;
                            else{
                                box.setUIValue(value,null,null,'md');
                                if(box.get(0) && box.getUIValue() == value)
                                    rt=box.onItemSelected(profile, item, e, src, checktype)||rt2;
                            }
                            return rt;
                        }

                    }
                    // for single selection
                    if(box.getUIValue() != item.id){
                        box.setUIValue(item.id,null,null,'md');
                        //if success
                        if(box.getUIValue() == item.id){
                            rt=box.onItemSelected(profile, item, e, src)||rt2;
                            return rt;
                        }
                    }
                }
            },
            HANDLE:{
                onKeydown:function(profile, e, src){
                    var keys=xui.Event.getKey(e), key = keys.key, shift=keys.shiftKey;
                    if(key==' '||key=='enter'){
                        profile.getSubNode('ITEM',profile.getSubId(src)).onClick();
                        return false;
                    }

                    var cur = xui(src),
                    target = profile.getSubNode('ITEMS'),
                    first = target.nextFocus(true, true, false),
                    last = target.nextFocus(false, true, false);

                    switch(key){
                        case 'tab':
                            if(shift){
                                if(cur.get(0)!=first.get(0)){
                                    first.focus(true);
                                    return false;
                                }
                            }else{
                                if(cur.get(0)!=last.get(0)){
                                    last.focus(true);
                                    return false;
                                }
                            }
                            break;
                        case 'left':
                        case 'up':
                            var next = cur.nextFocus(false, true, false);
                            if(cur.get(0)==first.get(0))
                                last.focus(true);
                            else
                                cur.nextFocus(false);
                            return false;
                            break;
                        case 'right':
                        case 'down':
                            var next = cur.nextFocus(true, false, false);
                            if(cur.get(0)==last.get(0))
                                first.focus(true);
                            else
                                cur.nextFocus();
                            return false;
                            break;
                    }
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var prop=profile.properties,
                        item=profile.getItemByDom(xui.use(src).parent().get(0));
                    if(!item)return false;

                    if(prop.disabled|| item.disabled || item.type=='split')return false;
                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,item, xui.use(src).id().split('_')[1],e,src);
                    return false;
                }
            },
            OPT:{
                onClick:function(profile, e, src){
                    profile.boxing().onShowOptions(profile, profile.getItemByDom(src), e, src);
                    return false;
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        uiv=properties.$UIvalue,
                        bak;

                    if(properties.disabled || item.disabled)return;
                    if(properties.readonly || item.readonly)return false;
                    var instance = profile.boxing();

                    if(false===instance.beforePageClose(profile, item, src)) return;

                    bak=xui.copy(item);

                    // if the current item is selected, select the next or the pre one item
                    if(uiv && uiv==item.id){
                        var items=properties.items,
                        index=xui.arr.subIndexOf(items,"id",item.id),
                        t,
                        nuiv=(t=items[index+1])?t.id:(t=items[index-1])?t.id:(t=items[0])?t.id:null;
                        if(nuiv && nuiv!=uiv){
                            profile.boxing().fireItemClickEvent(nuiv);
                        }
                    }

                    instance.removeItems(item.id);

                    instance.afterPageClose(profile, bak);

                    profile.adjustSize();

                    return false;
                }
            },
            MENUCLOSE:{
                onClick:function(profile, e, src){
                    profile.getSubNodeByItemId("CLOSE",profile._menuId).onClick(true);
                }
            },
            POP:{
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        options={parent:null,host:null,properties:null,events:null,CS:null,CC:null,CB:null,CF:null,init:null},
                        id=item.id;
                    if(properties.disabled || item.disabled)return false;
                    if(properties.readonly || item.readonly)return false;

                    if(profile.beforePagePop && false==profile.boxing().beforePagePop(profile,item,options,e,src))
                        return false;

                    var panel = profile.boxing().getPanel(id),
                        pos = profile.getRoot().offset(),
                        size=profile.getRoot().cssSize(),
                        pro = xui.copy(xui.UI.Dialog.$DataStruct),
                        events={};
                    
                    xui.merge(pro, item, 'with');
                    xui.merge(pro,{
                        dragKey: item.dragkey || properties.dragKey ,
                        dock:'none',
                        tag:item.tag||item.id,
                        width:Math.max(size.width,200),
                        height:Math.max(size.height,100),
                        left:pos.left,
                        top:pos.top,
                        landBtn:true
                    },'all');
                    if(options.properties)
                        xui.merge(pro, options.properties, 'with');
                    
                    if(options.events)
                        xui.merge(events, options.events, 'all');

                    var dialog = new xui.UI.Dialog(pro,events,options.host||profile.host,options.CS||null,options.CC||null,options.CB||null,options.CF||null);

                    if(xui.isFun(options.init) && false===options.init(dialog,profile,options)){
                    }else{
                        dialog.show(options.parent||xui('body'));    
                        var arr=[];
                        xui.arr.each(profile.children,function(o){
                            if(o[1]==id){
                                arr.push(o[0]);
                            }
                        });
                        if(arr.length){
                            dialog.append(xui.UI.pack(arr,false));
                        }
                        profile.boxing().removeChildren(id).removeItems(id);
                    }
                    return false;
                }
            },
            MENU:{
                onMouseover:function(profile, e, src){
                    var menu=profile._droppopmenu;
                    if(menu)return;

                    var ins=profile.boxing(),
                        items=profile.properties.items,
                        nitems=[],
                        l=items.length,
                        ll;
                    if(items.length>10){
                        ll=Math.ceil(l/10);
                        for(var i=0;i<ll;i++)
                            nitems.push({caption:(i*10+1) + " - " + Math.min(l,((i+1)*10+1)), sub:[]});
                        xui.arr.each(items,function(item,i){
                            nitems[parseInt(i/10)].sub.push(xui.clone(item,false,1));
                        });
                    }else{
                        nitems=xui.clone(items,false,2);
                    }
                    //POPMENU
                    menu=profile._droppopmenu=new xui.UI.PopMenu({
                        items:nitems,
                        autoHide:true
                    },{onMenuSelected:function(profile, item){
                        ins.fireItemClickEvent(item.id);
                    },
                    beforeHide:function(p,e){
                        if(e){
                            var node=xui(src),
                            p1=xui.Event.getPos(e),
                            size=node.cssSize(),
                            add=3,
                            p2=node.offset();

                            if(p1.left>p2.left && p1.top>p2.top-add && p1.left<p2.left+size.width && p1.top<p2.top+size.height){
                                return false;
                            }
                        }
                    },onHide:function(){
                        profile._droppopmenu.destroy(true);
                        delete profile._droppopmenu;
                    }});
                    menu.pop(src);
                },
                onMouseout:function(profile, e, src){
                    var pop;
                    if(pop=profile._droppopmenu){
                        var node=pop.get(0).getRoot(),
                        p1=xui.Event.getPos(e),
                        size=node.cssSize(),
                        add=3,
                        p2=node.offset();

                        if(p1.left>p2.left && p1.top>p2.top-add && p1.left<p2.left+size.width && p1.top<p2.top+size.height){}else
                            pop.hide();
                    }
                },
                onClick:function(p, e, src){
                    xui(src).onMouseover(true);
                }
            },
            PANEL:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                        item = profile.getItemByDom(src);
                    if(p.disabled || item.disabled)return false;
                    if(profile.onClickPanel)
                        return profile.boxing().onClickPanel(profile, item, e, src);
                }
            }
        },
        DataModel:{
            rotate:null,

            selectable:true,
            dirtyMark:false,

            lazyAppend:true,
            isFormField:{
                hidden:true,
                ini:false
            },

            dock:'fill',
            width:{
                $spaceunit:1,
                ini:'18em'
            },
            height:{
                $spaceunit:1,
                ini:'18em'
            },
            position:'absolute',
            itemWidth:{
                ini:0,
                action:function(value){
                    this.getSubNode('CAPTION',true).width(value);
                }
            },
            itemAlign:{
                ini:"",
                listbox:['','left','center','right'],
                action:function(value){
                    this.getSubNode('CAPTION',true).css('text-align',value);
                }
            },
            HAlign:{
                ini:'left',
                listbox:['left','center','right'],
                action:function(value){
                    this.getSubNode('ITEMS').css('textAlign',value);
                }
            },
            dropKeysPanel:'',
            value:{
                ini:''
            },
            selMode:{
                ini:'single',
                listbox:['single', 'multi']
            },
            noPanel:{
                ini:false,
                action:function(value){
                    this.getSubNode('PANEL',true).css('display',value?'none':'block');
                    this.adjustSize(null,true);
                }
            },
            noHandler:{
                ini:false,
                action:function(value){
                    this.getSubNode('LIST').css('display',value?'none':'block');
                    this.adjustSize(null,true);
                }
            },
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            }
        },
        EventHandlers:{
            onCmd:function(profile,item,cmdkey,e,src){},
            onIniPanelView:function(profile, item){},
            beforePagePop:function(profile, item, options, e, src){},
            beforePageClose:function(profile, item, src){},
            afterPageClose:function(profile, item){},
            onShowOptions:function(profile,item,e,src){},
            onItemSelected:function(profile, item,e,src,type){},
            onCaptionActive:function(profile, item,e,src){},
            onClickPanel:function(profile, item, e, src){}
        },
        RenderTrigger:function(){
            var self=this,v,i,ins;
            // set default value
            if(v=self.properties.value){
                (ins=self.boxing()).setUIValue(v,null,null,'render');
                if(i=self.getItemByItemId(v))
                    ins.onItemSelected(self, i);
            }
        },
        _prepareData:function(profile){
            var data = arguments.callee.upper.call(this, profile);
            data.panels = data.items;
            if(data.HAlign)
                data.HAlign = 'text-align:'+data.HAlign+';';
            data._liststyle = data.noHandler?'display:none':'';
            if(data.sideBarStatus=='fold'){
                data._specialIconCls = profile.getClass('ITEMS')+'-icon2';
                data._iconChecked = ' xui-uiborder-hidden-checked xui-icon-menu-checked ';
            }
            return data;
        },
        _prepareItem:function(profile, item){
            var dpn = 'display:none',p=profile.properties,t;
            item.closeDisplay = item.closeBtn?'':dpn;
            item.popDisplay = item.popBtn?'':dpn;
            item._opt = item.optBtn?'':dpn;
            item._itemDisplay = item.hidden?dpn:'';
            if(t = item.itemWidth || p.itemWidth)
                item.itemWidth="width:"+t+(xui.isFinite(t)?"px":"");
            if(t = item.itemAlign || p.itemAlign)
                item.itemAlign = "text-align:"+ t;

            item._bginfo="";
            if(t=item.panelBgClr||p.panelBgClr)
                item._bginfo+="background-color:"+t+";";
            if(t=item.panelBgImg||p.panelBgImg)
                item._bginfo+="background-image:url("+xui.adjustRes(t)+");";
            if(t=item.panelBgImgPos||p.panelBgImgPos)
                item._bginfo+="background-position:"+t+";";
            if(t=item.panelBgImgRepeat||p.panelBgImgRepeat)
                item._bginfo+="background-repeat:"+t+";";
            if(t=item.panelBgImgAttachment||p.panelBgImgAttachment)
                item._bginfo+="background-attachment:"+t+";";
                
            if(xui.isStr(item.overflow))
                item._overflow = item.overflow.indexOf(':')!=-1?(item.overflow):(data.overflow?("overflow:"+data.overflow):"");
            else if(xui.isStr(p.overflow))
                item._overflow = p.overflow.indexOf(':')!=-1?(p.overflow):(p.overflow?("overflow:"+p.overflow):"");

            this._prepareCmds(profile, item);
        },
        getDropKeys:function(profile,node){
            var prop=profile.properties, item=profile.getItemByDom(node);
            return profile.getKey(xui.use(node).id())==profile.keys.PANEL 
                ? ((item&&item.dropKeysPanel) || prop.dropKeysPanel)
                : ((item&&item.dropKeys) || prop.dropKeys);
        },
        _forLazyAppend:function(profile, item, value){
            var prop=profile.properties,box=profile.boxing(),
                moduleHash={},
                zz = profile.moduleClass+"["+profile.moduleXid+"]";
            //dynamic render
            if(prop.lazyAppend){
                var arr=profile.children,a=[];
                xui.arr.each(arr,function(o){
                    if(o[1]==value && 
                        // not rendered, or node not in
                        (!o[0].renderId || xui.UIProfile.getFromDom(xui(o[0].renderId).parent().id())!=profile )
                    ){
                        a.push(o[0]);
                    }
                });
                if(a.length)
                    xui.arr.each(a,function(o,y,z){
                        if(o.moduleClass && o.moduleXid && (y=xui.SC.get(o.moduleClass)) && (y=y.getInstance(o.moduleXid)) && y["xui.Module"]){
                            z=o.moduleClass+"["+o.moduleXid+"]";
                            if(zz!=z && !moduleHash[z]){
                                moduleHash[z]=y;
                            }
                        }
                        box.append(xui(o),value);
                    });

                // $attached is dynamic
                if(profile.$attached){
                    for(var i=0,v;v=profile.$attached[i++];)
                        if(v._render)
                            v._render(true);
                    delete profile.$attached;
                }

                arr=profile.exchildren;
                if(arr && arr.length){
                    a=[];
                    xui.filter(arr,function(o){
                        if(o[1]==value){
                            a.push(o[0]);
                            return false;
                        }
                    });
                    if(a.length)
                        xui.arr.each(a,function(o){
                            if(o.moduleClass && o.moduleXid && (y=xui.SC.get(o.moduleClass)) && (y=y.getInstance(o.moduleXid)) && y["xui.Module"]){
                                z=o.moduleClass+"["+o.moduleXid+"]";
                                if(zz!=z && !moduleHash[z]){
                                    moduleHash[z]=y;
                                }
                            }
                            box.append(xui(o),value);
                        });
                }

                arr=profile.excoms;
                if(arr && arr.length){
                    a=[];
                    xui.filter(arr,function(o){
                        if(o[1]==value){
                            a.push(o[0]);
                            return false;
                        }
                    });
                    if(a.length)
                        xui.arr.each(a,function(o){
                            o.show(null, box, value, false);
                        });
                }

                 xui.each(moduleHash,function(o){
                     o.render();
                 });
            }
        },
        _forIniPanelView:function(profile, item){
            if(!item)return;
            var prop=profile.properties,box=profile.boxing();
            if(!item._$ini){
                item._$ini=true;
                if(profile.onIniPanelView)box.onIniPanelView(profile,item);
                if(item.iframeAutoLoad){
                    box.getPanel(item.id).css('overflow','hidden');
                    var _if=typeof item.iframeAutoLoad=='string'?{url:item.iframeAutoLoad}:xui.clone(item.iframeAutoLoad,true),
                        id="diframe_"+xui.rand(),
                        e=xui.browser.ie && xui.browser.ver<9,
                        ifr=document.createElement(e?"<iframe name='"+id+"'>":"iframe");

                    _if.url=xui.adjustRes(_if.url,false,true);

                    ifr.id=ifr.name=id;
                    if(xui.isHash(item.iframeAutoLoad))item.iframeAutoLoad.frameName=id;
                    item._frameName=id;

                    if(!_if.query)_if.query={};
                    _if.query._rand=xui.rand();
                    ifr.frameBorder='0';
                    ifr.marginWidth='0';
                    ifr.marginHeight='0';
                    ifr.vspace='0';
                    ifr.hspace='0';
                    ifr.allowTransparency='true';
                    ifr.width='100%';
                    ifr.height='100%';
                    box.getPanel(item.id).html("").append(ifr);
    
                    if((_if.method||"").toLowerCase()=="post")
                        xui.Dom.submit(_if.url, _if.query, "post", id, _if.enctype);
                    else
                        ifr.src=_if.url;
                }else if(item.ajaxAutoLoad){
                    var _ajax=typeof item.ajaxAutoLoad=='string'?{url:item.ajaxAutoLoad}:xui.clone(item.ajaxAutoLoad,true),
                        options={rspType:"text"};
                    xui.merge(options, _ajax.options);
                    if(!_ajax.query)_ajax.query={};
                    _ajax.query._rand=xui.rand();
                    box.busy(false,null,"PANEL",profile.getSubIdByItemId(item.id));
                    var node=box.getPanel(item.id);
                    xui.Ajax(xui.adjustRes(_ajax.url,false,true), _ajax.query, function(rsp){
                        node.html(rsp,true,true);
                        box.free();
                    }, function(err){
                        node.html("<div>"+err+"</div>",true,false);
                        box.free();
                    }, null, options).start();
                }
            }
        },
        _showTips:function(profile, node, pos){
            if(profile.properties.disableTips)return;
            if(profile.onShowTips)
                return profile.boxing().onShowTips(profile, node, pos);
            if(!xui.Tips)return;
            var id=node.id,pid,ppid,ks=profile.keys;
            pid=xui.get(node,["parentNode","id"])||"";
            ppid=xui.get(node,["parentNode","parentNode","id"])||"";
            if(id.indexOf(ks.ITEM)===0||pid.indexOf(ks.ITEM)===0||ppid.indexOf(ks.ITEM)===0||
                id.indexOf(ks.HANDLE)===0||pid.indexOf(ks.HANDLE)===0||ppid.indexOf(ks.HANDLE)===0||
                id.indexOf(ks.CMDS)===0||pid.indexOf(ks.CMDS)===0||ppid.indexOf(ks.CMDS)===0){
                var upper=arguments.callee.upper,
                    rtn=upper.apply(this,xui.toArr(arguments));
                upper=null;
                return rtn;
            }
        },
        // drop item
        _onDrop:xui.UI.List._onDrop,
        //for tabs only
        _onresize:function(profile,width,height,force,key){
              var prop=profile.properties,
                item = profile.getItemByItemId(key);

            if(!item){
                key=prop.$UIvalue||prop.value;
                item = profile.getItemByItemId(key);
            }
            if(!item){
                item=prop.items[0];
                key=item&&item.id;
            }
            if(!item)return;
            var panel = profile.boxing().getPanel(key),
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot(),
                list=profile.getSubNode('LIST'),
                
                fzrate=profile.getEmSize()/root._getEmSize(),
                panelfz=panel._getEmSize(fzrate),
                listfz=list._getEmSize(fzrate),
                
                wc=null,
                hc=null,
                listH;

            // caculate by px
            if(width && width!='auto')width=profile.$px(width, null, true);
            if(height && height!='auto')height=profile.$px(height, null, true);

            if(!panel || panel.isEmpty())return;
            
            if(!prop.noHandler){
                //force to get offsetHeight
                listH = list.offsetHeight(true);
                if(profile._listH!=listH){
                    profile._listH=listH;
                    force=true;
                }
            }

            if(force)item._w=item._h=null;
            if(height && item._h!=height){
                item._h=height;
                if(height=='auto'){
                    hc='auto';
                }else{
                    if(!prop.noHandler){
                        height = height-listH;
                    }
                    if(height>0)hc=height;
                };
            }else hc=height;

            if(width && item._w!=width){
                list.width(wc = adjustunit(item._w=width, listfz));
                if(!prop.noHandler){
                    this._adjustHScroll(profile);
                }
            }

            if(!prop.noPanel && (hc||wc))panel.height(adjustunit(hc,panelfz)).onSize();

            if(wc){
                xui.UI._adjustConW(profile, panel, wc);
            }
        },
        _adjustHScroll:function(profile){
            // SCROLL
            var items = profile.getSubNode('ITEMS'),
                innerW=items.width(),
                list = profile.getSubNode('LIST'),
                menu = profile.getSubNode('MENU'),
                caps = profile.getSubNode('CAPTION',true),
                itemsW = 0,
                getItemsW=function(){
                    var w=0;
                    items.children().each(function(item){
                        if(item.offsetWidth==0)return;
                        if(!w){
                            w = item.offsetLeft + item.offsetWidth;
                            return false;
                        }
                    },true);
                    return w;
                },
                getCapsW=function(){
                    var w=0;
                    caps.each(function(item){
                        if(item.clientWidth==0)return;
                        w += item.clientWidth;
                    });
                    return w;
                },
                ignoreCap;

                // init
                items.tagClass('-icon',false);
                items.tagClass('-icon2',false);
                items.tagClass('-menu',false);
                menu.css('display','none');
                caps.css('width','');
                
                profile._mode='normal';
                // try 1: minus caption width
                itemsW = getItemsW();
                if(itemsW>innerW){
                    var capw=getCapsW();
                    if((itemsW - innerW) < capw * .75){
                        var percent = 1- (itemsW - innerW) / capw;
                        caps.each(function(cap){
                            xui(cap).width(Math.floor(cap.clientWidth * percent) +'px');
                        });
                        profile._mode='narrow';
                    }else{
                        ignoreCap=1;
                    }

                    // try 2: icon mode
                    if(ignoreCap || getItemsW()>innerW){
                        items.tagClass('-icon',true);
                        profile._mode='icon';
                        // try 3: menu mode
                        if(getItemsW()>innerW){
                            items.tagClass('-menu',true);
                            menu.setInlineBlock();
                            profile._mode='menu';
                        }
                    }
                }
        }
    }
});xui.Class("xui.UI.Stacks", "xui.UI.Tabs",{
    Initialize:function(){
        var t=this.getTemplate(),keys=this.$Keys;
        t.BOX={tagName:'div',LIST:t.LIST, PNAELS:t.PNAELS};
        delete t.LIST.LEFT;
        delete t.LIST.RIGHT;
        delete t.LIST.DROP;
        delete t.LIST;
        delete t.PNAELS;
        t.$submap.items.ITEM.className = 'xui-uibar xui-uiborder-t xui-uiborder-b';
        t.$submap.items.ITEM.ITEMI.ITEMC.HANDLE.IBWRAP.TOGGLE={
            $order:1,
            className:'xuifont {_tlgchecked}',
             $fonticon:'xui-uicmd-toggle'
        };
        this.setTemplate(t);
        delete keys.LEFT;delete keys.RIGHT;delete keys.DROP;
    },
    Static:{
        Behaviors:{
            DroppableKeys:['PANEL','KEY', 'ITEM']
        },
        Appearances:{
            BOX:{
                position:'absolute',
                overflow:'hidden',
                left:0,
                top:0
            },
            LIST:{
                position:'static'
            },
            ITEMS:{
                position:'static'
            },
            ITEM:{
                $order:0,
                display:'block',
                position:'absolute',
                cursor:'pointer',
                width:'100%',
                left:0
            },
            // to cover Tab's setting, must use ITEMC/ITEMI separately
            ITEMC:{
                display:'block'
            },
            ITEMI:{
                display:'block'
            },
            'ITEM-hover':{
                $order:1
            },
            'ITEM-active ITEMC, ITEM-checked ITEMC':{
                $order:2
            },
            'ITEM-active ITEMI, ITEM-checked ITEMI':{
                $order:2
            },
            'ITEM-active, ITEM-checked':{
                $order:3
            },
            HANDLE:{
                cursor:'pointer',
                display:'block',
                'padding':'.58333em',
                'white-space':'nowrap'
            },
            'ITEM-checked HANDLE':{
            },
            PANEL:{
                position:'absolute',
//                visibility:'hidden',
//                top:'-10000px',
//                left:'-10000px',
                display:'none',
                overflow:'auto'
            },
            CMDS:{
                position:'absolute',
                top:'.5em',
                right:'.75em',
                'text-align':'right',
                'vertical-align': 'middle'
            }
        },
        DataModel:{
            noPanel:null,
            noHandler:null,
            selMode:null,
            borderType:{
                ini:'flat',
                listbox:['none','flat','inset','outset'],
                action:function(v){
                    var ns=this,
                        p=ns.properties,
                        n1=ns.getSubNode('BOX'),
                        reg=/^xui-uiborder-/,
                        flat='xui-uiborder-flat  xui-uiborder-radius',
                        ins='xui-uiborder-inset  xui-uiborder-radius',
                        outs='xui-uiborder-outset  xui-uiborder-radius',
                        root=ns.getRoot();
                    n1.removeClass(reg);
                    switch(v){
                        case 'flat':
                        n1.addClass(flat);
                        break;
                        case 'inset':
                        n1.addClass(ins);
                        break;
                        case 'outset':
                        n1.addClass(outs);
                        break;
                    }

                    //force to resize
                    ns.adjustSize();
                }
            }
        },
        LayoutTrigger:function(){
            var v=this.properties.borderType;
            if(v&&v!='none')this.boxing().setBorderType(v,true);
        },
        _onresize:function(profile,width,height,force,key){
              var prop=profile.properties,
                noPanel=prop.noPanel,
                  cb=xui.browser.contentBox,
                item = profile.getItemByItemId(key);

            if(!item){
                key=prop.$UIvalue||prop.value;
                item = profile.getItemByItemId(key);
            }
            if(!item){
                item=prop.items[0];
                key=item&&item.id;
            }
            if(!item)return;

            var panel = profile.boxing().getPanel(key),
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot(),
                box=profile.getSubNode('BOX'),
                list=profile.getSubNode('LIST'),

                fzrate=profile.getEmSize()/root._getEmSize(),
                panelfz=panel._getEmSize(fzrate),
                listfz=list._getEmSize(fzrate),

                type = prop.borderType,
                // have to use borderLeftWidth( ff will result 0 with borderWidth)
                bw =!cb?0: (type=='flat'||type=='inset'||type=='outset') ? box._borderW() : 0,
                wc=null,
                hc=null,
                off,
                temp,t1,t2,obj,top;

            if(!panel || panel.isEmpty())return;

            // caculate by px
            width=width?profile.$px(width, null,true):width;
            height=height?profile.$px(height, null,true):height;

            // change value
            if(height){
                height -= bw;
                t2=t1=0;
                xui.arr.each(prop.items,function(o){
                    obj = profile.getSubNodeByItemId('ITEM', o.id);
                    obj.cssRegion({bottom:'auto',top:adjustunit(t1,obj)});

                    // force to get offsetHeight
                    off=obj.offsetHeight(true);
                    t1 += off
                    if(o.id == key)return false;
                });
                xui.arr.each(prop.items,function(o){
                    if(o.id == key)return false;
                    obj = profile.getSubNodeByItemId('ITEM', o.id);
                    obj.cssRegion({top:'auto',bottom:adjustunit(t2,obj)});

                    // offsetHeight maybe not set here
                    off=obj.offsetHeight(true);
                    t2+= off
                },null,true);

                temp = height - t1 - t2;
                if(temp>0){
                    top=t1;
                    hc=temp;
                }

                box.height(adjustunit(height));
            }
            if(width){
                width-=bw;
                wc=width;
                box.width(adjustunit(width));
            }    

            panel.cssRegion({
                width:wc?adjustunit(wc,panelfz):null,
                height:hc?adjustunit(hc,panelfz):null,
                top:adjustunit(top,panelfz),
                left:0+profile.$picku()
            },true);
            if(wc){
                list.width(wc = adjustunit(wc,listfz));
                xui.UI._adjustConW(profile, panel, wc);
            }
        },
        _adjustScroll:null
    }
});
xui.Class("xui.UI.ButtonViews", "xui.UI.Tabs",{
    Initialize:function(){        
        var t=this.getTemplate(),keys=this.$Keys;
        t.LIST.className='xui-uibar';
        this.setTemplate(t);
        t.$submap.items.ITEM.className = 'xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius {itemClass} {disabled} {readonly} {itemPosCls}';
        delete keys.LEFT;delete keys.RIGHT;delete keys.DROP;
    },
    Static:{
        Appearances:{
            LIST:{
                'z-index':'2',
                position:'absolute',
                'white-space': 'nowrap',
                overflow:'hidden'
            },
            // for auto height
            'LIST-attop, LIST-atbottom':{
                $order:2,
                position:'relative'
            },
            LISTBG:{
                display:'none'
            },
            MENU:{
                display:'none',
                margin:'.25em',
                padding:'.25em',
                cursor:'pointer'
            },
            MENU2:{
                display:'none',
                'text-align':'center'
           },
            MENUICON2:{
                position:'relative',
                margin:'.09375em',
                padding:'.1875em',
                cursor: 'pointer'
            },
            ITEMS:{
                'z-index':'2',
                position:'relative',
                left:0,
                top:0,
                width:'100%',
                height:'100%',
                'white-space': 'nowrap',
                'overflow-x':'hidden',
                'overflow-y':'scroll'
            },
            'ITEMS-left, ITEMS-left ITEMC':{
                $order:1,
                height:'auto',
                'text-align': 'left'
            },
            'ITEMS-center, ITEMS-center ITEMC':{
                $order:1,
                height:'auto',
                'text-align': 'center'
            },
            'ITEMS-right, ITEMS-right ITEMC':{
                $order:1,
                height:'auto',
                'text-align': 'right'
            },
            'ITEMS-left HANDLE, ITEMS-right HANDLE':{
                $order:2,
                display:'block'
            },
            ITEM:{
                $order:0,
                margin:'.166667em',
                position:'relative',
                cursor:'pointer',
                'padding':'0 .125em 0 0',
                'vertical-align':'top'
            },
            ITEMI:{
                $order:0,
                'padding-left':'.125em',
                //keep this same with ITEM
                'vertical-align':'top'
            },
            'ITEMS-block ITEM, ITEMS-block ITEMI, ITEMS-block ITEMC':{
                $order:2,
                display:'block'
            },
            ITEMC:{
                $order:0,
                padding:'.15em 0 .125em 0',
                //keep this same with ITEM
                'vertical-align':'top',
                'text-align': 'center'
            },             
            HANDLE:{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie6?1:null,
                cursor:'pointer',
                'vertical-align':'middle',
                margin:'.125em'
            },
            'ITEM-checked HANDLE':{
            }
        },
        DataModel:{
            HAlign:null,
            barLocation:{
                ini:'top',
                listbox:['top','bottom','left','right'],
                action:function(v){
                    var self=this,
                        hs = self.getSubNode('LIST'),
                        h = self.getSubNode('ITEMS'),
                        unit = 0+self.$picku();
                    switch(v){
                        case 'left':
                            hs.cssRegion({left:unit,top:unit,right:'auto',bottom:unit});
                        break;
                        case 'top':
                            hs.cssRegion({left:unit,top:unit,right:unit,bottom:'auto'});
                        break;
                        case 'right':
                            hs.cssRegion({left:'auto',top:unit,right:unit,bottom:unit});
                        break;
                        case 'bottom':
                            hs.cssRegion({left:unit,top:'auto',right:unit,bottom:unit});
                       break;
                    }
                    switch(v){
                        case 'left':
                        case 'right':
                            h.tagClass('-block',true);
                            break;
                        case 'top':
                        case 'bottom':
                            h.tagClass('-block',false);
                            hs.height('auto');
                            break;
                    }
                    // add 'at' to be distinguished from xui-uibar-bottom
                    hs.tagClass('(-attop|-atbottom|-atleft|-atright)',false).tagClass('-at'+v, true);
                    this.adjustSize();
                }
            },
            barHAlign:{
                ini:'left',
                listbox:['left','center', 'right'],
                action:function(v){
                    var hl=this.getSubNode('ITEMS');
                    hl.tagClass('(-left|-right|-center)',false).tagClass('-'+v, true);
                }
            },
            barVAlign:{
                ini:'top',
                listbox:['top','bottom'],
                action:function(v){
                    var hl = this.getSubNode('ITEMS'),
                        unit = 0+this.$picku();
                    if(v=='top')
                        hl.cssRegion({top:unit,bottom:'auto'});
                    else
                        hl.cssRegion({bottom:unit,top:'auto'});
                    this.adjustSize();
                }
            },
            barSize:{
                $spaceunit:1,
                ini:'2em',
                action:function(v){
                    this.adjustSize();
                }
            },
            borderType:{
                ini:'none',
                listbox:['none','flat','inset','outset'],
                action:function(v){
                    var ns=this,
                        p=ns.properties,
                        n1=ns.getSubNode('LIST'),
                        reg=/^xui-uiborder-/,
                        flat='xui-uiborder-flat xui-uiborder-radius',
                        ins='xui-uiborder-inset xui-uiborder-radius',
                        outs='xui-uiborder-outset xui-uiborder-radius',
                        root=ns.getRoot();
                    n1.removeClass(reg);
                    switch(v){
                        case 'flat':
                        n1.addClass(flat);
                        break;
                        case 'inset':
                        n1.addClass(ins);
                        break;
                        case 'outset':
                        n1.addClass(outs);
                        break;
                    }

                    //force to resize
                    this.adjustSize();
                }
            },
            sideBarStatus:{
                ini:'expand',
                listbox:['expand','fold'],
                action:function(v){
                   var self = this,
                        t = self.properties,
                        us = xui.$us(t),
                        adjustunit = function(v,emRate){return self.$forceu(v, us>0?'em':'px', emRate)},
                        hl = self.getSubNode('ITEMS'),
                        menu2 =  self.getSubNode('MENUICON2');

                    if(t.sideBarStatus=='fold'){
                        hl.tagClass('-icon2',true);
                        menu2.tagClass('-checked',true);
                    }else{
                        hl.tagClass('-icon2',false);
                        menu2.tagClass('-checked',false);
                    }

                    this.adjustSize();
                }
            },
            sideBarSize:{
                ini:'3em',
                action:function(v){
                    this.adjustSize();
                }
            }
        },
        Behaviors:{
            MENU2:{
                onClick:function(profile, e, src){
                    profile.boxing().setSideBarStatus(profile.properties.sideBarStatus=='fold'?'expand':'fold', true);
                }
            }
        },
        LayoutTrigger:function(){
            var pro = this.properties;
            this.boxing().setBarLocation(pro.barLocation,true)
            .setBarHAlign(pro.barHAlign,true)
            .setBarVAlign(pro.barVAlign,true);

            if(pro.barLocation=='top'||pro.barLocation=='bottom'){
                this.getSubNode('ITEMS').addClass('xui-css-noscroll');
            }
            if(pro.borderType&&pro.borderType!='none')this.boxing().setBorderType(pro.borderType,true);
        },
        _onresize:function(profile,width,height,force,key){
            var prop = profile.properties,
                noPanel = prop.noPanel,
                noHandler = prop.noHandler,
                item = profile.getItemByItemId(key);

            if(!item){
                key=prop.$UIvalue||prop.value;
                item = profile.getItemByItemId(key);
            }
            if(!item){
                item=prop.items[0];
                key=item&&item.id;
            }
            if(!item)return;

            var panel = profile.boxing().getPanel(key),
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                // caculate by px
                ww=width?profile.$px(width, null, true):width, 
                hh=(height&&height!='auto')?profile.$px(height, null, true):height,
                root = profile.getRootNode(),
                hs = profile.getSubNode('LIST'),
                hl = profile.getSubNode('ITEMS'),
                menu2 =  profile.getSubNode('MENU2'),
 
                fzrate=profile.getEmSize()/profile.getRoot()._getEmSize(),
                panelfz=panel._getEmSize(fzrate),
                hsfz=hs._getEmSize(fzrate),
                hlfz=hl._getEmSize(fzrate),
                cb=xui(root).contentBox(),
                type = prop.borderType,
                bw = !cb?0:(type=='flat'||type=='inset'||type=='outset') ? hs._borderW() : 0,
                wc=null,
                hc=null,
                top, left, itmsH;

            // side bar
            menu2.css('display','none');

            if(noHandler){
                wc=ww;
                hc=hh;
            }else{
                if(prop.barLocation=='top'||prop.barLocation=='bottom'){
                    if(xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB)){
                    }else{
                        hl.css('overflow-y','hidden');
                    }
                    itmsH = hs.height(prop.barSize||'auto').offsetHeight(true);
                    hl.css('position','relative');

                    if(width){
                        hs.width(adjustunit(ww-bw, hsfz));
                        hl.width(adjustunit(ww-bw, hlfz));
                        
                        // for nopanel:
                        if(noPanel && height!='auto'){
                            hs.height(adjustunit(hh-bw, hsfz));
                            hl.height(adjustunit(hh-bw, hsfz));
                        }

                        if(!noHandler)
                            profile.box._adjustHScroll(profile);

                        left = 0;
                        wc=ww;
                    }
                    if(hh!='auto'){
                        // caculate by px
                        if(hh-itmsH>0)hc=hh-itmsH-bw;
                        //hs.height(adjustunit(itmsH, hsfz));
                    }else{
                        hc=hh;
                    }
                    var t;
                    if(prop.barLocation=='top'){
                        // ensure it's the last
                        if((t=root.firstElementChild||root.firstChild)!=hs.get(0)){
                            if(t)root.insertBefore(hs.get(0), t);
                            else root.appendChild(hs.get(0));
                        }
                    }else if(prop.barLocation=='bottom'){
                        // ensure it's the last
                        if((root.lastElementChild||root.lastChild)!=hs.get(0)){
                            root.appendChild(hs.get(0));
                        }
                    }
                }else{
                    //reset to default
                    if(xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB)){
                    }else{
                        // bug: in mobile android, it will make hs._nodes.length=0
                        hl.css('overflow-y','scroll');
                    }
                    // side bar
                    menu2.css('display',prop.sideBarSize?'block':'none');

                    if(!noHandler)
                        profile.getSubNode('CAPTION',true).css('width','');

                    // dont support auto height for 'top' or 'bottom' barLocation
                    if(hh=='auto'){
                        hh=300;
                    }

                    if(height){
                        // for nopanel:
                        if(noPanel){
                            if(xui.browser.isTouch && (xui.browser.isAndroid||xui.browser.isBB)){
                            }else{
                                hl.css('overflow-y','hidden');
                            }
                            hs.width(adjustunit(ww-bw, hsfz));
                            hl.width(adjustunit(ww-bw, hsfz));
                        }

                        // for nopanel:
                        hs.height(adjustunit(hh-bw, hsfz));
                        hl.height('auto');
                        // for scroll by mouse wheel
                        if(hl.height()>=hs.height()){
                            hl.height(adjustunit(hh-bw-(prop.sideBarSize?menu2.offsetHeight():0), hlfz));
                        }
                        hl.css('position', prop.barVAlign=='bottom'?'absolute':'relative');
                        hc=hh;
                    }
                    if(height || width){
                        var v = profile.$px(prop.sideBarStatus=='fold' ? prop.sideBarSize : prop.barSize, hlfz);
                        var vv = hl._paddingW() + hl._marginW();

                        //caculate by px
                        left = prop.barLocation=='left'?bw+profile.$px(v+vv, hsfz):0;
                        wc = ww-profile.$px(v+vv, hsfz)-bw;

                        hl.width('auto');

                        if(!noPanel){
                            hs.width( adjustunit(v + vv , hsfz) );
                            hl.width( adjustunit(v + xui.Dom.getScrollBarSize(), hlfz) );
                        }
                    }
                }
            }

            if(!noPanel){
                panel.cssRegion({
                    width : (wc = wc?adjustunit(wc,panelfz):null),
                    height : hc?adjustunit(hc,panelfz):null,
                    left : noHandler?0:adjustunit(left,panelfz)
                },true);
                if(wc){
                    xui.UI._adjustConW(profile, panel, wc);
                }
            }
        }
    }
});xui.Class("xui.UI.RadioBox", "xui.UI.List",{
    Initialize:function(){
        //modify default template for shell
        var t = this.getTemplate();
        t.className='{_className}';
        t.ITEMS.className='{_bordertype}';
        t.$submap={
            items:{
                ITEM:{
                    className:'xui-showfocus {_itemRow} {itemClass} {disabled} {readonly}',
                    style:'{itemStyle}{_itemDisplay}',
                    tabindex: '{_tabindex}',
                    MARK:{
                        $order:0,
                        className:'xuifont',
                        $fonticon:'{_fi_markcls}'
                    },
                    ICON:{
                        $order:1,
                        className:'xuicon {imageClass}  {picClass}',
                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                        text:'{iconFontCode}'
                    },
                    CAPTION:{
                        text : '{caption}',
                        $order:2
                    }
                }
            }
        };
        this.setTemplate(t);
    },
    Static:{
        _DIRTYKEY:'MARK',
        _ITEMMARKED:true,
        Appearances:{
            ITEM:{
               display:xui.$inlineBlock,
               border:0,
               padding:'.5em',
               position:'relative',
               zoom:xui.browser.ie?1:null,
               cursor:'pointer',
               overflow:'hidden',
               'vertical-align':'middle'
            },
            // to cover LIST's
            'ITEM-checked':{
                padding:'.5em'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            },
            ITEMS:{
                overflow:'auto',
                'overflow-x': 'hidden',
                position:'relative',
                'line-height':'1.25em'
            },
            MARK:{
               $order:1,
               cursor:'pointer',
               margin: '0 .5em 0 .25em',
               'vertical-align':'middle'
            }
        },
        DataModel:{
            tagCmds:null,
            borderType:{
                ini:'none'
            },
            checkBox:{
                ini:false,
                action:function(v){
                    this.getSubNode('MARK',true).replaceClass(v ? /(uicmd-radio)|(\s+uicmd-radio)/g : /(^uicmd-check)|(\s+uicmd-check)/g , v ? ' xui-uicmd-check' : ' xui-uicmd-radio');
                }
            }
        },
        Behaviors:{
            HoverEffected:{ITEM:null,MARK:'MARK'},
            ClickEffected:{ITEM:null,MARK:'MARK'}
        },
        EventHandlers:{
            onCmd:null
        },
        _prepareItem:function(profile, item){
            item._fi_markcls = profile.properties.checkBox?'xui-uicmd-check':'xui-uicmd-radio';
            item._itemRow = profile.properties.itemRow?'xui-item-row':'';
        }
    }
});
xui.Class("xui.UI.StatusButtons", ["xui.UI.List"],{
    Initialize:function(){
        //modify default template fro shell
        var t = this.getTemplate();
        t.className='{_className}';
        t.ITEMS.className='{_bordertype}';
        t.$submap={
            items:{
                ITEM:{
                    className:'{_itemClass} {itemClass} {disabled} {readonly}',
                    style:'{itemPadding};{itemMargin};{itemWidth};{itemAlign};{itemStyle}',
                    tabindex: '{_tabindex}',
                    ICON:{
                        $order:10,
                        className:'xuicon {imageClass}  {picClass}',
                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                        text:'{iconFontCode}'
                    },
                    CAPTION:{
                        $order:11,
                        text:'{caption}'
                    },
                    DROP:{
                        $order:12,
                        className:'xuifont',
                        $fonticon:'xui-uicmd-arrowdrop',
                        style:'{_dropDisplay}'
                    },
                    FLAG:{
                        $order:13,
                        className:'xui-display-none {flagClass}',
                        style:'{_flagStyle};{flagStyle}',
                        text:'{flagText}'
                    }
                }
            }
        };
        this.setTemplate(t);
    },
    Static:{
        Appearances:{
            ITEMS:{
                position:'relative',
                overflow:'visible'
            },
            ITEM:{
                'vertical-align':'middle',
                position:'relative',
                padding:'.5em',
                margin:'.166667em',
                cursor:'pointer',
                'white-space':'nowrap'
            },
            'ITEM-hover, ITEM-active, ITEM-checked':{
            },
            'ITEM-hover':{
            },
            'ITEM-active':{
            },
            'ITEM-checked':{
            },
            CAPTION:{
                display:xui.$inlineBlock,
                zoom:xui.browser.ie6?1:null,
                'vertical-align':'middle',
                'font-size':'1em'
            },
            DROP:{
                'vertical-align': 'middle'
            },
            FLAG:{
                top:'-.5em',
                right:'-.5em',
                position:'absolute',
                'z-index':10
            }
        },
        DataModel:({
            maxHeight:null,
            tagCmds:null,
            height:'auto',

            itemMargin:{
                ini:"",
                action:function(value){
                    this.getSubNode('ITEM',true).css('margin',v);
                }
            },
            itemPadding:{
                ini:"",
                action:function(v){
                    this.getSubNode('ITEM',true).css('padding',v);
                }
            },
            itemWidth:{
                $spaceunit:1,
                ini:"auto",
                action:function(v){
                    this.getSubNode('ITEM',true).width(v||'auto');
                }
            },
            itemAlign:{
                ini:"",
                listbox:['','left','center','right'],
                action:function(value){
                    this.getSubNode('ITEM',true).css('text-align',value);
                }
            },
            itemType:{
                ini:"button",
                listbox:['text','button','dropButton'],
                action:function(value){
                    this.boxing().refresh();
                }
            },
            connected:{
                ini:false,
                action:function(){
                    this.boxing().refresh();
                }
            }
        }),
        Behaviors:{
            DroppableKeys:["ITEMS"]
        },
        EventHandlers:{
            onCmd:null
        },
        _prepareItem:function(profile, item, a, b, i, l){
            var p = profile.properties, t,
                type=item.type||p.itemType;
            item._tabindex = p.tabindex;

            if(p.connected)item.itemMargin = "margin:" + (i===0?"0":"0 0 0 -1px");
            else if(t = item.itemMargin || p.itemMargin)item.itemMargin = "margin:" + t;
            
            if(t = item.itemPadding || p.itemPadding)item.itemPadding = "padding:" + t;

            if(t = item.itemWidth || p.itemWidth)item.itemWidth = "width:"+ profile.$forceu(t||'auto');
            if(t = item.itemAlign || p.itemAlign)item.itemAlign = "text-align:"+ t;

            if(item.flagText||item.flagClass)item._flagStyle='display:block';
            if(!item.flagClass)item.flagClass='xui-uiflag-1';

            item._itemClass = type == "text" ? "xui-node-a" 
                : ("xui-ui-btn xui-uibar xui-uigradient " + ( p.connected ? ( i==0 ? "xui-uiborder-radius-tl xui-uiborder-radius-bl xui-uiborder-noradius-r" 
                    : i===l-1 ? "xui-uiborder-radius-tr xui-uiborder-radius-br xui-uiborder-noradius-l"
                    :"xui-uiborder-noradius") 
                : "xui-uiborder-radius"));

            item._dropDisplay=type=="dropButton"?'':'display:none';
        }
    }
});

xui.Class("xui.UI.TreeBar",["xui.UI","xui.absList","xui.absValue"],{
    $Start:function(t){
        if(t=this.Static.RenderTrigger)t.$order = -1;
    },
    Instance:{
        _setCtrlValue:function(value, flag){
            return this.each(function(profile){
                if(!profile.renderId)return;

                var box = profile.boxing(),
                    uiv = box.getUIValue(),
                    properties = profile.properties,
                    fun=function(key,o,b){
                        profile.getSubNodeByItemId(key, o).tagClass('-checked', b);
                    },
                    selmode=properties.selMode
                    ;
                if(selmode=='single'){
                    var itemId = profile.getSubIdByItemId(uiv);
                    if(uiv && itemId)
                        fun('BAR', uiv, false);

                    itemId = profile.getSubIdByItemId(value);
                    if(itemId){
                        fun('BAR', value, true);
                        //scroll
                        if(!profile._noScroll){
                            var o = profile.getSubNode('ITEM',itemId);
                            if(o){
                                var items = profile.getSubNode('BOX'),
                                    offset = o.offset(null, items),
                                    top = offset?offset.top:0,
                                    height = o.offsetHeight(),
                                    sh=items.scrollHeight(),
                                    st=items.scrollTop(),
                                    hh=items.height();
                                if(sh > hh)
                                    if(top<st || (top+height)>(st+hh))
                                        items.scrollTop(top);
                            }
                        }
                    }
                }else if(selmode=='multi'||selmode=='multibycheckbox'){
                    uiv = uiv?uiv.split(properties.valueSeparator):[];
                    value = value?value.split(properties.valueSeparator):[];
                    if(flag){
                        xui.arr.each(value,function(o){
                            fun('BAR', o);
                            fun('MARK', o);
                        });
                    }else{
                        //check all
                        xui.arr.each(uiv,function(o){
                            fun('BAR', o, false);
                            fun('MARK', o, false);
                        });
                        xui.arr.each(value,function(o){
                            fun('BAR', o);
                            fun('MARK', o);
                        });
                    }
                }
            });
        },
        insertItems:function(arr, pid/*true: the current item*/, base/*true: the current item*/,before, toggle){
            var node,data,
                b=this._afterInsertItems;

            return this.each(function(profile){
                // prepare properties format
                var tar,r,k,newsub,
                    prop=profile.properties;

                data=profile.box._adjustItems(arr);

                // current 
                if(pid===true){
                    v=prop.$UIvalue||prop.value;
                    if(v)v=(v+'').split(prop.valueSeparator);
                    k=profile.getItemByItemId(v[0]);
                    pid=k?k.id:null;
                }

                if(pid){
                    k=profile.getItemByItemId(pid);
                    tar = xui.isArr(k.sub)?k.sub:(newsub=true, k.sub= []);
                }else{
                    k=prop;
                    tar = k.items ||(k.items=[])
                }
                //1
                if(profile.renderId){
                    if(base===true){
                        v=prop.$UIvalue||prop.value;
                        if(v)v=(v+'').split(prop.valueSeparator);
                        k=profile.getItemByItemId(v[0]);
                        base=k?k.id:null;
                    }
                    if(base){
                        node=profile.getSubNodeByItemId('ITEM', base);
                        if(node){
                            r=profile._buildItems('items', profile.box._prepareItems(profile, data, pid));
                            if(before)
                                node.addPrev(r);
                            else
                                node.addNext(r);
                        }
                    }else{
                        if(!pid)
                            node=profile.getSubNode('ITEMS');
                        else if(pid){
                            if(newsub){
                                profile.getSubNodeByItemId('TOGGLE', pid)
                                    .removeClass('xui-icon-placeholder xui-uicmd-none')
                                    .addClass('xui-uicmd-toggle');
                            }
                            if(k._inited){
                                node=profile.getSubNodeByItemId('SUB', pid);
                            }
                        }
                        if(node){
                            r=profile._buildItems('items', profile.box._prepareItems(profile, data, pid));
                            if(before)
                                node.prepend(r);
                            else
                                node.append(r);
                        }
                    }
                }
                //2
                //must be here
                if(!base)
                    xui.arr.insertAny(tar,data, before?0:-1);
                else{
                    var index = xui.arr.subIndexOf(tar, 'id', base);
                    xui.arr.insertAny(tar,data, before?index:(index+1));
                }
                //3
                if(profile.renderId && toggle!==false){
                    // try to open root subs
                    if(!pid){
                        profile.boxing()._toggleNodes(data, true, true, true);
                    }
                    // try to open parent node
                    else if (profile.getItemByItemId(pid)._inited){
                        if(!(('iniFold' in k)?k.iniFold:profile.properties.iniFold))
                            profile.boxing()._toggleNodes(data, true, true, true);
                    }
                }
                
                if(b && profile.renderId)
                    profile.boxing()._afterInsertItems(profile, data, pid, base, before);

                if(profile.renderId && pid){
                    profile.box._tofold(profile,k,pid);
                }

            });
        },
        _toggleNodes:function(items, expand, recursive, init){
            var self=this,prf=self.get(0),pro=prf.properties,
                f=function(items,expand,recursive,init){
                    if(xui.isArr(items)){
                        xui.arr.each(items,function(o){
                            if(init && (xui.isBool(o.iniFold)?o.iniFold:pro.iniFold))return;
                            self.toggleNode(o.id, expand, false, recursive);
                            if(recursive && o.sub && xui.isArr(o.sub) && o.sub.length)
                                f(o.sub,expand,true,init);
                        });
                    }
                };
            f(items,expand,recursive,init);
            return self;
        },
        /*
        *expand:true->expand false->fold
        *recursive:true open recursively
        */
        toggleNode:function(id, expand, recursive, stopanim, callback){
            var profile=this.get(0),ns=this,self=arguments.callee;
            if(id){
                var o=profile.getItemByItemId(id);
                if(o && o.sub && (!xui.isSet(expand) || !!expand !== !!o._checked))
                    profile.box._setSub(profile, o, xui.isSet(expand) ?!!expand:!o._checked, recursive, stopanim||recursive, callback);
            }else{
                xui.arr.each(profile.properties.items,function(item){
                    if(item.sub)self.call(ns,item.id,expand,recursive);
                })
            }
            return this;
        },
        /*
        *open to deep node
        */
        openToNode:function(id, triggerEvent){
            return this.each(function(profile){
                var res=false, a=[],
                    fun=function(arr, catId, layer){
                        layer = layer || 0;
                        var me=arguments.callee;
                        xui.arr.each(arr,function(o){
                            if(o.id==catId){
                                a.push(o);
                                res=true;
                                return false;
                            }
                            if(o.sub && xui.isArr(o.sub)){
                                res = me.call(me, o.sub, catId, ++layer)
                                if(res){
                                    a.push(o);
                                    return false;
                                }
                            }
                        });
                        return res;
                    }
                fun(profile.properties.items, id);
                if(res){
                    a.reverse();
                    xui.arr.each(a,function(o,i){
                        if(o.sub){
                            profile.boxing().toggleNode(o.id,true);
                            // for the last one, trigger its onclick event
                            if(triggerEvent!==false &&  i==a.length-1 && !(o.hasOwnProperty('group')?o.group:profile.properties.group))
                                profile.boxing().fireItemClickEvent(o.id);
                        }else if(triggerEvent!==false){
                            profile.boxing().fireItemClickEvent(o.id);
                        }
                    });
                }
            });
        }
    },
    Static:{
        _focusNodeKey:'BAR',
        Templates:{
            tagName : 'div',
            style:'{_style}',
            className:'{_className}',
            ondrag:'return false',
            onselectstart:'return false',
            BORDER:{
                tagName : 'div',
                className:"xui-uibase",
                BOX:{
                    tagName : 'div',
                    onselectstart:'return false',
                    ITEMS:{
                        tagName : 'div',
                        className:'{_cmdsalign}',
                        text:"{items}"
                    }
                }
            },
            $submap:{
                items:{
                    ITEM:{
                        className:'',
                        style:'{_itemDisplay}',
                        tagName : 'div',
                        BAR:{
                            $order:0,
                            tabindex: '{_tabindex}',
                            className:'xui-uitembg  xui-showfocus  {itemClass} {cls_group} {cls_fold} {_split} {disabled} {readonly}',
                            style:'{itemStyle};{_splitstyle}',
                            RULER:{
                                $order:2,
                                style:'{_ruleDisplay};{rulerStyle}',
                                text:'{innerIcons}'
                            },
                            TOGGLE:{
                                $order:3,
                                style:'{_tglDisplay}',
                                className:'xuifont',
                                $fonticon:'{_fi_togglemark}'
                            },
                            LTAGCMDS:{
                                $order:4,
                                tagName:'span',
                                style:'{_ltagDisplay}',
                                text:"{ltagCmds}"
                            },
                            MARK:{
                                $order:5,
                                className:'xuifont',
                                $fonticon:'xui-uicmd-check',
                                style:'{mark2Display}'
                            },
                            ITEMICON:{
                                $order:6,
                                className:'xuicon {imageClass} {picClass}',
                                style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                                text:'{iconFontCode}'
                            },
                            ITEMCAPTION:{
                                text : '{caption}',
                                style:'{_capDisplay}',
                                className:"{disabled}  {readonly}",
                                $order:7
                            },
                            EXTRA:{
                                style:'{_extraDisplay}',
                                text : '{ext}',
                                $order:8
                            },
                            RTAGCMDS:{
                                $order:9,
                                tagName:'span',
                                style:'{_rtagDisplay}',
                                text:"{rtagCmds}"
                            },
                            OPT:{
                                $order:10,
                                style:'{_optDisplay}',
                                className:'xuifont',
                                $fonticon:'{_fi_optClass}'
                            }
                        },
                        SUB:{
                            $order:1,
                            tagName : 'div',
                            text:xui.UI.$childTag
                        }
                    }
                },
                'items.ltagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,'items.tagCmds'+(map[v.type]||'.button'),result)
                },
                'items.rtagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,'items.tagCmds'+(map[v.type]||'.button'),result)
                },
                'items.tagCmds.text':xui.UI.$getTagCmdsTpl('text'),
                'items.tagCmds.button':xui.UI.$getTagCmdsTpl('button'),
                'items.tagCmds.image':xui.UI.$getTagCmdsTpl('image')
            }
        },
        Appearances:{
            KEY: {
                'border':0
            },
            EXTRA:{
                display:'none'
            },
            BOX:{
                left:0,
                overflow: 'auto',
                'overflow-x': 'hidden',
                position:'relative',
                clear:"both"
            },
            ITEMS:{
                overflow: 'hidden'
            },
            ITEM:{
                'white-space': 'nowrap',
                position:'relative',
                overflow:'hidden'
            },
            BAR:{
               cursor:'pointer',
               zoom:xui.browser.ie?1:null,
               position:'relative',
               display:'block',
               overflow: 'hidden',
               padding:'.25em .5em',
                'border-radius': '.3px 0 0 3px',
                '-moz-border-radius': '3px 0 0 3px',
                '-webkit-border-radius': '3px 0 0 3px',
                '-o-border-radius': '3px 0 0 3px',
                '-ms-border-radius': '3px 0 0 3px',
                '-khtml-border-radius': '3px 0 0 3px',

               'outline-offset':'-1px',
               '-moz-outline-offset':(xui.browser.gek && xui.browser.ver<3)?'-1px !important':null
            },
            SUB:{
                overflow:'hidden',
                zoom:xui.browser.ie?1:null,
                height:0,
                'font-size':xui.browser.ie68?'1px':null,
                //1px for ie8
                'line-height':xui.browser.ie68?'1px':null,
                position:'relative',
                'margin-left':'1.75em'
            },
            MARK:{
               cursor:'pointer',
               'vertical-align':'middle'
            },
            'BAR-group':{
                $order:4,
                border:'none'
            },
            ITEMCAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                padding:'.167em',
                'white-space': 'normal'
            },
            OPT:{
                $order:10,
                position:'absolute',
                left:'auto',
                top:'50%',
                'margin-top':'-0.5em',
                right:'.167em',
                display:'none'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            'ITEMS-tagcmdleft RTAGCMDS':{
                "padding-right":'.333em',
                "float":"left"
            },
            'ITEMS-tagcmdfloatright RTAGCMDS':{
                "padding-right":'.333em',
                "float":"right"
            },
            TOGGLE:{
                padding:'0 .334em 0 0'
            }
        },
        Behaviors:{
            HoverEffected:{TOGGLE:'TOGGLE', BAR:'BAR',OPT:'OPT',CMD:'CMD'},
            ClickEffected:{TOGGLE:'TOGGLE', BAR:'BAR',OPT:'OPT',CMD:'CMD'},
            DraggableKeys:["BAR"],
            NoDraggableKeys:['TOGGLE'],
            DroppableKeys:["BAR","TOGGLE","BOX"],
            onSize:xui.UI.$onSize,
            TOGGLE:{
                onClick:function(profile, e, src){
                    var properties = profile.properties,
                        domId=xui.use(src).id(),
                        item = profile.getItemByDom(domId);

                    if(properties.disabled || item.disabled)return false;
                    if(!('sub' in item))return false;
                    profile.box._setSub(profile, item, !item._checked);

                    // not to fire BAR's onclick event;
                    return false;
                }
            },
            BAR:{
                onDblclick:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        rtn=profile.onDblclick && profile.boxing().onDblclick(profile, item, e, src);
                    if(item.sub && rtn!==false){
                        profile.getSubNode('TOGGLE',profile.getSubId(src)).onClick();
                    }
                },
                onClick:function(profile, e, src){
                    return profile.box._onclickbar(profile,e,src);
                },
                onKeydown:function(profile, e, src){
                    return profile.box._onkeydownbar(profile,e,src);
                },
                onContextmenu:function(profile, e, src){
                    if(profile.onContextmenu)
                        return profile.boxing().onContextmenu(profile, e, src, profile.getItemByDom(src) )!==false;
                },
                onMouseover:function(profile, e, src){
                    if(xui.browser.fakeTouch || xui.browser.deviceType == 'touchOnly')return;
                    var item = profile.getItemByDom(src);
                    if(!item)return;
                    if(!profile.properties.optBtn && !item.optBtn)return;
                    profile.getSubNode('OPT',profile.getSubId(src)).setInlineBlock();
                },
                onMouseout:function(profile, e, src){
                    if(xui.browser.fakeTouch || xui.browser.deviceType == 'touchOnly')return;
                    var item = profile.getItemByDom(src);
                    if(!item)return;
                    if(!profile.properties.optBtn && !item.optBtn)return;
                    profile.getSubNode('OPT',profile.getSubId(src)).css('display','none');
                }
            },
            OPT:{
                onClick:function(profile, e, src){
                    if(profile.onShowOptions){
                        var item = profile.getItemByDom(src);
                        if(!item)return;
                        if(!profile.properties.optBtn && !item.optBtn)return;
                        profile.boxing().onShowOptions(profile, item, e, src);
                    }
                    return false;
                },
                onDblclick:function(profile, e, src){
                    return false;
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var prop=profile.properties,
                        item=profile.getItemByDom(xui.use(src).parent().get(0));
                    if(!item)return false;

                    if(prop.disabled|| item.disabled|| item.type=='split')return false;
                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,item, xui.use(src).id().split('_')[1],e,src);
                    return false;
                }
            },
            BOX:{
                onScroll:function(profile, e, src){
                    //for ie 'href focus' will scroll view
                    if((e=xui.use(src)).scrollLeft()!==0)
                        e.scrollLeft(0);
                }
            }
        },
        EventHandlers:{
            onShowOptions:function(profile, item, e, src){},
            beforeClick:function(profile, item, e, src){},
            onClick:function(profile, item, e, src){},
            afterClick:function(profile, item, e, src){},
            onCmd:function(profile,item,cmdkey,e,src){},            
            onDblclick:function(profile, item, e, src){},

            onGetContent:function(profile, item, callback){},
            onItemSelected:function(profile, item, e, src, type){},
            
            beforeFold:function(profile,item){},
            beforeExpand:function(profile,item){},
            afterFold:function(profile,item){},
            afterExpand:function(profile,item){}
        },
        DataModel:{
            listKey:null,
            isFormField:{
                hidden:true,
                ini:false
            },

            width:{
                $spaceunit:1,
                ini:'18em'
            },
            height:{
                $spaceunit:1,
                ini:'18em'
            },
            iniFold:true,
            animCollapse:true,
            dock:'fill',
            group:{
                ini:false,
                action:function(v){
                    var self = this,
                        items = self.properties.items,
                        results = self.queryItems(items, function(o){return o.sub && o.group===undefined }),
                        nodes=xui();
                    xui.arr.each(results,function(o){
                        nodes.merge( self.getSubNodeByItemId('BAR', o.id) );
                    });
                    if(v)
                       nodes.addClass('xui-uigradient xui-uibar ' + self.getClass('BAR','-group'));
                    else
                       nodes.removeClass('xui-uigradient xui-uibar ' + self.getClass('BAR','-group'));
                }
            },
            selMode:{
                ini:'single',
                listbox:['single','none','multi','multibycheckbox'],
                action:function(value){
                    var ns=this,p=this.properties,sels=[];
                    xui.each(this.SubSerialIdMapItem,function(o){
                        if(!(o.sub && (o.hasOwnProperty('group')?o.group:p.group)))
                            sels.push(ns.getSubNodeByItemId('MARK',o.id).get(0));
                    });
                    xui(sels).css('display',(value=='multi'||value=='multibycheckbox')?'':'none');
                }
            },
            noCtrlKey:true,
            singleOpen:false,
            dynDestory:false,
            position:'absolute',
            optBtn:{
                ini:"",
                combobox:xui.toArr("xui-uicmd-opt,xui-icon-singleright"),
                action:function(){
                    this.boxing().refresh();
                }
            },
            togglePlaceholder:false,
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            },
            tagCmdsAlign:{
                ini:"right",
                listbox:['left','right','floatright'],
                action:function(v){
                    var profile=this,box=profile.getSubNode("ITEMS"),cls=profile.getClass('ITEMS','-tagcmd');
                    box.removeClass(new RegExp(cls+'[\w]*')).addClass(profile.getClass('ITEMS','-tagcmd'+v));
                }
            }
        },
        RenderTrigger:function(){
            this.boxing()._toggleNodes(this.properties.items, true, true, true);
        },
        _onclickbar:function(profile, e, src){
            var properties = profile.properties,
                domId=xui.use(src).id(),
                item = profile.getItemByDom(domId),
                itemId =profile.getSubId(domId),
                box = profile.boxing(),
                ks = xui.Event.getKey(e),
                sk = profile.getKey(xui.Event.getSrc(e).id||""),
                ignoreClick = sk==profile.keys.TOGGLE||sk==profile.keys.MARK;

            if(!ignoreClick && profile.beforeClick && false===box.beforeClick(profile,item,e,src))return false;
                
            if(properties.disabled|| item.disabled|| item.type=='split')return false;

            if(!ignoreClick && profile.onClick)
                box.onClick(profile,item,e,src);

            //group not fire event
            if(item.sub && (item.hasOwnProperty('group')?item.group:properties.group)){
                profile.getSubNode('TOGGLE', itemId).onClick();
                return;
            }
    
            profile.getSubNode(profile.box._focusNodeKey, itemId).focus(true);
    
            switch(properties.selMode){
            case 'none':
                box.onItemSelected(profile, item, e, src, 0);
                break;
            case 'multibycheckbox':
                if(properties.readonly|| item.readonly)return false;
                if(profile.keys.MARK){
                    if(sk!=profile.keys.MARK){
                        box.onItemSelected(profile, item, e, src, 0);
                        break;
                    }
                }
            case 'multi':
                if(properties.readonly|| item.readonly)return false;
                var value = box.getUIValue(),
                    arr = value?value.split(properties.valueSeparator):[],
                    checktype=1;
                if(arr.length&&(ks.ctrlKey||ks.shiftKey||properties.noCtrlKey)){
                    if(ks.shiftKey){
                        if(profile.$firstV._pid!=item._pid)return;
                        var items=properties.items;
                        if(item._pid){
                            var pitem=profile.getItemByItemId(item._pid);
                            if(pitem)items=pitem.sub;
                        }
                        var i1=xui.arr.subIndexOf(items,'id',profile.$firstV.id),
                            i2=xui.arr.subIndexOf(items,'id',item.id),
                            i;
                        arr.length=0;
                        for(i=Math.min(i1,i2);i<=Math.max(i1,i2);i++)
                            arr.push(items[i].id);
                    }else{
                        if(xui.arr.indexOf(arr,item.id)!=-1){
                            xui.arr.removeValue(arr,item.id);
                            checktype=-1;
                        }else
                            arr.push(item.id);
                    }
                    arr.sort();
                    value = arr.join(properties.valueSeparator);
    
                    //update string value only for _setCtrlValue
                    if(box.getUIValue() != value){
                        profile._noScroll=1;
                        box.setUIValue(value,null,null,'click');
                        delete profile._noScroll;
                        if(box.get(0) && box.getUIValue() == value)
                            box.onItemSelected(profile, item, e, src, checktype);
                    }
                    break;
                }
            case 'single':
                if(box.getUIValue() != item.id){
                    profile.$firstV=item;
                    profile._noScroll=1;
                    box.setUIValue(item.id,null,null,'click');
                    delete profile._noScroll;
                    if(box.get(0) && box.getUIValue() == item.id)
                        box.onItemSelected(profile, item, e, src, 1);
                }
                break;
            }
            if(!ignoreClick && profile.afterClick)box.afterClick(profile,item,e,src);
            return !ignoreClick;
        },
        _onkeydownbar:function(profile, e, src){
            var keys=xui.Event.getKey(e), key = keys.key, shift=keys.shiftKey, ctrl=keys.ctrlKey,
                cur = profile.getSubNode(profile.box._focusNodeKey, profile.getSubId(src)),
                root = profile.getRoot(),
                first = root.nextFocus(true, true, false),
                last = root.nextFocus(false, true, false);

            switch(key){
                case 'enter':
                    cur.onClick();
                    break;
                case 'tab':
                    if(shift){
                        if(cur.get(0)!=first.get(0)){
                            first.focus(true);
                            return false;
                        }
                    }else{
                        if(cur.get(0)!=last.get(0)){
                            last.focus(true);
                            return false;
                        }
                    }
                    break;
                case 'up':
                    if(ctrl){
                        profile.getSubNode('TOGGLE',profile.getSubId(src)).onClick();
                        return false;
                    }
                    if(cur.get(0)==first.get(0))
                        last.focus(true);
                    else
                        cur.nextFocus(false, true, false).focus(true);
                     return false;
                     break;
                case 'down':
                    if(ctrl){
                        profile.getSubNode('TOGGLE',profile.getSubId(src)).onClick();
                        return false;
                    }
                     if(cur.get(0)==last.get(0))
                        first.focus(true);
                     else
                        cur.nextFocus(true, false, false).focus(true);
                     return false;
                     break;
                case 'right':
                case 'left':
                    profile.getSubNode('TOGGLE',profile.getSubId(src)).onClick();
                    return false;
            }
        },
        _onStartDrag:function(profile, e, src, pos){
            var pos=xui.Event.getPos(e);
            xui.use(src).startDrag(e, {
                dragSource:profile.$xid,
                dragType:'icon',
                shadowFrom:src,
                targetLeft:pos.left+12,
                targetTop:pos.top+12,
                dragCursor:'pointer',
                dragDefer:2,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false;
        },
        _onDropTest:function(profile, e, src, key, data, item){
            var fid=data&&data.domId;
            if(fid){
                var tid=xui.use(src).id();
                if(fid==tid)return false;

                if(xui.get(xui.use(src).get(0),['parentNode','previousSibling','firstChild','id'])==fid)return false;

                var oitem=profile.getItemByDom(fid);

                // stop self
                if(oitem && item && oitem._pid==item.id)return false;

                var p=xui.use(src).get(0),
                    rn=profile.getRootNode();
                // stop children
                while((p=p.parentNode)){
                    if(profile.getSubId(p.id) == profile.getSubId(fid)){
                        return false;
                    }
                    if(p.id==xui.get(rn,["parentNode","id"])){
                        break;
                    }
                }
            }
        },
        _onDrop:function(profile, e, src, key, data, item){
            var k=profile.getKey(xui.use(src).id()),
                po=data.profile,
                ps=data.domId,
                oitem,
                ks=profile.keys,
                t=xui.absObj.$specialChars,
                b=profile.boxing(),
                arr=xui.copy(b.getUIValue(true));
            //remove
            oitem=xui.clone(po.getItemByDom(ps),function(o,i){return !t[(i+'').charAt(0)]});
            po.boxing().removeItems([oitem.id]);

            //add
            if(k==ks.BOX)
                b.insertItems([oitem], null, null, false);
            else if(k==ks.BAR)
                b.insertItems([oitem], item._pid, item.id, true);
            else if(k==ks.TOGGLE)
                b.insertItems([oitem], item.id, null, false);

            if(arr && arr.length){
                if(xui.arr.indexOf(arr, oitem.id)!=-1){
                    //set checked items
                    profile._noScroll=1;
                    b.setUIValue(arr,true,null,'drop');
                    delete profile._noScroll;
                }
            }
            data._new = oitem;
            return false;
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile);
            d._cmdsalign=profile.getClass('ITEMS','-tagcmd'+profile.properties.tagCmdsAlign);
            return d;
        },
        _prepareItem:function(profile, item, oitem, pid, index,len){
            var p=profile.properties,
                map1=profile.ItemIdMapSubSerialId,
                map2=profile.SubSerialIdMapItem,
                pitem;

            if(pid)
                oitem._pid=pid;

            // set 'visible' will show when parent call .height()
            item._fi_togglemark = item.sub?('xui-uicmd-toggle'+(item._checked?" xuifont-checked xui-uicmd-toggle-checked":"")):(p.togglePlaceholder?'xui-icon-placeholder':'xui-uicmd-none');

            item.disabled = item.disabled?'xui-ui-disabled':'';
            item.mark2Display = ('showMark' in item)?(item.showMark?'':'display:none;'):(p.selMode=='multi'||p.selMode=='multibycheckbox')?'':'display:none;';
            item._tabindex = p.tabindex;
            item._fi_optClass = p.optBtn;

            //change css class
            if(item.sub && (item.hasOwnProperty('group')?item.group:p.group)){
                item.cls_group = "xui-uigradient xui-uibar "  + profile.getClass('BAR','-group');
                item.mark2Display = 'display:none';
            }
            this._prepareCmds(profile, item);

            if(xui.browser.fakeTouch || xui.browser.deviceType == 'mouseOnly'){
                item._optDisplay = p.optBtn?'display:block;':'';
            }

            if(item.type=='split'){
                item._split='xui-uitem-split';
                item._ruleDisplay=item._ltagDisplay=item._tglDisplay=item._rtagDisplay=item.imageDisplay=item.mark2Display=item._capDisplay=item._extraDisplay=item._optDisplay='display:none;';
            }
        },
        _setSub:function(profile, item, flag, recursive, stopanim, cb){
            var id=profile.domId,
                ins=profile.boxing(),
                prop = profile.properties,
                itemId = profile.getSubIdByItemId(item.id),
                markNode = profile.getSubNode('TOGGLE', itemId),
                subNs = profile.getSubNode('SUB', itemId),

                barNode = profile.getSubNode('BAR', itemId),
                icon = profile.getSubNode('ITEMICON', itemId);

            if(xui.Thread.isAlive(profile.key+profile.id)) return;
            //close
            if(!flag){
                if(item._checked){
                    if(ins.beforeFold && false===ins.beforeFold(profile,item)){
                        return;
                    }
                    var onend=function(){
                        subNs.css({display:'none',height:0});
                        markNode.tagClass('-checked', false);
                        barNode.tagClass('-expand',false).tagClass('-fold');
                        icon.tagClass('-expand',false).tagClass('-fold');
                        item._checked = false;
                        if(prop.dynDestory || item.dynDestory){
                            var s=item.sub, arr=[];
                            for(var i=0,l=s.length;i<l;i++)
                                arr.push(s[i].id);
                            profile.boxing().removeItems(arr);
                            item.sub=true;
                            delete item._inited;
                        }
                        if(ins.afterFold)
                            ins.afterFold(profile,item);
                       xui.resetRun(id, function(cb){
                            if(cb)xui.tryF(cb,[profile,item],ins);
                        },0,[cb]);
                    };
                    if(!stopanim){
                         if(prop.animCollapse){
                            subNs.animate({'height':[subNs.height(),0]},null,onend, 200, null, 'expoOut', profile.key+profile.id).start();
                        }else onend();
                    }else onend();
                }
                if(recursive && item.sub && !prop.dynDestory && !item.dynDestory){
                    xui.arr.each(item.sub,function(o){
                        if(o.sub && o.sub.length)
                            profile.box._setSub(profile, o, flag, recursive, true, cb);
                    });
                }
            }else{
                //open
                if(!item._checked){
                    if(ins.beforeExpand && false===ins.beforeExpand(profile,item)){
                        return;
                    }
                    var onend=function(empty){
                        subNs.css({display:'',height:'auto'});
                        //markNode.css('background','');
                        // compitable with IE<8
                        if(xui.browser.ie && xui.browser.ver<=8){
                            markNode.css({
                                backgroundImage:'',
                                backgroundRepeat:'',
                                backgroundPositionX:'',
                                backgroundPositionY:'',
                                backgroundColor:'',
                                backgroundAttachment:''
                              });
                        }else{
                            markNode.removeClass('xui-icon-loading');
                        }
                        if(!empty){
                            item._checked = true;
                            if(ins.afterExpand)
                                ins.afterExpand(profile,item);
                        }
                       xui.resetRun(id, function(cb){
                            if(cb)xui.tryF(cb,[profile,item],ins);
                        },0,[cb]);
                    },
                    openSub = function(profile, item, id, markNode, subNs, barNode, icon, sub){
                        var b=profile.boxing(),
                            p=profile.properties,
                            empty = sub===false;
                        //created
                        if(!empty&& !item._inited){
                            delete item.sub;
                            //before insertRows
                            item._inited=true;
                            if(sub){
                                if(typeof sub=='string')
                                    subNs.html(item.sub=sub,false);
                                else if(sub['xui.Template']||sub['xui.UI']){
                                    subNs.append(item.sub=sub.render(true));
                                }else if(xui.isArr(sub)){
                                    b.insertItems(sub, item.id);
                                    // for []
                                    if(!item.sub)item.sub=sub;                                    
                                }
                                var s=0,arr=b.getUIValue(true);
                                if(arr && arr.length){
                                    xui.arr.each(sub,function(o){
                                        if(xui.arr.indexOf(arr, o.id||o)!=-1){
                                            s=1;
                                            return false;
                                        }
                                    });
                                    if(s){
                                        //set checked items
                                        profile._noScroll=1;
                                        b._setCtrlValue(b.getUIValue());
                                        delete profile._noScroll;
                                    }
                                }
                            }
                        }

                        if(p.singleOpen)
                            b._toggleNodes(item._pid?profile.getItemByItemId(item._pid).sub:p.items, false)

                        if(!empty){
                            markNode.tagClass('-checked');
                            barNode.tagClass('-expand').tagClass('-fold',false);
                            icon.tagClass('-fold',false).tagClass('-expand');
                        }
                        
                        if(!stopanim){
                            subNs.css("height","0px").css("display",'');
                           
                            if(p.animCollapse){
                                var h=0;
                                subNs.children().each(function(o){
                                    h+=o.offsetHeight;
                                });
                                subNs.animate({'height':[0,h]},null,function(){
                                    onend(empty);
                                }, 200, null, 'expoIn', profile.key+profile.id).start();
                            }else onend(empty);
                        }else onend(empty);
                    },
                    sub=item.sub,
                    callback=function(sub){
                        openSub(profile, item, id, markNode, subNs, barNode, icon, sub)
                    },t;

                    if((t=typeof sub)=='string'||t=='object')
                        callback(sub);
                    else if(profile.onGetContent){
                        if(xui.browser.ie && xui.browser.ver<=8){
                            markNode.css('background','url('+xui.ini.img_busy+') no-repeat');
                        }else{
                            markNode.addClass('xui-icon-loading');
                        }
                        var r=profile.boxing().onGetContent(profile, item, callback);
                        if(r||r===false){
                            //return true: toggle icon will be checked
                            if(r===true)
                                item._inited=true;
                            callback(r);
                        }
                    }
                }
                if(recursive&& item.sub){
                    xui.arr.each(item.sub,function(o){
                        if(o.sub && o.sub.length && !o._checked)
                            profile.box._setSub(profile, o, flag, recursive, true, cb);
                    });
                }
            }
        },
        _tofold:function(profile,item,pid){
            profile.getSubNodeByItemId('BAR', pid).addClass(profile.getClass('BAR','-fold'));
            profile.getSubNodeByItemId('TOGGLE', pid).replaceClass(new RegExp("\\buicmd-(none|empty)\\b"), "xui-uicmd-toggle");
        },
        _onresize:function(profile,width,height){
            profile.getSubNode('BORDER').cssSize({ width :width?width:null, height :height?height:null});
            profile.getSubNode('BOX').cssSize({ width :width?width:null, height : height?height:null});
        }
    }
});
xui.Class("xui.UI.TreeView","xui.UI.TreeBar",{
    Initialize:function(){
        this.addTemplateKeys(['IMAGE']);
         var t = this.getTemplate();
         t.$submap.items.ITEM.BAR.className='xui-uitembg xui-uiborder-radius xui-showfocus {cls_group} {cls_fold} {_split} {disabled} {readonly}';
         var n=t.$submap.items.ITEM.BAR.ITEMICON;
         n.$fonticon = '{_fi_cls_file}';
         this.setTemplate(t);
    },
    Static:{
        Appearances:{
            ITEMS:{
                //overflow: 'visible'
                'padding':'.25em'
            },
            ITEM:{
                'white-space': 'nowrap',
                position:'relative',
                overflow:'hidden'
            },
            BAR:{
               zoom:xui.browser.ie?1:null,
               position:'relative',
               display:'block',
               'outline-offset':'-1px',
               '-moz-outline-offset':(xui.browser.gek && xui.browser.ver<3)?'-1px !important':null
            },
            SUB:{
                zoom:xui.browser.ie?1:null,
                height:0,
                'font-size':xui.browser.ie68?'1px':null,
                //1px for ie8
                'line-height':xui.browser.ie68?'1px':null,
                position:'relative',
                overflow:'hidden'
            },
            BOX:{
                left:0,
                overflow: 'auto',
                position:'relative'
            }
        },
        Behaviors:{
            MARK:{
                onClick:function(profile, e, src){
                   profile.box._onclickbar(profile,e,xui.use(src).parent().xid());
                   return false;
                }
            },
            ITEMICON:{
                onClick:function(profile, e, src){
                   profile.box._onclickbar(profile,e,xui.use(src).parent().xid());
                   return false;
                }
            }
        },
        DataModel:{
            $subMargin:1.8,
            group:null,
            noIcon:{
                ini:false,
                action:function(v){
                    this.getSubNode("ITEMICON",true).css('display',v?'none':'');
                }
            }
        },
        _prepareItem:function(profile, item, oitem, pid, index,len){
            var p=profile.properties,
                map1=profile.ItemIdMapSubSerialId,
                map2=profile.SubSerialIdMapItem,
                pitem;

            if(pid){
                oitem._pid=pid;
                if(pitem=map2[map1[pid]]){
                    oitem._deep=pitem._deep+1;
                    item.rulerStyle='width:'+(oitem._deep*p.$subMargin)+'em;';
                    // for the last one
                    item._fi_togglemark = item.sub?('xui-uicmd-toggle' + (item._checked?'-checked':'')):(p.togglePlaceholder?'xui-uicmd-empty':'xui-uicmd-none');
                }
            }else{
                oitem._deep=0;
                item.rulerStyle='';
                item.innerIcons='';
                item._fi_togglemark = item.sub?('xui-uicmd-toggle' + (item._checked?'-checked':'')):(p.togglePlaceholder?'xui-uicmd-empty':'xui-uicmd-none');
            }
            // show image
            item.imageDisplay=(item.noIcon||p.noIcon)?"display:none;":"";
            //
            item.cls_fold = item.sub?profile.getClass('BAR','-fold'):'';

            if(!(item.imageClass||item.image||item.iconFontCode))
                item._fi_cls_file = 'xui-icon-file' + (item.sub?' xui-icon-file-fold':'');

            item._fi_optClass = p.optBtn;

            item.disabled = item.disabled?'xui-ui-disabled':'';
            item._itemDisplay=item.hidden?'display:none;':'';
            item.mark2Display = ('showMark' in item)?(item.showMark?'':'display:none;'):(p.selMode=='multi'||p.selMode=='multibycheckbox')?'':'display:none;';
            item._tabindex = p.tabindex;
            this._prepareCmds(profile, item);
            
            if(item.type=='split'){
                item._split='xui-uitem-split';
                item._splitstyle='margin-left:'+(oitem._deep*p.$subMargin)+'em;';
                item._ruleDisplay=item._ltagDisplay=item._tglDisplay=item._rtagDisplay=item.imageDisplay=item.mark2Display=item._capDisplay=item._extraDisplay=item._optDisplay='display:none;';
            }
        },
        _tofold:function(profile,item,pid){
            var cls=profile.getClass('IMAGE');
            profile.getSubNodeByItemId('BAR', pid).addClass(profile.getClass('BAR','-fold'));
            profile.getSubNodeByItemId('TOGGLE', pid).replaceClass(new RegExp("\\b"+cls+"-path([-\\w]+)\\b"), cls + '-fold$1');
        }
    }
});
xui.Class("xui.UI.PopMenu",["xui.UI.Widget","xui.absList"],{
    Instance:{
        adjustSize:function(){
            this.each(function(profile){
                if(profile.renderId){
                    var root=profile.getRoot();
                    var border = profile.getSubNode('BORDER'),
                        box = profile.getSubNode('BOX'),
                        bg = profile.getSubNode('BOXBGBAR'),
                        items = profile.getSubNode('ITEMS'),
                        nodes = profile.getSubNode('ITEM',true),
                        prop=profile.properties,
                        us = xui.$us(prop),
                        cb = border.contentBox(),
                        adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                        ww=0,hh=0;
                       
                       items.cssSize({width:'auto',height:'auto'});
 
                        hh = items.height() + (cb?0:border._borderH());
                        if(xui.browser.ie67 && hh%2==1)hh+=1;
                        items.addClass(profile.getClass('ITEMS','-inline'));
                        nodes.each(function(n){
                            ww=Math.max(ww, n.offsetWidth);
                        });
                        if(ww%2==1)ww+=1;
                        items.removeClass(profile.getClass('ITEMS','-inline'));

                    // for IE7
                    items.cssSize({
                        width:adjustunit(ww),
                        height:adjustunit(hh)
                    });
                    bg.height(adjustunit(hh));

                    var h = adjustunit(Math.min(prop._maxHeight, hh)),
                        w = adjustunit(Math.min(prop._maxWidth, ww)),
                        size={
                            width:w,
                            height:h
                        };
                    prop.width=w;
                    prop.height=h;

                    root.cssSize(size);
                    border.cssSize(size);
                    box.cssSize({
                        width:adjustunit(Math.min(prop._maxWidth, ww)  + xui.Dom.getScrollBarSize()),
                        height:size.height
                    });
                }
            });
            return this._setScroll();
        },
        _setScroll:function(){
            return this.each(function(profile){
                if(profile.renderId){
                    var o=profile.getSubNode('BOX'),
                        t=o.scrollTop(),
                        h=o.scrollHeight(),
                        b = profile.getRoot(),
                        hh=b.offsetHeight();
                    profile.getSubNode('TOP').css('display',t===0?'none':'block');
                    profile.getSubNode('BOTTOM').css('display',(hh>=h-t)?'none':'block');
                }
            })
        },
        _scrollToBottom:function(){
            var profile=this.get(0),
                o = profile.getSubNode('BOX'),
                border = profile.getSubNode('BORDER'),
                y = o.scrollTop(),
                b=false,
                offset,
                h = o.scrollHeight(),
                bh = border.height();
            if(bh<h-y){
                y += (profile.$scrollStep = Math.max(5, (profile.$scrollStep||1)*1.005));
                if(bh>=h-y){
                    y=h-bh;
                    b=true;
                }
                o.scrollTop(y);
                if(b){
                    profile.getSubNode('BOTTOM').css('display','none');
                    profile.$scrollTobottom=false;
                    profile.$scrollStep=1;
                }else{
                    profile.getSubNode('TOP').css('display','block');
                    if(profile.$scrollTobottom)
                        xui.asyRun(this._scrollToBottom, 0, [], this);
                }
            }
        },
        _scrollToTop:function(){
            var profile=this.get(0),
                o = profile.getSubNode('BOX'),
                y = o.scrollTop(),
                b=false;
            if(y>0){
                y -= (profile.$scrollStep = Math.max(5, (profile.$scrollStep||1)*1.005));
                if(y<0){
                    y=0;
                    b=true;
                }
                o.scrollTop(y);
                if(b){
                    profile.getSubNode('TOP').css('display','none');
                    profile.$scrollToTop=false;
                    profile.$scrollStep=1;
                }else{
                    profile.getSubNode('BOTTOM').css('display','block');
                    if(profile.$scrollToTop)
                        xui.asyRun(this._scrollToTop, 0, [], this);
                }
            }
        },
        _initGrp:function(){
            var profile=this.get(0),root;
            if(!profile.$popGrp || !profile.$popGrp.length){
                root=profile.getRoot();
                profile.$popGrp = [root._get(0)];
                //group blur trigger
                root.setBlurTrigger(profile.$xid, null);
                root.setBlurTrigger(profile.$xid, function(){
                    if(profile.box){
                        profile.boxing().hide();
                        if(profile.$popGrp)
                            profile.$popGrp.length=0;
                    }
                }, profile.$popGrp);
            }
        },
        pop:function(obj, type, parent,ignoreEffects){
            var ns=this,
                profile=ns.get(0),
                p=profile.properties,
                sms='$subPopMenuShowed',
                hl='$highLight',
                cm='$childPopMenu';
            //ensure rendered
            if(!profile.renderId){
                //use empty idv for LayoutTrigger
                xui.Dom.getEmptyDiv().append(ns.render(true));
            }

            //clear highLight first
            if(profile.$highLight)
                xui([profile.$highLight]).tagClass('-hover',false);

            // set container
            profile._conainer = p.parentID ? xui(p.parentID) : parent || null;

            profile.getRoot().popToTop(obj, type, profile._conainer);

            ns._setScroll();
            ns.adjustSize();

            ns._initGrp();
            profile[cm]=profile[sms]=profile[hl]=null;
            return ns;
        },
        hide:function(triggerEvent, ignoreEffects , e){
            var t,
                profile=this.get(0),
                p=profile.properties,
                root=profile.getRoot(),
                sms='$subPopMenuShowed',
                hl='$highLight',
                cm='$childPopMenu',
                fun=function(){
                    if(false!==triggerEvent)
                        if(false===profile.boxing().beforeHide(profile, ignoreEffects, e))
                            return this;

                    if(!root || root.css('display')=='none')return;

                    //remove trigger
                    root.setBlurTrigger(profile.$xid,null);
                    if(xui.get(profile,['$hideMenuPool','_nodes',0]))
                        profile.$hideMenuPool.append(root);
                    else
                        root.css('display','none');

                    if(t=profile[hl])
                       xui([t]).tagClass('-hover',false);

                    //hide all parent pop
                    var p=profile[cm],q;
                    if(t=profile[sms])t.hide(triggerEvent, ignoreEffects);
                    while(p){
                        p.boxing().hide(triggerEvent, ignoreEffects);
                        p=(q=p)[cm];
                        q[cm] = q[sms] = q[hl] = null;
                    }
                    profile[cm]=profile[sms]=profile[hl]=null;
                    if(t=profile.$parentPopMenu)t[sms]=null;

                    if(profile.$popGrp)
                        xui.arr.removeValue(profile.$popGrp,root._get(0));

                    if(false!==triggerEvent)
                        profile.boxing().onHide(profile);
                };
            root.hide(fun,null,ignoreEffects);
            return this;
        },
        _afterInsertItems:function(profile){
            if(!profile.renderId)return;
            profile.boxing().adjustSize();
        },
        _afterRemoveItems:function(profile){
            if(!profile.renderId)return;
            profile.boxing().adjustSize();
        }
    },
    Initialize:function(){
        //modify default template fro shell
        var t = this.getTemplate();
        xui.merge(t.FRAME.BORDER,{
            className:"xui-uiborder-outset xui-uiborder-radius",
             TOP:{
                className:'xuifont xui-uibar xui-uiborder-b',
                $fonticon:'xui-icon-circleup'
             },
             BOTTOM:{
                className:'xuifont xui-uibar xui-uiborder-t',
                $fonticon:'xui-icon-circledown'
             },
             BOX:{
                tagName:'div',
                className:"xui-uibase",
                BOXBGBAR:{
                    tabName:'div',
                    className:'xui-uibar',
                    style:'{_iconDisplay}'
                },
                 ITEMS:{
                    tagName:'div',
                    text:"{items}"
                 }
             },
             POOL:{}
        },'all');
        t.$submap = {
            'items':function(profile,template,v,tag,result){
                var t;
                tag = tag+'.'+v.type;
                //for xui.UI or xui.Template
                if(t=v.object){
                    //[v] is for xui.Template
                    result[result.length]=t.build(v);
                }else{
                    if(template[tag])
                        xui.UI.$doTemplate(profile,template,v,tag,result);
                }
             },
            'items.split':{
                ITEMSPLIT:{
                    style:"{_itemDisplay}",
                    className:'xui-uiborder-b'
                }
            },
            'items.button':{
                ITEM:{
                    tabindex: -1,
                    className: ' xui-uimenu {itemClass} {disabled}',
                    style:'{itemStyle}{_itemDisplay}',
                    ICON:{
                        $order:0,
                        className:'xuicon xui-icon-placeholder {imageClass}  {picClass}',
                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{_iconDisplay}{iconStyle}',
                        text:'{iconFontCode}'
                    },
                    CAPTION:{
                        text : '{caption}',
                        $order:1
                    },
                    RULER:{
                        style:'{displayAdd}',
                        $order:2
                    },
                    ADD:{
                        tagName : 'div',
                        style:'{displayAdd}',
                        text : '{add}',
                        $order:2
                    },
                    SUB:{
                        className:'xuifont',
                        $fonticon:'xui-icon-singleright',
                        style:'{displaySub}'
                    }
                }
            },
            'items.checkbox':{
                ITEM:{
                    tabindex: -1,
                    className: '  xui-uimenu {itemClass} {disabled}',
                    style:'{itemStyle}{_itemDisplay}',
                    CHECKBOX:{
                        $order:0,
                         className:'xuifont',
                        $fonticon:'{_fi_checkboxCls1} {_fi_checkboxCls2}  {_iconDisplay}'
                    },
                    CAPTION:{
                        text : '{caption}',
                        $order:1
                    },
                    RULER:{
                        style:'{displayAdd}',
                        $order:2
                    },
                    ADD:{
                        tagName : 'div',
                        style:'{displayAdd}',
                        text : '{add}',
                        $order:2
                    }
                }
            },
            'items.radiobox':{
                ITEM:{
                    tabindex: -1,
                    className: '  xui-uimenu {itemClass} {disabled}',
                    style:'{itemStyle}{_itemDisplay}',
                    RADIOBOX:{
                        $order:0,
                        className:'xuifont',
                        $fonticon:'{_fi_radioboxCls1} {_fi_radioboxCls2}  {_iconDisplay}'
                    },
                    CAPTION:{
                        text : '{caption}',
                        $order:1
                    },
                    RULER:{
                        style:'{displayAdd}',
                        $order:2
                    },
                    ADD:{
                        tagName : 'div',
                        style:'{displayAdd}',
                        text : '{add}',
                        $order:2
                    }
                }
            }
        };
        this.setTemplate(t);
    },
    Static:{
        $initRootHidden:true,
        Appearances:{
            KEY:{
                visibility:'hidden'
            },
            POOL:{
                position:'absolute',
                display:'none'
            },
            BOX:{
                overflow:'hidden',
                position:'relative',
                overflow:'hidden',
                'overflow-y':'auto',
                'z-index':'3'
            },
            BORDER:{
                position:'relative',
                overflow:'hidden'
            },
            ITEMS:{
                position:'relative',
                top:0,
                left:0,
                overflow:'hidden',
                'white-space':'nowrap'
            },
            BOXBGBAR:{
                'z-index':-1,
                position:'absolute',
                left:0,
                top:0,
                width:'2em',
                height:'100%'
            },
            'ITEMS-inline ITEM':{
                $order:5,
                display:xui.$inlineBlock
            },
            ITEM:{
                display:'block',
                position:'relative',
                overflow:'visible',
                'white-space': 'nowrap',
                cursor:'pointer',
                padding:'.25em 1.75em .25em .25em',
                outline:0
            },
            ITEMSPLIT:{
                display:'block',
                position:'relative',
                overflow:'visible',
                'white-space': 'nowrap',
                margin:'.25em .25em .25em 2em'
            },
            ICON:{
                margin:0
            },
            TOP:{
                cursor:'pointer',
                display:'none',
                position:'absolute',
                'z-index':'10',
                top:0,
                'text-align':'center',
                width:'100%'
            },
            BOTTOM:{
                cursor:'pointer',
                display:'none',
                position:'absolute',
                bottom:0,
                'z-index':'10',
                'text-align':'center',
                width:'100%'
            },
            'RADIOBOX, CHECKBOX, RADIOBOX-checked, CHECKBOX-checked':{
                cursor:'pointer',
                'vertical-align':'middle'
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'padding-left':'.75em',
                'font-size':'1em'
            },
            RULER:{
                width:'8em'
            },
            ADD:{
                position:'absolute',
                top:'.25em',
                right:0,
                width:'7em',
                'padding-right':'1.75em',
                'text-align':'right',
                'z-index':'10',
                zoom:xui.browser.ie?1:null
            },
            SUB:{
                position:'absolute',
                top:'.15em',
                right:'.15em'
            }
        },
        Behaviors:{
            HoverEffected:{TOP:'TOP', BOTTOM:'BOTTOM'},
            BOX:{
                onScroll:function(profile, e, src){
                    profile.boxing()._setScroll();
                }
            },
            ITEM:{
                onMouseover:function(profile, e, src){
                    var sms='$subPopMenuShowed',
                        all='$allPops',
                        hl='$highLight',
                        showp='$showpops',
                        popgrp='$popGrp';
                    //for stop second trigger by focus event
                    if(profile[hl] == src)return;

                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id,
                        Cancel = false,
                        pop,popp,t;
                    //if sub pop menu showed
                    if(t=profile[sms]){
                        //if the showed menu is self
                        if(t == xui.get(profile,[all,itemId]))
                            Cancel=true;
                        else{
                            t.hide();
                            profile[sms] = null;
                        }
                    }
                    if(!Cancel){
                        if(t=profile[hl])
                            xui([t]).tagClass( '-hover',false);
                        profile[hl] = src;
                        xui.use(src).tagClass('-hover');
                        //don't fire events here
                        try{xui.use(src).get(0).focus()}catch(e){}
                    }

                    if(!Cancel && item.sub){
                        // if no sub arrays
                        if(!(xui.isArr(item.sub) && item.sub.length)){
                            if(profile.onShowSubMenu){
                                var r=profile['$sub:'+item.id];
                                if(r && r['xui.UI'] && !r.isEmpty()){}
                                else
                                    r=profile.boxing().onShowSubMenu(profile, item, src);

                                // return UI control
                                if(r && r['xui.UI'] && !r.isEmpty()){
                                    profile[sms] = r;
                                    r=r.reBoxing();
                                    r.onMouseout(function(p,e,src){
                                        profile.box._mouseout(profile, e, src);
                                    },null,-1);

                                    profile.boxing()._initGrp();
                                    profile[popgrp].push(r._get(0));

                                    r.popToTop(src,2,profile._conainer);

                                    return;
                                }
                                // return items array
                                else if(r && xui.isArr(r) && r.length){
                                    item.sub=r;
                                }
                            }
                        }

                        // show items
                        if(xui.isArr(item.sub) && item.sub.length){
                            profile[all] = profile[all] || {};

                            //no create
                            if(!(pop = profile[all][itemId])){
                                var pro=profile.properties;
                                pop = (new xui.UI.PopMenu({position:'absolute', items:item.sub, autoHide:pro.autoHide, showEffects:pro.showEffects, hideEffects:pro.hideEffects})).render(true);
                                pop.onShowSubMenu(function(pro, item, src){
                                    return profile.boxing().onShowSubMenu(profile, item, src);
                                });
                                pop.onMenuSelected(function(pro, item, src){
                                    return profile.boxing().onMenuSelected(profile, item, src);
                                });
                                popp=pop.get(0);
                                //set pool to parent
                                popp.$hideMenuPool = xui.get(profile,['$hideMenuPool','_nodes',0]) || profile.getSubNode('POOL');

                                profile[all][itemId] = pop;

                                //collect
                                profile[showp] = profile[showp] || [profile];
                                popp[showp] = profile[showp];
                                profile[showp].push(popp);
                            }else popp=pop.get(0);

                            //input a copy of root for group trigger
                            profile.boxing()._initGrp();
                            profile[popgrp].push(popp.getRoot()._get(0));
                            popp[popgrp] = profile[popgrp];

                            //set parent pop
                            popp.$parentPopMenu = profile;
                            profile.$childPopMenu = popp;

                            pop.pop(src, 2, profile._conainer);
                            profile[sms] = pop;
                        }
                    }
                },
                onMouseout:function(profile, e, src){
                    var properties = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id,
                        action = true,
                        hl='$highLight',
                        t;
                    if(profile[hl] == src)return;

                    //if cursor move to submenu, keep the hover face
                    if(t=profile.$subPopMenuShowed){
                        var node = e.toElement||e.relatedTarget,
                            target = t.get(0).getRootNode();
                        try{
                            do{
                                if(node==target)
                                    return;
                            }while((node && (node=node.parentNode)))
                        }catch(a){}
                    }
                    xui.use(src).tagClass('-hover',false);
                    profile[hl] = null;
                },
                onClick:function(profile, e, src){
                    var prop = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId = item.id;
                    if(prop.disabled || item.disabled)return false;

                    // give a change to click an item with sub popmenu
                    if(!item.group){
                        if(item.type=='checkbox')
                            profile.getSubNodeByItemId('CHECKBOX',item.id).tagClass('-checked', item.value = !item.value);
                        else if(item.type=='radiobox'){
                            profile.getSubNode('RADIOBOX',true).tagClass('-checked', false);
                            xui.arr.each(prop.items,function(o){
                                if(o.type=='radiobox')
                                    o.value=false;
                            });
                            profile.getSubNodeByItemId('RADIOBOX',item.id).tagClass('-checked', item.value = true);
                        }

                        if(profile.onMenuSelected)profile.boxing().onMenuSelected(profile, item, src);

                        if(prop.hideAfterClick){
                            xui.use(src).tagClass('-hover',false);
                            //hide all parent pop
                            xui.asyRun(function(){
                                var p=profile,q;
                                if(!p.renderId)return;
                                while(p){
                                    p.boxing().hide();
                                    p=(q=p).$parentPopMenu;
                                    q.$parentPopMenu = q.$subPopMenuShowed = null;
                                }
                                //reset
                                profile.$subPopMenuShowed = null;
                                if(profile.$popGrp)
                                    profile.$popGrp.length=0;
                            },100);
                        }
                    }
                },
                onFocus:function(profile, e, src){
                    var box = profile.getSubNode('BOX'),
                        top=box.scrollTop(), h=box.scrollHeight(),
                        n = xui.use(src).offsetTop();

                    if(n<top || n>top+h)
                        xui.use(src).offsetTop(top);

                    xui.use(src).onMouseover();
                },
                onKeydown : function(profile, e, src){
                    var item = profile.getItemByDom(src),
                        items = profile.properties.items,
                        key = xui.Event.getKey(e).key,
                        itemId = item.id,
                        flag,r,tid,node,t;

                    switch(key){
                        case 'enter':
                            xui(src).onClick();
                            break;
                        case 'up':
                            r=true;
                            flag=false;
                            xui.arr.each(items,function(o,i){
                                if(o.type == 'split')return;
                                if(flag){
                                    tid=o.id;
                                    return r=false;
                                }
                                if(o.id == itemId)flag=true;
                            },null,true);
                            //last
                            if(r)tid=items[items.length-1].id;
                            node = profile.getSubNodeByItemId('ITEM', tid).get(0);
                            break;
                        case 'down':
                            r=true;
                            flag=false;
                            xui.arr.each(items,function(o,i){
                                if(o.type == 'split')return;
                                if(flag){
                                    tid=o.id;
                                    return r=false;
                                }
                                if(o.id == itemId)flag=true;
                            });
                            //first
                            if(r)tid=items[0].id;
                            node = profile.getSubNodeByItemId('ITEM', tid).get(0);
                            break;
                        case 'left':
                            if(t=profile.$parentPopMenu){
                                if(t=profile.$parentPopMenu.$highLight)
                                    node = t;
                            }
                            break;
                        case 'right':
                            if((t=profile.$subPopMenuShowed) && t == profile.$allPops[itemId])
                                t.activate();
                            break;
                    }
                     if(node&&node.tagName)try{node.focus()}catch(e){}
                }
            },
            TOP:{
                onMouseover:function(profile){
                    profile.$scrollToTop=true;
                    profile.$scrollStep=1;
                    profile.boxing()._scrollToTop();
                },
                onMouseout:function(profile){
                    profile.$scrollToTop=false;
                    profile.$scrollStep=1;
                },
                onClick:function(profile){
                    profile.$scrollStep*=2;
                }
            },
            BOTTOM:{
                onMouseover:function(profile){
                    profile.$scrollTobottom=true;
                    profile.$scrollStep=1;
                    profile.boxing()._scrollToBottom();
                },
                onMouseout:function(profile){
                    profile.$scrollTobottom=false;
                    profile.$scrollStep=1;
                },
                onClick:function(profile){
                    profile.$scrollStep*=2;
                }
            },
            ITEMS:{
                afterKeydown:function(profile, e){
                    var key=xui.Event.getKey(e).key;
                    if(key=='tab' || key=='enter')
                        return true;
                    else if(key=='esc'){
                        //top
                        do{
                            profile.boxing().hide();
                        }while(profile = profile.$parentPopMenu)

                        return false;
                    }else return false;
                }
            },
            BORDER:{
                onMouseout:function(profile, e, src){
                    profile.box._mouseout(profile, e, src);
                }
            }
        },
        DataModel:({
            dock:null,
            tabindex:null,
            tips:null,
            border:null,
            resizer:null,
            dragSortable:null,
            showEffects:"Blur",
            hideEffects:"",
            autoTips:false,
            shadow:true,
            _maxHeight:260,
            _maxWidth:300,
            left:-10000,
            parentID:'',
            hideAfterClick:true,

            autoHide:false,

            height:{
                $spaceunit:1,
                ini:'auto'
            },
            //opera needs more space for initialize
            width:{
                $spaceunit:1,
                ini:'auto'
            },
            position:'absolute',
            noIcon:{
                ini:false,
                action:function(){
                    this.boxing().refresh();
                }
            },
            $hborder:0,
            $vborder:0
        }),
        EventHandlers:{
            onShowSubMenu:function(profile, item, src){},
            beforeHide:function(profile,e){},
            onHide:function(profile){},
            onMenuSelected:function(profile, item, src){}
        },
        RenderTrigger:function(){
            this.boxing().adjustSize();
        },
        _beforeSerialized:function(profile){
            var o=arguments.callee.upper.call(this, profile),
                op=o.properties;
            delete op.left;delete op.top;delete op.right;delete op.bottom;delete op.width;delete op.height;
            return o;
        },
        _mouseout:function(profile, e){
            if(profile.properties.autoHide){
                var p1=xui.Event.getPos(e),
                    size, p2, b;
                xui.arr.each(profile.$popGrp,function(o){
                    o=xui([o]);
                    p2=o.offset();
                    size=o.cssSize();
                    if(p1.left>=p2.left && p1.top>=p2.top && p1.left<=p2.left+size.width && p1.top<=p2.top+size.height){
                        b=1;return false;
                    }
                });
                if(!b){
                    while(b=profile.$parentPopMenu)profile=b;
                    profile.boxing().hide(true,null,e);
                    if(profile.$popGrp)
                        profile.$popGrp.length=0;
                }
            }
        },
        _prepareData:function(profile){
            var data = arguments.callee.upper.call(this, profile),
                NONE='display:none',
                prop=profile.properties;
            if(prop.noIcon)data._iconDisplay=NONE;
            return data;
        },
        _prepareItem:function(profile, item){
            var NONE='display:none;',
                prop=profile.properties;

            item.add = item.add || '';
            item.displayAdd = item.add?'':NONE;
            item.displaySub = item.sub?'':NONE;
            item._itemDisplay=item.hidden?NONE:'';

            item._iconDisplay=prop.noIcon?NONE:'';

            item.type=item.type||'button';
            if(item.type=='checkbox'){
                item._fi_checkboxCls1 = 'xui-uicmd-check';
                item._fi_checkboxCls2 = item.value?'xuicon-checked xui-uicmd-check-checked':'';
            }
            else if(item.type=='radiobox'){
                item._fi_radioboxCls1 = 'xui-uicmd-radio';
                item._fi_radioboxCls2 = item.value?'xuicon-checked xui-uicmd-radio-checked':'';
            }
        },
        _onresize:null
    }
});xui.Class("xui.UI.MenuBar",["xui.UI","xui.absList" ],{
    Instance:{
        updateItem:function(subId,options){
            var self=this,
                profile=self.get(0),
                items=profile.properties.items;
            //the root
            if(xui.arr.subIndexOf(items,"id",subId)!=-1)
                arguments.callee.upper.call(self,subId,options);
            //try each sub popmenu
            else{
                var ok=0;
                xui.each(profile.$allPops,function(o){
                    o.updateItem(subId,options);
                    ok=1;
                });
                if(!ok)
                    arguments.callee.upper.call(self,subId,options);
            }
            return self;
        },
        _pop:function(item,src){
            var self=this,
                profile=self.get(0);
            //hide first, ignoreEffects false,true
            if(profile.$curPop)self.hide();

            if(!item.sub)return ;

            if(profile.beforePopMenu && false==profile.boxing().beforePopMenu(profile, item, src)){
                return;
            }else{
                
                xui.use(src).tagClass('-active');
                
                var menu, 
                    id=item.id,
                    pro=profile.properties,
                    all='$allPops';
                
                profile.$curPop=id;
                profile.$curElem=src;
                profile.$menuPop = id;

                profile[all] = profile[all] || {};
                if(!profile[all][id]){
                    var callback=function(sub){
                        var hash={position:'absolute', items:sub, autoHide:!!pro.autoShowTime};
                        if(pro.showEffects)hash.showEffects=pro.showEffects;
                        if(pro.hideEffects)hash.hideEffects=pro.hideEffects;
                        var menu = xui.create('PopMenu',hash);
                        profile.getSubNode('POOL').append(menu);
                        menu.onHide(function(pro){
                            self.hide(false);
                        }).onMenuSelected(function(pro, item, src){
                            return profile.boxing().onMenuSelected(profile, pro, item, src);
                        }).onShowSubMenu(function(pro, item, src){
                            return profile.boxing().onShowSubMenu(profile, pro, item, src);
                        });
                        menu.get(0).$hideMenuPool = profile.getSubNode('POOL');
                        menu.get(0)[all] = profile[all];
                        profile[all][id] = menu;
                    }

                    if(xui.isArr(item.sub) && item.sub.length)
                        callback(item.sub);
                    else if(profile.onGetPopMenu){
                        var r=profile.boxing().onGetPopMenu(profile, item, callback);
                        if(xui.isArr(r) && r.length)
                            callback(item.sub=r);
                    }
                }
                // popmenu
                if(profile[all][id])
                    profile[all][id].pop(xui(src), 1, xui(pro.parentID));

                return false;
            }
        },
        _afterInsertItems:function(){
            this.clearPopCache();
        },
        hide:function(ignoreEffects){
            var profile=this.get(0),menu,
            id = profile.$curPop,
            node = profile.$curElem;

            if(menu = profile.$allPops[id]){
                //To avoid trigger recursive call
                if(false!==arguments[0])
                    menu.hide(false,ignoreEffects);
                // collect
                profile.getSubNode('POOL').append(menu.reBoxing());
                xui([node]).tagClass('-active',false);
            }
            profile.$menuPop=profile.$curPop=profile.$curElem=null;
        },
        clearPopCache:function(){
            var profile=this.get(0);
            if(profile.renderId){
                profile.getSubNode('POOL').empty();
                profile.$allPops=profile.$curPop=profile.$curElem=null;
            }
        }
    },
    Initialize:function(){
        xui.SC('xui.UI.PopMenu');
    },
    Static:{
        _nocap2tip:true,
        Templates:{
            tagName:'div',
            className:'{_className}',
            style:'{_style}',
            POOL:{
                tagName:'div'
            },
            BORDER:{
                className:'xui-uibar xui-uiborder-outset xui-uiborder-radius',
                tagName:'div',
                LIST:{
                    tagName:'div',
                    HANDLER:{
                        className:'xuifont',
                        $fonticon:'xui-icon-placeholder',
                        style:'{handler}'
                    },
                    ITEMS:{
                        $order:1,
                        text:"{items}"
                    }
                }
            },
            $submap:{
                items:{
                    ITEM:{
                        style:'{itemStyle}{_itemDisplay}',
                        className:'xui-uimenu',
                        ITEMI:{
                            ITEMC:{
                                ITEMA:{
                                    tabindex: '{_tabindex}',
                                    className:' {typeCls} {disabled}',
                                    ICON:{
                                        $order:1,
                                        className:'xuicon {imageClass}  {picClass}',
                                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                                        text:'{iconFontCode}'
                                    },
                                    CAPTION:{
                                        $order:2,
                                        text : '{caption}',
                                        style:'{captionDisplay}'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        Appearances:{
            KEY:{
                position:'absolute',
                left:0,
                top:0
            },
            POOL:{
                width:0,
                height:0,
                visibility:'hidden',
                position:'absolute',
                left:'-10000px',
                top:'-10000px'
            },
            BORDER:{
                left:0,
                top:0
            },
            HANDLER:{
                height:'100%',
                width:'0.5em',
                background:'url('+xui.ini.img_handler+') repeat-y left top',
                cursor:'move',
                'vertical-align':'middle'
            },
            LIST:{
                padding:'.125em'
            },
            ITEMS:{
                'vertical-align':'middle'
            },
            ITEM:{
                'white-space': 'nowrap',
                'vertical-align':'top',
                overflow:'hidden',
                margin:'0 .25em 0 .25em',
                'padding-right':'.5em'
            },
            'ITEM *':{
                cursor:'pointer'
            },
            ITEMI:{
                'padding':'0 .25em',
                'vertical-align':'top'
            },
            ITEMC:{
                'padding':'.25em 0',
                'vertical-align':'top'
            },
            ITEMA:{
                display:xui.$inlineBlock
            },
            CAPTION:{
                'vertical-align':xui.browser.ie6?'baseline':'middle',
                'font-size':'1em'
            }
        },
        Behaviors:{
            ITEM:{
                onMouseover:function(profile, e, src){
                    var p = profile.properties, ns=src;
                    if(p.disabled)return;
                    var item = profile.getItemByDom(src),
                        itemId = item.id;
                    if(item.disabled)return;
                    xui.use(ns).tagClass('-hover');

                    if(profile.$menuPop){
                        if(profile.$menuPop != itemId){
                            //show current popmenu
                            profile.boxing()._pop(item, ns);
                        }
                    }else{
                        if(p.autoShowTime){
                            xui.resetRun(profile.$xid+':autoShowTime', function(){
                                profile.boxing()._pop(item, ns);
                            },p.autoShowTime);
                        }
                    }
                },
                onMouseout:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled)return;
                    var item = profile.getItemByDom(src);
                    if(item.disabled)return;
                    xui.use(src).tagClass('-hover',false);

                    if(p.autoShowTime){
                        var pop = profile.$allPops;
                        if(pop=pop && pop[profile.$curPop]){
                            var node=pop.get(0).getRoot(),
                                p1=xui.Event.getPos(e),
                                size=node.cssSize(),
                                add=3,
                                p2=node.offset();

                            if(p1.left>p2.left && p1.top>p2.top-add && p1.left<p2.left+size.width && p1.top<p2.top+size.height){}else
                                pop.hide();
                        }
                        xui.resetRun(profile.$xid+':autoShowTime', null);
                    }
                },
                onMousedown:function(profile, e, src){
                    var p = profile.properties;
                    if(p.disabled)return;
                    var item = profile.getItemByDom(src),
                        itemId = item.id;
                    if(item.disabled)return;

                    xui.use(src).tagClass('-active');
                    
                    // if poped, stop to trigger document.body's onmousedown event
                    return profile.boxing()._pop(item, src);                    
                },
                onMouseup:function(profile,e,src){
                    var item = profile.getItemByDom(src);
                    if(profile.$menuPop != item.id)
                        xui.use(src).tagClass('-active',false);
                },
                onKeydown:function(profile, e, src){
                    var keys=xui.Event.getKey(e), key = keys.key, shift=keys.shiftKey,
                    cur = xui(src),
                    first = profile.getRoot().nextFocus(true, true, false),
                    last = profile.getRoot().nextFocus(false, true, false);

                    switch(xui.Event.getKey(e).key){
                        case 'tab':
                            if(shift){
                                if(cur.get(0)!=first.get(0)){
                                    first.focus(true);
                                    return false;
                                }
                            }else{
                                if(cur.get(0)!=last.get(0)){
                                    last.focus(true);
                                    return false;
                                }
                            }
                            break;
                        case 'left':
                        case 'up':
                            var next = cur.nextFocus(false, true, false);
                            if(cur.get(0)==first.get(0))
                                last.focus(true);
                            else
                                cur.nextFocus(false);
                            return false;
                            break;
                        case 'right':
                        case 'down':
                            var next = cur.nextFocus(true, false, false);
                            if(cur.get(0)==last.get(0))
                                first.focus(true);
                            else
                                cur.nextFocus();
                            return false;
                            break;
                        case 'enter':
                            cur.onMousedown();
                            break;
                    }
                },
                onClick:function(profile, e, src){
                    var item = profile.getItemByDom(src);
                    if(profile.$menuPop != item.id)
                        if(profile.onMenuBtnClick)
                            profile.boxing().onMenuBtnClick(profile, item, src);
                }
            }
        },
        DataModel:{
            listKey:null,
            dragSortable:null,
            autoTips:false,
            //can't change height
            height:{
                $spaceunit:1,
                ini:'auto',
                readonly:true
            },
                
            width:{
                $spaceunit:1,
                ini:'auto'
            },
            parentID:'',
            $hborder:1,
            $vborder:1,
            left:0,
            top:0,

            autoShowTime:200,

            handler:{
                ini:true,
                action:function(v){
                    this.getSubNode('HANDLER').css('display',v?'':'none');
                }
            },
            position:'absolute',
            dock:{
                ini:'top',
                listbox:['top','bottom']
            }
        },
        LayoutTrigger:function(){
            var v=this.properties,nd=this.getSubNode("BORDER");
            v.$hborder=v.$vborder= nd._borderW('left');
        },
        EventHandlers:{
            onGetPopMenu:function(profile, item, callback){},
            onMenuBtnClick:function(profile, item, src){},
            beforePopMenu:function(profile, item, src){},
            onShowSubMenu:function(profile, popProfile, item, src){},
            onMenuSelected:function(profile, popProfile, item, src){}
        },
        RenderTrigger:function(){
            if(this.properties.disabled)this.boxing().setDisabled(true,true);
        },
        _prepareData:function(profile){
            var none='display:none;';
            var data=arguments.callee.upper.call(this, profile);
            data.handler = data.handler?'':none;
            data._itemDisplay=data.hidden?none:'';
            return data;
        }
    }
});

xui.Class("xui.UI.ToolBar",["xui.UI","xui.absList"],{
    Instance:{
        updateItem:function(subId,options){
            if(options.type){
                return arguments.callee.upper.call(this,subId,options);
            }else{
                var self=this,
                    profile=self.get(0),
                    box=profile.box,
                    items=profile.properties.items,
                    rst=profile.queryItems(items,function(o){return typeof o=='object'?o.id===subId:o==subId},true,true,true),
                    nid,item,n1,n2,n3,n4,n5,t;
                if(xui.isStr(options))options={caption:options};

                if(rst.length){
                        rst=rst[0];
                        if(item=rst[0]){
                            
                        // [[modify id
                        if(xui.isSet(options.id))options.id+="";
                        if(options.id && subId!==options.id){
                            nid=options.id;
                            var m2=profile.ItemIdMapSubSerialId, v;
                            if(!m2[nid]){
                                if(v=m2[subId]){
                                    m2[nid]=v;
                                    delete m2[subId];
                                    profile.SubSerialIdMapItem[v].id=nid;
                                }else{
                                    item.id=nid;
                                }
                            }
                        }
                        delete options.id;
                        // modify id only
                        if(xui.isEmpty(options))
                            return self;
                        //]]
                    
                        //in dom already?
                        n1=profile.getSubNodeByItemId('ICON',nid||subId);
                        n2=profile.getSubNodeByItemId('CAPTION',nid||subId);
                        n3=profile.getSubNodeByItemId('ITEM',nid||subId);
                        n4=profile.getSubNodeByItemId('LABEL',nid||subId);
                        n5=profile.getSubNodeByItemId('BTN',nid||subId);

                        if('value' in options && options.value!==item.value)
                            profile.getSubNodeByItemId('BTN',nid||subId).tagClass('-checked', !!options.value);
                            
                        if('caption' in options&& options.caption!==item.caption){
                            n2.html(options.caption);
                            if(options.caption && !item.caption)
                                n2.css('display','');
                            if(!options.caption && item.caption)
                                n2.css('display','none');
                        }
                        if('label' in options&& options.label!==item.label){
                            n4.html(options.label);
                            if(options.label && !item.label)
                                n4.css('display','');
                            if(!options.label && item.label)
                                n4.css('display','none');
                        }
                        if('disabled' in options && options.disabled!==item.disabled){
                            if(options.disabled)
                                n3.addClass('xui-ui-itemdisabled');
                            else
                                n3.removeClass('xui-ui-itemdisabled');
  
                            n5.onMouseout(true,{$force:true})
                        }
                        if('image' in options&& options.image!==item.image)
                            n1.css('background-image',options.image);
                        if('imagePos' in options&& options.imagePos!==item.imagePos)
                            n1.css('background-position',options.imagePos);
                        if('imageClass' in options&& options.imageClass!==item.imageClass){
                            if(item.imageClass)
                                n1.removeClass(item.imageClass);
                            if(options.imageClass)
                                n1.addClass(options.imageClass);
                        }
                        if('hidden' in options){
                            var  b = !!options.hidden;
                            if(b){
                                if(item.hidden!==true){
                                    n3.css('display','none');
                                }
                            }else{
                                if(item.hidden===true){
                                    n3.css('display','');
                                }
                            }
                        }

                        //merge options
                        xui.merge(item, options, 'all');
                    }
                }
                return self;
            }
        },
        showItem:function(itemId, value){
            return this.each(function(profile){
                var item=profile.getItemByItemId(itemId);
                if(item){
                    item.hidden=value===false;
                    profile.getSubNodeByItemId('ITEM', itemId).css('display',value===false?'none':'');
                }
            });
        },
        showGroup:function(grpId, value){
            return this.each(function(profile){
                xui.arr.each(profile.properties.items,function(o){
                    if(o.id==grpId){
                        o.hidden=value===false;
                        return false;
                    }
                });
                var n=profile.getSubNodeByItemId('GROUP', grpId);
                n.css('display',value===false?'none':'');    
                
                xui.resetRun(profile.$xid+':showgrp',function(){
                    if(profile.renderId && profile.getRootNode().offsetWidth){
                        xui.UI.$dock(profile,true,true);
                    }
                });
            });
        }
    },
    Static:{
        _focusNodeKey:'BTN',
        _ITEMKEY:'GROUP',
        Templates:{
            tagName:'div',
            className:'{_className}',
            style:'{_style}',
            ITEMS:{
                className:'xui-uibar xui-uiborder-outset xui-uiborder-radius',
                tagName:'div',
                style:'{mode}',
                text:'{items}'
            },
            $submap:{
                items:{
                    GROUP:{
                        className:'{groupClass}',
                        style:'{grpDisplay} {groupStyle}',
                        HANDLER:{
                            className:'xuifont',
                            $fonticon:'xui-icon-placeholder',
                            style:'{mode2}'
                        },
                        LIST:{
                            $order:1,
                            tagName:'text',
                            text:'{sub}'
                        }
                    }
                },
                'items.sub':{
                    ITEM:{
                        style:'{_itemDisplay}',
                        className:" {disabled}",
                    //for firefox2 image in -moz-inline-box cant change height bug
                        IBWRAP:{
                            tagName:'div',
                            SPLIT:{
                                style:'{splitDisplay}',
                                className:"xui-uiborder-l xui-uiborder-r",
                                // for auto height
                                text:'&nbsp;'
                            },
                            LABEL:{
                                style:'{labelDisplay}',
                                text:'{label}'
                            },
                            BTN:{
                                tagName:'button',
                                className:'xui-uiborder-hidden xui-uiborder-radius xui-showfocus {itemcls} {itemClass}',
                                style:'{itemStyle} {_boxDisplay}',
                                tabindex: '{_tabindex}',
                                BOXWRAP:{
                                    tagName:'div',
                                    RULER:{},
                                    ICON:{
                                        $order:1,
                                        className:'xuicon {imageClass}  {picClass}',
                                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                                        text:'{iconFontCode}'
                                    },
                                    CAPTION:{
                                        $order:2,
                                        text : '{caption}',
                                        style:'{captionDisplay}'
                                    },
                                    DROP:{
                                        $order:3,
                                        className:'xuifont',
                                        $fonticon:'xui-uicmd-arrowdrop',
                                        style:'{_dropDisplay}'
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        Appearances:{
            KEY:{
                position:'absolute',
                overflow:'hidden',
                left:0,
                top:0
            },
            RULER:{
                padding:'0',
                margin:'0',
                width:'0'
            },
            ICON:{
                margin:0,
                'vertical-align':'middle'
            },
            ITEMS:{
                display:'block',
                'padding-bottom':'.125em'
            },
            HANDLER:{
                height:'100%',
                width:'.75em',
                background:'url('+xui.ini.img_handler+') repeat-y left top',
                cursor:'move',
                'vertical-align':'middle'
            },
            GROUP:{
                // crack for: The IE 'non-disappearing content' bug
                position:'static',
                padding:'.125em .25em 0 .125em',
                'vertical-align':'middle'
            },
            ITEM:{
                'vertical-align': 'middle',
                padding: '0 .125em',
                margin: '0'
            },
            'SPLIT':{
                $order:1,
                width:'0',
                'vertical-align':'middle',
                margin: '0 .25em'
            },
            BTN:{
                'padding':'.25em',
                'cursor':'pointer',
                // for extra padding bug in IE678
                '*width':'auto',
                '*overflow':'visible'
            },
            BOX:{
                height:'auto'
            },
            'LABEL, CAPTION':{
                'vertical-align':'middle',
                'margin-left':'.25em',
                'margin-right':'.25em',
                'font-size':'1em'
            },
            LABEL:{
                cursor:'default',
                'padding':'.25em'
            },
            DROP:{
                'vertical-align': 'middle'
            }
        },
        Behaviors:{
            NoTips:["GROUP","HANDLER"],
            HoverEffected:{BTN:['BTN']},
            ClickEffected:{BTN:['BTN']},
            DraggableKeys:["HANDLER"],
            DroppableKeys:["GROUP","ITEMS"],
            BTN:{
                onClick:function(profile, e, src){
                    if(profile.properties.disabled)return false;
                    var id2=xui.use(src).parent(3).id(),
                        item2 = profile.getItemByDom(id2);
                    if(item2.disabled)return false;

                    var item = profile.getItemByDom(src);
                    if(item.disabled)return false;

                    xui.use(src).focus(true);
                    if(item.type=="statusButton")
                        xui.use(src).tagClass('-checked',item.value=!item.value);

                    profile.boxing().onClick(profile, item, item2, e, src);
                    return false;
                }
            }
        },
        DataModel:{
            listKey:null,
            height:{
                ini:'auto',
                readonly:true
            },
            width:{
                $spaceunit:1,
                ini:'auto'
            },

            left:{
                $spaceunit:1,
                ini:0
            },
            top:{
                $spaceunit:1,
                ini:0
            },

            handler:{
                ini:true,
                action:function(v){
                    this.getSubNode('HANDLER',true).css('display',v?'':'none');
                }
            },
            position:'absolute',
            hAlign:{
                ini:'left',
                listbox:['left','center','right'],
                action:function(v){
                    this.getSubNode('ITEMS', true).css('textAlign', v);
                }
            },
            dock:{
                ini:'top',
                listbox:['top','bottom']
            }
        },
        EventHandlers:{
            onClick:function(profile, item, group, e, src){}
        },
        _adjustItems:function(arr){
            if(!arr)arr=[xui.stamp()+''];
            if(xui.isStr(arr))arr=[arr];

            var a=xui.copy(arr),m;
            xui.arr.each(a,function(o,i){
                if(xui.isArr(o)){
                    o={
                        id:xui.id(),
                        sub:o
                    };
                }
                if(xui.isHash(o)){
                    //copy group
                    a[i]=xui.copy(o);
                    a[i].sub=[];
                    //copy sub(tool item)
                    if(o.sub)
                        xui.arr.each(o.sub,function(v){
                            a[i].sub.push(xui.isHash(v)?xui.copy(v):{id:v+""});
                        });
                }
            });
            return a;
        },
        _onDrop:function(profile, e, src, key, data, item){
            var k=profile.getKey(xui.use(src).id()),
                po=data.profile,
                ps=data.domId,
                oitem,
                t=xui.absObj.$specialChars;

            //remove
            oitem=xui.clone(po.getItemByDom(ps),function(o,i){return !t[(i+'').charAt(0)]});
            po.boxing().removeItems([oitem.id], 'GROUP', true);

            if(k==profile.keys.GROUP)
                profile.boxing().insertItems([oitem], item.id, true);
            else
                profile.boxing().insertItems([oitem]);
            
            data._new = oitem;
            return false;
        },
        _prepareData:function(profile){
            var d=arguments.callee.upper.call(this, profile);
            var p = profile.properties;

            d.mode = p.hAlign!='left'?('text-align:'+p.hAlign+';'):'';

            return d;
        },
        _prepareItem:function(profile, oitem, sitem, pid, index,len, mapCache, serialId){
            var ns=this,
                dn='display:none',
                tabindex = profile.properties.tabindex,
                fun=function(profile, dataItem, item, pid, index,len, mapCache,serialId){
                    var id=dataItem[xui.UI.$tag_subId]=typeof serialId=='string'?serialId:('a_'+profile.pickSubId('aitem')), t;
                    if(typeof item=='string')
                        item={caption:item};

                    if(false!==mapCache){
                        profile.ItemIdMapSubSerialId[item.id] = id;
                        profile.SubSerialIdMapItem[id] = item;
                    }

                    if(item.object){
                        dataItem.object=ns._prepareInlineObj(profile, item, tabindex);
                    }else{
                        // for compitable with older versions
                        if(item.statusButton){item.type="statusButton";delete item.statusButton;}
                        else if(item.dropButton){item.type="dropButton";delete item.dropButton;}
                        else if(item.split){item.type="split";delete item.split;}

                        if(item.type!=="split" && !item.caption){
                            item.caption="";
                        }

                        xui.UI.adjustData(profile,item, dataItem);

                        if(item.type=="statusButton" && !!item.value)
                            dataItem.itemcls=" xui-uiborder-hidden-checked "+profile.getClass('BTN','-checked', !!item.value);

                        dataItem._tabindex=tabindex;
                        dataItem.splitDisplay=dataItem.type=="split"?'':dn;
                        dataItem.labelDisplay=dataItem.label?'':dn;
                        dataItem.captionDisplay=dataItem.caption?'':dn;
                        dataItem._dropDisplay=item.type=="dropButton"?'':dn;
                        dataItem._boxDisplay= (dataItem.type!=="split" && (dataItem.caption || dataItem.image || dataItem.imageClass))?'':dn;
                    }
                    dataItem._itemDisplay=item.hidden?dn:'';
                    item._pid=pid;
                };

            if(pid){
                fun(profile,oitem,sitem,pid,index,len,mapCache,serialId);
            }else{
                var arr=[],
                dataItem,
                a=sitem.sub||[];

                pid=sitem.id;
                oitem.mode2 = ('handler' in sitem)?(sitem.handler?'':dn):(profile.properties.handler?'':dn);
                oitem.grpDisplay=sitem.hidden?dn:'';
                oitem.sub = arr;

                xui.arr.each(a,function(item){
                    dataItem={id: item.id};
                    fun(profile,dataItem,item,pid,index,len,mapCache,serialId);
                    arr.push(dataItem);
                });
            }
        }
    }
});
xui.Class("xui.UI.Layout",["xui.UI", "xui.absList"],{
    Instance:{
        getPanel:function(subId){
            return this.get(0).getSubNodeByItemId('PANEL', subId);
        },
        append:function(target, subId,  pre, base){
            var pro=this.get(0);
            return arguments.callee.upper.call(this, target, subId||'main', pre, base);
        },
        insertItems:function(arr, base, before, all){
            return this._insertItems(arr, base, before, all);
        },
        _insertItems:function(arr, base, before, all){
            var node,arr2,
                items, index, r,
                data,box,
                pos="before",
                b=this._afterInsertItems;
            return this.each(function(profile){
                box=profile.box;
                items = profile.properties.items;
                if(!all){
                    index = xui.arr.subIndexOf(items,'id',base);
                    if(index==-1){
                        pos=before?'before':'after';
                    }else{
                        if(items[index].id=='main')
                            pos=before?'before':'after';
                        else
                            pos=items[index].pos||'after';
                    }
                    arr2=box._adjustItems2(arr, pos);
                }else{
                    arr2=box._adjustItems(arr);
                }

                //must be here
                if(index==-1)
                    xui.arr.insertAny(items,arr2, before?0:-1);
                else
                    xui.arr.insertAny(items,arr2, before?index:index+1);

                //if in dom, create it now
                if(profile.renderId){
                    data = box._prepareItems(profile, arr2, base);
                    r=profile._buildItems('items', data);
                    // try to render inner xui.UI
                    if(profile.$attached){
                        for(var i=0,v;v=profile.$attached[i++];){
                            if(v._render)v._render(true);
                        }
                        delete profile.$attached;
                    }
                    profile.getRoot().prepend(r);
                    profile.adjustSize();
                    t=null;
                }

                if(b)
                    profile.boxing()._afterInsertItems(profile, data, base, before);
            });
        },
        _afterRemoveItems:function(profile){
            if(profile.renderId)
                profile.adjustSize();
        },
        updateItem:function(subId,options){
            var self=this,
                profile=self.get(0),
                vertical=profile.properties.type=='vertical',
                getN=function(key,subId){return profile.getSubNodeByItemId(key,subId)},
                box=profile.box,
                items=profile.properties.items,
                rst=profile.queryItems(items,function(o){return typeof o=='object'?o.id===subId:o==subId},true,true,true),
                nid,item,serialId,node,sub,t;
            if(typeof options!='object')return;

            if(rst.length){
                rst=rst[0];
                if(typeof rst[0]!='object')
                    item=rst[2][rst[1]]={id:rst[0]};
                else
                    item=rst[0];

                // [[modify id
                if(xui.isSet(options.id))options.id+="";
                if(options.id && subId!==options.id){
                    nid=options.id;
                    var m2=profile.ItemIdMapSubSerialId, v;
                    if(!m2[nid]){
                        if(v=m2[subId]){
                            m2[nid]=v;
                            delete m2[subId];
                            profile.SubSerialIdMapItem[v].id=nid;
                        }else{
                            item.id=nid;
                        }
                    }
                }
                delete options.id;
                // modify id only
                if(xui.isEmpty(options))
                    return self;
                //]]

                var bResize=false;
                //in dom already?
                node=getN('ITEM',subId);
                if(!node.isEmpty()){
                    if(options.hasOwnProperty('size')){
                        options.size = Math.round(parseFloat(''+options.size));
                        if(options.size!=item._size){
                            item._size=options.size;
                            if(vertical)
                                node.height(options.size);
                             else
                                node.width(options.size);
                            bResize=true;
                        }
                    }
                    if(options.hasOwnProperty('hidden')){
                        options.hidden = !!options.hidden;
                        if(options.hidden !== item.hidden){
                            getN('ITEM',subId).css('display',options.hidden?'none':'');
                            bResize=true;
                        }
                    }
                    if(options.hasOwnProperty('locked')){
                        options.locked = !!options.locked;
                        if(options.locked !== item.locked){
                            getN('MOVE',subId).css({
                                display: options.locked?'none':'',
                                cursor: options.locked?'default':vertical?'n-resize':'w-resize'
                            });
                            getN('CMD',subId).css('display', (('cmd' in options)?options.cmd:item.cmd)&&!options.locked?'':'none');
                            bResize=true;
                        }
                    }
                    if(options.hasOwnProperty('folded')){
                        options.folded = !!options.folded;
                        if(options.folded !== item.folded)
                            profile.boxing().fireCmdClickEvent(subId);
                    }
                    if(options.hasOwnProperty('cmd')){
                        options.cmd = !!options.cmd;
                        if(options.cmd !== item.cmd)
                            getN('CMD',subId).css('display', options.cmd && !(('locked' in options)?options.locked:item.locked) ? '' : 'none');
                    }

                    var hash={};
                    if(options.hasOwnProperty('panelBgClr'))hash["background-color"]=options.panelBgClr;
                    if(options.hasOwnProperty('panelBgImg')){
                        hash["background-image"]=options.panelBgImg?("url("+xui.adjustRes(options.panelBgImg)+")"):"";
                    }
                    if(options.hasOwnProperty('panelBgImgPos'))hash["position-color"]=options.panelBgImgPos;
                    if(options.hasOwnProperty('panelBgImgRepeat'))hash["background-repeat"]=options.panelBgImgRepeat;
                    if(options.hasOwnProperty('panelBgImgAttachment'))hash["background-attachment"]=options.panelBgImgAttachment;
                    if(options.hasOwnProperty('overflow')){
                        var v=options.overflow;
                        if(v){
                            if(v.indexOf(':')!=-1){
                                xui.arr.each(v.split(/\s*;\s*/g),function(s){
                                    var a=s.split(/\s*:\s*/g);
                                    if(a.length>1){
                                        hash[xui.str.trim(a[0])]=xui.str.trim(a[1]||'');
                                    }
                                });
                            }
                        }
                        hash.overflow=v||"";
                    }
                    if(!xui.isEmpty(hash)){
                        getN('PANEL',subId).css(hash);
                    }
                }

                //merge options
                xui.merge(item, options, 'all');

                if(bResize)
                    profile.adjustSize();
            }
            return self;
        },
        fireCmdClickEvent:function(subId){
            this.getSubNodeByItemId('CMD', subId).onMousedown();
            return this;
        }
    },
    Static:{
        Templates:{
            tagName:'div',
            style:'{_style}',
            className:'{_className} {_trans}',
            text:"{items}",
            $submap:{
                items:{
                    ITEM:{
                        tagName:'div',
                        className:'{cls1} {itemClass}',
                        style:'{itemStyle};{display}',
                        MOVE:{
                            $order:0,
                            tagName:'div',
                            // give icon font for em size
                            className:'xui-ui-unselectable xui-uibar {clsmovebg} {cls2} ',
                            style:'{moveDisplay};cursor:{_cursor}'
                        },
                        CMD:{
                            $order:1,
                            tagName:'span',
                            style:'{cmdDisplay}',
                            className:'xui-node xui-ui-unselectable xuifont {cls3}',
                            $fonticon:'{_fi_cls3} '
                        },
                        PANEL:{
                            tagName:'div',
                            className:'xui-uibase xui-uicontainer',
                            style:'position:absolute;{_bginfo};{_overflow};',
                            text:xui.UI.$childTag
                        }
                    }
                }
            }
        },
        Appearances:{
            KEY:{
                position:'absolute',
                overflow:'hidden',
                left:0,
                top:0
            },
            "KEY-trans, KEY-trans > ITEM, KEY-trans > ITEM > PANEL, KEY-trans > ITEM > MOVE, KEY-trans > ITEM > CMD":{
                $order:100,
                "background-color":"transparent",
                "border":"none"
            },
            MOVE:{
                $order:0,
                position:'absolute',
                'z-index':'10'
            },
            CMD:{
                position:'absolute',
                cursor:'pointer',
                'z-index':'20'
            },
            ITEM:{
                position:'absolute',
                "z-index":1,
                overflow:'hidden',
                'border-width':xui.browser.opr?'0':null
            },
            PANEL:{
                position:'absolute',
                overflow:'auto',
                left:0,
                top:0,
                /*for opera, opera default set border to 3 ;( */
                'border-width':xui.browser.opr?'0':null
            },
            'ITEM-MAIN':{
                left:0,
                right:0,
                top:0,
                bottom:0
            },
            'ITEM-TOP, ITEM-BOTTOM':{
                left:0,
                right:0
            },
            'ITEM-LEFT, ITEM-RIGHT':{
                top:0,
                bottom:0
            },
            'MOVE-TOP, MOVE-BOTTOM':{
                width:'100%',
                height:xui.browser.contentBox?'.75em':'.83333em',
                cursor:'n-resize'
            },
            'MOVE-LEFT, MOVE-RIGHT':{
                height:'100%',
                width:xui.browser.contentBox?'.75em':'.83333em',
                cursor:'w-resize'
            },
            'MOVE-TOP':{
                bottom:0
            },
            'MOVE-BOTTOM':{
                top:0
            },
            'MOVE-LEFT':{
                right:'0'
            },
            'MOVE-RIGHT':{
                left:0
            },
            'CMD-TOP, CMD-BOTTOM, CMD-LEFT, CMD-RIGHT':{
                padding:0,
                'border-radius': '0',
                '-moz-border-radius': '0',
                '-webkit-border-radius': '0',
                '-o-border-radius': '0',
                '-ms-border-radius': '0',
                '-khtml-border-radius': '0'
            },
            'CMD-TOP':{
                $order:1,
                left:'50%',
                'margin-left':'-1em',
                bottom:0,
                width:'2em',
                height:xui.browser.contentBox?'.66667em':'.75em',
                'text-align':'center'
            },
            'CMD-BOTTOM':{
                $order:1,
                left:'50%',
                'margin-left':'-1em',
                top:0,
                width:'2em',
                height:xui.browser.contentBox?'.66667em':'.75em',
                'text-align':'center'
            },
            'CMD-LEFT':{
                $order:1,
                top:'50%',
                'margin-top':'-1em',
                right:0,
                height:'2em',
                width:xui.browser.contentBox?'.66667em':'.75em',
                'line-height':'2em'
            },
            'CMD-RIGHT':{
                $order:1,
                top:'50%',
                'margin-top':'-1em',
                left:0,
                height:'2em',
                width:xui.browser.contentBox?'.66667em':'.75em',
                'line-height':'2em'
            },
            'MOVE-MAIN':{
                $order:5,
                display:'none'
            },
            'CMD-MAIN':{
                $order:5,
                display:'none'
            }
        },
        Behaviors:{
            DroppableKeys:['PANEL'],
            PanelKeys:['PANEL'],
            HoverEffected:{MOVE:'MOVE',CMD:['MOVE','CMD']},
            ClickEffected:{CMD:'CMD'},
            onSize:xui.UI.$onSize,
            MOVE:{
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    var itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src);
                    if(item.folded)return;
                    if(item.locked)return;

                    var main = profile.getItemByItemId('main'),
                        o=profile.getSubNode('ITEM', itemId),
                        m=profile.getSubNodeByItemId('ITEM', 'main'),
                        cursor=xui.use(src).css('cursor'),
                        t=profile.properties,
                        h,w,mh,mw,offset1,offset2;

                    profile.pos=item.pos;

                    if(t.type=='vertical'){
                        h = profile._cur = o.height();
                        mh = m.height();
                        if(item.pos=='before'){
                            offset1 = h - item.min;
                            offset2 = Math.round(item.max?Math.min(parseFloat(item.max)-h, (mh-main.min)):(mh-main.min));
                        }else{
                            offset1 = Math.round(item.max?Math.min(parseFloat(item.max)-h, (mh-main.min)):(mh-main.min));
                            offset2 = h - item.min;
                        }

                        xui.use(src).startDrag(e,{
                            dragType:'copy',
                            targetReposition:false,
                            verticalOnly:true,
                            maxTopOffset:offset1,
                            maxBottomOffset:offset2,
                            dragCursor:cursor,
                            // IE8 bug
                            targetWidth:xui.browser.ie?xui.use(src).offsetWidth():null,
                            targetHeight:xui.browser.ie?xui.use(src).offsetHeight():null,
                            targetCallback:xui.browser.ie?function(n){n.tagClass('-(top|bottom)',false)}:null
                        });
                    }else{
                        w = profile._cur = o.width();
                        mw = m.width();
                        if(item.pos=='before'){
                            offset1 = w - item.min;
                            offset2 = Math.round(item.max?Math.min(parseFloat(item.max)-w, (mw-main.min)):(mw-main.min));
                        }else{
                            offset1 = Math.round(item.max?Math.min(parseFloat(item.max)-w, (mw-main.min)):(mw-main.min));
                            offset2 = w - item.min;
                        }

                        xui.use(src).startDrag(e,{
                            dragType:'copy',
                            targetReposition:false,
                            horizontalOnly:true,
                            maxLeftOffset:offset1,
                            maxRightOffset:offset2,
                            dragCursor:cursor,
                            // IE8 bug
                            targetWidth:xui.browser.ie?xui.use(src).offsetWidth():null,
                            targetHeight:xui.browser.ie?xui.use(src).offsetHeight():null,
                            targetCallback:xui.browser.ie?function(n){n.tagClass('-(left|right)',false)}:null
                        });
                    }

                    profile._limited=0;
                },
                onDrag:function(profile, e, src){
                    var t=profile.properties,
                        d=xui.DragDrop,
                        p=xui.DragDrop._profile,
                        b=0;
                    if(t.type=='vertical'){
                        if((p.y<=p.restrictedTop) || (p.y>=p.restrictedBottom))b=true;
                    }else{
                        if(p.x<=p.restrictedLeft || p.x>=p.restrictedRight)b=true;
                    }

                    if(b){
                        if(!profile._limited){
                            p.proxyNode.addClass('xui-alert');
                            profile._limited=true;
                        }
                    }else{
                        if(profile._limited){
                            p.proxyNode.removeClass('xui-alert');
                            profile._limited=0;
                        }
                    }

                },
                onDragstop:function(profile, e, src){
                    var t=profile.properties,
                        height=t.height,
                        width=t.width,
                        o=xui.use(src).parent(),
                        r=profile.getRoot(),
                        item = profile.getItemByDom(src),
                        sum=0, cur,
                        innerW=null,innerH=null,mainItem;
                    for (var i=0,l=t.items.length; i<l; i++){
                        if(!t.items[i].hidden)sum+= t.items[i].size || 80;
                        if(t.items[i].id=="main")mainItem=t.items[i];
                    }
                    //add offset and refresh
                    if(t.type=='vertical'){
                        innerH = r.height();
                        //use size to ignore onresize event once
                        item._size =  profile._cur + (profile.pos=='before'?1:-1)*xui.DragDrop.getProfile().offset.y
                        o.height(profile.$isEm(height)?profile.$px2em(item._size, o)+'em':item._size);
                        cur = sum * item._size / innerH;
                    }else{
                        innerW = r.width();
                        item._size = profile._cur + (profile.pos=='before'?1:-1)*xui.DragDrop.getProfile().offset.x
                        o.width(profile.$isEm(width)?profile.$px2em(item._size, o)+'em':item._size);
                        cur = sum * item._size / innerW;
                    }
                    // always - main
                    mainItem.size -= cur - item.size;
                    item.size = cur;
                    //use size to ignore onresize event once
                    // use px here,  _onresize handle em things
                    xui.UI.$tryResize(profile,  innerW, innerH, true);
                    profile._limited=0;
                }
            },
            CMD:{
                onMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!="left")return;
                    var t=profile.properties,
                        itemId = profile.getSubId(src),
                        item = profile.getItemByDom(src),
                        r=profile.getRoot(),
                        main = profile.getItemByItemId('main'),
                        m=profile.getSubNodeByItemId('ITEM', 'main'),
                        o = profile.getSubNode('ITEM',itemId),
                        panel = profile.getSubNode('PANEL',itemId),
                        move = profile.getSubNode('MOVE',itemId),
                        _handlerSize=(item.locked?0:t.type=='vertical'?move.offsetHeight():move.offsetWidth());

                    if(t.type=='vertical'){
                        // restore resize mode
                        if(item.folded){
                           // if(item._size <= m.height() - main.min + _handlerSize){
                                //restore h
                                o.height(item._size);
                                panel.show();

                                item.folded=false;
                                //set appearance
                                if(item.pos=='before')
                                    xui.use(src).replaceClass(/bottom/g,'top');
                                else
                                    xui.use(src).replaceClass(/top/g,'bottom');

                                //hidden 'move'
                                if(!item.locked)move.css('cursor','n-resize');
                                profile.getSubNode('MOVE').tagClass('-checked',false);
                           // }else
                           //    xui.message('no enough space!');
                        // to min and fix mode
                        }else{
                            o.height(_handlerSize);
                            panel.hide();

                            item.folded=true;
                            if(item.pos=='before')
                                xui.use(src).replaceClass(/top/g,'bottom');
                            else
                                xui.use(src).replaceClass(/bottom/g,'top');

                            if(!item.locked)
                                move.css('cursor','default');
                            profile.getSubNode('MOVE').tagClass('-checked');
                        }
                        xui.UI.$tryResize(profile,null,r.height(),true);
                    }else{
                        if(item.folded){
                           // if(item._size <= m.width()-main.min + _handlerSize){
                                o.width(item._size);
                                panel.show();
                                item.folded=false;
                                if(item.pos=='before')
                                    xui.use(src).replaceClass(/right/g,'left');
                                else
                                    xui.use(src).replaceClass(/left/g,'right');

                                if(!item.locked)move.css('cursor','w-resize');
                                profile.getSubNode('MOVE').tagClass('-checked',false);
                            //}else
                            //    xui.message('no enough space!');
                        }else{
                            o.width(_handlerSize);
                            panel.hide();
                            item.folded=true;
                            if(item.pos=='before')
                                xui.use(src).replaceClass(/left/g,'right');
                            else
                                xui.use(src).replaceClass(/right/g,'left');


                            if(!item.locked)
                                move.css('cursor','default');
                            profile.getSubNode('MOVE').tagClass('-checked');
                        }
                        xui.UI.$tryResize(profile,r.width(),null,true);
                    }

                    return false;
                }
            },
            PANEL:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                        item = profile.getItemByDom(src);
                    if(p.disabled || item.disabled)return false;
                    if(profile.onClickPanel)
                        return profile.boxing().onClickPanel(profile, item, e, src);
                }
            }
        },
        DataModel:{
            rotate:null,
            selectable:true,
            disabled:null,
            position:'absolute',
            type:{
                listbox:['vertical', 'horizontal'],
                ini:'vertical',
                action:function(value, ovalue){
                    if(value != ovalue){
                        var self=this, auto='auto',
                        nodes2 = self.getSubNode('ITEM',true),
                        nodes1 = self.getSubNode('MOVE',true),
                        nodes3 = self.getSubNode('CMD',true);
                        nodes1.merge(nodes2).merge(nodes3);

                        if(value=='vertical'){
                            nodes1.replaceClass(/(-left)(\b)/ig,'-top$2');
                            nodes1.replaceClass(/(-right)(\b)/ig,'-bottom$2');
                            nodes2.each(function(o){
                                xui(o).height(xui(o).width());
                            })
                            .css({left:0,top:auto,right:auto,bottom:auto})
                            ;
                        }else{
                            nodes1.replaceClass(/(-top)(\b)/ig,'-left$2');
                            nodes1.replaceClass(/(-bottom)(\b)/ig,'-right$2');
                            nodes2.each(function(o){
                                xui(o).width(xui(o).height());
                            })
                            .css({left:auto,top:0,right:auto,bottom:auto})
                            ;

                        }

                        self.adjustSize();
                    }
                }
            },
            dock:'fill',
            listKey:null,
            width:{
                $spaceunit:1,
                ini:'18em'
            },
            height:{
                $spaceunit:1,
                ini:'18em'
            },
            dragSortable:null,
            flexSize:{
                ini: false,
                action:function(){
                    this.adjustSize();
                }
            },
            transparent:{
                ini:false,
               action:function(v){
                    this.getRoot().tagClass('-trans', !!v);
               }
            },
            items:{
                ini:[] 
            }
        },
        EventHandlers:{
            onClickPanel:function(profile, item, e, src){}
        },
        _adjustItems2:function(items, pos){
            var arr=[];
            //arrage items
            xui.arr.each(items,function(o){
                if(o.id!='main'){
                    arr.push(o=xui.isHash(o)?o:{id:''+o});
                    o.pos=pos;
                }
            });

            //set the items to default value
            xui.arr.each(arr,function(o){
                o.id = xui.isStr(o.id)?o.id:xui.id();
                o.min = o.min || 10;
                o._size = o.size = Math.round(parseFloat(o.size)) || 80;
                o.locked= typeof o.locked=='boolean'?o.locked:false;
                o.folded = typeof o.folded=='boolean'?o.folded:false;
                o.hidden = typeof o.hidden=='boolean'?o.hidden:false;
                o.cmd = typeof o.cmd=='boolean'?o.cmd:true;
            });
            return arr;
        },
        _adjustItems:function(items){
            var main, before=[], after=[],watershed=0;

            //arrage items
            xui.arr.each(items,function(o,i){
                o=xui.copy(o);
                if(o.id=='main'){
                    main=o;
                    watershed=i;
                }else{
                    if(o.pos=='before'){
                        before.push(o);
                    }else if(o.pos=='after'){
                        after.push(o);
                    }else if(watershed){
                        o.pos='after';
                        after.push(o);
                    }else{
                        o.pos='after';
                        before.push(o);
                    }
                }
            });

            main = main || {};
            main.id = 'main';
            main.min = main.min || 10;
            // no _size in main
            main.size = Math.round(parseFloat(main.size)) || 80;

            //reset items
            items.length = 0;
            xui.arr.insertAny(items, this._adjustItems2(before,'before'));
            xui.arr.insertAny(items, main);
            xui.arr.insertAny(items, this._adjustItems2(after,'after'));

            return items;
        },
        _prepareData:function(profile){
            var prop=profile.properties;
            if(!prop.items || !xui.isArr(prop.items))
                prop.items = xui.clone([
                    {id:'before', pos:'before', locked:false, size:60, min: 50, max:200},
                    {id:'after',pos:'after', locked:false, size:60, min: 50, max:200}
                ]);
            prop.items = this._adjustItems(prop.items);

            var data = arguments.callee.upper.call(this, profile);
            data._trans=data.transparent?profile.getClass("KEY","-trans"):"";
            return data;
        },
        _prepareItems:function(profile, items){
            var data = arguments.callee.upper.apply(this, arguments);
            xui.arr.each(items,function(o){
                delete o.caption;
            });
            return data;
        },
        _prepareItem:function(profile, data,item){
            var p=profile.properties, 
                width=p.width, height=p.height,t;
            if(data.id=='main'){
                data.cls1=profile.getClass('ITEM', '-main');
                data.cls2  = profile.getClass('MOVE', '-main');
                data.cls3  = profile.getClass('CMD', '-main' );
            }else{
                var pos;
                if(p.type=='vertical'){
                    data.clsmovebg = "xui-uiborder-t xui-uiborder-b";
                    if(data.pos=='before')
                        pos='top';
                    else
                        pos='bottom';
                }else{
                    data.clsmovebg = "xui-uiborder-l xui-uiborder-r";
                    if(data.pos=='before')
                        pos='left';
                    else
                        pos='right';
                }

                data.cls1  = profile.getClass('ITEM', '-' + pos );
                data.cls2  = profile.getClass('MOVE', '-' + pos );
                data.cls3  = profile.getClass('CMD', '-' + pos );
                data._fi_cls3  = "xui-icon-arrow" + pos;

                data.display = data.hidden?'display:none':'';
                data._cursor = data.locked?'default':(p.type=='vertical')?'n-resize':'w-resize';
                data.cmdDisplay = (data.cmd&&!data.locked)?'':'display:none';
                data.moveDisplay = !data.locked?'':'display:none';
            }
            data._bginfo="";
            if(t=data.panelBgClr||p.panelBgClr)
                data._bginfo+="background-color:"+t+";";
            if(t=data.panelBgImg||p.panelBgImg)
                data._bginfo+="background-image:url("+xui.adjustRes(t)+");";
            if(t=data.panelBgImgPos||p.panelBgImgPos)
                data._bginfo+="background-position:"+t+";";
            if(t=data.panelBgImgRepeat||p.panelBgImgRepeat)
                data._bginfo+="background-repeat:"+t+";";
            if(t=data.panelBgImgAttachment||p.panelBgImgAttachment)
                data._bginfo+="background-attachment:"+t+";";
            if(xui.isStr(data.overflow))
                data._overflow = data.overflow.indexOf(':')!=-1?(data.overflow):(data.overflow?("overflow:"+data.overflow):"");
            else if(xui.isStr(p.overflow))
                data._overflow = p.overflow.indexOf(':')!=-1?(p.overflow):(p.overflow?("overflow:"+p.overflow):"");
        },
        RenderTrigger:function(){
            var t, profile=this;
            xui.arr.each(profile.properties.items,function(item){
                if(item.id!='main'){
                    if(item.folded && (t=profile.getSubIdByItemId(item.id))){
                            item.folded=false;
                            profile.getSubNode('CMD',t).onMousedown();
                        }
                }
            });
        },
        _onresize:function(profile,width,height){
            var t=profile.properties,itemId,
                key=profile.keys.ITEM,
                panel=profile.keys.PANEL,
                main=profile.getItemByItemId('main'),
                mainmin=main.min||10,
                pct = t.flexSize, 
                sum=0,

                move, _handlerSize,
                us = xui.$us(t),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                fzrate=profile.getEmSize()/profile.getRoot()._getEmSize();

            if(width)width=profile.$px(width);
            if(height)height=profile.$px(height);

            var obj={}, obj2={};
            // **keep the original size
            //,obj3={};
            xui.arr.each(t.items,function(o){
                itemId = profile.getSubIdByItemId(o.id);
                obj[itemId] = {};
                obj2[itemId] = {};
//                obj3[itemId] = o;
                if(pct && !o.hidden)sum+=o.size||80;
            });

            var fun=function(prop,w,width,left,right,offset,forceoffset){
                var _t,m,m1,itemId, temp1=0,temp2=0,temp=0,blocknumb=0,offsetbak=offset;

                xui.arr.each(prop.items,function(o){
                    if(o.id=='main')return;
                    if(o.pos=='before'){
                        itemId = profile.getSubIdByItemId(o.id);
                        move=profile.getSubNode('MOVE',itemId),
                        _handlerSize=(o.locked?0:t.type=='vertical'?move.offsetHeight():move.offsetWidth())
                        if(o.hidden){
                            m=0;
                            obj2[itemId][width]=Math.round(pct? parseFloat(w*Math.min(1,(o.size/sum))) :o._size);
                        }else if(o.folded){
                            m=obj2[itemId][width]=_handlerSize;
                        }else{
                            blocknumb++;
                            m=m1=Math.round(pct? parseFloat(w*Math.min(1,(o.size/sum))) :o._size);
                            if(m>offset+o.min){
                                m-=offset;
                            }else{
                                offset=m-o.min;
                                m=o.min;
                            }
                            m-=forceoffset;
                            m=Math.max(m,_handlerSize);
                        }
                        obj2[itemId][left]=temp1;
                        temp1 +=m;
                        obj[itemId][left]=0;
                        obj[itemId][width] = m - _handlerSize;
                        obj2[itemId][right]=obj[itemId][right]='auto';
                        obj2[itemId][width] = m;
                        mainmin+=_handlerSize;
                    }
                });
                xui.arr.each(prop.items,function(o){
                    if(o.id=='main')return;
                    if(o.pos=='after'){
                        itemId = profile.getSubIdByItemId(o.id);
                        move=profile.getSubNode('MOVE',itemId),
                        _handlerSize=(o.locked?0:t.type=='vertical'?move.offsetHeight():move.offsetWidth())
                        if(o.hidden){
                            m=0;
                            obj2[itemId][width]= Math.round(pct? parseFloat(w*Math.min(1,(o.size/sum))) : o._size);
                        }else if(o.folded){
                            m=obj2[itemId][width]=_handlerSize;
                        }else{
                            blocknumb++;
                            m=m1= Math.round(pct? parseFloat(w*Math.min(1,(o.size/sum))): o._size);
                            if(m>offset+o.min){
                                m-=offset;
                            }else{
                                offset=m-o.min;
                                m=o.min;
                            }
                            m-=forceoffset;
                            m=Math.max(m,_handlerSize);
                        }
                        obj2[itemId][right]=temp2;
                        temp2 +=m;
                        obj[itemId][right]=0;
                        obj[itemId][width] = m-_handlerSize;
                        obj2[itemId][left]=obj[itemId][left]='auto';
                        obj2[itemId][width] = m;
                        mainmin+=_handlerSize;
                    }
                },null,true);
                temp = temp1+temp2;

                //set main
                if(w-temp>=mainmin || forceoffset){
                    _t=profile.getSubIdByItemId('main');
                    obj2[_t][width]=obj[_t][width]=w-temp;
                    obj2[_t][left]=temp1;
                }else{
                    var args=xui.toArr(arguments);
                    // second time only
                    if(!offsetbak){
                        args[args.length-2]=(mainmin-(w-temp))/blocknumb;
                    }
                    // third time only
                    else{
                        args[args.length-2]=offsetbak;
                        args[args.length-1]=(mainmin-(w-temp))/blocknumb;
                    }
                    //second time
                    fun.apply(null,args);
                }
            };

            if(t.type!='vertical'){
                if(!xui.isNull(width)){
                    //get left
                    fun(t,width,'width','left','right',0,0);
//                    xui.each(obj2,function(o,i){
//                       if(o.width && !obj3[i].folded)obj3[i]._size=o.width;
//                    });
                 }
                if(!xui.isNull(height)){
                    xui.each(obj,function(o,id){
                        obj2[id].height=o.height=height;
                    });
                }
            }else{
                if(!xui.isNull(height)){
                    //get left
                    fun(t,height,'height','top','bottom',0,0);
//                    xui.each(obj2,function(o,i){
//                        if(o.height  && !obj3[i].folded)obj3[i]._size=o.height;
//                    });
                }
                if(!xui.isNull(width)){
                    xui.each(obj,function(o,id){
                        obj2[id].width=o.width=width;
                    });
                }
            }
            var ff_w=function(o, emRate){
               xui.arr.each("left,width,right".split(','),function(t){
                   if(t in o)o[t]=profile.$forceu(o[t],'em',emRate);
               });
            }, ff_h=function(o, emRate){
               xui.arr.each("top,height,bottom".split(','),function(t){
                    if(t in o)o[t]=profile.$forceu(o[t],'em',emRate);
               });
            };
            //collect width/height in size
            xui.each(obj2, function(o, id){
                var p=profile.getSubNode('PANEL', id),
                    i=profile.getSubNode('ITEM', id);
                
                if(us>0){
                    var pfz=us>0?p._getEmSize(fzrate):null,
                        ifz=us>0?i._getEmSize(fzrate):null;
                    ff_w(obj[id],ifz); ff_w(obj2[id],ifz);
                    ff_h(obj[id],pfz); ff_h(obj2[id],pfz);
                }
                p.cssRegion(obj[id], true);

                if(obj[id].width){
                    xui.UI._adjustConW(profile, p, obj[id].width);
                }

                i.cssRegion(obj2[id]);
            });
        }
    }
});
//rowMap => row_SerialIdMapItem
//rowMap2 => row_ItemIdMapSerialId
//colMap => header_SerialIdMapItem
//colMap2 => header_ItemIdMapSerialId
//cellMap => cells_SerialIdMapItem
//cellType: label,input,textarea,combobox,listbox,file,getter,helpinput,button,dropbutton,cmdbox,popbox,date,time,datetime,color,spin,counter,currency,number,checkbox,progress
xui.Class("xui.UI.TreeGrid",["xui.UI","xui.absValue"],{
    Instance:{
        activate:function(){
            var profile=this.get(0),t;
            if(!profile.renderId)return;
            profile.getSubNode('ROWS22').nextFocus(true, true, true);
            return this;
        },
        _setCtrlValue:function(value){
            return this.each(function(profile){
                if(!profile.renderId)return;
                if(profile.properties.activeMode=='none')return;

                var box = profile.boxing(),
                    uiv = box.getUIValue(),
                    p = profile.properties,
                    rowMap=profile.rowMap,
                    k = p.activeMode=='row'?['CELLS1','CELLS2','MARK']:'CELL',
                    getN = function(k,i){return profile.getSubNodes(k,i)},
                    getI = function(i){
                        var map1=profile.rowMap2;
                        if(p.activeMode=='row')
                            return map1[i];
                        else{
                            if(!i)return;
                            var r=(''+i).split('|');
                            return xui.get(profile.rowMap,[map1[r[0]],'_cells',r[1]]);
                        }
                    };

                if(p.selMode=='single'){
                    var itemId = getI(uiv);
                    if(uiv && itemId)
                        getN(k,itemId).tagClass('-checked',false);

                    itemId = getI(value);
                    if(itemId)
                        getN(k,itemId).tagClass('-checked');

                    /*if(itemId){
                        var o = getN("ROW",itemId);
                        if(o){
                            var top = o.offsetTop(),
                            items = getN('SCROLL'),
                            sh=items.scrollHeight(),
                            st=items.scrollTop(),
                            hh=items.height()
                            ;
                            if(sh > hh)
                                if(top<st || top>st+hh)
                                    items.scrollTop(top);
                        }
                    }*/
                }else if(p.selMode=='multi'||p.selMode=='multibycheckbox'){
                    uiv = uiv?(''+uiv).split(p.valueSeparator):[];
                    value = value?(''+value).split(p.valueSeparator):[];
                    //check all
                    xui.arr.each(uiv,function(o,i){
                        if(o=getI(o)){
                            if(i=rowMap[o])delete i._selected;
                            getN(k, o).tagClass('-checked',false);
                        }
                    });
                    xui.arr.each(value,function(o){
                        if(o=getI(o)){
                            if(i=rowMap[o])i._selected=1;
                            getN(k, o).tagClass('-checked');
                        }
                    });
                    // clear the header's row handler checkbox
                    if(value.length===0){
                        getN("HFMARK").tagClass('-checked',false);
                        delete profile._$checkAll;
                    }
                }
            });
        },
        calculateGridValue:function(){
            var profile=this.get(0), prop=profile.properties,
                f = prop.gridValueFormula,value=null,
                refs,coo,v2,cellsMap,xformula=xui.ExcelFormula,tcell, colMax, rowMax;
            if(profile.beforeGridValueCalculated && false!==(v2=profile.boxing().beforeGridValueCalculated(profile))){
                value = v2;
            }else{
                if(f){
                    colMax = prop.header.length;
                    // only for first level
                    rowMax = prop.rows.length;
                    if(xformula.validate(f)){
                        cellsMap={};
                        if(refs  = xformula.getRefCells(f, colMax, rowMax)){
                            xui.each(refs,function(v,i){
                                    coo = xformula.toCoordinate(i);
                                    tcell=prop.rows[coo.row].cells[coo.col];
                                    cellsMap[i] = tcell.value;
                            });
                        }
                        value = xformula.calculate(f, cellsMap,colMax,rowMax);
                    }
                }
            }
            if(profile.afterGridValueCalculated)
                profile.boxing().afterGridValueCalculated(profile, value);

            profile._$gridvalue = value;
            if(prop.excelCellId && profile._$oldgridvalue!==profile._$gridvalue){
                profile.boxing().notifyExcel(false) ;
            }
            return profile._$oldgridvalue = value;
        },
        // notify the grid's modification to fake excel ( in module )
        notifyExcel:xui.UI.Input.prototype.notifyExcel,
        // get grid's fake cexcel cell value
        getExcelCellValue:function(){
            var profile=this.get(0), prop=profile.properties,f,refs,coo,value,v2,cellsMap,xformula=xui.ExcelFormula,tcell, colMax, rowMax;
            if(prop.excelCellId){
                value = ('_$gridvalue' in profile) ? profile. _$gridvalue : this.caculateGridValue();
                if(xui.isSet(v2 = (profile.onGetExcelCellValue && profile.boxing().onGetExcelCellValue(profile, prop.excelCellId, value))))
                    value = v2;
                return value;
            }
            return null;
        },
        // calculate the cellTo's formula, and apply to the cell
        // only for first level
        applyCellFormula:function(cellTo, dirtyMark, triggerEvent){
            return this.each(function(prf){
                var tg=prf.box,  formula, j ,i, needUpdate,t2,cellsMap={},coo,
                    prop = prf.properties,
                    rows=prop.rows,
                    // only for first level
                    colMax = xui.arr.indexOf(prop.header, cellTo._col),
                    rowMax = xui.arr.indexOf(rows, cellTo._row),
                    xformula = xui.ExcelFormula;
                if(formula = tg._getCellFormula(prf, cellTo, xformula.toColumnChr(colMax+1),rowMax+1)){
                    var refs = xformula.getRefCells(formula, colMax,rowMax)
                    if(!refs)return ;
                    xui.each(refs,function(v,i){
                        coo = xformula.toCoordinate(i);
                        tcell = rows[coo.row].cells[coo.col];
                        cellsMap[i] = tcell.value;
                    });
                     t2=xformula.calculate(formula, cellsMap,colMax,rowMax);
                     if(t2!==cellTo.value){
                        needUpdate = [cellTo._serialId,t2,cellTo, formula];
                        if(prf.beforeApplyFormula && false===prf.boxing().beforeApplyFormula(prf, cellTo, t2, formula)){}else{
                            tg._updCell(prf, needUpdate[0], {value:needUpdate[1]}, dirtyMark, triggerEvent, true);
                        }
                        if(prf.afterApplyFormulas)
                            prf.boxing().afterApplyFormulas(prf, [needUpdate]);
                     }
                }
            });
        },
        // calculate all cells' (or cellFrom's)  formula, and apply to them(it)
        // only for first level
        triggerFormulas:function(cellFrom, dirtyMark, triggerEvent){
            return this.each(function(prf){
                var tg=prf.box,  cellId, 
                    prop=prf.properties, 
                    rows=prop.rows,
                    // only for first level
                    rowMax =rows.length,
                    colMax = prop.header.length,
                    xformula=xui.ExcelFormula,
                    formulaCells={}, formula, tcell;
                //1. collection all formula cells
                xui.arr.each(prop.rows, function(row,i){
                    xui.arr.each(row.cells,function(c,j){
                        if(c===cellFrom)cellId=xformula.toCellId(j,i);
                        if(formula = tg._getCellFormula(prf, c, xformula.toColumnChr(j+1), i+1)){
                            formulaCells[xformula.toCellId(j,i)]=[c,formula];
                        }
                    });
                });
                // if input cell, must remove itself;
                if(cellId)delete formulaCells[cellId];
                if(xui.isEmpty(formulaCells))return;

                //2. collect refs for formulaCells
                var refs={};
                xui.each(formulaCells,function(a, id){
                     if(a = xformula.getRefCells(a[1],colMax,rowMax))
                         refs[id]=a;
                });

                //3. loop to calculate non-ref cells
                var count, noFormulaRef, cellsMap={}, coo, needUpdate=[], t1,t2,
                    changed={}, needRec;
                if(cellId){
                    changed[cellId]=1;
                }
                do{
                    count=0;
                    xui.filter(refs,function(v,k){
                        needRec=0;
                        if(!cellId)needRec=1;
                        else{
                            for(var i in v){
                                if(i in changed){
                                    needRec=1;
                                    break;
                                }
                            }
                        }
                        // no need to re-calculate
                        if(!needRec){
                            return false;
                        }

                        noFormulaRef=true;
                         for(var i in v){
                            if(!cellId && (i in formulaCells)){
                                noFormulaRef=false;
                            }else{
                                if(!(i in cellsMap)){
                                    coo = xformula.toCoordinate(i);
                                    tcell = rows[coo.row].cells[coo.col];
                                    cellsMap[i] = tcell.value;
                                }
                            }
                         }
                         if(noFormulaRef){
                             t1=formulaCells[k];
                             t2=xformula.calculate(t1[1], cellsMap,colMax,rowMax);
                             if(t2!==t1[0].value){
                                 // keep update value
                                needUpdate.push([t1[0], t2, t1[1], t1[0]._serialId]);
                                if(cellId)changed[k]=1;
                             }
                            // remove from formulaCells
                            delete formulaCells[k];
                            count++;
                            return false;
                         }
                    });
                }
                // Avoid circular references
                while(!xui.isEmpty(formulaCells) && count>0);
                
                // update cell by order
                for(var i=0,l=needUpdate.length;i<l;i++){
                    if(prf.beforeApplyFormula && false===prf.boxing().beforeApplyFormula(prf, needUpdate[i][0], needUpdate[i][1], needUpdate[i][2])){}else{
                        tg._updCell(prf, needUpdate[i][3], {value:needUpdate[i][1]}, dirtyMark, triggerEvent, false);
                    }
                }
                // [[cell servialid, cell value, cell, fomula]]
                if(prf.afterApplyFormulas)
                    prf.boxing().afterApplyFormulas(prf, needUpdate);

                if(prop.gridValueFormula){
                    prf.boxing().calculateGridValue(false) ;
                }
            });
        },
        /*insert rows to dom
        arr is formatted properties
        pid,base are item id
        before: insert before?
        */
        _insertRowsToDom:function(profile, arr, pid, base, before,temp){
            //if parent not open, return
            if(pid){
                var parent = profile.rowMap[pid];
                if(parent && !parent._inited)return;
            }
            if(!arr)
                arr=[];

            var obj21,obj22,hw,
                box=profile.box,
                prop=profile.properties,
                hw=profile.getSubNode('FHCELL').width();
            if(hw)hw=profile.$forceu(hw);

            //give width at here, and do filter
            xui.arr.each(arr,function(o){
                o._row0DfW = hw?('width:'+hw):'';
                xui.arr.each(o.cells,function(v,i){
                    v.width=v._col._colWidth;
                })
            });
            // check freezed row exists?
            if(profile.properties.freezedRow){
                var t = profile.getSubNode('ROWS12');
                if(!t.isEmpty()  && t.query('div','id',/-ROWS12\:/).isEmpty())
                    delete profile._passFreezedRow;
            }

            //build dom
            var nodes21 = profile._buildItems('rows21', arr),
                nodes22 = profile._buildItems('rows22', arr);

            //get base dom
            if(!base){
                //no base add to parent
                if(pid){
                    obj21 = profile.getSubNode('SUB1', pid);
                    obj22 = profile.getSubNode('SUB2', pid);
                }else{
                    obj21 = profile.getSubNode('ROWS21');
                    obj22 = profile.getSubNode('ROWS22');
                }
                if(before){
                    obj21.prepend(nodes21);
                    obj22.prepend(nodes22);
                }else{
                    obj21.append(nodes21);
                    obj22.append(nodes22);
                }
            }else{
                //
                obj21 = profile.getSubNode('ROW1', base);
                obj22 = profile.getSubNode('ROW2', base);
                if(before){
                    obj21.addPrev(nodes21);
                    obj22.addPrev(nodes22);
                }else{
                    obj21.addNext(nodes21);
                    obj22.addNext(nodes22);
                }
            }

            //add sub
            xui.arr.each(arr,function(o){
                if(o.sub){
                    o.open=false;
                    if(false===box.getCellOption(profile, o, "iniFold"))
                        profile.boxing()._toggleRows([o],true,false,true);
                }
            });

            if(temp&&temp.length){
                var needshowinput=[],arrt=[];
                xui.arr.each(temp,function(o){
                       if(box.getCellOption(profile, o, "editable")&&
                           (box.getCellOption(profile, o, "editMode")=="inline"|| box.getCellOption(profile, o, "type")=='dropbutton'))
                            needshowinput.push(o);
                });
                temp.length=0;
                // for performance 25
                if(needshowinput.length){
                    for(var i=0,l=needshowinput.length,t;i<l;i++){
                        t=parseInt(i/25,10);
                        if(!arrt[t])arrt[t]=[];
                        arrt[t].push(needshowinput[i]);
                    }
                    needshowinput.length=0;
                    var fun=function(){
                        if(arrt.length){
                            var a=arrt.shift();
                            if(a&&a.length){
                                for(var i=0,l=a.length;i<l;i++){
                                    if(profile&&profile.box&&!profile.destroyed&&a[i]&&a[i]._row)
                                        profile.box._editCell(profile,a[i],null,true);
                                }
                                xui.asyRun(fun);
                            }
                        }else{
                            arrt=null;
                        }
                    };
                    // for event attached
                    xui.asyRun(fun);
                }
            }
            
            //clear rows cache
            delete profile.$allrowscache1;
            delete profile.$allrowscache2;

            profile.box._adjustBody(profile,'addrow');
        },
        _refreshHeader:function(header){
            var profile=this.get(0),
                prop=profile.properties,
                box=profile.box,
                grpcols=xui.clone(prop.grpCols,false,2),
                arr,arr2,
                rows=this.getRows("data");

            xui.breakO(profile.colMap,2);

            header=box._adjustHeader(header||[]);
            arr=box._prepareHeader(profile, header);
            prop.header = header;

            this.removeAllRows();

            profile.getSubNodes(['HCELL','HSCELL'], true).remove();

            var nodes1, nodes2;
            if(arr.length){
                nodes1=profile._buildItems('header1', arr);
                profile.getSubNode('HCELLS1').append(nodes1);
                nodes2=profile._buildItems('header2', arr);
                profile.getSubNode('LHCELL').addPrev(nodes2);
            }
            if(grpcols && xui.isArr(grpcols) && grpcols.length>0){
                grpcols=box._adjustGrpColsData(profile,grpcols);
                prop.grpCols=grpcols;
                arr2=box._prepareGrpCols(profile, grpcols, arr);
                if(arr2 && arr2.length){
                    nodes1=profile._buildItems('grpCols1', arr2);
                    profile.getSubNode('GRPCELLBOX1').append(nodes1);
                    nodes2=profile._buildItems('grpCols2', arr2);
                    profile.getSubNode('GRPCELLBOX2').append(nodes2);
                }
                box._adjustColsWidth(profile);
                box._adjustColsHeight(profile);

                profile.adjustSize();
            }
            if(rows&&rows.length)
                this.setRows(rows);

            box._adjustBody(profile,'refreshheader');

            //render
            var co=profile.properties.colOptions;
            xui.arr.each(arr,function(o){
                if(xui.isFun(o.colRenderer||co.colRenderer))
                    (o.colRenderer||co.colRenderer).call(null,profile,o);
            });
            // move it manually
            if(prop.treeMode=='infirstcell'){
                profile.getSubNode('HCELLA', arr[0]._serialId).prepend(
                    profile.getSubNode('LTAGCMDS')
                ).prepend(
                    profile.getSubNode('HFMARK')
                );
            }

            // clear collist cache
            if(profile.$col_pop){
                profile.$col_pop.destroy(true);
                delete profile.$col_pop;
            }
            //clear editor cache
            xui.each(profile.$cache_editor,function(o){
                if(!o.destroyed)o.destroy(true);
            });
            profile.$cache_editor={};
        },
        _toggleRows:function(rows, expand){
            var self=this;
            if(rows && rows.length)
                xui.arr.each(rows,function(o){
                    if(o.id)self.toggleRow(o.id, expand);
                });
        },
        autoRowHeight:function(rowId){
            return this.each(function(prf){
                if(prf.renderId ){
                    var ev=xui.Event;
                    if(ev.__realtouch)ev.__simulatedMousedown=1;
                    if(rowId && prf.rowMap2[rowId])
                        prf.getSubNode('FHANDLER',prf.rowMap2[rowId]).onDblclick(true);
                    else
                        xui.each(prf.rowMap,function(o,i){
                            prf.getSubNode('FHANDLER',i).onDblclick(true);
                        });
                    if(ev.__realtouch)ev.__simulatedMousedown=0;
                }
            });
        },
        autoColWidth:function(colId){
            return this.each(function(prf){
                if(prf.renderId){
                    var ev=xui.Event;
                    if(ev.__realtouch)ev.__simulatedMousedown=1;

                    if(colId && prf.colMap2[colId])
                        prf.getSubNode('HHANDLER',prf.colMap2[colId]).onDblclick(true);
                    else
                        xui.each(prf.colMap,function(o,i){
                            prf.getSubNode('HHANDLER',i).onDblclick(true);
                        });
                    if(ev.__realtouch)ev.__simulatedMousedown=0;
                }
            });
        },
        autoColHeight:function(){
            return this.each(function(prf){
                if(prf.renderId){
                    var ev=xui.Event;
                    if(ev.__realtouch)ev.__simulatedMousedown=1;
                    prf.getSubNode('FHANDLER').onDblclick(true);
                    if(ev.__realtouch)ev.__simulatedMousedown=0;
                }
            });
        },
        addHotRow:function(focusColId){
            var prf=this.get(0);
            if(prf.renderId)
                prf.box._addTempRow(prf, focusColId||null);
            return this;
        },
        getHotRow:function(type){
            return this.getRowbyRowId(this.Class._temprowid, type);
        },
        updateHotRow:function(cells,dirtyMark,triggerEvent){
            return this.updateRow(this.Class._temprowid, {cells: cells}, dirtyMark,triggerEvent);
        },
        removeHotRow:function(){
            var profile=this.get(0);
            profile.box._sethotrowoutterblur(profile,true);
            delete profile.__hastmpRow;
            this.removeRows([profile.box._temprowid],false);
            return this;
        },
        isDirtied:function(){
            var dirty=false, prf=this.get(0);
            // check grid (for delete)
            if(prf._dirty)return true;
            // check row (for new row)
            xui.each(prf.rowMap,function(v){
                if(v._dirty || v._oValue!==v.value||(('unit' in v) && v._oUnit!==v.unit)){
                    dirty=true;
                    return false;
                }
            });
            // check cell
            xui.each(prf.cellMap,function(v){
                if(v._dirty || v._oValue!==v.value || (('unit' in v) && v._oUnit!==v.unit)){
                    dirty=true;
                    return false;
                }
            });
            return dirty;
        },
        isCellDirtied:function(cell){
            return cell._dirty || cell._oValue!==cell.value || (('unit' in cell) && cell._oUnit!==cell.unit);
        },
        isRowDirtied:function(row){
            var ns=this, dirty = row._dirty || row._oValue!==row.value;
            if(prf._dirty)return true;
            for(var i=0,l=row.cells.length;i<l;i++){
                if(ns.isCellDirtied(cell))
                    return true;
            }
            return false;
        },
        _getObjByDom:function(src, type){
            var prf=this.get(0),
                subId=prf.getSubId(typeof src=='string'
                    ? src.charAt(0)=='!'
                        ? ((src=xui.use(src).get(0))&&src.id)
                        : src
                    : src.id );
            return prf[type=="row"?"rowMap":type=="col"?"colMap":"cellMap"][subId];
        },
        getRowByDom:function(src, type, splitMixColumn){
            return this.get(0).box._getRow(this.get(0), this._getObjByDom(src, "row"),type,splitMixColumn);
        },
        getHeaderByDom:function(src){
            return this._getObjByDom(src, "col");
        },
        getCellByDom:function(src){
            return this._getObjByDom(src, "cell");
        },
        /*rows related*/
        //type: 'original', 'data', 'map', 'min'
        getRows:function(type, splitMixColumn){
            var v=this.get(0).properties.rows,a,b;
            if(!xui.isArr(v))return [];
            if(type=='data'||type=='min'||type=='map'){
                a=xui.clone(v,true);

                if(a&&a.length&&a[a.length-1]&&a[a.length-1].id==this.constructor._temprowid)
                    a.pop();

                if(type=='min'){
                    xui.arr.each(a,function(o,i){
                        if(a[i].cells){
                            xui.each(b=a[i]=a[i].cells,function(v,j){
                                b[j] = v.value;
                            });
                        }
                    });
                }else if(type=='map'){
                    a = this.getRawData(null, splitMixColumn);
                }
                return a;
            }else
                return v;
        },
        getRowbyRowId:function(rowId, type, splitMixColumn){
            var profile=this.get(0),v=profile.rowMap2,rows=profile.properties.rows,t;
            if(xui.isNumb(rowId))rowId=xui.get(rows,[rowId==-1?(rows.length-1):rowId,"id"]);
            if(v&&v[rowId])
                return profile.box._getRow(profile, profile.rowMap[v[rowId]], type, splitMixColumn);
            if((v=profile.queryItems(rows, function(v,k){
                return v.id==rowId;
            }, 1,1))&&v.length)
                return profile.box._getRow(profile, v[0], type, splitMixColumn);
        },
        getRowbyCell:function(cell, type, splitMixColumn){
            return this.constructor._getRow(this.get(0), cell._row, type, splitMixColumn);
        },
        toggleRow:function(rowId, expand, recursive, stopanim, callback){
            var ns=this, profile = this.get(0),self=arguments.callee,
                    v=profile.rowMap2,rows=profile.properties.rows;
            if(xui.isNumb(rowId))rowId=xui.get(rows,[rowId==-1?(rows.length-1):rowId,"id"]);
            if(v&&v[rowId]){
                var row = profile.rowMap[v[rowId]];
                if(row && row.sub && (!xui.isSet(expand) || !!expand !== !!row._checked)){
                    profile.box._setSub(profile, row, xui.isSet(expand) ?!!expand:!row._checked, recursive, stopanim||recursive, callback);
                }
            }else{
                xui.arr.each(rows,function(row){
                    if(row.sub)
                        self.call(ns,row.id,expand,recursive, true, callback);
                })
            }
            return this;
        },
        showRows:function(rowId,/*default is the current*/ show){
            var ns=this,
                profile = ns.get(0), 
                showNodes=xui(),
                hideNodes=xui(),
                prop = profile.properties;
            rowId = xui.isHash(rowId)?rowId.id:xui.isArr(rowId)?rowId:rowId===0?[0]:rowId?(rowId+'').split(prop.valueSeparator):null;
            if(!rowId){
                rowId=xui.get(ns.getActiveRow(),"id") || ((prop.$UIvalue||prop.value)+"");
                rowId=rowId.split(prop.valueSeparator);
            }
            if(rowId&&rowId.length){
                xui.arr.each(rowId, function(r, row){
                    if(row=ns.getRowbyRowId(r)){
                        if(show===false){
                            if(!row.hidden)hideNodes.merge(ns.getSubNodes(['ROW1','ROW2'],row._serialId));
                        }else{
                            if(row.hidden)showNodes.merge(ns.getSubNodes(['ROW1','ROW2'],row._serialId));
                        }
                        row.hidden=show===false;
                    }
                });
            }

            // reflect to dom 
            if(!showNodes.isEmpty())showNodes.css('display','');
            if(!hideNodes.isEmpty())hideNodes.css('display','none');
            return this;
        },
        updateRow:function(rowId/*default is the current*/,options,dirtyMark,triggerEvent){
            var ns=this,
                profile = ns.get(0), 
                box = profile.box,
                prop = profile.properties,
                prforow;
 
            if(!rowId&&rowId!==0)rowId=xui.get(ns.getActiveRow(),"id") || ((prop.$UIvalue||prop.value)+"").split(prop.valueSeparator)[0];
            orow = ns.getRowbyRowId(rowId);
            if(!orow)return ns;

            var pdm = prop.dirtyMark,
                psdm = pdm && prop.showDirtyMark, 
                ishotrow = orow.id==box._temprowid,
                sc = xui.absObj.$specialChars,
                ext;

            
            if(!xui.isHash(options)){
                if(xui.isArr(options)) options={cells:options};
                else options={value:options};
            }

            options=xui.filter(options,function(o,i,r){r= !sc[i.charAt(0)]; if(!r){ext=ext||{}; ext[i]=o} return r;});

            if(triggerEvent){
                if(profile.beforeRowUpdated && false === profile.boxing().beforeRowUpdated(profile, orow, options, ishotrow, ext))
                    return;
            }
            if(!xui.isEmpty(options)){
                if(orow){
                    var rid=orow._serialId, t, tt, nid ;

                    // [[modify id
                    if(xui.isSet(options.id))options.id+="";
                    if(options.id && options.id!==rowId){
                        nid=options.id;
                        var m2=profile.rowMap2, v;
                        if(!m2[nid]){
                            if(v=m2[rowId]){
                                m2[nid]=v;
                                delete m2[rowId];
                                profile.rowMap[v].id=nid;
                                // modify cells link
                                xui.each(profile.colMap,function(o){
                                    if(o=o._cells){
                                        o[nid]=o[rowId];
                                        delete o[rowId];
                                    }
                                });
                            }
                        }
                    }else{
                        options.id=rowId;
                    }
                    // modify id only
                    if(xui.isEmpty(options))
                        return ns;
                    //]]

                    // need to refresh
                    if(('group' in options && options.group!=orow.group) ||
                        'cells' in options ||
                        ('sub' in options &&
                        // only try to show/hide toggle icon
                        !((options.sub===true && !orow.sub) || (!options.sub && orow.sub===true)))
                    ){
                        var id="__special",pid=orow._pid?profile.rowMap[orow._pid].id:null;
                        // change id in rowMap
                        orow.id=id;
                        // change link in rowMap2
                        profile.rowMap2[id]=profile.rowMap2[nid||rowId];
                        delete profile.rowMap2[nid||rowId];
                        // remove cells link
                        xui.each(profile.colMap,function(o){
                            if(o=o._cells)
                                delete o[nid||rowId];
                        });
                        // make sure data
                        orow=xui.clone(orow,true);
                        xui.merge(orow, options, 'all');
                        if('sub' in options && !options.sub)delete orow.sub;

                        ns.insertRows([orow],pid,id,true);
                        ns.removeRows([id]);

                        if(profile.properties.activeMode=='row'){
                            var uiv=profile.properties.$UIvalue||"", arr=(''+uiv).split(profile.properties.valueSeparator);
                            if(arr.length && xui.arr.indexOf(arr, rowId)!=-1){
                                if(nid)
                                    xui.arr.removeValue(arr, rowId);
                                ns.setUIValue(arr.join(profile.properties.valueSeparator), true,null,'sub');
                            }
                        }
                    }else{
                        if('sub' in options){
                            t = box._getToggleNode(profile, rid);
                            if(options.sub){
                                t.addClass('xui-uicmd-toggle');
                                if(orow._layer)
                                    t.removeClass('xui-uicmd-empty');
                            }else{
                                t.removeClass('xui-uicmd-toggle');
                                if(orow._layer)
                                    t.addClass('xui-uicmd-empty');
                            }
                        }
                        // 
                        tt = ns.getSubNodes(['CELLS1','CELLS2'],rid);
                        if(t=profile.$px(options.height)) profile.box._adjusteditorH(profile, tt.height(orow._rowHeight=profile.$forceu(t) ),t);
                        if(t=options.rowStyle) tt.attr('style',tt.attr('style')+";"+t);
                        if(t=options.rowClass) tt.addClass(t);
                        if(options.hasOwnProperty('disabled')){
                            var cls='xui-uicell-disabled';
                            if(options.disabled)
                                tt.addClass(cls);
                            else
                                tt.removeClass(cls);
                        }
                        if(options.hasOwnProperty('readonly')){
                            var cls='xui-ui-readonly';
                            if(options.readonly)
                                tt.addClass(cls);
                            else
                                tt.removeClass(cls);
                        }
                        //
                        if(t=options.firstCellStyle) (tt=ns.getSubNode('FCELL',rid)).first().attr('style',tt.attr('style')+";"+t);
                        if(t=options.firstCellClass) ns.getSubNode('FCELL',rid).first().addClass(t);

                        if(options.hasOwnProperty('value') && !xui.isSet(options.caption) ) {
                            options.caption = options.value +"";
                        }
                        if(options.hasOwnProperty('caption'))
                            ns.getSubNode('FCELLCAPTION',rid).get(0).innerHTML=options.caption||"";

                        if(options.hasOwnProperty('rowResizer')){
                            t=!!options.rowResizer;
                            ns.getSubNode('FHANDLER',rid).css('display',(options.rowResizer=t)?"block":'none');
                        }

                        if(options.hasOwnProperty('hidden')){
                            var  b = !!options.hidden;
                            if(b){
                                if(orow.hidden!==true){
                                    ns.getSubNodes(['ROW1','ROW2'],rid).css('display','none');
                                }
                            }else{
                                if(orow.hidden===true){
                                    ns.getSubNodes(['ROW1','ROW2'],rid).css('display','');
                                }
                            }
                        }

                        xui.merge(orow, options, 'all');

                        //if update value
                        if(options.hasOwnProperty('value')){
                            var node=profile.getSubNode('CELLA', rid);
                            if(!pdm || dirtyMark===false)
                                orow._oValue=orow.value;
                            else{
                                if(orow.value===orow._oValue){
                                    if(psdm)
                                        node.removeClass('xui-ui-dirty');
                                }else{
                                    if(psdm)
                                        node.addClass('xui-ui-dirty');
                                }
                            }
                            if(orow._editor)orow._editor.setValue(options.value,true,'editorini');
                        }
                    }
                }else{
                    var rst=ns.get(0).queryItems(ns.getRows(),function(o){return typeof o=='object'?o.id===rowId:o==rowId},true,true,true);
                    if(rst.length)
                        xui.merge(orow = rst[0][0], options, 'all');
                }
                orow._dirty=true;
            }
            if(triggerEvent){
                if(profile.afterRowUpdated)
                    profile.boxing().afterRowUpdated(profile, orow, options, ishotrow, ext);
            }
            return ns;
        },
        //pid,base are id
        insertRows:function(arr, pid/*true: the current item*/, base/*true: the current item*/, before, ignoreMixColumn){
            var affectUI=arguments[4],
                ns=this,
                c=ns.constructor,
                profile=ns.get(0);
            if(xui.isHash(arr))arr=[arr];
            if(arr && xui.isArr(arr) && arr.length>0){
                var prop=profile.properties,
                    row_m=profile.rowMap2,
                    ro=prop.rowOptions,
                    b=profile.rowMap, temp,
                    tar, t, k;
                // current 
                if(pid===true){
                    v=prop.$UIvalue||prop.value;
                    if(v)v=(v+'').split(prop.valueSeparator);
                    pid=v[0];
                }

                pid = row_m&&row_m[pid];
                if(base===true){
                    v=prop.$UIvalue||prop.value;
                    if(v)v=(v+'').split(prop.valueSeparator);
                    base=v[0];
                }
                base = row_m&&row_m[base];
                if(base){
                    t=profile.rowMap[base];
                    if(t)pid=t._pid;
                }
                arr=c._adjustRows(profile, arr, ignoreMixColumn);
                if(!pid)
                    tar = xui.isArr(prop.rows)?prop.rows:(prop.rows=[]);
                else{
                    k=b&&b[pid];
                    tar = xui.isArr(k.sub)?k.sub:(k.sub=[]);
                }

                //1
                var rows;
                if(profile.renderId){
                    // if insert to root, or the parent node is inited
                    if(!pid || k._inited){
                        //prepareData(add links)
                        temp=[];
                        rows = c._prepareItems(profile, arr, pid,temp);
                        ns._insertRowsToDom(profile, rows, pid, base, before,temp);

                        //render
                        xui.arr.each(arr,function(o){
                            if(xui.isFun(o.rowRenderer||ro.rowRenderer))
                                (o.rowRenderer||ro.rowRenderer).call(null,profile,o);
                        });
                    }
                    // normal row to tree row
                    else if(pid && !k.inited){
                        profile.box._getToggleNode(profile, pid)
                                .removeClass('xui-icon-placeholder xui-uicmd-none')
                                .addClass('xui-uicmd-toggle');
                    }
                }
                //2
                //must be here
                if(!base)
                    xui.arr.insertAny(tar, arr, before?0:-1);
                else{
                    var index = xui.arr.subIndexOf(tar,'_serialId', base);
                    xui.arr.insertAny(tar,arr, before?index:(index+1));
                }
                //3
                if(profile.renderId){
                    profile.box._asy(profile);
                }

                if(rows&&rows.length){
                    xui.breakO(rows,2);
                    rows.length=0;
                }
            }
            if(affectUI!==false && profile.renderId&&profile.__hastmpRow){
                profile.box.__ensurehotrow(profile,null);
            }
    
            // try to hide ui-no-children row
            // logic must same to doFilter
            if(profile.$itemFilter){
                var hideRows=[];
                xui.arr.each(arr,function(row){
                   if(row.sub && !row.hidden){
                    //  if(!row._checked && row.id)
                    //      ns.toggleRow(row.id, true, false, true);
                       if(true!==profile.$itemFilter(row,'checkSub',profile)){
                            var flag;
                            for(var i=0,l=row.sub.length;i<l;i++){
                               if( !row.sub[i].hidden){
                                   flag=1;break;
                               }
                           }
                           if(!flag)hideRows.push(row.id);
                       }else{
                           hideRows.push(row.id);
                       }
                   }
                });
                if(hideRows.length)ns.showRows(hideRows,false);
            }
            return ns;
        },
        doFilter:xui.absList.prototype.doFilter,
        //delete row according to id
        //xui.UI.TreeGrid.getAll().removeRows(['2','5'])
        removeRows:function(ids/*default is the current*/){
            var affectUI=arguments[1],
                self=this,
                profile=self.get(0);
            if(!profile.rowMap2)return;

            var p=profile.properties,
                cell=profile.cellMap,
                nodes=[],v,count=0;

            //get array
            ids = xui.isHash(ids)?[ids.id]:xui.isArr(ids)?ids:ids===0?[0]:ids?(ids+"").split(p.valueSeparator):null;
            if(!ids){
                ids= xui.get(self.getActiveRow(),"id") || ((p.$UIvalue||p.value)+"");
                ids = ids.split(p.valueSeparator);
            }
            if(!ids || !ids.length)return self;

            xui.arr.each(ids,function(o,i){
                if(xui.isNumb(o))
                    o=p.rows[o] && p.rows[o].id;
                ids[i]=''+o;
            });
            xui.arr.each(ids,function(id){
                //get item id
                if(id=profile.rowMap2[id]){
                    count++;
                    //get row
                    var row;
                    if(row = profile.rowMap[id]){
                        var tdids = row._cells,
                            rowid = row.id,
                            temp;
                        //for sub delete
                        if(row.sub && xui.isArr(row.sub)){
                            var arr=[];
                            xui.arr.each(row.sub,function(o){
                                arr.push(o.id)
                            });
                            self.removeRows(arr);
                        }

                        ////delete and clear links
                        xui.each(tdids,function(o,i){
                            //clear colMap/properties.header
                            delete cell[o]._col._cells[rowid];
                            xui.breakO(cell[o]);
                            //clear cellMap
                            delete cell[o];
                            profile.reclaimSubId(o.slice(3), 'cell');
                        });

                        //clear properties.row array
                        if(temp= row._pid?(temp=profile.rowMap[row._pid])?temp.sub:null:profile.properties.rows)
                            if(xui.isArr(temp))
                                xui.filter(temp,function(o){
                                    return o._serialId != id;
                                });

                        //clear profile.rowMap2
                        delete profile.rowMap2[rowid];

                        //clear rowMap
                        xui.breakO(profile.rowMap[id]);
                        delete profile.rowMap[id];

                        nodes.push(profile.getSubNode('ROW1', id).get(0));
                        nodes.push(profile.getSubNode('ROW2', id).get(0));
                    }
                    profile.reclaimSubId(id.slice(3), 'row');
                }else{
                    var f=function(rows){
                        var index=xui.arr.subIndexOf(rows, "id", id);
                        if(index!==-1){
                            count++;
                            xui.arr.removeFrom(rows,index);
                        }
                        xui.arr.each(rows,function(row){
                            if(row.sub)f(row.sub);
                        });
                    };
                    f(p.rows);
                }
            });
            if(count>0){
                // clear UI value
                if(v=p.$UIvalue){
                    if((v=(''+v).split(p.valueSeparator)).length>1){
                        xui.filter(v,function(o){
                            return xui.arr.indexOf(ids,o)==-1;
                        });
                        p.$UIvalue=v.join(p.valueSeparator);
                    }else{
                        if(xui.arr.indexOf(ids,p.$UIvalue)!=-1)
                            p.$UIvalue=null;
                    }
                }
                xui(nodes).remove();

                // remove activerow/cell
                if(profile.$activeCell && !xui.Dom.byId(profile.$activeCell))
                    delete profile.$activeCell;
                if(profile.$activeRow && !xui.Dom.byId(profile.$activeRow))
                    delete profile.$activeRow;

                //clear rows cache
                delete profile.$allrowscache1;
                delete profile.$allrowscache2;

                profile.box._asy(profile);
                profile.box._adjustBody(profile,'delrow');
            }
            if(affectUI!==false && profile.renderId&&profile.__hastmpRow){
                profile.box.__ensurehotrow(profile,null);
            }
            profile._dirty=1;
            return self;
        },
        insertCol:function(col, cells, pos){
            var profile=this.get(0),
                prop=profile.properties,
                box=profile.box,
                rows=prop.rows,
                cell,base,colResult,cellResult;

            //// handle header
            // position
            pos=xui.isNumb(pos)?pos:-1;
            if(pos===-1||prop.header.length<pos)pos=prop.header.length;
            if(pos<0)pos=0;
            if(prop.treeMode=='infirstcell' && pos===0)return false;

            var leftRegion = pos <= prop.freezedColumn -1 ;

            var arr=prop.grpCols;
            if(arr && xui.isArr(arr)&& arr.length){
                for(var j=0,m=arr.length,grp;j<m;j++){
                    grp=arr[j];
                    if(grp.from>pos){
                        grp.from++;
                        grp['to']++;
                    }else if(pos>=grp.from && pos<=grp['to']){
                        grp['to']++;
                    }
                }
            }

            if(profile.renderId){
                colResult = box._parepareCol(profile, col,prop.header);
                col=colResult[0];

                // insert header
                xui.arr.insertAny(prop.header, col, pos);
                // insert dom node
                base = profile.getSubNode(leftRegion?'HCELLS1':'HCELLS2').children().get(pos-1/*must be before LCELL*/);
                if(base)
                    xui(base).addNext(profile._buildItems(leftRegion?'header1':'header2', [colResult[1]]));

                // render
                var co=profile.properties.colOptions;
                if(xui.isFun(col.colRenderer||co.colRenderer))
                    (col.colRenderer||co.colRenderer).call(null,profile,col);

                // for adjust UI
                prop.grpCols=box._adjustGrpColsData(profile,arr);
                box._adjustColsWidth(profile);
                box._adjustColsHeight(profile);
                box._adjustBody(profile,'addcol');
            }else{
                // insert header dir
                xui.arr.insertAny(prop.header, col, pos);
            }

            //// handle cells
            cells=xui.isArr(cells)?cells:[];
            var k=0, applaycell=function(rows){
                    var temp=[];
                    xui.arr.each(rows,function(row,i){
                        if(row.group){
                            applaycell(row.sub);
                        }else{
                            cell=cells[k];
                            // this row was rendered
                            base=profile.getSubNode(leftRegion?'CELLS1':'CELLS2',row._serialId).children().get(pos-1/*must be before LCELL*/);
                            if(base){
                                cellResult = box._prepareCell(profile,cell,row,col,temp);

                                // original cell only
                                xui.arr.insertAny(row.cells, cellResult[0], pos);
                                // insert dom node
                                xui(base).addNext(profile._buildItems(leftRegion?'rows1.cells':'rows2.cells', [cellResult[1]]));
                            }else{
                                // insert cell dir
                                xui.arr.insertAny(row.cells, cell||{}, pos);
                            }
                        }
                        k++;
                    });
                    if(temp.length){
                        xui.arr.each(temp,function(o){
                               if(box.getCellOption(profile, o, "editable")&&
                                   (box.getCellOption(profile, o, "editMode")=="inline"||box.getCellOption(profile, o, "type")=="dropbutton"))
                                    box._editCell(profile,o);
                        });
                        temp.length=0;
                    }
                };
            if(rows&&xui.isArr(rows)){
                applaycell(rows);
            }
            profile._dirty=1;
        },
        removeCols:function(ids){
            var affectUI=arguments[1],
                self=this,
                profile=self.get(0),
                box=profile.box,
                p=profile.properties,
                cell=profile.cellMap,
                SubID=xui.UI.$tag_subId,
                nodes=[],count=0;

            //get array
            ids = xui.isArr(ids)?ids:(ids+"").split(p.valueSeparator);
            xui.arr.each(ids,function(o,i){ids[i]=''+o});
            if(ids&&ids.length>1){
                ids.sort(function(x,y){
                    var xx=xui.arr.indexOf(p.header, x);
                    if(xx==-1)xx=xui.arr.subIndexOf(p.header, "id", x);
                    var yy=xui.arr.indexOf(p.header, y);
                    if(yy==-1)yy=xui.arr.subIndexOf(p.header, "id", y);
                    return xx>yy?1:xx===yy?0:-1;
                });
            }

            var arr=p.grpCols;
            if(arr && xui.isArr(arr)&& arr.length){
                xui.arr.each(ids,function(id){
                    var pos=xui.arr.indexOf(p.header, id);
                    if(pos==-1)pos=xui.arr.subIndexOf(p.header, "id", id);
                    if(pos==-1)return;
                    for(var j=0,m=arr.length,grp;j<m;j++){
                        grp=arr[j];
                        if(grp.from>pos){
                            grp.from--;
                            grp['to']--;
                        }else if(pos>=grp.from && pos<=grp['to']){
                           grp['to']--;
                        }
                    }
                },null,true);

                xui.filter(arr,function(o){
                    var r=o['to']>=o.from;
                    if(!r && profile.renderId){
                        profile.getSubNode(["HCELL","HSCELL"],o[SubID]).remove();
                        delete profile.colMap[o[SubID]];
                        delete profile.colMap2[o.id];
                    }
                    return r;
                });
            }

            xui.arr.each(ids,function(id){
                var index=xui.arr.indexOf(p.header, id);
                if(index==-1)index=xui.arr.subIndexOf(p.header, "id", id);
                if(index==-1)return;

                // clear UI and links
                if(profile.colMap2 && (id=profile.colMap2[id])){
                    count++;
                    //get row
                    var col;
                    if(col = profile.colMap[id]){
                        var tdids = col._cells,
                            colid = col.id;

                        ////delete and clear links
                        xui.each(tdids,function(o,i){
                            nodes.push(profile.getSubNode('CELL', o).get(0));
                            //clear colMap/properties.header
                            delete cell[o]._row._cells[colid];
                            xui.breakO(cell[o]);
                            //clear cellMap
                            delete cell[o];
                            profile.reclaimSubId(o.slice(3), 'cell');
                        });

                        //clear profile.rowMap2
                        delete profile.colMap2[colid];

                        //clear rowMap
                        xui.breakO(profile.colMap[id]);
                        delete profile.colMap[id];
                        var t;
                        t=profile.getSubNode('HCELL', id).get(0);
                        if(t)nodes.push(t);
                        t=profile.getSubNode('HSCELL', id).get(0);
                        if(t)nodes.push(t);
                    }
                    profile.reclaimSubId(id.slice(3), 'header');
                }

                var applaycell=function(rows){
                    xui.arr.each(rows,function(row){
                        if(row.cells)xui.arr.removeFrom(row.cells,index);
                        if(row.sub){
                            applaycell(row.sub);
                        }
                    });
                };
                applaycell(p.rows);

                xui.arr.removeFrom(p.header,index);
            },null,true);
            if(count>0){
                xui(nodes).remove();

                // remove activerow/cell
                if(profile.$activeCell && !xui.Dom.byId(profile.$activeCell))
                    delete profile.$activeCell;

                p.grpCols=box._adjustGrpColsData(profile,arr);
                box._adjustColsWidth(profile);
                box._adjustColsHeight(profile);
                box._adjustBody(profile,'delcol');
            }
            profile._dirty=1;
            return self;
        },
        removeAllRows:function(){
            var affectUI=arguments[0],
                profile=this.get(0),
                box=profile.box,
                prop=profile.properties;
            if(!prop.rows || prop.rows.length<00)
                return this;

            for(var i in profile.cellMap)
                profile.reclaimSubId(i.slice(3), 'cell');
            for(var i in profile.rowMap)
                profile.reclaimSubId(i.slice(3), 'row');

            //remove links
            xui.each(profile.colMap,function(o){
                o._cells={};
            });
            xui.breakO([profile.rowMap, profile.cellMap],3);

            profile.rowMap = {};
            profile.cellMap = {};
            profile.rowMap2 = {};

            // remove activerow/cell
            delete profile.$activeCell;
            delete profile.$activeRow;

            profile.properties.rows.length=0;
            if(profile.renderId){
                // ensure the column header scroll to zero
                // code must same to the SCROLL->onScroll event
                if(profile.$sl!=0)
                    profile.getSubNode('HEADER2').get(0).scrollLeft=profile.$sl=0;
                profile.getSubNodes(['SCROLL21','SCROLL22']).scrollTop(0).scrollLeft(0);
                profile.getSubNodes(['ROWS21','ROWS22']).empty();
            }
            //clear rows cache
            delete profile.$allrowscache1;
            delete profile.$allrowscache2;
            profile.properties.$UIvalue=null;

            if(affectUI!==false&&profile.renderId&&profile.__hastmpRow){
                box.__ensurehotrow(profile,null);
            }

            box._adjustBody(profile,'delrow');

            return this;
        },

        // reset all cells' value, and clear all dirty mark
        updateGridValue:function(){
            return this.each(function(profile){
                var prop=profile.properties;
                delete profile._dirty;
                xui.each(profile.rowMap,function(v){
                    v._oValue=v.value;
                    if('unit' in v)v._oUnit=v.unit;
                    delete v._dirty;
                });
                xui.each(profile.cellMap,function(v){
                    v._oValue=v.value;
                    if('unit' in v)v._oUnit=v.unit
                    delete v._dirty;
                });
                if(prop.dirtyMark && prop.showDirtyMark)
                    profile.getSubNode('CELLA',true).removeClass('xui-ui-dirty');
            })
        },
        updateRowValue:function(rowId){
            var profile=this.get(0),row=this.getRowbyRowId(rowId),arr=[],prop=profile.properties;
            // for cells
            xui.arr.each(row.cells,function(o){
                if(o._oValue!==o.value||(('unit' in o) && o._oUnit!==o.unit)){
                    o._oValue=o.value;
                    if('unit' in o)o._oUnit=o.unit
                    delete o._dirty;
                    if(prop.dirtyMark)
                        arr.push(profile.getSubNode('CELLA',o._serialId).get(0));
                }
            });
            // for row 
            row._oValue = row.value;
            delete row._dirty;
            if(prop.dirtyMark)
                arr.push(profile.getSubNode('CELLA',row._serialId).get(0));

            if(prop.dirtyMark && prop.showDirtyMark)
                xui(arr).removeClass('xui-ui-dirty');
        },
        updateColValue:function(colId){
            var profile=this.get(0),col=this.getHeaderByColId(colId),arr=[],prop=profile.properties;
            xui.arr.each(col.cells,function(o){
                if(o._oValue!==o.value||(('unit' in o) && o._oUnit!==o.unit)){
                    o._oValue=o.value;
                    if('unit' in o)o._oUnit=o.unit;
                    delete o._dirty;
                    if(prop.dirtyMark)
                        arr.push(profile.getSubNode('CELLA',o._serialId).get(0));
                }
            });
            if(prop.dirtyMark && prop.showDirtyMark)
                xui(arr).removeClass('xui-ui-dirty');
        },
        updateCellValue:function(cell){
            var ns=this, profile=ns.get(0), prop=profile.properties;
            if(typeof cell=='string')cell=ns.getCell(cell);
            if(cell._oValue!==cell.value||(('unit' in cell) && cell._oUnit!==cell.unit)){
                cell._oValue=cell.value;
                if('unit' in cell)cell._oUnit=cell.unit;
                delete cell._dirty;
                if(prop.dirtyMark)
                    profile.getSubNode('CELLA',cell._serialId).removeClass('xui-ui-dirty');
            }
            return ns;
        },
        //resetGridValue
        //resetRow
        //resetCol
        resetCellValue:function(cell){
            var ns=this, profile=ns.get(0), prop=profile.properties;
            if(typeof cell=='string')cell=ns.getCell(cell);
            if(cell._oValue!==cell.value||(('unit' in cell) && cell._oUnit!==cell.unit)){
                cell.value=cell._oValue;
                if('unit' in cell)cell.unit=cell._oUnit;
                delete cell._dirty;
                profile.box._renderCell(profile, cell, {}, profile.getSubNode('CELLA', cell._serialId));
            }
            return ns;
        },
        getActiveRow:function(type, splitMixColumn){
            var ar,profile=this.get(0);
            if(profile.properties.activeMode!='row')return;
            if(!(ar=profile.$activeRow))return;
            ar=profile.rowMap[profile.getSubId(ar)];
         //   if(ar && ar.id && ar.id==profile.box._temprowid){
         //       ar=null;
          //  }
            return profile.box._getRow(profile, ar, type, splitMixColumn);
        },
        setActiveRow:function(rowId){
            var dr, row, profile=this.get(0);
            if(profile.properties.activeMode!='row')return;
            // deative first
            profile.box._activeRow(profile, false);

            if(!(row=this.getRowbyRowId(rowId)))return;
            if(!(dr=profile.getSubNodes(['CELLS1','CELLS2'],row._serialId)).isEmpty()){
                profile.box._activeRow(profile, dr.get(0).id);
                dr.scrollIntoView();
            }
            return this;
        },
        getRowMap:function(rowId){
            var prf=this.get(0),ins=prf.boxing(),p=prf.properties,t,hash;
            if(xui.isHash(rowId))rowId=rowId.id;
            if(!xui.isSet(rowId)&&prf.renderId&&!prf.destroyed){
                if(p.activeMode="row"){
                    if(t=ins.getActiveRow())rowId=t.id;
                }else if(p.activeMode="cell"){
                    if(t=ins.getActiveCell())rowId=t._row.id;
                }
            }
            return ins.getRowbyRowId(rowId, "map");
        },
        setRowMap:function(rowId, hash, dirtyMark, triggerEvent){
            if(xui.isHash(rowId))rowId=rowId.id;
            return this.each(function(prf){
                var ins=prf.boxing(),p=prf.properties,t;
                if(!rowId&&prf.renderId&&!prf.destroyed){
                    if(p.activeMode="row"){
                        if(t=ins.getActiveRow())rowId=t.id;
                    }else if(p.activeMode="cell"){
                        if(t=ins.getActiveCell())rowId=t._row.id;
                    }
                }
                if(rowId){
                    var row=ins.getRowbyRowId(rowId),
                        header=ins.getHeader('min');
                    rowId=row.id;
                    // must adjust it first
                    var rows=prf.box._adjustRows(prf, [hash]),
                        cells=rows[0].cells;
                    xui.arr.each(row.cells,function(t,j){
                        xui.isDefined(cells[j] && cells[j].value) && ins.updateCellByRowCol(rowId, header[j], cells[j], dirtyMark, triggerEvent);
                    });
                }
                p.rowMap=hash;
            });
        },
        /*column and header related*/
        //type: 'original', 'data', 'min'
        getHeader:function(type){
            var v=this.get(0).properties.header;
            if(!xui.isArr(v))return [];
            if(type=='data')
                return xui.clone(v,true);
            else if(type=='min'){
                var a=xui.clone(v,true),b;
                xui.arr.each(a,function(o,i){
                    a[i]=o.id;
                });
                return a;
            }else
                return v;
        },
        getHeaderByColId:function(colId, type){
            var v=this.get(0).properties.header,i;
            if(xui.isNumb(colId))colId=xui.get(profile.properties.header,[colId,"id"]);
            i=xui.arr.subIndexOf(v,"id",colId);
            return i==-1?null:
                type=='data'?xui.clone(v[i],true):
                type=='min'?v[i].id:
                v[i];
        },
        getHeaderByCell:function(cell, type){
            var v=cell._col;
            return !v?null:
                type=='data'?xui.clone(v,true):
                type=='min'?v.id:
                v;
        },

        updateHeader:function(colId,options){
            var ns=this,
                profile=ns.get(0),
                prop=profile.properties,
                colh=ns.getHeaderByColId(colId), isGroup;
            if(!colh){
                var grpCols=prop.grpCols,
                    index=xui.arr.subIndexOf(grpCols,"id",colId);
                colh=grpCols[index];
                isGroup=true;
            }
            if(colh){
                if(typeof options!='object') options={caption:options+''};
                else xui.filter(options,true);
                delete options.id;

                if(profile.renderId){
                    var hid=colh._serialId, t, tt,nd;
                    if(!isGroup){
                        if(t=options.width){
                            t=profile.$px(t);
                            var n=[];
                            nd=ns.getSubNode('HCELL',hid).get(0);
                            if(nd)n.push(nd);
                            nd=ns.getSubNode('HSCELL',hid).get(0);
                            if(nd)n.push(nd);
                            xui.each(colh._cells,function(o){
                                n.push(ns.getSubNode('CELL',o).get(0));
                            });
                            profile.box._adjusteditorW(profile, xui(n).width(colh._colWidth=profile.$forceu(t)),t);

                            ns.getSubNode('SCROLL22').onScroll();
                            ns.constructor._adjustColsWidth(ns.get(0));
                            ns.constructor._adjustBody(ns.get(0),'setcol');
                        }

                        //  Forward-compatible with 'visibility'
                        if(options.hasOwnProperty('visibility') && !options.hasOwnProperty('hidden'))
                            options.hidden=!options.visibility;

                        if(options.hasOwnProperty('hidden')){
                            var  b = !!options.hidden;
                            if(b){
                                if(colh.hidden!==true){
                                    ns.showColumn(colId, false);
                                }
                            }else{
                                if(colh.hidden===true){
                                    ns.showColumn(colId, true);
                                }
                            }
                        }
                        if('type' in options){
                            delete colh.editorCacheKey;
                        }
                    }

                    if(t=options.headerStyle||options.colStyle)
                        (tt=ns.getSubNodes(['HCELLA','HSCELLA'],hid)).attr('style',tt.attr('style')+";"+t);
                    if(t=options.headerClass)
                        ns.getSubNodes(['HCELLA','HSCELLA'],hid).addClass(t);
                    if(options.hasOwnProperty('caption'))
                        ns.getSubNodes(['HCELLCAPTION','HSCELLCAPTION'],hid).get(0).innerHTML=options.caption;
                    if('colResizer' in options){
                        t=!!options.colResizer;
                        ns.getSubNode('HHANDLER',hid).css('display',(options.colResizer=t)?"block":'none');
                    }
                }

                xui.merge(colh, options, 'all');

                if('flexSize' in options)
                    profile.adjustSize();
            }
        },
        showColumn:function(colId, flag){
            var profile=this.get(0),
                map=profile.colMap2,
                    cols=profile.colMap,
                    col,
                    sid,
                    cells,
                    nd,
                    n=[];
                if(col=cols[sid=map[colId]]){
                if(profile.beforeColShowHide && false===profile.boxing().beforeColShowHide(profile,colId,flag))
                    return false;
                    nd=profile.getSubNode('HCELL',sid).get(0);
                    if(nd)n.push(nd);
                    nd=profile.getSubNode('HSCELL',sid).get(0);
                    if(nd)n.push(nd);
                    xui.each(col._cells,function(id){
                        n.push(profile.getSubNode('CELL',id).get(0));
                    });
                    xui(n).css('display',(col.hidden=(flag===false?true:false))?'none':'');

                if(profile.afterColShowHide)
                    profile.boxing().afterColShowHide(profile,colId,flag);
                }

                profile.box._adjustColsWidth(profile);
                profile.box._adjustBody(profile,'setcol');
            return true;
        },
        sortColumn:function(colId, desc, sortby){
            var prf=this.get(0), sId=prf.colMap2[colId],col=prf.colMap[sId];
            if(sId && col){
                if(xui.isBool(desc))
                    col._order=!desc;
                if(xui.isFun(sortby))
                    col.sortby=sortby;
                prf.getSubNode("HCELLA",sId).onClick();
            }
            return this;
        },
        /*cell realted*/
        getCell:function(cellId, type){
            var self=this,profile=this.get(0),v,m;
            xui.each(profile.cellMap,function(o){
                if(o.id && o.id===cellId){
                    cellId=o._serialId;
                    return false;
                }
            });
            v=profile.cellMap[cellId];
            return !v?null:
                    type=='data'? xui.merge({rowId:v._row.id, colId:v._col.id},xui.clone(v,true)):
                    type=='min'? v.value:
                    type=='map'?( (m={})&&((m[v._col.id]=v.value)||1)&&m):
                    v;
        },
        getCellbyRowCol:function(rowId, colId, type){
            var self=this,profile=self.get(0),v,m;
            if(xui.isNumb(rowId))rowId=xui.get(profile.properties.rows,[rowId,"id"]);
            if(xui.isNumb(colId))colId=xui.get(profile.properties.header,[colId,"id"]);
            v=xui.get(profile.rowMap,[profile.rowMap2[rowId], '_cells',colId]);
            v=v && profile.cellMap[v];
            if(!v){
                var row=self.getRowbyRowId(rowId),header=self.getHeader('min'),col;
                if(row&&row.cells){
                    col=xui.arr.indexOf(header,colId);
                    if(col!=-1)v=row.cells[col];
                }
            }
            return !v?null:
                type=='data'? xui.merge({rowId:rowId, colId:colId},xui.clone(v,true)):
                type=='min'? v.value:
                type=='map'?( (m={})&&((m[colId]=v.value)||1)&&m):
                v;
        },
        getCells:function(rowId, colId, type){
            var map={};
            xui.each(this.get(0).cellMap,function(v){
                if((rowId?(rowId==v._row.id):1) && (colId?(colId==v._col.id):1)){
                    map[v.id]= type=='data'?xui.merge({rowId:v._row.id, colId:v._col.id},xui.clone(v,true)):
                               type=='min' ? v.value:
                               v;
                }
            });
            //dont return inner value
            return map;
        },

        updateCellByRowCol:function(rowId, colId, options, dirtyMark, triggerEvent, triggerFormula){
            var t,self=this,con=self.constructor;
            if(t=con._getCellId(self.get(0), rowId, colId))
                con._updCell(self.get(0), t, options, dirtyMark, triggerEvent, triggerFormula);
            else{
                var row=self.getRowbyRowId(rowId),header=self.getHeader('min'),col;
                if(row&&row.cells){
                    col=xui.arr.indexOf(header,colId);
                    if(col!=-1){
                        if(!xui.isHash(row.cells[col]))row.cells[col]={value:row.cells[col]};
                        xui.merge(row.cells[col],options);
                    }
                }
            }
            return self;
        },
        getCellPos:function(cell, excelType){
            if(!cell || !cell._row || !cell._col)return null;
            var prf=this.get(0),
                col=xui.arr.indexOf(cell._row.cells,cell),
                row=xui.arr.indexOf(prf.properties.rows, cell._row);
            return col==-1||row==-1?null:excelType?xui.ExcelFormula.toCellId(col,row):{row:row,col:col};
        },
        // 0:2 => row:0, col:2
        // A3 => row:0, col:2
        updateCellByRowCol2:function(mixedId, options, dirtyMark, triggerEvent){
            var arr=mixedId.indexOf(":")!=-1?mixedId.split(":"):xui.ExcelFormula.toCoordinate("A3",true),
                row=parseInt(arr[0],10),
                col=parseInt(arr[1],10);
            return this.updateCellByRowCol(row,col,options,dirtyMark,triggerEvent);
        },
        updateCell:function(cellId, options, dirtyMark, triggerEvent, triggerFormula){
            var self=this,profile=this.get(0);
            xui.each(profile.cellMap,function(o){
                if(o.id && o.id===cellId){
                    cellId=o._serialId;
                    return false;
                }
            });
            self.constructor._updCell(profile,cellId,options, dirtyMark, triggerEvent, triggerFormula);
            return self;
        },
        editCellbyRowCol:function(rowId, colId){
            var profile=this.get(0),con=profile.box;
            con._editCell(profile, con._getCellId(profile, rowId, colId));
            return this;
        },
        editCell:function(cell/*default is the active cell*/){
            if(cell=cell?cell:this.get(0).getSubId(this.get(0).$activeCell+''))
                this.constructor._editCell(this.get(0), cell);
            return this;
        },
        // only support single line text input
        editFirstCell:function(rowId){
            var profile=this.get(0),
                getPro=function(key){return profile.box.getCellOption(profile, row, key)},
                row = typeof rowId=='string' ? (profile.rowMap[profile.rowMap2[rowId]]) : rowId,
                editor;

            if(!profile.properties.firstCellEditable || !row)return;
            if(getPro(profile, row, 'disabled')||getPro(profile, row, 'readonly'))return;
            if(!(profile && profile.renderId) || profile.destroyed)return;

            var cellNode = profile.getSubNode('FCELLCAPTION',row._serialId);
            if(!cellNode.isEmpty()){
                if(profile.beforeIniEditor){
                    editor=profile.boxing().beforeIniEditor(profile, row, cellNode, pp, 'row');
                    if(editor===false)
                        return;
                }

                var pp=cellNode.parent(),
                    size2 = pp.cssSize(),
                    baseNode = profile.getSubNode('BORDER'),
                    borderW=baseNode.contentBox()?2:0,
                    absPos = cellNode.offset(null, pp),
                    absPos2 = pp.offset(null, baseNode);
                // too small
                if(absPos2.left > size2.width - 8)return;

                // try to get from cache
                editor = profile.$cache_editor['firstCellEditor'];
                if(!editor || !editor['xui.UI'] || editor.isDestroyed()){
                    editor=new xui.UI.ComboInput({type:"input",zIndex:100});
                    profile.$cache_editor['firstCellEditor'] = editor;
                }
                editor.setWidth(size2.width - absPos.left + borderW)
                    .setHeight(size2.height + borderW)
                    .setValue(row.value||row.value||"");

                if(profile.onBeginEdit)profile.boxing().onBeginEdit(profile,row,editor, 'row');

                editor.undo=function(){
                    var editor=this, row=editor.get(0) && editor.get(0).$row;
                    // execute once
                    editor.undo=null;
                    // row dirty alert
                    if(profile.box){
                        if(row && row._oValue!==row.value && row.id !=profile.box._temprowid && profile.onRowDirtied)
                            profile.boxing().onRowDirtied(profile,row);
                    }
                    if(editor.get(0) && editor.get(0).box){
                        // for ie's setBlurTrigger doesn't trigger onchange event
                        editor.getSubNode('INPUT').onBlur(true);
                        editor.getRoot().setBlurTrigger("tg_editor_blur:"+profile.$xid);

                        if(profile.properties){
                            editor.beforeUnitUpdated(null).afterUIValueSet(null).beforeNextFocus(null).onCancel(null).onFileDlgOpen(null);
                            editor.setValue('',true,'editorreset');
                        }
                        delete editor.get(0).$row;
                        delete editor.get(0)._smartnav;
                        delete editor.get(0).$editMode;
                        //don't use disply:none, firfox has many bugs about Caret or renderer
                        editor.hide();
                    }
                    if(row)delete row._editor;
                    profile.$curEditor=null;
                    if(profile.onEndEdit)
                        profile.boxing().onEndEdit(profile, row, editor, 'row');

                    // don't cache it
                    if(editor.get(0)){
                        editor.destroy(true);
                    }

                    editor=null;
                };
                editor.afterUIValueSet(function(prf, ov, nv, force, tag){
                    var options={value:nv},t;
                    if(prf.properties.hasOwnProperty("tagVar") && !xui.isEmpty(t=prf.properties.tagVar))
                        options.tagVar=t;
                    if(false!==(profile.beforeEditApply&&profile.boxing().beforeEditApply(profile, row, options, editor, tag, 'row'))){
                        profile.boxing().updateRow(row.id, {value:nv, caption:nv+""});
                        xui.tryF(editor.undo,[],editor);
                    }
                })
                .beforeNextFocus(function(prop, e){
                    xui.tryF(editor.undo,[true],editor);
                    var hash=xui.Event.getEventPara(e);
                    if(hash.key=='enter')hash.$key='right';
                    profile.getSubNode('CELLA', row._serialId).onKeydown(true,hash);
                    //prevent
                    return false;
                })
                .onCancel(function(){
                    xui.tryF(editor.undo,[],editor);
                })

                baseNode.append(editor);

                //show editor
                editor.reBoxing().show((absPos.left + absPos2.left -1 )+'px',(absPos2.top - 1)+'px');

                var root=editor.getRoot();
                // For scroll to undo
                root.setBlurTrigger("tg_editor_blur:"+profile.$xid,function(){
                    xui.tryF(editor.undo,[],editor);
                    return false;
                }); 

                //give reference
                editor.get(0).$row = row;
                editor.get(0)._smartnav = true;
                row._editor=editor;
                profile.$curEditor=editor;

                editor.activate();
            }

            return this;
        },
        focusCellbyRowCol:function(rowId, colId){
            var profile=this.get(0),con=profile.box,
                cellId=con._getCellId(profile, rowId, colId),
                node=profile.getSubNode('CELLA', cellId);
            if(node && node.get(0))node.focus(true);
            return this;
        },
        focusCell:function(cell){
            var cellId=cell._serialId;
            this.get(0).getSubNode('CELLA', cellId).focus(true);
            return this;
        },
        getActiveCell:function(type){
            var ar,profile=this.get(0),m,v;
            if(profile.properties.activeMode!='cell')return;
            if(!(ar=profile.$activeCell))return;
            v=profile.cellMap[profile.getSubId(ar)];
            return !v?null:
                    type=='data'? xui.merge({rowId:v._row.id, colId:v._col.id},xui.clone(v,true)):
                    type=='min'? v.value:
                    type=='map'?( (m={})&&((m[v._col.id]=v.value)||1)&&m):
                    v;
        },
        setActiveCell:function(rowId, colId){
            var dr, cell, profile=this.get(0);
            if(profile.properties.activeMode!='cell')return;
            // deative first
            profile.box._activeCell(profile, false);

            if(typeof rowId=='object')
                cell=rowId;
            else
                cell=this.getCellbyRowCol(rowId, colId);

            if(!cell)
                return;

            if(!(dr=profile.getSubNode('CELL',cell._serialId)).isEmpty())
                profile.box._activeCell(profile, dr.get(0).id);
            return this;
        },

        /*others*/
        getDirtied:function(rowId, colId){
            var map={};
            xui.each(this.get(0).cellMap,function(v){
                if((v._oValue!==v.value||(('unit' in v)&&v._oUnit!==v.unit)) &&(rowId?(rowId==v._row.id):1) && (colId?(colId==v._col.id):1)){
                    map[v.id]={rowId:v._row.id, colId:v._col.id, value:v.value, _oValue:v._oValue};
                    if('unit' in v)map[v.id]._oUnit=v._oUnit;
                }
            });
            //dont return inner value
            return map;
        },
        getSubNodeInGrid:function(key, rowId, colId){
            var ns=this,
                t=  (xui.isSet(rowId) && xui.isSet(colId)) ? ns.getCellbyRowCol(rowId, colId) :
                    colId ? ns.getHeaderByColId(colId):
                    rowId ? ns.getRowbyRowId(rowId):null;
            return ns.getSubNode(key, (t&&t._serialId)||true);
        },
        getInlineEditors:function(rowId, colId){
            var map={};
            xui.each(this.getCells(rowId, colId), function(cell, id){
                map[id]=cell._editor;
            });
            return map;
        },
        getEditor:function(){
            return xui.get(this.get(0),["$curEditor"]);
        },
        updateEditor:function(value, caption, prop){
            var editor = this.getEditor();
            if(editor){
                if(xui.isHash(prop))editor.setProperties(prop, true);
                if(xui.isDefined(caption))editor.setCaption(caption, true);
                // last one
                if(xui.isDefined(value))editor.setUIValue(value, true);
            }
            return this;
        },
        getEditCell:function(){
            return xui.get(this.get(0),["$cellInEditor"]);
        },
        offEditor:function(refresh, ignoreInline){
            var profile=this.get(0),editor;
            if(!profile)return;
            if(editor = profile.$curEditor){
                xui.tryF(editor.undo,[],editor);
            }
            if(!ignoreInline)
                xui.each(profile.cellMap,function(cell){
                    if(editor = cell._editor){
                        editor.destroy();
                        delete cell._editor;
                    }
                });
                
            if(refresh){
                var getPro=profile.box.getCellOption;
                xui.each(profile.cellMap,function(o){
                       if(getPro(profile, o, "editable") && 
                           (getPro(profile, o, "editMode")=="inline" || getPro(profile, o, "type")=='dropbutton' ))
                            profile.box._editCell(profile,o,null,true);
                });
            }
        },
        adjustEditor:function(adjustFun){
            var ns=this,prf=this.get(0),borderW=this.getRoot().contentBox();
            if(prf && prf.$curEditor){
                var editor=prf.$curEditor,
                    cell=prf.$cellInEditor;
                if(typeof adjustFun=='function'){
                    adjustFun.apply(ns,[editor, cell]);
                }else if(editor.KEY=="xui.UI.ComboInput"){
                    var cellNode = prf.getSubNode('CELL', cell.id),
                        absPos=cellNode.offset(null, prf.getSubNode('SCROLL22')),
                        size = cellNode.cssSize();
                    editor.setLeft(absPos.left-1).setTop(absPos.top-1)
                    .setWidth(size.width+borderW+1).setHeight(size.height+borderW)
                    .reLayout(true);
                }
            }
            return ns;
        }
    },
    Before:function(key, parent_key, o){
        if(key=='xui.UI.TreeGrid'){
            this.Behaviors.CELLS1=this.Behaviors.CELLS2;
            this.Behaviors.GCELLA=this.Behaviors.CELLA;
        }
        return arguments.callee.upper.apply(this,arguments);
    },
    Initialize:function(){
        this.addTemplateKeys(['ALT','PROGRESS']);
        this.getCellPro = this.getCellOption;
       
        var p=this.prototype;

        p.getColumn=p.getHeader;
        p.updateColumn=p.updateHeader;

        p.getColByDom=p.getHeaderByDom;
        p.getColByColId=p.getHeaderByColId;
        p.getColByCell=p.getHeaderByCell;
    },
    Static:{
        DIRYMARKICON:"DIRTYMARK",
        Templates:{
            tagName : 'div',
            style:'{_style}',
            className:'{_className}',
            BORDER:{
                tagName : 'div',
                BOX:{
                    tagName:'table',
                    cellspacing:'0',
                    cellpadding:'0',
                    className:'xui-uibase',
                    TBODY:{
                        tagName:'tbody',
                        TRHEADER:{
                            tagName:'tr',
                            TDHEADER1:{
                                tagName:'td',
                                HEADER1:{
                                    tagName:'div',
                                    //className:'{_columnfreezed}',
                                    style:"{showHeader}",
                                    HI1:{
                                        tagName:'div',
                                        HCELLS1:{
                                            tagName:'div',
                                            style:'{headerHeight}',
                                            /*the first col (row handler) in table header*/
                                            FHCELL:{
                                                $order:0,
                                                style:'{rowHandlerDisplay};{_row0DfW};height:{_hcellheight};',
                                                className:'xui-uiborder-noradius xui-uibar xui-uiborder-outset {cellCls}',
                                                tabindex: '{_tabindex}',
                                                HCELLA:{
                                                    //for IE78
                                                    style:'{firstCellStyle};',
                                                    className:'xui-v-wrapper xui-showfocus {firstCellClass}',
                                                    HHANDLER:{
                                                        tagName:'div',
                                                        style:'{colDDDisplay}'
                                                    },
                                                    FHANDLER:{
                                                        tagName:'div',
                                                        style:'{rowDDDisplay}'
                                                    },
                                                    HFMARK:{
                                                        $order:1,
                                                        className:"xuifont",
                                                        $fonticon:"xui-uicmd-check",
                                                        style:'{_rowMarkDisplay}'
                                                    },
                                                    LTAGCMDS:{
                                                        $order:2,
                                                        tagName:'span',
                                                        className:'xui-ltag-cmds',
                                                        text:"{ltagCmds}"
                                                    },
                                                    GRIDCAPTION:{
                                                        $order:5,
                                                        text:'{gridHandlerCaption}'
                                                    },
                                                    SORT:{
                                                        className:'xuifont',
                                                        $fonticon:'xui-icon-sort',
                                                        style:'{sortDisplay}'
                                                    }
                                                }
                                            },
                                            OTHERHCELLS:{
                                                $order:1,
                                                tagName:'text',
                                                text:'{header1}'
                                            }
                                        },
                                        GRPCELLBOX1:{
                                            tagName:'div',
                                            style:'{headerHeight};',
                                            GRPCELLS:{
                                                $order: 3,
                                                tagName:'text',
                                                text:'{grpCols1}'
                                            }
                                        }
                                    }
                                }
                            },
                            TDHEADER2:{
                                tagName:'td',
                                HEADER2:{
                                    $order:0,
                                    tagName:'div',
                                    style:"{showHeader}",
                                    //for scroll performance
                                    HI2:{
                                        tagName:'div',
                                        HCELLS2:{
                                            tagName:'div',
                                            style:'{headerHeight};',
                                            OTHERHCELLS:{
                                                $order:1,
                                                tagName:'text',
                                                text:'{header2}'
                                            },
                                            LHCELL:{
                                                $order: 2,
                                                className:'xui-v-wrapper',
                                                LHCELLINNER:{
                                                    $order:1,
                                                    text:'{headerTail}'
                                                },
                                                RTAGCMDS:{
                                                    $order:1,
                                                    tagName:'span',
                                                    className:'xui-rtag-cmds',
                                                    text:"{rtagCmds}"
                                                }
                                            }
                                        },
                                        GRPCELLBOX2:{
                                            tagName:'div',
                                            style:'{headerHeight};',
                                            GRPCELLS:{
                                                $order: 3,
                                                tagName:'text',
                                                text:'{grpCols2}'
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        TRLOCKED1:{
                            tagName:'tr',
                            TDBODY11:{
                                tagName:'td',
                                SCROLL11:{
                                    $order:1,
                                    tagName:'div',
                                    className:'',
                                    BODY11:{
                                        tagName:'div',
                                        ROWS11:{
                                            $order:1,
                                            tagName:'div',
                                            text:'{rows11}'
                                        }
                                    }
                                }
                            },
                            TDBODY12:{
                                tagName:'td',
                                SCROLL12:{
                                    $order:1,
                                    tagName:'div',
                                    className:'{_rowfreezed}',
                                    BODY12:{
                                        tagName:'div',
                                        ROWS12:{
                                            $order:1,
                                            tagName:'div',
                                            text:'{rows12}'
                                        }
                                    }
                                }
                            }
                        },
                        TRBODY:{
                            tagName:'tr',
                            TDBODY21:{
                                tagName:'td',
                                SCROLL21:{
                                    $order:1,
                                    tagName:'div',
                                    className:'{_columnfreezed}',
                                    BODY21:{
                                        tagName:'div',
                                        ROWS21:{
                                            $order:1,
                                            tagName:'div',
                                            text:'{rows21}'
                                        }
                                    }
                                }
                            },
                            TDBODY22:{
                                tagName:'td',
                                SCROLL22:{
                                    $order:1,
                                    tagName:'div',
                                    BODY22:{
                                        tagName:'div',
                                        ROWS22:{
                                            $order:1,
                                            tagName:'div',
                                            text:'{rows22}'
                                        }
                                    }
                                }
                            }
                        },
                        TRTAIL:{
                            tagName:'tr',
                            TDTAIL1:{
                                tagName:'td'
                            },
                            TDTAIL2:{
                                tagName:'td'
                            }
                        }
                    }
                },
                COLLIST:{
                    tagName:'div',
                    COLLISTDROP:{
                        className:'xuifont xui-special-icon',
                        $fonticon:'xui-icon-triangle-down'
                    }
                },
                ARROW:{
                    className:'xuifont xui-special-icon',
                    $fonticon:'xui-icon-bigup',
                    text:'&nbsp;'
                }
            },
            DIRTYMARK:{},
            $submap : {
                /*the other header in table header*/
                header1:function(profile,template,v,tag,result,index){
                    if(index > profile.properties.freezedColumn)return;
                    profile.colMap[v._serialId]._region=1;
                    tag="header";
                    xui.UI.$doTemplate(profile,template,v,tag, result);
                    return tag;
                },
                header2:function(profile,template,v,tag,result,index){
                    if(index > profile.properties.freezedColumn){
                        profile.colMap[v._serialId]._region=2;
                        tag="header";
                        xui.UI.$doTemplate(profile,template,v,tag, result);
                        return tag;
                    }
                },
                header:{
                    HCELL:{
                        style:"width:{_cellWidth};height:{_hcellheight};{colDisplay};",
                        className:'xui-uiborder-noradius xui-uibar xui-uiborder-outset {cellCls}',
                        HCELLA:{
                            className:'xui-v-wrapper xui-showfocus {headerClass}',
                            style:"{headerStyle};{colStyle}",
                            tabindex: '{_tabindex}',
                            HCELLCAPTION:{
                                $order:5,
                                className:'xui-v-node',
                                text:"{caption}"
                            },
                            SORT:{
                                className:'xuifont',
                                $fonticon:'xui-icon-sort',
                                style:'{sortDisplay}'
                            },
                            HHANDLER : {
                                $order:2,
                                tagName:'div',
                                style:'{colDDDisplay}'
                            }
                        }
                    }
                },
                grpCols1:function(profile,template,v,tag,result,index){
                    var index=profile.properties.freezedColumn - 1,
                        map=profile.colMap;
                    if(v.from > index)return;
                    if(v['to'] > index){
                        map[v._serialId]._region=2;
                        map[v._serialId]._shadow=1;
                        tag="grpColsShadow";
                        xui.UI.$doTemplate(profile,template,v,tag, result);
                    }else{
                        map[v._serialId]._region=1;
                        tag="grpCols";
                        xui.UI.$doTemplate(profile,template,v,tag, result);
                    }
                    return tag;
                },
                grpCols2:function(profile,template,v,tag,result,index){
                    var index=profile.properties.freezedColumn - 1;
                    if(v['to'] > index){
                        profile.colMap[v._serialId]._region=2;
                        tag="grpCols";
                        xui.UI.$doTemplate(profile,template,v,tag, result);
                        return tag;
                    }
                },
                grpCols:{
                    HCELL:{
                        style:"position:absolute;width:{_cellWidth};height:{_hcellheight};top:{_hcelltop};left:{_hcellleft};",
                        className:'xui-uiborder-noradius xui-uibar xui-uiborder-outset {cellCls}',
                        HCELLA:{
                            className:'xui-v-wrapper xui-showfocus {headerClass}',
                            style:"{headerStyle};{colStyle}",
                            tabindex: '{_tabindex}',
                            HCELLCAPTION:{
                                $order:5,
                                className:"xui-v-node",
                                text:"{caption}"
                            },
                            HHANDLER : {
                                $order:2,
                                tagName:'div',
                                style:'{colDDDisplay}'
                            }
                        }
                    }
                },
                grpColsShadow:{
                    HSCELL:{
                        style:"position:absolute;width:{_cellWidth};height:{_hcellheight};top:{_hcelltop};left:{_hcellleft};",
                        className:'xui-uiborder-noradius xui-uibar xui-uiborder-outset {cellCls}',
                        HSCELLA:{
                            className:'xui-v-wrapper xui-showfocus {headerClass}',
                            style:"{headerStyle};{colStyle}",
                            tabindex: '{_tabindex}',
                            HSCELLCAPTION:{
                                className:"xui-v-node",
                                text:"{caption}"
                            }
                        }
                    }
                },
                grpCols:{
                    HCELL:{
                        style:"position:absolute;width:{_cellWidth};height:{_hcellheight};top:{_hcelltop};left:{_hcellleft};",
                        className:'xui-uiborder-noradius xui-uibar xui-uiborder-outset {cellCls}',
                        HCELLA:{
                            className:'xui-v-wrapper xui-showfocus {headerClass}',
                            style:"{headerStyle};{colStyle}",
                            tabindex: '{_tabindex}',
                            HCELLCAPTION:{
                                $order:5,
                                className:"xui-v-node",
                                text:"{caption}"
                            },
                            HHANDLER : {
                                $order:2,
                                tagName:'div',
                                style:'{colDDDisplay}'
                            }
                        }
                    }
                },
                rows11:function(profile,template,v,tag,result,index){
                    if(profile._passFreezedRow)return false;
                    if(index > profile.properties.freezedRow)return false;
                    profile.rowMap[v._serialId]._region=1;
                    // keep realtag for real data
                    xui.UI.$doTemplate(profile,template,v, "row1", result, index,'rows1');
                },
                rows12:function(profile,template,v,tag,result,index){
                    if(profile._passFreezedRow)return false;
                    if(index > profile.properties.freezedRow)return false;
                    profile.rowMap[v._serialId]._region=1;
                    // keep realtag for real data
                    xui.UI.$doTemplate(profile,template,v, "row2", result, index,'rows2');
                },
                rows21:function(profile,template,v,tag,result,index){
                    if(!profile._passFreezedRow && index <= profile.properties.freezedRow)return;
                    profile.rowMap[v._serialId]._region=2;
                    // keep realtag for real data
                    xui.UI.$doTemplate(profile,template,v, "row1", result, index,'rows1');
                },
                rows22:function(profile,template,v,tag,result,index){
                    if(!profile._passFreezedRow && index <= profile.properties.freezedRow)return;
                    // *** dont calculate freeeze rows again
                    profile._passFreezedRow=1;
                    profile.rowMap[v._serialId]._region=2;
                    // keep realtag for real data
                    xui.UI.$doTemplate(profile,template,v, "row2", result, index,'rows2');
                },
                row1:{
                    ROW1:{
                        tagName:'div',
                        style:'{rowDisplay}',
                        CELLS1:{
                            $order:2,
                            tagName:'div',
                            className:'xui-uirowbg xui-uiborder-b xui-uiborder-light {rowCls} {rowClass}',
                            style:'{_rowHeight};{rowStyle}',
                            CELLHANDLER:{
                                tagName:'text',
                                text:'{_handler_cell}'
                            },
                            GRPCELL2:{
                                tagName:'text',
                                text:'{_firstcell_grp}'
                            },
                            OTHERCELLS:{
                                tagName:'text',
                                $order: 2,
                                text:'{cells}'
                            }
                        },
                        SUB1:{
                            $order:3,
                            tagName:'div'
                        }
                    }
                },
                row2:{
                    ROW2:{
                        tagName:'div',
                        style:'{rowDisplay}',
                        CELLS2:{
                            $order:2,
                            tagName:'div',
                            className:'xui-uirowbg xui-uiborder-b xui-uiborder-light {rowCls} {rowClass}',
                            style:'{_rowHeight};{rowStyle}',
                            GRPCELL2:{
                                tagName:'text',
                                text:'{_firstcell_grp}'
                            },
                            OTHERCELLS:{
                                tagName:'text',
                                $order: 2,
                                text:'{cells}'
                            },
                            LCELL:{
                                $order: 3,
                                className:'xui-v-wrapper',
                                LCELLINNER:{
                                    $order:1,
                                    text:'{rowTail}'
                                },
                                RTAGCMDS:{
                                    $order:2,
                                    tagName:'span',
                                    className:'xui-rtag-cmds',
                                    text:"{rtagCmds}"
                                }
                            }
                        },
                        SUB2:{
                            $order:3,
                            tagName:'div'
                        }
                    }
                },
                'rows1._handler_cell':function(profile,template,v,tag,result,index){
                    xui.UI.$doTemplate(profile,template,v, profile.properties.treeMode=="infirstcell" ?"rows1._handler_cell2" : "rows1._handler_cell1", result);
                },
                'rows1._handler_cell1':{
                    FCELL:{
                        $order:0,
                        style:'{rowHandlerDisplay};{_row0DfW};',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            tabindex: '{_tabindex}',
                            style:'{cellStyle}{firstCellStyle}',
                            className:'xui-v-wrapper xui-showfocus {cellClass}{firstCellClass}',
                           MARK:{
                                $order:1,                                
                                className:'xuifont',
                                $fonticon:'xui-uicmd-check',
                                style:'{_rowMarkDisplay}'
                            },
                            ROWLRULER:{
                                $order:2,
                                style:'{_treeMode};{_rulerW}'
                            },
                             ROWNUM:{
                                $order:3,
                                className:'xui-ui-readonly',
                                style:'{_rowNumbDisplay}'
                            },
                            ROWTOGGLE:{
                                $order:4,
                                style:'{_treeMode};',
                                className:'xuifont',
                                $fonticon:'{_fi_togglemark}'
                            },
                            LTAGCMDS:{
                                $order:1,
                                tagName:'span',
                                className:'xui-ltag-cmds',
                                style:'{_ltagDisplay}',
                                text:"{ltagCmds}"
                            },
                            FCELLCAPTION:{
                                $order:5,
                                className:"xui-v-node",
                                text:"{caption}"
                            },
                            FHANDLER:{
                                $order:0,
                                tagName:'div',
                                style:'{rowDDDisplay}'
                            }
                        }
                    } 
                },
                'rows1._handler_cell2':{
                    FCELL:{
                        $order:0,
                        style:'{rowHandlerDisplay};{_row0DfW};',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            tabindex: '{_tabindex}',
                            style:'{cellStyle}{firstCellStyle}',
                            className:'xui-v-wrapper xui-showfocus {cellClass}{firstCellClass}',
                            FHANDLER:{
                                $order:6,
                                tagName:'div',
                                style:'{rowDDDisplay}'
                            }
                        }
                    } 
                },
                'rows1._firstcell_grp':function(profile,template,v,tag,result,index){
                    if(profile.properties.treeMode!="infirstcell")return;
                    if(!profile.properties.freezedColumn)return;
                    xui.UI.$doTemplate(profile,template,v,  "rows._firstcell_grp", result);
                },
                'rows2._firstcell_grp':function(profile,template,v,tag,result,index){
                    if(profile.properties.treeMode!="infirstcell")return;
                    if(profile.properties.freezedColumn)return;
                    xui.UI.$doTemplate(profile,template,v,  "rows._firstcell_grp", result);
                },
                'rows._firstcell_grp':{
                    GCELL:{
                        $order:0,
                        className:'{cellCls}',
                        GCELLA:{
                            tabindex: '{_tabindex}',
                            style:'{cellStyle}{firstCellStyle}',
                            className:'xui-v-wrapper xui-showfocus {cellClass}{firstCellClass}',
                           MARK:{
                                $order:1,
                                $customId:1,
                                className:'xuifont',
                                $fonticon:'xui-uicmd-check',
                                style:'{_rowMarkDisplay}'
                            },
                            ROWLRULER:{
                                $order:2,
                                $customId:1,
                                style:'{_treeMode};{_rulerW}'
                            },
                            ROWNUM:{
                                $order:3,
                                $customId:1,
                                 className:'xui-ui-readonly',
                                style:'{_rowNumbDisplay}'
                            },
                            ROWTOGGLE:{
                                $order:4,
                                $customId:1,
                                style:'{_treeMode};',
                                className:'xuifont',
                                $fonticon:'{_fi_togglemark}'
                            },
                            LTAGCMDS:{
                                $order:1,
                                $customId:1,
                                tagName:'span',
                                style:'{_ltagDisplay}',
                                text:"{ltagCmds}"
                            },
                            FCELLCAPTION:{
                                $order:5,
                                $customId:1,
                                className:"xui-v-node",
                                text:"{caption}"
                            }
                        }
                    } 
                },
                'rows1.cells':function(profile,template,v,tag,result,index){
                    if(index > profile.properties.freezedColumn)return;
                    tag = 'rows.cells';

                    var t = profile.box._tplMap2[v.type] || '.input';
                    if(profile.properties.treeMode=='infirstcell' && index==1 && t=='.input'){
                        t='._first_cell';
                    }
                    xui.UI.$doTemplate(profile,template,v,tag + t, result);

                    return tag;
                },
                'rows2.cells':function(profile,template,v,tag,result,index){
                    if(index <= profile.properties.freezedColumn)return;
                    tag = 'rows.cells';

                    var t = profile.box._tplMap2[v.type] || '.input';
                    if(profile.properties.treeMode=='infirstcell' && index==1 && t=='.input'){
                        t='._first_cell';
                    }
                    xui.UI.$doTemplate(profile,template,v,tag + t, result);

                    return tag;
                },
                'rows.cells._first_cell':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay};',
                        className:'xui-uiborder-r xui-uiborder-light xui-treegrid-fcell {cellCls}',
                        CELLA:{
                            className:'xui-v-wrapper xui-showfocus {cellClass}',
                            style:'{bgcolor};{cellStyle}',
                            tabindex: '{_tabindex}',
                           MARK:{
                                $order:1,
                                $customId:1,
                                className:'xuifont',
                                $fonticon:'xui-uicmd-check',
                                style:'{_rowMarkDisplay}'
                            },
                            ROWLRULER:{
                                $order:2,
                                $customId:1,
                                style:'{_treeMode};{_rulerW}'
                            },
                            ROWNUM:{
                                $order:3,
                                $customId:1,
                                 className:'xui-ui-readonly',
                                style:'{_rowNumbDisplay}'
                            },
                            ROWTOGGLE:{
                                $order:4,
                                $customId:1,
                                style:'{_treeMode};',
                                className:'xuifont',
                                $fonticon:'{_fi_togglemark}'
                            },
                            LTAGCMDS:{
                                $order:1,
                                $customId:1,
                                tagName:'span',
                                style:'{_ltagDisplay}',
                                text:"{ltagCmds}"
                            },
                            CELLCAPTION:{
                                $order:5,
                                style:'{color}',
                                className:'xui-v-node xui-treegrid-fcellcaption',
                                text:"{_caption}"
                            }
                        }
                    }
                },
                'rows.cells.input':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay};',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            className:'xui-v-wrapper xui-showfocus {cellClass}',
                            style:'{bgcolor};{cellStyle}',
                            tabindex: '{_tabindex}',
                            CELLCAPTION:{
                                className:'xui-v-node',
                                style:'{color}',
                                text:"{_caption}"
                            }
                        }
                    }
                },
                'rows.cells.textarea':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay};',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            className:'xui-v-wrapper xui-showfocus xui-cls-wordwrap {cellClass}',
                            style:'{bgcolor};{cellStyle}',
                            tabindex: '{_tabindex}',
                            CELLCAPTION:{
                                className:'xui-v-node',
                                style:'{color}',
                                text:"{_caption}"
                            }
                        }
                    }
                },
                'rows.cells.button':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay};',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            tagName:'button',
                            className:'xui-node xui-showfocus xui-wrapper xui-ui-btn xui-uibar xui-uigradient xui-uiborder-radius xui-treegrid-tgbtn {cellClass}',
                            style:'{cellStyle}',
                            tabindex: '{_tabindex}',
                            CELLCAPTION:{
                                className:'xui-v-node',
                                text:"{_caption}"
                            }
                        }
                    }
                },
                'rows.cells.checkbox':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay}',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            className:'xui-v-wrapper xui-showfocus {cellClass}',
                            style:'{cellStyle}',
                            tabindex: '{_tabindex}',
                            CHECKBOX:{
                                className:'xuifont xui-uicmd-check',
                                $fonticon:'{_fi_checkboxCls}'
                            }
                        }
                    }
                },
                'rows.cells.progress':{
                    CELL:{
                        style:'width:{_cellWidth};{cellDisplay}',
                        className:'xui-uiborder-r xui-uiborder-light {cellCls}',
                        CELLA:{
                            className:'xui-showfocus {cellClass}',
                            style:'{cellStyle}',
                            tabindex: '{_tabindex}',
                            PROGRESS:{
                                $order:2,
                                tagName:'div',
                                className:'xui-v-wrapper xui-uibar',
                                style:'width:{progress};',
                                CELLCAPTION:{
                                    className:'xui-v-node',
                                    text:"{_caption}"
                                }
                            }
                        }
                    }
                },
                'rows1._handler_cell1.ltagCmds':function(profile,template,v,tag,result){
                    if(v.id==profile.box._temprowid)return;
                    xui.UI.$doTemplate(profile,template,v,'rows.tagCmds'+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'rows._firstcell_grp.ltagCmds':function(profile,template,v,tag,result){
                    xui.UI.$doTemplate(profile,template,v,'rows.tagCmds'+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'rows.cells._first_cell.ltagCmds':function(profile,template,v,tag,result){
                    xui.UI.$doTemplate(profile,template,v,'rows.tagCmds'+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'rows2.rtagCmds':function(profile,template,v,tag,result){
                    xui.UI.$doTemplate(profile,template,v,'rows.tagCmds'+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'ltagCmds':function(profile,template,v,tag,result){
                    xui.UI.$doTemplate(profile,template,v,"rows.tagCmds"+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'rtagCmds':function(profile,template,v,tag,result){
                    xui.UI.$doTemplate(profile,template,v,"rows.tagCmds"+(profile.box._tplMap[v.type]||'.button'),result)
                },
                'rows.tagCmds.text':xui.UI.$getTagCmdsTpl('text'),
                'rows.tagCmds.button':xui.UI.$getTagCmdsTpl('button'),
                'rows.tagCmds.image':xui.UI.$getTagCmdsTpl('image')
            }
        },
        Appearances:{
            KEY:{
                //in firefox, a can focused with display:block
                display:'block',
                position:'absolute',
                overflow:'hidden'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            'HFMARK, MARK':{
                'margin-left':'.5em'
            },
            DIRTYMARK:{
                position:'absolute',
                width:"1em",
                height:"1em",
                left: "1px",
                top: "1px",
                "z-index":10
            },
            BOX:{
                'border-collapse':'collapse',
                 height: '100%',
                 width: '100%'
            },
            'HEADER1, HEADER2':{
                'background-color':'#EDEDED',
                position:'relative',
                overflow:'hidden',
                'text-align':'left'
            },
            'HI1, HI2':{
                position:'relative'
            },
            'GRPCELLBOX1, GRPCELLBOX2':{
                position:'absolute',
                overflow:'visible',
                left:0,
                top:0,
                width:0,
                height:0
            },
            'SCROLL11, SCROLL12, SCROLL21, SCROLL22':{
                position:'relative',
                'text-align':'left'
            },
            'SCROLL11, SCROLL12, SCROLL21':{
                overflow:'hidden'
            },
            SCROLL22:{
                overflow:'auto'
            },
            ARROW:{
                position:'absolute',
                'z-index':'20',
                left:0,
                top:0,
                display:'none',
                width:'auto',
                height:'auto',
                'font-weight': 'bold',
                'text-align': 'center',
                'font-size': '2em'
            },
            'ARROW:before':{
                'margin-left':'-50%'
            },
            COLLIST:{
                position:'absolute',
                'z-index':'10',
                left:0,
                top:0,
                cursor:'pointer',
                visibility:'hidden'
            },
            COLLISTDROP:{
                position:'absolute',
                left:0,
                bottom:0,
                cursor:'pointer'
            },
            'BODY11, BODY12, BODY21, BODY22':{
                overflow:'visible',
                position:'absolute',
                left:0,
                top:0
            },
            SORT:{
                position:'absolute',
                right:'.25em',
                bottom:'.25em'
            },
            HHANDLER:{
                position:'absolute',
                //if set z-index, disappearing in opera
                //'z-index':'10',
                background: xui.browser.ie?'url('+xui.ini.img_bg+')':null,
                width:'.5em',
                top:'0',
                right:'0',
                height:'100%',
                cursor:'e-resize'
            },
            'HCELLS1, HCELLS2, CELLS1, CELLS2':{
                //for ie height change trigger
                'overflow-y': xui.browser.ie ?'hidden':'',
                position:'relative',
                background:'transparent',
                'white-space': 'nowrap' 
            },
            'HCELLS1, HCELLS2, GRPCELLBOX1, GRPCELLBOX2':{
                overflow:'visible'
            },
            'CELLS1, CELLS2':{
                overflow:'visible'
            },
            'CELLS1-group FCELL, CELLS2-group FCELL':{
                'border-right':0,
                'padding-right':'1px',
                overflow:'visible'
            },
            'CELLS1-group FCELLCAPTION, CELLS1-group CELLA,  CELLS1-group GCELLA, CELLS1-group ROWNUM, CELLS2-group FCELLCAPTION, CELLS2-group CELLA, CELLS2-group GCELLA':{
                'font-weight':'bold',
                overflow:'visible'
            },
            'CELLS1-active, CELLS2-active, CELL-active, CELL-active CELLA':{
                 $order:5,
                 'background-color':'#DDDDDD'
            },
            "CELLS1-hot, CELLS2-hot":{
                $order:6,
                'background-color':'#FFE97F'
            },
            // hot always use CELLS2
            "CELLS2-hot LTAGCMDS, CELLS2-hot RTAGCMDS":{
                $order:6,
                'display':'none'
            },
            'CELLS1-checked, CELLS2-checked, CELLS1-checked .xui-node, CELLS2-checked .xui-node, CELL-checked, CELL-checked .xui-node':{
                 $order:6,
                'background-color':'#ABABAB',
                color:'#fff'
            },
            "FCELL CELLA, GCELL GCELLA":{
                'text-align': 'left'
            },
            "FHCELL HCELLA, HSCELLA":{
                'text-align': 'center'
            },
            'CELLCAPTION,HCELLCAPTION,HSCELLCAPTION,SORT,HHANDLER':{
                'vertical-align':'middle'
            },
            'CELLCAPTION,HCELLCAPTION,HSCELLCAPTION,FCELLCAPTION,GRIDCAPTION':{
                "max-width": "100%",
                "text-overflow": "ellipsis",
                "white-space": "nowrap",
                "overflow": "hidden",
                'font-size':'1em'
            },
            // for "text-overflow": "ellipsis",
            'FCELL FCELLCAPTION, FHCELL GRIDCAPTION':{
                display:"inline"
            },
            'CELL-textarea CELLCAPTION':{
                $order:10,
                 "white-space": "normal"
            },
            FHANDLER:{
                position:'absolute',
                'height':'.5em',
                left:'0',
                width:'100%',
                bottom:'0',
                cursor:'n-resize',
                'z-index':10
            },
            'FCELLCAPTION, ROWNUM':{
                'vertical-align':'middle',
                overflow:'hidden'
            },
            'FHCELL, HCELL, HSCELL':{
               padding:0,
               'vertical-align':'bottom'
            },
            'ROW1, ROW2':{
                position:'relative',
                zoom:xui.browser.ie?1:null,
                width:xui.browser.ie?'100%':null
            },
            ROWNUM:{
                'padding-right':'.5em'
            },
            'FCELL, CELL':{
                height:'100%',
                //firefox:height:100% without overflow:hidden
                'padding-left':'1px',
                position:'relative',
                overflow:xui.browser.ie6?'hidden':'',
                'vertical-align':'top',
                display:xui.$inlineBlock
            },
            'GCELL':{
                height:'100%',
                width:'100%',
                //firefox:height:100% without overflow:hidden
                'padding-left':'1px',
                position:'relative',
                overflow:xui.browser.ie6?'hidden':'',
                'vertical-align':'top',
                display:xui.$inlineBlock
            },
            "LHCELL, LCELL":{
                height:'100%',
                position:'relative',
                'vertical-align':'top'
            },
            'CELLS1-alt, CELLS2-alt':{
                $order:1,
                'background-color':'#EFF8FF'
            },
            //
            'CELL-input':{
            },
            'CELL-number, CELL-spin, CELL-currency':{
                'text-align':'right'
            },
            'CELL-counter':{
                'text-align':'center'
            },
            'CELL-checkbox':{
                'text-align':'center'
            },
            'KEY-tgbtn':{
                $order:100,
                width:'100%',
                padding: 0,
                'vertical-align': 'text-bottom',
                'line-height':'100%',
                height:'100%'
            },
           'CELLS1-hover, CELLS2-hover':{
                $order:4,
                'background-color':'#F6F6F6'
            },
            'CELL-hover, CELL-hover .xui-node[class*="xui-treegrid-"]':{
                $order:5,
                'background-color':'#C5C5C5 !important'
            },
            'FCELL CELLA, GCELL GCELLA, HCELLA, HSCELLA':{
                position:'relative',
                "text-overflow": "ellipsis"
            },
            'HCELLA, HSCELLA':{
                $order:3,
                'text-align': 'center',
                'vertical-align':'middle',
                'line-height':'inherit'
            },
            'HCELLA, HSCELLA, CELLA, GCELLA':{
                display:'block',
                overflow:'hidden',
                '-moz-box-flex':'1',
                'outline-offset':'-1px',
                '-moz-outline-offset':(xui.browser.gek && xui.browser.ver<3)?'-1px !important':null,
                height:'100%',
                //ie need this
                width:xui.browser.ie?'100%':'',
                // depends on parent
                'line-height':'inherit'
            },
            'CELLA-inline':{
                $order:5,
                display:xui.$inlineBlock,
                width:'auto',
                '-moz-box-flex':0
            },
            PROGRESS:{
                border:'none',
                height:'100%',
                'line-height':'1.83333em',
                overflow:'visible',
                opacity:0.7,
                '*filter':'alpha(opacity=70)'
            },
            'PROGRESS CELLCAPTION':{
                overflow:'visible'
            },
            'CHECKBOX, MARK':{
               cursor:'pointer',
               'vertical-align':'middle'
            },
            'SUB1, SUM22':{
                //for ie bug: relative , height='auto' will disppear
                zoom:xui.browser.ie?1:null,
                height:0,
                position:'relative',
                overflow:'visible'
            },
            ROWTOGGLE:{
                padding:'0 .334em 0 0'
            }
        },
        _objectProp:{rowOptions:1,colOptions:1},
        Behaviors:{
            //don't add cell in HoverEffected, for 'hover' editMode
            HoverEffected:{ROWTOGGLE:'ROWTOGGLE', GCELL:'GCELL', CELL:'CELL', HCELL:['HCELL','HSCELL'],HSCELL:['HCELL','HSCELL'], FHCELL:'FHCELL',FCELL:'FHCELL',CMD:'CMD',SCROLL22:"SCROLL22",BODY11:"BODY11",BODY12:"BODY12",BODY21:"BODY22",BODY11:"BODY22",HEADER1:"HEADER1",HEADER2:"HEADER2"},
            ClickEffected:  {ROWTOGGLE:'ROWTOGGLE', GCELL:'GCELL', CELL:'CELL', HCELL:['HCELL','HSCELL'],HSCELL:['HCELL','HSCELL'], CMD:'CMD'},
            DraggableKeys:['FCELL'],
            DroppableKeys:['SCROLL21','SCROLL22','CELLS1','CELLS2','FCELL'],

            onSize:xui.UI.$onSize,
            HFMARK:{
                onClick:function(profile,e,src){
                    if(profile.properties.selMode!='multi'&&profile.properties.selMode!='multibycheckbox')return;

                    var rows=[];
                    xui.each(profile.rowMap,function(o){
                        rows.push(o.id);
                    });

                    if(profile._$checkAll){
                        delete profile._$checkAll;
                        profile.boxing().setUIValue("",null,null,'checkbox');
                        xui.use(src).tagClass('-checked',false)
                        profile.boxing().onRowSelected(profile, "allrows", e, src, -1);
                    }else{
                        profile._$checkAll=true;
                        xui.use(src).tagClass('-checked')
                        profile.boxing().setUIValue(rows.join(profile.properties.valueSeparator),null,null,'click');
                        profile.boxing().onRowSelected(profile, "allrows", e, src, 1);
                    }
                    return false;
                }
            },
            TRLOCKED1:{
                onMouseover:function(profile, e, src){
                    profile.box.$cancelHoverEditor(profile);
                }
            },
            TRTAIL:{
                onMouseover:function(profile, e, src){
                    profile.box.$cancelHoverEditor(profile);
                }
            },
            TDBODY21:{
                onMouseover:function(profile, e, src){
                    profile.box.$cancelHoverEditor(profile);
                }
            },
            TRHEADER:{
                onMouseover:function(profile, e, src){
                    profile.box.$cancelHoverEditor(profile);
                }
            },
            SCROLL22:{
                onScroll:function(profile, e, src){
                    var node=xui.use(src).get(0),
                        l=node.scrollLeft||0,
                        t=node.scrollTop||0;
                    if(profile.$sl!=l){
                        profile.getSubNodes(['HEADER2','SCROLL12']).scrollLeft(profile.$sl=l);
                    }
                    if(profile.$st!=t){
                        profile.getSubNode('SCROLL21').get(0).scrollTop=profile.$st=t;
                        //for IE11's scrollbar bug
                        if((t=profile.getSubNode('SCROLL21').get(0).scrollTop) && t!=profile.$st){
                            node.scrollTop=profile.$st=t;
                        }                    
                    }
                }
            },
            SCROLL21:{
                onScroll:function(profile, e, src){
                    var node=xui.use(src).get(0),
                        t=node.scrollTop||0;
                    if(profile.$st!=t)
                        profile.getSubNode('SCROLL22').get(0).scrollTop=profile.$st=t;
                }
            },
            HEADER2:{
                onScroll:function(profile, e, src){
                    var node=xui.use(src).get(0),
                        l=node.scrollLeft||0;
                    if(profile.$sl!=l)
                        profile.getSubNodes(['SCROLL12','SCROLL22']).scrollLeft(profile.$sl=l);
                }
            },
            SCROLL12:{
                onScroll:function(profile, e, src){
                    var node=xui.use(src).get(0),
                        l=node.scrollLeft||0;
                    if(profile.$sl!=l)
                        profile.getSubNodes(['HEADER2','SCROLL22']).scrollLeft(profile.$sl=l);
                }
            },
            //colomn resizer
            HHANDLER:{
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    var p=profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id],o;
                    if(col && col._isgroup){
                        o=profile.getSubNode("HHANDLER",profile.properties.header[col["to"]]._serialId);
                    }else{
                        o=xui(src);
                    }
                    var minW =o.parent(2).width()-profile.$px(p._minColW),
                    scroll = profile.getSubNode('SCROLL22'),
                    maxW = scroll.offset().left + scroll.width() - xui.Event.getPos(e).left - 4;

                    if(p.disabled)return false;
                    if(col && col.disabled)return false;

                    o.startDrag(e, {
                        horizontalOnly:true,
                        dragType:'blank',
                        dragDefer:2,
                        maxLeftOffset:minW,
                        maxRightOffset:maxW,
                        targetReposition:false
                    });
                    xui.use(src).parent(2).onMouseout(true,{$force:true}).onMouseup(true);
                },
                onDragbegin:function(profile, e, src){
                    xui.DragDrop.getProfile().proxyNode
                    .css({
                        height:profile.getRoot().height()+'px',
                        width:'4px',
                        backgroundColor:'#DDDDDD',
                        cursor:'e-resize'
                    });
                },
                onDrag:function(profile, e, src){
                    var d=xui.DragDrop,p=d.getProfile(),b=0;
                    if(p.x<=p.restrictedLeft || p.x>=p.restrictedRight)b=true;
                    if(b){
                        if(!profile._limited){
                            p.proxyNode.css('backgroundColor','#ff6600');
                            profile._limited=true;
                        }
                    }else{
                        if(profile._limited){
                            p.proxyNode.css('backgroundColor','#DDDDDD');
                            profile._limited=0;
                        }
                    }
                },
                onDragstop:function(profile, e, src){
                    var p=profile.properties,
                        o=xui(src).parent(2),
                        ks=profile.keys,
                        col=profile.colMap[profile.getSubId(src)],
                        oldw=o.width(),
                        w=oldw + xui.DragDrop.getProfile().offset.x,
                        emw;
                    if(col){
                        if(col&&col._isgroup){
                            col=profile.properties.header[col['to']];
                            o=profile.getSubNode("HCELL",col._serialId);
                        }
                        if(col.hasOwnProperty('maxWidth'))w=Math.min(profile.$px(col.maxWidth),w);
                        if(col.hasOwnProperty('minWidth'))w=Math.max(profile.$px(col.minWidth),w);
                    }

                    if(profile.beforeColResized && false===profile.boxing().beforeColResized(profile,col?col.id:null,w)){
                        profile._limited=0;
                        return;
                    }
                    emw = profile.$forceu(w);
                    o.width(emw);
                    if(col){
                        if(col.flexSize){
                            var emw = parseFloat(col.width),
                                percent = w / profile._relAvailable,
                                oldPercent = oldw / profile._relAvailable;
                            col.width =  (emw / oldPercent - emw)  * percent / (1 -percent) + profile.$picku(col.width);
                        }else{
                            col.width=emw;
                        }
                        col._colWidth=emw;
                    }

                    //collect cell id
                    var ids=[],ws=[];
                    if(profile.getKey(xui.use(src).parent(2).id())==ks.FHCELL){
                        profile.box._setRowHanderW(profile,w);
                    }else{
                        var cells = col._cells,t;
                        xui.each(cells,function(o){
                            if(!(t=profile.getSubNode(ks.CELL, o)).isEmpty()) ids.push(t.id());
                        });
                        profile.box._adjusteditorW(profile, xui(ids).width(emw), w);
                    }

                    if(profile.afterColResized)
                        profile.boxing().afterColResized(profile,col?col.id:null,w);

                    profile.getSubNode('SCROLL22').onScroll();
                    profile.box._adjustColsWidth(profile);
                    profile.box._adjustBody(profile,'setcol');
                    profile._limited=0;
                },
                onClick:function(){
                    return false
                },
                onDblclick:function(profile, e, src){
                    var p = profile.properties,
                        o = xui.use(src).parent(2),
                        id = profile.getSubId(src)
                        col = profile.colMap[id];

                    if(col&&col._isgroup){
                        col=profile.properties.header[col['to']];
                        o=profile.getSubNode("HCELL",col._serialId);
                    }

                    if(col && col.flexSize)return;
                    if(profile.getRootNode().clientHeight<=0)return;

                    //for row0
                    if(profile.getKey(xui.use(src).parent(2).id())==profile.keys.FHCELL){
                        profile.box._setRowHanderW(profile,true);
                        return;
                    }

                    //for other rows
                    var cells=col._cells,
                        cls=profile.getClass('CELLA','-inline'),
                        n,nodes=[],ws=[],w,emw;
                    xui.each(cells,function(o){
                        n=profile.getSubNode('CELLA',o);
                        if(n._nodes.length){
                            nodes.push(n.get(0));
                            ws.push(n.addClass(cls).width());
                        }
                    });
                    // for group in the first column
                    if(p.treeMode=='infirstcell' && p.header[0]==col){
                        profile.getSubNode("GCELLA",true).each(function(o){
                            ws.push(xui(o).addClass(cls).width());
                            xui(o).removeClass(cls);
                        });
                    }

                    ws.push(profile.$px(p._minColW));
                    w=parseFloat(Math.max.apply(null,ws));
                    if(w>profile.$px(p._maxColW))w=profile.$px(p._maxColW);

                    if(profile.beforeColResized && false===profile.boxing().beforeColResized(profile,col?col.id:null,w))
                        return;

                    if(col){
                        if(col.hasOwnProperty('maxWidth'))w=Math.min(profile.$px(col.maxWidth),w);
                        if(col.hasOwnProperty('minWidth'))w=Math.max(profile.$px(col.minWidth),w);
                    }
                    w+=2;
                    emw=profile.$forceu(w);

                    profile.box._adjusteditorW(profile, xui(nodes).parent().width(emw),w);
                    o.width(col.width=col._colWidth=emw);
                    
                    xui(nodes).removeClass(cls);
                    if(profile.afterColResized)
                        profile.boxing().afterColResized(profile,col.id,w);

                    profile.box._adjustColsWidth(profile);
                    profile.box._adjustBody(profile,'setcol');
                    return false;
                }
            },
            //row resizer
            FHANDLER:{
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    var p=profile.properties,
                    row = profile.rowMap[profile.getSubId(src)],
                    o=xui(src),
                    minH =o.parent(3).height()-profile.$px(p._minRowH),
                    scroll = profile.getSubNode('SCROLL21'),
                    maxH = scroll.offset().top + scroll.height() - xui.Event.getPos(e).top - 4;

                    if(p.disabled || (row&&row.disabled))return false;
                    o.startDrag(e, {
                        verticalOnly:true,
                        dragType:'blank',
                        dragDefer:2,
                        maxTopOffset:minH,
                        maxBottomOffset:maxH ,
                        targetReposition:false
                    });
                    xui.use(src).parent(2).onMouseout(true,{$force:true}).onMouseup(true);
                    if(!row)
                        profile.getSubNode('COLLIST').css('visibility','hidden');
                },
                onDragbegin:function(profile, e, src){
                    xui.DragDrop.getProfile().proxyNode
                    .css({
                        width:profile.getRoot().width()+'px',
                        height:'4px',
                        backgroundColor:'#DDDDDD',
                        cursor:'n-resize'
                    });
                },
                onDrag:function(profile, e, src){
                    var d=xui.DragDrop,p=d.getProfile(),b=0;
                    if(p.y<=p.restrictedTop || p.y>=p.restrictedBottom)b=true;
                    if(b){
                        if(!profile._limited){
                            p.proxyNode.css('backgroundColor','#ff6600');
                            profile._limited=true;
                        }
                    }else{
                        if(profile._limited){
                            p.proxyNode.css('backgroundColor','#DDDDDD');
                            profile._limited=0;
                        }
                    }
                },
                onDragstop:function(profile, e, src){
                    var subId=profile.getSubId(src),
                        o=xui(src).parent(3),
                        h=o.height()+xui.DragDrop.getProfile().offset.y,
                        row = profile.rowMap[profile.getSubId(src)],
                        prop=profile.properties,
                        header=prop.header,
                        headerHeight=prop.headerHeight;

                    //for ie's weird bug
                    if(xui.browser.ie && xui.browser.ver<=8 && h%2==1)h+=1;

                    if(profile.beforeRowResized && false===profile.boxing().beforeRowResized(profile, row?row.id:null, h)){
                        profile._limited=0;
                        return;
                    }
                     // use em
                    if(profile.getKey(xui.use(src).parent(2).id())==profile.keys.FHCELL){
                        prop.headerHeight=profile.$forceu(h);
                        profile.box._adjustColsHeight(profile);
                        profile.adjustSize();
                    }else{
                        row.height=profile.$forceu(h);
                        profile.getSubNode("CELLS2",subId).height(row.height);
                        o.height(row._rowHeight=row.height);
                        profile.box._adjusteditorH(profile, o, row._rowHeight);
                    }

                    if(profile.afterRowResized)
                        profile.boxing().afterRowResized(profile, row?row.id:null, h);

                    profile.box._adjustBody(profile,'setrow');

                    profile._limited=0;
                },
                onDblclick:function(profile, e, src){
                    var prop = profile.properties,
                        sid = profile.getSubId(src),
                        row,cells;
                    if(profile.getRootNode().clientHeight<=0)return;

                    if(sid){
                        row=profile.rowMap[sid];
                        cells=profile.getSubNodes(['CELLS2','CELLS1'], sid);
                        var h=cells.height('auto').height();

                        if(profile.beforeRowResized && false===profile.boxing().beforeRowResized(profile, row.id, h))
                            return;
                        cells.height(row.height=row._rowHeight=profile.$forceu(h));
                        profile.box._adjusteditorH(profile, cells, h);
                    }else{
                        // fake
                        var h=(profile._headerLayers||0 + 1)*profile.$px(profile.box.$DataStruct.headerHeight);
                        if(profile.beforeRowResized && false===profile.boxing().beforeRowResized(profile, null, h))
                            return;
                        profile.box._adjustColsHeight(profile,true);

                        prop.headerHeight = profile.$forceu(h, profile.$picku(prop.headerHeight));
                        profile.adjustSize();
                    }

                    if(profile.afterRowResized)
                        profile.boxing().afterRowResized(profile, row?row.id:null, h);

                    profile.box._adjustBody(profile,'setrow');

                    return false;
                },
                onClick:function(){return false}
            },
            //mark click for tree build
            ROWTOGGLE:{
                onClick:function(profile, e, src){
                    var  p = profile.properties,cell,
                        row = profile.rowMap[profile.getSubId(src)];
                    if(!row){
                        cell = profile.cellMap[profile.getSubId(src)];
                        if(cell)row=cell._row;
                    }
                    if(!row)return;
                    if(p.disabled || row.disabled)return false;
                    //for selection click
                    if(!row.sub)return;

                    profile.box._setSub(profile, row, !row._checked);

                    return false;
                },
                beforeMousedown:function(){
                    return false;
                }
            },
            //HCELLA handler dragdrop
            HSCELLA:{
                onClick:function(profile, e, src){
                    profile.getSubNode("HCELLA", profile.getSubId(src)).onClick(true);
                }
            },
            HCELLA:{
                onClick:function(profile, e, src){
                    var p=profile.properties,
                    id = profile.getSubId(src),
                    col = profile.colMap[id];
                    
                    if(!col){
                        if(profile.onClickGridHandler)
                            profile.boxing().onClickGridHandler(profile,e,src);

                        if(p.disabled)return false;
                        if(!p.colSortable)return;
                    }else{
                        if(profile.onClickHeader)
                            profile.boxing().onClickHeader(profile, col, e, src);

                        if(p.disabled || col.disabled)return false;
                        if(!(col.hasOwnProperty('colSortable')?col.colSortable:p.colSortable))return;
                    }

                    if(col&&col._isgroup){
                        col=profile.properties.header[col.from];
                    }
                    if(profile.beforeColSorted && false===profile.boxing().beforeColSorted(profile, col))
                        return false;

                    var order = (col ? col._order : profile._order) || false,
                    type = (col ? col.type : null) || 'input',
                    sortby = col ? col.sortby : null,
                    index = col ? xui.arr.indexOf(p.header,col) :-1,
                    me=arguments.callee,
                    fun = me.fun||(me.fun = function(profile, subNode, index, type, sortby,order,lastrownode1,lastrownode2){
                        var rows,parent1,parent2,self=arguments.callee;
                        if(subNode){
                            rows = subNode.sub;
                            parent1 = profile.getSubNode('SUB1', subNode._serialId).get(0);
                            parent2 = profile.getSubNode('SUB2', subNode._serialId).get(0);
                        }else{
                            subNode={_inited:true};
                            rows = profile.properties.rows;
                            parent1 = profile.getSubNode('ROWS21').get(0);
                            parent2 = profile.getSubNode('ROWS22').get(0);
                        }
                        //sor sub first
                        var a1=[],a2=[], a4=[],t,ff;
                        var a11=[], a12=[], a31=[], a32=[];
                        xui.arr.each(rows,function(row){
                            if(row._region==1)return;

                            if(row.sub && row.sub.length>1)
                                self(profile, row, index, type, sortby, order, null);
                             //for short input
                             a1[a1.length]= index==-1
                                ? row.caption
                                : (t=row.cells)?(t=t[index])?t.value:'':row[index];
                             a4[a4.length]= index==-1
                                    ? row
                                : (t=row.cells)?t[index]:row[index];
                             a2[a2.length]=a2.length;
                        });
                        var sortf;
                        if(typeof sortby!='function'){
                            switch(type){
                                case 'number':
                                case 'spin':
                                case 'counter':
                                case 'currency':
                                    ff=function(n){return parseFloat(n)||0};
                                    break;
                                case 'datetime':
                                case 'date':
                                    ff=function(n){return xui.isDate(n)?n.getTime():xui.isFinite(n)?parseInt(n,10):0};
                                    break;
                                default:
                                    ff=function(n){return n||''};
                            }
                            sortf=function(x,y){
                               var xx=ff(a1[x]), yy=ff(a1[y]);
                               return (xx>yy?(order?1:-1):xx===yy?(x>y?-1:1):(order?-1:1));
                            };
                        }else{
                            sortf=function(x,y){
                               return sortby.apply(profile,[x,y,a1,order,index,a4]);
                            };
                        }
                        a2.sort(sortf);

                        //sort memory array
                        //sort dom node
                        var b = subNode._inited, bak=xui.copy(rows), c;
                        if(b){
                            a11=parent1.childNodes;
                            a12=parent2.childNodes;
                        }
                        xui.arr.each(a2,function(o,i){
                            rows[i]=bak[o];
                            if(b){
                                a31[i]=a11[o];
                                a32[i]=a12[o];
                            }
                        });
                        if(b){
                            var fragment1=document.createDocumentFragment(),
                                fragment2=document.createDocumentFragment();
                            for(var i=0;t=a31[i];i++) fragment1.appendChild(t);
                            for(var i=0;t=a32[i];i++) fragment2.appendChild(t);

                            if(lastrownode1){
                                parent1.insertBefore(fragment1, lastrownode1);
                                parent2.insertBefore(fragment2, lastrownode2);
                            }else{
                                parent1.appendChild(fragment1);
                                parent2.appendChild(fragment2);
                            }
                        }
                    });

                    var lastrow, lastrownode1, lastrownode2;
                    if(profile.__hastmpRow){
                        lastrow=profile.properties.rows.pop();
                        lastrownode1=profile.getSubNode('ROWS21').get(0).lastChild;
                        lastrownode2=profile.getSubNode('ROWS22').get(0).lastChild;
                    }

                    fun(profile, null, index, type, sortby,order, lastrownode1, lastrownode2);

                    if(profile.__hastmpRow)
                        profile.properties.rows.push(lastrow);

                    //show sort mark
                    profile.getSubNode('SORT', true).css('display','none');
                    var node = (col ? profile.getSubNode('SORT', col._serialId) : profile.getSubNode('SORT')).css('display','');
                    node.tagClass('-checked', col ? (!(col._order = !col._order)) : (!(profile._order = !profile._order)));

                    profile.box._asy(profile);

                    //clear rows cache
                    delete profile.$allrowscache1;
                    delete profile.$allrowscache2;

                    if(profile.afterColSorted)
                        profile.boxing().afterColSorted(profile, col);
                },
                beforeMousedown:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;
                    
                    var p=profile.properties;
                    if(p.disabled)return;

                    var col=profile.colMap[profile.getSubId(src)];
                    if(!col||col._isgroup)return;
                    if(p.disabled || col.disabled)return false;
                    if(p.treeMode=='infirstcell' && p.header[0]==col)return false;
                    if(!(col.hasOwnProperty('colMovable')?col.colMovable:p.colMovable))return;

                    //fire before event
                    if(false === profile.boxing().beforeColDrag(profile, col.id))return;

                    var pos=xui.Event.getPos(e),
                        o = xui(src),
                        itemId = profile.getSubId(src);

                    o.startDrag(e,{
                        dragType:'icon',
                        shadowFrom:o.parent(),
                        dragCursor:'pointer',
                        targetLeft:pos.left+12,
                        targetTop:pos.top+12,
                        targetReposition:false,
                        dragDefer: 2,
                        dragKey:profile.$xid + ":col",
                        dragData:o.parent().id(),
                        tagVar:col._region
                    });
                },
                onDragbegin:function(profile, e, src){
                    xui(src).parent().onMouseout(true,{$force:true});
                    xui(src).onMouseup(true);
                },
                beforeMouseover:function(profile, e, src){
                    var p=profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if(!col || col._isgroup)return;
                    if(p.disabled || col.disabled)return false;

                    var dp=xui.DragDrop.getProfile();
                    if(!dp.dragData||dp.dragKey!=profile.$xid + ":col")return;
                    if(dp.tagVar!=col._region)return;

                    var psrc=xui.use(src).parent().xid();
                    if(false===profile.box._colDragCheck(profile,psrc))return;
                    xui.DragDrop.setDropElement(src).setDropFace(src,'move');
                    var nn=xui.use(psrc).get(0), left=nn.offsetLeft + (col._region==2?profile._leftregionw:0), top=nn.offsetTop+nn.offsetHeight;
                    profile.getSubNode("ARROW")
                        .left(left)
                        .top(top)
                        .css("display","block");
                },
                beforeMouseout:function(profile, e, src){
                    var p=profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];
                    if(!col)return;
                    if(p.disabled || col.disabled)return false;

                   var dp=xui.DragDrop.getProfile();
                    if(!dp.dragData||dp.dragKey!=profile.$xid + ":col")return;

                    var psrc=xui.use(src).parent().xid();
                    xui.DragDrop.setDropElement(null).setDropFace(null,'none');
                    if(false===profile.box._colDragCheck(profile, psrc))return;
                    profile.getSubNode("ARROW").css("display","none");
                },
                onDrop:function(profile, e, src){
                    var p=profile.properties,
                        box=profile.box,
                        id = profile.getSubId(src),
                        SubID=xui.UI.$tag_subId,
                        col = profile.colMap[id];
                    if(!col)return;
                    if(p.disabled || col.disabled)return false;

                    var psrc=xui.use(src).parent().xid();
                    profile.getSubNode("ARROW").css("display","none");
                    if(false===box._colDragCheck(profile, psrc))return;

                    //check dragData
                    var data=xui.DragDrop.getProfile().dragData,
                        fromId = data && profile.getSubId(data),
                        toId = profile.getSubId(psrc),
                    //get properties
                        map=profile.colMap,
                        fromTh=map[fromId],
                        toTh=map[toId];

                    //fire before event
                    if(false === profile.boxing().beforeColMoved(profile,fromTh.id, toTh.id))return;

                    //remove dragover appearance
                    xui.DragDrop.setDropFace(psrc,'none');

                    //get index in HCELL array
                    var fromIndex = xui.arr.subIndexOf(p.header,'_serialId',fromId),
                        toIndex = xui.arr.subIndexOf(p.header,'_serialId',toId);

                    //if same or same position, return
                    if(fromIndex===toIndex|| fromIndex===toIndex-1)return;

                    //reposition header dom node
                    profile.getSubNode('HCELL', toId).addPrev(xui(xui.DragDrop.getProfile().dragData));
                    //reposition cell dom nodes
                    xui.each(toTh._cells, function(o,i){
                        profile.getSubNode('CELL',o).addPrev(profile.getSubNode('CELL',fromTh._cells[i]));
                    });

                    //update memory
                    //HCELL position
                    //keep refrence, and remove
                    var temp=p.header[fromIndex];
                    // 1. insert to right pos
                    xui.arr.insertAny(p.header,temp,toIndex);
                    // 2. then, remove
                    xui.arr.removeFrom(p.header,fromIndex+(fromIndex>toIndex?1:0));
                    //cell position rowMap
                    var allitems = profile.queryItems(p.rows, true, true);
                    xui.arr.each(allitems,function(o){
                        //for those non-prepared data
                        o=o.cells?o.cells:o;
                        if(!o || !xui.isArr(o))return;
                        temp=o[fromIndex];
                        xui.arr.removeFrom(o,fromIndex);
                        xui.arr.insertAny(o,temp,toIndex);
                    });

                    // group columns
                    var arr=p.grpCols;
                    if(arr && xui.isArr(arr)&& arr.length){
                        for(var j=0,m=arr.length,grp;j<m;j++){
                            grp=arr[j];
                            if(grp.from>toIndex){
                                grp.from++;
                                grp['to']++;
                            }else if(toIndex>=grp.from && toIndex<=grp['to']){
                                grp['to']++;
                            }
                        }
                        for(var j=0,m=arr.length,grp;j<m;j++){
                            grp=arr[j];
                            if(grp.from>fromIndex){
                                grp.from--;
                                grp['to']--;
                            }else if(fromIndex>=grp.from && fromIndex<=grp['to']){
                               grp['to']--;
                            }
                        }
                        xui.filter(arr,function(o){
                            var r=o['to']>=o.from;
                            if(!r && profile.renderId){
                                profile.getSubNodes(["HCELL","HSCELL"],o[SubID]).remove();
                                delete profile.colMap[o[SubID]];
                                delete profile.colMap2[o.id];
                            }
                            return r;
                        });
                        p.grpCols=box._adjustGrpColsData(profile,arr);
                        box._adjustColsWidth(profile);
                        box._adjustColsHeight(profile);
                    }

                    //fire after event
                    profile.boxing().afterColMoved(profile, fromTh.id, toTh.id);

                    //clear rows cache
                    delete profile.$allrowscache1;
                    delete profile.$allrowscache2;
                },
                onMouseover:function(profile,e,src){
                    var p=profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];

                    if(col){
                        if(p.disabled || col.disabled)return false;
                        if(!(col.hasOwnProperty('colHidable')?col.colHidable:p.colHidable))return;
                        if(!(col.hasOwnProperty('colDroppable')?col.colDroppable:p.colDroppable))return;
                    }else{
                        if(p.disabled)return false;
                        if(!p.colHidable)return;
                    }

                    xui.resetRun(profile.$xid+':collist',null);
                    var region={},
                        pos=xui.use(src).parent().offset(null,profile.getSubNode('BOX')),
                        size=xui.use(src).parent().cssSize();
                    if(size.width<16)return;

                    region.height=profile.$forceu(size.height);
                    region.left=profile.$forceu(pos.left);
                    region.top=profile.$forceu(pos.top);
                    
                    profile.getSubNode('COLLIST').cssRegion(region).css('visibility','visible');
                },
                onMouseout:function(profile,e,src){
                    var p=profile.properties,
                        id = profile.getSubId(src),
                        col = profile.colMap[id];

                    if(col){
                        if(p.disabled || col.disabled)return false;
                        if(!(col.hasOwnProperty('colHidable')?col.colHidable:p.colHidable))return;
                    }else{
                        if(p.disabled)return false;
                        if(!p.colHidable)return;
                    }

                    xui.resetRun(profile.$xid+':collist',function(){
                        // destroyed
                        if(!profile.box)return;
                        profile.getSubNode('COLLIST').css({visibility:'hidden',left:0+profile.$picku(),top:0+profile.$picku()});
                    });
                },
                onContextmenu:function(profile, e, src){
                    if(profile.onContextmenu){
                        var sid=profile.getSubId(src);
                        return profile.boxing().onContextmenu(profile, e, src, sid?profile.colMap[sid]:null)!==false;
                    }
                }
            },
            COLLIST:{
                onMouseover:function(profile,e,src){
                    xui.resetRun(profile.$xid+':collist',null);
                },
                onMouseout:function(profile,e,src){
                    xui.resetRun(profile.$xid+':collist',function(){
                        // destroyed
                        if(!profile.box)return;
                        xui.use(src).css('visibility','hidden');
                    });
                },
                onClick:function(profile,e,src){
                    var p=profile.properties;
                    if(!profile.$col_pop){
                        var items=[],pop;
                        xui.arr.each(profile.properties.header,function(o){
                            if(o.hasOwnProperty('colHidable')?o.colHidable:p.colHidable)
                                items.push({id:o.id,caption:o.caption,type:'checkbox',value:o.hidden!==true});
                        });
                        if(items.length){
                            pop=profile.$col_pop=new xui.UI.PopMenu({hideAfterClick:false,items:items}).render(true);
                            pop.onMenuSelected(function(p,i,s){
                                var b=1;
                                xui.arr.each(p.properties.items, function(o){
                                    if(o.value!==false)
                                        return b=false;
                                });
                                if(!b){
                                    profile.boxing().showColumn(i.id, i.value);
                                }else{
                                    p.getSubNodeByItemId('CHECKBOX',i.id).tagClass('-checked');
                                    i.value=true;
                                }
                            })
                        }
                    }
                    if(profile.$col_pop)
                        profile.$col_pop.pop(src);
                }
            },
            CELLS2:{
                afterMouseover:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled)return;
                    if(p.disableHoverEffect===true)return;
                    if(p.disableHoverEffect && /\bCELLS2\b/.test(p.disableHoverEffect||""))return;
                    //if(p.activeMode=='row'){
                        var subid=profile.getSubId(src);
                        profile.getSubNodes(['CELLS1','CELLS2'], subid).tagClass('-hover');
                        if(profile.onRowHover){
                            var row = profile.rowMap[subid];
                            profile.boxing().onRowHover(profile, row, true, e, src);
                        }
                    //}
                },
                afterMouseout:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled)return;
                    if(p.disableHoverEffect===true)return;
                    if(p.disableHoverEffect && /\bCELLS2\b/.test(p.disableHoverEffect||""))return;
                   //if(p.activeMode=='row'){
                        var subid=profile.getSubId(src);
                        profile.getSubNodes(['CELLS1','CELLS2'], subid).tagClass('-hover',false);
                        if(profile.onRowHover){
                            var row = profile.rowMap[subid];
                            profile.boxing().onRowHover(profile, row, false, e, src);
                        }
                    //}
                },
                onDblclick:function(profile, e, src){
                    var p = profile.properties,
                        row = profile.rowMap[profile.getSubId(src)],
                        nn = xui.Event.getSrc(e),
                        eid = nn&&(nn.id||""),
                        ks=profile.keys,
                        ck=profile.getKey(eid)
                    while(!ck){
                        nn=nn.offsetParent;
                        ck=profile.getKey(eid = nn.id);
                    }
                    if(!row || p.disabled || row.disabled)return false;
                    if(eid && xui.UIProfile.getFromDom(eid)!=profile)return false;
                    if(ck==ks.ROWTOGGLE || ck==ks.MARK) return false;
                    if(profile.onDblclickRow)profile.boxing().onDblclickRow(profile, row, e, src);
                    return false;
                },
                onClick:function(profile, e, src){
                    var p = profile.properties,
                        subid = profile.getSubId(src),
                        ks=profile.keys,
                        row = profile.rowMap[subid],
                        eid = xui.Event.getSrc(e).id||"";
                    if(p.disabled || row.disabled)return false;
                    if(eid && xui.UIProfile.getFromDom(eid)!=profile)return false;
                    if(profile.onClickRow)
                        profile.boxing().onClickRow(profile, row, e, src);
                }
            },
            CELL:{
                onMouseover:function(profile, e, src){
                    if(false == profile.box.$cancelHoverEditor(profile))return;

                    var box=profile.box, p=profile.properties, i=xui.use(src).id(),editor;
                    if(p.disableHoverEffect===true)return;
                    if(p.disableHoverEffect && /\bCELL\b/.test(p.disableHoverEffect||""))return;
                    i=i.split(":")[2];
                    if(!i)return;
                    i=profile.cellMap[i];
                    if(!i)return;

                    if(box.getCellOption(profile, i, "disabled"))return;
                    
                    var editMode=box.getCellOption(profile, i, "editMode");
                    if( box.getCellOption(profile, i, "editable") && xui.str.startWith(editMode,"hover")){
                        if(editMode=='hoversharp' && box.getCellOption(profile, i, "type")=='file'){
                        //    profile.box.$cancelHoverEditor(profile);
                        }else{
                        //    profile.box.$cancelHoverEditor(profile);
                            xui.resetRun(profile.key+":"+profile.$xid+":hovereditor",function(){
                                    if(profile.destroyed)return;
                                    profile.box._editCell(profile, profile.getSubId(src),true);
                            });
                            return false;
                        }
                    }//else{
                     //   profile.box.$cancelHoverEditor(profile);
                    //}
                }
            },
            GCELL:{
                onMouseover:function(profile, e, src){
                    profile.box.$cancelHoverEditor(profile);
                }
            },
            CELLA:{
                onDblclick:function(profile, e, src){
                    var cell = profile.cellMap[profile.getSubId(src)];
                    if(!cell)return;
                    if(profile.properties.disabled)return;
                    var box=profile.box,
                        getPro=box.getCellOption,
                        type=getPro(profile, cell, 'type'),
                        disabled=getPro(profile, cell, 'disabled'),
                        editable=getPro(profile, cell, 'editable');

                    if(!disabled && (!editable || (type=='button'||type=='label'))){
                        profile.boxing().onDblclickCell(profile, cell, e, src);
                        // stop to trigger row's onDblclick event
                        if(type=='button')
                            return false;
                    }
                },
                afterMousedown:function(profile,e,src){
                    xui.setNodeData(src,'_tmp_forcefocus');
                },
                onClick:function(profile, e, src){
                    var p = profile.properties,
                        box=profile.box,
                        getPro=box.getCellOption,
                        cell = profile.cellMap[profile.getSubId(src)],
                        id;
                    if(cell){
                        if(profile.properties.disabled)return false;
                        var type=getPro(profile, cell, 'type'),
                            disabled=getPro(profile, cell, 'disabled'),
                            readonly=getPro(profile, cell, 'readonly'),
                            event=getPro(profile, cell, 'event'),
                            mode = p.activeMode,
                            editable=getPro(profile, cell, 'editable');

                        if(!disabled && (!editable || (type=='button'||type=='label'))){
                            if(typeof event == 'function' && false===event.call(profile._host||profile, profile, cell, null,null,e,src)){}
                            else if(profile.onClickCell)
                                profile.boxing().onClickCell(profile, cell, e, src);
                            if(type=='button')
                                return false;
                        }
                        // checkbox is special for editor
                        if(!disabled && !readonly && type=='checkbox')
                            if(editable){
                                box._updCell(profile, cell, !cell.value, p.dirtyMark, true, true);

                                profile.box._trycheckrowdirty(profile,cell);

                                var ishotrow=cell._row.id==profile.box._temprowid
                                if(ishotrow){
                                    profile.__needchecktmprow=true;
                                    profile.box._sethotrowoutterblur(profile);
                                }
                            }

                        if(!p.editable){
                            if(mode=='cell'){
                                if(getPro(profile, cell, 'disabled'))
                                    return false;
                                id = xui(src).parent().id();
                                box._sel(profile, 'cell', src, id, e);
                            }else if(mode=='row'){
                                if(p.disabled || cell._row.disabled)
                                    return false;
                                id = xui(src).parent(3).id();
                                box._sel(profile, 'row', src, id, e);
                            }
                        }else{
                            if(p.activeMode=='row'){
                                id = xui(src).parent(3).id();
                                box._sel(profile, 'row', src, id, e);
                            } 
                        }
                    // handler CELL
                    }else{
                        var row = profile.rowMap[profile.getSubId(src)];
                        if(p.disabled || row.disabled)
                            return false;
                        if(profile.keys.MARK){
                            var ck=profile.getKey(xui.Event.getSrc(e).id||""),
                                clickMark=ck==profile.keys.MARK;
                        }
                        if(!clickMark){
                            if(typeof event == 'function' && false===event.call(profile._host||profile, profile, row, null,null,e,src)){}
                            else if(profile.onClickRowHandler)
                                profile.boxing().onClickRowHandler(profile, row, e, src);
                            // toggle
                            if(row.group) profile.box._getToggleNode(profile, row._serialId).onClick();
                        }

                        if(p.activeMode=='row'){
                            id = xui(src).parent(3).id();
                            box._sel(profile, 'row', src, id, e);
                        }
                    }
                    if(profile.box){
                        if(xui.use(src).get(0)){
                            //in some browsers: if CELLA has a child 'span', you click 'span' will not tigger to focus CELLA
                            if(!xui.getNodeData(src,'_tmp_forcefocus') )
                                profile.box._focusEvent(profile, e, src);
                        }
                    }
                },
                onFocus:function(profile, e, src){
                    xui.setNodeData(src,'_tmp_forcefocus',1);
                    profile.box._focusEvent(profile, e, src);
                },
                onKeydown:function(profile, e, src){
                    var akeys={"tab":1,"left":1,"right":1,"up":1,"down":1},
                        keys=xui.Event.getKey(e),
                        key = keys.key;

                    if(key=='enter'){
                        xui(src).onClick();
                        return;
                    }

                    if(!akeys[key])return;

                    var cell=profile.cellMap[profile.getSubId(src)];
                    if(profile.beforeCellKeydown && false===profile.boxing().beforeCellKeydown(profile,cell,keys)){
                        return false;
                    }

                    // for navigation
                    var p = profile.properties,
                        shift=keys.shiftKey,
                        ctrl=keys.ctrlKey,
                        cur = xui(src),
                        body11 = profile.getSubNode('SCROLL11'),
                        body12 = profile.getSubNode('SCROLL12'),
                        body21 = profile.getSubNode('SCROLL21'),
                        body22 = profile.getSubNode('SCROLL22'),
                        keyid=new RegExp("^"+profile.box.$Keys.CELLA+":"+profile.serialId+":"),
                        hasBody12 = !!body12.offsetWidth() ,
                        hasBody21 = !!body21.offsetWidth() ,
                        hasBody22 = !!body22.offsetHeight() ,
                        first11 = body11.nextFocus(true, true, false, keyid),
                        first12 = body12.nextFocus(true, true, false, keyid),
                        first21 = body21.nextFocus(true, true, false, keyid),
                        first22 = body22.nextFocus(true, true, false, keyid),
                        last11 = body11.nextFocus(false, true, false, keyid),
                        last12 = body12.nextFocus(false, true, false, keyid),
                        last21 = body21.nextFocus(false, true, false, keyid),
                        last22 = body22.nextFocus(false, true, false, keyid),
                        first = hasBody12 ? hasBody21 ? first11 : first12: hasBody21 ? first21 : first22,
                        last = body22 ? last22 : body12 ? last12 : body21 ? last21 : last11,

                        cellNode = cur.parent(),
                        cellsid = cellNode.parent().id(),
                        subId = profile.getSubId(cellsid),
                        row = cell ? cell._row : profile.rowMap[profile.getSubId(src)], 
                        ishotrow = row && row.id==profile.box._temprowid,
                        region = cell ? (cell._row._region + "" + cell._col._region) : (row._region + "1"),
                        t;

                    var toLeft=function(inner){
                        if(src!=first.xid()){
                            var ok;
                            if(!cellNode.get(0).previousSibling || !cellNode.get(0).previousSibling.clientWidth){
                                switch(region){
                                    case '11':
                                    case '21':
                                        // has right region
                                        if(hasBody22){
                                            if(src==first21.xid()){
                                                last12.focus(true);
                                                ok=1;
                                            }else{
                                                var prev = profile.getSubNode("ROW2",subId).prev();
                                                if(prev){
                                                    prev.nextFocus(false, true, true,keyid);
                                                    ok=1;
                                                }
                                            }
                                        }                        
                                    break;
                                    case '12':
                                    case '22':
                                        // has left region
                                        if(hasBody21){
                                            profile.getSubNode("CELLS1",subId).last(2).focus(true);
                                            ok=1;
                                        }
                                    break;
                                }
                            }
                            if(!ok){
                                cur.nextFocus(false,false,true,keyid);
                            }
                            return false;
                        }else if(inner){
                            last.focus(true);
                        }
                    },
                    toRight=function(inner){
                        if(src!=last.xid()){
                            var ok;
                            if(region=="11"||region=="21" ? !cellNode.get(0).nextSibling : (!(t=cellNode.get(0).nextSibling)||!t.clientWidth)){
                                switch(region){
                                    case '11':
                                    case '21':
                                        // has right region
                                        if(hasBody22){
                                            profile.getSubNode("CELLS2",subId).first(2).focus(true);
                                            ok=1;
                                        }
                                    break;
                                    case '12':
                                    case '22':
                                        // has left region
                                        if(hasBody21){
                                            if(src==last12.xid()){
                                                first21.focus(true);
                                                ok=1;
                                            }else{
                                                var next = profile.getSubNode("ROW1",subId).next();
                                                if(next){
                                                    next.nextFocus(true, true, true,keyid);
                                                    ok=1;
                                                }
                                            }
                                        }
                                    break;
                                }
                            }
                            if(!ok){
                                cur.nextFocus(true,false,true,keyid);
                            }
                            return false;
                        }else if(inner){
                            toDown();
                        }
                    },
                    verticalNav=function(up){
                        //get no.
                        var count=1,
                            temp = cur.parent().get(0),
                            max=temp.parentNode.childNodes.length;
                        while(temp=temp.previousSibling)count++;

                        //get row
                        temp=cur.parent(2).get(0);

                        //get all rows
                        if(!profile.$allrowscache2)
                            profile.box._cacheRows(profile);

                        //get index
                        var index = xui.arr.indexOf(region=="12"||region=="22" ? profile.$allrowscache2 : profile.$allrowscache1, temp),
                            rowLen = profile.$allrowscache2.length,
                            newLine=0;

                        //adjust index
                        if(key=='up'){
                            index--;
                            if(index==-1){
                                index = rowLen-1;
                                count--;
                                if(count==0)count=max;
                            }
                        }else{
                            index++;
                            if(index==rowLen){
                                newLine=1;
                                index=0;
                                count++;
                                if(count==max+1)count=1;
                            }
                        }
                        //get node
                        var node = xui( (region=="12"||region=="22" ? profile.$allrowscache2 : profile.$allrowscache1)[index]).first(),
                            node2=node;
                        // it's normal cell
                        if(count>1)
                            node2=node2.next(count-1);
                        // no normal cell(group)
                        if(node2.isEmpty())
                            node2=node;
                        // get CELLA
                        if(node2 && !node2.isEmpty())
                            node2=node2.first();
                        // focus
                        if(!node2.isEmpty())
                            return  [node2, newLine];
                        return null;
                    },
                    toUp=function(){
                        var tnode;
                        if(src!=first.xid()){
                            if(cur.get(0)==first12.get(0) || cur.get(0)==first22.get(0)){
                                if(hasBody21){
                                    tnode=last21;
                                }else{
                                    tnode=last11;                             
                                }
                            }
                            if(!tnode){
                                tnode=verticalNav(true)[0];
                            }
                        }else{
                            tnode=last;
                        }
                        if(tnode)tnode.focus(true);
                    },
                    toDown=function(){
                        var newLine, tnode;
                        if(src!=last.xid()){
                            if(cur.get(0)==last11.get(0) || cur.get(0)==last21.get(0)){
                                if(hasBody12){
                                    tnode = first12;
                                }else{
                                    tnode=first22;                         
                                }
                            }
                            if(!tnode){
                                tnode=verticalNav();
                                newLine=tnode[1];
                                tnode=tnode[0];
                            }
                        }else{
                            tnode=first;
                            newLine=1;
                        }

                        if(newLine && p.hotRowMode!='none'){
                            var colId;
                            if(!cell){
                                var row=profile.rowMap[profile.getSubId(src)];
                                if(!row)return false;
                            }
                            colId = (p.hotRowRequired||'').split(p.valueSeparator)[0] || (cell && cell._col && cell._col.id);

                            var addhotrow=true;
                            // if it's just the active row
                            if(profile.__hastmpRow){
                                // if it's invalid, dont add new row
                                addhotrow=profile.box._checkNewLine(profile,'keydown');

                                if(!profile.$allrowscache2)
                                    profile.box._cacheRows(profile);
                            }

                            if(addhotrow){
                                profile.box._addTempRow(profile,colId);
                                // dont focus to next cell
                                return false;
                            }
                        }else{
                            if(tnode)tnode.focus(true);
                        }
                    };
                    switch(key){
                    //tab to next/pre
                    case 'tab':
                        if(shift){
                            if(false===toLeft(ishotrow)){
                                return false;
                            }
                        }else{
                            if(false===toRight(ishotrow)){
                                return false;
                            }
                        }
                        break;
                    case 'left':
                        if(false===toLeft(true)){
                            return false;
                        }
                        break;
                    case 'right':
                        if(false===toRight(true)){
                            return false;
                        }
                        break;
                    case 'up':
                        if(ctrl){
                            if(row && !(p.disabled || row.disabled) && (row.group||row.sub)){
                                profile.box._getToggleNode(profile, row._serialId).onClick();
                                return false;
                            }
                        }
                        toUp();
                        return false;
                        break;
                    case 'down':
                        if(ctrl){
                            if(row && !(p.disabled || row.disabled) &&  (row.group||row.sub)){
                                profile.box._getToggleNode(profile, row._serialId).onClick();
                                return false;
                            }
                        }
                        toDown();
                        return false;
                        break;
                    }
                },
                onContextmenu:function(profile, e, src){
                    if(profile.onContextmenu){
                        var sid=profile.getSubId(src);
                        // cell or row
                        return profile.boxing().onContextmenu(profile, e, src,sid?(profile.cellMap[sid]||profile.rowMap[sid]):null)!==false;
                    }
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var p=profile.properties,
                        id=xui.use(src).id().split('_'),
                        cmdkey=id[id.length-1];
                    id.pop();
                    var row = profile.rowMap[profile.getSubId(id.join("_"))];
                    if(p.disabled|| (row&&row.disabled))return false;

                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,row, cmdkey, e, src);
                    return false;
                }
            }
        },
        DataModel:{
            directInput:true,
            listKey:null,
            currencyTpl:"$ *",
            numberTpl:"",
            valueSeparator:";",
            activeRow:{
                hidden:true,
                ini:null
            },
            activeCell:{
                hidden:true,
                ini:null
            },
            rowMap:{
                hidden:true,
                ini:null
            },
            selMode:{
                ini:'none',
                listbox:['single','none','multi','multibycheckbox'],
                action:function(value){
                    this.getSubNodes(['HFMARK','MARK'],true).css('display',(value=='multi'||value=='multibycheckbox')?'':'none');
                }
            },
            editMode:{
                ini:'focus',
                listbox:["focus","sharp","hover","hoversharp","inline"]
            },
            dock:'fill',
            togglePlaceholder:false,
            isFormField:{
                hidden:true,
                ini:false
            },
            altRowsBg: {
                ini:false,
                action:function(value){
                    var ns=this;
                    var altCls = ns.getClass('CELLS1', '-alt'),
                        nodes21 = ns.getSubNode('CELLS1',true),
                        nodes22 = ns.getSubNode('CELLS2',true),
                        j,o1,o2;
                    nodes21.removeClass(altCls);
                    nodes22.removeClass(altCls);
                    if(value){
                        alt=[];
                        j=0;
                        nodes22.each(function(o2,i){
                            if(o2.clientHeight){
                                o2=xui([o2]);
                                o1=xui([nodes21.get(i)]);
                                if((j++)%2==1){
                                    if(!o1.hasClass(altCls))o1.addClass(altCls);
                                    if(!o2.hasClass(altCls))o2.addClass(altCls);
                                }else{
                                    if(o1.hasClass(altCls))o1.removeClass(altCls);
                                    if(o2.hasClass(altCls))o2.removeClass(altCls);
                                }
                            }
                        });
                    }
                }
            },
            rowNumbered:{
                ini:false,
                action:function(value){
                    var ns=this,
                        f=ns.CF.getNumberedStr||function(a){return a},
                        nodes = ns.getSubNode('ROWNUM',true),
                        i=0,
                        map=ns.rowMap,
                        row,ol=0,l=0,a1=[],a2=[],tag='',temp,t;

                    nodes.css('display',value?'':'none');
                    if(value)
                        nodes.each(function(o){
// for perfomance: remove this
//                            if(o.parentNode.clientHeight){
                            if(row=map[ns.getSubId(o.id)]){
                                l=row._layer;
                                if(l>ol){
                                    a1.push(i);
                                    a2.push(tag);
                                    tag=tag+i+'.';
                                    i=0;
                                }else if(l<ol){
                                    while(l<ol--){
                                        i=a1.pop();
                                        tag=a2.pop();
                                    }
                                }
                                i++;
                                ol=l;
                                //o.innerHTML=''+tag+i;
                                row._autoNumber=f(tag+i);
                                temp=row.rowNumber||row._autoNumber;
                                if(t=o.firstChild){
                                    if(t.nodeValue!=temp)
                                        t.nodeValue=temp;
                                }else
                                    o.appendChild(document.createTextNode(temp));
                            }
//                            }
                        });
                    else
                        nodes.text('');
                }
            },
            editable:false,
            firstCellEditable:false,

            $subMargin:'1.375em',

            iniFold:true,
            animCollapse:false,

            position:'absolute',
            width:'25em',
            height:'18em',

            _minColW:'.5em',
            _maxColW:'25em',
            _minRowH:'1.83333em',

            gridHandlerCaption:{
                ini:"",
                action:function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('GRIDCAPTION').html(xui.adjustRes(v,true));
                }
            },
            rowHandlerWidth: {
                $spaceunit:1,
                ini:'5em',
                set:function(value){
                    var o=this;
                    if(o.renderId)
                        o.box._setRowHanderW(o,value);
                    else
                        o.properties.rowHandlerWidth=value;
                }
            },

            showHeader:{
                ini:true,
                action:function(value){
                    this.getSubNodes(['HEADER1','HEADER2']).css('display',value?'':'none');
                }
            },
            headerHeight:{
                $spaceunit:1,
                ini:'2em',
                action:function(v){
                    var profile=this,
                        prop=profile.properties;
                    profile.box._adjustColsHeight(profile);
                    profile.adjustSize();
                }
            },
            rowHeight:{
                $spaceunit:1,
                ini:'2em',
                action:function(v){
                    this.box._adjusteditorH(this, this.getSubNodes(['CELLS1','CELLS2'], true).height(v),v);
                }
            },
            _colDfWidth: '8em',

            rowHandler:{
                ini:true,
                action:function(value){
                    this.getSubNode('FHCELL').css('display',value?'':'none');
                    this.getSubNode('FCELL',true).css('display',value?'':'none');

                    this.box._adjustColsWidth(this);
                    this.box._adjustBody(this,'rowhandler');
                }
            },
            rowResizer:{
                ini:false,
                action:function(value){
                    this.getSubNode('FHANDLER',true).css('display',value?'':'none');
                }
            },

            colHidable:false,
            colResizer:{
                ini:true,
                action:function(value){
                    this.getSubNode('HHANDLER',true).css('display',value?'':'none');
                }
            },
            colSortable:{
                ini:true,
                action:function(value){
                    if(!value)
                        this.getSubNode('SORT',true).css('display','none');
                }
            },
            colMovable:false,

            header:{
                ini:{},
                set:function(value){
                    var o=this;
                    if(o.renderId){
                        o.boxing()._refreshHeader(value);
                    }else
                        o.properties.header = xui.copy(value);
                }
            },
            uidColumn:'',
            grpCols:{
                //for default merge
                ini:{},
                set:function(value){
                    var o=this;
                    o.properties.grpCols = xui.copy(value);
                    if(o.renderId){
                        o.boxing()._refreshHeader(xui.clone(o.properties.header,false,2));
                    }
                }
            },
            rows:{
                //for default merge
                ini:{},
                set:function(value){
                    var o=this;
                    if(o.renderId)
                        o.boxing().removeAllRows(false).insertRows(value);
                    //use copy to avoid outer memory link
                    else
                        o.properties.rows = xui.copy(value);
                }
            },
            // can be se dynamic only
            rawData:{
                ini:[],
                set:function(value){
                    if(!value || !xui.isArr(value) || !value.length)return;
                    var o=this,cols={},header=[],rows=[],i,j,l=value.length,hash;
                    // collect data
                    for(i=0;i<l;i++){
                        if(!xui.isHash(hash=value[i])){
                            return;
                        }
                        for(var k in hash){
                            if(!(k in cols))cols[k]=[];
                            cols[k][i] = hash[k];
                        }
                    }
                    //convert to header / rows
                    j=0;
                    for(var k in cols){
                        header.push(k);
                        for(i=0;i<l;i++){
                            if(!rows[i])rows[i]=[];
                            rows[i][j]=cols[k][i];
                        }
                      j++;
                    }

                    var ins=o.boxing();
                    if(ins.getHeader('min').join(';') != header.join(';')){
                        ins.setHeader(header)
                    }
                    ins.setRows(rows);
                },
                get:function(row,  splitMixColumn){
                    var o=this, prop=o.properties, header=prop.header,
                        tid=this.box._temprowid,
                        one = row&&row.cells&&xui.isArr(row.cells),
                        rows=  one ? [row] : xui.isArr(row)&&row[0]&&row[0].cells&&xui.isArr(row[0].cells) ? row: prop.rows,
                        l=header.length, h=rows.length,
                        columns=[],cell,key,keys,
                        data=[];

                    if(h){
                        for(var i=0;i<l;i++){
                            columns.push(header[i].id);
                        }
                        for(var j=0;j<h;j++){
                            //ignore temp row for all rows
                            if(!one && rows[j].id==tid)continue;
                            if(rows[j].group || !rows[j].cells)continue;

                            var hash={};
                            for(var i=0;i<l;i++){
                                key = columns[i];
                                cell = rows[j].cells[i]
                                if(splitMixColumn && key.indexOf(":")!=-1){
                                    keys=key.split(':');
                                    hash[keys[0]]=('value' in cell)?cell.value:cell;
                                    hash[keys[1]]=('caption' in cell)?cell.caption:null;
                                }else{
                                    hash[key.split(':')[0]]=('value' in cell)?cell.value:cell;
                                }
                            }
                            data.push(hash);             
                        }
                    }
                    return one?data[0]:data;
                }
            },
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            },
            activeMode:{
                ini:'row',
                listbox:['row','cell','none'],
                action:function(value){
                    var profile=this;
                    if(value!='cell' && profile.$activeCell){
                        xui(profile.$activeCell).tagClass('-active',false);
                        delete profile.$activeCell;
                    }
                    if(value!='row' && profile.$activeRow){
                        xui(profile.$activeRow).tagClass('-active',false);
                        delete profile.$activeRow;
                    }
                }
            },

            rowOptions:{
                ini:{},
                action:function(value){
                    var ins=this.boxing(),
                        rows=ins.getRows('data');
                    ins.removeAllRows();
                    ins.insertRows(rows);
                }
            },
            colOptions:{
                ini:{},
                action:function(value){
                    var ins=this.boxing(),
                        rows=ins.getRows('data');
                    ins.removeAllRows();
                    ins.insertRows(rows);
                }
            },
            treeMode:{
                ini:'inhandler',
                // compitable: false->'none'; true->inhanlder
                listbox:['none','inhandler','infirstcell'],
                action:function(value, ovalue){
                    if((ovalue=='inhandler' && value=='infirstcell')||(ovalue=='infirstcell' && value=='inhandler')){
                        this.boxing().refresh();
                    }else{
                        this.getSubNodes(['ROWLRULER', 'ROWTOGGLE'],true).css('display',value?'':'none');
                    }
                }
            },
            freezedColumn:{
                ini:0,
                action:function(){
                    this.boxing().refresh();
                    this.box._adjustColsWidth(this);
                }
            },
            freezedRow:{
                ini:0,
                action:function(){
                    this.boxing().refresh();
                }
            },
            hotRowMode:{
                ini:'none',
                listbox:['none','show','hide','auto'],
                action:function(value){
                    if(this.renderId){
                        if(value=='none')
                            this.boxing().removeHotRow();
                        else
                            this.box.__ensurehotrow(this,null);
                    }
                }
            },
            excelCellId:{
                ini:"",
                action:function(){
                    this.boxing().notifyExcel(false);
                }
            },
            gridValueFormula:"",
            hotRowNumber:'[*]',
            hotRowCellCap:'(*)',
            hotRowRequired:'',
            noCtrlKey:true
        },
        EventHandlers:{
            onBodyLayout:function(profile, trigger){},

            beforeCellKeydown:function(profile,cell,keys){},
            afterCellFocused:function(profile, cell, row){},

            beforeInitHotRow:function(profile){},
            onInitHotRow:function(profile,row){},

            beforeHotRowAdded:function(profile, cellMap, row, leaveGrid){},
            afterHotRowAdded:function(profile, row){},

            onGetContent:function(profile, row, callback){},
            onRowSelected:function(profile, row, e, src, type){},
            onCmd:function(profile, row, cmdkey, e, src){},

            beforeFold:function(profile,item){},
            beforeExpand:function(profile,item){},
            afterFold:function(profile,item){},
            afterExpand:function(profile,item){},

            beforeColDrag:function(profile, colId){},
            beforeColMoved:function(profile, colId, toId){},
            afterColMoved:function(profile, colId, toId){},
            beforeColSorted:function(profile, col){},
            afterColSorted:function(profile, col){},

            beforeColShowHide:function(profile,colId,flag){},
            afterColShowHide:function(profile,colId,flag){},
            beforeColResized:function(profile,colId,width){},
            afterColResized:function(profile,colId,width){},
            beforeRowResized:function(profile, rowId, height){},
            afterRowResized:function(profile, rowId, height){},

            beforePrepareRow:function(profile, row, pid){},
            beforePrepareCol:function(profile,  col){},

            beforeRowActive:function(profile, row){},
            afterRowActive:function(profile, row){},
            beforeCellActive:function(profile, cell){},
            afterCellActive:function(profile, cell){},

            beforeCellUpdated:function(profile, cell, options, isHotRow){},
            afterCellUpdated:function(profile, cell, options, isHotRow){},
            beforeRowUpdated:function(profile, obj, options, isHotRow){},
            afterRowUpdated:function(profile, obj, options, isHotRow){},

            onRowDirtied:function(profile, row){},

            onRowHover:function(profile, row, hover, e, src){},
            onClickHeader:function(profile, col, e, src){},
            onClickRow:function(profile, row, e, src){},
            onClickRowHandler:function(profile, row, e, src){},
            onDblclickRow:function(profile, row, e, src){},
            onClickCell:function(profile, cell, e, src){},
            onDblclickCell:function(profile, cell, e, src){},
            onClickGridHandler:function(profile, e, src){},

            beforeIniEditor:function(profile, cell, cellNode, pNode, type){},
            onBeginEdit:function(profile, cell, editor, type){},
            beforeEditApply:function(profile, cell, options, editor, tag, type){},
            onEndEdit:function(profile, cell, editor, type){},

           // Editors' default events
            onFileDlgOpen:function(profile, cell, proEditor, src){},
            beforeComboPop:function(profile, cell, proEditor, pos, e, src){},
            beforePopShow:function(profile, cell, proEditor, popCtl, items){},
            afterPopShow:function(profile, cell, proEditor, popCtl){},
            onCommand:function(profile, cell, proEditor, src, type){},
            onEditorClick:function(profile, cell, proEditor, type, src){},
            beforeUnitUpdated:function(profile, cell, proEditor, type){},

            // beforeApplyGridExcelFormula
            // afterApplyGridExcelFormula
            beforeApplyFormula:function(profile, cell, value, formula){},
            afterApplyFormulas:function(profile, dataArrs){},
            beforeGridValueCalculated:function(profile){},
            afterGridValueCalculated:function(profile, value){},

            onGetExcelCellValue:function(profile, excelCellId, dftValue){}
        },
        RenderTrigger:function(){
            var ns=this, 
                box=ns.box, 
                prop=ns.properties,
                ins=ns.boxing(), 
                getPro=box.getCellOption;

            ns.destroyTrigger=function(){
                var ns=this, prop=ns.properties;
                xui.each(ns.cellMap,function(cell){
                    if(cell._editor)cell._editor.destroy();
                });
                xui.breakO([ns.colMap, ns.rowMap, ns.cellMap], 3);
                prop.header.length=0;
                prop.rows.length=0;
                prop.grpCols.length=0;
            };
            ns.$cache_editor={};
            if(!prop.iniFold)
                ins._toggleRows(prop.rows,true);
            // trigger render
            xui.arr.each(prop.header,function(o){
                if(xui.isFun(o.colRenderer||prop.colOptions.colRenderer))
                    (o.colRenderer||prop.colOptions.colRenderer).call(null,ns,o);
            });
            // move it manually
            if(prop.treeMode=='infirstcell'){
                ns.getSubNode('HCELLA', prop.header[0]._serialId).prepend(
                    ns.getSubNode('LTAGCMDS')
                ).prepend(
                    ns.getSubNode('HFMARK')
                );
            }
            xui.arr.each(prop.rows,function(o){
                if(xui.isFun(o.rowRenderer||prop.rowOptions.rowRenderer))
                    (o.rowRenderer||prop.rowOptions.rowRenderer).call(null,ns,o);
                    if(false===getPro(ns, o, "iniFold"))
                        ins._toggleRows([o],true);
            });

            ns.box.__ensurehotrow(ns,null);

            xui.each(ns.cellMap,function(o){
                   if(getPro(ns, o, "editable") && 
                       (getPro(ns, o, "editMode")=="inline" || getPro(ns, o, "type")=='dropbutton' ))
                        box._editCell(ns,o);
            });

            if(prop.excelCellId)
                ns.boxing().calculateGridValue();
        },
        LayoutTrigger:function(){
            var ns=this, box=ns.box, prop=ns.properties,ins=ns.boxing();
            if(xui.isArr(prop.grpCols)){
                xui.arr.each(prop.grpCols,function(o){
                    if(xui.isFun(o.colRenderer||prop.colOptions.colRenderer))
                        (o.colRenderer||prop.colOptions.colRenderer).call(null,ns,o);
                });
                box._adjustColsHeight(ns);
            }
            ns.box._asy(ns);
            ns.box._adjustBody(ns,'render');
        },
        _tplMap:{'text':'.text','button':'.button','image':'.image'},
        _tplMap2:{'textarea':'.textarea','checkbox':'.checkbox','button':'.button','progress':'.progress'},
        _focusEvent:function(profile, e, src){
            var ins=profile.boxing(),
                prop=profile.properties,
                cell=profile.cellMap[profile.getSubId(src)],
                row;

            profile.box._focuscell(profile, e, src);

            if(profile.afterCellFocused){
                if(cell)
                    row=cell._row;
                else
                    row=profile.rowMap[profile.getSubId(src)];
                ins.afterCellFocused(profile, cell, row);
            }
            // to check hot row
            if(prop.hotRowMode!='none'){
                var cell=profile.cellMap[profile.getSubId(src)],row;
                if(cell)
                    row=cell._row;
                else
                    row=profile.rowMap[profile.getSubId(src)];
                if(profile.__hastmpRow && profile.__needchecktmprow && row.id!==profile.box._temprowid)
                    profile.box._checkNewLine(profile,'focuscell');
            }
        },
        __ensurehotrow:function(profile,focusColId){
            var prop=profile.properties,
                box=profile.box,
                need=false;
            if(!box || !profile.renderId|| prop.hotRowMode=="none")return;

            if(profile.__hastmpRow){
                var rows=profile.properties.rows;
                if(rows.length===0 || rows[rows.length-1].id!=profile.box._temprowid)
                    need=true;
            }else{
                need=true;
            }

            if(need){
                // add a temp row
                switch(prop.hotRowMode){
                    case 'auto':
                        if(!prop.rows||prop.rows.length===0)
                            box._addTempRow(profile,focusColId);
                    break;
                    case 'show':
                        box._addTempRow(profile,focusColId);
                    break;
                }
            }
        },
        _temprowid:'_ r _temp_',
        isHotRow:function(row){
            return row && (row.id||row)===this._temprowid;
        },
        _addTempRow:function(profile,focusColId){
            var prop=profile.properties;
            if(prop.readonly || prop.disabled  || !prop.header || prop.header.length<=0)
                return false;

            // clear first, ensure only one
            profile.box._sethotrowoutterblur(profile,true);
            delete profile.__hastmpRow;
            profile.boxing().removeRows([this._temprowid],false);

            if(profile.beforeInitHotRow && false===profile.boxing().beforeInitHotRow(profile))
                return false;

            profile.__needchecktmprow=true;

            var cells={},
                row={cells:cells},
                required=(prop.hotRowRequired||"").split(prop.valueSeparator),
                newcell={caption:prop.hotRowCellCap},
                ins=profile.boxing();
            if(required.length){
                xui.arr.each(prop.header,function(col, i){
                    if(xui.arr.indexOf(required, col.id)!=-1){
                        // must hash for mix column
                        cells[col.id]=newcell;
                    }else if(xui.isSet(col.defaultValue)){
                        cells[col.id]=col.defaultValue;
                    }
                });
            }

            if(profile.onInitHotRow)
                row=ins.onInitHotRow(profile,row)||row;

            if(xui.isArr(row))
                row={cells:row};
            else if(!xui.isHash(row))
                row={cells:[row]};

            // gives a special id
            row.id = this._temprowid;
            row.rowNumber=prop.hotRowNumber;
            row.rowClass=profile.getClass('CELLS2', '-hot');

            ins.insertRows([row],null,null,false,false);

            profile.__hastmpRow=true;

            // focus to next cell
            if(focusColId!==null){
                ins.focusCellbyRowCol(row.id, focusColId||prop.header[0].id);
                profile.box._sethotrowoutterblur(profile);
            }
        },
        _checkNewLine:function(profile,trigger){
            var prop=profile.properties;
            profile.box._sethotrowoutterblur(profile,true);

            // checked already
            if(!profile.__hastmpRow)
                return;

            delete profile.__needchecktmprow;

            var ins=profile.boxing(),
                rowId=this._temprowid,
                required=prop.hotRowRequired && prop.hotRowRequired.split(prop.valueSeparator),
                // must be map row
                tempRow=ins.getRowbyRowId(rowId, 'map', true),
                result=!!trigger;
            if(!tempRow)
                return;
            if(required && required.length){
                for(var i=0,j,cell,l=required.length;i<l;i++){
                    j=xui.arr.subIndexOf(prop.header, 'id',required[i]);
                    if( j!=-1 && !(xui.isHash(cell=tempRow[required[i].split(':')[0]]) ? cell.value : cell) ){
                        result=null;
                        break;
                    }
                }
            }
            var tempRowData=ins.getRowbyRowId(rowId, 'data', true);
            // clear temp data
            delete tempRowData.id; delete tempRowData.rowClass; delete tempRowData.rowNumber;
            xui.arr.each(tempRowData.cells, function(cell){
                if(cell.id.indexOf('-c_')==0)delete cell.id; 
                if(cell.caption===prop.hotRowCellCap)delete cell.caption;
            });

            if(profile.beforeHotRowAdded){
                var result2=ins.beforeHotRowAdded(profile, tempRow, tempRowData, !trigger);
                if(xui.isDefined(result2))
                    result=result2===true?result2:result2===false?result2:null;
            }

            // do nothing
            if(result===null){
                if(prop.hotRowMode=='hide'||prop.hotRowMode=='auto'){
                    profile.box._sethotrowoutterblur(profile);
                }
                return false;
            }
            // remove the hot row
            else if(result===false){
                if(prop.hotRowMode=='hide'||prop.hotRowMode=='auto'){
                    delete profile.__hastmpRow;
                    ins.removeRows([rowId],false);
                    if(prop.rows.length===0 && prop.hotRowMode=='auto')
                        this._addTempRow(profile,null);
                }
                // dont add new hot row
                return false;
            }
            // add a new row
            else if(result===true){
                delete profile.__hastmpRow;
                ins.removeRows([rowId],false);                    
                ins.insertRows(tempRowData,null,null,false,true);

                tempRow = prop.rows[prop.rows.length-1];
                tempRow._dirty=1;
                if(profile.afterHotRowAdded)
                    ins.afterHotRowAdded(profile, tempRow);
                if(prop.hotRowMode=='show'){
                    if(!profile.__hastmpRow)
                        this._addTempRow(profile,null);
                }
                return true;
            }
            // focus the invalid cell, and keep this hot row
            else{
                profile.__needchecktmprow=true;
                // if returns cell
                if(xui.isHash(result))
                    ins.focusCell(result);
                // if return cell id
                else
                    ins.focusCell(ins.getCell(result));

                profile.box._sethotrowoutterblur(profile);
                // dont add new hot row
                return false;
            }
        },
        _sethotrowoutterblur:function(profile, clear){
            var f=function(k){return profile.getSubNode(k).get(0) };
            profile.getSubNode('ROWS22').setBlurTrigger(profile.$domId+':ROWS22',clear?null:function(pos,e){
                var node=xui.Event.getSrc(e), 
                    trigger = node==f('SCROLL11') || node==f('SCROLL12') || node==f('SCROLL21') || node==f('SCROLL22') ?'focusin':'focusout';
                profile.__tmpRowBlurTrigger=xui.asyRun(function(){
                    // destroyed
                    if(!profile.box)return;
                    profile.box._checkNewLine(profile,trigger);
                });
            },xui([f('ROWS11'),f('ROWS12'),f('ROWS21'),f('ROWS22')]),null,true);
            if(clear){
                if(profile.__tmpRowBlurTrigger){
                    xui.clearTimeout(profile.__tmpRowBlurTrigger);
                    delete profile.__tmpRowBlurTrigger;
                }
            }
        },
        _cacheRows:function(profile){
            var all1=profile.getSubNodes('CELLS1',true).get(),
                all2=profile.getSubNodes('CELLS2',true).get();
            //filter dispaly==none
            xui.filter(all1,function(o){
                return !!o.clientHeight;
            });
            xui.filter(all2,function(o){
                return !!o.clientHeight;
            });
            profile.$allrowscache1 = all1;
            profile.$allrowscache2 = all2;
        },
        _asy:function(profile){
            var prop=profile.properties,b=profile.boxing(),id=profile.$xid;
            if(prop.altRowsBg)xui.resetRun(id+"1",function(){if(profile.rowMap)b.setAltRowsBg(true,true)});
            if(prop.rowNumbered)xui.resetRun(id+"2",function(){if(profile.rowMap)b.setRowNumbered(true,true)});
        },
        _setRowHanderW:function(profile, flag){
            var prop=profile.properties,
                ww=profile._$subMargin || (profile._$subMargin=profile.$px(prop.$subMargin)),
                map=profile.rowMap,
                hcell=profile.getSubNode('FHCELL'),
                n,w;
            if(xui.isFinite(flag) || profile.$isEm(flag)|| profile.$isPx(flag))
                w=profile.$forceu(flag);
            else if(flag===true){
                var ws=[],t;
                profile.getSubNode('FCELLCAPTION',true).each(function(o){
                    if((t=o.parentNode).parentNode.offsetHeight>0 && xui.Dom.getStyle(t,'overflow')!='visible')
                        if(n=map[profile.getSubId(o.id)])
                            ws.push(xui([o]).width() + n._layer*ww);
                });
                ws.push(profile.$px(prop._minColW));
                w=profile.$forceu(Math.max.apply(null,ws)+ww*2);
            }else
                w=profile.$forceu(hcell.width());

            //set width
            if(w){
                if(profile.$px(w)<profile.$px(prop._minColW))w=profile.$em(prop._minColW)+'em';
                if(profile.$px(w)<=0)return;
                if(prop.rowHandlerWidth!=w){
                    hcell.width(prop.rowHandlerWidth=w);
                    profile.getSubNode('FCELL',true).width(w);
                    profile.getSubNode('GCELL',true).width(w);

                    /*
                    profile.getSubNode('ROWLRULER',true).each(function(o){
                        n=map[profile.getSubId(o.id)];
                        o.style.width=(4 + n._layer*ww)+'px';
                    });
                    */
                    profile.box._adjustColsWidth(profile);
                    profile.box._adjustBody(profile,'rowhandler');
                }
            }
        },
        _onStartDrag:function(profile, e, src){
            var row = profile.rowMap[profile.getSubId(src)];
            if(row && row.id==profile.box._temprowid)return false;

            var pos=xui.Event.getPos(e);
            profile.$_ond=src;
            xui.use(src).startDrag(e, {
                dragSource:profile.$xid,
                dragType:'icon',
                shadowFrom:xui.use(src).parent()._get(0),
                targetLeft:pos.left+12,
                targetTop:pos.top+12,
                dragCursor:'pointer',
                dragDefer:2,
                dragKey: profile.box.getDragKey(profile, src),
                dragData: profile.box.getDragData(profile, e, src)
            });
            return false;
        },
        _onDropTest:function(profile, e, src, key, data, item){
            var fid=data&&data.domId, tid=src, fp=data&&data.profile,t;
            if(tid){
                var k=profile.getKey(tid),
                    ks=profile.keys,
                    row=profile.rowMap[profile.getSubId(tid)];
                if(k==ks.FCELL && !row.sub)
                    return false;
                if(profile.properties.rowHandler){
                    if(k==ks.CELLS2||k==ks.SCROLL22)return false;
                }else{
                    if(k==ks.CELLS1||k==ks.SCROLL21)return false;
                }
            }
            if(fp && fp.$xid==profile.$xid){
                if(fid && profile.getSubId(fid)==profile.getSubId(tid))
                    return false;
                t=profile.$_ond;

                src=xui(src).get(0);
                if(xui.get(src,['parentNode','previousSibling'])==t)return false;
                do{
                    if(src==t){
                        src=t=null;
                        return false;
                    }
                }while(src && (src=src.parentNode) && src!==document && src!==window)
                src=t=null;
            }
        },
        _onDragstop:function(profile, e, src, key, data, item){
            delete profile.$_ond;
        },
        _onDrop:function(profile, e, src, key, data, item){
            if(!data.profile || !data.profile[profile.KEY])return;
            var k = profile.getKey(src),
                po = data.profile,
                ps = data.domId,
                oitem,
                ks = profile.keys,
                t = xui.absObj.$specialChars,
                b = profile.boxing(),
                arr = xui.copy(b.getUIValue(true)),
                orow = po.rowMap[po.getSubId(ps)],
                row = profile.rowMap[profile.getSubId(src)];

            //remove
            orow=xui.clone(orow,function(o,i){return !t[(i+'').charAt(0)]});
            po.boxing().removeRows([orow.id]);

            //add
            if(k==ks.SCROLL21||k==ks.SCROLL22)
                b.insertRows([orow], null, null, false);
            else if((k==ks.FCELL) && row.sub)
                b.insertRows([orow], row.id, null, false);
            else if(k==ks.CELLS1||k==ks.CELLS2)
                b.insertRows([orow], row._pid, row.id, true);

            if(arr && arr.length){
                if(xui.arr.indexOf(arr, orow.id)!=-1){
                    b.setUIValue(arr,true,null,'drop');
                }
            }
            data._new = orow;
            return false;
        },

        _beforeSerialized:function(profile){
            var o=arguments.callee.upper.call(this, profile),
                pp=profile.properties,
                map=xui.absObj.$specialChars,
                op=o.properties,
                t;
            op.header = xui.clone(pp.header, function(o,i,d){
                return !map[((d===1?o.id:i)+'').charAt(0)]  && o!=undefined
            });
            op.grpCols = xui.clone(pp.grpCols, function(o,i,d){
                return !map[((d===1?o.id:i)+'').charAt(0)]  && o!=undefined
            });
            op.rows = xui.clone(pp.rows, function(o,i,d){
                return !map[((d===1?o.id:i)+'').charAt(0)]  && o!=undefined && ((i=="id"&&typeof(o)=="string")?o.charAt(0)!="-":true);
            });
            if(xui.isEmpty(op.header))delete op.header;
            if(xui.isEmpty(op.grpCols))delete op.grpCols;
            if(xui.isEmpty(op.rows))delete op.rows;

            delete op.activeRow;
            delete op.activeCell;
            delete op.rawData;
            return o;
        },
        _clsCache:{},

        _colDragCheck:function(profile, src){
            var p=profile.properties,
                dd = xui.DragDrop.getProfile(), key=dd.dragKey, data=dd.dragData,
                col=profile.colMap[profile.getSubId(src)];
            if(!col || col._isgroup)return false;
            if(p.treeMode=='infirstcell' && p.header[0]==col)return false;
            if(!(col.hasOwnProperty('colMovable')?col.colMovable:profile.properties.colMovable))return false;
            if(!key || !data || key!=(profile.$xid+":col"))return false;
            if(data==xui.use(src).id() || data==xui.use(src).prev().id())return false;
        },
        _prepareData:function(profile){
            var data = arguments.callee.upper.call(this, profile),
                NONE='display:none',
                prop=profile.properties;

            // init row/cell cache
            profile.rowMap2 = {};
            profile.rowMap = {};
            profile.cellMap = {};

            data.showHeader=prop.showHeader?'':NONE;
            data.colDDDisplay=prop.colResizer?'':NONE;
            data.rowDDDisplay=prop.rowResizer?'':NONE;
            data.rowHandlerDisplay=prop.rowHandler?'':NONE;
            data.sortDisplay=NONE;
            data._rowMarkDisplay=(prop.selMode=="multi"||prop.selMode=="multibycheckbox")?"":"display:none;";

            if(!prop.header || !xui.isArr(prop.header))
                prop.header = [];
            if(!prop.grpCols || !xui.isArr(prop.grpCols))
                prop.grpCols = [];
            if(!prop.rows || !xui.isArr(prop.rows))
                prop.rows = [];

            prop.header=this._adjustHeader(prop.header);
            data.header=this._prepareHeader(profile, prop.header);
            // for triggerring render
            data.header1=data.header2= data.header;
            prop.grpCols=this._adjustGrpColsData(profile,prop.grpCols);
            data.grpCols=this._prepareGrpCols(profile, prop.grpCols, data.header);
            // for triggerring render
            data.grpCols1=data.grpCols2=data.grpCols;
            data._row0DfW=data.rowHandlerWidth?('width:'+profile.$forceu(data.rowHandlerWidth)):'';

            // make sure its' size
            if(profile.$isEm(prop.headerHeight))data.headerHeight = profile.$forceu(profile.$px(prop.headerHeight,0,true),'em');
            if(profile.$isEm(prop.rowHeight))data.rowHeight = profile.$forceu(profile.$px(prop.rowHeight,0,true),'em');
            if(profile.$isEm(prop.rowHandlerWidth))data.headerHeight = profile.$forceu(profile.$px(prop.rowHandlerWidth,0,true),'em');

            arguments.callee.upper.call(this, profile);

            prop.rows=this._adjustRows(profile, prop.rows);
            data.rows11 = data.rows12 = data.rows21 = data.rows22 = this._prepareItems(profile, prop.rows);
            
            data.tagCmds = xui.clone(prop.colOptions.tagCmds || data.tagCmds);
            if(data.tagCmds){
                this._prepareCmds(profile, data, function(item){
                    return !item.tag || !!item.tag.match(/\bheader\b/);
                });
            }
            data._columnfreezed = prop.freezedColumn?'xui-ui-shadow-r xui-uiborder-r xui-uiborder-dark':'';
            data._rowfreezed = prop.freezedRow?'xui-ui-shadow-b xui-uiborder-b xui-uiborder-dark':'';

            return data;
        },
        _parepareCol:function(profile,col,cols,index){
            // build header
            var SubID=xui.UI.$tag_subId,
                prop=profile.properties,
                headerHeight=profile.$px(prop.headerHeight),
                borderH=profile.getRoot().contentBox()?2:0,
                NONE='display:none',iid,
                ii=1,tt,
                oid, uicol;

            if(!xui.isHash(col)){
                oid = col + "";
                col={id : oid};
            }else{
                oid = col.id +"";
            }

            // links
            col._cells={};
            iid = profile.pickSubId('header');
            col[SubID]='-h_'+iid;

            col.id = col.id || iid;
            while((tt=xui.arr.subIndexOf(cols,"id",col.id) )!= -1 && tt!==index){
                col.id = iid + (ii++);
            }

            profile.colMap[col[SubID]]=col;

            var _ww=profile.$px(col.width)||profile.$px(prop._colDfWidth);
            if('relWidth' in col){
                col.flexSize = col.relWidth
                delete col.relWidth;
            }
            // width
            if(!col.flexSize){
                if(col.hasOwnProperty('minWidth'))_ww=Math.max(_ww, profile.$px(col.minWidth));
                if(col.hasOwnProperty('maxWidth'))_ww=Math.min(_ww, profile.$px(col.minWidth));
            }

            col.width = col._cellWidth = col._colWidth = profile.$forceu(_ww);
            col._hcellheight=profile.$forceu(headerHeight-borderH);

            uicol={
                sortDisplay : NONE,
                rowHandlerDisplay : prop.rowHandler?'':NONE
            };
            uicol[SubID]=col[SubID];
            uicol._tabindex=prop.tabindex;
            uicol.colDDDisplay = (('colResizer' in col)?col.colResizer:prop.colResizer)?'':NONE;

            //if(col.flexSize)uicol.colDDDisplay = NONE;

            //  Forward-compatible with 'visibility'
            if(col.hasOwnProperty('visibility') && !col.hasOwnProperty('hidden'))
                col.hidden=!col.visibility;

            uicol.colDisplay = col.hidden===true?NONE:'';

            uicol.firstCellStyle=prop.colOptions.firstCellStyle||'';
            uicol.firstCellClass=prop.colOptions.firstCellClass||'';

            if(!col.type)col.type=prop.colOptions.type || 'input';
            if(!(('caption' in col) && xui.isDefined(col.caption)))col.caption = oid;
            xui.UI.adjustData(profile, col, uicol, 'sub');

            // id to dom item id
            profile.colMap2[col.id]=col[SubID];

            return [col,uicol];
        },
        _prepareCell:function(profile,cell,row,col,temp,_row,index){
            // build header
            var ns=this,
                SubID=xui.UI.$tag_subId,
                prop=profile.properties,
                NONE='display:none',
                uicell={};
            cell=xui.isSet(cell) ? xui.isHash(cell) ? cell : {value:cell} :{};
            //cell/cell link to row
            cell._row=row;
            //cell/cell link to header
            cell._col=col;
            //_serialId
            cell[SubID]='-c_'+profile.pickSubId('cell');
            // give id
            cell.id=cell.id||cell[SubID];
            // adjust
            ns._adjustCell(profile, cell, uicell);
            // cell only link its' dom item id to properties item
            profile.cellMap[uicell[SubID]]=cell;
            if(temp)temp.push(cell);
            // row link to cell/cell
            row._cells[col.id]=uicell[SubID];
            // header link to cell/cell
            col._cells[row.id]=uicell[SubID];

            // for _first_cell
            if(prop.treeMode=='infirstcell' && index===0 && _row){
                uicell._treeMode=_row._treeMode;
                uicell._rulerW=_row._rulerW;
                uicell._fi_togglemark=_row._fi_togglemark;
                uicell._rowMarkDisplay = _row._rowMarkDisplay;
                uicell._rowNumbDisplay = _row._rowNumbDisplay;
                uicell._ltagDisplay = _row._ltagDisplay;
                uicell.ltagCmds = _row.ltagCmds;
                uicell[xui.UI.$tag_subId_c]=_row[xui.UI.$tag_subId];
            }

            return [cell, uicell];
        },
        _prepareGrpCols:function(profile, arr, _header){
            var prop=profile.properties;
            if(prop.showHeader && arr && xui.isArr(arr)&& arr.length){
                var header=prop.header,
                    headerHeight=profile.$px(prop.headerHeight),
                     borderH=profile.getRoot().contentBox()?2:0,
                    SubID=xui.UI.$tag_subId,
                    NONE='display:none',
                    _ngrp=[],
                    _grp,w,h,_left,_ww,

                    layer=profile._headerLayers,
                    h=headerHeight/(layer+1),
                    flag=false;

                for(var j=0,m=arr.length,grp;j<m;j++){
                    _grp={};
                    w=0;
                    flag=false;
                    _left=0;//prop.rowHandler?(profile.$px(prop.rowHandlerWidth)+borderH):0;

                    grp=arr[j];
                    xui.UI.adjustData(profile, grp, _grp, 'sub');
                    for(var k=0,o;k<=grp['to'];k++){
                        o=header[k];p=_header[k];_ww=profile.$px(p._colWidth);
                        if(k===grp.from){
                            flag=true;
                            _grp._hcellleft=profile.$forceu(_left);
                        }
                        _left+= _ww + borderH;
                        if(flag && !o.hidden){
                            w += _ww + borderH;
                        }
                    }
                    _grp._colWidth = _grp._cellWidth = profile.$forceu(w -borderH);

                    _grp._hcellheight = profile.$forceu(h-borderH);
                    _grp._hcelltop = profile.$forceu(h*(grp._layer-1));

                    _grp._tabindex=prop.tabindex;
                    _grp.colDDDisplay = (('colResizer' in grp)?grp.colResizer:prop.colResizer)?'':NONE;

                    _ngrp.push(_grp)
                }

                // adjust base columns' height
                for(var k=0,n=header.length,o,p;k<n;k++){
                    o=header[k];p=_header[k];
                    if(o._grp && o._grp.length){
                        p._hcellheight=profile.$forceu(headerHeight - o._grp.length*h - borderH);
                    }
                }
                return _ngrp;
            }
        },
        _prepareHeader:function(profile, arr){
            var header=[], colResult;

            // init cols cache
            profile.colMap2 = {};
            profile.colMap = {};

            xui.arr.each(arr,function(o,i){
                if(profile.beforePrepareCol && false===profile.boxing().beforePrepareCol(profile, o)){
                    return;
                }
                colResult=profile.box._parepareCol(profile,o,arr,i);
                arr[i]=colResult[0];
                header.push(colResult[1]);
            });

            return header;
        },
        // to set uicell, or set dom node directly
        // uicell and node are not occur at the same time
        _renderCell:function(profile, cell, uicell, node,options){
            var getPro=profile.box.getCellOption,
                type=getPro(profile, cell, 'type'),
                t1='',
                t2='',
                caption,
                cellanode=node,
                capOut= uicell && xui.isStr(uicell._caption)?uicell._caption:uicell &&xui.isStr(cell.caption) ? uicell.caption : xui.isStr(cell.caption) ? cell.caption : null,
                reg1=/</g,
                dcls='xui-uicell-disabled',
                rcls='xui-ui-readonly',
                ren=function(profile,cell,uicell,fun){return (
                        // 1 renderer in cell
                        typeof (cell.renderer||cell._renderer)=='function'? (cell.renderer||cell._renderer).call(profile,cell) :
                        // 2 template in cell
                        (uicell && typeof uicell.caption =='string') ? uicell.caption:
                        // 3 default caption function
                        typeof fun=='function'?fun(cell.value, profile, cell):
                        // 4 value in cell 
                        (xui.isSet(cell.value)?(""+cell.value):
                        // 5 empty
                        "")
                    // default value
                    ) || ""},
                f0=function(v,profile,cell){
                    return v ? xui.Date.getText(v, getPro(profile, cell, 'dateEditorTpl')||'ymdhn') : "";
                },
                f1=function(v,profile,cell){
                    return v ? xui.Date.getText(v, getPro(profile, cell, 'dateEditorTpl')||'ymd') : "";
                },
                f2=function(v){return v?(v+'').replace(reg1,'&lt;').replace(/\t/g,'    ')/*.replace(/ /g,' ')*/.replace(/(\r\n|\n|\r)/g,"<br />"):""},
                f3=function(v){return (v||v===0) ? ((v*100).toFixed(2)+'%') : ""},
                f4=function(v,profile,cell){
                    if(v||v===0){
                        return xui.formatNumeric(
                                parseFloat(v),
                                getPro(profile, cell, 'precision'),
                                getPro(profile, cell, 'groupingSeparator'),
                                getPro(profile, cell, 'decimalSeparator'),
                                getPro(profile, cell, 'forceFillZero'),
                                getPro(profile, cell, 'trimTailZero')
                            );
                    }else
                        return "";
               },
               f5=function(v,profile,cell){
                    if(v||v===0){
                        var precision=getPro(profile, cell, 'precision');
                        return xui.formatNumeric(
                                parseFloat(v),
                                // currency default precision is 2
                                xui.isSet(precision)?precision:2,
                                getPro(profile, cell, 'groupingSeparator'),
                                getPro(profile, cell, 'decimalSeparator'),
                                getPro(profile, cell, 'forceFillZero'),
                                getPro(profile, cell, 'trimTailZero')
                            );
                    }else
                        return "";
               },
               f6=function(v,profile,cell){
                    var t=getPro(profile,cell,'editorListItems');
                    if(!t)
                        if(t=getPro(profile,cell,'editorListKey'))
                           t=xui.UI.getCachedData(typeof(t)=="function"?t():t);
                    if((typeof(t)=="function"?(t=t()):t) && t.length)
                        for(var i=0,l=t.length;i<l;i++)
                            if(t[i].id===v)
                                return t[i].caption||v;
                    return f7(v,profile,cell);
               },
               f7=function(v,profile,cell){
                   if(v){
                       v=v+"";
                        var t=v.indexOf('=');
                        if(t!=-1){
                            cell.value = v.substr(0,t);
                            return v.substr(t+1);
                        }
                   }
                    return v;
               },
               unit=function(caption, cell){return caption + (cell.unit?" "+cell.unit:"")};
            // get caption node
            if(node && node.get(0))node=node.last();
            switch(type){
                case 'number':
                case 'spin':
                case 'counter':
                    var v=parseFloat(cell.value);
                    cell.value=(v||v===0)?v:null;
                    caption=unit(capOut ||ren(profile,cell,uicell,f4), cell);
                    var tpl = getPro(profile, cell, 'numberTpl');
                    if(tpl && caption)
                        caption = tpl.replace("*", caption);
                    if(node)
                        node.html(caption,false);
                break;
                case 'currency':
                    var v=parseFloat((cell.value+"").replace(/[^\d.-]/g,''));
                    cell.value=(v||v===0)?v:null;
                    //  Note that cell value has true numeric value, while caption has currency format with commas.
                    caption=unit(capOut ||ren(profile,cell,uicell,f5),cell);
                    var tpl = getPro(profile, cell, 'currencyTpl');
                    if(tpl && caption!=="")
                        caption = tpl.replace("*", caption);
                    if(node)
                        node.html(caption,false);
                break;
                case 'date':
                    cell.value= xui.isDate(cell.value)?cell.value:xui.isFinite(cell.value)?new Date(parseInt(cell.value,10)):xui.Date.parse(cell.value);
                    caption=unit(capOut || ren(profile,cell,uicell,f1),cell);
                    if(node)
                        node.html(caption, false);
                break;
                case 'datetime':
                    cell.value= xui.isDate(cell.value)?cell.value:xui.isFinite(cell.value)?new Date(parseInt(cell.value,10)):xui.Date.parse(cell.value);
                    caption=unit(capOut || ren(profile,cell,uicell,f0),cell);
                    if(node)
                        node.html(caption, false);
                break;
                case 'input':
                    cell.value=cell.value||"";
                    caption=unit(capOut ||ren(profile,cell,uicell),cell);
                    if(node)node.html(caption,false);
                break;
                case 'textarea':
                    cell.value=cell.value||"";
                    caption=unit(capOut ||ren(profile,cell,uicell,f2),cell);
                    if(node)node.html(caption,false);
                break;
                case 'color':
                    var c=xui.UI.ColorPicker._ensureValue(0,cell.value);
                    cell.value=cell.value?((c!=="transparent"?'#':'')+c):"";
                    caption=unit(capOut ||ren(profile,cell,uicell),cell);
                    if(cell.value){
                        t1=xui.UI.ColorPicker.getTextColor(cell.value);
                        if(node){
                            node.html(caption,false);
                            node.css('color',t1);
                            node.parent().css('backgroundColor',cell.value);
                        }else{
                            uicell.color='color:'+t1+';';
                            uicell.bgcolor='background-color:'+cell.value+';';
                        }
                    }else{
                        if(node){
                            node.html(caption,false);
                            node.css('color','');
                            node.parent().css('backgroundColor','');
                        }else{
                            //uicell.color='color:#000;';
                            //uicell.bgcolor='background-color:#fff;';
                        }
                    }
                break;
                case 'checkbox':
                    cell.value=cell.value==="0"?false:!!cell.value;
                    caption=unit(cell.value+'',cell);
                    if(node)
                        node.tagClass('-checked', cell.value);
                    else{
                        uicell._fi_checkboxCls = cell.value?'xuifont-checked xui-uicmd-check-checked':'';
                     }
                break;
                case 'progress':
                    cell.value=parseFloat(cell.value)||0;
                    cell.value=Math.min(Math.max(cell.value,0),1);
                    caption=unit(capOut ||ren(profile,cell,uicell,f3),cell);
                    if(node){
                        node.first().html(caption, false);
                        node.width(caption);
                    }else
                        uicell.progress=caption;
                break;
                case 'listbox':
                    cell.value=cell.hasOwnProperty("value")?cell.value:"";
                    caption=xui.adjustRes(unit(capOut ||ren(profile,cell,uicell,f6),cell));
                    if(node)node.html((caption===null||caption===undefined)?cell.value:caption,false);
                break;
                case 'dropbox':
                case 'cmdbox':
                    cell.value=cell.hasOwnProperty("value")?cell.value:"";
                    caption=xui.adjustRes(unit(capOut ||ren(profile,cell,uicell,f7),cell));
                    if(node)node.html((caption===null||caption===undefined)?cell.value:caption,false);
                break;
                default:
                    cell.value=cell.hasOwnProperty("value")?cell.value:"";
                    caption=xui.adjustRes(unit(capOut ||ren(profile,cell,uicell),cell));
                    if(node)node.html((caption===null||caption===undefined)?cell.value:caption,false);
            }

            if('_renderer' in cell)delete cell._renderer;
            cell._caption = cell._$tips = cell._$tmpcap = caption;

            var t2=getPro(profile, cell, 'disabled'),
                t3=getPro(profile, cell, 'readonly');
            if(uicell){
                /*
                    colRenderer
                    rowRenderer

                    cellStyle
                    cellClass
                    cellRenderer

                    renderer
                    type
                    disabled
                    readonly
                    increment
                    min
                    max
                    maxlength
                    precision
                    dateEditorTpl
                    editable
                    value
                    caption
                    sortby [for column only]

                    customEditor -> an object for custom editor. or the below prop

                    editorListKey
                    editorListItems
                    editorFormat
                    editorMask
                    editorReadonly
                    editorDropListWidth
                    editorDropListHeight
                    editorProperties
                    editorCC
                    editorCS
                    editorEvents
                */
                uicell.cellCls=profile.getClass('CELL', '-'+type) + (t2?(' '+dcls):'') + (t3?(' '+rcls):'');
                uicell.type=type;
                uicell.value=cell.value;
                uicell._caption=caption;
                uicell.cellStyle=getPro(profile, cell, 'cellStyle');
                uicell.cellClass=getPro(profile, cell, 'cellClass');
            }else{
                if(t2) cellanode.parent().addClass(dcls);
                else cellanode.parent().removeClass(dcls);
                if(t3) cellanode.parent().addClass(rcls);
                else cellanode.parent().removeClass(rcls);

                if(t2=options.cellStyle)
                    cellanode.attr('style',cellanode.attr('style')+";"+t2);
                if(t2=options.cellUnclass)
                    cellanode.removeClass(t2);
                if(t2=options.cellClass)
                    cellanode.addClass(t2);
            }
            return cell;
        },
        _prepareItems:function(profile, arr, pid ,temparr){
            var self=this,
                prop=profile.properties,
                _treemode=prop.treeMode,
                mm = profile._$subMargin || (profile._$subMargin=profile.$px(prop.$subMargin)),
                a = profile.rowMap2,
                b = profile.rowMap,
                _layer=pid?b[pid]?(b[pid]._layer+1):0:0,
                SubID=xui.UI.$tag_subId,
                me=arguments.callee,
                ider = me._id||(me._id=new xui.id()),
                rows=[],
                temp,cells,t,row,v,cellResult,
                ro =  prop.rowOptions,
                itemFilter=profile.$itemFilter,
                NONE='display:none';
            
            _treemode= !(!_treemode || _treemode=="none");
            if(itemFilter)itemFilter('begin','prepareItem',profile)
            for(var i=0,l=arr.length;i<l;i++){
                row = arr[i];
                // give id (avoid conflicts)
                if(!row.id || a[row.id]){
                    while(a[t=ider.next()]);
                    row.id="-"+t;
                }else{
                    row.id+="";
                }
                if(profile.beforePrepareRow && false===profile.boxing().beforePrepareRow(profile, row, pid, temparr)){
                    continue;
                }

                // give _serialId
                temp='-r_'+profile.pickSubId('row');
                row[SubID]=temp;
                b[temp]=row;

                //#
                row._pid = pid;
                row._cells={};
                row._layer=_layer;

                row._tabindex=prop.tabindex;
                row._rowMarkDisplay=(prop.selMode=="multi"||prop.selMode=="multibycheckbox")?"":NONE;

                row._treeMode=_treemode?'':NONE;

                row._rowNumbDisplay=prop.rowNumbered?'':NONE;

                t={id: row.id};

                t.rowCls = ""
                if(row.disabled)
                    t.rowCls += ' xui-uicell-disabled';
                if(row.readonly)
                    t.rowCls += ' xui-ui-readonly';
                if(row.group){
                    t.group=1;
                    t.rowCls += ' ' + profile.getClass('CELLS1','-group') + " xui-uiborder-r xui-uiborder-light";
                }
                // filter: hidden                
                if(itemFilter)row.hidden = !!itemFilter(row,'prepareItem',profile);

                if(row.hidden)
                    t.rowDisplay=NONE;

                t._row0DfW=prop.rowHandlerWidth?('width:'+profile.$forceu(prop.rowHandlerWidth)):'';
                t._rulerW='width:'+ (row.rulerWidth || profile.$forceu(4+_layer*mm));

                // use em for row Height
                t._rowHeight = profile.$forceu(row._rowHeight || row.height || prop.rowHeight, 'em');
                row._rowHeight = t._rowHeight;
                t._rowHeight="height:"+t._rowHeight;

                t.rowHandlerDisplay=prop.rowHandler?'':NONE;
                t.rowDDDisplay=(('rowResizer' in row)?row.rowResizer:prop.rowResizer)?'':NONE;

                t.firstCellStyle=row.firstCellStyle||ro.firstCellStyle||'';
                t.firstCellClass=row.firstCellClass||ro.firstCellClass||'';

                cells = t.cells = [];

                t[SubID]=temp;
               //   t._fi_togglemark = row.sub?'xui-uicmd-toggle':(row._layer?'xui-uicmd-empty':'');
                // t._fi_togglemark = row.sub?'xui-uicmd-toggle':'';
                t._fi_togglemark = row.sub?('xui-uicmd-toggle'+(row._checked?" xuifont-checked xui-uicmd-toggle-checked":"")):(prop.togglePlaceholder?'xui-icon-placeholder':'xui-uicmd-none');

                // id to dom item id
                a[row.id]=temp;

                if(!row.hasOwnProperty('caption') && row.hasOwnProperty('value'))
                    row.caption=''+row.value;
                 
                 row._oValue=row.value;

                if(row.caption && !row.tips)
                    row._$tips=row.caption;

                xui.UI.adjustData(profile, row, t, 'sub');

                t.tagCmds = xui.clone(t.tagCmds || ro.tagCmds || prop.tagCmds);
                if(t.tagCmds){
                    this._prepareCmds(profile, t, function(item){
                        return !item.tag || !!item.tag.match(/\brow\b/);
                    });
                }

                // for cells
                if(row.group)
                    row.cells=null;
                if((v=row.cells)){
                    xui.arr.each(prop.header,function(col,j){
                        cellResult = profile.box._prepareCell(profile, v[j], row, col,temparr,t,j);
                        v[j]=cellResult[0];
                        cells.push(cellResult[1]);
                    });
                }

                var hash={};
                xui.merge(hash, t, function(o, i){
                    return xui.isNumb(o) || xui.isStr(o) || i=='ltagCmds';
                });
                hash[xui.UI.$tag_subId_c]=t[xui.UI.$tag_subId];
                t._handler_cell = xui.clone(hash);

                if(prop.treeMode=='infirstcell'){
                    if(row.group)
                        t._firstcell_grp = xui.clone(hash);

                    t._rulerW=t._fi_togglemark='';
                    t._treeMode=t.tMarkDisplay=t.tNumbDisplay=t._ltagDisplay=NONE;
                    t.ltagCmds=null;
                }
                rows.push(t);
            }
            if(itemFilter)itemFilter('end','prepareItem',profile);
            return rows;
        },
        _adjustCell:function(profile, cell, uicell){
            var self=this,
                prop=profile.properties,
                col=cell._col,
                renderer=self.getCellOption(profile, cell, 'cellRenderer'),
                cellCapTpl=self.getCellOption(profile, cell, 'cellCapTpl'),
                renderer;

            // allow to set caption dynamically
            if(cellCapTpl)
                cell._caption=cellCapTpl;
            xui.UI.adjustData(profile, cell, uicell, 'sub');

            if(renderer)
                cell._renderer=renderer;
            if(!uicell._cellWidth)
                uicell._cellWidth=col._colWidth;

            uicell._tabindex=prop.tabindex;
            uicell.cellDisplay=col.hidden===true?'display:none;':'';

            self._renderCell(profile, cell, uicell);

            //next
            cell._oValue=cell.value;
            if('unit' in cell)cell._oUnit=cell.unit;
        },
        _setSub:function(profile, item, flag, recursive, stopanim, cb){
            var id=profile.domId,
                ins=profile.boxing(),
                prop=profile.properties,
                itemId = profile.rowMap2[item.id],
                markNode = profile.box._getToggleNode(profile, itemId),
                subNs = profile.getSubNodes(['SUB1','SUB2'], itemId),

                subNs1 = xui(subNs.get(0)),
                subNs2 = xui(subNs.get(1));

            if(xui.Thread.isAlive(profile.key+profile.id)) return;
            //close
            if(!flag){
                if(item._checked){
                    if(ins.beforeFold && false===ins.beforeFold(profile,item)){
                        return;
                    }
                    var onend=function(){
                        subNs.css({display:'none', height:0, overflow:''});
                        markNode.tagClass('-checked', false);
                        item._checked = false;

                        if(prop.dynDestory || item.dynDestory){
                            var s=item.sub, arr=[];
                            for(var i=0,l=s.length;i<l;i++)
                                arr.push(s[i].id);
                            profile.boxing().removeRows(arr);
                            item.sub=true;
                            delete item._inited;
                        }
                        if(ins.afterFold)
                            ins.afterFold(profile,item);

                        xui.resetRun(id, function(cb){
                            profile.box._asy(profile);
                            //clear rows cache
                            delete profile.$allrowscache1;
                            delete profile.$allrowscache2;
                            profile.box._adjustBody(profile,'foldrow');
                            if(cb)xui.tryF(cb,[profile,item],ins);
                         },0,[cb]);
                    };
                    if(!stopanim){
                        if(prop.animCollapse) {
                            subNs.css('overflow','hidden');
                            subNs.animate({'height':[subNs2.height(),0]},null,onend, 200, null, 'expoOut', profile.key+profile.id).start();
                        }else onend();
                    }else onend();
                }
                if(recursive && item.sub && !prop.dynDestory && !item.dynDestory){
                    xui.arr.each(item.sub,function(o){
                        if(o.sub && o.sub.length)
                            profile.box._setSub(profile, o, flag, recursive, true, cb);
                    });
                }
            }else{
                //open
                if(!item._checked){
                    if(ins.beforeExpand && false===ins.beforeExpand(profile,item)){
                        return;
                    }
                    var onend=function(empty,t){
                        //markNode.css('background','');
                        // compitable with IE<8
                        if(xui.browser.ie && xui.browser.ver<=8){
                            markNode.css({
                                backgroundImage:'',
                                backgroundRepeat:'',
                                backgroundPositionX:'',
                                backgroundPositionY:'',
                                backgroundColor:'',
                                backgroundAttachment:''
                              });
                        }else{
                            markNode.removeClass('xui-icon-loading');
                        }
                        if(!empty){
                            item._checked = true;
                            if(ins.afterExpand)
                                ins.afterExpand(profile,item);
                        }
                        subNs.css({display:'',height:'auto',overflow:''});  
                        if((prop.freezedRow||prop.rowHandler) && !subNs1.height() && (t=subNs2.height()))
                            subNs1.height(t);

                       xui.resetRun(id, function(cb){
                            profile.box._asy(profile);
                            //clear rows cache
                            delete profile.$allrowscache1;
                            delete profile.$allrowscache2;
                            profile.box._adjustBody(profile,'expandrow');
                            if(cb)xui.tryF(cb,[profile,item],ins);
                        },0,[cb]);
                    },
                    openSub = function(profile, item, id, markNode, subNs1, subNs2, subNs, sub){
                        var b=profile.boxing(),
                            p = profile.properties,
                            empty = sub===false;
                        //created
                        if(!empty && !item._inited){
                            delete item.sub;
                            //before insertRows
                            item._inited=true;
                            if(sub){
                                if(typeof sub=='string'){
                                    subNs2.html(item.sub=sub,false);
                                    // right-bottom border
                                    subNs.addClass('xui-uiborder-r xui-uiborder-b xui-uiborder-light');
                                }else if(sub['xui.Template']||sub['xui.UI']){
                                    subNs2.append(item.sub=sub.render(true));
                                    // right-bottom border
                                    subNs.addClass('xui-uiborder-r xui-uiborder-b xui-uiborder-light');
                                }else if(xui.isArr(sub)){
                                    b.insertRows(sub, item.id);
                                    // for []
                                    if(!item.sub)item.sub=sub;
                                }
                                var s=0,arr=b.getUIValue(true);
                                if(arr && arr.length){
                                    xui.arr.each(sub,function(o){
                                        if(xui.arr.indexOf(arr, o.id||o)!=-1){
                                            s=1;
                                            return false;
                                        }
                                    });
                                    if(s){
                                        //set checked items
                                        b._setCtrlValue(b.getUIValue());
                                    }
                                }
                            }
                        }

                        if(!empty){
                            markNode.tagClass('-checked');
                        }

                        if(!stopanim){
                            subNs.css("height","0px").css("display",'');
                        
                            if(p.animCollapse) {
                                var h=0;
                                subNs2.children().each(function(o){
                                    h+=o.offsetHeight;
                                });
                                subNs.css('overflow','hidden');
                                subNs.animate({'height':[0,h]},null,function(){
                                    onend(empty);
                                }, 200, null, 'expoIn', profile.key+profile.id).start();
                            }else onend(empty);
                        }else onend(empty);
                    },
                    sub = item.sub,
                    callback=function(sub){
                        openSub(profile, item, id, markNode, subNs1, subNs2, subNs, sub);
                    },t;

                    if((t=typeof sub)=='string'||t=='object')
                        callback(sub);
                    else if(profile.onGetContent){
                        if(xui.browser.ie && xui.browser.ver<=8){
                            markNode.css('background','url('+xui.ini.img_busy+') no-repeat');
                        }else{
                            markNode.addClass('xui-icon-loading');
                        }
                        var r=profile.boxing().onGetContent(profile, item, callback);
                        if(r||r===false){
                            //return true: toggle icon will be checked
                            if(r===true)
                                item._inited=true;
                            callback(r);
                        }
                    }
                }
                if(recursive&& item.sub){
                    xui.arr.each(item.sub,function(o){
                        if(o.sub && o.sub.length && !o._checked)
                            profile.box._setSub(profile, o, flag, recursive, true, cb);
                    });
                }
            }
        },
        _getCellId:function(profile, rowId, colId){
            if(xui.isNumb(rowId))rowId=xui.get(profile.properties.rows,[rowId,"id"]);
            if(xui.isNumb(colId))colId=xui.get(profile.properties.header,[colId,"id"]);
            return xui.get(profile.rowMap,[profile.rowMap2[rowId], '_cells',colId]);
        },
        _updCell:function(profile, cellId, options, dirtyMark, triggerEvent, triggerFormula){
            var box=profile.box,
                prop=profile.properties,
                pdm=prop.dirtyMark,
                psdm=pdm&&prop.showDirtyMark,
                sc=xui.absObj.$specialChars,
                cell,node,ishotrow,ext;

            if(typeof cellId == 'string')
                cell = profile.cellMap[cellId];
            else{
                cell = cellId;
                cellId = cell._serialId;
            }
            if(!cell || !cell._row)return;
            ishotrow=cell._row.id==box._temprowid;
            if(ishotrow && cell.caption==prop.hotRowCellCap)
                delete cell.caption;

            if(!xui.isHash(options))options={value:options};
            options=xui.filter(options,function(o,i,r){r= !sc[i.charAt(0)]; if(!r){ext=ext||{}; ext[i]=o} return r;});
            if(triggerEvent){
                if(profile.beforeCellUpdated && false === profile.boxing().beforeCellUpdated(profile, cell, options,ishotrow,ext))
                    return;
            }
            if(!xui.isEmpty(options)){
                // * remove cell's special setting first
                delete cell._$tips;
                delete cell._$tmpcap;

                xui.merge(cell,options,'all');

                node=profile.getSubNode('CELLA', cellId);
                if('type' in options){
                    var uicell={};
                    box._adjustCell(profile, cell, uicell);
                    node.parent().replace(profile._buildItems('rows2.cells', [uicell]));
                    node=profile.getSubNode('CELLA', cellId);
                }else{
                    // allow to set caption dynamically
                    var cellCapTpl=box.getCellOption(profile, cell, 'cellCapTpl');
                    // * : only for cellCapTpl => caption
                    if(cellCapTpl)
                        cell.caption=xui.adjustRes(cellCapTpl,true,false,null,null,cell);
                    cell = box._renderCell(profile, cell, null, node, options);
                }

                var editor=cell._editor;

                //if update value
                if('value' in options){
                    if(!pdm || dirtyMark===false)
                        cell._oValue=cell.value;
                        if('unit' in cell)cell._oUnit=cell.unit;
                    else{
                        if(cell.value===cell._oValue&&( !('unit' in cell) || cell._oUnit===cell.unit)){
                            if(psdm)
                                node.removeClass('xui-ui-dirty');
                        }else{
                            if(psdm)
                                node.addClass('xui-ui-dirty');
                        }
                    }
                    if(editor)editor.setValue(cell.value,true,'editorini');
                    // formula
                    if(triggerFormula!==false)
                        xui.resetRun(profile.key+":"+profile.$xid+":"+cell.id,function(){
                            if(profile&&profile.box)profile.boxing().triggerFormulas(cell, 'updatecell');
                        });
                }
                if(('caption' in options) && editor && editor.setCaption){
                    editor.setCaption(options.caption||null,true);
                }

                cell._dirty=1;
            }
            if(triggerEvent){
                if(profile.afterCellUpdated)
                    profile.boxing().afterCellUpdated(profile,cell, options,ishotrow,ext);
            }
        },
        _ensureValue:function(profile,value){
            if(profile.properties.selMode=='multi'||profile.properties.selMode=='multibycheckbox'){
                var arr = xui.isArr(value) ? value : (value ? (''+value) : '').split(profile.properties.valueSeparator);
                // ignore hot row
                xui.arr.removeValue(arr,this._temprowid);
                arr.sort();
                return arr.join(profile.properties.valueSeparator);
            }else{
                // ignore hot row
                return value==this._temprowid?null:value;
            }
        },
        _sel:function(profile, type, src, id, e){
            var properties=profile.properties;
            if(properties.activeMode!=type)return;

            var targetId = profile.getSubId(id),
                map = type=='cell'?profile.cellMap:profile.rowMap,
                box=profile.boxing(),
                targetItem=map[targetId],
                ks=xui.Event.getKey(e),
                sid=type=='cell'?(targetItem._row.id+'|'+targetItem._col.id):targetItem.id,
                mode=properties.selMode;
            switch(mode){
            case 'none':
                box.onRowSelected(profile, targetItem, e, src, 0);
                break;
            case 'multibycheckbox':
                if(profile.keys.MARK){
                    var ck=profile.getKey(xui.Event.getSrc(e).id||""),
                        clickMark=ck==profile.keys.MARK;
                    if(!clickMark){
                        box.onRowSelected(profile, targetItem, e, src, 0);
                        break;
                    }
                }
            case 'multi':
                var value = box.getUIValue(),
                    arr = value?(''+value).split(properties.valueSeparator):[],
                    checktype=1;
                if(arr.length&&(ks.ctrlKey||ks.shiftKey||properties.noCtrlKey)){
                    //todo: give cell multi selection function
                    if(ks.shiftKey && type=='row'){
                        if(profile.$firstV._pid!=targetItem._pid)return false;
                        var items=properties.rows;
                        if(targetItem._pid){
                            var pitem=map[targetItem._pid];
                            if(pitem)items=pitem.sub;
                        }
                        var i1=xui.arr.subIndexOf(items,'id',profile.$firstV.id),
                            i2=xui.arr.subIndexOf(items,'id',targetItem.id),
                            i;
                        arr.length=0;
                        for(i=Math.min(i1,i2);i<=Math.max(i1,i2);i++)
                            arr.push(items[i].id);
                    }else{
                        if(xui.arr.indexOf(arr,sid)!=-1){
                            xui.arr.removeValue(arr,sid);
                            checktype=-1;
                        }else
                            arr.push(sid);
                    }

                    arr.sort();
                    value = arr.join(properties.valueSeparator);

                    //update string value only for setCtrlValue
                    if(box.getUIValue() != value){
                        box.setUIValue(value,null,null,'click');
                        if(box.get(0) && box.getUIValue() == value)
                            box.onRowSelected(profile, targetItem, e, src, checktype);
                    }
                    break;
                }
            case 'single':
                if(box.getUIValue() != sid){
                    profile.$firstV=targetItem;
                    box.setUIValue(sid,null,null,'click');
                    if(box.get(0) && box.getUIValue() == sid)
                        box.onRowSelected(profile, targetItem, e, src, 1);
                }
                break;
            }
        },
        _activeCell:function(profile, id){
            if(profile.properties.activeMode!='cell')return;
            if(profile.$activeCell == id)return;
            var targetCell=null;
            if(profile.$activeCell){
                xui(profile.$activeCell).tagClass('-active', false);
                delete profile.$activeCell;
            }
            if(id!==false){
                var targetId = profile.getSubId(id),
                    map = profile.cellMap;
                targetCell=map[targetId];
                if(profile.beforeCellActive && (false===profile.boxing().beforeCellActive(profile, targetCell)))return;
                xui(profile.$activeCell = id).tagClass('-active');
            }
            if(profile.afterCellActive)profile.boxing().afterCellActive(profile, targetCell);
        },
        _activeRow:function(profile, id){
            if(profile.properties.activeMode!='row')return;
            if(profile.$activeRow == id)return;
            var targetRow=null, subId;
            if(profile.$activeRow){
               subId=profile.getSubId(profile.$activeRow);
               profile.getSubNodes(['CELLS1','CELLS2'],subId).tagClass('-active', false);
               delete profile.$activeRow;
            }
            if(id!==false){
                var targetId = profile.getSubId(id),
                    map = profile.rowMap;
                targetRow=map[targetId];
                //before event
                if(profile.beforeRowActive && (false===profile.boxing().beforeRowActive(profile, targetRow)))return;
                subId=profile.getSubId(profile.$activeRow = id);
                profile.getSubNodes(['CELLS1','CELLS2'],subId).tagClass('-active');
            }
            //after event
            if(profile.afterRowActive)profile.boxing().afterRowActive(profile, targetRow);
        },
        _getCellFormula:function(profile, cell, col, row){
            var t, p=profile.properties,f1=function(t,col){
                t=xui.isStr(t) ? t : ('='+t);
                return t.replace(/(\B)(\?)([0-9]+\b)/g, '$1'+col+'$3').replace(/(\b)(_)([0-9]+\b)/g, '$1'+col+'$3');
            },f2=function(t,row){
                t=xui.isStr(t) ? t : ('='+t);
                return t.replace(/(\b[A-Z]+)(\?)(\B)/g, '$1'+row+'$3').replace(/(\b[A-Z]+)(_)(\b)/g, '$1'+row+'$3');
            };
            return (cell&&(t=cell.formula))? t
                    : (cell&&(t=cell._row)&&(t=t.formula)) ?f1(t, col) 
                    : ((t=p.rowOptions)&&(t=t.formula)) ? f1(t, col) 
                    : (cell&&(t=cell._col)&&(t=t.formula)) ? f2(t, row) 
                    : ((t=p.colOptions)&&(t=t.formula)) ?  f2(t, row) 
                    :  null ;
        },
        getCellOption:function(profile, cell, key){
            var t=cell,p=profile.properties;
            return (t && t.hasOwnProperty(key)&&xui.isSet(t[key]))?t[key]
                    :(cell&&(t=cell._row)&&t.hasOwnProperty(key)&&xui.isSet(t[key]))? t[key]
                    :((t=p.rowOptions)&&t.hasOwnProperty(key)&&xui.isSet(t[key]))? t[key]
                    :(cell&&(t=cell._col)&&t.hasOwnProperty(key)&&xui.isSet(t[key]))?t[key]
                    :((t=p.colOptions)&&t.hasOwnProperty(key)&&xui.isSet(t[key]))?t[key]
                    :((t=p)&&t.hasOwnProperty(key)&&xui.isSet(t[key]))?t[key]:null;
        },
        _trycheckrowdirty:function(profile,cell){
            if(!cell || !cell._row)return;

            xui.resetRun(profile.key+":"+profile.$xid+":"+cell._row.id,function(){
                // destroyed
                if(!profile.box)return;
                var lc=profile.$cellInEditor;
                if(cell._row && (!lc || (lc._row && lc._row!=cell._row))){
                    var dirty=false;
                    xui.arr.each(cell._row.cells,function(v){
                        if(v._oValue!==v.value||(('unit' in v) &&v._oUnit!==v.unit)){
                            dirty=true;
                            return false;
                        }
                    });
                    if(dirty && cell._row.id !=profile.box._temprowid && profile.onRowDirtied)
                        profile.boxing().onRowDirtied(profile,cell._row);
                }
            },100);
        },
        _adjusteditorW:function(profile, nodes,width){
            if(nodes){
                nodes.each(function(n,i){
                    if(!(i=n.id))return;
                    i=i.split(":")[2];
                    if(i=profile.cellMap[i])
                           if(i._editor)
                                i._editor.setWidth(width);
                });
            }
        },
        _adjusteditorH:function(profile, nodes,height){
            nodes.each(function(n,i){
                if(!(i=n.id))return;
                i=i.split(":")[2];
                if(i=profile.rowMap[i]){
                    i=i.cells;
                    for(var j in i){
                       j=i[j];
                       if(j._editor)
                            j._editor.setHeight(profile.$addpx(height, 1, j._editor.getRootNode()));
                    }
                }
            });
        },
        _editCell:function(profile, cellId, byhover, inactive){
            var cell = typeof cellId=='string'?(profile.cellMap[cellId]||profile.cellMap[profile.cellMap2[cellId]]):cellId;
            if(!cell)return;
            // real cellId
            cellId=cell._serialId;

            var box=profile.box,
                getPro=function(key){return box.getCellOption(profile, cell, key)};

            if(getPro('disabled') || getPro('readonly') ||  !getPro('editable'))return ;

            var editor,
                grid = this,
                prop = profile.properties,
                cb=profile.getRoot().contentBox(),
                type=getPro('type')||'input',
                //region = prop.freezedColumn prop.freezedRow
                col = cell._col,
                colId = col.id,
                row = cell._row,
                rowId = row.id,
                ishotrow=rowId==profile.box._temprowid,
                editMode= getPro('editMode'),
                inline=editMode=="inline"||(getPro('type')=='dropbutton'),
                baseNode = profile.getSubNode('SCROLL' + row._region + col._region),
                //baseNode = profile.getSubNode('BORDER'),
                cellNode = profile.getSubNode('CELL', cellId),
                toggleNode = prop.treeMode=='infirstcell' && profile.getSubNode('ROWTOGGLE', cellId);

            // only for first cell and, shown toggle 
            if(toggleNode && (toggleNode.isEmpty() || !toggleNode.get(0).clientWidth)){
                toggleNode=null;
            }

            if(!inline){
                //clear the prev editor
                editor = profile.$curEditor;
                if(editor)xui.tryF(editor.undo,[],editor);
                editor=null;
            }

            // -1. for special type
            if(inline && cell._editor){
                if(!inactive)cell._editor.activate();
                return;
            }else if(type=='checkbox'||type=='button'){
                if(!inactive)profile.getSubNode('CELLA', cellId).focus(true);
                return;
            }

            // 1. customEditor in cell/row or header
            if((editor = getPro('customEditor')) && typeof editor.iniEditor=='function'){
                editor.iniEditor(profile, cell, cellNode);
                if(!inactive)xui.tryF(editor.activate,[],editor);
                if(profile.onBeginEdit)
                    profile.boxing().onBeginEdit(profile, cell, editor, 'cell');
            }else{
                // 2. beforeIniEditor
                //      returns an editor(xui.UI object)
                //      or, sets $editorValue
                if(profile.beforeIniEditor){
                    editor=profile.boxing().beforeIniEditor(profile, cell, cellNode, baseNode, 'cell');
                    // if return false, dont set $curEditor
                    if(editor===false)
                        return;
                }

                // 3. for lable type only, give it an chance to customEditor/beforeIniEditor
                if(type=='label'){
                    if(!inactive)profile.getSubNode('CELLA', cellId).focus(true);
                    return;
                }

                // if beforeIniEditor doesnt return an editor
                if(!editor || !editor['xui.UI']){
                    var editorAutoPop= getPro('editorAutoPop'),
                        editorCacheKey = getPro('editorCacheKey'),
                        editorProperties = getPro('editorProperties'),
                        editorCC= getPro('editorCC'),
                        editorCS= getPro('editorCS'),
                        editorEvents = getPro('editorEvents'),
                        editorFormat = getPro('editorFormat'),
                        editorMask = getPro('editorMask'),
                        editorReadonly = getPro('editorReadonly'),
                        editorHAlign=getPro('editorHAlign'),
                        editorDropListWidth = getPro('editorDropListWidth'),
                        editorDropListHeight = getPro('editorDropListHeight'),
                        editorCommandBtn=getPro('editorCommandBtn'),
                        t,oldProp;


                    if(!inline){
                        // 4. try to get editor from cache
                        if(editorCacheKey && profile.$cache_editor[editorCacheKey])
                            editor=profile.$cache_editor[editorCacheKey];
                        if(editor && (!editor.get(0) || editor.isDestroyed()))
                            editor=nulll;
                    }
                    // 5. else, create a ComboInput Editor, and cache it
                    if(!editor){
                        var iniprop={
                            dirtyMark:false,cachePopWnd:false,left:-1000,top:-1000,position:'absolute',visibility:'hidden',zIndex:100
                        };
                        if(inline){
                            xui.merge(iniprop,{
                                left:0,
                                top:0,
                                cachePopWnd:true,
                                width:profile.$px(cell._col._colWidth)+(cb?2:1),
                                height:profile.$px(cell._row._rowHeight)+(cb?1:0),
                                visibility:'visible',
                                zIndex:100
                            },'all');
                        }
                        editor=new xui.UI.ComboInput(iniprop);
                    }
                    switch(type){
                        // input
                        // button
                        // checkbox
                        case 'number':
                        case 'spin':
                        case 'counter':
                        case 'currency':
                            editor.setType(type);
                            xui.each(xui.toArr('precision,increment,min,max,maxlength,currencyTpl,numberTpl,groupingSeparator,decimalSeparator,forceFillZero,trimTailZero,unit,units'),function(key,u){
                                v=getPro(key);
                                if(type=='currency'){
                                    if(key=='precision'&&!v)v=2;
                                }else{
                                    if(key=='precision'&&!v)v=0;
                                    if(key=='increment'&&!v)v=1;
                                }

                                if(xui.isSet(v))editor['set'+xui.str.initial(key)](v);
                            });
                            break;
                        case 'progress':
                            editor.setType('spin').setMax(1).setMin(0).setPrecision(4).setIncrement(0.01);
                            break;
                        case 'input':
                            editor.setType('none');
                            break;
                        case 'textarea':
                            editor.setType('none').setMultiLines(true).setCommandBtn('save').onCommand(function(p){
                                p.boxing().hide();
                            });
                            if(!inline)
                                xui.tryF(editor.setResizer,[true],editor);
                            break;
                        case 'date':
                        case 'datetime':
                            var dateEditorTpl=getPro('dateEditorTpl');
                            if(dateEditorTpl)
                                editor.setDateEditorTpl(dateEditorTpl);
                        case 'listbox':
                        case 'combobox':
                        case 'helpinput':
                        case 'time':
                        case 'color':
                        case 'getter':
                        case 'popbox':
                        case 'dropbutton':
                        case 'cmdbox':
                            editor.setType(type);
                            if(profile.box.getCellOption(profile, cell,'disabled')){
                            }else{
                                editor.beforeComboPop(function(editorprf, pos, e, src){
                                    var cell=editorprf.$cell,event=profile.box.getCellOption(profile, cell, 'event');
                                    if(typeof event == 'function')
                                        return event.call(profile._host||profile, profile, cell, editorprf, pos,e,src);
                                    else
                                        return profile.boxing().beforeComboPop(profile, cell, editorprf, pos, e, src);
                                });
                                if(profile.beforePopShow)
                                    editor.beforePopShow(function(editorprf, popCtl, items){
                                        return profile.boxing().beforePopShow(profile, editorprf.$cell, editorprf, popCtl, items);
                                    });
                                if(profile.afterPopShow)
                                    editor.afterPopShow(function(editorprf, popCtl){
                                        return profile.boxing().afterPopShow(profile, editorprf.$cell, editorprf, popCtl);
                                    });
                                if(type=='popbox' || type=='cmdbox' || type=='getter' || type=='dropbutton'){
                                    if(profile.onEditorClick)
                                        editor.onClick(function(prf, e, src, btn){
                                            return profile.boxing().onEditorClick(profile, prf.$cell, prf, btn, src);
                                        });
                                }
                            }
                            break;
                        case 'file':
                            editor.setType(type);
                        break;
                    }
                    if(profile.onCommand)
                        editor.onCommand(function(editorprf, node, type){
                            return profile.boxing().onCommand(profile, editorprf.$cell, editorprf, node, type);
                        });

                   cell._editor = editor;
                   if(inline){
                       cellNode.append(editor);
                    }else{
                        baseNode.append(editor);
                    }
                    //cache the stantdard editor
                    if(!inline && editorCacheKey)
                        profile.$cache_editor[editorCacheKey] = editor;

                    if(editor.setInputReadonly)
                        editor.setInputReadonly(!!editorReadonly);
                    if(editor.setDropListWidth && editorDropListWidth)
                        editor.setDropListWidth(editorDropListWidth);
                    if(editor.setDropListHeight && editorDropListHeight)
                        editor.setDropListHeight(editorDropListHeight);
                    if(editor.setHAlign&&editorHAlign)
                        editor.setHAlign(editorHAlign);
                    if(editor.setCommandBtn&&editorCommandBtn)
                        editor.setCommandBtn(editorCommandBtn);
                    if(editorFormat){
                        if(typeof editorFormat=='function' && editor.beforeFormatCheck)
                            editor.beforeFormatCheck(editorFormat);
                        else if(typeof editorFormat=='string' && editor.setValueFormat)
                            editor.setValueFormat(editorFormat);
                    }
                    if(editorMask && editor.setMask)
                        editor.setMask(editorMask);
                    if(editorProperties){
                        oldProp={}
                        var h=profile.getProperties();
                        xui.each(editorProperties,function(o,i){
                            oldProp=h[i];
                        });
                        editor.setProperties(editorProperties);
                    }
                    if(editorCC)
                        editor.setCustomClass(xui.clone(editorCC,2));
                    if(editorCS)
                        editor.setCustomStyle(xui.clone(editorCS,2));
                    if(editorEvents)
                        editor.setEvents(editorEvents);
                    if(!inline){
                        // clear for valueFormat, setValue maybe cant set value because of valueFormat
                        editor.resetValue();
                    }
                    //set properities
                    switch(type){
                        case 'listbox':
                        case 'combobox':
                        case 'helpinput':
                            // set properties
                            if(t=getPro('editorListItems')){
                                editor.setListKey(null);
                                editor.setItems(typeof(t)=="function"?t():t);
                            }else if(t=getPro('editorListKey')) {
                                editor.setItems(null);
                                editor.setListKey(typeof(t)=="function"?t():t);
                            }
                            break;
                    }

                    // must set value here, after setItems/setListKey
                    //$editorValue must be set in beforeIniEditor
                    editor.setValue(xui.isSet(cell.$editorValue)?cell.$editorValue:cell.value,true,'editorini');
                    delete cell.$editorValue;

                    if(editor.setCaption){
                        if(editorProperties&&('caption' in editorProperties)&& xui.isDefined(editorProperties.caption)){
                            editor.setCaption(editorProperties.caption,true);
                        }else  if(type=="cmdbox"||type=="popbox"||type=="button"||type=="dropbutton"){
                            editor.setCaption(cell._caption||cell._$tmpcap||cell.caption||"",true);
                        }
                    }
                    //$tag for compatible
                    if(cell.$tag){
                        if(editor.setCaption)editor.setCaption(cell.$tag);
                        else if(editor.setValue)editor.setValue(cell.$tag,null,'editortag');
                    }
                    //give a reference
                    editor.get(0).$cell = cell;
                    editor.get(0)._smartnav=true;

                    //undo function is a must
                    editor.undo=inline?null:function(refocus, inactive){
                        var editor=this;
                        // execute once
                        editor.undo=null;
                        // row dirty alert
                        if(profile.box)
                            profile.box._trycheckrowdirty(profile,profile.$cellInEditor);
                        if(!inactive){
                            if(editor.get(0) && editor.get(0).box){
                                // for ie's setBlurTrigger doesn't trigger onchange event
                                editor.getSubNode('INPUT').onBlur(true);

                                if(refocus && xui.str.endWith(editMode,"sharp")){
                                   cell._ignorefocus=1;
                                   profile.boxing().focusCell (profile.$cellInEditor);
                                   xui.asyRun(function(){
                                        delete cell._ignorefocus;
                                   });
                                }
                            }
                            editor.getRoot().setBlurTrigger(profile.$xid+":editor");
                            if(profile.properties && !profile.properties.directInput){
                                editor.beforeUnitUpdated(null).afterUIValueSet(null).beforeNextFocus(null).onCancel(null).afterPopHide(null);
                                editor.setValue('',true,'editorreset');
                            }
                            // clear those setting
                            if(editorFormat){
                                if(editor.beforeFormatCheck)editor.beforeFormatCheck(null);
                                if(editor.setValueFormat)editor.setValueFormat('');
                            }
                            if(editorMask)
                                if(editor.setMask)editor.setMask('');
                            if(editor.setInputReadonly)editor.setInputReadonly(!editorReadonly);
                            if(editorDropListWidth)
                                if(editor.setDropListWidth)editor.setDropListWidth(0);
                            if(editorDropListHeight)
                                if(editor.setDropListHeight)editor.setDropListHeight(0);
                            if(oldProp){
                                editor.setProperties(oldProp);
                                oldProp=null;
                            }
                            delete editor.get(0).$cell;
                            delete editor.get(0)._smartnav;
                            //don't use disply:none, firfox has many bugs about Caret or renderer
                            editor.hide();

                            if(xui.isFun(editor.collapse))editor.collapse();
                        }
                        if(editorEvents){
                            var h={};
                            xui.each(editorEvents,function(o,i){
                                h[i]=null;
                            });
                            editor.setEvents(h);
                        }
                        profile.$curEditor=null;
                        profile.$cellInEditor=null;
                        if(profile.onEndEdit)
                            profile.boxing().onEndEdit(profile, cell, editor, 'cell');

                        // don't cache it
                        if(!editorCacheKey && editor.get(0)){
                            editor.destroy(true);
                        }
                        cell._editor=editor=null;
                    };
                    var g1=profile.boxing(),pos=g1.getCellPos(cell),cc,nc,
                        _getcell=function(editorPrf){
                            if(pos) return g1.getCellbyRowCol(pos.row, pos.col);
                            else return editorPrf.$cell;
                        };

                    //editor change value, update cell value
                    editor
                    .beforeUnitUpdated(function(editorPrf,v){
                        cc=_getcell(editorPrf);
                        if(profile.beforeUnitUpdated&&false===g1.beforeUnitUpdated(profile, cc, editorPrf, v))
                            return false;
                        grid._updCell(profile, cc, {value:cc.value, unit: v},profile.properties.dirtyMark,true,true);
                        if((nc=_getcell(editorPrf)) && nc!==cc){
                            editorPrf.$cell = nc
                            nc._editor=editor;
                            if(!inline){
                                profile.$cellInEditor=nc;
                            }
                        }
                    })
                    .afterUIValueSet(function(editorPrf,oV,nV,force,tag){
                        var type=getPro('type'),caption;
                        switch(type){
                            case 'number':
                            case 'spin':
                            case 'counter':
                            case 'progress':
                                nV=parseFloat(nV);
                                nV=(nV||nV===0)?nV:null;
                                break;
                            case 'currency':
                                nV=parseFloat((''+nV).replace(/[^\d.-]/g,''));
                                nV=(nV||nV===0)?nV:null;
                                break;
                            case 'cmdbox':
                            case 'button':
                            case 'dropbutton':
                            case 'popbox':
                            case 'combobox':
                            case 'listbox':
                            case 'helpinput':
                                caption=editorPrf.boxing().getShowValue();
                                break;
                        }
                        var options={
                            value:nV
                        };

                        if(xui.isDefined(caption))
                            options.caption=caption;

                        if(editorPrf.properties.hasOwnProperty("tagVar") && !xui.isEmpty(editorPrf.properties.tagVar))
                            options.tagVar=editorPrf.properties.tagVar;

                        cc=_getcell(editorPrf);
                        if(false!==(profile.beforeEditApply&&profile.boxing().beforeEditApply(profile, cc, options, editor, tag, 'cell'))){
                            grid._updCell(profile, cc, options, profile.properties.dirtyMark, true, true);
                            if((nc=_getcell(editorPrf)) && nc!==cc){
                                editorPrf.$cell = nc
                                nc._editor=editor;
                                if(!inline){
                                    profile.$cellInEditor=nc;
                                }
                            }

                            if(xui.str.endWith(editMode,"sharp") && type!='spin' && type!='counter'){
                                xui.tryF(editor.undo,[true],editor);
                            }
                        }
                    })
                    .beforeNextFocus(function(editorPrf, e){
                        if(editor.undo)
                            xui.tryF(editor.undo,[true],editor);
                        var hash=xui.Event.getEventPara(e);
                        // fake 'right' key
                        if(hash.key=='enter')hash.$key='right';
                        profile.getSubNode('CELLA', cell._serialId).onKeydown(true,hash);
                        //prevent
                        return false;
                    })
                    .onFileDlgOpen(function(editorPrf,src){
                        if(profile.onFileDlgOpen)profile.boxing().onFileDlgOpen(profile,cell,editorPrf,src);
                    });

                    if(!inline){
                        editor
                        .onCancel(function(){
                            if(editor)
                                xui.tryF(editor.undo,[],editor);
                        })
                        .afterPopHide(function(p,r,type){
                            if(xui.str.endWith(editMode,"sharp"))
                                xui.tryF(editor.undo,[type!="blur"&&type!="call"],editor);
                        })
                        .getRoot().setBlurTrigger(profile.$xid+":editor", function(){
                            if(editor)
                                xui.tryF(editor.undo,[],editor);
                            return false;
                        });

                        var absPos=cellNode.offset(null, baseNode),
                            size = cellNode.cssSize(),
                            absPos2 = toggleNode?toggleNode.offset(null, cellNode):null,
                            w2 = toggleNode?toggleNode.width():null;
                        if(absPos2)absPos2.left+=w2;
                        // too small
                        if(  toggleNode && (absPos2.left > size.width - 8))return;
 
                        //show editor
                        if(type=='textarea'){
                            editor.setWidth(Math.max(200,size.width  - (toggleNode?absPos2.left:0)  +(cb?3:0))).setHeight(Math.max(100,size.height +(cb?2:0)))
                            .reLayout(true,true)
                            .reBoxing()
                            .popToTop(cellNode, 4, baseNode);
                        }else{
                            //**toggleNode
                            editor.setWidth(size.width  - (toggleNode?absPos2.left:0)  +(cb?3:0)).setHeight(size.height +(cb?2:0)).reLayout(true);
                            editor.reBoxing().show((absPos.left + (toggleNode?absPos2.left:0)  -(cb?1:0))+'px',(absPos.top -(cb?1:0))+'px');
                        }

                        var expand,
                            noInputType = type=='cmdbox'||type=='cmdbox'|| type=='listbox'||type=='file',
                            insPopType = noInputType || type=='date' || type=='time' || type=='datetime' || type=='color',
                            inputReadonly = editor.getInputReadonly && editor.getInputReadonly(),
                        issharp = xui.str.endWith(editMode,"sharp")  && (editorAutoPop || inputReadonly || insPopType);
                        if(!inactive){
                            if( xui.isFun(editor.expand) 
                                && editorAutoPop!==false
                                && ( issharp || ((xui.str.endWith(editMode,"sharp") || editMode=="focus") &&   (editorAutoPop || noInputType)))
                             ) {
                                expand=1;
                                editor.expand(cellNode,false,null);
                             }
                        }
                        editor.get(0).$editMode=editMode;

                        if(!inline)
                            editor.setVisibility(issharp ? "hidden" : "visible");
                       //activate editor
                        if(!xui.str.startWith(editMode,"hover") || !byhover){
                            if(!inactive){
                                xui.asyRun(function(){
                                    // destroyed
                                    if(!profile.box)return;
                                    var target=editor;
                                    if(target.get(0)&&target.get(0).box){
                                        if(expand && editor.getPopWnd)
                                            target = editor.getPopWnd();
                                        if(target){
                                            xui.tryF(target&&target.activate,[],target);
                                            target.get(0)._stopmouseupcaret=1;
                                        }
                                    }
                                });
                            }
                        }else{
                            var bfun=function(){
                                if(editor)editor.getRoot().onMouseout(null,"tg-hover-edit");
                            },cfun=function(){
                                if(editor)editor.getRoot().onMouseout(function(){
                                    if(editor) xui.tryF(editor.undo,[],editor);
                                },"tg-hover-edit");
                            },dfun=function(){
                               // if(editor) xui.tryF(editor.undo,[],editor);
                            };
                            editor.onFocus(bfun).beforePopShow(function(editorPrf, popCtl,items){
                                bfun();
                                editor.onBlur(null);
                                // for compitable
                                if(profile.beforePopShow)
                                    return profile.boxing().beforePopShow(profile, editorPrf.$cell, editorPrf, popCtl, items);
                            }).afterPopHide(function(){
                                cfun();
                                editor.onBlur(dfun);
                            }).onBlur(dfun);

                            if(!inactive&& !expand)
                                xui.tryF(editor&&editor.activate,[],editor);
                        }
                    }
                    if(profile.onBeginEdit)
                        profile.boxing().onBeginEdit(profile, cell, editor, 'cell');
                }
            }
            if(!inline){
                //give a reference
                profile.$curEditor=editor;
                profile.$cellInEditor=cell;
            }
            if(ishotrow){
                profile.__needchecktmprow=true;
                profile.box._sethotrowoutterblur(profile);
            }
        },
        _adjustBody:function(profile, trigger, callback){
            if(!profile.renderId || profile.destroyed)return;
            xui.resetRun(profile.$xid+'4',function(){
                // destroyed
                if(!profile.renderId || profile.destroyed)return;
                
                var prop = profile.properties,
                    us = xui.$us(prop),
                    adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                    size = profile.getSubNode("BORDER").cssSize(),
                    _border = profile.getRoot().contentBox()?2:0,
                    width = profile.$px(size.width),
                    height = profile.$px(size.height),

                    //left region
                    w1 = prop.rowHandler?(profile.$px(prop.rowHandlerWidth) + _border):0,
                    w2,
                    h1 = profile.getSubNode('HEADER1'),
                    h2 = profile.getSubNode('HEADER2'),
                    b12 = profile.getSubNode('BODY12'),
                    b21 = profile.getSubNode('BODY21'),
                    s11 = profile.getSubNode('SCROLL11'),
                    s12 = profile.getSubNode('SCROLL12'),
                    s21 = profile.getSubNode('SCROLL21'),
                    s22 = profile.getSubNode('SCROLL22'),
                    rh = h2.height(),
                    rr = b12.height();

                // adjust width
                // left region
                if(prop.freezedColumn){
                    xui.arr.each(prop.header,function(col,i){
                        if(i==prop.freezedColumn)return false;
                        if(!col.hidden)w1 += profile.$px(col.width) + _border;
                    });
                }
                // for border-bottom
                if(rr && prop.freezedRow)rr-=1;
                // for border-right
                if(w1 && prop.freezedColumn)w1-=1;

                w2 = width - w1;
                profile._leftregionw = w1;

                //h1.width(adjustunit(w1));
                //s21.width(adjustunit(w1));
                h2.width(adjustunit(w2));
                s22.width(adjustunit(w2));

                // for scroll sync
                xui.asyRun(function(){
                    // separated read/write 
                    var b21e=b21.isEmpty(),
                        s21e=s21.isEmpty(),
                        b12e=b12.isEmpty(),
                        s12e=s12.isEmpty(),
                        fr=prop.freezedRow,
                        pb=!s21e?((s22.isScrollBarShowed('x')?xui.Dom.getScrollBarSize():0) + 'px'):'',
                        st=!s21e?s22.scrollTop():0,
                        sl=(fr&&!s12e)?s22.scrollLeft():0,
                        pr=(fr&&!b12e)?((s22.isScrollBarShowed('y')?xui.Dom.getScrollBarSize():0) + 'px'):'';

                    if(!b21e)b21.css('padding-bottom', pb);
                    if(fr&&!b12e)b12.css('padding-right', pr);
                    if(!s21e)s21.scrollTop(st);
                    if(fr&&!s12e)s12.scrollLeft(sl);
                },100);

                // adjust height
                s11.height(rr?adjustunit(rr):0);
                s12.height(rr?adjustunit(rr):0);
                s21.height(adjustunit(height - rh - rr));
                s22.height(adjustunit(height - rh - rr));

                // avoid onmouseout of CELLS2 trigger CELLS1 scroll to top
                s11.css('display',rr&&profile._leftregionw?'':'none');
                s12.css('display',rr?'':'none');
                s21.css('display',profile._leftregionw?'':'none');

                // others
                s22.css('overflow','hidden');
                var overflowX=profile.box._adjustRelWith(profile);

                var body=profile.getSubNode('ROWS22'),
                    header=profile.getSubNode('HCELLS2'),
                    cols=profile.properties.header,
                    scroll=profile.getSubNode('SCROLL22'),
                    t,l,last,keys=profile.keys,ww,bw,hiw,bodyw;

                if(body.get(0).clientHeight){
                    if(header.get(0).clientHeight){
                        if(t=header.get(0).childNodes){
                            l=t.length;
                            while(l){
                                if(t[l-1].clientHeight){
                                    last=t[l-1];
                                    break;
                                }
                                --l;
                            }
                        }
                        ww=last?(last.offsetWidth+last.offsetLeft+100):0;
                        hiw = adjustunit(ww);
                        bodyw = adjustunit(bw=ww);
                    }else{
                        if(t=body.get(0).childNodes){
                            l=t.length;
                            while(l){
                                if(t[l-1].clientHeight){
                                    last=t[l-1];
                                    break;
                                }
                                --l;
                            }
                            if(last){
                                var sid=profile.getSubId(last.id);
                                t=profile.getSubNode('CELLS2',sid);
                                if(t=t.get(0).childNodes){
                                    l=t.length;
                                    while(l){
                                        if(t[l-1].clientHeight){
                                            last=t[l-1];
                                            break;
                                        }
                                        --l;
                                    }
                                }
                            }
                        }
                    }
                }

                if(last){
                    bodyw=adjustunit(bw = last.offsetLeft);
                }else{
                    var prop = profile.properties,hd=prop.header,rows=prop.rows,
                    //defult
                    w = 0;
                    xui.arr.each(hd,function(o){
                        if(o.hidden!==true)
                            w += ('_colWidth' in o) ? profile.$px(o._colWidth) : (profile.$px(o.width) + _border);
                    });
                    bodyw = adjustunit(bw=w);
                }
                t=last=null;

                //HI 
                if(hiw)header.parent().width(hiw);
                if(bodyw)body.width(bodyw);

                // must use 'auto' for Android
                scroll.css('overflow','auto');

                if(bw>scroll.width()+_border){
                    overflowX="auto";
                }

                scroll.css('overflowX', overflowX);

                scroll.onScroll();

                if(profile.onBodyLayout)
                    profile.boxing().onBodyLayout(profile, trigger);

                if(callback)callback();
            });
            // formula
            if(trigger!='render' && trigger!='rowhandler' && trigger!='foldrow' && trigger!='expandrow' && trigger!='setcol' && trigger!='resize')
                xui.resetRun(profile.key+":"+profile.$xid,function(){
                    if(profile&&profile.box)profile.boxing().triggerFormulas(null, trigger);
                });
        },
        _adjustHeader:function(arr){
            var a=xui.copy(arr),m;
            xui.arr.each(a,function(o,i){
                //id will be adjusted in _prepareHeader
                a[i]=xui.copy(o);
            });
            return a;
        },
        _adjustGrpColsData:function(profile,arr){
            if(!xui.isArr(arr))return xui.copy(arr);

            var prop=profile.properties,
                header=prop.header,
                len=header.length,
                slen=(len+'').length,
                SubID=xui.UI.$tag_subId,
                a=xui.copy(arr,function(o){
                    o.from=parseInt(o.from,10)||0;
                    o['to']=parseInt(o['to'],10)||0;
                    return o.from<=len && o['to']<=len && o['to']>=o.from;
                });

            xui.arr.each(a,function(o,i){
                a[i]=xui.isHash?xui.copy(o):{};
            });
            xui.arr.stableSort(a,function(x,y){
                // desc by from, aesc by to
                return x.from>y.from?1:x.from==y.from?(x['to']>y['to']?-1:x['to']==y['to']?0:1):-1;
            });
            for(var j=0,m=a.length,grp;j<m;j++){
                grp=a[j];
                grp[SubID]=grp[SubID]||('-g_'+profile.pickSubId('grpCol'));
                grp.id=grp.id||grp[SubID];
                if(!grp.caption)grp.caption=grp.id;
                grp._isgroup=1;
                delete grp._grp;

                profile.colMap[grp[SubID]]=grp;
                profile.colMap2[grp.id]=grp[SubID];
            }
            xui.arr.each(a,function(o,i){
                for(var j=0;j<i;j++){
                    // across
                    if(a[i]['to'] > a[j].from && a[i].from < a[j]['to']){
                        // cut
                        if(a[i]['to'] > a[j]['to'])a[i]['to'] = a[j]['to'];
                        // record it
                        (a[i]._grp||(a[i]._grp=[])).push(a[j].id);
                    }
                }
            });
            xui.arr.each(header,function(o){
                delete o._grp;
            });

            var layer=0;
            // calculate layers
            for(var j=0,m=a.length,grp,o;j<m;j++){
                grp=a[j];
                for(var i=grp.from;i<=grp['to'];i++){
                    o=header[i];
                    (o._grp||(o._grp=[])).push(grp.id);
                    if(!grp._layer){
                        grp._layer=o._grp.length;
                    }
                    layer=Math.max(layer,grp._layer);
                }
            }
            profile._headerLayers = layer;
            return a;
        },
        _adjustRows:function(profile, arr, ignoreMixColumn){
            var a,m,h={},hvalue={},hcap={},p=profile.properties,uid=p.uidColumn,key,keys, mixcol,rheader=[];
            if(uid)uid=xui.arr.subIndexOf(p.header,'id',uid);
            else uid=-1;

            xui.arr.each(p.header,function(c,i){
                key=c.id||c;
                keys=null;
                if(!ignoreMixColumn && key.indexOf(":")!=-1){
                    keys=key.split(':');
                }
                if(keys && keys[0] && keys[1]){
                    hvalue[keys[0]]=hcap[keys[1]]=i;
                    rheader.push(keys[0], keys[1]);
                    mixcol=1;
                }else{
                    h[key]=i;
                    rheader.push(key);
                }
            });

            if(xui.isArr(arr) && arr.length && typeof arr[0] !='object')a=[arr];
            else a=xui.copy(arr);

            xui.arr.each(a,function(o,i){
                //id will be adjusted in _prepareItems
                if(xui.isArr(o))a[i]={cells:xui.copy(o)};
                else a[i]=xui.copy(o);

                // there's mix column
                if(mixcol && xui.isArr(a[i].cells)){
                    var cells1=a[i].cells,cells2=[],col;
                    for(var j=0,l=rheader.length;j<l;j++){
                        col=rheader[j];
                        if(col in h)cells2.push(cells1[j]);
                        else{
                            if(col in hvalue){
                                cells2.push({
                                    value:cells1[j],
                                    caption:cells1[++j]
                                });
                            }
                        }
                    }
                    a[i].cells=cells2;
                }

                // check if it's a map row data
                //1 > {col:value} 2 >{cells:{col:value}}
                var tt = (xui.isHash(a[i]) && (!a[i].cells || !xui.isObj(a[i].cells))) ? 1 : (a[i].cells && xui.isHash(a[i].cells)) ? 2: 0;
                if(!o.group && tt){
                    var cells=[], hash;
                    xui.each(tt==1?a[i]:a[i].cells,function(v,i){
                        if(i in h)cells[h[i]]=xui.isHash(v)?v:{value:v};
                        else{
                            if(i in hvalue){
                                hash=cells[hvalue[i]]||{};
                                hash.value=v;
                                cells[hvalue[i]]=hash;
                            }
                            if(i in hcap){
                                hash=cells[hcap[i]]||{};
                                hash.caption=v;
                                cells[hcap[i]]=hash;
                            }                            
                        }
                    });
                    a[i].cells=cells;
                }
 
                xui.arr.each(m = a[i].cells, function(o,i){
                    if(xui.isDefined(o)){
                        //It's a hash
                        if(!!o && xui.isHash(o))
                            m[i]=xui.copy(o);
                        // not a hash
                        else
                            m[i]={value:o};
                    }
                });
                // set uidColumn cell's value to row id 
                if(!('id' in a[i]) && uid!=-1 && m[uid]&& m[uid].value){
                    a[i].id=m[uid].value;
                }
            });
            return a;
        },
        _adjustColsWidth:function(profile){
            var prop=profile.properties,
                header=prop.header,
                arr=prop.grpCols,
                border=profile.getRoot().contentBox()?2:0;

            if(prop.showHeader){
                if(arr && xui.isArr(arr)&& arr.length){
                    var _left,_l,_w,flag=false,_ww,
                         _l2=0;
                    for(var j=0,m=arr.length,grp,n;j<m;j++){
                        _l=_w=0;
                        flag=false;
                        grp=arr[j];
                        _left=0;
                        for(var k=0,o;k<=grp['to'];k++){
                            o=header[k];
                            _ww=profile.$px(o._colWidth,null,true);
                            // for the main region
                            if(prop.freezedColumn && prop.freezedColumn==k && !_l2){
                                _l2 = _left;
                            }
                            if(k===grp.from){
                                flag=true;
                                _l=_left;
                            }
                            _left+= _ww + border;
                            if(flag && !o.hidden){
                                _w += _ww + border;
                            }
                        }
                        n=profile.getSubNode("HCELL",grp._serialId);
                        if(_w>border){
                            n.css({display:'',left:profile.$forceu(_l - (prop.freezedColumn
                                                                        ? (grp['to'] > prop.freezedColumn - 1 
                                                                                ? _l2 
                                                                                : (prop.rowHandler ? -(profile.$px(prop.rowHandlerWidth)+border) : 0) 
                                                                            )
                                                                        : 0
                                                                    )
                                                          ), width:profile.$forceu(_w-border)});
                        }else{
                            n.css({display:'none'});
                        }
                        if(prop.freezedColumn && prop.rowHandler && grp._shadow){
                            n=profile.getSubNode("HSCELL",grp._serialId);
                            if(_w>border){
                                n.css({display:'',
                                    left: profile.$forceu(_l + (profile.$px(prop.rowHandlerWidth)+border) ) , 
                                    width:profile.$forceu(_w-border)
                                });
                            }else{
                                n.css({display:'none'});
                            }
                        }
                    }
                }
            }
        },
        // use em here
        _adjustColsHeight:function(profile, force){
            var map=profile.colMap,
                map2=profile.colMap2,
                _layers=profile._headerLayers,
                headerh=profile.properties.headerHeight,
                h=profile.$px(headerh,0,true),
                cacuH=profile.$px(profile.box.$DataModel.headerHeight.ini,0,true)*(_layers+1),
                border=profile.getRoot().contentBox()?2:0,
                tt,l,th,col,rt,rh,upper,grpcolsh,h2;
            // ensure height here
            if(force||h<cacuH){
                h=cacuH;
            }
            
            profile.getSubNodes(['HCELLS1','HCELLS2','GRPCELLBOX1','GRPCELLBOX2']).height(profile.$px2em(h)+'em');
            h2=profile.$px2em(h-border)+"em";
            profile.getSubNode('FHCELL').css({height:h2});
            if(!_layers){
                 profile.getSubNode('HCELL',true).css({height:h2});
                // if(xui.browser.ie6) // ignore ie6 here
                //    profile.getSubNode('HCELLA',true).css({'line-height':h2});
            }else{
                th=h/(_layers+1);
                profile.getSubNode('HCELL',true).each(function(o){
                    col=profile.getSubId(o.id);
                    if(col=map[col]){
                        // group
                        if(col&&col._isgroup){
                            upper=0;
                            for(var i in map){
                                tt=map[i];
                                if(tt._isgroup && tt._layer<col._layer && tt. from <=col['to'] && tt['to']>=col['from']){
                                    upper += profile.$px(tt.height || th);
                                }
                            }
                            xui(o).top(profile.$px2em(upper)+'em');
                            rh = profile.$px(col.height || th);
                        }else{
                            if(col._grp&&(l=col._grp.length)){
                                grpcolsh=0;
                                for(var i=0;i<l;i++){
                                    if(tt=map2[col._grp[i]]){
                                        grpcolsh += profile.$px(map[tt].height || th);
                                    }
                                }
                                rh = h - grpcolsh;
                            }else
                                rh = h;
                        }
                        xui(o).height(profile.$px2em(rh-border)+'em');
                        
                        if(col && col._isgroup && col._shadow){
                            o=profile.getSubNode("HSCELL",col._serialId);
                            xui(o).top(profile.$px2em(upper)+'em');
                            xui(o).height(profile.$px2em(rh-border)+'em');
                        }
                    }
                });
            }
        },
         _focuscell:function(profile, e, src){
            if(profile.properties.disabled||profile.properties.readonly)return;
            if(!xui.use(src).get(0))return;
            // ensure call _focuscell once when click
            if(!profile.$_ensureOnce){
                profile.$_ensureOnce=1;
                xui.asyRun(function(){
                    profile.$_ensureOnce=0;
                });
            }else return;

            var p = profile.properties,
                box=profile.box,
                getPro=box.getCellOption,
                cell = profile.cellMap[profile.getSubId(src)],
                mode = p.activeMode, id;

            if(cell && cell._ignorefocus)return;

            if(cell){
                var edit=false,type=getPro(profile, cell, "type");
                if(getPro(profile, cell, 'editable')){
                    if(getPro(profile, cell, 'disabled')||getPro(profile, cell, 'readonly')){
                        edit=false;
                    }else{
                        edit=true;
                        if((getPro(profile, cell, 'editMode')=="inline"&&type!=='label')|| type=='dropbutton'){
                            if(cell._editor)cell._editor.activate();
                        }else{
                            box._editCell(profile, cell._serialId);
                            xui(src).parent().tagClass('-active', false);
                            xui.asyRun(function(){
                                // destroyed
                                if(!profile.box)return;
                                xui.use(src).parent().onMouseout(true,{$force:true})
                                          .parent().onMouseout(true,{$force:true});
                            });
                        }
                    }
                }
                // if not in edit mode
                if(!edit){
                    if(cell && mode=='cell'){
                        id = xui.use(src).parent().id();
                        box._activeCell(profile, id);
                    }
                }else{
                    if(cell && mode=='cell'){
                        box._activeCell(profile, false);
                    }
                }
            }else{
                var row = profile.rowMap[profile.getSubId(src)];
                if(getPro(profile, row, 'editable')){
                    if(getPro(profile, row, 'disabled')||getPro(profile, row, 'readonly')){
                    }else{
                        profile.boxing().editFirstCell(row);
                    }
                }
            }
            if(mode=='row'){
                id = xui.use(src).parent(2).id();
                box._activeRow(profile, id);
            }
        },
        _getToggleNode:function(profile, rowId){
            return profile.getSubNode('ROWTOGGLE', rowId);
        },
        _showTips:function(profile, node, pos){
            if(profile.properties.disableTips)return;
            if(profile.onShowTips)
                return profile.boxing().onShowTips(profile, node, pos);
            if(!xui.Tips)return;

            var ks=profile.keys,item,sid,id,pid,ppid;
            if(profile.properties.disabled)return;

            id=node.id;
            pid=xui.get(node,["parentNode","id"])||"";
            ppid=xui.get(node,["parentNode","parentNode","id"])||"";
            sid=profile.getSubId(id);

            if(id.indexOf(ks.FHCELL)==0||pid.indexOf(ks.FHCELL)==0||ppid.indexOf(ks.FHCELL)==0)
                item = {tips:profile.properties.tips};
            else if(id.indexOf(ks.FCELL)==0 || pid.indexOf(ks.FCELL)==0)
                item = profile.rowMap[sid];
            else if(id.indexOf(ks.HCELL)==0 || id.indexOf(ks.HSCELL)==0 || pid.indexOf(ks.HCELLA)==0)
                item = profile.colMap[sid];
            else if(id.indexOf(ks.CELL)==0 || pid.indexOf(ks.CELLA)==0)
                item = profile.cellMap[sid];

            if(item){
                xui.Tips.show(pos, ('tips' in item)?item.tips:(item._$tips||item._caption||item.caption));
                return false;
            }else
                return true;
        },
        _adjustRelWith:function(profile){
            var prop=profile.properties,
                _ww,
                cols=profile.colMap,
                t2=profile.getSubNode('SCROLL22'),
                t3=profile.getSubNode('BODY22'),
                bW = t3.contentBox()?2:0,
                width=t2.width(),
                borderW=0,
                borderC=0;

            profile.getSubNodes('HCELL',true).each(function(hc){
                if(hc.clientHeight){
                    borderW = hc.offsetWidth - profile.$px(hc.style.width);
                    return false;
                }
            });

            var fixW=0,relWTotal=0,relWCol=[],relWCol2=[],overflowX;
            //if(prop.rowHandler){
                //borderC++;
                //fixW=profile.$px(prop.rowHandlerWidth);
            //}
            xui.each(profile.colMap,function(col){
                if(col.hidden || col._isgroup)return;
                // ignore left region columns
                if(col._region==1)return;

                if(!col.flexSize){
                    fixW+=profile.$px(col.width);
                }else{
                    relWTotal+=profile.$px(col.width);
                    relWCol.push(col)
                    relWCol2.push(col);
                }
                borderC++;
            });

            var lcellw=profile.getSubNode("LHCELL").get(0).clientWidth || 0;
            profile.getSubNodes('LCELL',true).each(function(hc){
                if(hc.children.length){
                    lcellw=Math.max(lcellw, hc.clientWidth);
                }
            });
            profile.__lcellW = lcellw;

            if(!relWCol.length){
                overflowX='auto';
                profile.box._adjustColsWidth(profile);
                return;
            }else{
                overflowX='hidden';
                if(t2.scrollable('y'))
                    width-=xui.Dom.getScrollBarSize();
            }
            
            width -= profile.__lcellW;
            // all flexSize cols' width
            profile._relWTotal=relWTotal;
            // available room for flexSize cols
            profile._relAvailable=width-(fixW+borderC*borderW);
            
            while(relWCol.length && width!=fixW+borderC*borderW){
                var fW=profile._relAvailable,
                    fW1=0,t,
                    l=relWCol.length,
                    retry=0;
                for(var i=l-1;i>=0;i--){
                    var col=relWCol[i],
                        w = i===0?(fW-fW1):Math.round(fW*(profile.$px(col.width)/relWTotal));

                    if(w<0)w=0;
                    _ww=w;
                    if(col.hasOwnProperty('minWidth')){
                        if((t=profile.$px(col.minWidth))>w){
                            fixW+=t;
                            _ww=t;
                            xui.arr.removeFrom(relWCol,i);
                            retry++;
                        }
                    }
                    if(col.hasOwnProperty('maxWidth')){
                        if((t=profile.$px(col.maxWidth))<w){
                            fixW+=t;
                            _ww=t;
                            xui.arr.removeFrom(relWCol,i);
                            retry++;
                        }
                    }
                    col._colWidth = profile.$forceu(_ww);
                    fW1+=_ww;
                }
                // break while;
                if(retry===0||retry===l)
                    break;
            }
            profile.box._adjustColsWidth(profile);
            if(relWCol2.length){
                xui.arr.each(relWCol2,function(col){
                    var n,nodes=[];
                    xui.each(col._cells,function(o){
                        n=profile.getSubNode('CELL',o);
                        if(n._nodes.length)nodes.push(n.get(0));
                    });
                    n=profile.getSubNode('HCELL',col._serialId);
                    if(n._nodes.length){
                        nodes.push(n.get(0));
                    }
                    profile.box._adjusteditorW(profile, xui(nodes).width(col._colWidth), profile.$px(col._colWidth)+bW);
                });
            }
            return overflowX;
        },
        _getRow:function(profile,row,type,splitMixColumn){
            if(row){
                if(type=='data')
                    return xui.clone(row,true);
                else if(type=='min'){
                    var a=[];
                    xui.each(row.cells||row,function(cell,j){
                        a[j]=('value' in cell)?cell.value:cell;
                    });
                    return a;
                }else if(type=='map'){
                    return profile.boxing().getRawData(row, splitMixColumn);
                }else
                    return row;
            }
        },
        $cancelHoverEditor:function(profile){
            if(profile.destroyed)return;
            var type=xui.get(profile,['$curEditor','_nodes',0,'$editMode'])||"",t;
            if(xui.str.startWith(type,'hover')){
                var editor=profile.$curEditor;
                if(type=="hover" && (t=editor.get(0)) && t.$poplink)return false;
                xui.tryF(editor.undo,[],editor);
            }
        },
        _onresize:function(profile,width,height){
            var prop = profile.properties,
                f=function(k){return profile.getSubNode(k)},
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                root = profile.getRoot(),
                borderW = root.contentBox()?2:0,
                w1 = prop.rowHandler?(profile.$px(prop.rowHandlerWidth) + borderW):0,
                w2,
                border = f('BORDER'),
                h1 = f('HEADER1'),
                h2 = f('HEADER2'),
                b12 = f('BODY12'),
                b21 = f('BODY21'),
                s11 = f('SCROLL11'),
                s12 = f('SCROLL12'),
                s21 = f('SCROLL21'),
                s22 = f('SCROLL22'),

                rh = h2.height(),
                rr = b12.height();

             // calculate by px
            width=width?profile.$px(width,null, true):width;
            height=height?profile.$px(height, null, true):height;

            border.cssSize({
                width:width?adjustunit(width):null,
                height:height?adjustunit(height):null
            });

            // adjust width
            if(width){
                // left region
                if(prop.freezedColumn){
                    xui.arr.each(prop.header,function(col,i){
                        if(i==prop.freezedColumn)return false;
                        if(!col.hidden)w1 += profile.$px(col.width) + borderW;
                    });
                }
                // for border-bottom
                if(rr && prop.freezedRow)rr-=1;
                // for border-right
                if(w1 && prop.freezedColumn)w1-=1;

                w2 = width - w1;
                profile._leftregionw = w1;

                //h1.width(adjustunit(w1));
                h2.width(adjustunit(w2));
                //s21.width(adjustunit(w1));
                //s22.width(adjustunit(w2));
            }

            // adjust height
            if(height){
                s11.height(rr?adjustunit(rr):0);
                s12.height(rr?adjustunit(rr):0);
                s21.height(adjustunit(height - rh - rr));
                s22.height(adjustunit(height - rh - rr));
                // avoid onmouseout of CELLS2 trigger CELLS1 scroll to top
                s11.css('display',rr?'':'none');
                s12.css('display',rr?'':'none');
            }
            if(width){
                // avoid onmouseout of CELLS2 trigger CELLS1 scroll to top
                s11.css('display',profile._leftregionw?'':'none');
                s21.css('display',profile._leftregionw?'':'none');
            }
            // for modify em value
            if(profile.$forceRelayout){
                this._adjustColsWidth(profile);
                this._adjustColsHeight(profile);
            }

            this._adjustBody(profile,'resize');
        }
    }
});xui.Class("xui.UI.Dialog","xui.UI.Widget",{
    Instance:{
        showModal:function(parent, left, top, callback, ignoreEffects){
            this.show(parent, true, left, top, callback, ignoreEffects);
        },
        show:function(parent, modal, left, top, callback,ignoreEffects){
            parent = parent || xui('body');
            return this.each(function(profile){
                if(profile.inShowing)return;
                var t,
                    p=profile.properties,
                    us = xui.$us(p),
                    ins = profile.boxing();
                // default to center dlg
                switch(p.initPos){
                    case 'auto':
                        // all in px
                       if(xui.isHash(left)){
                            top=left.top;
                            left=left.left;
                        }else{
                            top=(top||top===0)?top:profile.$px(p.top);
                            left=(left||left===0)?left:profile.$px(p.left);
                        }
                    break;
                    case 'center':
                        if(xui.isHash(left)){
                            top=left.top+(left.height-profile.$px(p.height))/2;
                            left=left.left+(left.width-profile.$px(p.width))/2;
                        }else{
                            var pr = parent.get(0)==xui('body').get(0)?xui.win:(parent['xui.UI']?parent.getRoot():parent);
                            // here, have to use global em
                            top=(top||top===0)?top:Math.max(0,(pr.height()-profile.$px(p.height))/2+pr.scrollTop());
                            left=(left||left===0)?left:Math.max(0,(pr.width()-profile.$px(p.width))/2+pr.scrollLeft());
                        }
                    break;
                }
                if(left<0)left=0;
                if(top<0)top=0;

                if(p.status=='max'){
                    left=top=0;
                }

                var f1 = function(){
                    parent.append(ins);
                    var box=profile.box,
                        root=profile.getRoot(),
                        adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)};
                    
                    if(p.iframeAutoLoad||p.ajaxAutoLoad)
                        xui.UI.Div._applyAutoLoad(profile);

                    if((modal || p.modal) && !profile.$inModal)
                        box._modal(profile);
                        
                    ins.activate();
                    var tt=profile._$rs_args,fun=function(){
                        if(profile.onShow)profile.boxing().onShow(profile);                            
                        delete profile.inShowing;
                        delete profile.$inThread;
                        xui.tryF(callback);

                        // attention animation
                        if(p&&p.activeAnim){
                            xui.asyRun(function(){
                                if(profile && !profile.destroyed)
                                    ins.setActiveAnim(p.activeAnim, true);
                            });
                        }

                    };
                    if(p.status=='min')
                        box._min(profile,'normal', fun, true);
                    else if(p.status=='max')
                        box._max(profile,'normal', fun, ignoreEffects);
                    else{
                        // resize immidiately here, maybe max here
                        xui.UI.$doResize(profile, (tt&&tt[1])||p.width, (tt&&tt[2])||p.height);
                        root.show(left?adjustunit(left):null, top?adjustunit(top):null, fun,null,ignoreEffects);
                        box._refreshRegion(profile);
                    }
                };

                profile.inShowing=1;
                if(t=p.fromRegion)
                    profile.$inThread = xui.Dom.animate({border:'solid 1px #555',background:'#888',opacity:.1},{
                        left:[t.left,left],
                        top:[t.top,top],
                        width:[t.width, profile.$px(p.width)],
                        height:[t.height, profile.$px(p.height)]
                    }, null,f1,300,0,'expoIn').start();
                else
                    f1();
            });
        },
        hide:function(ignoreEffects){
            this.each(function(profile){
                var pro=profile.properties,
                    box=profile.box,
                    us = xui.$us(pro),
                    root=profile.getRoot();

                var fun=function(){
                    if(profile.inHiding)return;
                    profile.inHiding=1;
                    if(profile.$inModal)
                        box._unModal(profile);
                    //max has dock prop
                    if(pro.status=='max' || pro.status=='min'){
                        var os=pro.status;
                        box._restore(profile);
                        pro.status=os;
                    }
    
                    var t=pro.fromRegion, f1=function(){
                        delete profile.inHiding;
                        delete profile.$inThread;
                    };
                    if(t)
                        profile.$inThread = xui.Dom.animate({border:'solid 1px #555',background:'#888',opacity:.1},{
                            left:[profile.$px(pro.left),t.left],
                            top:[profile.$px(pro.top),t.top],
                            width:[profile.$px(pro.width),t.width],
                            height:[profile.$px(pro.height),t.height]
                        },  null, f1,300,0,'expoOut').start();
                    else
                        f1();
                };
                root.hide(fun,null,ignoreEffects);
            });
            return this;
        },
        close:function(triggerEvent,ignoreEffects){
            return this.each(function(profile){
                if(false!==triggerEvent && profile.beforeClose && false === profile.boxing().beforeClose(profile))
                    return;
                if(profile.inClosing)return;
                profile.inClosing=1;
                var pro=profile.properties, t=pro.fromRegion, fun=function(){
                    profile.boxing().destroy(ignoreEffects);
                    delete profile.inClosing;
                    delete profile.$inThread;
                };

                if(t)
                    profile.$inThread = xui.Dom.animate({
                        border:'solid 1px #555',
                        background:'#888',
                        opacity:.1
                    },{
                        left:[pro.left,t.left],
                        top:[pro.top,t.top],
                        width:[pro.width,t.width],
                        height:[pro.height,t.height]
                    }, null,fun,300,0,'expoOut').start();
                else
                    fun();
            });
        },
        activate:function(flag){
            var self=this, profile=this.get(0),ifocus;
            profile.box._active(profile,flag);
            this.getChildren(null,true).each(function(o){
                if(xui.get(o,['properties','defaultFocus'])){
                    try{xui.asyRun(function(){o.boxing().activate()})}catch(e){}
                    ifocus=1;
                    return false;
                }
            });
            xui.asyRun(function(){
                if(flag!==false && !ifocus){
                    try{profile.getSubNode('CAPTION').focus(true);}catch(e){}
                }
                if(self.onActivated)self.onActivated(profile);                        
            });
        },
        isPinned:function(){
            return !!xui.get(this.get(0),['properties','pinned']);
        }
    },
    Initialize:function(){
        var ns=this, t=ns.getTemplate();
        xui.merge(t.FRAME.BORDER,{
            tabindex: '{tabindex}',
            className: 'xui-uiborder-outset xui-uiborder-box xui-uiborder-radius-big',
            TABSTOP1:{$order:-1},
            TBAR:{
                tagName:'div',
                className:'xui-uibar-top',
                TBARTDL:{
                    className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-tl',
                    TBARTDLT:{
                        className:'xui-uibar-tdlt'
                    }
                },
                TBARTDM:{
                    $order:1,
                    className:'xui-uibar-tdm xui-uibar',
                    TBARTDMT:{
                        className:'xui-uibar-tdmt'
                    }
                },
                TBARTDR:{
                    $order:2,
                    className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-tr',
                    TBARTDRT:{
                        className:'xui-uibar-tdrt'
                    }
                },
                BARCMDL:{
                    $order:3,
                    tagName: 'div',
                    className:'xui-uibar-cmdl',
                    style:'{_align}',
                    RULER:{
                        className:'xui-ui-ruler'
                    },
                    LTAGCMDS:{
                        tagName:'span',
                        className:'xui-ltag-cmds',
                        style:'{_ltagDisplay}',
                        text:"{ltagCmds}"
                    },
                    ICON:{
                        $order:2,
                        className:'xuicon {imageClass}  {picClass}',
                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                        text:'{iconFontCode}'
                    },
                    CAPTION:{
                        tabindex: '{tabindex}',
                        className:"xui-title-node",
                        text : '{caption}',
                        $order:3
                    }
                },
                BARCMDR:{
                    $order:4,
                    tagName: 'div',
                    className:'xui-uibar-cmdr',
                    RTAGCMDS:{
                        $order:0,
                        tagName:'span',
                        className:'xui-rtag-cmds',
                        style:'{_rtagDisplay}',
                        text:"{rtagCmds}"
                    } ,
                    INFO:{
                        className:'xuicon',
                        $fonticon:'xui-uicmd-info',
                        style:'{infoDisplay}',
                        $order:2
                    },
                    OPT:{
                        className:'xuicon',
                        $fonticon:'xui-uicmd-opt',
                        style:'{optDisplay}',
                        $order:3
                    },
                    PIN:{
                        $order:4,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-pin',
                        style:'{pinDisplay}'
                    },
                    LAND:{
                        $order:5,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-land',
                        style:'{landDisplay}'
                    },
                    REFRESH:{
                        className:'xuicon',
                        $fonticon:'xui-uicmd-refresh',
                        style:'{refreshDisplay}',
                        $order:6
                    },
                    MIN:{
                        $order:7,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-min',
                        style:'{minDisplay}'
                    },
                    RESTORE:{
                        $order:8,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-restore',
                        style:'display:none;'
                    },
                    MAX:{
                        $order:9,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-max',
                        style:'{maxDisplay}'
                    },
                    CLOSE:{
                        $order:10,
                        className:'xuicon',
                        $fonticon:'xui-uicmd-close',
                        style:'{closeDisplay}'
                    }
                },
                TBARTDB:{
                    $order:5,
                    tagName: 'div',
                    className:'xui-uibar-tdb xui-uiborder-inset xui-uiborder-radius'
                }
            },
            MAIN:{
                $order:2,
                tagName:'div',
                className:'xui-uicon-main xui-uibar',
                MAINI:{
                    tagName:'div',
                    className:'xui-uicon-maini xui-uibar',
                    PANEL:{
                        tagName:'div',
                        style:"{_panelstyle};{_overflow};",
                        className:'xui-uibar xui-uicontainer',
                        text:'{html}'+xui.UI.$childTag
                    }
                }
            },
            BBAR:{
                $order:3,
                tagName:'div',
                className:'xui-uibar-bottom',
                BBARTDL:{
                    $order:1,
                    className:'xui-uibar-tdl xui-uibar xui-uiborder-radius-big-bl'
                },
                BBARTDM:{
                    $order:2,
                    className:'xui-uibar-tdm xui-uibar'
                },
                BBARTDR:{
                    $order:3,
                    className:'xui-uibar-tdr xui-uibar xui-uiborder-radius-big-br'
                }
            },
            TABSTOP2:{$order:9}
        },'all');
        t.$submap = xui.UI.$getTagCmdsTpl();

        ns.setTemplate(t);

        xui.alert=ns.alert;
        xui.confirm=ns.confirm;
        xui.pop=ns.pop;
        xui.prompt=ns.prompt;
    },
    Static:{
        Appearances:{
            KEY:{
                overflow:'visible'
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            "TABSTOP1,TABSTOP2":{
                height:0,
                width:"16px",
                display:'inline',
                position:'absolute'
            },
            'TBART, BBART':{
                'border-spacing':0,
                'border-collapse':'separate'
            },
            MAINI:{
                'padding-top':'.16667em'
            },
            PANEL:{
                position:'relative',
                overflow:'auto'
            },
            CAPTION:{
                display:'inline',
                'vertical-align':xui.browser.ie6?'baseline':'middle'
            },
            BORDER:{
                position:'relative',
                outline:0
            }
        },
        Behaviors:{
            DroppableKeys:['PANEL'],
            PanelKeys:['PANEL'],
            DraggableKeys:['LAND'],
            NoDraggableKeys:['LAND','MIN','MAX','RESTORE','PIN','INFO','OPT','CLOSE','REFRESH','CMD'],
            HoverEffected:{LAND:'LAND',MIN:'MIN',MAX:'MAX',RESTORE:'RESTORE',PIN:'PIN',INFO:'INFO',OPT:'OPT', CLOSE:'CLOSE',REFRESH:'REFRESH',CMD:'CMD',ICON:'ICON'},
            ClickEffected:{LAND:'LAND',MIN:'MIN',MAX:'MAX',RESTORE:'RESTORE',PIN:'PIN',INFO:'INFO',OPT:'OPT', CLOSE:'CLOSE',REFRESH:'REFRESH',CMD:'CMD',ICON:'ICON'},
            onMousedown:function(profile, e){
                if(!profile.$inModal)
                    profile.box._active(profile);
            },
            afterKeydown:function(profile, e){
                var keys = xui.Event.getKey(e);
                if((e.$key || e.keyCode || e.charCode)==9){
                    // hack for ie tab event
                    if(xui.browser.ie){
                        var id="xui::_specialforietab";
                        if(!xui.Dom.byId(id))
                            xui('body').append("<div style='display:none;position:absolute;' id="+id+"></div>");
                        xui.Dom.byId(id).innerHTML=xui.stamp()+"";
                    }
                    var n1=profile.getSubNode("TABSTOP1").get(0),
                        n2=profile.getSubNode("TABSTOP2").get(0),
                        m=xui.Event.getSrc(e),t;
                    if(keys.shiftKey){
                        if(m!==n1)
                            n1.tabIndex = m.tabIndex;
                        n2.removeAttribute("tabIndex");
                    }else{
                        if(m!==n2)
                            n2.tabIndex = m.tabIndex;
                        n1.removeAttribute("tabIndex");
                    }
                    n1=n2=m=null;
                }
            },
            onDragstop:function(profile){
                var p = profile.properties,
                    us = xui.$us(p),
                    root=profile.getRoot(),
                    pos = root.cssPos(),
                    l = null, t = null;

                if(profile.$px(p.left) !== pos.left)
                    p.left = l = profile.$forceu( pos.left,null);
                if(profile.$px(p.top) !== pos.top)
                    p.top = t = profile.$forceu( pos.top,null);

                root.cssPos({ left: l, top: t });

                if(profile.onMove && (l!==null||t!==null))
                    profile.boxing().onMove(profile,l,t,null,null);
            },
            TABSTOP1:{
                onFocus:function(profile,e,src){
                    var tabindex = parseInt(xui.use(src).get(0).tabIndex||1 +"",10)-1;
                    var children = profile.getRoot().get(0).getElementsByTagName('*'),t,n;
                    for(var i=0,l=children.length,o;o=children[i];i++){
                        if(o.nodeType==1){
                            //cant set tabIndex to zero
                            if(o.tabIndex && o.tabIndex<=tabindex){
                                if(!t)t=(n=o).tabIndex;
                                if(o.tabIndex>t)t=(n=o).tabIndex;
                                if(t===tabindex)break;
                            }
                        }
                    }
                    if(o){
                        xui(o).focus(true);
                        xui.use(src).get(0).tabIndex=o.tabIndex;
                    }
                    else{
                        o=profile.getRoot().nextFocus(false,true,false);
                        xui(o).focus(true);
                        xui.use(src).get(0).tabIndex=o.get(0).tabIndex;
                    }
                    children=o=null;
                }
            },
            TABSTOP2:{
                onFocus:function(profile,e,src){
                    var tabindex = parseInt(xui.use(src).get(0).tabIndex||1 +"")+1;
                    var children = profile.getRoot().get(0).getElementsByTagName('*'),t,n;
                    for(var i=0,l=children.length,o;o=children[i];i++){
                        if(o.nodeType==1){
                            //cant set tabIndex to zero
                            if(o.tabIndex && o.tabIndex>=tabindex){
                                if(!t)t=(n=o).tabIndex;
                                if(o.tabIndex<t)t=(n=o).tabIndex;
                                if(t===tabindex)break;
                            }
                        }
                    }
                    if(o){
                        xui(o).focus(true);
                        xui.use(src).get(0).tabIndex=o.tabIndex;
                    }
                    else{
                        o=profile.getRoot().nextFocus(true,true,false);
                        xui(o).focus(true);
                        xui.use(src).get(0).tabIndex=o.get(0).tabIndex;
                    }
                    children=o=null;
                }
            },
            TBAR:{
                beforeMousedown:function(profile, e, src){
                    if(profile.$inDesign)return;

                    if(xui.Event.getBtn(e)!="left")return;
                    if(profile.getKey(xui.Event.getSrc(e).parentNode.id)==profile.keys.BARCMDR)return;
                    if(profile.properties.status=="max")return false;

                    if(profile.properties.movable && !profile._locked){
                        profile.box._active(profile);
                        var root=profile.getRoot(),
                            region=root.cssRegion(),
                            pregion=root.parent().cssRegion(),
                            dist=profile.getEmSize();
                        root.startDrag(e, {
                            dragDefer:2,
                            maxLeftOffset:region.left,
                            maxRightOffset:pregion.width-region.left-dist,
                            maxTopOffset:region.top,
                            maxBottomOffset:pregion.height-region.top-dist,
                            magneticDistance:dist,
                            xMagneticLines:[0,pregion.width-region.width],
                            yMagneticLines:[0,pregion.height-region.height],
                            targetOffsetParent:root.parent()
                        });
                    }
                },
                onDblclick:function(profile, e, src){
                    if(profile.getKey(xui.Event.getSrc(e).parentNode.id)==profile.keys.BARCMDR)return;
                    if(!profile.properties.maxBtn)return;
                    if(profile.properties.status=='max')
                        profile.box._restore(profile);
                    else
                        profile.box._max(profile);
                }
            },
            PIN:{
                onClick:function(profile, e, src){
                    var key=profile.keys.PIN, t=profile.properties,ins=profile.boxing();
                    if( profile.beforePin && false === profile.boxing().beforePin(profile, t.pinned))
                        return;

                    //set pinned status
                    t.pinned = !t.pinned;
                    //set appea
                    profile.getSubNode('PIN').tagClass('-checked', t.pinned);
                    //set lock flag for not movable
                    profile._locked = t.pinned;

                    // add/remove resize
                    if(t.resizer){
                        if(!t.pinned){
                            // if not in min mode
                            if(t.status != 'min')
                                ins._resizer();
                        }else
                            if(profile.$resizer)
                                //profile.boxing().setResizer(false);
                                ins._unResizer();
                    }
                }
            },
            MIN:{
                onClick:function(profile, e, src){
                    profile.box._min(profile,null,null,true);
                }
            },
            MAX:{
                onClick:function(profile, e, src){
                    profile.box._max(profile,null,null,true);
                }
            },
            RESTORE:{
                onClick:function(profile, e, src){
                    profile.box._restore(profile);
                }
            },
            LAND:{
                onClick:function(profile, e, src){
                    profile.boxing().onLand(profile, e, src);
                }
            },
            PANEL:{
                onClick:function(profile, e, src){
                    var p=profile.properties;
                    if(p.disabled)return false;
                    if(profile.onClickPanel)
                        return profile.boxing().onClickPanel(profile, e, src);
                }
            },

            INFO:{
                onClick:function(profile, e, src){
                    profile.boxing().onShowInfo(profile, e, src);
                }
            },
            OPT:{
                onClick:function(profile, e, src){
                    profile.boxing().onShowOptions(profile, e, src);
                }
            },
            REFRESH:{
                onClick:function(profile, e, src){
                    profile.boxing().onRefresh(profile);
                }
            },
            CLOSE:{
                onClick:function(profile, e, src){
                    profile.boxing().close();
                }
            },
            CMD:{
                onClick:function(profile,e,src){
                    var prop=profile.properties;
                    if(prop.disabled)return false;
                    if(profile.onCmd)
                        profile.boxing().onCmd(profile,xui.use(src).id().split('_')[1],e,src);
                    return false;
                }
            }
        },
        DataModel:{
            rotate:null,
            selectable:true,
            tips:null,
            border:null,
            disabled:null,
            dock:'none',
            showEffects:"Classic",
            hideEffects:"",
            initPos:{
                ini:'center',
                listbox:['auto','center']
            },
            iframeAutoLoad:{
                ini:"",
                action:function(){
                    xui.UI.Div._applyAutoLoad(this);
                }
            },
            ajaxAutoLoad:{
                ini:"",
                action:function(){
                    xui.UI.Div._applyAutoLoad(this);
                }
            },
            html:{
                html:1,
                action:function(v,ov,force){
                    this.getSubNode('PANEL').html(xui.adjustRes(v,0,1),null,null,force);
                }
            },
            // setCaption and getCaption
            caption:{
                ini:undefined,
                // ui update function when setCaption
                action: function(v){
                    v=(xui.isSet(v)?v:"")+"";
                    this.getSubNode('CAPTION').html(xui.adjustRes(v,true));
                }
            },
            image:{
                format:'image',
                action: function(v){
                    xui.UI.$iconAction(this);
                }
            },
            imagePos:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundPosition', value||'center');
                }
            },
            imageBgSize:{
                action: function(value){
                    this.getSubNode('ICON').css('backgroundSize', value||'');
                }
            },
            imageClass: {
                ini:'',
                action:function(v,ov){
                    xui.UI.$iconAction(this, 'ICON', ov);
                }
            },
            iconFontCode:{
                action:function(v){
                    xui.UI.$iconAction(this);
                }
            },
            // setCaption and getCaption
            shadow: true,
            resizer:true,
            movable: true ,

            minBtn:{
                ini:true,
                action:function(v){
                    var o = this.getSubNode('MIN');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            maxBtn:{
                ini:true,
                action:function(v){
                    var o = this.getSubNode('MAX');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            restoreBtn:{
                ini:true,
                action:function(v){
                    var o = this.getSubNode('RESTORE');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            infoBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('INFO').css('display',v?'':'none');
                }
            },
            optBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('OPT').css('display',v?'':'none');
                }
            },
            closeBtn:{
                ini:true,
                action:function(v){
                    var o = this.getSubNode('CLOSE');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            refreshBtn:{
                ini:false,
                action:function(v){
                    this.getSubNode('REFRESH').css('display',v?'':'none');
                }
            },
            pinBtn:{
                ini:false,
                action:function(v){
                    var o = this.getSubNode('PIN');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            landBtn:{
                ini:false,
                action:function(v){
                    var o = this.getSubNode('LAND');
                    if(v)
                        o.setInlineBlock();
                    else
                        o.css('display','none');
                }
            },
            width: {
                $spaceunit:1,
                ini:'25em'
            },
            height: {
                $spaceunit:1,
                ini:'25em'
            },
            minWidth : 200,
            minHeight : 100,

            position:'absolute',
            fromRegion:{
                hidden:true,
                ini:null
            },
            modal:{
                ini:false,
                action:function(v){
                    if(this.box){
                        if(v)this.box._modal(this);
                        else this.box._unModal(this);
                    }
                }
            },
            status:{
                ini:'normal',
                listbox:['normal','min','max'],
                action:function(v,o){
                    var self=this, b=self.box;
                    if(v=='min')b._min(self,o,null,true);
                    else if(v=='max')b._max(self,o,null,true);
                    else b._restore(self,o);
                }
            },
            hAlign:{
                ini:'left',
                listbox:['left','center','right'],
                action: function(v){
                    this.getSubNode("BARCMDL").css('textAlign',v);
                }
            },
            tagCmds:{
                ini:[],
                action:function(){
                    this.boxing().refresh();
                }
            },
            //hide props( with px)
            $hborder:1,
            $vborder:1
        },
        EventHandlers:{
            onIniPanelView:function(profile){},
            onShow:function(profile){},
            onActivated:function(profile){},
            beforePin:function(profile, value){},
            beforeStatusChanged:function(profile, oldStatus, newStatus){},
            afterStatusChanged:function(profile, oldStatus, newStatus){},
            onClickPanel:function(profile, e, src){},

            onLand:function(profile, e, src){},
            beforeClose:function(profile){},
            onShowInfo:function(profile, e, src){},
            onShowOptions:function(profile, e, src){},
            onRefresh:function(profile){},
            onCmd:function(profile,cmdkey,e,src){}
        },
        RenderTrigger:function(){
            var ns=this;
            ns.destroyTrigger = function(){
                var s=this;
                if(s.$inModal)s.box._unModal(s);
            };
        },
        LayoutTrigger:function(){
            var self=this, t=self.properties;
            // ensure modal
            if(t.modal){
                var p=self.$modalDiv&&self.$modalDiv.parent(),b=self.box;
                if(p&&p.get(0)&&p.get(0)!==self.getRootNode()){
                    b._unModal(self);
                }
                b._modal(self);
            }
        },
        _prepareData:function(profile){
            var data = arguments.callee.upper.call(this, profile),
                nodisplay='display:none';
            data.minDisplay = data.minBtn?'':nodisplay;
            data.maxDisplay = data.maxBtn?'':nodisplay;
            data.infoDisplay = data.infoBtn?'':nodisplay;
            data.optDisplay = data.optBtn?'':nodisplay;
            data.closeDisplay = data.closeBtn?'':nodisplay;
            data.pinDisplay = data.pinBtn?'':nodisplay;
            data.landDisplay = data.landBtn?'':nodisplay;
            data.refreshDisplay= data.refreshBtn?'':nodisplay;
            data._align = 'text-align:'+data.hAlign+';';

            var status=profile.properties.status;
            if(status=='min'||status=='max')
                profile.$noR=1;
            if(xui.isStr(data.overflow))
                data._overflow = data.overflow.indexOf(':')!=-1?(data.overflow):(data.overflow?("overflow:"+data.overflow):"");

            if(!xui.isEmpty(data.tagCmds))
                this._prepareCmds(profile, data);

            return data;
        },

        //ov from design mode
        _min:function(profile,status,effectcallback,ignoreEffects){
            var o=profile.getRoot(),
                box=profile.box,
                p=o.parent(),
                ins=profile.boxing(),
                t=profile.properties,
                a=xui.Dom._getEffects(t.showEffects,1);
            if(profile.$inThread)profile.$inThread.abort();
            if(!status)status=t.status;
            if(profile.beforeStatusChanged && false===profile.boxing().beforeStatusChanged(profile, 'min', status))
                return;

            // unMax
            if(status=='max')
                box._unMax(profile);
            // keep restore values
            else
                box._refreshRegion(profile);

            // hide those
            profile.getSubNodes(['PANEL','BBAR']).css('display','none');

            if(t.minBtn){
                // show restore button
                if(t.restoreBtn)
                profile.getSubNode('RESTORE').setInlineBlock();
                // hide min button
                profile.getSubNode('MIN').css('display','none');
            }

            // lockResize function
            if(t.resizer && profile.$resizer)
                ins._unResizer();

            //set it before resize
            t.status='min';

            var h1=o.height(),
                h2=profile.getSubNode('BORDER').height(),
                h=profile.getSubNode('TBAR').height();
            // resize
            o.cssSize({ width :t.minWidth, height :h+h1-h2},true);
            if(profile.afterStatusChanged)profile.boxing().afterStatusChanged (profile, 'min', status);
            
            if(a&&xui.browser.ie678)
                xui.filter(a.params,function(o,i){
                    return !!xui.Dom._cssfake[i];
                });
            o.show(null,null,effectcallback,null,ignoreEffects);
        },
        _max:function(profile,status,effectcallback,ignoreEffects){
            var o=profile.getRoot(),
                box=profile.box,
                ins=profile.boxing(),
                p=o.parent(),
                t=profile.properties,
                a=xui.Dom._getEffects(t.showEffects,1);
            if(!status)status=t.status;
            if(profile.$inThread)profile.$inThread.abort();
            
            if(profile.beforeStatusChanged && false===profile.boxing().beforeStatusChanged(profile, 'max', status))
                return;
            
            // if from normal status
            if(status=='min')
                //unset min
                box._unMin(profile);
            else
                box._refreshRegion(profile);

            // hide pin button
            if(t.pinBtn)
                profile.getSubNode('PIN').css('display','none');
            if(t.maxBtn){
                // hide max button
                profile.getSubNode('MAX').css('display','none');
                // show restore button
                if(t.restoreBtn)
                profile.getSubNode('RESTORE').setInlineBlock();
            }

            if(t.resizer && profile.$resizer)
                ins._unResizer(); 

            t.status='max';

            ins.setDock('cover',true);
            if(profile.afterStatusChanged)profile.boxing().afterStatusChanged (profile, 'max', status);
            if(a&&xui.browser.ie678)
                xui.filter(a.params,function(o,i){
                    return !!xui.Dom._cssfake[i];
                });
            o.show(null,null,effectcallback,null,ignoreEffects);
        },
        _restore:function(profile,status){
            var o=profile.getRoot(),
                box=profile.box,
                t=profile.properties;
            if(!status)status=t.status;
            t.status='normal';

            if(profile.beforeStatusChanged && false===profile.boxing().beforeStatusChanged(profile, 'normal', status))
                return;

            // if from max
            if(status=='max')box._unMax(profile);
            if(status=='min')box._unMin(profile);

            profile.getSubNode('BORDER').ieRemedy();

            // hide restore button
            profile.getSubNode('RESTORE').css('display','none');
        },
        _unMax:function(profile){
            var t=profile.properties,
                ins=profile.boxing();
            profile.getSubNode('MAX').setInlineBlock();
            if(t.pinBtn)
                profile.getSubNode('PIN').setInlineBlock();

            if(t.resizer && !t.pinned){
                    ins._resizer();
            }

            ins.setDock('none');

            // resize
            profile.adjustSize(true);
            if(profile.afterStatusChanged)profile.boxing().afterStatusChanged (profile, 'normal', status);
        },
        _unMin:function(profile){
            var t=profile.properties,
            ins=profile.boxing();
            profile.getSubNodes(['PANEL','BBAR']).css('display','block');
            profile.getSubNode('MIN').setInlineBlock();

            if(t.resizer && !t.pinned){
                    ins._resizer();
            }

            profile.getRoot().cssSize({width:t.width, height:t.height});
            // resize
            profile.adjustSize(true);
        },
        _active:function(profile,flag){
            var self=this;
            if(profile.$inDesign)return;

            if(flag!==false && xui.$cache.unique.activeWndId==profile.$xid)return;

            self._deActive();
            if(flag!==false){
                var o=xui(profile.domId),
                    //in ie, .children can't get the same thread added node(modal div,  here)
                    t1=o.topZindex(),
                    t2=parseInt(o.css('zIndex'),0);
                o.css('zIndex',t1>t2?t1:t2);

                profile.getSubNode('TBAR').tagClass('-focus');
                xui.$cache.unique.activeWndId = profile.$xid;
            }
        },
        _deActive:function(){
            var profile;
            if(profile=xui.UI._cache['$'+xui.$cache.unique.activeWndId])
                profile.getSubNode('TBAR').tagClass('-focus',false);
            delete xui.$cache.unique.activeWndId;
        },
        _modal:function(profile){
            var s=profile.getRoot(),temp,p=s.parent(),cover;
            if(!p.isEmpty()){
                if(!profile.$inModal){
                    cover = profile.$modalDiv;
                    if(!cover || !cover.get(0) || !cover.get(0).parentNode){
                        cover = profile.$modalDiv = xui.create("<div class='xui-cover xui-custom xui-cover-modal' style='left:0;top:0;position:absolute;overflow:hidden;display:block;z-index:0;'></div>");
                        cover.setSelectable(false);
                    }
                    p.append(cover);

                    // attach onresize event
                    if(p.get(0)===document.body || p.get(0)===document || p.get(0)===window)
                        p=xui.win,
                        w=Math.max(p.width(),p.scrollWidth())+'px',    
                        h=Math.max(p.height(),p.scrollHeight())+'px';

                    cover.css({
                        display:'block',width:w,height:h
                    })
                    .onMousedown(function(){return profile.$inDesign?null:false})
                    .topZindex(true);

                    if(profile.$inDesign)cover.onClick(function(){s.onClick(true)});

                    p.onSize(function(p){
                        p=xui(p);
                        var w=p.width()+"px",h=p.height()+"px";
                        // set widht/height first
                        cover.css({width:w,height:h});
                        xui.asyRun(function(){
                            var w=Math.max(p.width(),p.scrollWidth())+"px",h=Math.max(p.height(),p.scrollHeight())+"px";
                            cover.css({width:w,height:h});
                        });
                    },"dialog:"+profile.serialId);
                    
                    var i=(parseInt(cover.css('zIndex'),10)||0)+1;
                    s.css('zIndex',i);

                    if(i>=xui.Dom.TOP_ZINDEX)
                        xui.Dom.TOP_ZINDEX =i+1;
                    /*
                    //bak dlg tabzindnex
                    var hash={},a=profile.getRoot().query('*',function(o){return o.tabIndex>0}).get();
                    for(var i=0,o;o=a[i++];){
                        (hash[o.tabIndex] = hash[o.tabIndex]||[]).push(o);
                        o.tabIndex=-1;
                    }
                    //save others tabzindex
                    var h = profile.$focusHash={}, b=xui('body').query('*',function(o){return o.tabIndex>0}).get();
                    for(var i=0,o;o=b[i++];){
                        (h[o.tabIndex] = h[o.tabIndex]||[]).push(o);
                        o.tabIndex=-1;
                    }
                    //restore dlg tabzindnex
                    for(var i in hash){
                        h=hash[i];
                        for(var j in h)
                            h[j].tabIndex=i;
                    }
                    xui.Event.pushTabOutTrigger(profile.renderId, function(src,tabindex){
                        tabindex = parseInt(tabindex||1 +"",10);
                        var children = xui.use(src).get(0).getElementsByTagName('*'),t,n;
                        for(var i=0,l=children.length,o;o=children[i];i++){
                            if(o.nodeType==1){
                                if(o.tabIndex>=tabindex){
                                    if(!t)t=(n=o).tabIndex;
                                    if(o.tabIndex<t)t=(n=o).tabIndex;
                                    if(t===tabindex)break;
                                }
                            }
                        }
                        if(o)xui(o).focus(true);
                        else profile.getRoot().nextFocus();

                        children=o=null;
                    });
                    */

                    profile.$inModal=true;
                    p.setBlurTrigger(profile.$xid+"_anti", true, xui([cover.get(0),profile.getRootNode()]));
                }
            }
        },
        _unModal:function(profile){
            if(profile.$inModal){
                // detach onresize event
                var p=profile.$modalDiv.parent();
                if(p.get(0)===document.body || p.get(0)===document || p.get(0)===window)
                    p=xui.win;

                p.onSize(null, "dialog:"+profile.serialId);

                profile.getRoot().css('zIndex',0);
                
                profile.$modalDiv.css('display','none');
                var node=profile.getSubNode('BORDER');
                if(!node.isEmpty())
                    node.append(profile.$modalDiv);

                profile.$inModal=false;
                /*
                var hash=profile.$focusHash,h;
                for(var i in hash){
                    h=hash[i];
                    for(var j in h)
                        h[j].tabIndex=i;
                }
                xui.breakO(profile.$focusHash,2);
                xui.Event.popTabOutTrigger();
                */
                p.setBlurTrigger(profile.$xid+"_anti");
            }
        },
        _refreshRegion:function(profile){
            if(!profile.renderId) return;
            var prop=profile.properties, 
                root=profile.getRoot(),
                us=xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                nr=root.cssRegion();

            nr.left=adjustunit(nr.left);
            nr.top=adjustunit(nr.top);
            nr.width=adjustunit(nr.width);
            nr.height=adjustunit(nr.height);

            return xui.merge(prop, nr, function(o,i){return prop[i]!='auto'});
        },

        _adjust:function(dialog,caption, content, dftTilte, left, top){
            caption = xui.adjustRes(caption ||'');
            if(!xui.isSet(content)||content===""){
                content = caption;
                caption = dftTilte||"";
            }

            var node = dialog.$div.reBoxing(),
            ID='xui:temp:dialog',
            me=arguments.callee,
            w,h;

            if(!xui.Dom.byId(ID)){
                n2 = me._cache=node.clone(false);
                xui('body').append(n2);
                n2.css({overflow:'visible',position:'absolute',visibility:'visible',left:xui.Dom.HIDE_VALUE,top:xui.Dom.HIDE_VALUE})
                .id(ID,true);
            }
            var n2 = me._cache;
            n2.width('auto').height('auto');
            n2.html(content,false);
            var size = n2.cssSize();
            size.width+=10;
            size.height+=10;

            node.html(content);

            if(size.width>500){
                size.width=500;
                n2.width(500);
                size.height = n2.offsetHeight() + 10;
                n2.width('auto');
            }
            n2.html("",false);
            size.height += 10;
            if(size.height>400)size.height=400;
            if(size.width<150)size.width=150;
            if(size.height<30)size.height=30;

            node.cssSize(size).css('overflow','auto').show();

            var fs=dialog.getRoot()._getEmSize();
            w=size.width + fs*2;
            h=size.height + fs*7.5;
            dialog.setCaption(caption).setWidth(w).setHeight(h);
            return {width:w, height:h};
        },
        alert:function(title, content, onClose, btnCap, left, top, parent, subId, noCache){
            var me=arguments.callee, dialog;
            if(noCache || !(dialog=me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)){
                dialog = new xui.UI.Dialog({
                    overflow:'hidden',
                    minBtn:false,
                    maxBtn:false,
                    pinBtn:false,
                    resizer:false
                },{
                    beforeClose:function(){
                        xui.tryF(dialog._$onClose);
                        dialog._$onClose=null;
                        if(!noCache){
                            dialog.hide();
                            return false;
                        }
                    },
                    onHotKeydown:function(p,k){
                        if(k.key=='esc')
                            dialog.close();
                    }
                });

                var cmd = dialog.$cmd = new xui.UI.Div({
                    height:'2.5em',
                    dock:'bottom',
                    zIndex:10
                },null,null,null,{KEY:"text-align:center;padding-top:.5em"}),

                btn = dialog.$btn = new xui.UI.SButton({
                    position:'relative',
                    tabindex:1
                },
                {
                    onClick:function(){
                        dialog.close();
                    },
                    onHotKeydown:function(p,k){
                        if(k.key=='enter')
                            dialog.close();
                    }
                },null,null,{KEY:'margin:0 .5em'});
                cmd.append(btn);

                var div = dialog.$div = new xui.UI.Div({
                    left:10,
                    top:10
                });
                dialog.append(cmd).append(div).render();
                
                if(!noCache)
                    me.dialog = dialog;
            }
            dialog._$onClose=onClose;
            
            dialog.$btn.setCaption("&nbsp;&nbsp;"+(btnCap || xui.wrapRes('$inline.ok'))+"&nbsp;&nbsp;");

            var size=xui.UI.Dialog._adjust(dialog,title, content, "Alert");

            if(parent && parent["xui.UI"])parent=parent.getContainer(subId);
            if(!xui.isSet(parent))parent=xui('body');

            dialog.show(parent,true, left, top);
            xui.resetRun("dlg_focus:"+dialog.get(0).$xid,function(){
                dialog.$btn.activate();
            });
            return dialog;
        },
        confirm:function(title, caption, onYes, onNo, btnCapYes, btnCapNo, left, top, parent, subId, noCache){
            var me=arguments.callee, dialog;

            if(noCache || !(dialog=me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)){
                dialog = new xui.UI.Dialog({
                    overflow:'hidden',
                    minBtn:false,
                    maxBtn:false,
                    pinBtn:false,
                    resizer:false
                },{
                    beforeClose:function(){
                        if(!dialog._$_clicked)
                            xui.tryF(dialog._$onNo,['close']);
                        else
                            delete dialog._$_clicked;
                        dialog._$onYes=dialog._$onNo=null;
                        if(!noCache){
                            dialog.hide();
                            return false;
                        }
                    },
                    onHotKeydown:function(p,k){
                        if(k.key=='esc')
                            dialog.close();
                    }
                });

                var cmd = dialog.$cmd=new xui.UI.Div({
                    height:'2.5em',
                    dock:'bottom',
                    zIndex:10
                },null,null,null,{KEY:"text-align:center;padding-top:.5em"}),
                btn = dialog.$btn1 = new xui.UI.SButton({
                    tabindex:1,
                    position:'relative'
                },
                {
                    onClick:function(){
                        xui.tryF(dialog._$onYes,['yes']);
                        dialog._$_clicked=1;
                        dialog.close();
                    }
                },null,null,{KEY:'margin:0 .5em'});
                cmd.append(btn);

                btn = dialog.$btn2=new xui.UI.SButton({
                    tabindex:1,
                    position:'relative'
                },
                {
                    onClick:function(){
                        xui.tryF(dialog._$onNo,['no']);
                        dialog._$_clicked=1;
                        dialog.close();
                    }
                },null,null,{KEY:'margin:0 .5em'});
                cmd.append(btn);

                var div = dialog.$div=new xui.UI.Div({
                    left:10,
                    top:10
                });
                dialog.append(cmd).append(div).render();

                if(!noCache)
                    me.dialog = dialog;
            }
            dialog._$onYes=onYes;
            dialog._$onNo=onNo;
            delete dialog._$_clicked;
            dialog.$btn1.setCaption("&nbsp;&nbsp;"+(btnCapYes || xui.wrapRes('$inline.yes'))+"&nbsp;&nbsp;");
            dialog.$btn2.setCaption("&nbsp;&nbsp;"+(btnCapNo || xui.wrapRes('$inline.no'))+"&nbsp;&nbsp;");
            var size=xui.UI.Dialog._adjust(dialog, title, caption, "Confirm");

            if(parent && parent["xui.UI"])parent=parent.getContainer(subId);
            if(!xui.isSet(parent))parent=xui('body');

            dialog.show(parent, true, left, top);
            xui.resetRun("dlg_focus:"+dialog.get(0).$xid,function(){
                dialog.$btn2.activate();
            });
            return dialog;
        },
        pop:function(title, content, btnCap, left, top, parent, subId){
            var dialog = new xui.UI.Dialog({
                overflow:'hidden',
                minBtn:false,
                maxBtn:false,
                pinBtn:false,
                resizer:false
            },{
                onHotKeydown:function(p,k){
                    if(k.key=='esc')
                        dialog.close();
                }
            }),

            cmd = dialog.$cmd = new xui.UI.Div({
                    height:'2.5em',
                    dock:'bottom',
                    zIndex:10
                },null,null,null,{KEY:"text-align:center;padding-top:.5em"})
            .append( dialog.$btn = new xui.UI.SButton({
                caption: "&nbsp;&nbsp;"+(btnCap || '$inline.ok')+"&nbsp;&nbsp;",
                tabindex:1,
                position:'relative'
            },
            {
                onClick:function(){
                    dialog.destroy();
                },
                onHotKeydown:function(p,k){
                    if(k.key=='enter')
                        dialog.close();
                }
            },null,null,{KEY:'margin:0 .5em'})),

            div = dialog.$div = new xui.UI.Div({
                left:10,
                top:10,
                width:'7em'
            }).setCustomStyle({
                KEY:'overflow:visible'
            });

            dialog.append(cmd).append(div).render();

            var size=xui.UI.Dialog._adjust(dialog, title, content, "Message");

            if(parent && parent["xui.UI"])parent=parent.getContainer(subId);
            if(!xui.isSet(parent))parent=xui('body');

            dialog.show(parent,false,left, top);

            xui.resetRun("dlg_focus:"+dialog.get(0).$xid,function(){
                dialog.$btn.activate();
            });
            return dialog;
        },
        prompt:function(title, caption, content, onYes, onNo, btnCapYes, btnCapNo, left, top, parent, subId, noCache){
            var dialog,
                me=arguments.callee;
            if(noCache || !(dialog=me.dialog) || !dialog.get(0) || (!dialog.get(0).renderId)){
                dialog = new xui.UI.Dialog({
                    overflow:'hidden',
                    minBtn:false,
                    maxBtn:false,
                    pinBtn:false,
                    left:left||200,
                    top:top||200,
                    width:'25em',
                    height:'11em',
                    conDockPadding:{left:'.5em',right:'.5em',top:0,bottom:0}
                },{
                    beforeClose:function(){
                        if(!dialog._$_clickYes)
                        xui.tryF(dialog._$onNo,["no"]);
                        else
                            delete dialog._$_clickYes;

                        dialog._$input.setValue('',false,'prompt');
                        dialog._$onYes=dialog._$onNo=null;
                        if(!noCache){
                            dialog.hide();
                            return false;                        
                        }
                    }
                });
                var con = dialog._$caption = new xui.UI.Div({
                    height:'1.5em',
                    dock:'top'
                }),
                cmd = new xui.UI.Div({
                    height:'2.5em',
                    dock:'bottom',
                    zIndex:10
                },null,null,null,{KEY:"text-align:center;padding-top:.5em"})
                .append(dialog.$btn1 = new xui.UI.SButton({
                    position:'relative',
                    tabindex:1
                },
                {
                    onClick:function(){
                        if(false!==xui.tryF(dialog._$onYes,[dialog._$input.getUIValue()])){
                            dialog._$_clickYes=1;
                            dialog.close();
                        }
                    }
                },null,null,{KEY:'margin:0 .5em'}));

                cmd.append(dialog.$btn2 = new xui.UI.SButton({
                    tabindex:1,
                    position:'relative'
                },
                {
                    onClick:function(){
                        dialog.close();
                    }
                },null,null,{KEY:'margin:0 .5em'}));
                var inp=dialog._$input=new xui.UI.Input({
                    dock:'fill',
                    multiLines:true
                })
                dialog.append(con).append(cmd).append(inp).render();
                if(!noCache)
                    me.dialog = dialog;
            }
            dialog.setCaption(title||'Prompt');
            dialog._$caption.setHtml(caption||"");
            dialog._$input.setValue(content||"",true,'prompt');
            dialog._$onYes=onYes;
            dialog._$onNo=onNo;
            delete dialog._$_clickYes;
            dialog.$btn1.setCaption("&nbsp;&nbsp;"+(btnCapYes || xui.wrapRes('$inline.ok'))+"&nbsp;&nbsp;");
            dialog.$btn2.setCaption("&nbsp;&nbsp;"+(btnCapNo || xui.wrapRes('$inline.cancel'))+"&nbsp;&nbsp;");

            if(parent && parent["xui.UI"])parent=parent.getContainer(subId);
            if(!xui.isSet(parent))parent=xui('body');

            dialog.show(parent, true, left, top);
            xui.resetRun("dlg_focus:"+dialog.get(0).$xid,function(){
                dialog._$input.activate();
            });
            return dialog;
        },
        //
        _onresize:function(profile,width,height,force){
    		if(width && profile.properties.status=='min')
    			width=profile.properties.minWidth;

            var prop=profile.properties,
                us=xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)},
                size = arguments.callee.upper.apply(this,arguments),
                isize={},
                v0=profile.getSubNode('BORDER'),
                v1=profile.getSubNode('TBAR'),
                v2=profile.getSubNode('PANEL'),
                v4=profile.getSubNode('BBAR'),
                v5=profile.getSubNode('MAIN'),
                v6=profile.getSubNode('MAINI'),
                cb1=v0.contentBox(),
                cb2=v2.contentBox(),
                h1,h4,t;
            // caculate with px
            if(width)width=profile.$px(width);
            if(height)height=profile.$px(height);
            if(size.left)size.left=profile.$px(size.left);
            if(size.top)size.top=profile.$px(size.top);
            if(size.width)size.width=profile.$px(size.width);
            if(size.height)size.height=profile.$px(size.height);

            if(height){
                if(height=='auto'){
                    isize.height=height;
                }else{
                    //force to get height
                    h1=v1.offsetHeight(true);
                    h4=v4.offsetHeight(true);
                    if((t=size.height-h1-h4)>0)
                        isize.height=t;
                }
            }
            if(height)
                isize.height = isize.height - v6._paddingH() - (cb1?0:v0._borderH())- (cb2?0:v2._borderH());

            if(width)
                isize.width = size.width
                    - (parseFloat(v6.css('paddingRight'))||0)  - (parseFloat(v6.css('borderRightWidth'))||0)
                    - (parseFloat(v5.css('paddingLeft'))||0) - (parseFloat(v5.css('borderLeftWidth'))||0);
                    - (cb1?0:v0._borderW()) -  (cb2?0:v2._borderW())
            
            if(width&&us>0)isize.width=adjustunit(isize.width);
            if(height&&us>0)isize.height=adjustunit(isize.height);

            v2.cssSize(isize, true);
            if(width){
                xui.UI._adjustConW(profile, v2, isize.width);
            }
        }
    }
});
xui.Class("xui.UI.FoldingList", ["xui.UI.List"],{
    Instance:{
        fillContent:function(id, obj){
            var profile=this.get(0),t,item;
            if(profile.renderId){
                if(item=profile.getItemByItemId(id)){                    
                    t=profile.getSubNodeByItemId('BODYI',id).html('');
                    if(obj){
                        item._obj = obj;
                        item._fill=true;
                        if(typeof obj=='string')t.html(obj);
                        else t.append(obj.render(true));
                    }else
                        item._obj=item._fill=null;
                }
            }
            return this;
        },
        toggle:function(id){
            var profile=this.get(0);
            if(profile.renderId){
                var properties = profile.properties,
                    items=properties.items,
                    item = profile.getItemByItemId(id),
                    subId = profile.getSubIdByItemId(id),
                    node = profile.getSubNode('ITEM',subId),
                    toggle = profile.getSubNode('TOGGLE',subId),
                    nodenext = node.next(),t
                    ;
                if(item._show){
                    if(properties.activeLast && items.length)
                        if(items[items.length-1].id==item.id)
                            return false;
    
                    node.tagClass('-checked',false);
                    toggle.tagClass('-checked',false);
                    if(nodenext)
                        nodenext.tagClass('-prechecked',false);
                }else{
                    node.tagClass('-checked');
                    toggle.tagClass('-checked');
                    if(nodenext)
                        nodenext.tagClass('-prechecked');
                    //fill value
                    if(!item._fill){
                        var callback=function(o){
                            profile.boxing().fillContent(item.id, item._body=o);
                        };
                        if(profile.onGetContent){
                            var r = profile.boxing().onGetContent(profile, item, callback);
                            if(r) callback(r);
                        }else
                            callback(profile.box._buildBody(profile, item));
                    }
                }
                item._show=!item._show
             }
            return this;
        }
    },
    Initialize:function(){
        //modify default template fro shell
        var t = this.getTemplate();
         t.ITEMS.className='{_bordertype}';
        t.$submap.items={
            ITEM:{
                tagName : 'div',
                className:'xui-uiborder-flat xui-uiborder-radius {_checked} {_precheked} {itemClass} {disabled} {readonly}',
                style:'{itemStyle}',
                HEAD:{
                    tagName : 'div',
                    className:'xui-uibar',
                    HL:{tagName : 'div'},
                    HR:{tagName : 'div'},
                    TITLE:{
                        tabindex: '{_tabindex}',
                        TLEFT:{
                            $order:0,
                            tagName:'div',
                            TOGGLE:{
                                $order:0,
                                className:'xuifont',
                                $fonticon:'{_fi_tlg}'
                            },
                            LTAGCMDS:{
                                $order:2,
                                tagName:'span',
                                text:"{ltagCmds}"
                            },
                            CAP1:{
                                $order:1,
                                className:"xui-title-node",
                                text:'{title}'
                            }
                        },
                        TRIGHT:{
                            $order:1,
                            tagName:'div',
                            style:'{_capDisplay}',
                            CAP2:{
                                $order:0,
                                text:'{caption}'
                            },
                            TAGCMDS:{
                                $order:60,
                                tagName:'span',
                                text:"{rtagCmds}"
                            } 
                        }/*,
                        TCLEAR:{
                            $order:2,
                            tagName:'div'
                        }*/
                    }
                },
                BODY:{
                    $order:1,
                    tagName : 'div',
                    className:'xui-uibase',
                    BODYI:{
                        $order:0,
                        tagName : 'div',
                        text:'{_body}'
                    }
                },
                TAIL:{
                    $order:4,
                    tagName : 'div',
                    className:'xui-uibar',
                    TL:{tagName : 'div'},
                    TR:{tagName : 'div'}
                }
            }
        }
        this.setTemplate(t);
    },
    Static:{
        Appearances:{
            KEY:{
                padding:'.25em'
            },
            ITEMS:{
                border:0,
                position:'relative',
                zoom:xui.browser.ie?1:null,
                'padding-top':'.75em'//,
                //for ie6 1px bug,  HR/TR(position:absolute;right:0;)
                //'margin-right':xui.browser.ie6?'expression(this.parentNode.offsetWidth?(this.parentNode.offsetWidth-(parseInt(this.parentNode.style.paddingLeft,10)||0)-(parseInt(this.parentNode.style.paddingRight,10)||0) )%2+"px":"auto")':null
            },
            ITEM:{
                //for ie6 bug
                zoom:xui.browser.ie?1:null,
                'margin-top':'-7px',
                padding:0,
                position:'relative',
                overflow:'hidden',
                'border-radius': '6px',
                'box-shadow': '-1px -1px 2px #EDEDED'
            },
            'HEAD, BODY, BODYI, TAIL':{
                position:'relative'
            },
            BODY:{
                display:'none',
                zoom:xui.browser.ie?1:null,
                position:'relative',
                overflow:'auto'
            },
            BODYI:{
                padding:'.25em .75em 0 .75em',
                position:'relative'
            },
            'BODY, BODYI':{
            },
            'ITEM-hover, ITEM-active, ITEM-checked':null,
            'ITEM-checked':{
                $order:2,
                'margin-bottom':'1em'
             },
            'ITEM-checked BODY':{
                $order:2,
                display:'block'
            },
            'HL, HR, TL, TR':{
                position:'absolute',
                width:'.75em'
            },
            'HL, HR':{
                height:'2.5em'
            },
            'ITEM-prechecked HL':{
                $order:1
            },
            'ITEM-prechecked HR':{
                $order:1
            },
            'TL, TR':{
                height:'1.75em'
            },
            HL:{
                $order:1,
                top:0,
                left:0
            },
            HR:{
                $order:1,
                top:0,
                right:0
            },
            TL:{
                $order:1,
                bottom:0,
                left:0
            },
            TR:{
                $order:1,
                bottom:0,
                right:0
            },
            HEAD:{
                position:'relative',
                zoom:xui.browser.ie?1:null,
                overflow:'hidden'
            },
            TITLE:{
                $order:1,
                display:'block',
                position:'relative',
                'white-space':'nowrap',
                overflow:'hidden',
                padding:'.25em .5em'
            },
            TAIL:{
                position:'relative',
                height:'.25em'
            },
            'CAP1, CAP2':{
                padding:'.25em',
                'vertical-align':'middle'
            },
            CAP1:{
                cursor:'pointer',
                'white-space':'nowrap'
            },
            'ITEM-checked CAP1':{
                $order:2,
                'font-weight':'normal'
            },
            TLEFT:{
                //position:xui.browser.ie6?'relative':null,
                //'float':'left',
                position:'relative',
                left:'.5em',

                'white-space':'nowrap',
                overflow:'hidden'
            },
            TRIGHT:{
                //position:xui.browser.ie6?'relative':null,
                //'float':'right',

                position:'absolute',
                right:'.5em',
                top:'.25em',

                'white-space':'nowrap',
                overflow:'hidden'
            }
        },
        Behaviors:{
            HoverEffected:{ITEM:'ITEM',HEAD:'HEAD',OPT:'OPT'},
            ClickEffected:{ITEM:null,HEAD:'HEAD'},
            ITEM:{onClick:null,onKeydown:null},
            HEAD:{
                onClick:function(profile, e, src){
                    profile.boxing().toggle(profile.getItemIdByDom(src));
                    return false;
                }
            },
            OPT:{
                onMousedown:function(){
                    return false;
                },
                onClick:function(profile, e, src){
                    profile.boxing().onShowOptions(profile, profile.getItemByDom(src), e, src);
                    return false;
                }
            }
        },
        DataModel:({
            value: null,
            borderType: null,
            activeLast: true
        }),
        EventHandlers:{
            onGetContent:function(profile,item,onEnd){},
            onShowOptions:function(profile,item,e,src){}
        },
         RenderTrigger:function(){
            var self=this, pro=self.properties, items=pro.items, item;
            if(pro.activeLast && items.length>0){
                item=items[items.length-1];
                self.boxing().fillContent(item.id, item._body);
            }
        },
        _prepareItems:function(profile, arr, pid){
            if(arr.length){
                arr[0]._precheked = profile.getClass('ITEM','-prechecked');
                if(profile.properties.activeLast){
                    //for properties.data
                    var item = arr[arr.length-1];
                    item._show = true;
                    item._fill = true;
                    item._body = profile.onGetContent?profile.boxing().onGetContent(profile,item,function(o){
                        profile.boxing().fillContent(item.id, item._body=o);
                    }) : profile.box._buildBody(profile, item);
                }
            }
            return arguments.callee.upper.apply(this, arguments);
        },
        _prepareItem:function(profile, item){
            var p = profile.properties,o,
                dpn = 'display:none';
            item._tabindex = p.tabindex;
            if(!item.caption)
                item._capDisplay=dpn;
            else
                item.caption = item.caption.replace(/</g,"&lt;");
            item._body= item._body || 'Loading...'

            if(item._show){
                item._checked = profile.getClass('ITEM','-checked');
                item._fi_tlg = 'xuifont-checked xui-uicmd-toggle xui-uicmd-toggle-checked';
            }else{
                item._fi_tlg = 'xui-uicmd-toggle';
            }
            
            this._prepareCmds(profile, item);
        },
        _buildBody:function(profile,item){
            return item.text?'<pre class="xui-node xui-node-div">'+item.text.replace(/</g,"&lt;")+'</pre>':'';
        },
        _onresize:function(){}
    }
});
xui.Class("xui.UI.FoldingTabs", "xui.UI.Tabs",{
    Instance:{
        _setCtrlValue:function(value,init){
            this.each(function(profile){
                var id=profile.domId,
                    box = profile.boxing(),
                    uiv = init?'':box.getUIValue(),
                    prop = profile.properties,

                    fold=function(itemId, arr){
                        var subId = profile.getSubIdByItemId(itemId),
                            item=profile.getItemByItemId(itemId);
                        if(subId){
                            arr.push(subId);
                            
                            var itemnode=profile.getSubNode('BODY',subId);
                            if(itemnode.css('display')!='none'){
                                item._scrollTop=itemnode.get(0).scrollTop||0;
                                if(item._scrollTop)
                                    itemnode.get(0).scrollTop=0;
                                itemnode.css('display','none');
                            }
                        }
                    },
                    expand = function(itemId, arr){
                        var subId = profile.getSubIdByItemId(itemId),
                            item=profile.getItemByItemId(itemId);
                        if(subId){
                            arr.push(subId);
                            
                            var itemnode=profile.getSubNode('BODY',subId);
                            if(itemnode.css('display')=='none'){
                                 // show pane
                                //box.getPanel(itemId).css('position','relative').show('auto','auto');
                                itemnode.css('display','block');
                                if(item._scrollTop)
                                    itemnode.get(0).scrollTop=item._scrollTop;
    
                                profile.box._forLazyAppend(profile, item, itemId);
                                profile.box._forIniPanelView(profile, item, itemId);
                            }
                        }
                    };
                var arr1=[], arr2=[];
                if(prop.selMode=="multi"){
                    uiv = uiv?uiv.split(prop.valueSeparator):[];
                    value = value?value.split(prop.valueSeparator):[];

                    xui.arr.each(uiv,function(key){
                        if(xui.arr.indexOf(value,key)==-1)
                            fold(key, arr1);
                    });
                    xui.arr.each(value,function(key){
                        if(xui.arr.indexOf(uiv,key)==-1)
                            expand(key, arr2);
                    });
                }else{
                    fold(uiv, arr1);
                    expand(value, arr2);
                }
                if(arr1.length){
                    profile.getSubNodes(['ITEM','TOGGLE'],arr1).tagClass('-checked',false);
                    profile.getSubNodes('ITEM',arr1).next().tagClass('-prechecked',false);
                }
                if(arr2.length){
                    profile.getSubNodes(['ITEM','TOGGLE'],arr2).tagClass('-checked');
                    profile.getSubNodes('ITEM',arr2).next().tagClass('-prechecked');
                }
                profile.adjustSize();
            });
        },
        _afterInsertItems:null
    },
    Static:{
        Templates:{
            tagName : 'div',
            style:'{_style};',
            BOX:{
                $order:0,
                tagName : 'div',
                ITEMS:{
                    tagName : 'div',
                    text:"{items}"
                }
            },
            $submap:{
                items:{
                    ITEM:{
                        tagName : 'div',
                        className:'xui-uiborder-flat xui-uiborder-radius {_checked} {_precheked} {itemClass} {disabled} {readonly}',
                        style:'{_itemDisplay} {itemStyle}',
                        HEAD:{
                            tagName : 'div',
                            className:'xui-uibar  {_checked} {_precheked} ',
                            HL:{tagName : 'div'},
                            HR:{tagName : 'div'},
                            TITLE:{
                                tabindex: '{_tabindex}',
                                TLEFT:{
                                    $order:0,
                                    tagName:'div',
                                    LTAGCMDS:{
                                        $order:0,
                                        tagName:'span',
                                        style:'{_ltagDisplay}',
                                        text:"{ltagCmds}"
                                    },
                                    TOGGLE:{
                                        $order:1,
                                        className:'xuifont {_tlgchecked}',
                                         $fonticon:'xui-uicmd-toggle'
                                    },
                                    ICON:{
                                        $order:2,
                                        className:'xuicon {imageClass}  {picClass}',
                                        style:'{backgroundImage}{backgroundPosition}{backgroundSize}{backgroundRepeat}{iconFontSize}{imageDisplay}{iconStyle}',
                                        text:'{iconFontCode}'
                                    },
                                    CAPTION:{
                                        $order:3,
                                        className:"xui-title-node",
                                        text:'{caption}'
                                    }
                                },
                                TRIGHT:{
                                    $order:1,
                                    tagName:'div',
                                    style:'{_capDisplay}',
                                    MESSAGE:{
                                        $order:0,
                                        text:'{message}'
                                    },
                                    CMDS:{
                                        $order:2,
                                        RTAGCMDS:{
                                            $order:0,
                                            tagName:'span',
                                            style:'{_rtagDisplay}',
                                            text:"{rtagCmds}"
                                        },
                                        OPT:{
                                            $order:1,
                                            className:'xuifont',
                                            $fonticon:'xui-uicmd-opt',
                                            style:'{_opt}'
                                        },
                                        POP:{
                                            className:'xuifont',
                                            $fonticon:'xui-uicmd-pop',
                                            style:'{popDisplay}',
                                            $order:1
                                        },
                                        CLOSE:{
                                            className:'xuifont',
                                            $fonticon:'xui-uicmd-close',
                                            style:'{closeDisplay}',
                                            $order:2
                                        }
                                    }
                                }/*,
                                TCLEAR:{
                                    $order:2,
                                    tagName:'div'
                                }*/
                            }
                        },
                        BODY:{
                            $order:1,
                            tagName : 'div',
                            className:'xui-uibase',
                            BODYI:{
                                tagName : 'div',
                                PANEL:{
                                    tagName : 'div',
                                    style:'{_itemHeight};{_overflow};{_bginfo}',
                                    className:'xui-uibase xui-uicontainer',
                                    text:xui.UI.$childTag
                                }
                            }
                        },
                        TAIL:{
                            $order:4,
                            tagName : 'div',
                            className:'xui-uibar',
                            TL:{tagName : 'div'},
                            TR:{tagName : 'div'}
                        }
                    }
                },
                'items.ltagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.rtagCmds':function(profile,template,v,tag,result){
                    var me=arguments.callee,map=me._m||(me._m={'text':'.text','button':'.button','image':'.image'});
                    xui.UI.$doTemplate(profile,template,v,"items.tagCmds"+(map[v.type]||'.button'),result)
                },
                'items.tagCmds.text':xui.UI.$getTagCmdsTpl('text'),
                'items.tagCmds.button':xui.UI.$getTagCmdsTpl('button'),
                'items.tagCmds.image':xui.UI.$getTagCmdsTpl('image')
            }
        },
        Appearances:{
            KEY:{
            },
            BOX:{
                    
            },
            'LTAGCMDS, RTAGCMDS':{
                padding:0,
                margin:0,
                'vertical-align': 'middle'
            },
            ITEMS:{
                border:0,
                position:'relative',
                zoom:xui.browser.ie?1:null,
                padding:'11px 4px 4px 4px'//,
                //for ie6 1px bug,  HR/TR(position:absolute;right:0;)
                //'margin-right':xui.browser.ie6?'expression(this.parentNode.offsetWidth?(this.parentNode.offsetWidth-(parseInt(this.parentNode.style.paddingLeft,10)||0)-(parseInt(this.parentNode.style.paddingRight,10)||0) )%2+"px":"auto")':null
            },
            ITEM:{
                //for ie6 bug
                zoom:xui.browser.ie?1:null,
                'margin-top':'-7px',
                padding:0,
                position:'relative',
                overflow:'hidden',
                'border-radius': '6px',
                'box-shadow': '-1px -1px 2px #EDEDED'
            },
            'HEAD, BODY, BODYI, PANEL, TAIL':{
                position:'relative'
            },

            CMDS:{
                padding:'.25em 0 0 .25em',
                'vertical-align':'middle',
                position:'relative'
            },
            BODY:{
                display:'none',
                zoom:xui.browser.ie?1:null,
                position:'relative'
            },
            BODYI:{
                padding:'0 .25em'
            },
            PANEL:{
                overflow:'auto',
                padding:'.25em'
            },
            'ITEM-hover':{
            },
            'ITEM-active, ITEM-checked':{
            },
            'ITEM-checked':{
                $order:2,
                'margin-bottom':'1em'
             },
            'ITEM-checked BODY':{
                $order:2,
                display:'block'
            },
            'HL, HR, TL, TR':{
                position:'absolute',
                width:'.75em'
            },
            'HL, HR':{
                height:'2.5em'
            },
            'ITEM-prechecked HL':{
                $order:1
            },
            'ITEM-prechecked HR':{
                $order:1
            },
            'TL, TR':{
                height:'1.75em'
            },
            HL:{
                $order:1,
                top:0,
                left:0
            },
            HR:{
                $order:1,
                top:0,
                right:0
            },
            TL:{
                $order:1,
                bottom:0,
                left:0
            },
            TR:{
                $order:1,
                bottom:0,
                right:0
            },
            HEAD:{
                cursor:'pointer',
                position:'relative',
                zoom:xui.browser.ie?1:null,
                overflow:'hidden'
            },
            TITLE:{
                $order:1,
                display:'block',
                position:'relative',
                'white-space':'nowrap',
                overflow:'hidden',
               padding:'.25em .5em'
            },
            'BODY, BODYI':{
                overflow:'hidden'
            },
            TAIL:{
                height:'.25em'
            },
            'CAPTION, MESSAGE':{
                padding:'.25em',
                'vertical-align':'middle'
            },
            MESSAGE:{
                'font-size':'1em'
            },
            CAPTION:{
                'white-space':'nowrap'
            },
            'ITEM-checked CAPTION':{
                $order:2,
                'font-weight':'bold'
            },
            TLEFT:{
                //position:xui.browser.ie6?'relative':null,
                //'float':'left',
                position:'relative',
               left:'.5em',
                padding:"0 0 0 .5em",
                'white-space':'nowrap',
                overflow:'hidden'
            },
            TRIGHT:{
                //position:xui.browser.ie6?'relative':null,
                //'float':'right',

                position:'absolute',
                right:'.5em',
                top:'.25em',
                'white-space':'nowrap',
                overflow:'hidden'
            }
        },
        Behaviors:{
            DraggableKeys:['HEAD'],
            HoverEffected:{OPT:'OPT',CLOSE:'CLOSE',POP:'POP',ITEM:'HEAD'},
            ClickEffected:{OPT:'OPT',CLOSE:'CLOSE',POP:'POP',ITEM:'HEAD'},
            ITEM:{onClick:null},
            ITEMS:{onMousedown:null,onDrag:null,onDragstop:null},
            HEAD:{
                onClick:function(profile, e, src){
                    if(xui.Event.getBtn(e)!='left')return;

                    var prop = profile.properties,
                        item = profile.getItemByDom(src),
                        itemId =profile.getSubId(src),
                        box = profile.boxing();
                    if(!item)return;

                    if(prop.disabled|| item.disabled)return false;
                    if(prop.readonly|| item.readonly)return false;

                    profile.getSubNode('TITLE').focus(true);

                    switch(prop.selMode){
                    case 'multi':
                        var value = box.getUIValue(),
                            arr = value?value.split(prop.valueSeparator):[],
                            checktype=1;

                        if(arr.length){
                            //for select
                            if(xui.arr.indexOf(arr,item.id)!=-1){
                                xui.arr.removeValue(arr,item.id);
                                checktype=-1
                            }else
                                arr.push(item.id);

                            arr.sort();
                            value = arr.join(prop.valueSeparator);

                            //update string value only for setCtrlValue
                            if(box.getUIValue() !== value){
                                box.setUIValue(value,null,null,'click');
                                if(box.get(0) && box.getUIValue() == value)
                                    box.onItemSelected(profile, item, e, src, checktype);
                            }
                            break;
                        }
                    case 'single':

                        if(box.getUIValue() !== item.id){
                            box.setUIValue(item.id,null,null,'click');
                            if(box.get(0) && box.getUIValue() == item.id)
                                box.onItemSelected(profile, item, e, src, 1);
                        }
                        break;
                    }
                },
                onKeydown:function(profile, e, src){
                    var keys=xui.Event.getKey(e), key = keys.key, shift=keys.shiftKey;
                    if(key==' '||key=='enter'){
                        profile.getSubNode('HEAD',profile.getSubId(src)).onClick();
                        return false;
                    }
                }
            }
        },
        DataModel:{
            $hborder:0,
            $vborder:0,
            noPanel:null,
            noHandler:null,
            HAlign:null,
            selMode:{
                ini:'single',
                listbox:['single', 'multi']
            }
        },
        _prepareItems:function(profile, arr, pid){
            if(arr.length)
                arr[0]._precheked = profile.getClass('ITEM','-prechecked');
            return arguments.callee.upper.apply(this, arguments);
        },
        _prepareItem:function(profile, item){
            var dpn = 'display:none',p=profile.properties,t;
            item.closeDisplay = item.closeBtn?'':dpn;
            item.popDisplay = item.popBtn?'':dpn;
            item._opt = item.optBtn?'':dpn;
            item._itemDisplay = item.hidden?dpn:'';

            if(item.height)
                item._itemHeight="height:"+profile.$forceu(item.height);

            var prop = profile.properties,o;
            item._tabindex = prop.tabindex;
            if(!item.caption)
                item._capDisplay=dpn;

            item._bginfo="";
            if(t=item.panelBgClr||p.panelBgClr)
                item._bginfo+="background-color:"+t+";";
            if(t=item.panelBgImg||p.panelBgImg)
                item._bginfo+="background-image:url("+xui.adjustRes(t)+");";
            if(t=item.panelBgImgPos||p.panelBgImgPos)
                item._bginfo+="background-position:"+t+";";
            if(t=item.panelBgImgRepeat||p.panelBgImgRepeat)
                item._bginfo+="background-repeat:"+t+";";
            if(t=item.panelBgImgAttachment||p.panelBgImgAttachment)
                item._bginfo+="background-attachment:"+t+";";

            if(xui.isStr(item.overflow))
                item._overflow = item.overflow.indexOf(':')!=-1?(item.overflow):(data.overflow?("overflow:"+data.overflow):"");
            else if(xui.isStr(p.overflow))
                item._overflow = p.overflow.indexOf(':')!=-1?(p.overflow):(p.overflow?("overflow:"+p.overflow):"");

            if(item._show){
                item._checked = profile.getClass('ITEM','-checked');
                item._tlgchecked = profile.getClass('TOGGLE','-checked');
            }
            this._prepareCmds(profile, item);
        },
        _onresize:function(profile,width,height,force,key){
            if(force){profile._w=profile._h=null;}
            if(width && profile._w!=width){
                profile._w=width;
                profile.getSubNode("PANEL",true).each(function(panel){
                    if(panel.offsetWidth){
                        xui(panel).width('auto');
                        var w=xui(panel).width(), prop=profile.properties;
                        if(xui.$us(prop)>0)w=profile.$px2em(w, panel)+'em';
                        xui(panel).width(w);

                        xui.UI._adjustConW(profile, panel, w);
                    }
                });
            }
        },
        _adjustScroll:null
    }
});
//  \\
//  Raphal 2.2.0 - JavaScript Vector Library                                                              \\
//  \\
//  Copyright  2008-2016 Dmitry Baranovskiy (http://raphaeljs.com)                                        \\
//  Copyright  2008-2016 Sencha Labs (http://sencha.com)                                                  \\
//  \\
//  Licensed under the MIT (https://github.com/DmitryBaranovskiy/raphael/blob/master/license.txt) license. \\
//  \\

(function webpackUniversalModuleDefinition(root, factory) {
	if(typeof exports === 'object' && typeof module === 'object')
		module.exports = factory();
	else if(typeof define === 'function' && define.amd)
		define("Raphael", [], factory);
	else if(typeof exports === 'object')
		exports["Raphael"] = factory();
	else
		root["Raphael"] = factory();
})(this, function() {
return /******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};

/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {

/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId])
/******/ 			return installedModules[moduleId].exports;

/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			exports: {},
/******/ 			id: moduleId,
/******/ 			loaded: false
/******/ 		};

/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

/******/ 		// Flag the module as loaded
/******/ 		module.loaded = true;

/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}


/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;

/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;

/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";

/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(0);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ function(module, exports, __webpack_require__) {

	var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__(1), __webpack_require__(3), __webpack_require__(4)], __WEBPACK_AMD_DEFINE_RESULT__ = function(R) {

	    return R;

	}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));

/***/ },
/* 1 */
/***/ function(module, exports, __webpack_require__) {

	var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__(2)], __WEBPACK_AMD_DEFINE_RESULT__ = function(eve) {

	    /*\
	     * Raphael
	     [ method ]
	     **
	     * Creates a canvas object on which to draw.
	     * You must do this first, as all future calls to drawing methods
	     * from this instance will be bound to this canvas.
	     > Parameters
	     **
	     - container (HTMLElement|string) DOM element or its ID which is going to be a parent for drawing surface
	     - width (number)
	     - height (number)
	     - callback (function) #optional callback function which is going to be executed in the context of newly created paper
	     * or
	     - x (number)
	     - y (number)
	     - width (number)
	     - height (number)
	     - callback (function) #optional callback function which is going to be executed in the context of newly created paper
	     * or
	     - all (array) (first 3 or 4 elements in the array are equal to [containerID, width, height] or [x, y, width, height]. The rest are element descriptions in format {type: type, <attributes>}). See @Paper.add.
	     - callback (function) #optional callback function which is going to be executed in the context of newly created paper
	     * or
	     - onReadyCallback (function) function that is going to be called on DOM ready event. You can also subscribe to this event via Eves DOMLoad event. In this case method returns `undefined`.
	     = (object) @Paper
	     > Usage
	     | // Each of the following examples create a canvas
	     | // that is 320px wide by 200px high.
	     | // Canvas is created at the viewports 10,50 coordinate.
	     | var paper = Raphael(10, 50, 320, 200);
	     | // Canvas is created at the top left corner of the #notepad element
	     | // (or its top right corner in dir="rtl" elements)
	     | var paper = Raphael(document.getElementById("notepad"), 320, 200);
	     | // Same as above
	     | var paper = Raphael("notepad", 320, 200);
	     | // Image dump
	     | var set = Raphael(["notepad", 320, 200, {
	     |     type: "rect",
	     |     x: 10,
	     |     y: 10,
	     |     width: 25,
	     |     height: 25,
	     |     stroke: "#f00"
	     | }, {
	     |     type: "text",
	     |     x: 30,
	     |     y: 40,
	     |     text: "Dump"
	     | }]);
	    \*/
	    function R(first) {
	        if (R.is(first, "function")) {
	            return loaded ? first() : eve.on("raphael.DOMload", first);
	        } else if (R.is(first, array)) {
	            return R._engine.create[apply](R, first.splice(0, 3 + R.is(first[0], nu))).add(first);
	        } else {
	            var args = Array.prototype.slice.call(arguments, 0);
	            if (R.is(args[args.length - 1], "function")) {
	                var f = args.pop();
	                return loaded ? f.call(R._engine.create[apply](R, args)) : eve.on("raphael.DOMload", function () {
	                    f.call(R._engine.create[apply](R, args));
	                });
	            } else {
	                return R._engine.create[apply](R, arguments);
	            }
	        }
	    }
	    R.version = "2.2.0";
	    R.eve = eve;
	    var loaded,
	        separator = /[, ]+/,
	        elements = {circle: 1, rect: 1, path: 1, ellipse: 1, text: 1, image: 1},
	        formatrg = /\{(\d+)\}/g,
	        proto = "prototype",
	        has = "hasOwnProperty",
	        g = {
	            doc: document,
	            win: window
	        },
	        oldRaphael = {
	            was: Object.prototype[has].call(g.win, "Raphael"),
	            is: g.win.Raphael
	        },
	        Paper = function () {
	            /*\
	             * Paper.ca
	             [ property (object) ]
	             **
	             * Shortcut for @Paper.customAttributes
	            \*/
	            /*\
	             * Paper.customAttributes
	             [ property (object) ]
	             **
	             * If you have a set of attributes that you would like to represent
	             * as a function of some number you can do it easily with custom attributes:
	             > Usage
	             | paper.customAttributes.hue = function (num) {
	             |     num = num % 1;
	             |     return {fill: "hsb(" + num + ", 0.75, 1)"};
	             | };
	             | // Custom attribute hue will change fill
	             | // to be given hue with fixed saturation and brightness.
	             | // Now you can use it like this:
	             | var c = paper.circle(10, 10, 10).attr({hue: .45});
	             | // or even like this:
	             | c.animate({hue: 1}, 1e3);
	             |
	             | // You could also create custom attribute
	             | // with multiple parameters:
	             | paper.customAttributes.hsb = function (h, s, b) {
	             |     return {fill: "hsb(" + [h, s, b].join(",") + ")"};
	             | };
	             | c.attr({hsb: "0.5 .8 1"});
	             | c.animate({hsb: [1, 0, 0.5]}, 1e3);
	            \*/
	            this.ca = this.customAttributes = {};
	        },
	        paperproto,
	        appendChild = "appendChild",
	        apply = "apply",
	        concat = "concat",
	        supportsTouch = ('ontouchstart' in g.win) || g.win.DocumentTouch && g.doc instanceof DocumentTouch, //taken from Modernizr touch test
	        E = "",
	        S = " ",
	        Str = String,
	        split = "split",
	        events = "click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel contextmenu"[split](S),
	        touchMap = {
	            mousedown: "touchstart",
	            mousemove: "touchmove",
	            mouseup: "touchend"
	        },
	        lowerCase = Str.prototype.toLowerCase,
	        math = Math,
	        mmax = math.max,
	        mmin = math.min,
	        abs = math.abs,
	        pow = math.pow,
	        PI = math.PI,
	        nu = "number",
	        string = "string",
	        array = "array",
	        toString = "toString",
	        fillString = "fill",
	        objectToString = Object.prototype.toString,
	        paper = {},
	        push = "push",
	        ISURL = R._ISURL = /^url\(['"]?(.+?)['"]?\)$/i,
	        colourRegExp = /^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,
	        isnan = {"NaN": 1, "Infinity": 1, "-Infinity": 1},
	        bezierrg = /^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,
	        round = math.round,
	        setAttribute = "setAttribute",
	        toFloat = parseFloat,
	        toInt = parseInt,
	        upperCase = Str.prototype.toUpperCase,
	        availableAttrs = R._availableAttrs = {
	            "arrow-end": "none",
	            "arrow-start": "none",
	            blur: 0,
	            "clip-rect": "0 0 1e9 1e9",
	            cursor: "default",
	            cx: 0,
	            cy: 0,
	            fill: "#fff",
	            "fill-opacity": 1,
	            font: '10px "Arial"',
	            "font-family": '"Arial"',
	            "font-size": "10",
	            "font-style": "normal",
	            "font-weight": 400,
	            gradient: 0,
	            height: 0,
	            href: "http://raphaeljs.com/",
	            "letter-spacing": 0,
	            opacity: 1,
	            path: "M0,0",
	            r: 0,
	            rx: 0,
	            ry: 0,
	            src: "",
	            stroke: "#000",
	            "stroke-dasharray": "",
                //not for vml
	            "stroke-dashoffset" : 0,
	            "stroke-linecap": "butt",
	            "stroke-linejoin": "butt",
	            "stroke-miterlimit": 0,
	            "stroke-opacity": 1,
	            "stroke-width": 1,
	            target: "_blank",
	            "text-anchor": "middle",
	            title: "Raphael",
	            transform: "",
	            width: 0,
	            x: 0,
	            y: 0,
	            "class": ""
	        },
	        availableAnimAttrs = R._availableAnimAttrs = {
	            blur: nu,
	            "clip-rect": "csv",
	            cx: nu,
	            cy: nu,
	            fill: "colour",
	            "fill-opacity": nu,
	            "font-size": nu,
	            height: nu,
	            opacity: nu,
	            path: "path",
	            r: nu,
	            rx: nu,
	            ry: nu,
	            stroke: "colour",
	            "stroke-opacity": nu,
	            "stroke-width": nu,
	            transform: "transform",
	            width: nu,
	            x: nu,
	            y: nu
	        },
	        whitespace = /[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]/g,
	        commaSpaces = /[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,
	        hsrg = {hs: 1, rg: 1},
	        p2s = /,?([achlmqrstvxz]),?/gi,
	        pathCommand = /([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,
	        tCommand = /([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,
	        pathValues = /(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/ig,
	        radial_gradient = R._radial_gradient = /^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,
	        eldata = {},
	        sortByKey = function (a, b) {
	            return a.key - b.key;
	        },
	        sortByNumber = function (a, b) {
	            return toFloat(a) - toFloat(b);
	        },
	        fun = function () {},
	        pipe = function (x) {
	            return x;
	        },
	        rectPath = R._rectPath = function (x, y, w, h, r) {
	            if (r) {
	                return [["M", x + r, y], ["l", w - r * 2, 0], ["a", r, r, 0, 0, 1, r, r], ["l", 0, h - r * 2], ["a", r, r, 0, 0, 1, -r, r], ["l", r * 2 - w, 0], ["a", r, r, 0, 0, 1, -r, -r], ["l", 0, r * 2 - h], ["a", r, r, 0, 0, 1, r, -r], ["z"]];
	            }
	            return [["M", x, y], ["l", w, 0], ["l", 0, h], ["l", -w, 0], ["z"]];
	        },
	        ellipsePath = function (x, y, rx, ry) {
	            if (ry == null) {
	                ry = rx;
	            }
	            return [["M", x, y], ["m", 0, -ry], ["a", rx, ry, 0, 1, 1, 0, 2 * ry], ["a", rx, ry, 0, 1, 1, 0, -2 * ry], ["z"]];
	        },
	        getPath = R._getPath = {
	            path: function (el) {
	                return el.attr("path");
	            },
	            circle: function (el) {
	                var a = el.attrs;
	                return ellipsePath(a.cx, a.cy, a.r);
	            },
	            ellipse: function (el) {
	                var a = el.attrs;
	                return ellipsePath(a.cx, a.cy, a.rx, a.ry);
	            },
	            rect: function (el) {
	                var a = el.attrs;
	                return rectPath(a.x, a.y, a.width, a.height, a.r);
	            },
	            image: function (el) {
	                var a = el.attrs;
	                return rectPath(a.x, a.y, a.width, a.height);
	            },
	            text: function (el) {
	                var bbox = el._getBBox();
	                return rectPath(bbox.x, bbox.y, bbox.width, bbox.height);
	            },
	            set : function(el) {
	                var bbox = el._getBBox();
	                return rectPath(bbox.x, bbox.y, bbox.width, bbox.height);
	            }
	        },
	        /*\
	         * Raphael.mapPath
	         [ method ]
	         **
	         * Transform the path string with given matrix.
	         > Parameters
	         - path (string) path string
	         - matrix (object) see @Matrix
	         = (string) transformed path string
	        \*/
	        mapPath = R.mapPath = function (path, matrix) {
	            if (!matrix) {
	                return path;
	            }
	            var x, y, i, j, ii, jj, pathi;
	            path = path2curve(path);
	            for (i = 0, ii = path.length; i < ii; i++) {
	                pathi = path[i];
	                for (j = 1, jj = pathi.length; j < jj; j += 2) {
	                    x = matrix.x(pathi[j], pathi[j + 1]);
	                    y = matrix.y(pathi[j], pathi[j + 1]);
	                    pathi[j] = x;
	                    pathi[j + 1] = y;
	                }
	            }
	            return path;
	        };

	    R._g = g;
	    /*\
	     * Raphael.type
	     [ property (string) ]
	     **
	     * Can be SVG, VML or empty, depending on browser support.
	    \*/
	    R.type = (g.win.SVGAngle || g.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure", "1.1") ? "SVG" : "VML");
	    if (R.type == "VML") {
	        var d = g.doc.createElement("div"),
	            b;
	        d.innerHTML = '<v:shape adj="1"/>';
	        b = d.firstChild;
	        b.style.behavior = "url(#default#VML)";
	        if (!(b && typeof b.adj == "object")) {
	            return (R.type = E);
	        }
	        d = null;
	    }
	    /*\
	     * Raphael.svg
	     [ property (boolean) ]
	     **
	     * `true` if browser supports SVG.
	    \*/
	    /*\
	     * Raphael.vml
	     [ property (boolean) ]
	     **
	     * `true` if browser supports VML.
	    \*/
	    R.svg = !(R.vml = R.type == "VML");
	    R._Paper = Paper;
	    /*\
	     * Raphael.fn
	     [ property (object) ]
	     **
	     * You can add your own method to the canvas. For example if you want to draw a pie chart,
	     * you can create your own pie chart function and ship it as a Raphal plugin. To do this
	     * you need to extend the `Raphael.fn` object. You should modify the `fn` object before a
	     * Raphal instance is created, otherwise it will take no effect. Please note that the
	     * ability for namespaced plugins was removed in Raphael 2.0. It is up to the plugin to
	     * ensure any namespacing ensures proper context.
	     > Usage
	     | Raphael.fn.arrow = function (x1, y1, x2, y2, size) {
	     |     return this.path( ... );
	     | };
	     | // or create namespace
	     | Raphael.fn.mystuff = {
	     |     arrow: function () {},
	     |     star: function () {},
	     |     // etc
	     | };
	     | var paper = Raphael(10, 10, 630, 480);
	     | // then use it
	     | paper.arrow(10, 10, 30, 30, 5).attr({fill: "#f00"});
	     | paper.mystuff.arrow();
	     | paper.mystuff.star();
	    \*/
	    R.fn = paperproto = Paper.prototype = R.prototype;
	    R._id = 0;
	    /*\
	     * Raphael.is
	     [ method ]
	     **
	     * Handful of replacements for `typeof` operator.
	     > Parameters
	     - o () any object or primitive
	     - type (string) name of the type, i.e. string, function, number, etc.
	     = (boolean) is given value is of given type
	    \*/
	    R.is = function (o, type) {
	        type = lowerCase.call(type);
	        if (type == "finite") {
	            return !isnan[has](+o);
	        }
	        if (type == "array") {
	            return o instanceof Array;
	        }
	        return  (type == "null" && o === null) ||
	                (type == typeof o && o !== null) ||
	                (type == "object" && o === Object(o)) ||
	                (type == "array" && Array.isArray && Array.isArray(o)) ||
	                objectToString.call(o).slice(8, -1).toLowerCase() == type;
	    };

	    function clone(obj) {
	        if (typeof obj == "function" || Object(obj) !== obj) {
	            return obj;
	        }
	        var res = new obj.constructor;
	        for (var key in obj) if (obj[has](key)) {
	            res[key] = clone(obj[key]);
	        }
	        return res;
	    }

	    /*\
	     * Raphael.angle
	     [ method ]
	     **
	     * Returns angle between two or three points
	     > Parameters
	     - x1 (number) x coord of first point
	     - y1 (number) y coord of first point
	     - x2 (number) x coord of second point
	     - y2 (number) y coord of second point
	     - x3 (number) #optional x coord of third point
	     - y3 (number) #optional y coord of third point
	     = (number) angle in degrees.
	    \*/
	    R.angle = function (x1, y1, x2, y2, x3, y3) {
	        if (x3 == null) {
	            var x = x1 - x2,
	                y = y1 - y2;
	            if (!x && !y) {
	                return 0;
	            }
	            return (180 + math.atan2(-y, -x) * 180 / PI + 360) % 360;
	        } else {
	            return R.angle(x1, y1, x3, y3) - R.angle(x2, y2, x3, y3);
	        }
	    };
	    /*\
	     * Raphael.rad
	     [ method ]
	     **
	     * Transform angle to radians
	     > Parameters
	     - deg (number) angle in degrees
	     = (number) angle in radians.
	    \*/
	    R.rad = function (deg) {
	        return deg % 360 * PI / 180;
	    };
	    /*\
	     * Raphael.deg
	     [ method ]
	     **
	     * Transform angle to degrees
	     > Parameters
	     - rad (number) angle in radians
	     = (number) angle in degrees.
	    \*/
	    R.deg = function (rad) {
	        return Math.round ((rad * 180 / PI% 360)* 1000) / 1000;
	    };
	    /*\
	     * Raphael.snapTo
	     [ method ]
	     **
	     * Snaps given value to given grid.
	     > Parameters
	     - values (array|number) given array of values or step of the grid
	     - value (number) value to adjust
	     - tolerance (number) #optional tolerance for snapping. Default is `10`.
	     = (number) adjusted value.
	    \*/
	    R.snapTo = function (values, value, tolerance) {
	        tolerance = R.is(tolerance, "finite") ? tolerance : 10;
	        if (R.is(values, array)) {
	            var i = values.length;
	            while (i--) if (abs(values[i] - value) <= tolerance) {
	                return values[i];
	            }
	        } else {
	            values = +values;
	            var rem = value % values;
	            if (rem < tolerance) {
	                return value - rem;
	            }
	            if (rem > values - tolerance) {
	                return value - rem + values;
	            }
	        }
	        return value;
	    };

	    /*\
	     * Raphael.createUUID
	     [ method ]
	     **
	     * Returns RFC4122, version 4 ID
	    \*/
	    var createUUID = R.createUUID = (function (uuidRegEx, uuidReplacer) {
	        return function () {
	            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uuidRegEx, uuidReplacer).toUpperCase();
	        };
	    })(/[xy]/g, function (c) {
	        var r = math.random() * 16 | 0,
	            v = c == "x" ? r : (r & 3 | 8);
	        return v.toString(16);
	    });

	    /*\
	     * Raphael.setWindow
	     [ method ]
	     **
	     * Used when you need to draw in `&lt;iframe>`. Switched window to the iframe one.
	     > Parameters
	     - newwin (window) new window object
	    \*/
	    R.setWindow = function (newwin) {
	        eve("raphael.setWindow", R, g.win, newwin);
	        g.win = newwin;
	        g.doc = g.win.document;
	        if (R._engine.initWin) {
	            R._engine.initWin(g.win);
	        }
	    };
	    var toHex = function (color) {
	        if (R.vml) {
	            // http://dean.edwards.name/weblog/2009/10/convert-any-colour-value-to-hex-in-msie/
	            var trim = /^\s+|\s+$/g;
	            var bod;
	            try {
	                var docum = new ActiveXObject("htmlfile");
	                docum.write("<body>");
	                docum.close();
	                bod = docum.body;
	            } catch(e) {
	                bod = createPopup().document.body;
	            }
	            var range = bod.createTextRange();
	            toHex = cacher(function (color) {
	                try {
	                    bod.style.color = Str(color).replace(trim, E);
	                    var value = range.queryCommandValue("ForeColor");
	                    value = ((value & 255) << 16) | (value & 65280) | ((value & 16711680) >>> 16);
	                    return "#" + ("000000" + value.toString(16)).slice(-6);
	                } catch(e) {
	                    return "none";
	                }
	            });
	        } else {
	            var i = g.doc.createElement("i");
	            i.title = "Rapha\xebl Colour Picker";
	            i.style.display = "none";
	            g.doc.body.appendChild(i);
	            toHex = cacher(function (color) {
	                i.style.color = color;
	                return g.doc.defaultView.getComputedStyle(i, E).getPropertyValue("color");
	            });
	        }
	        return toHex(color);
	    },
	    hsbtoString = function () {
	        return "hsb(" + [this.h, this.s, this.b] + ")";
	    },
	    hsltoString = function () {
	        return "hsl(" + [this.h, this.s, this.l] + ")";
	    },
	    rgbtoString = function () {
	        return this.hex;
	    },
	    prepareRGB = function (r, g, b) {
	        if (g == null && R.is(r, "object") && "r" in r && "g" in r && "b" in r) {
	            b = r.b;
	            g = r.g;
	            r = r.r;
	        }
	        if (g == null && R.is(r, string)) {
	            var clr = R.getRGB(r);
	            r = clr.r;
	            g = clr.g;
	            b = clr.b;
	        }
	        if (r > 1 || g > 1 || b > 1) {
	            r /= 255;
	            g /= 255;
	            b /= 255;
	        }

	        return [r, g, b];
	    },
	    packageRGB = function (r, g, b, o) {
	        r *= 255;
	        g *= 255;
	        b *= 255;
	        var rgb = {
	            r: r,
	            g: g,
	            b: b,
	            hex: R.rgb(r, g, b),
	            toString: rgbtoString
	        };
	        R.is(o, "finite") && (rgb.opacity = o);
	        return rgb;
	    };

	    /*\
	     * Raphael.color
	     [ method ]
	     **
	     * Parses the color string and returns object with all values for the given color.
	     > Parameters
	     - clr (string) color string in one of the supported formats (see @Raphael.getRGB)
	     = (object) Combined RGB & HSB object in format:
	     o {
	     o     r (number) red,
	     o     g (number) green,
	     o     b (number) blue,
	     o     hex (string) color in HTML/CSS format: #,
	     o     error (boolean) `true` if string cant be parsed,
	     o     h (number) hue,
	     o     s (number) saturation,
	     o     v (number) value (brightness),
	     o     l (number) lightness
	     o }
	    \*/
	    R.color = function (clr) {
	        var rgb;
	        if (R.is(clr, "object") && "h" in clr && "s" in clr && "b" in clr) {
	            rgb = R.hsb2rgb(clr);
	            clr.r = rgb.r;
	            clr.g = rgb.g;
	            clr.b = rgb.b;
	            clr.hex = rgb.hex;
	        } else if (R.is(clr, "object") && "h" in clr && "s" in clr && "l" in clr) {
	            rgb = R.hsl2rgb(clr);
	            clr.r = rgb.r;
	            clr.g = rgb.g;
	            clr.b = rgb.b;
	            clr.hex = rgb.hex;
	        } else {
	            if (R.is(clr, "string")) {
	                clr = R.getRGB(clr);
	            }
	            if (R.is(clr, "object") && "r" in clr && "g" in clr && "b" in clr) {
	                rgb = R.rgb2hsl(clr);
	                clr.h = rgb.h;
	                clr.s = rgb.s;
	                clr.l = rgb.l;
	                rgb = R.rgb2hsb(clr);
	                clr.v = rgb.b;
	            } else {
	                clr = {hex: "none"};
	                clr.r = clr.g = clr.b = clr.h = clr.s = clr.v = clr.l = -1;
	            }
	        }
	        clr.toString = rgbtoString;
	        return clr;
	    };
	    /*\
	     * Raphael.hsb2rgb
	     [ method ]
	     **
	     * Converts HSB values to RGB object.
	     > Parameters
	     - h (number) hue
	     - s (number) saturation
	     - v (number) value or brightness
	     = (object) RGB object in format:
	     o {
	     o     r (number) red,
	     o     g (number) green,
	     o     b (number) blue,
	     o     hex (string) color in HTML/CSS format: #
	     o }
	    \*/
	    R.hsb2rgb = function (h, s, v, o) {
	        if (this.is(h, "object") && "h" in h && "s" in h && "b" in h) {
	            v = h.b;
	            s = h.s;
	            o = h.o;
	            h = h.h;
	        }
	        h *= 360;
	        var R, G, B, X, C;
	        h = (h % 360) / 60;
	        C = v * s;
	        X = C * (1 - abs(h % 2 - 1));
	        R = G = B = v - C;

	        h = ~~h;
	        R += [C, X, 0, 0, X, C][h];
	        G += [X, C, C, X, 0, 0][h];
	        B += [0, 0, X, C, C, X][h];
	        return packageRGB(R, G, B, o);
	    };
	    /*\
	     * Raphael.hsl2rgb
	     [ method ]
	     **
	     * Converts HSL values to RGB object.
	     > Parameters
	     - h (number) hue
	     - s (number) saturation
	     - l (number) luminosity
	     = (object) RGB object in format:
	     o {
	     o     r (number) red,
	     o     g (number) green,
	     o     b (number) blue,
	     o     hex (string) color in HTML/CSS format: #
	     o }
	    \*/
	    R.hsl2rgb = function (h, s, l, o) {
	        if (this.is(h, "object") && "h" in h && "s" in h && "l" in h) {
	            l = h.l;
	            s = h.s;
	            h = h.h;
	        }
	        if (h > 1 || s > 1 || l > 1) {
	            h /= 360;
	            s /= 100;
	            l /= 100;
	        }
	        h *= 360;
	        var R, G, B, X, C;
	        h = (h % 360) / 60;
	        C = 2 * s * (l < .5 ? l : 1 - l);
	        X = C * (1 - abs(h % 2 - 1));
	        R = G = B = l - C / 2;

	        h = ~~h;
	        R += [C, X, 0, 0, X, C][h];
	        G += [X, C, C, X, 0, 0][h];
	        B += [0, 0, X, C, C, X][h];
	        return packageRGB(R, G, B, o);
	    };
	    /*\
	     * Raphael.rgb2hsb
	     [ method ]
	     **
	     * Converts RGB values to HSB object.
	     > Parameters
	     - r (number) red
	     - g (number) green
	     - b (number) blue
	     = (object) HSB object in format:
	     o {
	     o     h (number) hue
	     o     s (number) saturation
	     o     b (number) brightness
	     o }
	    \*/
	    R.rgb2hsb = function (r, g, b) {
	        b = prepareRGB(r, g, b);
	        r = b[0];
	        g = b[1];
	        b = b[2];

	        var H, S, V, C;
	        V = mmax(r, g, b);
	        C = V - mmin(r, g, b);
	        H = (C == 0 ? null :
	             V == r ? (g - b) / C :
	             V == g ? (b - r) / C + 2 :
	                      (r - g) / C + 4
	            );
	        H = ((H + 360) % 6) * 60 / 360;
	        S = C == 0 ? 0 : C / V;
	        return {h: H, s: S, b: V, toString: hsbtoString};
	    };
	    /*\
	     * Raphael.rgb2hsl
	     [ method ]
	     **
	     * Converts RGB values to HSL object.
	     > Parameters
	     - r (number) red
	     - g (number) green
	     - b (number) blue
	     = (object) HSL object in format:
	     o {
	     o     h (number) hue
	     o     s (number) saturation
	     o     l (number) luminosity
	     o }
	    \*/
	    R.rgb2hsl = function (r, g, b) {
	        b = prepareRGB(r, g, b);
	        r = b[0];
	        g = b[1];
	        b = b[2];

	        var H, S, L, M, m, C;
	        M = mmax(r, g, b);
	        m = mmin(r, g, b);
	        C = M - m;
	        H = (C == 0 ? null :
	             M == r ? (g - b) / C :
	             M == g ? (b - r) / C + 2 :
	                      (r - g) / C + 4);
	        H = ((H + 360) % 6) * 60 / 360;
	        L = (M + m) / 2;
	        S = (C == 0 ? 0 :
	             L < .5 ? C / (2 * L) :
	                      C / (2 - 2 * L));
	        return {h: H, s: S, l: L, toString: hsltoString};
	    };
	    R._path2string = function () {
	        return this.join(",").replace(p2s, "$1");
	    };
	    function repush(array, item) {
	        for (var i = 0, ii = array.length; i < ii; i++) if (array[i] === item) {
	            return array.push(array.splice(i, 1)[0]);
	        }
	    }
	    function cacher(f, scope, postprocessor) {
	        function newf() {
	            var arg = Array.prototype.slice.call(arguments, 0),
	                args = arg.join("\u2400"),
	                cache = newf.cache = newf.cache || {},
	                count = newf.count = newf.count || [];
	            if (cache[has](args)) {
	                repush(count, args);
	                return postprocessor ? postprocessor(cache[args]) : cache[args];
	            }
	            count.length >= 1e3 && delete cache[count.shift()];
	            count.push(args);
	            cache[args] = f[apply](scope, arg);
	            return postprocessor ? postprocessor(cache[args]) : cache[args];
	        }
	        return newf;
	    }

	    var preload = R._preload = function (src, f) {
	        var img = g.doc.createElement("img");
	        img.style.cssText = "position:absolute;left:-9999em;top:-9999em";
	        img.onload = function () {
	            f.call(this);
	            this.onload = null;
	            g.doc.body.removeChild(this);
	        };
	        img.onerror = function () {
	            g.doc.body.removeChild(this);
	        };
	        g.doc.body.appendChild(img);
	        img.src = src;
	    };

	    function clrToString() {
	        return this.hex;
	    }

	    /*\
	     * Raphael.getRGB
	     [ method ]
	     **
	     * Parses colour string as RGB object
	     > Parameters
	     - colour (string) colour string in one of formats:
	     # <ul>
	     #     <li>Colour name (<code>red</code>, <code>green</code>, <code>cornflowerblue</code>, etc)</li>
	     #     <li>#  shortened HTML colour: (<code>#000</code>, <code>#fc0</code>, etc)</li>
	     #     <li>#  full length HTML colour: (<code>#000000</code>, <code>#bd2300</code>)</li>
	     #     <li>rgb(, , )  red, green and blue channels values: (<code>rgb(200,&nbsp;100,&nbsp;0)</code>)</li>
	     #     <li>rgb(%, %, %)  same as above, but in %: (<code>rgb(100%,&nbsp;175%,&nbsp;0%)</code>)</li>
	     #     <li>hsb(, , )  hue, saturation and brightness values: (<code>hsb(0.5,&nbsp;0.25,&nbsp;1)</code>)</li>
	     #     <li>hsb(%, %, %)  same as above, but in %</li>
	     #     <li>hsl(, , )  same as hsb</li>
	     #     <li>hsl(%, %, %)  same as hsb</li>
	     # </ul>
	     = (object) RGB object in format:
	     o {
	     o     r (number) red,
	     o     g (number) green,
	     o     b (number) blue
	     o     hex (string) color in HTML/CSS format: #,
	     o     error (boolean) true if string cant be parsed
	     o }
	    \*/
	    R.getRGB = cacher(function (colour) {
	        if (!colour || !!((colour = Str(colour)).indexOf("-") + 1)) {
	            return {r: -1, g: -1, b: -1, hex: "none", error: 1, toString: clrToString};
	        }
	        if (colour == "none") {
	            return {r: -1, g: -1, b: -1, hex: "none", toString: clrToString};
	        }
	        !(hsrg[has](colour.toLowerCase().substring(0, 2)) || colour.charAt() == "#") && (colour = toHex(colour));
	        var res,
	            red,
	            green,
	            blue,
	            opacity,
	            t,
	            values,
	            rgb = colour.match(colourRegExp);
	        if (rgb) {
	            if (rgb[2]) {
	                blue = toInt(rgb[2].substring(5), 16);
	                green = toInt(rgb[2].substring(3, 5), 16);
	                red = toInt(rgb[2].substring(1, 3), 16);
	            }
	            if (rgb[3]) {
	                blue = toInt((t = rgb[3].charAt(3)) + t, 16);
	                green = toInt((t = rgb[3].charAt(2)) + t, 16);
	                red = toInt((t = rgb[3].charAt(1)) + t, 16);
	            }
	            if (rgb[4]) {
	                values = rgb[4][split](commaSpaces);
	                red = toFloat(values[0]);
	                values[0].slice(-1) == "%" && (red *= 2.55);
	                green = toFloat(values[1]);
	                values[1].slice(-1) == "%" && (green *= 2.55);
	                blue = toFloat(values[2]);
	                values[2].slice(-1) == "%" && (blue *= 2.55);
	                rgb[1].toLowerCase().slice(0, 4) == "rgba" && (opacity = toFloat(values[3]));
	                values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
	            }
	            if (rgb[5]) {
	                values = rgb[5][split](commaSpaces);
	                red = toFloat(values[0]);
	                values[0].slice(-1) == "%" && (red *= 2.55);
	                green = toFloat(values[1]);
	                values[1].slice(-1) == "%" && (green *= 2.55);
	                blue = toFloat(values[2]);
	                values[2].slice(-1) == "%" && (blue *= 2.55);
	                (values[0].slice(-3) == "deg" || values[0].slice(-1) == "\xb0") && (red /= 360);
	                rgb[1].toLowerCase().slice(0, 4) == "hsba" && (opacity = toFloat(values[3]));
	                values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
	                return R.hsb2rgb(red, green, blue, opacity);
	            }
	            if (rgb[6]) {
	                values = rgb[6][split](commaSpaces);
	                red = toFloat(values[0]);
	                values[0].slice(-1) == "%" && (red *= 2.55);
	                green = toFloat(values[1]);
	                values[1].slice(-1) == "%" && (green *= 2.55);
	                blue = toFloat(values[2]);
	                values[2].slice(-1) == "%" && (blue *= 2.55);
	                (values[0].slice(-3) == "deg" || values[0].slice(-1) == "\xb0") && (red /= 360);
	                rgb[1].toLowerCase().slice(0, 4) == "hsla" && (opacity = toFloat(values[3]));
	                values[3] && values[3].slice(-1) == "%" && (opacity /= 100);
	                return R.hsl2rgb(red, green, blue, opacity);
	            }
	            rgb = {r: red, g: green, b: blue, toString: clrToString};
	            rgb.hex = "#" + (16777216 | blue | (green << 8) | (red << 16)).toString(16).slice(1);
	            R.is(opacity, "finite") && (rgb.opacity = opacity);
	            return rgb;
	        }
	        return {r: -1, g: -1, b: -1, hex: "none", error: 1, toString: clrToString};
	    }, R);
	    /*\
	     * Raphael.hsb
	     [ method ]
	     **
	     * Converts HSB values to hex representation of the colour.
	     > Parameters
	     - h (number) hue
	     - s (number) saturation
	     - b (number) value or brightness
	     = (string) hex representation of the colour.
	    \*/
	    R.hsb = cacher(function (h, s, b) {
	        return R.hsb2rgb(h, s, b).hex;
	    });
	    /*\
	     * Raphael.hsl
	     [ method ]
	     **
	     * Converts HSL values to hex representation of the colour.
	     > Parameters
	     - h (number) hue
	     - s (number) saturation
	     - l (number) luminosity
	     = (string) hex representation of the colour.
	    \*/
	    R.hsl = cacher(function (h, s, l) {
	        return R.hsl2rgb(h, s, l).hex;
	    });
	    /*\
	     * Raphael.rgb
	     [ method ]
	     **
	     * Converts RGB values to hex representation of the colour.
	     > Parameters
	     - r (number) red
	     - g (number) green
	     - b (number) blue
	     = (string) hex representation of the colour.
	    \*/
	    R.rgb = cacher(function (r, g, b) {
	        function round(x) { return (x + 0.5) | 0; }
	        return "#" + (16777216 | round(b) | (round(g) << 8) | (round(r) << 16)).toString(16).slice(1);
	    });
	    /*\
	     * Raphael.getColor
	     [ method ]
	     **
	     * On each call returns next colour in the spectrum. To reset it back to red call @Raphael.getColor.reset
	     > Parameters
	     - value (number) #optional brightness, default is `0.75`
	     = (string) hex representation of the colour.
	    \*/
	    R.getColor = function (value) {
	        var start = this.getColor.start = this.getColor.start || {h: 0, s: 1, b: value || .75},
	            rgb = this.hsb2rgb(start.h, start.s, start.b);
	        start.h += .075;
	        if (start.h > 1) {
	            start.h = 0;
	            start.s -= .2;
	            start.s <= 0 && (this.getColor.start = {h: 0, s: 1, b: start.b});
	        }
	        return rgb.hex;
	    };
	    /*\
	     * Raphael.getColor.reset
	     [ method ]
	     **
	     * Resets spectrum position for @Raphael.getColor back to red.
	    \*/
	    R.getColor.reset = function () {
	        delete this.start;
	    };

	    // http://schepers.cc/getting-to-the-point
	    function catmullRom2bezier(crp, z) {
	        var d = [];
	        for (var i = 0, iLen = crp.length; iLen - 2 * !z > i; i += 2) {
	            var p = [
	                        {x: +crp[i - 2], y: +crp[i - 1]},
	                        {x: +crp[i],     y: +crp[i + 1]},
	                        {x: +crp[i + 2], y: +crp[i + 3]},
	                        {x: +crp[i + 4], y: +crp[i + 5]}
	                    ];
	            if (z) {
	                if (!i) {
	                    p[0] = {x: +crp[iLen - 2], y: +crp[iLen - 1]};
	                } else if (iLen - 4 == i) {
	                    p[3] = {x: +crp[0], y: +crp[1]};
	                } else if (iLen - 2 == i) {
	                    p[2] = {x: +crp[0], y: +crp[1]};
	                    p[3] = {x: +crp[2], y: +crp[3]};
	                }
	            } else {
	                if (iLen - 4 == i) {
	                    p[3] = p[2];
	                } else if (!i) {
	                    p[0] = {x: +crp[i], y: +crp[i + 1]};
	                }
	            }
	            d.push(["C",
	                  (-p[0].x + 6 * p[1].x + p[2].x) / 6,
	                  (-p[0].y + 6 * p[1].y + p[2].y) / 6,
	                  (p[1].x + 6 * p[2].x - p[3].x) / 6,
	                  (p[1].y + 6*p[2].y - p[3].y) / 6,
	                  p[2].x,
	                  p[2].y
	            ]);
	        }

	        return d;
	    }
	    /*\
	     * Raphael.parsePathString
	     [ method ]
	     **
	     * Utility method
	     **
	     * Parses given path string into an array of arrays of path segments.
	     > Parameters
	     - pathString (string|array) path string or array of segments (in the last case it will be returned straight away)
	     = (array) array of segments.
	    \*/
	    R.parsePathString = function (pathString) {
	        if (!pathString) {
	            return null;
	        }
	        var pth = paths(pathString);
	        if (pth.arr) {
	            return pathClone(pth.arr);
	        }

	        var paramCounts = {a: 7, c: 6, h: 1, l: 2, m: 2, r: 4, q: 4, s: 4, t: 2, v: 1, z: 0},
	            data = [];
	        if (R.is(pathString, array) && R.is(pathString[0], array)) { // rough assumption
	            data = pathClone(pathString);
	        }
	        if (!data.length) {
	            Str(pathString).replace(pathCommand, function (a, b, c) {
	                var params = [],
	                    name = b.toLowerCase();
	                c.replace(pathValues, function (a, b) {
	                    b && params.push(+b);
	                });
	                if (name == "m" && params.length > 2) {
	                    data.push([b][concat](params.splice(0, 2)));
	                    name = "l";
	                    b = b == "m" ? "l" : "L";
	                }
	                if (name == "r") {
	                    data.push([b][concat](params));
	                } else while (params.length >= paramCounts[name]) {
	                    data.push([b][concat](params.splice(0, paramCounts[name])));
	                    if (!paramCounts[name]) {
	                        break;
	                    }
	                }
	            });
	        }
	        data.toString = R._path2string;
	        pth.arr = pathClone(data);
	        return data;
	    };
	    /*\
	     * Raphael.parseTransformString
	     [ method ]
	     **
	     * Utility method
	     **
	     * Parses given path string into an array of transformations.
	     > Parameters
	     - TString (string|array) transform string or array of transformations (in the last case it will be returned straight away)
	     = (array) array of transformations.
	    \*/
	    R.parseTransformString = cacher(function (TString) {
	        if (!TString) {
	            return null;
	        }
	        var paramCounts = {r: 3, s: 4, t: 2, m: 6},
	            data = [];
	        if (R.is(TString, array) && R.is(TString[0], array)) { // rough assumption
	            data = pathClone(TString);
	        }
	        if (!data.length) {
	            Str(TString).replace(tCommand, function (a, b, c) {
	                var params = [],
	                    name = lowerCase.call(b);
	                c.replace(pathValues, function (a, b) {
	                    b && params.push(+b);
	                });
	                data.push([b][concat](params));
	            });
	        }
	        data.toString = R._path2string;
	        return data;
	    });
	    // PATHS
	    var paths = function (ps) {
	        var p = paths.ps = paths.ps || {};
	        if (p[ps]) {
	            p[ps].sleep = 100;
	        } else {
	            p[ps] = {
	                sleep: 100
	            };
	        }
	        setTimeout(function () {
	            for (var key in p) if (p[has](key) && key != ps) {
	                p[key].sleep--;
	                !p[key].sleep && delete p[key];
	            }
	        });
	        return p[ps];
	    };
	    /*\
	     * Raphael.findDotsAtSegment
	     [ method ]
	     **
	     * Utility method
	     **
	     * Find dot coordinates on the given cubic bezier curve at the given t.
	     > Parameters
	     - p1x (number) x of the first point of the curve
	     - p1y (number) y of the first point of the curve
	     - c1x (number) x of the first anchor of the curve
	     - c1y (number) y of the first anchor of the curve
	     - c2x (number) x of the second anchor of the curve
	     - c2y (number) y of the second anchor of the curve
	     - p2x (number) x of the second point of the curve
	     - p2y (number) y of the second point of the curve
	     - t (number) position on the curve (0..1)
	     = (object) point information in format:
	     o {
	     o     x: (number) x coordinate of the point
	     o     y: (number) y coordinate of the point
	     o     m: {
	     o         x: (number) x coordinate of the left anchor
	     o         y: (number) y coordinate of the left anchor
	     o     }
	     o     n: {
	     o         x: (number) x coordinate of the right anchor
	     o         y: (number) y coordinate of the right anchor
	     o     }
	     o     start: {
	     o         x: (number) x coordinate of the start of the curve
	     o         y: (number) y coordinate of the start of the curve
	     o     }
	     o     end: {
	     o         x: (number) x coordinate of the end of the curve
	     o         y: (number) y coordinate of the end of the curve
	     o     }
	     o     alpha: (number) angle of the curve derivative at the point
	     o }
	    \*/
	    R.findDotsAtSegment = function (p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t) {
	        var t1 = 1 - t,
	            t13 = pow(t1, 3),
	            t12 = pow(t1, 2),
	            t2 = t * t,
	            t3 = t2 * t,
	            x = t13 * p1x + t12 * 3 * t * c1x + t1 * 3 * t * t * c2x + t3 * p2x,
	            y = t13 * p1y + t12 * 3 * t * c1y + t1 * 3 * t * t * c2y + t3 * p2y,
	            mx = p1x + 2 * t * (c1x - p1x) + t2 * (c2x - 2 * c1x + p1x),
	            my = p1y + 2 * t * (c1y - p1y) + t2 * (c2y - 2 * c1y + p1y),
	            nx = c1x + 2 * t * (c2x - c1x) + t2 * (p2x - 2 * c2x + c1x),
	            ny = c1y + 2 * t * (c2y - c1y) + t2 * (p2y - 2 * c2y + c1y),
	            ax = t1 * p1x + t * c1x,
	            ay = t1 * p1y + t * c1y,
	            cx = t1 * c2x + t * p2x,
	            cy = t1 * c2y + t * p2y,
	            alpha = (90 - math.atan2(mx - nx, my - ny) * 180 / PI);
	        (mx > nx || my < ny) && (alpha += 180);
	        return {
	            x: x,
	            y: y,
	            m: {x: mx, y: my},
	            n: {x: nx, y: ny},
	            start: {x: ax, y: ay},
	            end: {x: cx, y: cy},
	            alpha: alpha
	        };
	    };
	    /*\
	     * Raphael.bezierBBox
	     [ method ]
	     **
	     * Utility method
	     **
	     * Return bounding box of a given cubic bezier curve
	     > Parameters
	     - p1x (number) x of the first point of the curve
	     - p1y (number) y of the first point of the curve
	     - c1x (number) x of the first anchor of the curve
	     - c1y (number) y of the first anchor of the curve
	     - c2x (number) x of the second anchor of the curve
	     - c2y (number) y of the second anchor of the curve
	     - p2x (number) x of the second point of the curve
	     - p2y (number) y of the second point of the curve
	     * or
	     - bez (array) array of six points for bezier curve
	     = (object) point information in format:
	     o {
	     o     min: {
	     o         x: (number) x coordinate of the left point
	     o         y: (number) y coordinate of the top point
	     o     }
	     o     max: {
	     o         x: (number) x coordinate of the right point
	     o         y: (number) y coordinate of the bottom point
	     o     }
	     o }
	    \*/
	    R.bezierBBox = function (p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y) {
	        if (!R.is(p1x, "array")) {
	            p1x = [p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y];
	        }
	        var bbox = curveDim.apply(null, p1x);
	        return {
	            x: bbox.min.x,
	            y: bbox.min.y,
	            x2: bbox.max.x,
	            y2: bbox.max.y,
	            width: bbox.max.x - bbox.min.x,
	            height: bbox.max.y - bbox.min.y
	        };
	    };
	    /*\
	     * Raphael.isPointInsideBBox
	     [ method ]
	     **
	     * Utility method
	     **
	     * Returns `true` if given point is inside bounding boxes.
	     > Parameters
	     - bbox (string) bounding box
	     - x (string) x coordinate of the point
	     - y (string) y coordinate of the point
	     = (boolean) `true` if point inside
	    \*/
	    R.isPointInsideBBox = function (bbox, x, y) {
	        return x >= bbox.x && x <= bbox.x2 && y >= bbox.y && y <= bbox.y2;
	    };
	    /*\
	     * Raphael.isBBoxIntersect
	     [ method ]
	     **
	     * Utility method
	     **
	     * Returns `true` if two bounding boxes intersect
	     > Parameters
	     - bbox1 (string) first bounding box
	     - bbox2 (string) second bounding box
	     = (boolean) `true` if they intersect
	    \*/
	    R.isBBoxIntersect = function (bbox1, bbox2) {
	        var i = R.isPointInsideBBox;
	        return i(bbox2, bbox1.x, bbox1.y)
	            || i(bbox2, bbox1.x2, bbox1.y)
	            || i(bbox2, bbox1.x, bbox1.y2)
	            || i(bbox2, bbox1.x2, bbox1.y2)
	            || i(bbox1, bbox2.x, bbox2.y)
	            || i(bbox1, bbox2.x2, bbox2.y)
	            || i(bbox1, bbox2.x, bbox2.y2)
	            || i(bbox1, bbox2.x2, bbox2.y2)
	            || (bbox1.x < bbox2.x2 && bbox1.x > bbox2.x || bbox2.x < bbox1.x2 && bbox2.x > bbox1.x)
	            && (bbox1.y < bbox2.y2 && bbox1.y > bbox2.y || bbox2.y < bbox1.y2 && bbox2.y > bbox1.y);
	    };
	    function base3(t, p1, p2, p3, p4) {
	        var t1 = -3 * p1 + 9 * p2 - 9 * p3 + 3 * p4,
	            t2 = t * t1 + 6 * p1 - 12 * p2 + 6 * p3;
	        return t * t2 - 3 * p1 + 3 * p2;
	    }
	    function bezlen(x1, y1, x2, y2, x3, y3, x4, y4, z) {
	        if (z == null) {
	            z = 1;
	        }
	        z = z > 1 ? 1 : z < 0 ? 0 : z;
	        var z2 = z / 2,
	            n = 12,
	            Tvalues = [-0.1252,0.1252,-0.3678,0.3678,-0.5873,0.5873,-0.7699,0.7699,-0.9041,0.9041,-0.9816,0.9816],
	            Cvalues = [0.2491,0.2491,0.2335,0.2335,0.2032,0.2032,0.1601,0.1601,0.1069,0.1069,0.0472,0.0472],
	            sum = 0;
	        for (var i = 0; i < n; i++) {
	            var ct = z2 * Tvalues[i] + z2,
	                xbase = base3(ct, x1, x2, x3, x4),
	                ybase = base3(ct, y1, y2, y3, y4),
	                comb = xbase * xbase + ybase * ybase;
	            sum += Cvalues[i] * math.sqrt(comb);
	        }
	        return z2 * sum;
	    }
	    function getTatLen(x1, y1, x2, y2, x3, y3, x4, y4, ll) {
	        if (ll < 0 || bezlen(x1, y1, x2, y2, x3, y3, x4, y4) < ll) {
	            return;
	        }
	        var t = 1,
	            step = t / 2,
	            t2 = t - step,
	            l,
	            e = .01;
	        l = bezlen(x1, y1, x2, y2, x3, y3, x4, y4, t2);
	        while (abs(l - ll) > e) {
	            step /= 2;
	            t2 += (l < ll ? 1 : -1) * step;
	            l = bezlen(x1, y1, x2, y2, x3, y3, x4, y4, t2);
	        }
	        return t2;
	    }
	    function intersect(x1, y1, x2, y2, x3, y3, x4, y4) {
	        if (
	            mmax(x1, x2) < mmin(x3, x4) ||
	            mmin(x1, x2) > mmax(x3, x4) ||
	            mmax(y1, y2) < mmin(y3, y4) ||
	            mmin(y1, y2) > mmax(y3, y4)
	        ) {
	            return;
	        }
	        var nx = (x1 * y2 - y1 * x2) * (x3 - x4) - (x1 - x2) * (x3 * y4 - y3 * x4),
	            ny = (x1 * y2 - y1 * x2) * (y3 - y4) - (y1 - y2) * (x3 * y4 - y3 * x4),
	            denominator = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4);

	        if (!denominator) {
	            return;
	        }
	        var px = nx / denominator,
	            py = ny / denominator,
	            px2 = +px.toFixed(2),
	            py2 = +py.toFixed(2);
	        if (
	            px2 < +mmin(x1, x2).toFixed(2) ||
	            px2 > +mmax(x1, x2).toFixed(2) ||
	            px2 < +mmin(x3, x4).toFixed(2) ||
	            px2 > +mmax(x3, x4).toFixed(2) ||
	            py2 < +mmin(y1, y2).toFixed(2) ||
	            py2 > +mmax(y1, y2).toFixed(2) ||
	            py2 < +mmin(y3, y4).toFixed(2) ||
	            py2 > +mmax(y3, y4).toFixed(2)
	        ) {
	            return;
	        }
	        return {x: px, y: py};
	    }
	    function inter(bez1, bez2) {
	        return interHelper(bez1, bez2);
	    }
	    function interCount(bez1, bez2) {
	        return interHelper(bez1, bez2, 1);
	    }
	    function interHelper(bez1, bez2, justCount) {
	        var bbox1 = R.bezierBBox(bez1),
	            bbox2 = R.bezierBBox(bez2);
	        if (!R.isBBoxIntersect(bbox1, bbox2)) {
	            return justCount ? 0 : [];
	        }
	        var l1 = bezlen.apply(0, bez1),
	            l2 = bezlen.apply(0, bez2),
	            n1 = mmax(~~(l1 / 5), 1),
	            n2 = mmax(~~(l2 / 5), 1),
	            dots1 = [],
	            dots2 = [],
	            xy = {},
	            res = justCount ? 0 : [];
	        for (var i = 0; i < n1 + 1; i++) {
	            var p = R.findDotsAtSegment.apply(R, bez1.concat(i / n1));
	            dots1.push({x: p.x, y: p.y, t: i / n1});
	        }
	        for (i = 0; i < n2 + 1; i++) {
	            p = R.findDotsAtSegment.apply(R, bez2.concat(i / n2));
	            dots2.push({x: p.x, y: p.y, t: i / n2});
	        }
	        for (i = 0; i < n1; i++) {
	            for (var j = 0; j < n2; j++) {
	                var di = dots1[i],
	                    di1 = dots1[i + 1],
	                    dj = dots2[j],
	                    dj1 = dots2[j + 1],
	                    ci = abs(di1.x - di.x) < .001 ? "y" : "x",
	                    cj = abs(dj1.x - dj.x) < .001 ? "y" : "x",
	                    is = intersect(di.x, di.y, di1.x, di1.y, dj.x, dj.y, dj1.x, dj1.y);
	                if (is) {
	                    if (xy[is.x.toFixed(4)] == is.y.toFixed(4)) {
	                        continue;
	                    }
	                    xy[is.x.toFixed(4)] = is.y.toFixed(4);
	                    var t1 = di.t + abs((is[ci] - di[ci]) / (di1[ci] - di[ci])) * (di1.t - di.t),
	                        t2 = dj.t + abs((is[cj] - dj[cj]) / (dj1[cj] - dj[cj])) * (dj1.t - dj.t);
	                    if (t1 >= 0 && t1 <= 1.001 && t2 >= 0 && t2 <= 1.001) {
	                        if (justCount) {
	                            res++;
	                        } else {
	                            res.push({
	                                x: is.x,
	                                y: is.y,
	                                t1: mmin(t1, 1),
	                                t2: mmin(t2, 1)
	                            });
	                        }
	                    }
	                }
	            }
	        }
	        return res;
	    }
	    /*\
	     * Raphael.pathIntersection
	     [ method ]
	     **
	     * Utility method
	     **
	     * Finds intersections of two paths
	     > Parameters
	     - path1 (string) path string
	     - path2 (string) path string
	     = (array) dots of intersection
	     o [
	     o     {
	     o         x: (number) x coordinate of the point
	     o         y: (number) y coordinate of the point
	     o         t1: (number) t value for segment of path1
	     o         t2: (number) t value for segment of path2
	     o         segment1: (number) order number for segment of path1
	     o         segment2: (number) order number for segment of path2
	     o         bez1: (array) eight coordinates representing bezir curve for the segment of path1
	     o         bez2: (array) eight coordinates representing bezir curve for the segment of path2
	     o     }
	     o ]
	    \*/
	    R.pathIntersection = function (path1, path2) {
	        return interPathHelper(path1, path2);
	    };
	    R.pathIntersectionNumber = function (path1, path2) {
	        return interPathHelper(path1, path2, 1);
	    };
	    function interPathHelper(path1, path2, justCount) {
	        path1 = R._path2curve(path1);
	        path2 = R._path2curve(path2);
	        var x1, y1, x2, y2, x1m, y1m, x2m, y2m, bez1, bez2,
	            res = justCount ? 0 : [];
	        for (var i = 0, ii = path1.length; i < ii; i++) {
	            var pi = path1[i];
	            if (pi[0] == "M") {
	                x1 = x1m = pi[1];
	                y1 = y1m = pi[2];
	            } else {
	                if (pi[0] == "C") {
	                    bez1 = [x1, y1].concat(pi.slice(1));
	                    x1 = bez1[6];
	                    y1 = bez1[7];
	                } else {
	                    bez1 = [x1, y1, x1, y1, x1m, y1m, x1m, y1m];
	                    x1 = x1m;
	                    y1 = y1m;
	                }
	                for (var j = 0, jj = path2.length; j < jj; j++) {
	                    var pj = path2[j];
	                    if (pj[0] == "M") {
	                        x2 = x2m = pj[1];
	                        y2 = y2m = pj[2];
	                    } else {
	                        if (pj[0] == "C") {
	                            bez2 = [x2, y2].concat(pj.slice(1));
	                            x2 = bez2[6];
	                            y2 = bez2[7];
	                        } else {
	                            bez2 = [x2, y2, x2, y2, x2m, y2m, x2m, y2m];
	                            x2 = x2m;
	                            y2 = y2m;
	                        }
	                        var intr = interHelper(bez1, bez2, justCount);
	                        if (justCount) {
	                            res += intr;
	                        } else {
	                            for (var k = 0, kk = intr.length; k < kk; k++) {
	                                intr[k].segment1 = i;
	                                intr[k].segment2 = j;
	                                intr[k].bez1 = bez1;
	                                intr[k].bez2 = bez2;
	                            }
	                            res = res.concat(intr);
	                        }
	                    }
	                }
	            }
	        }
	        return res;
	    }
	    /*\
	     * Raphael.isPointInsidePath
	     [ method ]
	     **
	     * Utility method
	     **
	     * Returns `true` if given point is inside a given closed path.
	     > Parameters
	     - path (string) path string
	     - x (number) x of the point
	     - y (number) y of the point
	     = (boolean) true, if point is inside the path
	    \*/
	    R.isPointInsidePath = function (path, x, y) {
	        var bbox = R.pathBBox(path);
	        return R.isPointInsideBBox(bbox, x, y) &&
	               interPathHelper(path, [["M", x, y], ["H", bbox.x2 + 10]], 1) % 2 == 1;
	    };
	    R._removedFactory = function (methodname) {
	        return function () {
	            eve("raphael.log", null, "Rapha\xebl: you are calling to method \u201c" + methodname + "\u201d of removed object", methodname);
	        };
	    };
	    /*\
	     * Raphael.pathBBox
	     [ method ]
	     **
	     * Utility method
	     **
	     * Return bounding box of a given path
	     > Parameters
	     - path (string) path string
	     = (object) bounding box
	     o {
	     o     x: (number) x coordinate of the left top point of the box
	     o     y: (number) y coordinate of the left top point of the box
	     o     x2: (number) x coordinate of the right bottom point of the box
	     o     y2: (number) y coordinate of the right bottom point of the box
	     o     width: (number) width of the box
	     o     height: (number) height of the box
	     o     cx: (number) x coordinate of the center of the box
	     o     cy: (number) y coordinate of the center of the box
	     o }
	    \*/
	    var pathDimensions = R.pathBBox = function (path) {
	        var pth = paths(path);
	        if (pth.bbox) {
	            return clone(pth.bbox);
	        }
	        if (!path) {
	            return {x: 0, y: 0, width: 0, height: 0, x2: 0, y2: 0};
	        }
	        path = path2curve(path);
	        var x = 0,
	            y = 0,
	            X = [],
	            Y = [],
	            p;
	        for (var i = 0, ii = path.length; i < ii; i++) {
	            p = path[i];
	            if (p[0] == "M") {
	                x = p[1];
	                y = p[2];
	                X.push(x);
	                Y.push(y);
	            } else {
	                var dim = curveDim(x, y, p[1], p[2], p[3], p[4], p[5], p[6]);
	                X = X[concat](dim.min.x, dim.max.x);
	                Y = Y[concat](dim.min.y, dim.max.y);
	                x = p[5];
	                y = p[6];
	            }
	        }
	        var xmin = mmin[apply](0, X),
	            ymin = mmin[apply](0, Y),
	            xmax = mmax[apply](0, X),
	            ymax = mmax[apply](0, Y),
	            width = xmax - xmin,
	            height = ymax - ymin,
	                bb = {
	                x: xmin,
	                y: ymin,
	                x2: xmax,
	                y2: ymax,
	                width: width,
	                height: height,
	                cx: xmin + width / 2,
	                cy: ymin + height / 2
	            };
	        pth.bbox = clone(bb);
	        return bb;
	    },
	        pathClone = function (pathArray) {
	            var res = clone(pathArray);
	            res.toString = R._path2string;
	            return res;
	        },
	        pathToRelative = R._pathToRelative = function (pathArray) {
	            var pth = paths(pathArray);
	            if (pth.rel) {
	                return pathClone(pth.rel);
	            }
	            if (!R.is(pathArray, array) || !R.is(pathArray && pathArray[0], array)) { // rough assumption
	                pathArray = R.parsePathString(pathArray);
	            }
	            var res = [],
	                x = 0,
	                y = 0,
	                mx = 0,
	                my = 0,
	                start = 0;
	            if (pathArray[0][0] == "M") {
	                x = pathArray[0][1];
	                y = pathArray[0][2];
	                mx = x;
	                my = y;
	                start++;
	                res.push(["M", x, y]);
	            }
	            for (var i = start, ii = pathArray.length; i < ii; i++) {
	                var r = res[i] = [],
	                    pa = pathArray[i];
	                if (pa[0] != lowerCase.call(pa[0])) {
	                    r[0] = lowerCase.call(pa[0]);
	                    switch (r[0]) {
	                        case "a":
	                            r[1] = pa[1];
	                            r[2] = pa[2];
	                            r[3] = pa[3];
	                            r[4] = pa[4];
	                            r[5] = pa[5];
	                            r[6] = +(pa[6] - x).toFixed(3);
	                            r[7] = +(pa[7] - y).toFixed(3);
	                            break;
	                        case "v":
	                            r[1] = +(pa[1] - y).toFixed(3);
	                            break;
	                        case "m":
	                            mx = pa[1];
	                            my = pa[2];
	                        default:
	                            for (var j = 1, jj = pa.length; j < jj; j++) {
	                                r[j] = +(pa[j] - ((j % 2) ? x : y)).toFixed(3);
	                            }
	                    }
	                } else {
	                    r = res[i] = [];
	                    if (pa[0] == "m") {
	                        mx = pa[1] + x;
	                        my = pa[2] + y;
	                    }
	                    for (var k = 0, kk = pa.length; k < kk; k++) {
	                        res[i][k] = pa[k];
	                    }
	                }
	                var len = res[i].length;
	                switch (res[i][0]) {
	                    case "z":
	                        x = mx;
	                        y = my;
	                        break;
	                    case "h":
	                        x += +res[i][len - 1];
	                        break;
	                    case "v":
	                        y += +res[i][len - 1];
	                        break;
	                    default:
	                        x += +res[i][len - 2];
	                        y += +res[i][len - 1];
	                }
	            }
	            res.toString = R._path2string;
	            pth.rel = pathClone(res);
	            return res;
	        },
	        pathToAbsolute = R._pathToAbsolute = function (pathArray) {
	            var pth = paths(pathArray);
	            if (pth.abs) {
	                return pathClone(pth.abs);
	            }
	            if (!R.is(pathArray, array) || !R.is(pathArray && pathArray[0], array)) { // rough assumption
	                pathArray = R.parsePathString(pathArray);
	            }
	            if (!pathArray || !pathArray.length) {
	                return [["M", 0, 0]];
	            }
	            var res = [],
	                x = 0,
	                y = 0,
	                mx = 0,
	                my = 0,
	                start = 0;
	            if (pathArray[0][0] == "M") {
	                x = +pathArray[0][1];
	                y = +pathArray[0][2];
	                mx = x;
	                my = y;
	                start++;
	                res[0] = ["M", x, y];
	            }
	            var crz = pathArray.length == 3 && pathArray[0][0] == "M" && pathArray[1][0].toUpperCase() == "R" && pathArray[2][0].toUpperCase() == "Z";
	            for (var r, pa, i = start, ii = pathArray.length; i < ii; i++) {
	                res.push(r = []);
	                pa = pathArray[i];
	                if (pa[0] != upperCase.call(pa[0])) {
	                    r[0] = upperCase.call(pa[0]);
	                    switch (r[0]) {
	                        case "A":
	                            r[1] = pa[1];
	                            r[2] = pa[2];
	                            r[3] = pa[3];
	                            r[4] = pa[4];
	                            r[5] = pa[5];
	                            r[6] = +(pa[6] + x);
	                            r[7] = +(pa[7] + y);
	                            break;
	                        case "V":
	                            r[1] = +pa[1] + y;
	                            break;
	                        case "H":
	                            r[1] = +pa[1] + x;
	                            break;
	                        case "R":
	                            var dots = [x, y][concat](pa.slice(1));
	                            for (var j = 2, jj = dots.length; j < jj; j++) {
	                                dots[j] = +dots[j] + x;
	                                dots[++j] = +dots[j] + y;
	                            }
	                            res.pop();
	                            res = res[concat](catmullRom2bezier(dots, crz));
	                            break;
	                        case "M":
	                            mx = +pa[1] + x;
	                            my = +pa[2] + y;
	                        default:
	                            for (j = 1, jj = pa.length; j < jj; j++) {
	                                r[j] = +pa[j] + ((j % 2) ? x : y);
	                            }
	                    }
	                } else if (pa[0] == "R") {
	                    dots = [x, y][concat](pa.slice(1));
	                    res.pop();
	                    res = res[concat](catmullRom2bezier(dots, crz));
	                    r = ["R"][concat](pa.slice(-2));
	                } else {
	                    for (var k = 0, kk = pa.length; k < kk; k++) {
	                        r[k] = pa[k];
	                    }
	                }
	                switch (r[0]) {
	                    case "Z":
	                        x = mx;
	                        y = my;
	                        break;
	                    case "H":
	                        x = r[1];
	                        break;
	                    case "V":
	                        y = r[1];
	                        break;
	                    case "M":
	                        mx = r[r.length - 2];
	                        my = r[r.length - 1];
	                    default:
	                        x = r[r.length - 2];
	                        y = r[r.length - 1];
	                }
	            }
	            res.toString = R._path2string;
	            pth.abs = pathClone(res);
	            return res;
	        },
	        l2c = function (x1, y1, x2, y2) {
	            return [x1, y1, x2, y2, x2, y2];
	        },
	        q2c = function (x1, y1, ax, ay, x2, y2) {
	            var _13 = 1 / 3,
	                _23 = 2 / 3;
	            return [
	                    _13 * x1 + _23 * ax,
	                    _13 * y1 + _23 * ay,
	                    _13 * x2 + _23 * ax,
	                    _13 * y2 + _23 * ay,
	                    x2,
	                    y2
	                ];
	        },
	        a2c = function (x1, y1, rx, ry, angle, large_arc_flag, sweep_flag, x2, y2, recursive) {
	            // for more information of where this math came from visit:
	            // http://www.w3.org/TR/SVG11/implnote.html#ArcImplementationNotes
	            var _120 = PI * 120 / 180,
	                rad = PI / 180 * (+angle || 0),
	                res = [],
	                xy,
	                rotate = cacher(function (x, y, rad) {
	                    var X = x * math.cos(rad) - y * math.sin(rad),
	                        Y = x * math.sin(rad) + y * math.cos(rad);
	                    return {x: X, y: Y};
	                });
	            if (!recursive) {
	                xy = rotate(x1, y1, -rad);
	                x1 = xy.x;
	                y1 = xy.y;
	                xy = rotate(x2, y2, -rad);
	                x2 = xy.x;
	                y2 = xy.y;
	                var cos = math.cos(PI / 180 * angle),
	                    sin = math.sin(PI / 180 * angle),
	                    x = (x1 - x2) / 2,
	                    y = (y1 - y2) / 2;
	                var h = (x * x) / (rx * rx) + (y * y) / (ry * ry);
	                if (h > 1) {
	                    h = math.sqrt(h);
	                    rx = h * rx;
	                    ry = h * ry;
	                }
	                var rx2 = rx * rx,
	                    ry2 = ry * ry,
	                    k = (large_arc_flag == sweep_flag ? -1 : 1) *
	                        math.sqrt(abs((rx2 * ry2 - rx2 * y * y - ry2 * x * x) / (rx2 * y * y + ry2 * x * x))),
	                    cx = k * rx * y / ry + (x1 + x2) / 2,
	                    cy = k * -ry * x / rx + (y1 + y2) / 2,
	                    f1 = math.asin(((y1 - cy) / ry).toFixed(9)),
	                    f2 = math.asin(((y2 - cy) / ry).toFixed(9));

	                f1 = x1 < cx ? PI - f1 : f1;
	                f2 = x2 < cx ? PI - f2 : f2;
	                f1 < 0 && (f1 = PI * 2 + f1);
	                f2 < 0 && (f2 = PI * 2 + f2);
	                if (sweep_flag && f1 > f2) {
	                    f1 = f1 - PI * 2;
	                }
	                if (!sweep_flag && f2 > f1) {
	                    f2 = f2 - PI * 2;
	                }
	            } else {
	                f1 = recursive[0];
	                f2 = recursive[1];
	                cx = recursive[2];
	                cy = recursive[3];
	            }
	            var df = f2 - f1;
	            if (abs(df) > _120) {
	                var f2old = f2,
	                    x2old = x2,
	                    y2old = y2;
	                f2 = f1 + _120 * (sweep_flag && f2 > f1 ? 1 : -1);
	                x2 = cx + rx * math.cos(f2);
	                y2 = cy + ry * math.sin(f2);
	                res = a2c(x2, y2, rx, ry, angle, 0, sweep_flag, x2old, y2old, [f2, f2old, cx, cy]);
	            }
	            df = f2 - f1;
	            var c1 = math.cos(f1),
	                s1 = math.sin(f1),
	                c2 = math.cos(f2),
	                s2 = math.sin(f2),
	                t = math.tan(df / 4),
	                hx = 4 / 3 * rx * t,
	                hy = 4 / 3 * ry * t,
	                m1 = [x1, y1],
	                m2 = [x1 + hx * s1, y1 - hy * c1],
	                m3 = [x2 + hx * s2, y2 - hy * c2],
	                m4 = [x2, y2];
	            m2[0] = 2 * m1[0] - m2[0];
	            m2[1] = 2 * m1[1] - m2[1];
	            if (recursive) {
	                return [m2, m3, m4][concat](res);
	            } else {
	                res = [m2, m3, m4][concat](res).join()[split](",");
	                var newres = [];
	                for (var i = 0, ii = res.length; i < ii; i++) {
	                    newres[i] = i % 2 ? rotate(res[i - 1], res[i], rad).y : rotate(res[i], res[i + 1], rad).x;
	                }
	                return newres;
	            }
	        },
	        findDotAtSegment = function (p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t) {
	            var t1 = 1 - t;
	            return {
	                x: pow(t1, 3) * p1x + pow(t1, 2) * 3 * t * c1x + t1 * 3 * t * t * c2x + pow(t, 3) * p2x,
	                y: pow(t1, 3) * p1y + pow(t1, 2) * 3 * t * c1y + t1 * 3 * t * t * c2y + pow(t, 3) * p2y
	            };
	        },
	        curveDim = cacher(function (p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y) {
	            var a = (c2x - 2 * c1x + p1x) - (p2x - 2 * c2x + c1x),
	                b = 2 * (c1x - p1x) - 2 * (c2x - c1x),
	                c = p1x - c1x,
	                t1 = (-b + math.sqrt(b * b - 4 * a * c)) / 2 / a,
	                t2 = (-b - math.sqrt(b * b - 4 * a * c)) / 2 / a,
	                y = [p1y, p2y],
	                x = [p1x, p2x],
	                dot;
	            abs(t1) > "1e12" && (t1 = .5);
	            abs(t2) > "1e12" && (t2 = .5);
	            if (t1 > 0 && t1 < 1) {
	                dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t1);
	                x.push(dot.x);
	                y.push(dot.y);
	            }
	            if (t2 > 0 && t2 < 1) {
	                dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t2);
	                x.push(dot.x);
	                y.push(dot.y);
	            }
	            a = (c2y - 2 * c1y + p1y) - (p2y - 2 * c2y + c1y);
	            b = 2 * (c1y - p1y) - 2 * (c2y - c1y);
	            c = p1y - c1y;
	            t1 = (-b + math.sqrt(b * b - 4 * a * c)) / 2 / a;
	            t2 = (-b - math.sqrt(b * b - 4 * a * c)) / 2 / a;
	            abs(t1) > "1e12" && (t1 = .5);
	            abs(t2) > "1e12" && (t2 = .5);
	            if (t1 > 0 && t1 < 1) {
	                dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t1);
	                x.push(dot.x);
	                y.push(dot.y);
	            }
	            if (t2 > 0 && t2 < 1) {
	                dot = findDotAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, t2);
	                x.push(dot.x);
	                y.push(dot.y);
	            }
	            return {
	                min: {x: mmin[apply](0, x), y: mmin[apply](0, y)},
	                max: {x: mmax[apply](0, x), y: mmax[apply](0, y)}
	            };
	        }),
	        path2curve = R._path2curve = cacher(function (path, path2) {
	            var pth = !path2 && paths(path);
	            if (!path2 && pth.curve) {
	                return pathClone(pth.curve);
	            }
	            var p = pathToAbsolute(path),
	                p2 = path2 && pathToAbsolute(path2),
	                attrs = {x: 0, y: 0, bx: 0, by: 0, X: 0, Y: 0, qx: null, qy: null},
	                attrs2 = {x: 0, y: 0, bx: 0, by: 0, X: 0, Y: 0, qx: null, qy: null},
	                processPath = function (path, d, pcom) {
	                    var nx, ny, tq = {T:1, Q:1};
	                    if (!path) {
	                        return ["C", d.x, d.y, d.x, d.y, d.x, d.y];
	                    }
	                    !(path[0] in tq) && (d.qx = d.qy = null);
	                    switch (path[0]) {
	                        case "M":
	                            d.X = path[1];
	                            d.Y = path[2];
	                            break;
	                        case "A":
	                            path = ["C"][concat](a2c[apply](0, [d.x, d.y][concat](path.slice(1))));
	                            break;
	                        case "S":
	                            if (pcom == "C" || pcom == "S") { // In "S" case we have to take into account, if the previous command is C/S.
	                                nx = d.x * 2 - d.bx;          // And reflect the previous
	                                ny = d.y * 2 - d.by;          // command's control point relative to the current point.
	                            }
	                            else {                            // or some else or nothing
	                                nx = d.x;
	                                ny = d.y;
	                            }
	                            path = ["C", nx, ny][concat](path.slice(1));
	                            break;
	                        case "T":
	                            if (pcom == "Q" || pcom == "T") { // In "T" case we have to take into account, if the previous command is Q/T.
	                                d.qx = d.x * 2 - d.qx;        // And make a reflection similar
	                                d.qy = d.y * 2 - d.qy;        // to case "S".
	                            }
	                            else {                            // or something else or nothing
	                                d.qx = d.x;
	                                d.qy = d.y;
	                            }
	                            path = ["C"][concat](q2c(d.x, d.y, d.qx, d.qy, path[1], path[2]));
	                            break;
	                        case "Q":
	                            d.qx = path[1];
	                            d.qy = path[2];
	                            path = ["C"][concat](q2c(d.x, d.y, path[1], path[2], path[3], path[4]));
	                            break;
	                        case "L":
	                            path = ["C"][concat](l2c(d.x, d.y, path[1], path[2]));
	                            break;
	                        case "H":
	                            path = ["C"][concat](l2c(d.x, d.y, path[1], d.y));
	                            break;
	                        case "V":
	                            path = ["C"][concat](l2c(d.x, d.y, d.x, path[1]));
	                            break;
	                        case "Z":
	                            path = ["C"][concat](l2c(d.x, d.y, d.X, d.Y));
	                            break;
	                    }
	                    return path;
	                },
	                fixArc = function (pp, i) {
	                    if (pp[i].length > 7) {
	                        pp[i].shift();
	                        var pi = pp[i];
	                        while (pi.length) {
	                            pcoms1[i]="A"; // if created multiple C:s, their original seg is saved
	                            p2 && (pcoms2[i]="A"); // the same as above
	                            pp.splice(i++, 0, ["C"][concat](pi.splice(0, 6)));
	                        }
	                        pp.splice(i, 1);
	                        ii = mmax(p.length, p2 && p2.length || 0);
	                    }
	                },
	                fixM = function (path1, path2, a1, a2, i) {
	                    if (path1 && path2 && path1[i][0] == "M" && path2[i][0] != "M") {
	                        path2.splice(i, 0, ["M", a2.x, a2.y]);
	                        a1.bx = 0;
	                        a1.by = 0;
	                        a1.x = path1[i][1];
	                        a1.y = path1[i][2];
	                        ii = mmax(p.length, p2 && p2.length || 0);
	                    }
	                },
	                pcoms1 = [], // path commands of original path p
	                pcoms2 = [], // path commands of original path p2
	                pfirst = "", // temporary holder for original path command
	                pcom = ""; // holder for previous path command of original path
	            for (var i = 0, ii = mmax(p.length, p2 && p2.length || 0); i < ii; i++) {
	                p[i] && (pfirst = p[i][0]); // save current path command

	                if (pfirst != "C") // C is not saved yet, because it may be result of conversion
	                {
	                    pcoms1[i] = pfirst; // Save current path command
	                    i && ( pcom = pcoms1[i-1]); // Get previous path command pcom
	                }
	                p[i] = processPath(p[i], attrs, pcom); // Previous path command is inputted to processPath

	                if (pcoms1[i] != "A" && pfirst == "C") pcoms1[i] = "C"; // A is the only command
	                // which may produce multiple C:s
	                // so we have to make sure that C is also C in original path

	                fixArc(p, i); // fixArc adds also the right amount of A:s to pcoms1

	                if (p2) { // the same procedures is done to p2
	                    p2[i] && (pfirst = p2[i][0]);
	                    if (pfirst != "C")
	                    {
	                        pcoms2[i] = pfirst;
	                        i && (pcom = pcoms2[i-1]);
	                    }
	                    p2[i] = processPath(p2[i], attrs2, pcom);

	                    if (pcoms2[i]!="A" && pfirst=="C") pcoms2[i]="C";

	                    fixArc(p2, i);
	                }
	                fixM(p, p2, attrs, attrs2, i);
	                fixM(p2, p, attrs2, attrs, i);
	                var seg = p[i],
	                    seg2 = p2 && p2[i],
	                    seglen = seg.length,
	                    seg2len = p2 && seg2.length;
	                attrs.x = seg[seglen - 2];
	                attrs.y = seg[seglen - 1];
	                attrs.bx = toFloat(seg[seglen - 4]) || attrs.x;
	                attrs.by = toFloat(seg[seglen - 3]) || attrs.y;
	                attrs2.bx = p2 && (toFloat(seg2[seg2len - 4]) || attrs2.x);
	                attrs2.by = p2 && (toFloat(seg2[seg2len - 3]) || attrs2.y);
	                attrs2.x = p2 && seg2[seg2len - 2];
	                attrs2.y = p2 && seg2[seg2len - 1];
	            }
	            if (!p2) {
	                pth.curve = pathClone(p);
	            }
	            return p2 ? [p, p2] : p;
	        }, null, pathClone),
	        parseDots = R._parseDots = cacher(function (gradient) {
	            var dots = [];
	            for (var i = 0, ii = gradient.length; i < ii; i++) {
	                var dot = {},
	                    par = gradient[i].match(/^([^:]*):?([\d\.]*)/);
	                dot.color = R.getRGB(par[1]);
	                if (dot.color.error) {
	                    return null;
	                }
	                dot.opacity = dot.color.opacity;
	                dot.color = dot.color.hex;
	                par[2] && (dot.offset = par[2] + "%");
	                dots.push(dot);
	            }
	            for (i = 1, ii = dots.length - 1; i < ii; i++) {
	                if (!dots[i].offset) {
	                    var start = toFloat(dots[i - 1].offset || 0),
	                        end = 0;
	                    for (var j = i + 1; j < ii; j++) {
	                        if (dots[j].offset) {
	                            end = dots[j].offset;
	                            break;
	                        }
	                    }
	                    if (!end) {
	                        end = 100;
	                        j = ii;
	                    }
	                    end = toFloat(end);
	                    var d = (end - start) / (j - i + 1);
	                    for (; i < j; i++) {
	                        start += d;
	                        dots[i].offset = start + "%";
	                    }
	                }
	            }
	            return dots;
	        }),
	        tear = R._tear = function (el, paper) {
	            el == paper.top && (paper.top = el.prev);
	            el == paper.bottom && (paper.bottom = el.next);
	            el.next && (el.next.prev = el.prev);
	            el.prev && (el.prev.next = el.next);
	        },
	        tofront = R._tofront = function (el, paper) {
	            if (paper.top === el) {
	                return;
	            }
	            tear(el, paper);
	            el.next = null;
	            el.prev = paper.top;
	            paper.top.next = el;
	            paper.top = el;
	        },
	        toback = R._toback = function (el, paper) {
	            if (paper.bottom === el) {
	                return;
	            }
	            tear(el, paper);
	            el.next = paper.bottom;
	            el.prev = null;
	            paper.bottom.prev = el;
	            paper.bottom = el;
	        },
	        insertafter = R._insertafter = function (el, el2, paper) {
	            tear(el, paper);
	            el2 == paper.top && (paper.top = el);
	            el2.next && (el2.next.prev = el);
	            el.next = el2.next;
	            el.prev = el2;
	            el2.next = el;
	        },
	        insertbefore = R._insertbefore = function (el, el2, paper) {
	            tear(el, paper);
	            el2 == paper.bottom && (paper.bottom = el);
	            el2.prev && (el2.prev.next = el);
	            el.prev = el2.prev;
	            el2.prev = el;
	            el.next = el2;
	        },
	        /*\
	         * Raphael.toMatrix
	         [ method ]
	         **
	         * Utility method
	         **
	         * Returns matrix of transformations applied to a given path
	         > Parameters
	         - path (string) path string
	         - transform (string|array) transformation string
	         = (object) @Matrix
	        \*/
	        toMatrix = R.toMatrix = function (path, transform) {
	            var bb = pathDimensions(path),
	                el = {
	                    _: {
	                        transform: E
	                    },
	                    getBBox: function () {
	                        return bb;
	                    }
	                };
	            extractTransform(el, transform);
	            return el.matrix;
	        },
	        /*\
	         * Raphael.transformPath
	         [ method ]
	         **
	         * Utility method
	         **
	         * Returns path transformed by a given transformation
	         > Parameters
	         - path (string) path string
	         - transform (string|array) transformation string
	         = (string) path
	        \*/
	        transformPath = R.transformPath = function (path, transform) {
	            return mapPath(path, toMatrix(path, transform));
	        },
	        extractTransform = R._extractTransform = function (el, tstr) {
	            if (tstr == null) {
	                return el._.transform;
	            }
	            tstr = Str(tstr).replace(/\.{3}|\u2026/g, el._.transform || E);
	            var tdata = R.parseTransformString(tstr),
	                deg = 0,
	                dx = 0,
	                dy = 0,
	                sx = 1,
	                sy = 1,
	                _ = el._,
	                m = new Matrix;
	            _.transform = tdata || [];
	            if (tdata) {
	                for (var i = 0, ii = tdata.length; i < ii; i++) {
	                    var t = tdata[i],
	                        tlen = t.length,
	                        command = Str(t[0]).toLowerCase(),
	                        absolute = t[0] != command,
	                        inver = absolute ? m.invert() : 0,
	                        x1,
	                        y1,
	                        x2,
	                        y2,
	                        bb;
	                    if (command == "t" && tlen == 3) {
	                        if (absolute) {
	                            x1 = inver.x(0, 0);
	                            y1 = inver.y(0, 0);
	                            x2 = inver.x(t[1], t[2]);
	                            y2 = inver.y(t[1], t[2]);
	                            m.translate(x2 - x1, y2 - y1);
	                        } else {
	                            m.translate(t[1], t[2]);
	                        }
	                    } else if (command == "r") {
	                        if (tlen == 2) {
	                            bb = bb || el.getBBox(1);
	                            m.rotate(t[1], bb.x + bb.width / 2, bb.y + bb.height / 2);
	                            deg += t[1];
	                        } else if (tlen == 4) {
	                            if (absolute) {
	                                x2 = inver.x(t[2], t[3]);
	                                y2 = inver.y(t[2], t[3]);
	                                m.rotate(t[1], x2, y2);
	                            } else {
	                                m.rotate(t[1], t[2], t[3]);
	                            }
	                            deg += t[1];
	                        }
	                    } else if (command == "s") {
	                        if (tlen == 2 || tlen == 3) {
	                            bb = bb || el.getBBox(1);
	                            m.scale(t[1], t[tlen - 1], bb.x + bb.width / 2, bb.y + bb.height / 2);
	                            sx *= t[1];
	                            sy *= t[tlen - 1];
	                        } else if (tlen == 5) {
	                            if (absolute) {
	                                x2 = inver.x(t[3], t[4]);
	                                y2 = inver.y(t[3], t[4]);
	                                m.scale(t[1], t[2], x2, y2);
	                            } else {
	                                m.scale(t[1], t[2], t[3], t[4]);
	                            }
	                            sx *= t[1];
	                            sy *= t[2];
	                        }
	                    } else if (command == "m" && tlen == 7) {
	                        m.add(t[1], t[2], t[3], t[4], t[5], t[6]);
	                    }
	                    _.dirtyT = 1;
	                    el.matrix = m;
	                }
	            }

	            /*\
	             * Element.matrix
	             [ property (object) ]
	             **
	             * Keeps @Matrix object, which represents element transformation
	            \*/
	            el.matrix = m;

	            _.sx = sx;
	            _.sy = sy;
	            _.deg = deg;
	            _.dx = dx = m.e;
	            _.dy = dy = m.f;

	            if (sx == 1 && sy == 1 && !deg && _.bbox) {
	                _.bbox.x += +dx;
	                _.bbox.y += +dy;
	            } else {
	                _.dirtyT = 1;
	            }
	        },
	        getEmpty = function (item) {
	            var l = item[0];
	            switch (l.toLowerCase()) {
	                case "t": return [l, 0, 0];
	                case "m": return [l, 1, 0, 0, 1, 0, 0];
	                case "r": if (item.length == 4) {
	                    return [l, 0, item[2], item[3]];
	                } else {
	                    return [l, 0];
	                }
	                case "s": if (item.length == 5) {
	                    return [l, 1, 1, item[3], item[4]];
	                } else if (item.length == 3) {
	                    return [l, 1, 1];
	                } else {
	                    return [l, 1];
	                }
	            }
	        },
	        equaliseTransform = R._equaliseTransform = function (t1, t2) {
	            t2 = Str(t2).replace(/\.{3}|\u2026/g, t1);
	            t1 = R.parseTransformString(t1) || [];
	            t2 = R.parseTransformString(t2) || [];
	            var maxlength = mmax(t1.length, t2.length),
	                from = [],
	                to = [],
	                i = 0, j, jj,
	                tt1, tt2;
	            for (; i < maxlength; i++) {
	                tt1 = t1[i] || getEmpty(t2[i]);
	                tt2 = t2[i] || getEmpty(tt1);
	                if ((tt1[0] != tt2[0]) ||
	                    (tt1[0].toLowerCase() == "r" && (tt1[2] != tt2[2] || tt1[3] != tt2[3])) ||
	                    (tt1[0].toLowerCase() == "s" && (tt1[3] != tt2[3] || tt1[4] != tt2[4]))
	                    ) {
	                    return;
	                }
	                from[i] = [];
	                to[i] = [];
	                for (j = 0, jj = mmax(tt1.length, tt2.length); j < jj; j++) {
	                    j in tt1 && (from[i][j] = tt1[j]);
	                    j in tt2 && (to[i][j] = tt2[j]);
	                }
	            }
	            return {
	                from: from,
	                to: to
	            };
	        };
	    R._getContainer = function (x, y, w, h) {
	        var container;
	        container = h == null && !R.is(x, "object") ? g.doc.getElementById(x) : x;
	        if (container == null) {
	            return;
	        }
	        if (container.tagName) {
	            if (y == null) {
	                return {
	                    container: container,
	                    width: container.style.pixelWidth || container.offsetWidth,
	                    height: container.style.pixelHeight || container.offsetHeight
	                };
	            } else {
	                return {
	                    container: container,
	                    width: y,
	                    height: w
	                };
	            }
	        }
	        return {
	            container: 1,
	            x: x,
	            y: y,
	            width: w,
	            height: h
	        };
	    };
	    /*\
	     * Raphael.pathToRelative
	     [ method ]
	     **
	     * Utility method
	     **
	     * Converts path to relative form
	     > Parameters
	     - pathString (string|array) path string or array of segments
	     = (array) array of segments.
	    \*/
	    R.pathToRelative = pathToRelative;
	    R._engine = {};
	    /*\
	     * Raphael.path2curve
	     [ method ]
	     **
	     * Utility method
	     **
	     * Converts path to a new path where all segments are cubic bezier curves.
	     > Parameters
	     - pathString (string|array) path string or array of segments
	     = (array) array of segments.
	    \*/
	    R.path2curve = path2curve;
	    /*\
	     * Raphael.matrix
	     [ method ]
	     **
	     * Utility method
	     **
	     * Returns matrix based on given parameters.
	     > Parameters
	     - a (number)
	     - b (number)
	     - c (number)
	     - d (number)
	     - e (number)
	     - f (number)
	     = (object) @Matrix
	    \*/
	    R.matrix = function (a, b, c, d, e, f) {
	        return new Matrix(a, b, c, d, e, f);
	    };
	    function Matrix(a, b, c, d, e, f) {
	        if (a != null) {
	            this.a = +a;
	            this.b = +b;
	            this.c = +c;
	            this.d = +d;
	            this.e = +e;
	            this.f = +f;
	        } else {
	            this.a = 1;
	            this.b = 0;
	            this.c = 0;
	            this.d = 1;
	            this.e = 0;
	            this.f = 0;
	        }
	    }
	    (function (matrixproto) {
	        /*\
	         * Matrix.add
	         [ method ]
	         **
	         * Adds given matrix to existing one.
	         > Parameters
	         - a (number)
	         - b (number)
	         - c (number)
	         - d (number)
	         - e (number)
	         - f (number)
	         or
	         - matrix (object) @Matrix
	        \*/
	        matrixproto.add = function (a, b, c, d, e, f) {
	            var out = [[], [], []],
	                m = [[this.a, this.c, this.e], [this.b, this.d, this.f], [0, 0, 1]],
	                matrix = [[a, c, e], [b, d, f], [0, 0, 1]],
	                x, y, z, res;

	            if (a && a instanceof Matrix) {
	                matrix = [[a.a, a.c, a.e], [a.b, a.d, a.f], [0, 0, 1]];
	            }

	            for (x = 0; x < 3; x++) {
	                for (y = 0; y < 3; y++) {
	                    res = 0;
	                    for (z = 0; z < 3; z++) {
	                        res += m[x][z] * matrix[z][y];
	                    }
	                    out[x][y] = res;
	                }
	            }
	            this.a = out[0][0];
	            this.b = out[1][0];
	            this.c = out[0][1];
	            this.d = out[1][1];
	            this.e = out[0][2];
	            this.f = out[1][2];
	        };
	        /*\
	         * Matrix.invert
	         [ method ]
	         **
	         * Returns inverted version of the matrix
	         = (object) @Matrix
	        \*/
	        matrixproto.invert = function () {
	            var me = this,
	                x = me.a * me.d - me.b * me.c;
	            return new Matrix(me.d / x, -me.b / x, -me.c / x, me.a / x, (me.c * me.f - me.d * me.e) / x, (me.b * me.e - me.a * me.f) / x);
	        };
	        /*\
	         * Matrix.clone
	         [ method ]
	         **
	         * Returns copy of the matrix
	         = (object) @Matrix
	        \*/
	        matrixproto.clone = function () {
	            return new Matrix(this.a, this.b, this.c, this.d, this.e, this.f);
	        };
	        /*\
	         * Matrix.translate
	         [ method ]
	         **
	         * Translate the matrix
	         > Parameters
	         - x (number)
	         - y (number)
	        \*/
	        matrixproto.translate = function (x, y) {
	            this.add(1, 0, 0, 1, x, y);
	        };
	        /*\
	         * Matrix.scale
	         [ method ]
	         **
	         * Scales the matrix
	         > Parameters
	         - x (number)
	         - y (number) #optional
	         - cx (number) #optional
	         - cy (number) #optional
	        \*/
	        matrixproto.scale = function (x, y, cx, cy) {
	            y == null && (y = x);
	            (cx || cy) && this.add(1, 0, 0, 1, cx, cy);
	            this.add(x, 0, 0, y, 0, 0);
	            (cx || cy) && this.add(1, 0, 0, 1, -cx, -cy);
	        };
	        /*\
	         * Matrix.rotate
	         [ method ]
	         **
	         * Rotates the matrix
	         > Parameters
	         - a (number)
	         - x (number)
	         - y (number)
	        \*/
	        matrixproto.rotate = function (a, x, y) {
	            a = R.rad(a);
	            x = x || 0;
	            y = y || 0;
	            var cos = +math.cos(a).toFixed(9),
	                sin = +math.sin(a).toFixed(9);
	            this.add(cos, sin, -sin, cos, x, y);
	            this.add(1, 0, 0, 1, -x, -y);
	        };
	        /*\
	         * Matrix.x
	         [ method ]
	         **
	         * Return x coordinate for given point after transformation described by the matrix. See also @Matrix.y
	         > Parameters
	         - x (number)
	         - y (number)
	         = (number) x
	        \*/
	        matrixproto.x = function (x, y) {
	            return x * this.a + y * this.c + this.e;
	        };
	        /*\
	         * Matrix.y
	         [ method ]
	         **
	         * Return y coordinate for given point after transformation described by the matrix. See also @Matrix.x
	         > Parameters
	         - x (number)
	         - y (number)
	         = (number) y
	        \*/
	        matrixproto.y = function (x, y) {
	            return x * this.b + y * this.d + this.f;
	        };
	        matrixproto.get = function (i) {
	            return +this[Str.fromCharCode(97 + i)].toFixed(4);
	        };
	        matrixproto.toString = function () {
	            return R.svg ?
	                "matrix(" + [this.get(0), this.get(1), this.get(2), this.get(3), this.get(4), this.get(5)].join() + ")" :
	                [this.get(0), this.get(2), this.get(1), this.get(3), 0, 0].join();
	        };
	        matrixproto.toFilter = function () {
	            return "progid:DXImageTransform.Microsoft.Matrix(M11=" + this.get(0) +
	                ", M12=" + this.get(2) + ", M21=" + this.get(1) + ", M22=" + this.get(3) +
	                ", Dx=" + this.get(4) + ", Dy=" + this.get(5) + ", sizingmethod='auto expand')";
	        };
	        matrixproto.offset = function () {
	            return [this.e.toFixed(4), this.f.toFixed(4)];
	        };
	        function norm(a) {
	            return a[0] * a[0] + a[1] * a[1];
	        }
	        function normalize(a) {
	            var mag = math.sqrt(norm(a));
	            a[0] && (a[0] /= mag);
	            a[1] && (a[1] /= mag);
	        }
	        /*\
	         * Matrix.split
	         [ method ]
	         **
	         * Splits matrix into primitive transformations
	         = (object) in format:
	         o dx (number) translation by x
	         o dy (number) translation by y
	         o scalex (number) scale by x
	         o scaley (number) scale by y
	         o shear (number) shear
	         o rotate (number) rotation in deg
	         o isSimple (boolean) could it be represented via simple transformations
	        \*/
	        matrixproto.split = function () {
	            var out = {};
	            // translation
	            out.dx = this.e;
	            out.dy = this.f;

	            // scale and shear
	            var row = [[this.a, this.c], [this.b, this.d]];
	            out.scalex = math.sqrt(norm(row[0]));
	            normalize(row[0]);

	            out.shear = row[0][0] * row[1][0] + row[0][1] * row[1][1];
	            row[1] = [row[1][0] - row[0][0] * out.shear, row[1][1] - row[0][1] * out.shear];

	            out.scaley = math.sqrt(norm(row[1]));
	            normalize(row[1]);
	            out.shear /= out.scaley;

	            // rotation
	            var sin = -row[0][1],
	                cos = row[1][1];
	            if (cos < 0) {
	                out.rotate = R.deg(math.acos(cos));
	                if (sin < 0) {
	                    out.rotate = 360 - out.rotate;
	                }
	            } else {
	                out.rotate = R.deg(math.asin(sin));
	            }

	            out.isSimple = !+out.shear.toFixed(9) && (out.scalex.toFixed(9) == out.scaley.toFixed(9) || !out.rotate);
	            out.isSuperSimple = !+out.shear.toFixed(9) && out.scalex.toFixed(9) == out.scaley.toFixed(9) && !out.rotate;
	            out.noRotation = !+out.shear.toFixed(9) && !out.rotate;
	            return out;
	        };
	        /*\
	         * Matrix.toTransformString
	         [ method ]
	         **
	         * Return transform string that represents given matrix
	         = (string) transform string
	        \*/
	        matrixproto.toTransformString = function (shorter) {
	            var s = shorter || this[split]();
	            if (s.isSimple) {
	                s.scalex = +s.scalex.toFixed(4);
	                s.scaley = +s.scaley.toFixed(4);
	                s.rotate = +s.rotate.toFixed(4);
	                return  (s.dx || s.dy ? "t" + [s.dx, s.dy] : E) +
	                        (s.scalex != 1 || s.scaley != 1 ? "s" + [s.scalex, s.scaley, 0, 0] : E) +
	                        (s.rotate ? "r" + [s.rotate, 0, 0] : E);
	            } else {
	                return "m" + [this.get(0), this.get(1), this.get(2), this.get(3), this.get(4), this.get(5)];
	            }
	        };
	    })(Matrix.prototype);

	    var preventDefault = function () {
	        this.returnValue = false;
	    },
	    preventTouch = function () {
	        return this.originalEvent.preventDefault();
	    },
	    stopPropagation = function () {
	        this.cancelBubble = true;
	    },
	    stopTouch = function () {
	        return this.originalEvent.stopPropagation();
	    },
	    getEventPosition = function (e) {
	        var scrollY = g.doc.documentElement.scrollTop || g.doc.body.scrollTop,
	            scrollX = g.doc.documentElement.scrollLeft || g.doc.body.scrollLeft;

	        return {
	            x: e.clientX + scrollX,
	            y: e.clientY + scrollY
	        };
	    },
	    addEvent = (function () {
	        if (g.doc.addEventListener) {
	            return function (obj, type, fn, element) {
	                var f = function (e) {
	                    var pos = getEventPosition(e);
	                    return fn.call(element, e, pos.x, pos.y);
	                };
	                obj.addEventListener(type, f, false);

	                if (supportsTouch && touchMap[type]) {
	                    var _f = function (e) {
	                        var pos = getEventPosition(e),
	                            olde = e;

	                        for (var i = 0, ii = e.targetTouches && e.targetTouches.length; i < ii; i++) {
	                            if (e.targetTouches[i].target == obj) {
	                                e = e.targetTouches[i];
	                                e.originalEvent = olde;
	                                e.preventDefault = preventTouch;
	                                e.stopPropagation = stopTouch;
	                                break;
	                            }
	                        }

	                        return fn.call(element, e, pos.x, pos.y);
	                    };
	                    obj.addEventListener(touchMap[type], _f, false);
	                }

	                return function () {
	                    obj.removeEventListener(type, f, false);

	                    if (supportsTouch && touchMap[type])
	                        obj.removeEventListener(touchMap[type], _f, false);

	                    return true;
	                };
	            };
	        } else if (g.doc.attachEvent) {
	            return function (obj, type, fn, element) {
	                var f = function (e) {
	                    e = e || g.win.event;
	                    var scrollY = g.doc.documentElement.scrollTop || g.doc.body.scrollTop,
	                        scrollX = g.doc.documentElement.scrollLeft || g.doc.body.scrollLeft,
	                        x = e.clientX + scrollX,
	                        y = e.clientY + scrollY;
	                    e.preventDefault = e.preventDefault || preventDefault;
	                    e.stopPropagation = e.stopPropagation || stopPropagation;
	                    return fn.call(element, e, x, y);
	                };
	                obj.attachEvent("on" + type, f);
	                var detacher = function () {
	                    obj.detachEvent("on" + type, f);
	                    return true;
	                };
	                return detacher;
	            };
	        }
	    })(),
	    drag = [],
	    dragMove = function (e) {
	        var x = e.clientX,
	            y = e.clientY,
	            scrollY = g.doc.documentElement.scrollTop || g.doc.body.scrollTop,
	            scrollX = g.doc.documentElement.scrollLeft || g.doc.body.scrollLeft,
	            dragi,
	            j = drag.length;
	        while (j--) {
	            dragi = drag[j];
	            if (supportsTouch && e.touches) {
	                var i = e.touches.length,
	                    touch;
	                while (i--) {
	                    touch = e.touches[i];
	                    if (touch.identifier == dragi.el._drag.id) {
	                        x = touch.clientX;
	                        y = touch.clientY;
	                        (e.originalEvent ? e.originalEvent : e).preventDefault();
	                        break;
	                    }
	                }
	            } else {
	                e.preventDefault();
	            }
	            var node = dragi.el.node,
	                o,
	                next = node.nextSibling,
	                parent = node.parentNode,
	                display = node.style.display;
	            g.win.opera && parent.removeChild(node);
	            node.style.display = "none";
	            o = dragi.el.paper.getElementByPoint(x, y);
	            node.style.display = display;
	            g.win.opera && (next ? parent.insertBefore(node, next) : parent.appendChild(node));
	            o && eve("raphael.drag.over." + dragi.el.id, dragi.el, o);
	            x += scrollX;
	            y += scrollY;
	            eve("raphael.drag.move." + dragi.el.id, dragi.move_scope || dragi.el, x - dragi.el._drag.x, y - dragi.el._drag.y, x, y, e);
	        }
	    },
	    dragUp = function (e) {
	        R.unmousemove(dragMove).unmouseup(dragUp);
	        var i = drag.length,
	            dragi;
	        while (i--) {
	            dragi = drag[i];
	            dragi.el._drag = {};
	            eve("raphael.drag.end." + dragi.el.id, dragi.end_scope || dragi.start_scope || dragi.move_scope || dragi.el, e);
	        }
	        drag = [];
	    },
	    /*\
	     * Raphael.el
	     [ property (object) ]
	     **
	     * You can add your own method to elements. This is useful when you want to hack default functionality or
	     * want to wrap some common transformation or attributes in one method. In difference to canvas methods,
	     * you can redefine element method at any time. Expending element methods wouldnt affect set.
	     > Usage
	     | Raphael.el.red = function () {
	     |     this.attr({fill: "#f00"});
	     | };
	     | // then use it
	     | paper.circle(100, 100, 20).red();
	    \*/
	    elproto = R.el = {};
	    /*\
	     * Element.click
	     [ method ]
	     **
	     * Adds event handler for click for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unclick
	     [ method ]
	     **
	     * Removes event handler for click for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.dblclick
	     [ method ]
	     **
	     * Adds event handler for double click for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.undblclick
	     [ method ]
	     **
	     * Removes event handler for double click for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.mousedown
	     [ method ]
	     **
	     * Adds event handler for mousedown for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unmousedown
	     [ method ]
	     **
	     * Removes event handler for mousedown for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.mousemove
	     [ method ]
	     **
	     * Adds event handler for mousemove for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unmousemove
	     [ method ]
	     **
	     * Removes event handler for mousemove for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.mouseout
	     [ method ]
	     **
	     * Adds event handler for mouseout for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unmouseout
	     [ method ]
	     **
	     * Removes event handler for mouseout for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.mouseover
	     [ method ]
	     **
	     * Adds event handler for mouseover for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unmouseover
	     [ method ]
	     **
	     * Removes event handler for mouseover for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.mouseup
	     [ method ]
	     **
	     * Adds event handler for mouseup for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.unmouseup
	     [ method ]
	     **
	     * Removes event handler for mouseup for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.touchstart
	     [ method ]
	     **
	     * Adds event handler for touchstart for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.untouchstart
	     [ method ]
	     **
	     * Removes event handler for touchstart for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.touchmove
	     [ method ]
	     **
	     * Adds event handler for touchmove for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.untouchmove
	     [ method ]
	     **
	     * Removes event handler for touchmove for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.touchend
	     [ method ]
	     **
	     * Adds event handler for touchend for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.untouchend
	     [ method ]
	     **
	     * Removes event handler for touchend for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/

	    /*\
	     * Element.touchcancel
	     [ method ]
	     **
	     * Adds event handler for touchcancel for the element.
	     > Parameters
	     - handler (function) handler for the event
	     = (object) @Element
	    \*/
	    /*\
	     * Element.untouchcancel
	     [ method ]
	     **
	     * Removes event handler for touchcancel for the element.
	     > Parameters
	     - handler (function) #optional handler for the event
	     = (object) @Element
	    \*/
	    for (var i = events.length; i--;) {
	        (function (eventName) {
	            R[eventName] = elproto[eventName] = function (fn, scope) {
	                if (R.is(fn, "function")) {
	                    this.events = this.events || [];
	                    this.events.push({name: eventName, f: fn, unbind: addEvent(this.shape || this.node || g.doc, eventName, fn, scope || this)});
	                }
	                return this;
	            };
	            R["un" + eventName] = elproto["un" + eventName] = function (fn) {
	                var events = this.events || [],
	                    l = events.length;
	                while (l--){
	                    if (events[l].name == eventName && (R.is(fn, "undefined") || events[l].f == fn)) {
	                        events[l].unbind();
	                        events.splice(l, 1);
	                        !events.length && delete this.events;
	                    }
	                }
	                return this;
	            };
	        })(events[i]);
	    }

	    /*\
	     * Element.data
	     [ method ]
	     **
	     * Adds or retrieves given value associated with given key.
	     **
	     * See also @Element.removeData
	     > Parameters
	     - key (string) key to store data
	     - value (any) #optional value to store
	     = (object) @Element
	     * or, if value is not specified:
	     = (any) value
	     * or, if key and value are not specified:
	     = (object) Key/value pairs for all the data associated with the element.
	     > Usage
	     | for (var i = 0, i < 5, i++) {
	     |     paper.circle(10 + 15 * i, 10, 10)
	     |          .attr({fill: "#000"})
	     |          .data("i", i)
	     |          .click(function () {
	     |             alert(this.data("i"));
	     |          });
	     | }
	    \*/
	    elproto.data = function (key, value) {
	        var data = eldata[this.id] = eldata[this.id] || {};
	        if (arguments.length == 0) {
	            return data;
	        }
	        if (arguments.length == 1) {
	            if (R.is(key, "object")) {
	                for (var i in key) if (key[has](i)) {
	                    this.data(i, key[i]);
	                }
	                return this;
	            }
	            eve("raphael.data.get." + this.id, this, data[key], key);
	            return data[key];
	        }
	        data[key] = value;
	        eve("raphael.data.set." + this.id, this, value, key);
	        return this;
	    };
	    /*\
	     * Element.removeData
	     [ method ]
	     **
	     * Removes value associated with an element by given key.
	     * If key is not provided, removes all the data of the element.
	     > Parameters
	     - key (string) #optional key
	     = (object) @Element
	    \*/
	    elproto.removeData = function (key) {
	        if (key == null) {
	            eldata[this.id] = {};
	        } else {
	            eldata[this.id] && delete eldata[this.id][key];
	        }
	        return this;
	    };
	     /*\
	     * Element.getData
	     [ method ]
	     **
	     * Retrieves the element data
	     = (object) data
	    \*/
	    elproto.getData = function () {
	        return clone(eldata[this.id] || {});
	    };
	    /*\
	     * Element.hover
	     [ method ]
	     **
	     * Adds event handlers for hover for the element.
	     > Parameters
	     - f_in (function) handler for hover in
	     - f_out (function) handler for hover out
	     - icontext (object) #optional context for hover in handler
	     - ocontext (object) #optional context for hover out handler
	     = (object) @Element
	    \*/
	    elproto.hover = function (f_in, f_out, scope_in, scope_out) {
	        return this.mouseover(f_in, scope_in).mouseout(f_out, scope_out || scope_in);
	    };
	    /*\
	     * Element.unhover
	     [ method ]
	     **
	     * Removes event handlers for hover for the element.
	     > Parameters
	     - f_in (function) handler for hover in
	     - f_out (function) handler for hover out
	     = (object) @Element
	    \*/
	    elproto.unhover = function (f_in, f_out) {
	        return this.unmouseover(f_in).unmouseout(f_out);
	    };
	    var draggable = [];
	    /*\
	     * Element.drag
	     [ method ]
	     **
	     * Adds event handlers for drag of the element.
	     > Parameters
	     - onmove (function) handler for moving
	     - onstart (function) handler for drag start
	     - onend (function) handler for drag end
	     - mcontext (object) #optional context for moving handler
	     - scontext (object) #optional context for drag start handler
	     - econtext (object) #optional context for drag end handler
	     * Additionally following `drag` events will be triggered: `drag.start.<id>` on start,
	     * `drag.end.<id>` on end and `drag.move.<id>` on every move. When element will be dragged over another element
	     * `drag.over.<id>` will be fired as well.
	     *
	     * Start event and start handler will be called in specified context or in context of the element with following parameters:
	     o x (number) x position of the mouse
	     o y (number) y position of the mouse
	     o event (object) DOM event object
	     * Move event and move handler will be called in specified context or in context of the element with following parameters:
	     o dx (number) shift by x from the start point
	     o dy (number) shift by y from the start point
	     o x (number) x position of the mouse
	     o y (number) y position of the mouse
	     o event (object) DOM event object
	     * End event and end handler will be called in specified context or in context of the element with following parameters:
	     o event (object) DOM event object
	     = (object) @Element
	    \*/
	    elproto.drag = function (onmove, onstart, onend, move_scope, start_scope, end_scope) {
	        function start(e) {
                if( ('which' in e)?(e.which==2||e.which==3):(e.button==4||e.button==2) )return;
	            (e.originalEvent || e).preventDefault();
	            var x = e.clientX,
	                y = e.clientY,
	                scrollY = g.doc.documentElement.scrollTop || g.doc.body.scrollTop,
	                scrollX = g.doc.documentElement.scrollLeft || g.doc.body.scrollLeft;
	            this._drag.id = e.identifier;
	            if (supportsTouch && e.touches) {
	                var i = e.touches.length, touch;
	                while (i--) {
	                    touch = e.touches[i];
	                    this._drag.id = touch.identifier;
	                    if (touch.identifier == this._drag.id) {
	                        x = touch.clientX;
	                        y = touch.clientY;
	                        break;
	                    }
	                }
	            }
	            this._drag.x = x + scrollX;
	            this._drag.y = y + scrollY;
	            !drag.length && R.mousemove(dragMove).mouseup(dragUp);
	            drag.push({el: this, move_scope: move_scope, start_scope: start_scope, end_scope: end_scope});
	            onstart && eve.on("raphael.drag.start." + this.id, onstart);
	            onmove && eve.on("raphael.drag.move." + this.id, onmove);
	            onend && eve.on("raphael.drag.end." + this.id, onend);
	            eve("raphael.drag.start." + this.id, start_scope || move_scope || this, e.clientX + scrollX, e.clientY + scrollY, e);
	        }
	        this._drag = {};
	        draggable.push({el: this, start: start});
	        this.mousedown(start);
	        return this;
	    };
	    /*\
	     * Element.onDragOver
	     [ method ]
	     **
	     * Shortcut for assigning event handler for `drag.over.<id>` event, where id is id of the element (see @Element.id).
	     > Parameters
	     - f (function) handler for event, first argument would be the element you are dragging over
	    \*/
	    elproto.onDragOver = function (f) {
	        f ? eve.on("raphael.drag.over." + this.id, f) : eve.unbind("raphael.drag.over." + this.id);
	    };
	    /*\
	     * Element.undrag
	     [ method ]
	     **
	     * Removes all drag event handlers from given element.
	    \*/
	    elproto.undrag = function () {
	        var i = draggable.length;
	        while (i--) if (draggable[i].el == this) {
	            this.unmousedown(draggable[i].start);
	            draggable.splice(i, 1);
	            eve.unbind("raphael.drag.*." + this.id);
	        }
	        !draggable.length && R.unmousemove(dragMove).unmouseup(dragUp);
	        drag = [];
	    };
	    /*\
	     * Paper.circle
	     [ method ]
	     **
	     * Draws a circle.
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the centre
	     - y (number) y coordinate of the centre
	     - r (number) radius
	     = (object) Raphal element object with type circle
	     **
	     > Usage
	     | var c = paper.circle(50, 50, 40);
	    \*/
	    paperproto.circle = function (x, y, r) {
	        var out = R._engine.circle(this, x || 0, y || 0, r || 0);
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.rect
	     [ method ]
	     *
	     * Draws a rectangle.
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the top left corner
	     - y (number) y coordinate of the top left corner
	     - width (number) width
	     - height (number) height
	     - r (number) #optional radius for rounded corners, default is 0
	     = (object) Raphal element object with type rect
	     **
	     > Usage
	     | // regular rectangle
	     | var c = paper.rect(10, 10, 50, 50);
	     | // rectangle with rounded corners
	     | var c = paper.rect(40, 40, 50, 50, 10);
	    \*/
	    paperproto.rect = function (x, y, w, h, r) {
	        var out = R._engine.rect(this, x || 0, y || 0, w || 0, h || 0, r || 0);
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.ellipse
	     [ method ]
	     **
	     * Draws an ellipse.
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the centre
	     - y (number) y coordinate of the centre
	     - rx (number) horizontal radius
	     - ry (number) vertical radius
	     = (object) Raphal element object with type ellipse
	     **
	     > Usage
	     | var c = paper.ellipse(50, 50, 40, 20);
	    \*/
	    paperproto.ellipse = function (x, y, rx, ry) {
	        var out = R._engine.ellipse(this, x || 0, y || 0, rx || 0, ry || 0);
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.path
	     [ method ]
	     **
	     * Creates a path element by given path data string.
	     > Parameters
	     - pathString (string) #optional path string in SVG format.
	     * Path string consists of one-letter commands, followed by comma seprarated arguments in numercal form. Example:
	     | "M10,20L30,40"
	     * Here we can see two commands: M, with arguments `(10, 20)` and L with arguments `(30, 40)`. Upper case letter mean command is absolute, lower caserelative.
	     *
	     # <p>Here is short list of commands available, for more details see <a href="http://www.w3.org/TR/SVG/paths.html#PathData" title="Details of a path's data attribute's format are described in the SVG specification.">SVG path string format</a>.</p>
	     # <table><thead><tr><th>Command</th><th>Name</th><th>Parameters</th></tr></thead><tbody>
	     # <tr><td>M</td><td>moveto</td><td>(x y)+</td></tr>
	     # <tr><td>Z</td><td>closepath</td><td>(none)</td></tr>
	     # <tr><td>L</td><td>lineto</td><td>(x y)+</td></tr>
	     # <tr><td>H</td><td>horizontal lineto</td><td>x+</td></tr>
	     # <tr><td>V</td><td>vertical lineto</td><td>y+</td></tr>
	     # <tr><td>C</td><td>curveto</td><td>(x1 y1 x2 y2 x y)+</td></tr>
	     # <tr><td>S</td><td>smooth curveto</td><td>(x2 y2 x y)+</td></tr>
	     # <tr><td>Q</td><td>quadratic Bzier curveto</td><td>(x1 y1 x y)+</td></tr>
	     # <tr><td>T</td><td>smooth quadratic Bzier curveto</td><td>(x y)+</td></tr>
	     # <tr><td>A</td><td>elliptical arc</td><td>(rx ry x-axis-rotation large-arc-flag sweep-flag x y)+</td></tr>
	     # <tr><td>R</td><td><a href="http://en.wikipedia.org/wiki/CatmullRom_spline#Catmull.E2.80.93Rom_spline">Catmull-Rom curveto</a>*</td><td>x1 y1 (x y)+</td></tr></tbody></table>
	     * * Catmull-Rom curveto is a not standard SVG command and added in 2.0 to make life easier.
	     * Note: there is a special case when path consist of just three commands: M10,10Rz. In this case path will smoothly connects to its beginning.
	     > Usage
	     | var c = paper.path("M10 10L90 90");
	     | // draw a diagonal line:
	     | // move to 10,10, line to 90,90
	     * For example of path strings, check out these icons: http://raphaeljs.com/icons/
	    \*/
	    paperproto.path = function (pathString) {
	        pathString && !R.is(pathString, string) && !R.is(pathString[0], array) && (pathString += E);
	        var out = R._engine.path(R.format[apply](R, arguments), this);
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.image
	     [ method ]
	     **
	     * Embeds an image into the surface.
	     **
	     > Parameters
	     **
	     - src (string) URI of the source image
	     - x (number) x coordinate position
	     - y (number) y coordinate position
	     - width (number) width of the image
	     - height (number) height of the image
	     = (object) Raphal element object with type image
	     **
	     > Usage
	     | var c = paper.image("apple.png", 10, 10, 80, 80);
	    \*/
	    paperproto.image = function (src, x, y, w, h) {
	        var out = R._engine.image(this, src || "about:blank", x || 0, y || 0, w || 0, h || 0);
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.text
	     [ method ]
	     **
	     * Draws a text string. If you need line breaks, put \n in the string.
	     **
	     > Parameters
	     **
	     - x (number) x coordinate position
	     - y (number) y coordinate position
	     - text (string) The text string to draw
	     = (object) Raphal element object with type text
	     **
	     > Usage
	     | var t = paper.text(50, 50, "Raphal\nkicks\nbutt!");
	    \*/
	    paperproto.text = function (x, y, text) {
	        var out = R._engine.text(this, x || 0, y || 0, Str(text));
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Paper.set
	     [ method ]
	     **
	     * Creates array-like object to keep and operate several elements at once.
	     * Warning: it doesnt create any elements for itself in the page, it just groups existing elements.
	     * Sets act as pseudo elements  all methods available to an element can be used on a set.
	     = (object) array-like object that represents set of elements
	     **
	     > Usage
	     | var st = paper.set();
	     | st.push(
	     |     paper.circle(10, 10, 5),
	     |     paper.circle(30, 10, 5)
	     | );
	     | st.attr({fill: "red"}); // changes the fill of both circles
	    \*/
	    paperproto.set = function (itemsArray) {
	        !R.is(itemsArray, "array") && (itemsArray = Array.prototype.splice.call(arguments, 0, arguments.length));
	        var out = new Set(itemsArray);
	        this.__set__ && this.__set__.push(out);
	        out["paper"] = this;
	        out["type"] = "set";
	        return out;
	    };
	    /*\
	     * Paper.setStart
	     [ method ]
	     **
	     * Creates @Paper.set. All elements that will be created after calling this method and before calling
	     * @Paper.setFinish will be added to the set.
	     **
	     > Usage
	     | paper.setStart();
	     | paper.circle(10, 10, 5),
	     | paper.circle(30, 10, 5)
	     | var st = paper.setFinish();
	     | st.attr({fill: "red"}); // changes the fill of both circles
	    \*/
	    paperproto.setStart = function (set) {
	        this.__set__ = set || this.set();
	    };
	    /*\
	     * Paper.setFinish
	     [ method ]
	     **
	     * See @Paper.setStart. This method finishes catching and returns resulting set.
	     **
	     = (object) set
	    \*/
	    paperproto.setFinish = function (set) {
	        var out = this.__set__;
	        delete this.__set__;
	        return out;
	    };
	    /*\
	     * Paper.getSize
	     [ method ]
	     **
	     * Obtains current paper actual size.
	     **
	     = (object)
	     \*/
	    paperproto.getSize = function () {
	        var container = this.canvas.parentNode;
	        return {
	            width: container.offsetWidth,
	            height: container.offsetHeight
	                };
	        };
	    /*\
	     * Paper.setSize
	     [ method ]
	     **
	     * If you need to change dimensions of the canvas call this method
	     **
	     > Parameters
	     **
	     - width (number) new width of the canvas
	     - height (number) new height of the canvas
	    \*/
	    paperproto.setSize = function (width, height) {
	        return R._engine.setSize.call(this, width, height);
	    };
	    /*\
	     * Paper.setViewBox
	     [ method ]
	     **
	     * Sets the view box of the paper. Practically it gives you ability to zoom and pan whole paper surface by
	     * specifying new boundaries.
	     **
	     > Parameters
	     **
	     - x (number) new x position, default is `0`
	     - y (number) new y position, default is `0`
	     - w (number) new width of the canvas
	     - h (number) new height of the canvas
	     - fit (boolean) `true` if you want graphics to fit into new boundary box
	    \*/
	    paperproto.setViewBox = function (x, y, w, h, fit) {
	        return R._engine.setViewBox.call(this, x, y, w, h, fit);
	    };
	    /*\
	     * Paper.top
	     [ property ]
	     **
	     * Points to the topmost element on the paper
	    \*/
	    /*\
	     * Paper.bottom
	     [ property ]
	     **
	     * Points to the bottom element on the paper
	    \*/
	    paperproto.top = paperproto.bottom = null;
	    /*\
	     * Paper.raphael
	     [ property ]
	     **
	     * Points to the @Raphael object/function
	    \*/
	    paperproto.raphael = R;
	    var getOffset = function (elem) {
	        var box = elem.getBoundingClientRect(),
	            doc = elem.ownerDocument,
	            body = doc.body,
	            docElem = doc.documentElement,
	            clientTop = docElem.clientTop || body.clientTop || 0, clientLeft = docElem.clientLeft || body.clientLeft || 0,
	            top  = box.top  + (g.win.pageYOffset || docElem.scrollTop || body.scrollTop ) - clientTop,
	            left = box.left + (g.win.pageXOffset || docElem.scrollLeft || body.scrollLeft) - clientLeft;
	        return {
	            y: top,
	            x: left
	        };
	    };
	    /*\
	     * Paper.getElementByPoint
	     [ method ]
	     **
	     * Returns you topmost element under given point.
	     **
	     = (object) Raphal element object
	     > Parameters
	     **
	     - x (number) x coordinate from the top left corner of the window
	     - y (number) y coordinate from the top left corner of the window
	     > Usage
	     | paper.getElementByPoint(mouseX, mouseY).attr({stroke: "#f00"});
	    \*/
	    paperproto.getElementByPoint = function (x, y) {
	        var paper = this,
	            svg = paper.canvas,
	            target = g.doc.elementFromPoint(x, y);
	        if (g.win.opera && target.tagName == "svg") {
	            var so = getOffset(svg),
	                sr = svg.createSVGRect();
	            sr.x = x - so.x;
	            sr.y = y - so.y;
	            sr.width = sr.height = 1;
	            var hits = svg.getIntersectionList(sr, null);
	            if (hits.length) {
	                target = hits[hits.length - 1];
	            }
	        }
	        if (!target) {
	            return null;
	        }
	        while (target.parentNode && target != svg.parentNode && !target.raphael) {
	            target = target.parentNode;
	        }
	        target == paper.canvas.parentNode && (target = svg);
	        target = target && target.raphael ? paper.getById(target.raphaelid) : null;
	        return target;
	    };

	    /*\
	     * Paper.getElementsByBBox
	     [ method ]
	     **
	     * Returns set of elements that have an intersecting bounding box
	     **
	     > Parameters
	     **
	     - bbox (object) bbox to check with
	     = (object) @Set
	     \*/
	    paperproto.getElementsByBBox = function (bbox) {
	        var set = this.set();
	        this.forEach(function (el) {
	            if (R.isBBoxIntersect(el.getBBox(), bbox)) {
	                set.push(el);
	            }
	        });
	        return set;
	    };

	    /*\
	     * Paper.getById
	     [ method ]
	     **
	     * Returns you element by its internal ID.
	     **
	     > Parameters
	     **
	     - id (number) id
	     = (object) Raphal element object
	    \*/
	    paperproto.getById = function (id) {
	        var bot = this.bottom;
	        while (bot) {
	            if (bot.id == id) {
	                return bot;
	            }
	            bot = bot.next;
	        }
	        return null;
	    };
	    /*\
	     * Paper.forEach
	     [ method ]
	     **
	     * Executes given function for each element on the paper
	     *
	     * If callback function returns `false` it will stop loop running.
	     **
	     > Parameters
	     **
	     - callback (function) function to run
	     - thisArg (object) context object for the callback
	     = (object) Paper object
	     > Usage
	     | paper.forEach(function (el) {
	     |     el.attr({ stroke: "blue" });
	     | });
	    \*/
	    paperproto.forEach = function (callback, thisArg) {
	        var bot = this.bottom;
	        while (bot) {
	            if (callback.call(thisArg, bot) === false) {
	                return this;
	            }
	            bot = bot.next;
	        }
	        return this;
	    };
	    /*\
	     * Paper.getElementsByPoint
	     [ method ]
	     **
	     * Returns set of elements that have common point inside
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the point
	     - y (number) y coordinate of the point
	     = (object) @Set
	    \*/
	    paperproto.getElementsByPoint = function (x, y) {
	        var set = this.set();
	        this.forEach(function (el) {
	            if (el.isPointInside(x, y)) {
	                set.push(el);
	            }
	        });
	        return set;
	    };
	    function x_y() {
	        return this.x + S + this.y;
	    }
	    function x_y_w_h() {
	        return this.x + S + this.y + S + this.width + " \xd7 " + this.height;
	    }
	    /*\
	     * Element.isPointInside
	     [ method ]
	     **
	     * Determine if given point is inside this elements shape
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the point
	     - y (number) y coordinate of the point
	     = (boolean) `true` if point inside the shape
	    \*/
	    elproto.isPointInside = function (x, y) {
	        var rp = this.realPath = getPath[this.type](this);
	        if (this.attr('transform') && this.attr('transform').length) {
	            rp = R.transformPath(rp, this.attr('transform'));
	        }
	        return R.isPointInsidePath(rp, x, y);
	    };
	    /*\
	     * Element.getBBox
	     [ method ]
	     **
	     * Return bounding box for a given element
	     **
	     > Parameters
	     **
	     - isWithoutTransform (boolean) flag, `true` if you want to have bounding box before transformations. Default is `false`.
	     = (object) Bounding box object:
	     o {
	     o     x: (number) top left corner x
	     o     y: (number) top left corner y
	     o     x2: (number) bottom right corner x
	     o     y2: (number) bottom right corner y
	     o     width: (number) width
	     o     height: (number) height
	     o }
	    \*/
	    elproto.getBBox = function (isWithoutTransform) {
	        if (this.removed) {
	            return {};
	        }
	        var _ = this._;
	        if (isWithoutTransform) {
	            if (_.dirty || !_.bboxwt) {
	                this.realPath = getPath[this.type](this);
	                _.bboxwt = pathDimensions(this.realPath);
	                _.bboxwt.toString = x_y_w_h;
	                _.dirty = 0;
	            }
	            return _.bboxwt;
	        }
	        if (_.dirty || _.dirtyT || !_.bbox) {
	            if (_.dirty || !this.realPath) {
	                _.bboxwt = 0;
	                this.realPath = getPath[this.type](this);
	            }
	            _.bbox = pathDimensions(mapPath(this.realPath, this.matrix));
	            _.bbox.toString = x_y_w_h;
	            _.dirty = _.dirtyT = 0;
	        }
	        return _.bbox;
	    };
	    /*\
	     * Element.clone
	     [ method ]
	     **
	     = (object) clone of a given element
	     **
	    \*/
	    elproto.clone = function () {
	        if (this.removed) {
	            return null;
	        }
	        var out = this.paper[this.type]().attr(this.attr());
	        this.__set__ && this.__set__.push(out);
	        return out;
	    };
	    /*\
	     * Element.glow
	     [ method ]
	     **
	     * Return set of elements that create glow-like effect around given element. See @Paper.set.
	     *
	     * Note: Glow is not connected to the element. If you change element attributes it wont adjust itself.
	     **
	     > Parameters
	     **
	     - glow (object) #optional parameters object with all properties optional:
	     o {
	     o     width (number) size of the glow, default is `10`
	     o     fill (boolean) will it be filled, default is `false`
	     o     opacity (number) opacity, default is `0.5`
	     o     offsetx (number) horizontal offset, default is `0`
	     o     offsety (number) vertical offset, default is `0`
	     o     color (string) glow colour, default is `black`
	     o }
	     = (object) @Paper.set of elements that represents glow
	    \*/
	    elproto.glow = function (glow) {
	        if (this.type == "text") {
	            return null;
	        }
	        glow = glow || {};
	        var s = {
	            width: (glow.width || 10) + (+this.attr("stroke-width") || 1),
	            fill: glow.fill || false,
	            opacity: glow.opacity == null ? .5 : glow.opacity,
	            offsetx: glow.offsetx || 0,
	            offsety: glow.offsety || 0,
	            color: glow.color || "#000"
	        },
	            c = s.width / 2,
	            r = this.paper,
	            out = r.set(),
	            path = this.realPath || getPath[this.type](this);
	        path = this.matrix ? mapPath(path, this.matrix) : path;
	        for (var i = 1; i < c + 1; i++) {
	            out.push(r.path(path).attr({
	                stroke: s.color,
	                fill: s.fill ? s.color : "none",
	                "stroke-linejoin": "round",
	                "stroke-linecap": "round",
	                "stroke-width": +(s.width / c * i).toFixed(3),
	                opacity: +(s.opacity / c).toFixed(3)
	            }));
	        }
	        return out.insertBefore(this).translate(s.offsetx, s.offsety);
	    };
	    var curveslengths = {},
	    getPointAtSegmentLength = function (p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, length) {
	        if (length == null) {
	            return bezlen(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y);
	        } else {
	            return R.findDotsAtSegment(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, getTatLen(p1x, p1y, c1x, c1y, c2x, c2y, p2x, p2y, length));
	        }
	    },
	    getLengthFactory = function (istotal, subpath) {
	        return function (path, length, onlystart) {
	            path = path2curve(path);
	            var x, y, p, l, sp = "", subpaths = {}, point,
	                len = 0;
	            for (var i = 0, ii = path.length; i < ii; i++) {
	                p = path[i];
	                if (p[0] == "M") {
	                    x = +p[1];
	                    y = +p[2];
	                } else {
	                    l = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6]);
	                    if (len + l > length) {
	                        if (subpath && !subpaths.start) {
	                            point = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6], length - len);
	                            sp += ["C" + point.start.x, point.start.y, point.m.x, point.m.y, point.x, point.y];
	                            if (onlystart) {return sp;}
	                            subpaths.start = sp;
	                            sp = ["M" + point.x, point.y + "C" + point.n.x, point.n.y, point.end.x, point.end.y, p[5], p[6]].join();
	                            len += l;
	                            x = +p[5];
	                            y = +p[6];
	                            continue;
	                        }
	                        if (!istotal && !subpath) {
	                            point = getPointAtSegmentLength(x, y, p[1], p[2], p[3], p[4], p[5], p[6], length - len);
	                            return {x: point.x, y: point.y, alpha: point.alpha};
	                        }
	                    }
	                    len += l;
	                    x = +p[5];
	                    y = +p[6];
	                }
	                sp += p.shift() + p;
	            }
	            subpaths.end = sp;
	            point = istotal ? len : subpath ? subpaths : R.findDotsAtSegment(x, y, p[0], p[1], p[2], p[3], p[4], p[5], 1);
	            point.alpha && (point = {x: point.x, y: point.y, alpha: point.alpha});
	            return point;
	        };
	    };
	    var getTotalLength = getLengthFactory(1),
	        getPointAtLength = getLengthFactory(),
	        getSubpathsAtLength = getLengthFactory(0, 1);
	    /*\
	     * Raphael.getTotalLength
	     [ method ]
	     **
	     * Returns length of the given path in pixels.
	     **
	     > Parameters
	     **
	     - path (string) SVG path string.
	     **
	     = (number) length.
	    \*/
	    R.getTotalLength = getTotalLength;
	    /*\
	     * Raphael.getPointAtLength
	     [ method ]
	     **
	     * Return coordinates of the point located at the given length on the given path.
	     **
	     > Parameters
	     **
	     - path (string) SVG path string
	     - length (number)
	     **
	     = (object) representation of the point:
	     o {
	     o     x: (number) x coordinate
	     o     y: (number) y coordinate
	     o     alpha: (number) angle of derivative
	     o }
	    \*/
	    R.getPointAtLength = getPointAtLength;
	    /*\
	     * Raphael.getSubpath
	     [ method ]
	     **
	     * Return subpath of a given path from given length to given length.
	     **
	     > Parameters
	     **
	     - path (string) SVG path string
	     - from (number) position of the start of the segment
	     - to (number) position of the end of the segment
	     **
	     = (string) pathstring for the segment
	    \*/
	    R.getSubpath = function (path, from, to) {
	        if (this.getTotalLength(path) - to < 1e-6) {
	            return getSubpathsAtLength(path, from).end;
	        }
	        var a = getSubpathsAtLength(path, to, 1);
	        return from ? getSubpathsAtLength(a, from).end : a;
	    };
	    /*\
	     * Element.getTotalLength
	     [ method ]
	     **
	     * Returns length of the path in pixels. Only works for element of path type.
	     = (number) length.
	    \*/
	    elproto.getTotalLength = function () {
	        var path = this.getPath();
	        if (!path) {
	            return;
	        }

	        if (this.node.getTotalLength) {
	            return this.node.getTotalLength();
	        }

	        return getTotalLength(path);
	    };
	    /*\
	     * Element.getPointAtLength
	     [ method ]
	     **
	     * Return coordinates of the point located at the given length on the given path. Only works for element of path type.
	     **
	     > Parameters
	     **
	     - length (number)
	     **
	     = (object) representation of the point:
	     o {
	     o     x: (number) x coordinate
	     o     y: (number) y coordinate
	     o     alpha: (number) angle of derivative
	     o }
	    \*/
	    elproto.getPointAtLength = function (length) {
	        var path = this.getPath();
	        if (!path) {
	            return;
	        }

	        return getPointAtLength(path, length);
	    };
	    /*\
	     * Element.getPath
	     [ method ]
	     **
	     * Returns path of the element. Only works for elements of path type and simple elements like circle.
	     = (object) path
	     **
	    \*/
	    elproto.getPath = function () {
	        var path,
	            getPath = R._getPath[this.type];

	        if (this.type == "text" || this.type == "set") {
	            return;
	        }

	        if (getPath) {
	            path = getPath(this);
	        }

	        return path;
	    };
	    /*\
	     * Element.getSubpath
	     [ method ]
	     **
	     * Return subpath of a given element from given length to given length. Only works for element of path type.
	     **
	     > Parameters
	     **
	     - from (number) position of the start of the segment
	     - to (number) position of the end of the segment
	     **
	     = (string) pathstring for the segment
	    \*/
	    elproto.getSubpath = function (from, to) {
	        var path = this.getPath();
	        if (!path) {
	            return;
	        }

	        return R.getSubpath(path, from, to);
	    };
	    /*\
	     * Raphael.easing_formulas
	     [ property ]
	     **
	     * Object that contains easing formulas for animation. You could extend it with your own. By default it has following list of easing:
	     # <ul>
	     #     <li>linear</li>
	     #     <li>&lt; or easeIn or ease-in</li>
	     #     <li>> or easeOut or ease-out</li>
	     #     <li>&lt;> or easeInOut or ease-in-out</li>
	     #     <li>backIn or back-in</li>
	     #     <li>backOut or back-out</li>
	     #     <li>elastic</li>
	     #     <li>bounce</li>
	     # </ul>
	     # <p>See also <a href="http://raphaeljs.com/easing.html">Easing demo</a>.</p>
	    \*/
	    var ef = R.easing_formulas = {
	        linear: function (n) {
	            return n;
	        },
	        "<": function (n) {
	            return pow(n, 1.7);
	        },
	        ">": function (n) {
	            return pow(n, .48);
	        },
	        "<>": function (n) {
	            var q = .48 - n / 1.04,
	                Q = math.sqrt(.1734 + q * q),
	                x = Q - q,
	                X = pow(abs(x), 1 / 3) * (x < 0 ? -1 : 1),
	                y = -Q - q,
	                Y = pow(abs(y), 1 / 3) * (y < 0 ? -1 : 1),
	                t = X + Y + .5;
	            return (1 - t) * 3 * t * t + t * t * t;
	        },
	        backIn: function (n) {
	            var s = 1.70158;
	            return n * n * ((s + 1) * n - s);
	        },
	        backOut: function (n) {
	            n = n - 1;
	            var s = 1.70158;
	            return n * n * ((s + 1) * n + s) + 1;
	        },
	        elastic: function (n) {
	            if (n == !!n) {
	                return n;
	            }
	            return pow(2, -10 * n) * math.sin((n - .075) * (2 * PI) / .3) + 1;
	        },
	        bounce: function (n) {
	            var s = 7.5625,
	                p = 2.75,
	                l;
	            if (n < (1 / p)) {
	                l = s * n * n;
	            } else {
	                if (n < (2 / p)) {
	                    n -= (1.5 / p);
	                    l = s * n * n + .75;
	                } else {
	                    if (n < (2.5 / p)) {
	                        n -= (2.25 / p);
	                        l = s * n * n + .9375;
	                    } else {
	                        n -= (2.625 / p);
	                        l = s * n * n + .984375;
	                    }
	                }
	            }
	            return l;
	        }
	    };
	    ef.easeIn = ef["ease-in"] = ef["<"];
	    ef.easeOut = ef["ease-out"] = ef[">"];
	    ef.easeInOut = ef["ease-in-out"] = ef["<>"];
	    ef["back-in"] = ef.backIn;
	    ef["back-out"] = ef.backOut;

	    var animationElements = [],
	        requestAnimFrame = window.requestAnimationFrame       ||
	                           window.webkitRequestAnimationFrame ||
	                           window.mozRequestAnimationFrame    ||
	                           window.oRequestAnimationFrame      ||
	                           window.msRequestAnimationFrame     ||
	                           function (callback) {
	                               setTimeout(callback, 16);
	                           },
	        animation = function () {
	            var Now = +new Date,
	                l = 0;
	            for (; l < animationElements.length; l++) {
	                var e = animationElements[l];
	                if (e.el.removed || e.paused) {
	                    continue;
	                }
	                var time = Now - e.start,
	                    ms = e.ms,
	                    easing = e.easing,
	                    from = e.from,
	                    diff = e.diff,
	                    to = e.to,
	                    t = e.t,
	                    that = e.el,
	                    set = {},
	                    now,
	                    init = {},
	                    key;
	                if (e.initstatus) {
	                    time = (e.initstatus * e.anim.top - e.prev) / (e.percent - e.prev) * ms;
	                    e.status = e.initstatus;
	                    delete e.initstatus;
	                    e.stop && animationElements.splice(l--, 1);
	                } else {
	                    e.status = (e.prev + (e.percent - e.prev) * (time / ms)) / e.anim.top;
	                }
	                if (time < 0) {
	                    continue;
	                }
	                if (time < ms) {
	                    var pos = easing(time / ms);
	                    for (var attr in from) if (from[has](attr)) {
	                        switch (availableAnimAttrs[attr]) {
	                            case nu:
	                                now = +from[attr] + pos * ms * diff[attr];
	                                break;
	                            case "colour":
	                                now = "rgb(" + [
	                                    upto255(round(from[attr].r + pos * ms * diff[attr].r)),
	                                    upto255(round(from[attr].g + pos * ms * diff[attr].g)),
	                                    upto255(round(from[attr].b + pos * ms * diff[attr].b))
	                                ].join(",") + ")";
	                                break;
	                            case "path":
	                                now = [];
	                                for (var i = 0, ii = from[attr].length; i < ii; i++) {
	                                    now[i] = [from[attr][i][0]];
	                                    for (var j = 1, jj = from[attr][i].length; j < jj; j++) {
	                                        now[i][j] = +from[attr][i][j] + pos * ms * diff[attr][i][j];
	                                    }
	                                    now[i] = now[i].join(S);
	                                }
	                                now = now.join(S);
	                                break;
	                            case "transform":
	                                if (diff[attr].real) {
	                                    now = [];
	                                    for (i = 0, ii = from[attr].length; i < ii; i++) {
	                                        now[i] = [from[attr][i][0]];
	                                        for (j = 1, jj = from[attr][i].length; j < jj; j++) {
	                                            now[i][j] = from[attr][i][j] + pos * ms * diff[attr][i][j];
	                                        }
	                                    }
	                                } else {
	                                    var get = function (i) {
	                                        return +from[attr][i] + pos * ms * diff[attr][i];
	                                    };
	                                    // now = [["r", get(2), 0, 0], ["t", get(3), get(4)], ["s", get(0), get(1), 0, 0]];
	                                    now = [["m", get(0), get(1), get(2), get(3), get(4), get(5)]];
	                                }
	                                break;
	                            case "csv":
	                                if (attr == "clip-rect") {
	                                    now = [];
	                                    i = 4;
	                                    while (i--) {
	                                        now[i] = +from[attr][i] + pos * ms * diff[attr][i];
	                                    }
	                                }
	                                break;
	                            default:
	                                var from2 = [][concat](from[attr]);
	                                now = [];
	                                i = that.paper.customAttributes[attr].length;
	                                while (i--) {
	                                    now[i] = +from2[i] + pos * ms * diff[attr][i];
	                                }
	                                break;
	                        }
	                        set[attr] = now;
	                    }
	                    that.attr(set);
	                    (function (id, that, anim) {
	                        setTimeout(function () {
	                            eve("raphael.anim.frame." + id, that, anim);
	                        });
	                    })(that.id, that, e.anim);
	                } else {
	                    (function(f, el, a) {
	                        setTimeout(function() {
	                            eve("raphael.anim.frame." + el.id, el, a);
	                            eve("raphael.anim.finish." + el.id, el, a);
	                            R.is(f, "function") && f.call(el);
	                        });
	                    })(e.callback, that, e.anim);
	                    that.attr(to);
	                    animationElements.splice(l--, 1);
	                    if (e.repeat > 1 && !e.next) {
	                        for (key in to) if (to[has](key)) {
	                            init[key] = e.totalOrigin[key];
	                        }
	                        e.el.attr(init);
	                        runAnimation(e.anim, e.el, e.anim.percents[0], null, e.totalOrigin, e.repeat - 1);
	                    }
	                    if (e.next && !e.stop) {
	                        runAnimation(e.anim, e.el, e.next, null, e.totalOrigin, e.repeat);
	                    }
	                }
	            }
	            animationElements.length && requestAnimFrame(animation);
	        },
	        upto255 = function (color) {
	            return color > 255 ? 255 : color < 0 ? 0 : color;
	        };
	    /*\
	     * Element.animateWith
	     [ method ]
	     **
	     * Acts similar to @Element.animate, but ensure that given animation runs in sync with another given element.
	     **
	     > Parameters
	     **
	     - el (object) element to sync with
	     - anim (object) animation to sync with
	     - params (object) #optional final attributes for the element, see also @Element.attr
	     - ms (number) #optional number of milliseconds for animation to run
	     - easing (string) #optional easing type. Accept on of @Raphael.easing_formulas or CSS format: `cubic&#x2010;bezier(XX,&#160;XX,&#160;XX,&#160;XX)`
	     - callback (function) #optional callback function. Will be called at the end of animation.
	     * or
	     - element (object) element to sync with
	     - anim (object) animation to sync with
	     - animation (object) #optional animation object, see @Raphael.animation
	     **
	     = (object) original element
	    \*/
	    elproto.animateWith = function (el, anim, params, ms, easing, callback) {
	        var element = this;
	        if (element.removed) {
	            callback && callback.call(element);
	            return element;
	        }
	        var a = params instanceof Animation ? params : R.animation(params, ms, easing, callback),
	            x, y;
	        runAnimation(a, element, a.percents[0], null, element.attr());
	        for (var i = 0, ii = animationElements.length; i < ii; i++) {
	            if (animationElements[i].anim == anim && animationElements[i].el == el) {
	                animationElements[ii - 1].start = animationElements[i].start;
	                break;
	            }
	        }
	        return element;
	        //
	        //
	        // var a = params ? R.animation(params, ms, easing, callback) : anim,
	        //     status = element.status(anim);
	        // return this.animate(a).status(a, status * anim.ms / a.ms);
	    };
	    function CubicBezierAtTime(t, p1x, p1y, p2x, p2y, duration) {
	        var cx = 3 * p1x,
	            bx = 3 * (p2x - p1x) - cx,
	            ax = 1 - cx - bx,
	            cy = 3 * p1y,
	            by = 3 * (p2y - p1y) - cy,
	            ay = 1 - cy - by;
	        function sampleCurveX(t) {
	            return ((ax * t + bx) * t + cx) * t;
	        }
	        function solve(x, epsilon) {
	            var t = solveCurveX(x, epsilon);
	            return ((ay * t + by) * t + cy) * t;
	        }
	        function solveCurveX(x, epsilon) {
	            var t0, t1, t2, x2, d2, i;
	            for(t2 = x, i = 0; i < 8; i++) {
	                x2 = sampleCurveX(t2) - x;
	                if (abs(x2) < epsilon) {
	                    return t2;
	                }
	                d2 = (3 * ax * t2 + 2 * bx) * t2 + cx;
	                if (abs(d2) < 1e-6) {
	                    break;
	                }
	                t2 = t2 - x2 / d2;
	            }
	            t0 = 0;
	            t1 = 1;
	            t2 = x;
	            if (t2 < t0) {
	                return t0;
	            }
	            if (t2 > t1) {
	                return t1;
	            }
	            while (t0 < t1) {
	                x2 = sampleCurveX(t2);
	                if (abs(x2 - x) < epsilon) {
	                    return t2;
	                }
	                if (x > x2) {
	                    t0 = t2;
	                } else {
	                    t1 = t2;
	                }
	                t2 = (t1 - t0) / 2 + t0;
	            }
	            return t2;
	        }
	        return solve(t, 1 / (200 * duration));
	    }
	    elproto.onAnimation = function (f) {
	        f ? eve.on("raphael.anim.frame." + this.id, f) : eve.unbind("raphael.anim.frame." + this.id);
	        return this;
	    };
	    function Animation(anim, ms) {
	        var percents = [],
	            newAnim = {};
	        this.ms = ms;
	        this.times = 1;
	        if (anim) {
	            for (var attr in anim) if (anim[has](attr)) {
	                newAnim[toFloat(attr)] = anim[attr];
	                percents.push(toFloat(attr));
	            }
	            percents.sort(sortByNumber);
	        }
	        this.anim = newAnim;
	        this.top = percents[percents.length - 1];
	        this.percents = percents;
	    }
	    /*\
	     * Animation.delay
	     [ method ]
	     **
	     * Creates a copy of existing animation object with given delay.
	     **
	     > Parameters
	     **
	     - delay (number) number of ms to pass between animation start and actual animation
	     **
	     = (object) new altered Animation object
	     | var anim = Raphael.animation({cx: 10, cy: 20}, 2e3);
	     | circle1.animate(anim); // run the given animation immediately
	     | circle2.animate(anim.delay(500)); // run the given animation after 500 ms
	    \*/
	    Animation.prototype.delay = function (delay) {
	        var a = new Animation(this.anim, this.ms);
	        a.times = this.times;
	        a.del = +delay || 0;
	        return a;
	    };
	    /*\
	     * Animation.repeat
	     [ method ]
	     **
	     * Creates a copy of existing animation object with given repetition.
	     **
	     > Parameters
	     **
	     - repeat (number) number iterations of animation. For infinite animation pass `Infinity`
	     **
	     = (object) new altered Animation object
	    \*/
	    Animation.prototype.repeat = function (times) {
	        var a = new Animation(this.anim, this.ms);
	        a.del = this.del;
	        a.times = math.floor(mmax(times, 0)) || 1;
	        return a;
	    };
	    function runAnimation(anim, element, percent, status, totalOrigin, times) {
	        percent = toFloat(percent);
	        var params,
	            isInAnim,
	            isInAnimSet,
	            percents = [],
	            next,
	            prev,
	            timestamp,
	            ms = anim.ms,
	            from = {},
	            to = {},
	            diff = {};
	        if (status) {
	            for (i = 0, ii = animationElements.length; i < ii; i++) {
	                var e = animationElements[i];
	                if (e.el.id == element.id && e.anim == anim) {
	                    if (e.percent != percent) {
	                        animationElements.splice(i, 1);
	                        isInAnimSet = 1;
	                    } else {
	                        isInAnim = e;
	                    }
	                    element.attr(e.totalOrigin);
	                    break;
	                }
	            }
	        } else {
	            status = +to; // NaN
	        }
	        for (var i = 0, ii = anim.percents.length; i < ii; i++) {
	            if (anim.percents[i] == percent || anim.percents[i] > status * anim.top) {
	                percent = anim.percents[i];
	                prev = anim.percents[i - 1] || 0;
	                ms = ms / anim.top * (percent - prev);
	                next = anim.percents[i + 1];
	                params = anim.anim[percent];
	                break;
	            } else if (status) {
	                element.attr(anim.anim[anim.percents[i]]);
	            }
	        }
	        if (!params) {
	            return;
	        }
	        if (!isInAnim) {
	            for (var attr in params) if (params[has](attr)) {
	                if (availableAnimAttrs[has](attr) || element.paper.customAttributes[has](attr)) {
	                    from[attr] = element.attr(attr);
	                    (from[attr] == null) && (from[attr] = availableAttrs[attr]);
	                    to[attr] = params[attr];
	                    switch (availableAnimAttrs[attr]) {
	                        case nu:
	                            diff[attr] = (to[attr] - from[attr]) / ms;
	                            break;
	                        case "colour":
	                            from[attr] = R.getRGB(from[attr]);
	                            var toColour = R.getRGB(to[attr]);
	                            diff[attr] = {
	                                r: (toColour.r - from[attr].r) / ms,
	                                g: (toColour.g - from[attr].g) / ms,
	                                b: (toColour.b - from[attr].b) / ms
	                            };
	                            break;
	                        case "path":
	                            var pathes = path2curve(from[attr], to[attr]),
	                                toPath = pathes[1];
	                            from[attr] = pathes[0];
	                            diff[attr] = [];
	                            for (i = 0, ii = from[attr].length; i < ii; i++) {
	                                diff[attr][i] = [0];
	                                for (var j = 1, jj = from[attr][i].length; j < jj; j++) {
	                                    diff[attr][i][j] = (toPath[i][j] - from[attr][i][j]) / ms;
	                                }
	                            }
	                            break;
	                        case "transform":
	                            var _ = element._,
	                                eq = equaliseTransform(_[attr], to[attr]);
	                            if (eq) {
	                                from[attr] = eq.from;
	                                to[attr] = eq.to;
	                                diff[attr] = [];
	                                diff[attr].real = true;
	                                for (i = 0, ii = from[attr].length; i < ii; i++) {
	                                    diff[attr][i] = [from[attr][i][0]];
	                                    for (j = 1, jj = from[attr][i].length; j < jj; j++) {
	                                        diff[attr][i][j] = (to[attr][i][j] - from[attr][i][j]) / ms;
	                                    }
	                                }
	                            } else {
	                                var m = (element.matrix || new Matrix),
	                                    to2 = {
	                                        _: {transform: _.transform},
	                                        getBBox: function () {
	                                            return element.getBBox(1);
	                                        }
	                                    };
	                                from[attr] = [
	                                    m.a,
	                                    m.b,
	                                    m.c,
	                                    m.d,
	                                    m.e,
	                                    m.f
	                                ];
	                                extractTransform(to2, to[attr]);
	                                to[attr] = to2._.transform;
	                                diff[attr] = [
	                                    (to2.matrix.a - m.a) / ms,
	                                    (to2.matrix.b - m.b) / ms,
	                                    (to2.matrix.c - m.c) / ms,
	                                    (to2.matrix.d - m.d) / ms,
	                                    (to2.matrix.e - m.e) / ms,
	                                    (to2.matrix.f - m.f) / ms
	                                ];
	                                // from[attr] = [_.sx, _.sy, _.deg, _.dx, _.dy];
	                                // var to2 = {_:{}, getBBox: function () { return element.getBBox(); }};
	                                // extractTransform(to2, to[attr]);
	                                // diff[attr] = [
	                                //     (to2._.sx - _.sx) / ms,
	                                //     (to2._.sy - _.sy) / ms,
	                                //     (to2._.deg - _.deg) / ms,
	                                //     (to2._.dx - _.dx) / ms,
	                                //     (to2._.dy - _.dy) / ms
	                                // ];
	                            }
	                            break;
	                        case "csv":
	                            var values = Str(params[attr])[split](separator),
	                                from2 = Str(from[attr])[split](separator);
	                            if (attr == "clip-rect") {
	                                from[attr] = from2;
	                                diff[attr] = [];
	                                i = from2.length;
	                                while (i--) {
	                                    diff[attr][i] = (values[i] - from[attr][i]) / ms;
	                                }
	                            }
	                            to[attr] = values;
	                            break;
	                        default:
	                            values = [][concat](params[attr]);
	                            from2 = [][concat](from[attr]);
	                            diff[attr] = [];
	                            i = element.paper.customAttributes[attr].length;
	                            while (i--) {
	                                diff[attr][i] = ((values[i] || 0) - (from2[i] || 0)) / ms;
	                            }
	                            break;
	                    }
	                }
	            }
	            var easing = params.easing,
	                easyeasy = R.easing_formulas[easing];
	            if (!easyeasy) {
	                easyeasy = Str(easing).match(bezierrg);
	                if (easyeasy && easyeasy.length == 5) {
	                    var curve = easyeasy;
	                    easyeasy = function (t) {
	                        return CubicBezierAtTime(t, +curve[1], +curve[2], +curve[3], +curve[4], ms);
	                    };
	                } else {
	                    easyeasy = pipe;
	                }
	            }
	            timestamp = params.start || anim.start || +new Date;
	            e = {
	                anim: anim,
	                percent: percent,
	                timestamp: timestamp,
	                start: timestamp + (anim.del || 0),
	                status: 0,
	                initstatus: status || 0,
	                stop: false,
	                ms: ms,
	                easing: easyeasy,
	                from: from,
	                diff: diff,
	                to: to,
	                el: element,
	                callback: params.callback,
	                prev: prev,
	                next: next,
	                repeat: times || anim.times,
	                origin: element.attr(),
	                totalOrigin: totalOrigin
	            };
	            animationElements.push(e);
	            if (status && !isInAnim && !isInAnimSet) {
	                e.stop = true;
	                e.start = new Date - ms * status;
	                if (animationElements.length == 1) {
	                    return animation();
	                }
	            }
	            if (isInAnimSet) {
	                e.start = new Date - e.ms * status;
	            }
	            animationElements.length == 1 && requestAnimFrame(animation);
	        } else {
	            isInAnim.initstatus = status;
	            isInAnim.start = new Date - isInAnim.ms * status;
	        }
	        eve("raphael.anim.start." + element.id, element, anim);
	    }
	    /*\
	     * Raphael.animation
	     [ method ]
	     **
	     * Creates an animation object that can be passed to the @Element.animate or @Element.animateWith methods.
	     * See also @Animation.delay and @Animation.repeat methods.
	     **
	     > Parameters
	     **
	     - params (object) final attributes for the element, see also @Element.attr
	     - ms (number) number of milliseconds for animation to run
	     - easing (string) #optional easing type. Accept one of @Raphael.easing_formulas or CSS format: `cubic&#x2010;bezier(XX,&#160;XX,&#160;XX,&#160;XX)`
	     - callback (function) #optional callback function. Will be called at the end of animation.
	     **
	     = (object) @Animation
	    \*/
	    R.animation = function (params, ms, easing, callback) {
	        if (params instanceof Animation) {
	            return params;
	        }
	        if (R.is(easing, "function") || !easing) {
	            callback = callback || easing || null;
	            easing = null;
	        }
	        params = Object(params);
	        ms = +ms || 0;
	        var p = {},
	            json,
	            attr;
	        for (attr in params) if (params[has](attr) && toFloat(attr) != attr && toFloat(attr) + "%" != attr) {
	            json = true;
	            p[attr] = params[attr];
	        }
	        if (!json) {
	            // if percent-like syntax is used and end-of-all animation callback used
	            if(callback){
	                // find the last one
	                var lastKey = 0;
	                for(var i in params){
	                    var percent = toInt(i);
	                    if(params[has](i) && percent > lastKey){
	                        lastKey = percent;
	                    }
	                }
	                lastKey += '%';
	                // if already defined callback in the last keyframe, skip
	                !params[lastKey].callback && (params[lastKey].callback = callback);
	            }
	          return new Animation(params, ms);
	        } else {
	            easing && (p.easing = easing);
	            callback && (p.callback = callback);
	            return new Animation({100: p}, ms);
	        }
	    };
	    /*\
	     * Element.animate
	     [ method ]
	     **
	     * Creates and starts animation for given element.
	     **
	     > Parameters
	     **
	     - params (object) final attributes for the element, see also @Element.attr
	     - ms (number) number of milliseconds for animation to run
	     - easing (string) #optional easing type. Accept one of @Raphael.easing_formulas or CSS format: `cubic&#x2010;bezier(XX,&#160;XX,&#160;XX,&#160;XX)`
	     - callback (function) #optional callback function. Will be called at the end of animation.
	     * or
	     - animation (object) animation object, see @Raphael.animation
	     **
	     = (object) original element
	    \*/
	    elproto.animate = function (params, ms, easing, callback) {
	        var element = this;
	        if (element.removed) {
	            callback && callback.call(element);
	            return element;
	        }
	        var anim = params instanceof Animation ? params : R.animation(params, ms, easing, callback);
	        runAnimation(anim, element, anim.percents[0], null, element.attr());
	        return element;
	    };
	    /*\
	     * Element.setTime
	     [ method ]
	     **
	     * Sets the status of animation of the element in milliseconds. Similar to @Element.status method.
	     **
	     > Parameters
	     **
	     - anim (object) animation object
	     - value (number) number of milliseconds from the beginning of the animation
	     **
	     = (object) original element if `value` is specified
	     * Note, that during animation following events are triggered:
	     *
	     * On each animation frame event `anim.frame.<id>`, on start `anim.start.<id>` and on end `anim.finish.<id>`.
	    \*/
	    elproto.setTime = function (anim, value) {
	        if (anim && value != null) {
	            this.status(anim, mmin(value, anim.ms) / anim.ms);
	        }
	        return this;
	    };
	    /*\
	     * Element.status
	     [ method ]
	     **
	     * Gets or sets the status of animation of the element.
	     **
	     > Parameters
	     **
	     - anim (object) #optional animation object
	     - value (number) #optional 0  1. If specified, method works like a setter and sets the status of a given animation to the value. This will cause animation to jump to the given position.
	     **
	     = (number) status
	     * or
	     = (array) status if `anim` is not specified. Array of objects in format:
	     o {
	     o     anim: (object) animation object
	     o     status: (number) status
	     o }
	     * or
	     = (object) original element if `value` is specified
	    \*/
	    elproto.status = function (anim, value) {
	        var out = [],
	            i = 0,
	            len,
	            e;
	        if (value != null) {
	            runAnimation(anim, this, -1, mmin(value, 1));
	            return this;
	        } else {
	            len = animationElements.length;
	            for (; i < len; i++) {
	                e = animationElements[i];
	                if (e.el.id == this.id && (!anim || e.anim == anim)) {
	                    if (anim) {
	                        return e.status;
	                    }
	                    out.push({
	                        anim: e.anim,
	                        status: e.status
	                    });
	                }
	            }
	            if (anim) {
	                return 0;
	            }
	            return out;
	        }
	    };
	    /*\
	     * Element.pause
	     [ method ]
	     **
	     * Stops animation of the element with ability to resume it later on.
	     **
	     > Parameters
	     **
	     - anim (object) #optional animation object
	     **
	     = (object) original element
	    \*/
	    elproto.pause = function (anim) {
	        for (var i = 0; i < animationElements.length; i++) if (animationElements[i].el.id == this.id && (!anim || animationElements[i].anim == anim)) {
	            if (eve("raphael.anim.pause." + this.id, this, animationElements[i].anim) !== false) {
	                animationElements[i].paused = true;
	            }
	        }
	        return this;
	    };
	    /*\
	     * Element.resume
	     [ method ]
	     **
	     * Resumes animation if it was paused with @Element.pause method.
	     **
	     > Parameters
	     **
	     - anim (object) #optional animation object
	     **
	     = (object) original element
	    \*/
	    elproto.resume = function (anim) {
	        for (var i = 0; i < animationElements.length; i++) if (animationElements[i].el.id == this.id && (!anim || animationElements[i].anim == anim)) {
	            var e = animationElements[i];
	            if (eve("raphael.anim.resume." + this.id, this, e.anim) !== false) {
	                delete e.paused;
	                this.status(e.anim, e.status);
	            }
	        }
	        return this;
	    };
	    /*\
	     * Element.stop
	     [ method ]
	     **
	     * Stops animation of the element.
	     **
	     > Parameters
	     **
	     - anim (object) #optional animation object
	     **
	     = (object) original element
	    \*/
	    elproto.stop = function (anim) {
	        for (var i = 0; i < animationElements.length; i++) if (animationElements[i].el.id == this.id && (!anim || animationElements[i].anim == anim)) {
	            if (eve("raphael.anim.stop." + this.id, this, animationElements[i].anim) !== false) {
	                animationElements.splice(i--, 1);
	            }
	        }
	        return this;
	    };
	    function stopAnimation(paper) {
	        for (var i = 0; i < animationElements.length; i++) if (animationElements[i].el.paper == paper) {
	            animationElements.splice(i--, 1);
	        }
	    }
	    eve.on("raphael.remove", stopAnimation);
	    eve.on("raphael.clear", stopAnimation);
	    elproto.toString = function () {
	        return "Rapha\xebl\u2019s object";
	    };

	    // Set
	    var Set = function (items) {
	        this.items = [];
	        this.length = 0;
	        this.type = "set";
	        if (items) {
	            for (var i = 0, ii = items.length; i < ii; i++) {
	                if (items[i] && (items[i].constructor == elproto.constructor || items[i].constructor == Set)) {
	                    this[this.items.length] = this.items[this.items.length] = items[i];
	                    this.length++;
	                }
	            }
	        }
	    },
	    setproto = Set.prototype;
	    /*\
	     * Set.push
	     [ method ]
	     **
	     * Adds each argument to the current set.
	     = (object) original element
	    \*/
	    setproto.push = function () {
	        var item,
	            len;
	        for (var i = 0, ii = arguments.length; i < ii; i++) {
	            item = arguments[i];
	            if (item && (item.constructor == elproto.constructor || item.constructor == Set)) {
	                len = this.items.length;
	                this[len] = this.items[len] = item;
	                this.length++;
	            }
	        }
	        return this;
	    };
	    /*\
	     * Set.pop
	     [ method ]
	     **
	     * Removes last element and returns it.
	     = (object) element
	    \*/
	    setproto.pop = function () {
	        this.length && delete this[this.length--];
	        return this.items.pop();
	    };
	    /*\
	     * Set.forEach
	     [ method ]
	     **
	     * Executes given function for each element in the set.
	     *
	     * If function returns `false` it will stop loop running.
	     **
	     > Parameters
	     **
	     - callback (function) function to run
	     - thisArg (object) context object for the callback
	     = (object) Set object
	    \*/
	    setproto.forEach = function (callback, thisArg) {
	        for (var i = 0, ii = this.items.length; i < ii; i++) {
	            if (callback.call(thisArg, this.items[i], i) === false) {
	                return this;
	            }
	        }
	        return this;
	    };
	    for (var method in elproto) if (elproto[has](method)) {
	        setproto[method] = (function (methodname) {
	            return function () {
	                var arg = arguments;
	                return this.forEach(function (el) {
	                    el[methodname][apply](el, arg);
	                });
	            };
	        })(method);
	    }
	    setproto.attr = function (name, value) {
	        if (name && R.is(name, array) && R.is(name[0], "object")) {
	            for (var j = 0, jj = name.length; j < jj; j++) {
	                this.items[j].attr(name[j]);
	            }
	        } else {
	            for (var i = 0, ii = this.items.length; i < ii; i++) {
	                this.items[i].attr(name, value);
	            }
	        }
	        return this;
	    };
	    /*\
	     * Set.clear
	     [ method ]
	     **
	     * Removes all elements from the set
	    \*/
	    setproto.clear = function () {
	        while (this.length) {
	            this.pop();
	        }
	    };
	    /*\
	     * Set.splice
	     [ method ]
	     **
	     * Removes given element from the set
	     **
	     > Parameters
	     **
	     - index (number) position of the deletion
	     - count (number) number of element to remove
	     - insertion (object) #optional elements to insert
	     = (object) set elements that were deleted
	    \*/
	    setproto.splice = function (index, count, insertion) {
	        index = index < 0 ? mmax(this.length + index, 0) : index;
	        count = mmax(0, mmin(this.length - index, count));
	        var tail = [],
	            todel = [],
	            args = [],
	            i;
	        for (i = 2; i < arguments.length; i++) {
	            args.push(arguments[i]);
	        }
	        for (i = 0; i < count; i++) {
	            todel.push(this[index + i]);
	        }
	        for (; i < this.length - index; i++) {
	            tail.push(this[index + i]);
	        }
	        var arglen = args.length;
	        for (i = 0; i < arglen + tail.length; i++) {
	            this.items[index + i] = this[index + i] = i < arglen ? args[i] : tail[i - arglen];
	        }
	        i = this.items.length = this.length -= count - arglen;
	        while (this[i]) {
	            delete this[i++];
	        }
	        return new Set(todel);
	    };
	    /*\
	     * Set.exclude
	     [ method ]
	     **
	     * Removes given element from the set
	     **
	     > Parameters
	     **
	     - element (object) element to remove
	     = (boolean) `true` if object was found & removed from the set
	    \*/
	    setproto.exclude = function (el) {
	        for (var i = 0, ii = this.length; i < ii; i++) if (this[i] == el) {
	            this.splice(i, 1);
	            return true;
	        }
	    };
	    setproto.animate = function (params, ms, easing, callback) {
	        (R.is(easing, "function") || !easing) && (callback = easing || null);
	        var len = this.items.length,
	            i = len,
	            item,
	            set = this,
	            collector;
	        if (!len) {
	            return this;
	        }
	        callback && (collector = function () {
	            !--len && callback.call(set);
	        });
	        easing = R.is(easing, string) ? easing : collector;
	        var anim = R.animation(params, ms, easing, collector);
	        item = this.items[--i].animate(anim);
	        while (i--) {
	            this.items[i] && !this.items[i].removed && this.items[i].animateWith(item, anim, anim);
	            (this.items[i] && !this.items[i].removed) || len--;
	        }
	        return this;
	    };
	    setproto.insertAfter = function (el) {
	        var i = this.items.length;
	        while (i--) {
	            this.items[i].insertAfter(el);
	        }
	        return this;
	    };
	    setproto.getBBox = function () {
	        var x = [],
	            y = [],
	            x2 = [],
	            y2 = [];
	        for (var i = this.items.length; i--;) if (!this.items[i].removed) {
	            var box = this.items[i].getBBox();
	            x.push(box.x);
	            y.push(box.y);
	            x2.push(box.x + box.width);
	            y2.push(box.y + box.height);
	        }
	        x = mmin[apply](0, x);
	        y = mmin[apply](0, y);
	        x2 = mmax[apply](0, x2);
	        y2 = mmax[apply](0, y2);
	        return {
	            x: x,
	            y: y,
	            x2: x2,
	            y2: y2,
	            width: x2 - x,
	            height: y2 - y
	        };
	    };
	    setproto.clone = function (s) {
	        s = this.paper.set();
	        for (var i = 0, ii = this.items.length; i < ii; i++) {
	            s.push(this.items[i].clone());
	        }
	        return s;
	    };
	    setproto.toString = function () {
	        return "Rapha\xebl\u2018s set";
	    };

	    setproto.glow = function(glowConfig) {
	        var ret = this.paper.set();
	        this.forEach(function(shape, index){
	            var g = shape.glow(glowConfig);
	            if(g != null){
	                g.forEach(function(shape2, index2){
	                    ret.push(shape2);
	                });
	            }
	        });
	        return ret;
	    };


	    /*\
	     * Set.isPointInside
	     [ method ]
	     **
	     * Determine if given point is inside this sets elements
	     **
	     > Parameters
	     **
	     - x (number) x coordinate of the point
	     - y (number) y coordinate of the point
	     = (boolean) `true` if point is inside any of the set's elements
	     \*/
	    setproto.isPointInside = function (x, y) {
	        var isPointInside = false;
	        this.forEach(function (el) {
	            if (el.isPointInside(x, y)) {
	                isPointInside = true;
	                return false; // stop loop
	            }
	        });
	        return isPointInside;
	    };

	    /*\
	     * Raphael.registerFont
	     [ method ]
	     **
	     * Adds given font to the registered set of fonts for Raphal. Should be used as an internal call from within Cufns font file.
	     * Returns original parameter, so it could be used with chaining.
	     # <a href="http://wiki.github.com/sorccu/cufon/about">More about Cufn and how to convert your font form TTF, OTF, etc to JavaScript file.</a>
	     **
	     > Parameters
	     **
	     - font (object) the font to register
	     = (object) the font you passed in
	     > Usage
	     | Cufon.registerFont(Raphael.registerFont({}));
	    \*/
	    R.registerFont = function (font) {
	        if (!font.face) {
	            return font;
	        }
	        this.fonts = this.fonts || {};
	        var fontcopy = {
	                w: font.w,
	                face: {},
	                glyphs: {}
	            },
	            family = font.face["font-family"];
	        for (var prop in font.face) if (font.face[has](prop)) {
	            fontcopy.face[prop] = font.face[prop];
	        }
	        if (this.fonts[family]) {
	            this.fonts[family].push(fontcopy);
	        } else {
	            this.fonts[family] = [fontcopy];
	        }
	        if (!font.svg) {
	            fontcopy.face["units-per-em"] = toInt(font.face["units-per-em"], 10);
	            for (var glyph in font.glyphs) if (font.glyphs[has](glyph)) {
	                var path = font.glyphs[glyph];
	                fontcopy.glyphs[glyph] = {
	                    w: path.w,
	                    k: {},
	                    d: path.d && "M" + path.d.replace(/[mlcxtrv]/g, function (command) {
	                            return {l: "L", c: "C", x: "z", t: "m", r: "l", v: "c"}[command] || "M";
	                        }) + "z"
	                };
	                if (path.k) {
	                    for (var k in path.k) if (path[has](k)) {
	                        fontcopy.glyphs[glyph].k[k] = path.k[k];
	                    }
	                }
	            }
	        }
	        return font;
	    };
	    /*\
	     * Paper.getFont
	     [ method ]
	     **
	     * Finds font object in the registered fonts by given parameters. You could specify only one word from the font name, like Myriad for Myriad Pro.
	     **
	     > Parameters
	     **
	     - family (string) font family name or any word from it
	     - weight (string) #optional font weight
	     - style (string) #optional font style
	     - stretch (string) #optional font stretch
	     = (object) the font object
	     > Usage
	     | paper.print(100, 100, "Test string", paper.getFont("Times", 800), 30);
	    \*/
	    paperproto.getFont = function (family, weight, style, stretch) {
	        stretch = stretch || "normal";
	        style = style || "normal";
	        weight = +weight || {normal: 400, bold: 700, lighter: 300, bolder: 800}[weight] || 400;
	        if (!R.fonts) {
	            return;
	        }
	        var font = R.fonts[family];
	        if (!font) {
	            var name = new RegExp("(^|\\s)" + family.replace(/[^\w\d\s+!~.:_-]/g, E) + "(\\s|$)", "i");
	            for (var fontName in R.fonts) if (R.fonts[has](fontName)) {
	                if (name.test(fontName)) {
	                    font = R.fonts[fontName];
	                    break;
	                }
	            }
	        }
	        var thefont;
	        if (font) {
	            for (var i = 0, ii = font.length; i < ii; i++) {
	                thefont = font[i];
	                if (thefont.face["font-weight"] == weight && (thefont.face["font-style"] == style || !thefont.face["font-style"]) && thefont.face["font-stretch"] == stretch) {
	                    break;
	                }
	            }
	        }
	        return thefont;
	    };
	    /*\
	     * Paper.print
	     [ method ]
	     **
	     * Creates path that represent given text written using given font at given position with given size.
	     * Result of the method is path element that contains whole text as a separate path.
	     **
	     > Parameters
	     **
	     - x (number) x position of the text
	     - y (number) y position of the text
	     - string (string) text to print
	     - font (object) font object, see @Paper.getFont
	     - size (number) #optional size of the font, default is `16`
	     - origin (string) #optional could be `"baseline"` or `"middle"`, default is `"middle"`
	     - letter_spacing (number) #optional number in range `-1..1`, default is `0`
	     - line_spacing (number) #optional number in range `1..3`, default is `1`
	     = (object) resulting path element, which consist of all letters
	     > Usage
	     | var txt = r.print(10, 50, "print", r.getFont("Museo"), 30).attr({fill: "#fff"});
	    \*/
	    paperproto.print = function (x, y, string, font, size, origin, letter_spacing, line_spacing) {
	        origin = origin || "middle"; // baseline|middle
	        letter_spacing = mmax(mmin(letter_spacing || 0, 1), -1);
	        line_spacing = mmax(mmin(line_spacing || 1, 3), 1);
	        var letters = Str(string)[split](E),
	            shift = 0,
	            notfirst = 0,
	            path = E,
	            scale;
	        R.is(font, "string") && (font = this.getFont(font));
	        if (font) {
	            scale = (size || 16) / font.face["units-per-em"];
	            var bb = font.face.bbox[split](separator),
	                top = +bb[0],
	                lineHeight = bb[3] - bb[1],
	                shifty = 0,
	                height = +bb[1] + (origin == "baseline" ? lineHeight + (+font.face.descent) : lineHeight / 2);
	            for (var i = 0, ii = letters.length; i < ii; i++) {
	                if (letters[i] == "\n") {
	                    shift = 0;
	                    curr = 0;
	                    notfirst = 0;
	                    shifty += lineHeight * line_spacing;
	                } else {
	                    var prev = notfirst && font.glyphs[letters[i - 1]] || {},
	                        curr = font.glyphs[letters[i]];
	                    shift += notfirst ? (prev.w || font.w) + (prev.k && prev.k[letters[i]] || 0) + (font.w * letter_spacing) : 0;
	                    notfirst = 1;
	                }
	                if (curr && curr.d) {
	                    path += R.transformPath(curr.d, ["t", shift * scale, shifty * scale, "s", scale, scale, top, height, "t", (x - top) / scale, (y - height) / scale]);
	                }
	            }
	        }
	        return this.path(path).attr({
	            fill: "#000",
	            stroke: "none"
	        });
	    };

	    /*\
	     * Paper.add
	     [ method ]
	     **
	     * Imports elements in JSON array in format `{type: type, <attributes>}`
	     **
	     > Parameters
	     **
	     - json (array)
	     = (object) resulting set of imported elements
	     > Usage
	     | paper.add([
	     |     {
	     |         type: "circle",
	     |         cx: 10,
	     |         cy: 10,
	     |         r: 5
	     |     },
	     |     {
	     |         type: "rect",
	     |         x: 10,
	     |         y: 10,
	     |         width: 10,
	     |         height: 10,
	     |         fill: "#fc0"
	     |     }
	     | ]);
	    \*/
	    paperproto.add = function (json) {
	        if (R.is(json, "array")) {
	            var res = this.set(),
	                i = 0,
	                ii = json.length,
	                j;
	            for (; i < ii; i++) {
	                j = json[i] || {};
	                elements[has](j.type) && res.push(this[j.type]().attr(j));
	            }
	        }
	        return res;
	    };

	    /*\
	     * Raphael.format
	     [ method ]
	     **
	     * Simple format function. Replaces construction of type `{<number>}` to the corresponding argument.
	     **
	     > Parameters
	     **
	     - token (string) string to format
	     -  (string) rest of arguments will be treated as parameters for replacement
	     = (string) formated string
	     > Usage
	     | var x = 10,
	     |     y = 20,
	     |     width = 40,
	     |     height = 50;
	     | // this will draw a rectangular shape equivalent to "M10,20h40v50h-40z"
	     | paper.path(Raphael.format("M{0},{1}h{2}v{3}h{4}z", x, y, width, height, -width));
	    \*/
	    R.format = function (token, params) {
	        var args = R.is(params, array) ? [0][concat](params) : arguments;
	        token && R.is(token, string) && args.length - 1 && (token = token.replace(formatrg, function (str, i) {
	            return args[++i] == null ? E : args[i];
	        }));
	        return token || E;
	    };
	    /*\
	     * Raphael.fullfill
	     [ method ]
	     **
	     * A little bit more advanced format function than @Raphael.format. Replaces construction of type `{<name>}` to the corresponding argument.
	     **
	     > Parameters
	     **
	     - token (string) string to format
	     - json (object) object which properties will be used as a replacement
	     = (string) formated string
	     > Usage
	     | // this will draw a rectangular shape equivalent to "M10,20h40v50h-40z"
	     | paper.path(Raphael.fullfill("M{x},{y}h{dim.width}v{dim.height}h{dim['negative width']}z", {
	     |     x: 10,
	     |     y: 20,
	     |     dim: {
	     |         width: 40,
	     |         height: 50,
	     |         "negative width": -40
	     |     }
	     | }));
	    \*/
	    R.fullfill = (function () {
	        var tokenRegex = /\{([^\}]+)\}/g,
	            objNotationRegex = /(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g, // matches .xxxxx or ["xxxxx"] to run over object properties
	            replacer = function (all, key, obj) {
	                var res = obj;
	                key.replace(objNotationRegex, function (all, name, quote, quotedName, isFunc) {
	                    name = name || quotedName;
	                    if (res) {
	                        if (name in res) {
	                            res = res[name];
	                        }
	                        typeof res == "function" && isFunc && (res = res());
	                    }
	                });
	                res = (res == null || res == obj ? all : res) + "";
	                return res;
	            };
	        return function (str, obj) {
	            return String(str).replace(tokenRegex, function (all, key) {
	                return replacer(all, key, obj);
	            });
	        };
	    })();
	    /*\
	     * Raphael.ninja
	     [ method ]
	     **
	     * If you want to leave no trace of Raphal (Well, Raphal creates only one global variable `Raphael`, but anyway.) You can use `ninja` method.
	     * Beware, that in this case plugins could stop working, because they are depending on global variable existence.
	     **
	     = (object) Raphael object
	     > Usage
	     | (function (local_raphael) {
	     |     var paper = local_raphael(10, 10, 320, 200);
	     |     
	     | })(Raphael.ninja());
	    \*/
	    R.ninja = function () {
	        if (oldRaphael.was) {
	            g.win.Raphael = oldRaphael.is;
	        } else {
	            // IE8 raises an error when deleting window property
	            window.Raphael = undefined;
	            try {
	                delete window.Raphael;
	            } catch(e) {}
	        }
	        return R;
	    };
	    /*\
	     * Raphael.st
	     [ property (object) ]
	     **
	     * You can add your own method to elements and sets. It is wise to add a set method for each element method
	     * you added, so you will be able to call the same method on sets too.
	     **
	     * See also @Raphael.el.
	     > Usage
	     | Raphael.el.red = function () {
	     |     this.attr({fill: "#f00"});
	     | };
	     | Raphael.st.red = function () {
	     |     this.forEach(function (el) {
	     |         el.red();
	     |     });
	     | };
	     | // then use it
	     | paper.set(paper.circle(100, 100, 20), paper.circle(110, 100, 20)).red();
	    \*/
	    R.st = setproto;

	    eve.on("raphael.DOMload", function () {
	        loaded = true;
	    });

	    // Firefox <3.6 fix: http://webreflection.blogspot.com/2009/11/195-chars-to-help-lazy-loading.html
	    (function (doc, loaded, f) {
	        if (doc.readyState == null && doc.addEventListener){
	            doc.addEventListener(loaded, f = function () {
	                doc.removeEventListener(loaded, f, false);
	                doc.readyState = "complete";
	            }, false);
	            doc.readyState = "loading";
	        }
	        function isLoaded() {
	            (/in/).test(doc.readyState) ? setTimeout(isLoaded, 9) : R.eve("raphael.DOMload");
	        }
	        isLoaded();
	    })(document, "DOMContentLoaded");

	    return R;
	}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));


/***/ },
/* 2 */
/***/ function(module, exports, __webpack_require__) {

	var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;// Copyright (c) 2013 Adobe Systems Incorporated. All rights reserved.
	// 
	// Licensed under the Apache License, Version 2.0 (the "License");
	// you may not use this file except in compliance with the License.
	// You may obtain a copy of the License at
	// 
	// http://www.apache.org/licenses/LICENSE-2.0
	// 
	// Unless required by applicable law or agreed to in writing, software
	// distributed under the License is distributed on an "AS IS" BASIS,
	// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	// See the License for the specific language governing permissions and
	// limitations under the License.
	//  \\
	//  Eve 0.4.2 - JavaScript Events Library                       \\
	//  \\
	//  Author Dmitry Baranovskiy (http://dmitry.baranovskiy.com/)  \\
	//  \\

	(function (glob) {
	    var version = "0.4.2",
	        has = "hasOwnProperty",
	        separator = /[\.\/]/,
	        wildcard = "*",
	        fun = function () {},
	        numsort = function (a, b) {
	            return a - b;
	        },
	        current_event,
	        stop,
	        events = {n: {}},
	    /*\
	     * eve
	     [ method ]

	     * Fires event with given `name`, given scope and other parameters.

	     > Arguments

	     - name (string) name of the *event*, dot (`.`) or slash (`/`) separated
	     - scope (object) context for the event handlers
	     - varargs (...) the rest of arguments will be sent to event handlers

	     = (object) array of returned values from the listeners
	    \*/
	        eve = function (name, scope) {
				name = String(name);
	            var e = events,
	                oldstop = stop,
	                args = Array.prototype.slice.call(arguments, 2),
	                listeners = eve.listeners(name),
	                z = 0,
	                f = false,
	                l,
	                indexed = [],
	                queue = {},
	                out = [],
	                ce = current_event,
	                errors = [];
	            current_event = name;
	            stop = 0;
	            for (var i = 0, ii = listeners.length; i < ii; i++) if ("zIndex" in listeners[i]) {
	                indexed.push(listeners[i].zIndex);
	                if (listeners[i].zIndex < 0) {
	                    queue[listeners[i].zIndex] = listeners[i];
	                }
	            }
	            indexed.sort(numsort);
	            while (indexed[z] < 0) {
	                l = queue[indexed[z++]];
	                out.push(l.apply(scope, args));
	                if (stop) {
	                    stop = oldstop;
	                    return out;
	                }
	            }
	            for (i = 0; i < ii; i++) {
	                l = listeners[i];
	                if ("zIndex" in l) {
	                    if (l.zIndex == indexed[z]) {
	                        out.push(l.apply(scope, args));
	                        if (stop) {
	                            break;
	                        }
	                        do {
	                            z++;
	                            l = queue[indexed[z]];
	                            l && out.push(l.apply(scope, args));
	                            if (stop) {
	                                break;
	                            }
	                        } while (l)
	                    } else {
	                        queue[l.zIndex] = l;
	                    }
	                } else {
	                    out.push(l.apply(scope, args));
	                    if (stop) {
	                        break;
	                    }
	                }
	            }
	            stop = oldstop;
	            current_event = ce;
	            return out.length ? out : null;
	        };
			// Undocumented. Debug only.
			eve._events = events;
	    /*\
	     * eve.listeners
	     [ method ]

	     * Internal method which gives you array of all event handlers that will be triggered by the given `name`.

	     > Arguments

	     - name (string) name of the event, dot (`.`) or slash (`/`) separated

	     = (array) array of event handlers
	    \*/
	    eve.listeners = function (name) {
	        var names = name.split(separator),
	            e = events,
	            item,
	            items,
	            k,
	            i,
	            ii,
	            j,
	            jj,
	            nes,
	            es = [e],
	            out = [];
	        for (i = 0, ii = names.length; i < ii; i++) {
	            nes = [];
	            for (j = 0, jj = es.length; j < jj; j++) {
	                e = es[j].n;
	                items = [e[names[i]], e[wildcard]];
	                k = 2;
	                while (k--) {
	                    item = items[k];
	                    if (item) {
	                        nes.push(item);
	                        out = out.concat(item.f || []);
	                    }
	                }
	            }
	            es = nes;
	        }
	        return out;
	    };
	    
	    /*\
	     * eve.on
	     [ method ]
	     **
	     * Binds given event handler with a given name. You can use wildcards `*` for the names:
	     | eve.on("*.under.*", f);
	     | eve("mouse.under.floor"); // triggers f
	     * Use @eve to trigger the listener.
	     **
	     > Arguments
	     **
	     - name (string) name of the event, dot (`.`) or slash (`/`) separated, with optional wildcards
	     - f (function) event handler function
	     **
	     = (function) returned function accepts a single numeric parameter that represents z-index of the handler. It is an optional feature and only used when you need to ensure that some subset of handlers will be invoked in a given order, despite of the order of assignment. 
	     > Example:
	     | eve.on("mouse", eatIt)(2);
	     | eve.on("mouse", scream);
	     | eve.on("mouse", catchIt)(1);
	     * This will ensure that `catchIt()` function will be called before `eatIt()`.
		 *
	     * If you want to put your handler before non-indexed handlers, specify a negative value.
	     * Note: I assume most of the time you dont need to worry about z-index, but its nice to have this feature just in case.
	    \*/
	    eve.on = function (name, f) {
			name = String(name);
			if (typeof f != "function") {
				return function () {};
			}
	        var names = name.split(separator),
	            e = events;
	        for (var i = 0, ii = names.length; i < ii; i++) {
	            e = e.n;
	            e = e.hasOwnProperty(names[i]) && e[names[i]] || (e[names[i]] = {n: {}});
	        }
	        e.f = e.f || [];
	        for (i = 0, ii = e.f.length; i < ii; i++) if (e.f[i] == f) {
	            return fun;
	        }
	        e.f.push(f);
	        return function (zIndex) {
	            if (+zIndex == +zIndex) {
	                f.zIndex = +zIndex;
	            }
	        };
	    };
	    /*\
	     * eve.f
	     [ method ]
	     **
	     * Returns function that will fire given event with optional arguments.
		 * Arguments that will be passed to the result function will be also
		 * concated to the list of final arguments.
	 	 | el.onclick = eve.f("click", 1, 2);
	 	 | eve.on("click", function (a, b, c) {
	 	 |     console.log(a, b, c); // 1, 2, [event object]
	 	 | });
	     > Arguments
		 - event (string) event name
		 - varargs () and any other arguments
		 = (function) possible event handler function
	    \*/
		eve.f = function (event) {
			var attrs = [].slice.call(arguments, 1);
			return function () {
				eve.apply(null, [event, null].concat(attrs).concat([].slice.call(arguments, 0)));
			};
		};
	    /*\
	     * eve.stop
	     [ method ]
	     **
	     * Is used inside an event handler to stop the event, preventing any subsequent listeners from firing.
	    \*/
	    eve.stop = function () {
	        stop = 1;
	    };
	    /*\
	     * eve.nt
	     [ method ]
	     **
	     * Could be used inside event handler to figure out actual name of the event.
	     **
	     > Arguments
	     **
	     - subname (string) #optional subname of the event
	     **
	     = (string) name of the event, if `subname` is not specified
	     * or
	     = (boolean) `true`, if current events name contains `subname`
	    \*/
	    eve.nt = function (subname) {
	        if (subname) {
	            return new RegExp("(?:\\.|\\/|^)" + subname + "(?:\\.|\\/|$)").test(current_event);
	        }
	        return current_event;
	    };
	    /*\
	     * eve.nts
	     [ method ]
	     **
	     * Could be used inside event handler to figure out actual name of the event.
	     **
	     **
	     = (array) names of the event
	    \*/
	    eve.nts = function () {
	        return current_event.split(separator);
	    };
	    /*\
	     * eve.off
	     [ method ]
	     **
	     * Removes given function from the list of event listeners assigned to given name.
		 * If no arguments specified all the events will be cleared.
	     **
	     > Arguments
	     **
	     - name (string) name of the event, dot (`.`) or slash (`/`) separated, with optional wildcards
	     - f (function) event handler function
	    \*/
	    /*\
	     * eve.unbind
	     [ method ]
	     **
	     * See @eve.off
	    \*/
	    eve.off = eve.unbind = function (name, f) {
			if (!name) {
			    eve._events = events = {n: {}};
				return;
			}
	        var names = name.split(separator),
	            e,
	            key,
	            splice,
	            i, ii, j, jj,
	            cur = [events];
	        for (i = 0, ii = names.length; i < ii; i++) {
	            for (j = 0; j < cur.length; j += splice.length - 2) {
	                splice = [j, 1];
	                e = cur[j].n;
	                if (names[i] != wildcard) {
	                    if (e[names[i]]) {
	                        splice.push(e[names[i]]);
	                    }
	                } else {
	                    for (key in e) if (e[has](key)) {
	                        splice.push(e[key]);
	                    }
	                }
	                cur.splice.apply(cur, splice);
	            }
	        }
	        for (i = 0, ii = cur.length; i < ii; i++) {
	            e = cur[i];
	            while (e.n) {
	                if (f) {
	                    if (e.f) {
	                        for (j = 0, jj = e.f.length; j < jj; j++) if (e.f[j] == f) {
	                            e.f.splice(j, 1);
	                            break;
	                        }
	                        !e.f.length && delete e.f;
	                    }
	                    for (key in e.n) if (e.n[has](key) && e.n[key].f) {
	                        var funcs = e.n[key].f;
	                        for (j = 0, jj = funcs.length; j < jj; j++) if (funcs[j] == f) {
	                            funcs.splice(j, 1);
	                            break;
	                        }
	                        !funcs.length && delete e.n[key].f;
	                    }
	                } else {
	                    delete e.f;
	                    for (key in e.n) if (e.n[has](key) && e.n[key].f) {
	                        delete e.n[key].f;
	                    }
	                }
	                e = e.n;
	            }
	        }
	    };
	    /*\
	     * eve.once
	     [ method ]
	     **
	     * Binds given event handler with a given name to only run once then unbind itself.
	     | eve.once("login", f);
	     | eve("login"); // triggers f
	     | eve("login"); // no listeners
	     * Use @eve to trigger the listener.
	     **
	     > Arguments
	     **
	     - name (string) name of the event, dot (`.`) or slash (`/`) separated, with optional wildcards
	     - f (function) event handler function
	     **
	     = (function) same return function as @eve.on
	    \*/
	    eve.once = function (name, f) {
	        var f2 = function () {
	            eve.unbind(name, f2);
	            return f.apply(this, arguments);
	        };
	        return eve.on(name, f2);
	    };
	    /*\
	     * eve.version
	     [ property (string) ]
	     **
	     * Current version of the library.
	    \*/
	    eve.version = version;
	    eve.toString = function () {
	        return "You are running Eve " + version;
	    };
	    (typeof module != "undefined" && module.exports) ? (module.exports = eve) : ( true ? (!(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_RESULT__ = function() { return eve; }.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__))) : (glob.eve = eve));
	})(this);


/***/ },
/* 3 */
/***/ function(module, exports, __webpack_require__) {

	var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__(1)], __WEBPACK_AMD_DEFINE_RESULT__ = function(R) {
	    if (R && !R.svg) {
	        return;
	    }

	    var has = "hasOwnProperty",
	        Str = String,
	        toFloat = parseFloat,
	        toInt = parseInt,
	        math = Math,
	        mmax = math.max,
	        abs = math.abs,
	        pow = math.pow,
	        separator = /[, ]+/,
	        eve = R.eve,
	        E = "",
	        S = " ";
	    var xlink = "http://www.w3.org/1999/xlink",
	        markers = {
	            block: "M5,0 0,2.5 5,5z",
	            classic: "M5,0 0,2.5 5,5 3.5,3 3.5,2z",
	            diamond: "M2.5,0 5,2.5 2.5,5 0,2.5z",
	            open: "M6,1 1,3.5 6,6",
	            oval: "M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"
	        },
	        markerCounter = {};
	    R.toString = function () {
	        return  "Your browser supports SVG.\nYou are running Rapha\xebl " + this.version;
	    };
	    var $ = function (el, attr) {
	        if (attr) {
	            if (typeof el == "string") {
	                el = $(el);
	            }
	            for (var key in attr) if (attr[has](key)) {
	                if (key.substring(0, 6) == "xlink:") {
	                    el.setAttributeNS(xlink, key.substring(6), Str(attr[key]));
	                } else {
	                    el.setAttribute(key, Str(attr[key]));
	                }
	            }
	        } else {
	            el = R._g.doc.createElementNS("http://www.w3.org/2000/svg", el);
	            el.style && (el.style.webkitTapHighlightColor = "rgba(0,0,0,0)");
	        }
	        return el;
	    },
	    addGradientFill = function (element, gradient) {
	        var type = "linear",
	            id = element.id + gradient,
	            fx = .5, fy = .5,
	            o = element.node,
	            SVG = element.paper,
	            s = o.style,
	            el = R._g.doc.getElementById(id);
	        if (!el) {
	            gradient = Str(gradient).replace(R._radial_gradient, function (all, _fx, _fy) {
	                type = "radial";
	                if (_fx && _fy) {
	                    fx = toFloat(_fx);
	                    fy = toFloat(_fy);
	                    var dir = ((fy > .5) * 2 - 1);
	                    pow(fx - .5, 2) + pow(fy - .5, 2) > .25 &&
	                        (fy = math.sqrt(.25 - pow(fx - .5, 2)) * dir + .5) &&
	                        fy != .5 &&
	                        (fy = fy.toFixed(5) - 1e-5 * dir);
	                }
	                return E;
	            });
	            gradient = gradient.split(/\s*\-\s*/);
	            if (type == "linear") {
	                var angle = gradient.shift();
	                angle = -toFloat(angle);
	                if (isNaN(angle)) {
	                    return null;
	                }
	                var vector = [0, 0, math.cos(R.rad(angle)), math.sin(R.rad(angle))],
	                    max = 1 / (mmax(abs(vector[2]), abs(vector[3])) || 1);
	                vector[2] *= max;
	                vector[3] *= max;
	                if (vector[2] < 0) {
	                    vector[0] = -vector[2];
	                    vector[2] = 0;
	                }
	                if (vector[3] < 0) {
	                    vector[1] = -vector[3];
	                    vector[3] = 0;
	                }
	            }
	            var dots = R._parseDots(gradient);
	            if (!dots) {
	                return null;
	            }
	            id = id.replace(/[\(\)\s,\xb0#]/g, "_");

	            if (element.gradient && id != element.gradient.id) {
	                SVG.defs.removeChild(element.gradient);
	                delete element.gradient;
	            }

	            if (!element.gradient) {
	                el = $(type + "Gradient", {id: id});
	                element.gradient = el;
	                $(el, type == "radial" ? {
	                    fx: fx,
	                    fy: fy
	                } : {
	                    x1: vector[0],
	                    y1: vector[1],
	                    x2: vector[2],
	                    y2: vector[3],
	                    gradientTransform: element.matrix.invert()
	                });
	                SVG.defs.appendChild(el);
	                for (var i = 0, ii = dots.length; i < ii; i++) {
	                    el.appendChild($("stop", {
	                        offset: dots[i].offset ? dots[i].offset : i ? "100%" : "0%",
	                        "stop-color": dots[i].color || "#fff",
	                        "stop-opacity": isFinite(dots[i].opacity) ? dots[i].opacity : 1
	                    }));
	                }
	            }
	        }
	        $(o, {
	            fill: fillurl(id),
	            opacity: 1,
	            "fill-opacity": 1
	        });
	        s.fill = E;
	        s.opacity = 1;
	        s.fillOpacity = 1;
	        return 1;
	    },
	    isIE9or10 = function () {
	      var mode = document.documentMode;
	      return mode && (mode === 9 || mode === 10);
	    },
	    fillurl = function (id) {
	      if (isIE9or10()) {
	          return "url('#" + id + "')";
	      }
	      var location = document.location;
	      var locationString = (
	          location.protocol + '//' +
	          location.host +
	          location.pathname +
	          location.search
	      );
	      return "url('" + locationString + "#" + id + "')";
	    },
	    updatePosition = function (o) {
	        var bbox = o.getBBox(1);
	        $(o.pattern, {patternTransform: o.matrix.invert() + " translate(" + bbox.x + "," + bbox.y + ")"});
	    },
	    addArrow = function (o, value, isEnd) {
	        if (o.type == "path") {
	            var values = Str(value).toLowerCase().split("-"),
	                p = o.paper,
	                se = isEnd ? "end" : "start",
	                node = o.node,
	                attrs = o.attrs,
	                stroke = attrs["stroke-width"],
	                i = values.length,
	                type = "classic",
	                from,
	                to,
	                dx,
	                refX,
	                attr,
	                w = 3,
	                h = 3,
	                t = 5;
	            while (i--) {
	                switch (values[i]) {
	                    case "block":
	                    case "classic":
	                    case "oval":
	                    case "diamond":
	                    case "open":
	                    case "none":
	                        type = values[i];
	                        break;
	                    case "wide": h = 5; break;
	                    case "narrow": h = 2; break;
	                    case "long": w = 5; break;
	                    case "short": w = 2; break;
	                }
	            }
	            if (type == "open") {
	                w += 2;
	                h += 2;
	                t += 2;
	                dx = 1;
	                refX = isEnd ? 4 : 1;
	                attr = {
	                    fill: "none",
	                    stroke: attrs.stroke
	                };
	            } else {
	                refX = dx = w / 2;
	                attr = {
	                    fill: attrs.stroke,
	                    stroke: "none"
	                };
	            }
	            if (o._.arrows) {
	                if (isEnd) {
	                    o._.arrows.endPath && markerCounter[o._.arrows.endPath]--;
	                    o._.arrows.endMarker && markerCounter[o._.arrows.endMarker]--;
	                } else {
	                    o._.arrows.startPath && markerCounter[o._.arrows.startPath]--;
	                    o._.arrows.startMarker && markerCounter[o._.arrows.startMarker]--;
	                }
	            } else {
	                o._.arrows = {};
	            }
	            if (type != "none") {
	                var pathId = "raphael-marker-" + type,
	                    markerId = "raphael-marker-" + se + type + w + h + "-obj" + o.id;
	                if (!R._g.doc.getElementById(pathId)) {
	                    p.defs.appendChild($($("path"), {
	                        "stroke-linecap": "round",
	                        d: markers[type],
	                        id: pathId
	                    }));
	                    markerCounter[pathId] = 1;
	                } else {
	                    markerCounter[pathId]++;
	                }
	                var marker = R._g.doc.getElementById(markerId),
	                    use;
	                if (!marker) {
	                    marker = $($("marker"), {
	                        id: markerId,
	                        markerHeight: h,
	                        markerWidth: w,
	                        orient: "auto",
	                        refX: refX,
	                        refY: h / 2
	                    });
	                    use = $($("use"), {
	                        "xlink:href": "#" + pathId,
	                        transform: (isEnd ? "rotate(180 " + w / 2 + " " + h / 2 + ") " : E) + "scale(" + w / t + "," + h / t + ")",
	                        "stroke-width": (1 / ((w / t + h / t) / 2)).toFixed(4)
	                    });
	                    marker.appendChild(use);
	                    p.defs.appendChild(marker);
	                    markerCounter[markerId] = 1;
	                } else {
	                    markerCounter[markerId]++;
	                    use = marker.getElementsByTagName("use")[0];
	                }
	                $(use, attr);
	                var delta = dx * (type != "diamond" && type != "oval");
	                if (isEnd) {
	                    from = o._.arrows.startdx * stroke || 0;
	                    to = R.getTotalLength(attrs.path) - delta * stroke;
	                } else {
	                    from = delta * stroke;
	                    to = R.getTotalLength(attrs.path) - (o._.arrows.enddx * stroke || 0);
	                }
	                attr = {};
	                attr["marker-" + se] = "url(#" + markerId + ")";
	                if (to || from) {
	                    attr.d = R.getSubpath(attrs.path, from, to);
	                }
	                $(node, attr);
	                o._.arrows[se + "Path"] = pathId;
	                o._.arrows[se + "Marker"] = markerId;
	                o._.arrows[se + "dx"] = delta;
	                o._.arrows[se + "Type"] = type;
	                o._.arrows[se + "String"] = value;
	            } else {
	                if (isEnd) {
	                    from = o._.arrows.startdx * stroke || 0;
	                    to = R.getTotalLength(attrs.path) - from;
	                } else {
	                    from = 0;
	                    to = R.getTotalLength(attrs.path) - (o._.arrows.enddx * stroke || 0);
	                }
	                o._.arrows[se + "Path"] && $(node, {d: R.getSubpath(attrs.path, from, to)});
	                delete o._.arrows[se + "Path"];
	                delete o._.arrows[se + "Marker"];
	                delete o._.arrows[se + "dx"];
	                delete o._.arrows[se + "Type"];
	                delete o._.arrows[se + "String"];
	            }
	            for (attr in markerCounter) if (markerCounter[has](attr) && !markerCounter[attr]) {
	                var item = R._g.doc.getElementById(attr);
	                item && item.parentNode.removeChild(item);
	            }
	        }
	    },
	    dasharray = {
	        "-": [3, 1],
	        ".": [1, 1],
	        "-.": [3, 1, 1, 1],
	        "-..": [3, 1, 1, 1, 1, 1],
	        ". ": [1, 3],
	        "- ": [4, 3],
	        "--": [8, 3],
	        "- .": [4, 3, 1, 3],
	        "--.": [8, 3, 1, 3],
	        "--..": [8, 3, 1, 3, 1, 3]
	    },
	    addDashes = function (o, value, params) {
            value =Str(value).replace(/\s+/,'');
	        value = dasharray[value] || (Raphael.svg && !/[^\d,]/.test(value) && value.split(/,/) );
	        if (value) {
	            var width = o.attrs["stroke-width"] || "1",
	                butt = {round: width, square: width, butt: 0}[o.attrs["stroke-linecap"] || params["stroke-linecap"]] || 0,
	                dashes = [],
	                i = value.length;
	            while (i--) {
	                dashes[i] = value[i] * width + ((i % 2) ? 1 : -1) * butt;
	            }
	            $(o.node, {"stroke-dasharray": dashes.join(",")});
	        }
	        else {
	          $(o.node, {"stroke-dasharray": "none"});
	        }
	    },
	    setFillAndStroke = function (o, params) {
	        var node = o.node,
	            attrs = o.attrs,
	            vis = node.style.visibility;
	        node.style.visibility = "hidden";
	        for (var att in params) {
	            if (params[has](att)) {
	                if (!R._availableAttrs[has](att)) {
	                    continue;
	                }
	                var value = params[att];
	                attrs[att] = value;
	                switch (att) {
	                    case "blur":
	                        o.blur(value);
	                        break;
	                    case "title":
	                        var title = node.getElementsByTagName("title");

	                        // Use the existing <title>.
	                        if (title.length && (title = title[0])) {
	                          title.firstChild.nodeValue = value;
	                        } else {
	                          title = $("title");
	                          var val = R._g.doc.createTextNode(value);
	                          title.appendChild(val);
	                          node.appendChild(title);
	                        }
	                        break;
	                    case "href":
	                    case "target":
	                        var pn = node.parentNode;
	                        if (pn.tagName.toLowerCase() != "a") {
	                            var hl = $("a");
	                            pn.insertBefore(hl, node);
	                            hl.appendChild(node);
	                            pn = hl;
	                        }
	                        if (att == "target") {
	                            pn.setAttributeNS(xlink, "show", value == "blank" ? "new" : value);
	                        } else {
	                            pn.setAttributeNS(xlink, att, value);
	                        }
	                        break;
	                    case "cursor":
	                        node.style.cursor = value;
	                        break;
	                    case "transform":
	                        o.transform(value);
	                        break;
	                    case "arrow-start":
	                        addArrow(o, value);
	                        break;
	                    case "arrow-end":
	                        addArrow(o, value, 1);
	                        break;
	                    case "clip-rect":
	                        var rect = Str(value).split(separator);
	                        if (rect.length == 4) {
	                            o.clip && o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);
	                            var el = $("clipPath"),
	                                rc = $("rect");
	                            el.id = R.createUUID();
	                            $(rc, {
	                                x: rect[0],
	                                y: rect[1],
	                                width: rect[2],
	                                height: rect[3]
	                            });
	                            el.appendChild(rc);
	                            o.paper.defs.appendChild(el);
	                            $(node, {"clip-path": "url(#" + el.id + ")"});
	                            o.clip = rc;
	                        }
	                        if (!value) {
	                            var path = node.getAttribute("clip-path");
	                            if (path) {
	                                var clip = R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g, E));
	                                clip && clip.parentNode.removeChild(clip);
	                                $(node, {"clip-path": E});
	                                delete o.clip;
	                            }
	                        }
	                    break;
	                    case "path":
	                        if (o.type == "path") {
	                            $(node, {d: value ? attrs.path = R._pathToAbsolute(value) : "M0,0"});
	                            o._.dirty = 1;
	                            if (o._.arrows) {
	                                "startString" in o._.arrows && addArrow(o, o._.arrows.startString);
	                                "endString" in o._.arrows && addArrow(o, o._.arrows.endString, 1);
	                            }
	                        }
	                        break;
	                    case "width":
	                        node.setAttribute(att, value);
	                        o._.dirty = 1;
	                        if (attrs.fx) {
	                            att = "x";
	                            value = attrs.x;
	                        } else {
	                            break;
	                        }
	                    case "x":
	                        if (attrs.fx) {
	                            value = -attrs.x - (attrs.width || 0);
	                        }
	                    case "rx":
	                        if (att == "rx" && o.type == "rect") {
	                            break;
	                        }
	                    case "cx":
	                        node.setAttribute(att, value);
	                        o.pattern && updatePosition(o);
	                        o._.dirty = 1;
	                        break;
	                    case "height":
	                        node.setAttribute(att, value);
	                        o._.dirty = 1;
	                        if (attrs.fy) {
	                            att = "y";
	                            value = attrs.y;
	                        } else {
	                            break;
	                        }
	                    case "y":
	                        if (attrs.fy) {
	                            value = -attrs.y - (attrs.height || 0);
	                        }
	                    case "ry":
	                        if (att == "ry" && o.type == "rect") {
	                            break;
	                        }
	                    case "cy":
	                        node.setAttribute(att, value);
	                        o.pattern && updatePosition(o);
	                        o._.dirty = 1;
	                        break;
	                    case "r":
	                        if (o.type == "rect") {
	                            $(node, {rx: value, ry: value});
	                        } else {
	                            node.setAttribute(att, value);
	                        }
	                        o._.dirty = 1;
	                        break;
	                    case "src":
	                        if (o.type == "image") {
	                            node.setAttributeNS(xlink, "href", value);
	                        }
	                        break;
	                    case "stroke-width":
	                        if (o._.sx != 1 || o._.sy != 1) {
	                            value /= mmax(abs(o._.sx), abs(o._.sy)) || 1;
	                        }
	                        node.setAttribute(att, value);
	                        if (attrs["stroke-dasharray"]) {
	                            addDashes(o, attrs["stroke-dasharray"], params);
	                        }
	                        if (o._.arrows) {
	                            "startString" in o._.arrows && addArrow(o, o._.arrows.startString);
	                            "endString" in o._.arrows && addArrow(o, o._.arrows.endString, 1);
	                        }
	                        break;
	                    case "stroke-dasharray":
	                        addDashes(o, value, params);
	                        break;
                        // not for vml
	                    case "stroke-dashoffset":
                            if(Raphael.svg)node.setAttribute(att, value);
	                        break;
	                    case "fill":
	                        var isURL = Str(value).match(R._ISURL);
	                        if (isURL) {
	                            el = $("pattern");
	                            var ig = $("image");
	                            el.id = R.createUUID();
	                            $(el, {x: 0, y: 0, patternUnits: "userSpaceOnUse", height: 1, width: 1});
	                            $(ig, {x: 0, y: 0, "xlink:href": isURL[1]});
	                            el.appendChild(ig);

	                            (function (el) {
	                                R._preload(isURL[1], function () {
	                                    var w = this.offsetWidth,
	                                        h = this.offsetHeight;
	                                    $(el, {width: w, height: h});
	                                    $(ig, {width: w, height: h});
	                                });
	                            })(el);
	                            o.paper.defs.appendChild(el);
	                            $(node, {fill: "url(#" + el.id + ")"});
	                            o.pattern = el;
	                            o.pattern && updatePosition(o);
	                            break;
	                        }
	                        var clr = R.getRGB(value);
	                        if (!clr.error) {
	                            delete params.gradient;
	                            delete attrs.gradient;
	                            !R.is(attrs.opacity, "undefined") &&
	                                R.is(params.opacity, "undefined") &&
	                                $(node, {opacity: attrs.opacity});
	                            !R.is(attrs["fill-opacity"], "undefined") &&
	                                R.is(params["fill-opacity"], "undefined") &&
	                                $(node, {"fill-opacity": attrs["fill-opacity"]});
	                        } else if ((o.type == "circle" || o.type == "ellipse" || Str(value).charAt() != "r") && addGradientFill(o, value)) {
	                            if ("opacity" in attrs || "fill-opacity" in attrs) {
	                                var gradient = R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g, E));
	                                if (gradient) {
	                                    var stops = gradient.getElementsByTagName("stop");
	                                    $(stops[stops.length - 1], {"stop-opacity": ("opacity" in attrs ? attrs.opacity : 1) * ("fill-opacity" in attrs ? attrs["fill-opacity"] : 1)});
	                                }
	                            }
	                            attrs.gradient = value;
	                            attrs.fill = "none";
	                            break;
	                        }
	                        clr[has]("opacity") && $(node, {"fill-opacity": clr.opacity > 1 ? clr.opacity / 100 : clr.opacity});
	                    case "stroke":
	                        clr = R.getRGB(value);
	                        node.setAttribute(att, clr.hex);
	                        att == "stroke" && clr[has]("opacity") && $(node, {"stroke-opacity": clr.opacity > 1 ? clr.opacity / 100 : clr.opacity});
	                        if (att == "stroke" && o._.arrows) {
	                            "startString" in o._.arrows && addArrow(o, o._.arrows.startString);
	                            "endString" in o._.arrows && addArrow(o, o._.arrows.endString, 1);
	                        }
	                        break;
	                    case "gradient":
	                        (o.type == "circle" || o.type == "ellipse" || Str(value).charAt() != "r") && addGradientFill(o, value);
	                        break;
	                    case "opacity":
	                        if (attrs.gradient && !attrs[has]("stroke-opacity")) {
	                            $(node, {"stroke-opacity": value > 1 ? value / 100 : value});
	                        }
	                        // fall
	                    case "fill-opacity":
	                        if (attrs.gradient) {
	                            gradient = R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g, E));
	                            if (gradient) {
	                                stops = gradient.getElementsByTagName("stop");
	                                $(stops[stops.length - 1], {"stop-opacity": value});
	                            }
	                            break;
	                        }
	                    default:
	                        att == "font-size" && (value = toInt(value, 10) + "px");
	                        var cssrule = att.replace(/(\-.)/g, function (w) {
	                            return w.substring(1).toUpperCase();
	                        });
	                        node.style[cssrule] = value;
	                        o._.dirty = 1;
	                        node.setAttribute(att, value);
	                        break;
	                }
	            }
	        }

	        tuneText(o, params);
	        node.style.visibility = vis;
	    },
	    leading = 1.2,
	    tuneText = function (el, params) {
	        if (el.type != "text" || !(params[has]("text") || params[has]("font") || params[has]("font-size") || params[has]("x") || params[has]("y"))) {
	            return;
	        }
	        var a = el.attrs,
	            node = el.node,
	            fontSize = node.firstChild ? toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild, E).getPropertyValue("font-size"), 10) : 10;

	        if (params[has]("text")) {
	            a.text = params.text;
	            while (node.firstChild) {
	                node.removeChild(node.firstChild);
	            }
	            var texts = Str(params.text).split("\n"),
	                tspans = [],
	                tspan;
	            for (var i = 0, ii = texts.length; i < ii; i++) {
	                tspan = $("tspan");
	                i && $(tspan, {dy: fontSize * leading, x: a.x});
	                tspan.appendChild(R._g.doc.createTextNode(texts[i]));
	                node.appendChild(tspan);
	                tspans[i] = tspan;
	            }
	        } else {
	            tspans = node.getElementsByTagName("tspan");
	            for (i = 0, ii = tspans.length; i < ii; i++) if (i) {
	                $(tspans[i], {dy: fontSize * leading, x: a.x});
	            } else {
	                $(tspans[0], {dy: 0});
	            }
	        }
	        $(node, {x: a.x, y: a.y});
	        el._.dirty = 1;
	        var bb = el._getBBox(),
	            dif = a.y - (bb.y + bb.height / 2);
	        dif && R.is(dif, "finite") && $(tspans[0], {dy: dif});
	    },
	    getRealNode = function (node) {
	        if (node.parentNode && node.parentNode.tagName.toLowerCase() === "a") {
	            return node.parentNode;
	        } else {
	            return node;
	        }
	    },
	    Element = function (node, svg) {
	        var X = 0,
	            Y = 0;
	        /*\
	         * Element.node
	         [ property (object) ]
	         **
	         * Gives you a reference to the DOM object, so you can assign event handlers or just mess around.
	         **
	         * Note: Dont mess with it.
	         > Usage
	         | // draw a circle at coordinate 10,10 with radius of 10
	         | var c = paper.circle(10, 10, 10);
	         | c.node.onclick = function () {
	         |     c.attr("fill", "red");
	         | };
	        \*/
	        this[0] = this.node = node;
	        /*\
	         * Element.raphael
	         [ property (object) ]
	         **
	         * Internal reference to @Raphael object. In case it is not available.
	         > Usage
	         | Raphael.el.red = function () {
	         |     var hsb = this.paper.raphael.rgb2hsb(this.attr("fill"));
	         |     hsb.h = 1;
	         |     this.attr({fill: this.paper.raphael.hsb2rgb(hsb).hex});
	         | }
	        \*/
	        node.raphael = true;
	        /*\
	         * Element.id
	         [ property (number) ]
	         **
	         * Unique id of the element. Especially useful when you want to listen to events of the element,
	         * because all events are fired in format `<module>.<action>.<id>`. Also useful for @Paper.getById method.
	        \*/
	        this.id = guid();
	        node.raphaelid = this.id;

	        /**
	        * Method that returns a 5 letter/digit id, enough for 36^5 = 60466176 elements
	        * @returns {string} id
	        */
	        function guid() {
	            return ("0000" + (Math.random()*Math.pow(36,5) << 0).toString(36)).slice(-5);
	        }

	        this.matrix = R.matrix();
	        this.realPath = null;
	        /*\
	         * Element.paper
	         [ property (object) ]
	         **
	         * Internal reference to paper where object drawn. Mainly for use in plugins and element extensions.
	         > Usage
	         | Raphael.el.cross = function () {
	         |     this.attr({fill: "red"});
	         |     this.paper.path("M10,10L50,50M50,10L10,50")
	         |         .attr({stroke: "red"});
	         | }
	        \*/
	        this.paper = svg;
	        this.attrs = this.attrs || {};
	        this._ = {
	            transform: [],
	            sx: 1,
	            sy: 1,
	            deg: 0,
	            dx: 0,
	            dy: 0,
	            dirty: 1
	        };
	        !svg.bottom && (svg.bottom = this);
	        /*\
	         * Element.prev
	         [ property (object) ]
	         **
	         * Reference to the previous element in the hierarchy.
	        \*/
	        this.prev = svg.top;
	        svg.top && (svg.top.next = this);
	        svg.top = this;
	        /*\
	         * Element.next
	         [ property (object) ]
	         **
	         * Reference to the next element in the hierarchy.
	        \*/
	        this.next = null;
	    },
	    elproto = R.el;

	    Element.prototype = elproto;
	    elproto.constructor = Element;

	    R._engine.path = function (pathString, SVG) {
	        var el = $("path");
	        SVG.canvas && SVG.canvas.appendChild(el);
	        var p = new Element(el, SVG);
	        p.type = "path";
	        setFillAndStroke(p, {
	            fill: "none",
	            stroke: "#000",
	            path: pathString
	        });
	        return p;
	    };
	    /*\
	     * Element.rotate
	     [ method ]
	     **
	     * Deprecated! Use @Element.transform instead.
	     * Adds rotation by given angle around given point to the list of
	     * transformations of the element.
	     > Parameters
	     - deg (number) angle in degrees
	     - cx (number) #optional x coordinate of the centre of rotation
	     - cy (number) #optional y coordinate of the centre of rotation
	     * If cx & cy arent specified centre of the shape is used as a point of rotation.
	     = (object) @Element
	    \*/
	    elproto.rotate = function (deg, cx, cy) {
	        if (this.removed) {
	            return this;
	        }
	        deg = Str(deg).split(separator);
	        if (deg.length - 1) {
	            cx = toFloat(deg[1]);
	            cy = toFloat(deg[2]);
	        }
	        deg = toFloat(deg[0]);
	        (cy == null) && (cx = cy);
	        if (cx == null || cy == null) {
	            var bbox = this.getBBox(1);
	            cx = bbox.x + bbox.width / 2;
	            cy = bbox.y + bbox.height / 2;
	        }
	        this.transform(this._.transform.concat([["r", deg, cx, cy]]));
	        return this;
	    };
	    /*\
	     * Element.scale
	     [ method ]
	     **
	     * Deprecated! Use @Element.transform instead.
	     * Adds scale by given amount relative to given point to the list of
	     * transformations of the element.
	     > Parameters
	     - sx (number) horisontal scale amount
	     - sy (number) vertical scale amount
	     - cx (number) #optional x coordinate of the centre of scale
	     - cy (number) #optional y coordinate of the centre of scale
	     * If cx & cy arent specified centre of the shape is used instead.
	     = (object) @Element
	    \*/
	    elproto.scale = function (sx, sy, cx, cy) {
	        if (this.removed) {
	            return this;
	        }
	        sx = Str(sx).split(separator);
	        if (sx.length - 1) {
	            sy = toFloat(sx[1]);
	            cx = toFloat(sx[2]);
	            cy = toFloat(sx[3]);
	        }
	        sx = toFloat(sx[0]);
	        (sy == null) && (sy = sx);
	        (cy == null) && (cx = cy);
	        if (cx == null || cy == null) {
	            var bbox = this.getBBox(1);
	        }
	        cx = cx == null ? bbox.x + bbox.width / 2 : cx;
	        cy = cy == null ? bbox.y + bbox.height / 2 : cy;
	        this.transform(this._.transform.concat([["s", sx, sy, cx, cy]]));
	        return this;
	    };
	    /*\
	     * Element.translate
	     [ method ]
	     **
	     * Deprecated! Use @Element.transform instead.
	     * Adds translation by given amount to the list of transformations of the element.
	     > Parameters
	     - dx (number) horisontal shift
	     - dy (number) vertical shift
	     = (object) @Element
	    \*/
	    elproto.translate = function (dx, dy) {
	        if (this.removed) {
	            return this;
	        }
	        dx = Str(dx).split(separator);
	        if (dx.length - 1) {
	            dy = toFloat(dx[1]);
	        }
	        dx = toFloat(dx[0]) || 0;
	        dy = +dy || 0;
	        this.transform(this._.transform.concat([["t", dx, dy]]));
	        return this;
	    };
	    /*\
	     * Element.transform
	     [ method ]
	     **
	     * Adds transformation to the element which is separate to other attributes,
	     * i.e. translation doesnt change `x` or `y` of the rectange. The format
	     * of transformation string is similar to the path string syntax:
	     | "t100,100r30,100,100s2,2,100,100r45s1.5"
	     * Each letter is a command. There are four commands: `t` is for translate, `r` is for rotate, `s` is for
	     * scale and `m` is for matrix.
	     *
	     * There are also alternative absolute translation, rotation and scale: `T`, `R` and `S`. They will not take previous transformation into account. For example, `...T100,0` will always move element 100 px horisontally, while `...t100,0` could move it vertically if there is `r90` before. Just compare results of `r90t100,0` and `r90T100,0`.
	     *
	     * So, the example line above could be read like translate by 100, 100; rotate 30 around 100, 100; scale twice around 100, 100;
	     * rotate 45 around centre; scale 1.5 times relative to centre. As you can see rotate and scale commands have origin
	     * coordinates as optional parameters, the default is the centre point of the element.
	     * Matrix accepts six parameters.
	     > Usage
	     | var el = paper.rect(10, 20, 300, 200);
	     | // translate 100, 100, rotate 45, translate -100, 0
	     | el.transform("t100,100r45t-100,0");
	     | // if you want you can append or prepend transformations
	     | el.transform("...t50,50");
	     | el.transform("s2...");
	     | // or even wrap
	     | el.transform("t50,50...t-50-50");
	     | // to reset transformation call method with empty string
	     | el.transform("");
	     | // to get current value call it without parameters
	     | console.log(el.transform());
	     > Parameters
	     - tstr (string) #optional transformation string
	     * If tstr isnt specified
	     = (string) current transformation string
	     * else
	     = (object) @Element
	    \*/
	    elproto.transform = function (tstr) {
	        var _ = this._;
	        if (tstr == null) {
	            return _.transform;
	        }
	        R._extractTransform(this, tstr);

	        this.clip && $(this.clip, {transform: this.matrix.invert()});
	        this.pattern && updatePosition(this);
	        this.node && $(this.node, {transform: this.matrix});

	        if (_.sx != 1 || _.sy != 1) {
	            var sw = this.attrs[has]("stroke-width") ? this.attrs["stroke-width"] : 1;
	            this.attr({"stroke-width": sw});
	        }

	        return this;
	    };
	    /*\
	     * Element.hide
	     [ method ]
	     **
	     * Makes element invisible. See @Element.show.
	     = (object) @Element
	    \*/
	    elproto.hide = function () {
	        if(!this.removed) this.node.style.display = "none";
	        return this;
	    };
	    /*\
	     * Element.show
	     [ method ]
	     **
	     * Makes element visible. See @Element.hide.
	     = (object) @Element
	    \*/
	    elproto.show = function () {
	        if(!this.removed) this.node.style.display = "";
	        return this;
	    };
	    /*\
	     * Element.remove
	     [ method ]
	     **
	     * Removes element from the paper.
	    \*/
	    elproto.remove = function () {
	        var node = getRealNode(this.node);
	        if (this.removed || !node.parentNode) {
	            return;
	        }
	        var paper = this.paper;
	        paper.__set__ && paper.__set__.exclude(this);
	        eve.unbind("raphael.*.*." + this.id);
	        if (this.gradient) {
	            paper.defs.removeChild(this.gradient);
	        }
	        R._tear(this, paper);

	        node.parentNode.removeChild(node);

	        // Remove custom data for element
	        this.removeData();

	        for (var i in this) {
	            this[i] = typeof this[i] == "function" ? R._removedFactory(i) : null;
	        }
	        this.removed = true;
	    };
	    elproto._getBBox = function () {
	        if (this.node.style.display == "none") {
	            this.show();
	            var hide = true;
	        }
	        var canvasHidden = false,
	            containerStyle;
	        if (this.paper.canvas.parentElement) {
	          containerStyle = this.paper.canvas.parentElement.style;
	        } //IE10+ can't find parentElement
	        else if (this.paper.canvas.parentNode) {
	          containerStyle = this.paper.canvas.parentNode.style;
	        }

	        if(containerStyle && containerStyle.display == "none") {
	          canvasHidden = true;
	          containerStyle.display = "";
	        }
	        var bbox = {};
	        try {
	            bbox = this.node.getBBox();
	        } catch(e) {
	            // Firefox 3.0.x, 25.0.1 (probably more versions affected) play badly here - possible fix
	            bbox = {
	                x: this.node.clientLeft,
	                y: this.node.clientTop,
	                width: this.node.clientWidth,
	                height: this.node.clientHeight
	            }
	        } finally {
	            bbox = bbox || {};
	            if(canvasHidden){
	              containerStyle.display = "none";
	            }
	        }
	        hide && this.hide();
	        return bbox;
	    };
	    /*\
	     * Element.attr
	     [ method ]
	     **
	     * Sets the attributes of the element.
	     > Parameters
	     - attrName (string) attributes name
	     - value (string) value
	     * or
	     - params (object) object of name/value pairs
	     * or
	     - attrName (string) attributes name
	     * or
	     - attrNames (array) in this case method returns array of current values for given attribute names
	     = (object) @Element if attrsName & value or params are passed in.
	     = (...) value of the attribute if only attrsName is passed in.
	     = (array) array of values of the attribute if attrsNames is passed in.
	     = (object) object of attributes if nothing is passed in.
	     > Possible parameters
	     # <p>Please refer to the <a href="http://www.w3.org/TR/SVG/" title="The W3C Recommendation for the SVG language describes these properties in detail.">SVG specification</a> for an explanation of these parameters.</p>
	     o arrow-end (string) arrowhead on the end of the path. The format for string is `<type>[-<width>[-<length>]]`. Possible types: `classic`, `block`, `open`, `oval`, `diamond`, `none`, width: `wide`, `narrow`, `medium`, length: `long`, `short`, `midium`.
	     o clip-rect (string) comma or space separated values: x, y, width and height
	     o cursor (string) CSS type of the cursor
	     o cx (number) the x-axis coordinate of the center of the circle, or ellipse
	     o cy (number) the y-axis coordinate of the center of the circle, or ellipse
	     o fill (string) colour, gradient or image
	     o fill-opacity (number)
	     o font (string)
	     o font-family (string)
	     o font-size (number) font size in pixels
	     o font-weight (string)
	     o height (number)
	     o href (string) URL, if specified element behaves as hyperlink
	     o opacity (number)
	     o path (string) SVG path string format
	     o r (number) radius of the circle, ellipse or rounded corner on the rect
	     o rx (number) horisontal radius of the ellipse
	     o ry (number) vertical radius of the ellipse
	     o src (string) image URL, only works for @Element.image element
	     o stroke (string) stroke colour
	     o stroke-dasharray (string) [, none, `-`, `.`, `-.`, `-..`, `. `, `- `, `--`, `- .`, `--.`, `--..`]
	     o stroke-linecap (string) [`butt`, `square`, `round`]
	     o stroke-linejoin (string) [`bevel`, `round`, `miter`]
	     o stroke-miterlimit (number)
	     o stroke-opacity (number)
	     o stroke-width (number) stroke width in pixels, default is '1'
	     o target (string) used with href
	     o text (string) contents of the text element. Use `\n` for multiline text
	     o text-anchor (string) [`start`, `middle`, `end`], default is `middle`
	     o title (string) will create tooltip with a given text
	     o transform (string) see @Element.transform
	     o width (number)
	     o x (number)
	     o y (number)
	     > Gradients
	     * Linear gradient format: `angle-colour[-colour[:offset]]*-colour`, example: `90-#fff-#000`  90
	     * gradient from white to black or `0-#fff-#f00:20-#000`  0 gradient from white via red (at 20%) to black.
	     *
	     * radial gradient: `r[(fx, fy)]colour[-colour[:offset]]*-colour`, example: `r#fff-#000` 
	     * gradient from white to black or `r(0.25, 0.75)#fff-#000`  gradient from white to black with focus point
	     * at 0.25, 0.75. Focus point coordinates are in 0..1 range. Radial gradients can only be applied to circles and ellipses.
	     > Path String
	     # <p>Please refer to <a href="http://www.w3.org/TR/SVG/paths.html#PathData" title="Details of a paths data attributes format are described in the SVG specification.">SVG documentation regarding path string</a>. Raphal fully supports it.</p>
	     > Colour Parsing
	     # <ul>
	     #     <li>Colour name (<code>red</code>, <code>green</code>, <code>cornflowerblue</code>, etc)</li>
	     #     <li>#  shortened HTML colour: (<code>#000</code>, <code>#fc0</code>, etc)</li>
	     #     <li>#  full length HTML colour: (<code>#000000</code>, <code>#bd2300</code>)</li>
	     #     <li>rgb(, , )  red, green and blue channels values: (<code>rgb(200,&nbsp;100,&nbsp;0)</code>)</li>
	     #     <li>rgb(%, %, %)  same as above, but in %: (<code>rgb(100%,&nbsp;175%,&nbsp;0%)</code>)</li>
	     #     <li>rgba(, , , )  red, green and blue channels values: (<code>rgba(200,&nbsp;100,&nbsp;0, .5)</code>)</li>
	     #     <li>rgba(%, %, %, %)  same as above, but in %: (<code>rgba(100%,&nbsp;175%,&nbsp;0%, 50%)</code>)</li>
	     #     <li>hsb(, , )  hue, saturation and brightness values: (<code>hsb(0.5,&nbsp;0.25,&nbsp;1)</code>)</li>
	     #     <li>hsb(%, %, %)  same as above, but in %</li>
	     #     <li>hsba(, , , )  same as above, but with opacity</li>
	     #     <li>hsl(, , )  almost the same as hsb, see <a href="http://en.wikipedia.org/wiki/HSL_and_HSV" title="HSL and HSV - Wikipedia, the free encyclopedia">Wikipedia page</a></li>
	     #     <li>hsl(%, %, %)  same as above, but in %</li>
	     #     <li>hsla(, , , )  same as above, but with opacity</li>
	     #     <li>Optionally for hsb and hsl you could specify hue as a degree: <code>hsl(240deg,&nbsp;1,&nbsp;.5)</code> or, if you want to go fancy, <code>hsl(240,&nbsp;1,&nbsp;.5)</code></li>
	     # </ul>
	    \*/
	    elproto.attr = function (name, value) {
	        if (this.removed) {
	            return this;
	        }
	        if (name == null) {
	            var res = {};
	            for (var a in this.attrs) if (this.attrs[has](a)) {
	                res[a] = this.attrs[a];
	            }
	            res.gradient && res.fill == "none" && (res.fill = res.gradient) && delete res.gradient;
	            res.transform = this._.transform;
	            return res;
	        }
	        if (value == null && R.is(name, "string")) {
	            if (name == "fill" && this.attrs.fill == "none" && this.attrs.gradient) {
	                return this.attrs.gradient;
	            }
	            if (name == "transform") {
	                return this._.transform;
	            }
	            var names = name.split(separator),
	                out = {};
	            for (var i = 0, ii = names.length; i < ii; i++) {
	                name = names[i];
	                if (name in this.attrs) {
	                    out[name] = this.attrs[name];
	                } else if (R.is(this.paper.customAttributes[name], "function")) {
	                    out[name] = this.paper.customAttributes[name].def;
	                } else {
	                    out[name] = R._availableAttrs[name];
	                }
	            }
	            return ii - 1 ? out : out[names[0]];
	        }
	        if (value == null && R.is(name, "array")) {
	            out = {};
	            for (i = 0, ii = name.length; i < ii; i++) {
	                out[name[i]] = this.attr(name[i]);
	            }
	            return out;
	        }
	        if (value != null) {
	            var params = {};
	            params[name] = value;
	        } else if (name != null && R.is(name, "object")) {
	            params = name;
	        }
	        for (var key in params) {
	            eve("raphael.attr." + key + "." + this.id, this, params[key]);
	        }
	        for (key in this.paper.customAttributes) if (this.paper.customAttributes[has](key) && params[has](key) && R.is(this.paper.customAttributes[key], "function")) {
	            var par = this.paper.customAttributes[key].apply(this, [].concat(params[key]));
	            this.attrs[key] = params[key];
	            for (var subkey in par) if (par[has](subkey)) {
	                params[subkey] = par[subkey];
	            }
	        }
	        setFillAndStroke(this, params);
	        return this;
	    };
	    /*\
	     * Element.toFront
	     [ method ]
	     **
	     * Moves the element so it is the closest to the viewers eyes, on top of other elements.
	     = (object) @Element
	    \*/
	    elproto.toFront = function () {
	        if (this.removed) {
	            return this;
	        }
	        var node = getRealNode(this.node);
	        node.parentNode.appendChild(node);
	        var svg = this.paper;
	        svg.top != this && R._tofront(this, svg);
	        return this;
	    };
	    /*\
	     * Element.toBack
	     [ method ]
	     **
	     * Moves the element so it is the furthest from the viewers eyes, behind other elements.
	     = (object) @Element
	    \*/
	    elproto.toBack = function () {
	        if (this.removed) {
	            return this;
	        }
	        var node = getRealNode(this.node);
	        var parentNode = node.parentNode;
	        parentNode.insertBefore(node, parentNode.firstChild);
	        R._toback(this, this.paper);
	        var svg = this.paper;
	        return this;
	    };
	    /*\
	     * Element.insertAfter
	     [ method ]
	     **
	     * Inserts current object after the given one.
	     = (object) @Element
	    \*/
	    elproto.insertAfter = function (element) {
	        if (this.removed || !element) {
	            return this;
	        }

	        var node = getRealNode(this.node);
	        var afterNode = getRealNode(element.node || element[element.length - 1].node);
	        if (afterNode.nextSibling) {
	            afterNode.parentNode.insertBefore(node, afterNode.nextSibling);
	        } else {
	            afterNode.parentNode.appendChild(node);
	        }
	        R._insertafter(this, element, this.paper);
	        return this;
	    };
	    /*\
	     * Element.insertBefore
	     [ method ]
	     **
	     * Inserts current object before the given one.
	     = (object) @Element
	    \*/
	    elproto.insertBefore = function (element) {
	        if (this.removed || !element) {
	            return this;
	        }

	        var node = getRealNode(this.node);
	        var beforeNode = getRealNode(element.node || element[0].node);
	        beforeNode.parentNode.insertBefore(node, beforeNode);
	        R._insertbefore(this, element, this.paper);
	        return this;
	    };
	    elproto.blur = function (size) {
	        // Experimental. No Safari support. Use it on your own risk.
	        var t = this;
	        if (+size !== 0) {
	            var fltr = $("filter"),
	                blur = $("feGaussianBlur");
	            t.attrs.blur = size;
	            fltr.id = R.createUUID();
	            $(blur, {stdDeviation: +size || 1.5});
	            fltr.appendChild(blur);
	            t.paper.defs.appendChild(fltr);
	            t._blur = fltr;
	            $(t.node, {filter: "url(#" + fltr.id + ")"});
	        } else {
	            if (t._blur) {
	                t._blur.parentNode.removeChild(t._blur);
	                delete t._blur;
	                delete t.attrs.blur;
	            }
	            t.node.removeAttribute("filter");
	        }
	        return t;
	    };
	    R._engine.circle = function (svg, x, y, r) {
	        var el = $("circle");
	        svg.canvas && svg.canvas.appendChild(el);
	        var res = new Element(el, svg);
	        res.attrs = {cx: x, cy: y, r: r, fill: "none", stroke: "#000"};
	        res.type = "circle";
	        $(el, res.attrs);
	        return res;
	    };
	    R._engine.rect = function (svg, x, y, w, h, r) {
	        var el = $("rect");
	        svg.canvas && svg.canvas.appendChild(el);
	        var res = new Element(el, svg);
	        res.attrs = {x: x, y: y, width: w, height: h, rx: r || 0, ry: r || 0, fill: "none", stroke: "#000"};
	        res.type = "rect";
	        $(el, res.attrs);
	        return res;
	    };
	    R._engine.ellipse = function (svg, x, y, rx, ry) {
	        var el = $("ellipse");
	        svg.canvas && svg.canvas.appendChild(el);
	        var res = new Element(el, svg);
	        res.attrs = {cx: x, cy: y, rx: rx, ry: ry, fill: "none", stroke: "#000"};
	        res.type = "ellipse";
	        $(el, res.attrs);
	        return res;
	    };
	    R._engine.image = function (svg, src, x, y, w, h) {
	        var el = $("image");
	        $(el, {x: x, y: y, width: w, height: h, preserveAspectRatio: "none"});
	        el.setAttributeNS(xlink, "href", src);
	        svg.canvas && svg.canvas.appendChild(el);
	        var res = new Element(el, svg);
	        res.attrs = {x: x, y: y, width: w, height: h, src: src};
	        res.type = "image";
	        return res;
	    };
	    R._engine.text = function (svg, x, y, text) {
	        var el = $("text");
	        svg.canvas && svg.canvas.appendChild(el);
	        var res = new Element(el, svg);
	        res.attrs = {
	            x: x,
	            y: y,
	            "text-anchor": "middle",
	            text: text,
	            "font-family": R._availableAttrs["font-family"],
	            "font-size": R._availableAttrs["font-size"],
	            stroke: "none",
	            fill: "#000"
	        };
	        res.type = "text";
	        setFillAndStroke(res, res.attrs);
	        return res;
	    };
	    R._engine.setSize = function (width, height) {
	        this.width = width || this.width;
	        this.height = height || this.height;
	        this.canvas.setAttribute("width", this.width);
	        this.canvas.setAttribute("height", this.height);
	        if (this._viewBox) {
	            this.setViewBox.apply(this, this._viewBox);
	        }
	        return this;
	    };
	    R._engine.create = function () {
	        var con = R._getContainer.apply(0, arguments),
	            container = con && con.container,
	            x = con.x,
	            y = con.y,
	            width = con.width,
	            height = con.height;
	        if (!container) {
	            throw new Error("SVG container not found.");
	        }
	        var cnvs = $("svg"),
	            css = "overflow:hidden;",
	            isFloating;
	        x = x || 0;
	        y = y || 0;
	        width = width || 512;
	        height = height || 342;
	        $(cnvs, {
	            height: height,
	            version: 1.1,
	            width: width,
	            xmlns: "http://www.w3.org/2000/svg",
	            "xmlns:xlink": "http://www.w3.org/1999/xlink"
	        });
	        if (container == 1) {
	            cnvs.style.cssText = css + "position:absolute;left:" + x + "px;top:" + y + "px";
	            R._g.doc.body.appendChild(cnvs);
	            isFloating = 1;
	        } else {
	            cnvs.style.cssText = css + "position:relative";
	            if (container.firstChild) {
	                container.insertBefore(cnvs, container.firstChild);
	            } else {
	                container.appendChild(cnvs);
	            }
	        }
	        container = new R._Paper;
	        container.width = width;
	        container.height = height;
	        container.canvas = cnvs;
	        container.clear();
	        container._left = container._top = 0;
	        isFloating && (container.renderfix = function () {});
	        container.renderfix();
	        return container;
	    };
	    R._engine.setViewBox = function (x, y, w, h, fit) {
	        eve("raphael.setViewBox", this, this._viewBox, [x, y, w, h, fit]);
	        var paperSize = this.getSize(),
	            size = mmax(w / paperSize.width, h / paperSize.height),
	            top = this.top,
	            aspectRatio = fit ? "xMidYMid meet" : "xMinYMin",
	            vb,
	            sw;
	        if (x == null) {
	            if (this._vbSize) {
	                size = 1;
	            }
	            delete this._vbSize;
	            vb = "0 0 " + this.width + S + this.height;
	        } else {
	            this._vbSize = size;
	            vb = x + S + y + S + w + S + h;
	        }
	        $(this.canvas, {
	            viewBox: vb,
	            preserveAspectRatio: aspectRatio
	        });
	        while (size && top) {
	            sw = "stroke-width" in top.attrs ? top.attrs["stroke-width"] : 1;
	            top.attr({"stroke-width": sw});
	            top._.dirty = 1;
	            top._.dirtyT = 1;
	            top = top.prev;
	        }
	        this._viewBox = [x, y, w, h, !!fit];
	        return this;
	    };
	    /*\
	     * Paper.renderfix
	     [ method ]
	     **
	     * Fixes the issue of Firefox and IE9 regarding subpixel rendering. If paper is dependent
	     * on other elements after reflow it could shift half pixel which cause for lines to lost their crispness.
	     * This method fixes the issue.
	     **
	       Special thanks to Mariusz Nowak (http://www.medikoo.com/) for this method.
	    \*/
	    R.prototype.renderfix = function () {
	        var cnvs = this.canvas,
	            s = cnvs.style,
	            pos;
	        try {
	            pos = cnvs.getScreenCTM() || cnvs.createSVGMatrix();
	        } catch (e) {
	            pos = cnvs.createSVGMatrix();
	        }
	        var left = -pos.e % 1,
	            top = -pos.f % 1;
	        if (left || top) {
	            if (left) {
	                this._left = (this._left + left) % 1;
	                s.left = this._left + "px";
	            }
	            if (top) {
	                this._top = (this._top + top) % 1;
	                s.top = this._top + "px";
	            }
	        }
	    };
	    /*\
	     * Paper.clear
	     [ method ]
	     **
	     * Clears the paper, i.e. removes all the elements.
	    \*/
	    R.prototype.clear = function () {
	        R.eve("raphael.clear", this);
	        var c = this.canvas;
	        while (c.firstChild) {
	            c.removeChild(c.firstChild);
	        }
	        this.bottom = this.top = null;
	        (this.desc = $("desc")).appendChild(R._g.doc.createTextNode("Created with Rapha\xebl " + R.version));
	        c.appendChild(this.desc);
	        c.appendChild(this.defs = $("defs"));
	    };
	    /*\
	     * Paper.remove
	     [ method ]
	     **
	     * Removes the paper from the DOM.
	    \*/
	    R.prototype.remove = function () {
	        eve("raphael.remove", this);
	        this.canvas.parentNode && this.canvas.parentNode.removeChild(this.canvas);
	        for (var i in this) {
	            this[i] = typeof this[i] == "function" ? R._removedFactory(i) : null;
	        }
	    };
	    var setproto = R.st;
	    for (var method in elproto) if (elproto[has](method) && !setproto[has](method)) {
	        setproto[method] = (function (methodname) {
	            return function () {
	                var arg = arguments;
	                return this.forEach(function (el) {
	                    el[methodname].apply(el, arg);
	                });
	            };
	        })(method);
	    }
	}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));


/***/ },
/* 4 */
/***/ function(module, exports, __webpack_require__) {

	var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__(1)], __WEBPACK_AMD_DEFINE_RESULT__ = function(R) {
	    if (R && !R.vml) {
	        return;
	    }

	    var has = "hasOwnProperty",
	        Str = String,
	        toFloat = parseFloat,
	        math = Math,
	        round = math.round,
	        mmax = math.max,
	        mmin = math.min,
	        abs = math.abs,
	        fillString = "fill",
	        separator = /[, ]+/,
	        eve = R.eve,
	        ms = " progid:DXImageTransform.Microsoft",
	        S = " ",
	        E = "",
	        map = {M: "m", L: "l", C: "c", Z: "x", m: "t", l: "r", c: "v", z: "x"},
	        bites = /([clmz]),?([^clmz]*)/gi,
	        blurregexp = / progid:\S+Blur\([^\)]+\)/g,
	        val = /-?[^,\s-]+/g,
	        cssDot = "position:absolute;left:0;top:0;width:1px;height:1px;behavior:url(#default#VML)",
	        zoom = 21600,
	        pathTypes = {path: 1, rect: 1, image: 1},
	        ovalTypes = {circle: 1, ellipse: 1},
	        path2vml = function (path) {
	            var total =  /[ahqstv]/ig,
	                command = R._pathToAbsolute;
	            Str(path).match(total) && (command = R._path2curve);
	            total = /[clmz]/g;
	            if (command == R._pathToAbsolute && !Str(path).match(total)) {
	                var res = Str(path).replace(bites, function (all, command, args) {
	                    var vals = [],
	                        isMove = command.toLowerCase() == "m",
	                        res = map[command];
	                    args.replace(val, function (value) {
	                        if (isMove && vals.length == 2) {
	                            res += vals + map[command == "m" ? "l" : "L"];
	                            vals = [];
	                        }
	                        vals.push(round(value * zoom));
	                    });
	                    return res + vals;
	                });
	                return res;
	            }
	            var pa = command(path), p, r;
	            res = [];
	            for (var i = 0, ii = pa.length; i < ii; i++) {
	                p = pa[i];
	                r = pa[i][0].toLowerCase();
	                r == "z" && (r = "x");
	                for (var j = 1, jj = p.length; j < jj; j++) {
	                    r += round(p[j] * zoom) + (j != jj - 1 ? "," : E);
	                }
	                res.push(r);
	            }
	            return res.join(S);
	        },
	        compensation = function (deg, dx, dy) {
	            var m = R.matrix();
	            m.rotate(-deg, .5, .5);
	            return {
	                dx: m.x(dx, dy),
	                dy: m.y(dx, dy)
	            };
	        },
	        setCoords = function (p, sx, sy, dx, dy, deg) {
	            var _ = p._,
	                m = p.matrix,
	                fillpos = _.fillpos,
	                o = p.node,
	                s = o.style,
	                y = 1,
	                flip = "",
	                dxdy,
	                kx = zoom / sx,
	                ky = zoom / sy;
	            s.visibility = "hidden";
	            if (!sx || !sy) {
	                return;
	            }
	            o.coordsize = abs(kx) + S + abs(ky);
	            s.rotation = deg * (sx * sy < 0 ? -1 : 1);
	            if (deg) {
	                var c = compensation(deg, dx, dy);
	                dx = c.dx;
	                dy = c.dy;
	            }
	            sx < 0 && (flip += "x");
	            sy < 0 && (flip += " y") && (y = -1);
	            s.flip = flip;
	            o.coordorigin = (dx * -kx) + S + (dy * -ky);
	            if (fillpos || _.fillsize) {
	                var fill = o.getElementsByTagName(fillString);
	                fill = fill && fill[0];
	                o.removeChild(fill);
	                if (fillpos) {
	                    c = compensation(deg, m.x(fillpos[0], fillpos[1]), m.y(fillpos[0], fillpos[1]));
	                    fill.position = c.dx * y + S + c.dy * y;
	                }
	                if (_.fillsize) {
	                    fill.size = _.fillsize[0] * abs(sx) + S + _.fillsize[1] * abs(sy);
	                }
	                o.appendChild(fill);
	            }
	            s.visibility = "visible";
	        };
	    R.toString = function () {
	        return  "Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl " + this.version;
	    };
	    var addArrow = function (o, value, isEnd) {
	        var values = Str(value).toLowerCase().split("-"),
	            se = isEnd ? "end" : "start",
	            i = values.length,
	            type = "classic",
	            w = "medium",
	            h = "medium";
	        while (i--) {
	            switch (values[i]) {
	                case "block":
	                case "classic":
	                case "oval":
	                case "diamond":
	                case "open":
	                case "none":
	                    type = values[i];
	                    break;
	                case "wide":
	                case "narrow": h = values[i]; break;
	                case "long":
	                case "short": w = values[i]; break;
	            }
	        }
	        var stroke = o.node.getElementsByTagName("stroke")[0];
	        stroke[se + "arrow"] = type;
	        stroke[se + "arrowlength"] = w;
	        stroke[se + "arrowwidth"] = h;
	    },
	    setFillAndStroke = function (o, params) {
	        // o.paper.canvas.style.display = "none";
	        o.attrs = o.attrs || {};
	        var node = o.node,
	            a = o.attrs,
	            s = node.style,
	            xy,
	            newpath = pathTypes[o.type] && (params.x != a.x || params.y != a.y || params.width != a.width || params.height != a.height || params.cx != a.cx || params.cy != a.cy || params.rx != a.rx || params.ry != a.ry || params.r != a.r),
	            isOval = ovalTypes[o.type] && (a.cx != params.cx || a.cy != params.cy || a.r != params.r || a.rx != params.rx || a.ry != params.ry),
	            res = o;


	        for (var par in params) if (params[has](par)) {
	            a[par] = params[par];
	        }
	        if (newpath) {
	            a.path = R._getPath[o.type](o);
	            o._.dirty = 1;
	        }
	        params.href && (node.href = params.href);
	        params.title && (node.title = params.title);
	        params.target && (node.target = params.target);
	        params.cursor && (s.cursor = params.cursor);
	        "blur" in params && o.blur(params.blur);
	        if (params.path && o.type == "path" || newpath) {
	            node.path = path2vml(~Str(a.path).toLowerCase().indexOf("r") ? R._pathToAbsolute(a.path) : a.path);
	            o._.dirty = 1;
	            if (o.type == "image") {
	                o._.fillpos = [a.x, a.y];
	                o._.fillsize = [a.width, a.height];
	                setCoords(o, 1, 1, 0, 0, 0);
	            }
	        }
	        "transform" in params && o.transform(params.transform);
	        if (isOval) {
	            var cx = +a.cx,
	                cy = +a.cy,
	                rx = +a.rx || +a.r || 0,
	                ry = +a.ry || +a.r || 0;
	            node.path = R.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x", round((cx - rx) * zoom), round((cy - ry) * zoom), round((cx + rx) * zoom), round((cy + ry) * zoom), round(cx * zoom));
	            o._.dirty = 1;
	        }
	        if ("clip-rect" in params) {
	            var rect = Str(params["clip-rect"]).split(separator);
	            if (rect.length == 4) {
	                rect[2] = +rect[2] + (+rect[0]);
	                rect[3] = +rect[3] + (+rect[1]);
	                var div = node.clipRect || R._g.doc.createElement("div"),
	                    dstyle = div.style;
	                dstyle.clip = R.format("rect({1}px {2}px {3}px {0}px)", rect);
	                if (!node.clipRect) {
	                    dstyle.position = "absolute";
	                    dstyle.top = 0;
	                    dstyle.left = 0;
	                    dstyle.width = o.paper.width + "px";
	                    dstyle.height = o.paper.height + "px";
	                    node.parentNode.insertBefore(div, node);
	                    div.appendChild(node);
	                    node.clipRect = div;
	                }
	            }
	            if (!params["clip-rect"]) {
	                node.clipRect && (node.clipRect.style.clip = "auto");
	            }
	        }
	        if (o.textpath) {
	            var textpathStyle = o.textpath.style;
	            params.font && (textpathStyle.font = params.font);
	            params["font-family"] && (textpathStyle.fontFamily = '"' + params["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g, E) + '"');
	            params["font-size"] && (textpathStyle.fontSize = params["font-size"]);
	            params["font-weight"] && (textpathStyle.fontWeight = params["font-weight"]);
	            params["font-style"] && (textpathStyle.fontStyle = params["font-style"]);
	        }
	        if ("arrow-start" in params) {
	            addArrow(res, params["arrow-start"]);
	        }
	        if ("arrow-end" in params) {
	            addArrow(res, params["arrow-end"], 1);
	        }
	        if (params.opacity != null ||
	            params.fill != null ||
	            params.src != null ||
	            params.stroke != null ||
	            params["stroke-width"] != null ||
	            params["stroke-opacity"] != null ||
	            params["fill-opacity"] != null ||
	            params["stroke-dasharray"] != null ||
	            params["stroke-miterlimit"] != null ||
	            params["stroke-linejoin"] != null ||
	            params["stroke-linecap"] != null) {
	            var fill = node.getElementsByTagName(fillString),
	                newfill = false;
	            fill = fill && fill[0];
	            !fill && (newfill = fill = createNode(fillString));
	            if (o.type == "image" && params.src) {
	                fill.src = params.src;
	            }
	            params.fill && (fill.on = true);
	            if (fill.on == null || params.fill == "none" || params.fill === null) {
	                fill.on = false;
	            }
	            if (fill.on && params.fill) {
	                var isURL = Str(params.fill).match(R._ISURL);
	                if (isURL) {
	                    fill.parentNode == node && node.removeChild(fill);
	                    fill.rotate = true;
	                    fill.src = isURL[1];
	                    fill.type = "tile";
	                    var bbox = o.getBBox(1);
	                    fill.position = bbox.x + S + bbox.y;
	                    o._.fillpos = [bbox.x, bbox.y];

	                    R._preload(isURL[1], function () {
	                        o._.fillsize = [this.offsetWidth, this.offsetHeight];
	                    });
	                } else {
	                    fill.color = R.getRGB(params.fill).hex;
	                    fill.src = E;
	                    fill.type = "solid";
	                    if (R.getRGB(params.fill).error && (res.type in {circle: 1, ellipse: 1} || Str(params.fill).charAt() != "r") && addGradientFill(res, params.fill, fill)) {
	                        a.fill = "none";
	                        a.gradient = params.fill;
	                        fill.rotate = false;
	                    }
	                }
	            }
	            if ("fill-opacity" in params || "opacity" in params) {
	                var opacity = ((+a["fill-opacity"] + 1 || 2) - 1) * ((+a.opacity + 1 || 2) - 1) * ((+R.getRGB(params.fill).o + 1 || 2) - 1);
	                opacity = mmin(mmax(opacity, 0), 1);
	                fill.opacity = opacity;
	                if (fill.src) {
	                    fill.color = "none";
	                }
	            }
	            node.appendChild(fill);
	            var stroke = (node.getElementsByTagName("stroke") && node.getElementsByTagName("stroke")[0]),
	            newstroke = false;
	            !stroke && (newstroke = stroke = createNode("stroke"));
	            if ((params.stroke && params.stroke != "none") ||
	                params["stroke-width"] ||
	                params["stroke-opacity"] != null ||
	                params["stroke-dasharray"] ||
	                params["stroke-miterlimit"] ||
	                params["stroke-linejoin"] ||
	                params["stroke-linecap"]) {
	                stroke.on = true;
	            }
	            (params.stroke == "none" || params.stroke === null || stroke.on == null || params.stroke == 0 || params["stroke-width"] == 0) && (stroke.on = false);
	            var strokeColor = R.getRGB(params.stroke);
	            stroke.on && params.stroke && (stroke.color = strokeColor.hex);
	            opacity = ((+a["stroke-opacity"] + 1 || 2) - 1) * ((+a.opacity + 1 || 2) - 1) * ((+strokeColor.o + 1 || 2) - 1);
	            var width = (toFloat(params["stroke-width"]) || 1) * .75;
	            opacity = mmin(mmax(opacity, 0), 1);
	            params["stroke-width"] == null && (width = a["stroke-width"]);
	            params["stroke-width"] && (stroke.weight = width);
	            width && width < 1 && (opacity *= width) && (stroke.weight = 1);
	            stroke.opacity = opacity;

	            params["stroke-linejoin"] && (stroke.joinstyle = params["stroke-linejoin"] || "miter");
	            stroke.miterlimit = params["stroke-miterlimit"] || 8;
	            params["stroke-linecap"] && (stroke.endcap = params["stroke-linecap"] == "butt" ? "flat" : params["stroke-linecap"] == "square" ? "square" : "round");
	            if ("stroke-dasharray" in params) {
	                var dasharray = {
	                    "-": "shortdash",
	                    ".": "shortdot",
	                    "-.": "shortdashdot",
	                    "-..": "shortdashdotdot",
	                    ". ": "dot",
	                    "- ": "dash",
	                    "--": "longdash",
	                    "- .": "dashdot",
	                    "--.": "longdashdot",
	                    "--..": "longdashdotdot"
	                };
	                stroke.dashstyle = dasharray[has](params["stroke-dasharray"]) ? dasharray[params["stroke-dasharray"]] : E;
	            }
	            newstroke && node.appendChild(stroke);
	        }
	        if (res.type == "text") {
	            res.paper.canvas.style.display = E;
	            var span = res.paper.span,
	                m = 100,
	                fontSize = a.font && a.font.match(/\d+(?:\.\d*)?(?=px)/);
	            s = span.style;
	            a.font && (s.font = a.font);
	            a["font-family"] && (s.fontFamily = a["font-family"]);
	            a["font-weight"] && (s.fontWeight = a["font-weight"]);
	            a["font-style"] && (s.fontStyle = a["font-style"]);
	            fontSize = toFloat(a["font-size"] || fontSize && fontSize[0]) || 10;
	            s.fontSize = fontSize * m + "px";
	            res.textpath.string && (span.innerHTML = Str(res.textpath.string).replace(/</g, "&#60;").replace(/&/g, "&#38;").replace(/\n/g, "<br>"));
	            var brect = span.getBoundingClientRect();
	            res.W = a.w = (brect.right - brect.left) / m;
	            res.H = a.h = (brect.bottom - brect.top) / m;
	            // res.paper.canvas.style.display = "none";
	            res.X = a.x;
	            res.Y = a.y + res.H / 2;

	            ("x" in params || "y" in params) && (res.path.v = R.format("m{0},{1}l{2},{1}", round(a.x * zoom), round(a.y * zoom), round(a.x * zoom) + 1));
	            var dirtyattrs = ["x", "y", "text", "font", "font-family", "font-weight", "font-style", "font-size"];
	            for (var d = 0, dd = dirtyattrs.length; d < dd; d++) if (dirtyattrs[d] in params) {
	                res._.dirty = 1;
	                break;
	            }

	            // text-anchor emulation
	            switch (a["text-anchor"]) {
	                case "start":
	                    res.textpath.style["v-text-align"] = "left";
	                    res.bbx = res.W / 2;
	                break;
	                case "end":
	                    res.textpath.style["v-text-align"] = "right";
	                    res.bbx = -res.W / 2;
	                break;
	                default:
	                    res.textpath.style["v-text-align"] = "center";
	                    res.bbx = 0;
	                break;
	            }
	            res.textpath.style["v-text-kern"] = true;
	        }
	        // res.paper.canvas.style.display = E;
	    },
	    addGradientFill = function (o, gradient, fill) {
	        o.attrs = o.attrs || {};
	        var attrs = o.attrs,
	            pow = Math.pow,
	            opacity,
	            oindex,
	            type = "linear",
	            fxfy = ".5 .5";
	        o.attrs.gradient = gradient;
	        gradient = Str(gradient).replace(R._radial_gradient, function (all, fx, fy) {
	            type = "radial";
	            if (fx && fy) {
	                fx = toFloat(fx);
	                fy = toFloat(fy);
	                pow(fx - .5, 2) + pow(fy - .5, 2) > .25 && (fy = math.sqrt(.25 - pow(fx - .5, 2)) * ((fy > .5) * 2 - 1) + .5);
	                fxfy = fx + S + fy;
	            }
	            return E;
	        });
	        gradient = gradient.split(/\s*\-\s*/);
	        if (type == "linear") {
	            var angle = gradient.shift();
	            angle = -toFloat(angle);
	            if (isNaN(angle)) {
	                return null;
	            }
	        }
	        var dots = R._parseDots(gradient);
	        if (!dots) {
	            return null;
	        }
	        o = o.shape || o.node;
	        if (dots.length) {
	            o.removeChild(fill);
	            fill.on = true;
	            fill.method = "none";
	            fill.color = dots[0].color;
	            fill.color2 = dots[dots.length - 1].color;
	            var clrs = [];
	            for (var i = 0, ii = dots.length; i < ii; i++) {
	                dots[i].offset && clrs.push(dots[i].offset + S + dots[i].color);
	            }
	            fill.colors = clrs.length ? clrs.join() : "0% " + fill.color;
	            if (type == "radial") {
	                fill.type = "gradientTitle";
	                fill.focus = "100%";
	                fill.focussize = "0 0";
	                fill.focusposition = fxfy;
	                fill.angle = 0;
	            } else {
	                // fill.rotate= true;
	                fill.type = "gradient";
	                fill.angle = (270 - angle) % 360;
	            }
	            o.appendChild(fill);
	        }
	        return 1;
	    },
	    Element = function (node, vml) {
	        this[0] = this.node = node;
	        node.raphael = true;
	        this.id = R._oid++;
	        node.raphaelid = this.id;
	        this.X = 0;
	        this.Y = 0;
	        this.attrs = {};
	        this.paper = vml;
	        this.matrix = R.matrix();
	        this._ = {
	            transform: [],
	            sx: 1,
	            sy: 1,
	            dx: 0,
	            dy: 0,
	            deg: 0,
	            dirty: 1,
	            dirtyT: 1
	        };
	        !vml.bottom && (vml.bottom = this);
	        this.prev = vml.top;
	        vml.top && (vml.top.next = this);
	        vml.top = this;
	        this.next = null;
	    };
	    var elproto = R.el;

	    Element.prototype = elproto;
	    elproto.constructor = Element;
	    elproto.transform = function (tstr) {
	        if (tstr == null) {
	            return this._.transform;
	        }
	        var vbs = this.paper._viewBoxShift,
	            vbt = vbs ? "s" + [vbs.scale, vbs.scale] + "-1-1t" + [vbs.dx, vbs.dy] : E,
	            oldt;
	        if (vbs) {
	            oldt = tstr = Str(tstr).replace(/\.{3}|\u2026/g, this._.transform || E);
	        }
	        R._extractTransform(this, vbt + tstr);
	        var matrix = this.matrix.clone(),
	            skew = this.skew,
	            o = this.node,
	            split,
	            isGrad = ~Str(this.attrs.fill).indexOf("-"),
	            isPatt = !Str(this.attrs.fill).indexOf("url(");
	        matrix.translate(1, 1);
	        if (isPatt || isGrad || this.type == "image") {
	            skew.matrix = "1 0 0 1";
	            skew.offset = "0 0";
	            split = matrix.split();
	            if ((isGrad && split.noRotation) || !split.isSimple) {
	                o.style.filter = matrix.toFilter();
	                var bb = this.getBBox(),
	                    bbt = this.getBBox(1),
	                    dx = bb.x - bbt.x,
	                    dy = bb.y - bbt.y;
	                o.coordorigin = (dx * -zoom) + S + (dy * -zoom);
	                setCoords(this, 1, 1, dx, dy, 0);
	            } else {
	                o.style.filter = E;
	                setCoords(this, split.scalex, split.scaley, split.dx, split.dy, split.rotate);
	            }
	        } else {
	            o.style.filter = E;
	            skew.matrix = Str(matrix);
	            skew.offset = matrix.offset();
	        }
	        if (oldt !== null) { // empty string value is true as well
	            this._.transform = oldt;
	            R._extractTransform(this, oldt);
	        }
	        return this;
	    };
	    elproto.rotate = function (deg, cx, cy) {
	        if (this.removed) {
	            return this;
	        }
	        if (deg == null) {
	            return;
	        }
	        deg = Str(deg).split(separator);
	        if (deg.length - 1) {
	            cx = toFloat(deg[1]);
	            cy = toFloat(deg[2]);
	        }
	        deg = toFloat(deg[0]);
	        (cy == null) && (cx = cy);
	        if (cx == null || cy == null) {
	            var bbox = this.getBBox(1);
	            cx = bbox.x + bbox.width / 2;
	            cy = bbox.y + bbox.height / 2;
	        }
	        this._.dirtyT = 1;
	        this.transform(this._.transform.concat([["r", deg, cx, cy]]));
	        return this;
	    };
	    elproto.translate = function (dx, dy) {
	        if (this.removed) {
	            return this;
	        }
	        dx = Str(dx).split(separator);
	        if (dx.length - 1) {
	            dy = toFloat(dx[1]);
	        }
	        dx = toFloat(dx[0]) || 0;
	        dy = +dy || 0;
	        if (this._.bbox) {
	            this._.bbox.x += dx;
	            this._.bbox.y += dy;
	        }
	        this.transform(this._.transform.concat([["t", dx, dy]]));
	        return this;
	    };
	    elproto.scale = function (sx, sy, cx, cy) {
	        if (this.removed) {
	            return this;
	        }
	        sx = Str(sx).split(separator);
	        if (sx.length - 1) {
	            sy = toFloat(sx[1]);
	            cx = toFloat(sx[2]);
	            cy = toFloat(sx[3]);
	            isNaN(cx) && (cx = null);
	            isNaN(cy) && (cy = null);
	        }
	        sx = toFloat(sx[0]);
	        (sy == null) && (sy = sx);
	        (cy == null) && (cx = cy);
	        if (cx == null || cy == null) {
	            var bbox = this.getBBox(1);
	        }
	        cx = cx == null ? bbox.x + bbox.width / 2 : cx;
	        cy = cy == null ? bbox.y + bbox.height / 2 : cy;

	        this.transform(this._.transform.concat([["s", sx, sy, cx, cy]]));
	        this._.dirtyT = 1;
	        return this;
	    };
	    elproto.hide = function () {
	        !this.removed && (this.node.style.display = "none");
	        return this;
	    };
	    elproto.show = function () {
	        !this.removed && (this.node.style.display = E);
	        return this;
	    };
	    // Needed to fix the vml setViewBox issues
	    elproto.auxGetBBox = R.el.getBBox;
	    elproto.getBBox = function(){
	      var b = this.auxGetBBox();
	      if (this.paper && this.paper._viewBoxShift)
	      {
	        var c = {};
	        var z = 1/this.paper._viewBoxShift.scale;
	        c.x = b.x - this.paper._viewBoxShift.dx;
	        c.x *= z;
	        c.y = b.y - this.paper._viewBoxShift.dy;
	        c.y *= z;
	        c.width  = b.width  * z;
	        c.height = b.height * z;
	        c.x2 = c.x + c.width;
	        c.y2 = c.y + c.height;
	        return c;
	      }
	      return b;
	    };
	    elproto._getBBox = function () {
	        if (this.removed) {
	            return {};
	        }
	        return {
	            x: this.X + (this.bbx || 0) - this.W / 2,
	            y: this.Y - this.H,
	            width: this.W,
	            height: this.H
	        };
	    };
	    elproto.remove = function () {
	        if (this.removed || !this.node.parentNode) {
	            return;
	        }
	        this.paper.__set__ && this.paper.__set__.exclude(this);
	        R.eve.unbind("raphael.*.*." + this.id);
	        R._tear(this, this.paper);
	        this.node.parentNode.removeChild(this.node);
	        this.shape && this.shape.parentNode.removeChild(this.shape);
	        for (var i in this) {
	            this[i] = typeof this[i] == "function" ? R._removedFactory(i) : null;
	        }
	        this.removed = true;
	    };
	    elproto.attr = function (name, value) {
	        if (this.removed) {
	            return this;
	        }
	        if (name == null) {
	            var res = {};
	            for (var a in this.attrs) if (this.attrs[has](a)) {
	                res[a] = this.attrs[a];
	            }
	            res.gradient && res.fill == "none" && (res.fill = res.gradient) && delete res.gradient;
	            res.transform = this._.transform;
	            return res;
	        }
	        if (value == null && R.is(name, "string")) {
	            if (name == fillString && this.attrs.fill == "none" && this.attrs.gradient) {
	                return this.attrs.gradient;
	            }
	            var names = name.split(separator),
	                out = {};
	            for (var i = 0, ii = names.length; i < ii; i++) {
	                name = names[i];
	                if (name in this.attrs) {
	                    out[name] = this.attrs[name];
	                } else if (R.is(this.paper.customAttributes[name], "function")) {
	                    out[name] = this.paper.customAttributes[name].def;
	                } else {
	                    out[name] = R._availableAttrs[name];
	                }
	            }
	            return ii - 1 ? out : out[names[0]];
	        }
	        if (this.attrs && value == null && R.is(name, "array")) {
	            out = {};
	            for (i = 0, ii = name.length; i < ii; i++) {
	                out[name[i]] = this.attr(name[i]);
	            }
	            return out;
	        }
	        var params;
	        if (value != null) {
	            params = {};
	            params[name] = value;
	        }
	        value == null && R.is(name, "object") && (params = name);
	        for (var key in params) {
	            eve("raphael.attr." + key + "." + this.id, this, params[key]);
	        }
	        if (params) {
	            for (key in this.paper.customAttributes) if (this.paper.customAttributes[has](key) && params[has](key) && R.is(this.paper.customAttributes[key], "function")) {
	                var par = this.paper.customAttributes[key].apply(this, [].concat(params[key]));
	                this.attrs[key] = params[key];
	                for (var subkey in par) if (par[has](subkey)) {
	                    params[subkey] = par[subkey];
	                }
	            }
	            // this.paper.canvas.style.display = "none";
	            if (params.text && this.type == "text") {
	                this.textpath.string = params.text;
	            }
	            setFillAndStroke(this, params);
	            // this.paper.canvas.style.display = E;
	        }
	        return this;
	    };
	    elproto.toFront = function () {
	        !this.removed && this.node.parentNode.appendChild(this.node);
	        this.paper && this.paper.top != this && R._tofront(this, this.paper);
	        return this;
	    };
	    elproto.toBack = function () {
	        if (this.removed) {
	            return this;
	        }
	        if (this.node.parentNode.firstChild != this.node) {
	            this.node.parentNode.insertBefore(this.node, this.node.parentNode.firstChild);
	            R._toback(this, this.paper);
	        }
	        return this;
	    };
	    elproto.insertAfter = function (element) {
	        if (this.removed) {
	            return this;
	        }
	        if (element.constructor == R.st.constructor) {
	            element = element[element.length - 1];
	        }
	        if (element.node.nextSibling) {
	            element.node.parentNode.insertBefore(this.node, element.node.nextSibling);
	        } else {
	            element.node.parentNode.appendChild(this.node);
	        }
	        R._insertafter(this, element, this.paper);
	        return this;
	    };
	    elproto.insertBefore = function (element) {
	        if (this.removed) {
	            return this;
	        }
	        if (element.constructor == R.st.constructor) {
	            element = element[0];
	        }
	        element.node.parentNode.insertBefore(this.node, element.node);
	        R._insertbefore(this, element, this.paper);
	        return this;
	    };
	    elproto.blur = function (size) {
	        var s = this.node.runtimeStyle,
	            f = s.filter;
	        f = f.replace(blurregexp, E);
	        if (+size !== 0) {
	            this.attrs.blur = size;
	            s.filter = f + S + ms + ".Blur(pixelradius=" + (+size || 1.5) + ")";
	            s.margin = R.format("-{0}px 0 0 -{0}px", round(+size || 1.5));
	        } else {
	            s.filter = f;
	            s.margin = 0;
	            delete this.attrs.blur;
	        }
	        return this;
	    };

	    R._engine.path = function (pathString, vml) {
	        var el = createNode("shape");
	        el.style.cssText = cssDot;
	        el.coordsize = zoom + S + zoom;
	        el.coordorigin = vml.coordorigin;
	        var p = new Element(el, vml),
	            attr = {fill: "none", stroke: "#000"};
	        pathString && (attr.path = pathString);
	        p.type = "path";
	        p.path = [];
	        p.Path = E;
	        setFillAndStroke(p, attr);
	        vml.canvas && vml.canvas.appendChild(el);
	        var skew = createNode("skew");
	        skew.on = true;
	        el.appendChild(skew);
	        p.skew = skew;
	        p.transform(E);
	        return p;
	    };
	    R._engine.rect = function (vml, x, y, w, h, r) {
	        var path = R._rectPath(x, y, w, h, r),
	            res = vml.path(path),
	            a = res.attrs;
	        res.X = a.x = x;
	        res.Y = a.y = y;
	        res.W = a.width = w;
	        res.H = a.height = h;
	        a.r = r;
	        a.path = path;
	        res.type = "rect";
	        return res;
	    };
	    R._engine.ellipse = function (vml, x, y, rx, ry) {
	        var res = vml.path(),
	            a = res.attrs;
	        res.X = x - rx;
	        res.Y = y - ry;
	        res.W = rx * 2;
	        res.H = ry * 2;
	        res.type = "ellipse";
	        setFillAndStroke(res, {
	            cx: x,
	            cy: y,
	            rx: rx,
	            ry: ry
	        });
	        return res;
	    };
	    R._engine.circle = function (vml, x, y, r) {
	        var res = vml.path(),
	            a = res.attrs;
	        res.X = x - r;
	        res.Y = y - r;
	        res.W = res.H = r * 2;
	        res.type = "circle";
	        setFillAndStroke(res, {
	            cx: x,
	            cy: y,
	            r: r
	        });
	        return res;
	    };
	    R._engine.image = function (vml, src, x, y, w, h) {
	        var path = R._rectPath(x, y, w, h),
	            res = vml.path(path).attr({stroke: "none"}),
	            a = res.attrs,
	            node = res.node,
	            fill = node.getElementsByTagName(fillString)[0];
	        a.src = src;
	        res.X = a.x = x;
	        res.Y = a.y = y;
	        res.W = a.width = w;
	        res.H = a.height = h;
	        a.path = path;
	        res.type = "image";
	        fill.parentNode == node && node.removeChild(fill);
	        fill.rotate = true;
	        fill.src = src;
	        fill.type = "tile";
	        res._.fillpos = [x, y];
	        res._.fillsize = [w, h];
	        node.appendChild(fill);
	        setCoords(res, 1, 1, 0, 0, 0);
	        return res;
	    };
	    R._engine.text = function (vml, x, y, text) {
	        var el = createNode("shape"),
	            path = createNode("path"),
	            o = createNode("textpath");
	        x = x || 0;
	        y = y || 0;
	        text = text || "";
	        path.v = R.format("m{0},{1}l{2},{1}", round(x * zoom), round(y * zoom), round(x * zoom) + 1);
	        path.textpathok = true;
	        o.string = Str(text);
	        o.on = true;
	        el.style.cssText = cssDot;
	        el.coordsize = zoom + S + zoom;
	        el.coordorigin = "0 0";
	        var p = new Element(el, vml),
	            attr = {
	                fill: "#000",
	                stroke: "none",
	                font: R._availableAttrs.font,
	                text: text
	            };
	        p.shape = el;
	        p.path = path;
	        p.textpath = o;
	        p.type = "text";
	        p.attrs.text = Str(text);
	        p.attrs.x = x;
	        p.attrs.y = y;
	        p.attrs.w = 1;
	        p.attrs.h = 1;
	        setFillAndStroke(p, attr);
	        el.appendChild(o);
	        el.appendChild(path);
	        vml.canvas.appendChild(el);
	        var skew = createNode("skew");
	        skew.on = true;
	        el.appendChild(skew);
	        p.skew = skew;
	        p.transform(E);
	        return p;
	    };
	    R._engine.setSize = function (width, height) {
	        var cs = this.canvas.style;
	        this.width = width;
	        this.height = height;
	        width == +width && (width += "px");
	        height == +height && (height += "px");
	        cs.width = width;
	        cs.height = height;
	        cs.clip = "rect(0 " + width + " " + height + " 0)";
	        if (this._viewBox) {
	            R._engine.setViewBox.apply(this, this._viewBox);
	        }
	        return this;
	    };
	    R._engine.setViewBox = function (x, y, w, h, fit) {
	        R.eve("raphael.setViewBox", this, this._viewBox, [x, y, w, h, fit]);
	        var paperSize = this.getSize(),
	            width = paperSize.width,
	            height = paperSize.height,
	            H, W;
	        if (fit) {
	            H = height / h;
	            W = width / w;
	            if (w * H < width) {
	                x -= (width - w * H) / 2 / H;
	            }
	            if (h * W < height) {
	                y -= (height - h * W) / 2 / W;
	            }
	        }
	        this._viewBox = [x, y, w, h, !!fit];
	        this._viewBoxShift = {
	            dx: -x,
	            dy: -y,
	            scale: paperSize
	        };
	        this.forEach(function (el) {
	            el.transform("...");
	        });
	        return this;
	    };
	    var createNode;
	    R._engine.initWin = function (win) {
	            var doc = win.document;
	            if (doc.styleSheets.length < 31) {
	                doc.createStyleSheet().addRule(".rvml", "behavior:url(#default#VML)");
	            } else {
	                // no more room, add to the existing one
	                // http://msdn.microsoft.com/en-us/library/ms531194%28VS.85%29.aspx
	                doc.styleSheets[0].addRule(".rvml", "behavior:url(#default#VML)");
	            }
	            try {
	                !doc.namespaces.rvml && doc.namespaces.add("rvml", "urn:schemas-microsoft-com:vml");
	                createNode = function (tagName) {
	                    return doc.createElement('<rvml:' + tagName + ' class="rvml">');
	                };
	            } catch (e) {
	                createNode = function (tagName) {
	                    return doc.createElement('<' + tagName + ' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');
	                };
	            }
	        };
	    R._engine.initWin(R._g.win);
	    R._engine.create = function () {
	        var con = R._getContainer.apply(0, arguments),
	            container = con.container,
	            height = con.height,
	            s,
	            width = con.width,
	            x = con.x,
	            y = con.y;
	        if (!container) {
	            throw new Error("VML container not found.");
	        }
	        var res = new R._Paper,
	            c = res.canvas = R._g.doc.createElement("div"),
	            cs = c.style;
	        x = x || 0;
	        y = y || 0;
	        width = width || 512;
	        height = height || 342;
	        res.width = width;
	        res.height = height;
	        width == +width && (width += "px");
	        height == +height && (height += "px");
	        res.coordsize = zoom * 1e3 + S + zoom * 1e3;
	        res.coordorigin = "0 0";
	        res.span = R._g.doc.createElement("span");
	        res.span.style.cssText = "position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;";
	        c.appendChild(res.span);
	        cs.cssText = R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden", width, height);
	        if (container == 1) {
	            R._g.doc.body.appendChild(c);
	            cs.left = x + "px";
	            cs.top = y + "px";
	            cs.position = "absolute";
	        } else {
	            if (container.firstChild) {
	                container.insertBefore(c, container.firstChild);
	            } else {
	                container.appendChild(c);
	            }
	        }
	        res.renderfix = function () {};
	        return res;
	    };
	    R.prototype.clear = function () {
	        R.eve("raphael.clear", this);
	        this.canvas.innerHTML = E;
	        this.span = R._g.doc.createElement("span");
	        this.span.style.cssText = "position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";
	        this.canvas.appendChild(this.span);
	        this.bottom = this.top = null;
	    };
	    R.prototype.remove = function () {
	        R.eve("raphael.remove", this);
	        this.canvas.parentNode.removeChild(this.canvas);
	        for (var i in this) {
	            this[i] = typeof this[i] == "function" ? R._removedFactory(i) : null;
	        }
	        return true;
	    };

	    var setproto = R.st;
	    for (var method in elproto) if (elproto[has](method) && !setproto[has](method)) {
	        setproto[method] = (function (methodname) {
	            return function () {
	                var arg = arguments;
	                return this.forEach(function (el) {
	                    el[methodname].apply(el, arg);
	                });
	            };
	        })(method);
	    }
	}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));


/***/ }
/******/ ])
});
;xui.Class("xui.svg", "xui.UI",{
    Before:function(key, parent_key, o){
        xui.absBox.$type[key.replace("xui.","")]=xui.absBox.$type[key]=key;
        return true;
    },
    Initialize:function(){
        if(typeof(Raphael)=="function"){
            Raphael._availableAttrs.href="";
            Raphael._availableAttrs.title="";
    
            Raphael.el.shadow = function () {
                var ns=this;
                if (ns.type == "text")return null;
                ns._.dirty=true;
                var sw=ns.attr("stroke-width"),
                    f=ns.attr("fill"),
                    o=ns.attr("opacity"),
                    fo=ns.attr("fill-opacity"),
                    tr=ns.attr("transform"),
                    c = 4,
                    r = ns.paper,
                    out = r.set(),
                    bbox = ns._getBBox(false),
                    rx=!bbox.width?0:(bbox.width+sw-c-4)/bbox.width,
                    ry=!bbox.height?0:(bbox.height+sw-c-4)/bbox.height,
                    path = ns.getPath();
                // path = ns.matrix ? Raphael.mapPath(path, ns.matrix) : path;
                if(f!=='none' && fo!==0)
                    path = Raphael.transformPath(path, "t"+(sw/2)+","+(sw/2)+"s"+rx+","+ry+","+(bbox.x+bbox.width+sw)+","+(bbox.y+bbox.height+sw));
                else
                    path = Raphael.transformPath(path, "t"+c/2+","+c/2);
    
                for (var i=1,s; i < c+1; i++) {
                    s=r.path(path).attr({
                        stroke: "#666",
                        fill: f=='none'?'none':'#555',
                        "fill-opacity": fo,
                        "stroke-linejoin": "round",
                        "stroke-linecap": "round",
                        "stroke-width": 2*i,
                        opacity: (.2 * (1-i/c) + .05)*o
                    });
                    s._decoration=1;
                    out.push(s);
                }
                if(tr && tr.length)
                    out.transform(tr);
                return out.insertBefore(ns);
            };
            
            var  r = function(){
                var m=arguments, g = m.length, b=0, a;
                for (;b<g;b++)if ((a = m[b]) || !(a !== !1 && a !== 0)) return a;
            },
            u = function(){
                var m=arguments, g = m.length, b=0, a;
                for (;b <g;b++)if((a = m[b]) || !(a !== !1 && a !== 0)) if (!isNaN(a = Number(a))) return a;
            },
            t = function(m){
                return "matrix(" + [ m.get(0), m.get(1), m.get(2), m.get(3), m.get(4), m.get(5) ].join() + ")";
            },
            h = /^matrix\(|\)$/g, 
            M = /\,/g, 
            e = /\n|<br\s*?\/?>/gi, 
            k = /[^\d\.]/gi, 
            V = /[\(\)\s,\xb0#]/g, 
            ga = /group/gi, 
            w = /&/g, 
            Q = /"/g, K = /'/g, 
            G = /</g, aa = />/g, 
            A = 0,
            l = Math, D = parseFloat, q = l.max, j = l.abs, s = l.pow, fa = String, ea = /[, ]+/, U = [ {
                reg: /xmlns\=\"http\:\/\/www.w3.org\/2000\/svg\"/gi,
                str: ""
            }, {
                reg: /^.*<svg /,
                str: '<svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" '
            }, {
                reg: /\/svg>.*$/,
                str: "/svg>"
            }, {
                reg: /\<desc[\s\>][^\<]*\<\/desc\>/,
                str: ""
            }, {
                reg: /zIndex="[^"]+"/g,
                str: ""
            }, {
                reg: /url\((\\?[\'\"])[^#]+#/g,
                str: "url($1#"
            }, {
                reg: / href=/g,
                str: " xlink:href="
            }, {
                reg: /(id|class|width|height)=([^" >]+)/g,
                str: '$1="$2"'
            }, {
                reg: /:(path|rect)/g,
                str: "$1"
            }, {
                reg: /\<ima?ge? ([^\>]+?)[^\/]\>/gi,
                str: "<image $1 />"
            }, {
                reg: /\<\/ima?ge?\>/g,
                str: ""
            }, {
                reg: /style="([^"]+)"/g,
                str: function(e) {
                    return e.toLowerCase();
                }
            } ], 
            W = {
                blur: function() {},
                transform: function() {},
                src: function(e, d) {
                    d.attrSTR += ' xlink:href="' + d.attrs.src + '"';
                },
                path: function(e, d) {
                    var h = d.attrs.path, h = Raphael._pathToAbsolute(h || "");
                    d.attrSTR += ' d="' + (h.toString && h.toString() || "").replace(M, " ") + '"';
                },
                gradient: function(e, d, h) {
                    var b = e.attrs.gradient, f = "linear", a, g, c = .5, k = .5, r = g = "", u = "";
                    a = b.replace(V, "_");
                    if (!h[a]) {
                        b = fa(b).replace(Raphael._radial_gradient, function(a, b, e) {
                            f = "radial";
                            b && e && (c = D(b), k = D(e), a = (k > .5) * 2 - 1, s(c - .5, 2) + s(k - .5, 2) > .25 && (k = l.sqrt(.25 - s(c - .5, 2)) * a + .5) && k != .5 && (k = k.toFixed(5) - 1e-5 * a));
                            return "";
                        });
                        b = b.split(/\s*\-\s*/);
                        if (f === "linear") {
                            g = b.shift();
                            g = -D(g);
                            if (isNaN(g)) return null;
                            var w = [ 0, 0, l.cos(Raphael.rad(g)), l.sin(Raphael.rad(g)) ];
                            g = 1 / (q(j(w[2]), j(w[3])) || 1);
                            w[2] *= g;
                            w[3] *= g;
                            w[2] < 0 && (w[0] = -w[2], w[2] = 0);
                            w[3] < 0 && (w[1] = -w[3], w[3] = 0);
                        }
                        b = Raphael._parseDots(b);
                        if (!b) return null;
                        f === "radial" ? (g = '<radialGradient fx = "' + c + '" fy = "' + k + '" id = "' + a + '">', 
                        r = "</radialGradient>") : (g = '<linearGradient x1 = "' + w[0] + '" y1 = "' + w[1] + '" x2 = "' + w[2] + '" y2 = "' + w[3] + '" gradientTransform ="matrix(' + e.matrix.invert() + ')" id = "' + a + '">', 
                        r = "</linearGradient>");
                        e = 0;
                        for (w = b.length; e < w; e++) u += '<stop offset="' + (b[e].offset ? b[e].offset : e ? "100%" : "0%") + '" stop-color="' + (b[e].color || "#fff") + '" stop-opacity="' + (b[e].opacity === void 0 ? 1 : b[e].opacity) + '" />';
                        h[a] = !0;
                        h.str += g + u + r;
                    }
                    d.attrSTR += " fill=\"url('#" + a + "')\"";
                },
                fill: function(e, d) {
                    var h = d.attrs, b = h.fill, f;
                    if (!e.attrs.gradient) if (b = Raphael.color(b), f = b.opacity, e.type === "text") d.styleSTR += "fill:" + b + "; stroke-opacity:0; "; else if (d.attrSTR += ' fill="' + b + '"', 
                    !h["fill-opacity"] && (f || f === 0)) d.attrSTR += ' fill-opacity="' + f + '"';
                },
                stroke: function(e, d) {
                    var h = d.attrs, b, f;
                    b = Raphael.color(h.stroke);
                    f = b.opacity;
                    if (e.type !== "text" && (d.attrSTR += ' stroke="' + b + '"', !h["stroke-opacity"] && (f || f === 0))) d.attrSTR += ' stroke-opacity="' + f + '"';
                },
                "clip-rect": function(e, d, i) {
                    var b = fa(d.attrs["clip-rect"]), f = b.split(ea), b = b.replace(V, "_") + "__" + A++;
                    f.length === 4 && (i[b] || (i[b] = !0, i.str += '<clipPath id="' + b + '"><rect x="' + f[0] + '" y="' + f[1] + '" width="' + f[2] + '" height="' + f[3] + '" transform="matrix(' + t(e.matrix.invert()).replace(h, "") + ')"/></clipPath>'), 
                    d.attrSTR += ' clip-path="url(#' + b + ')"');
                },
                cursor: function(e, d) {
                    var h = d.attrs.cursor;
                    h && (d.styleSTR += "cursor:" + h + "; ");
                },
                font: function(e, d) {
                    d.styleSTR += "font:" + d.attrs.font.replace(/\"/gi, " ") + "; ";
                },
                "font-size": function(e, d) {
                    var h = r(d.attrs["font-size"], "10");
                    h && h.replace && (h = h.replace(k, ""));
                    d.styleSTR += "font-size:" + h + "px; ";
                },
                "font-weight": function(e, d) {
                    d.styleSTR += "font-weight:" + d.attrs["font-weight"] + "; ";
                },
                "font-family": function(e, d) {
                    d.styleSTR += "font-family:" + d.attrs["font-family"] + "; ";
                },
                "line-height": function() {},
                "clip-path": function() {},
                visibility: function() {},
                "vertical-align": function() {},
                "text-anchor": function(e, d) {
                    var h = d.attrs["text-anchor"] || "middle";
                    e.type === "text" && (d.attrSTR += ' text-anchor="' + h + '"');
                },
                title: function() {},
                text: function(d, h) {
                    var i = h.attrs, b = i.text, f = r(i["font-size"], i.font, "10"), a = r(i["line-height"]), g;
                    f && f.replace && (f = f.replace(k, ""));
                    f = u(f);
                    a && a.replace && (a = a.replace(k, ""));
                    a = u(a, f && f * 1.2);
                    g = f ? f * .85 : a * .75;
                    for (var f = i.x, c = r(i["vertical-align"], "middle").toLowerCase(), b = fa(b).split(e), i = b.length, l = 0, c = c === "top" ? g : c === "bottom" ? g - a * i : g - a * i * .5; l < i; l++) h.textSTR += "<tspan ", 
                    g = (b[l] || "").replace(w, "&amp;").replace(Q, "&quot;").replace(K, "&#39;").replace(G, "&lt;").replace(aa, "&gt;"), 
                    h.textSTR += l ? 'dy="' + a + '" x="' + f + '" ' : 'dy="' + c + '"', h.textSTR += ">" + g + "</tspan>";
                }
            }, 
            X = function(e, i) {
                var k = "", b = {
                    attrSTR: "",
                    styleSTR: "",
                    textSTR: "",
                    attrs: e.attr()
                }, f = "", a = "", g = "", c, l, j = b.attrs;
                if (e.node.style.display !== "none") {
                    for (c in j) if (c !== "gradient" && (Raphael._availableAttrs[c] !== void 0 || W[c])) if (W[c]) W[c](e, b, i); else b.attrSTR += " " + c + '="' + j[c] + '"';
                    e.attrs.gradient && W.gradient(e, b, i);
                    e.type === "rect" && j.r && (b.attrSTR += ' rx="' + j.r + '" ry="' + j.r + '"');
                    for (l in e.styles) b.styleSTR += l + ":" + e.styles[l] + "; ";
                    e.type === "image" && (b.attrSTR += ' preserveAspectRatio="none"');
                    e.bottom && (a = X(e.bottom, i));
                    e.next && (g = X(e.next, i));
                    f = e.type;
                    f.match(ga) && (f = "g");
                    k += "<" + f + ' transform="matrix(' + t(e.matrix).replace(h, "") + ')" style="' + b.styleSTR + '"' + b.attrSTR + ">" + b.textSTR + a + "</" + f + ">" + g;
                } else e.next && (k += X(e.next, i));
                return k;
            };
            Raphael.fn.toSVG = function(includeImage) {
                var d = "", h = {str: ""}, b = 0, f = U.length, a = "";
                if (Raphael.svg) {
                    if (this.canvas && this.canvas.parentNode) 
                        for (d = this.canvas.parentNode.innerHTML; b < f; b += 1) 
                            h = U[b], d = d.replace(h.reg, h.str);
                } else{
                    d = '<svg style="overflow: hidden; position: relative;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="' + this.width + '" version="1.1" height="' + this.height + '">';
                    if(this.bottom){
                        a = X(this.bottom, h);
                        d += "<defs>" + h.str + "</defs>" + a + "</svg>";
                    }
                }
                if(!includeImage){
                    d = d.replace(/\<image [^\>]*\>/gi, "");
                }
                return d;
            };
        }

        var attr={
            "arrow-start":1,
            "arrow-end":1,
            "clip-rect":1,
            "fill":1, // Radial gradients can only be applied to circles and ellipses.
            "fill-opacity":1,
//            "href":1,
//            "target":1,
            "title":1,
            "cursor":1,
            "transform":1,
            "opacity":1,
            "stroke":1,
            "stroke-dasharray":1,
            "stroke-linecap":1,
            "stroke-linejoin":1,
            "stroke-miterlimit":1,
            "stroke-opacity":1,
            "stroke-dashoffset":1,
            "stroke-width":1
        };
        this.$attr={
            circle:{cx:1,cy:1,r:1},
            ellipse:{cx:1,cy:1,rx:1,ry:1},
            rect:{x:1,y:1,r:1,width:1,height:1},
            text:{x:1,y:1,text:1,font:1,"font-family":1,"font-style":1,"font-size":1,"font-weight":1,"text-anchor":1,"letter-spacing":1},
            image:{src:1,x:1,y:1,width:1,height:1},
            path:{path:1}
        };
        xui.each(this.$attr,function(o) {
            xui.merge(o,attr);
        });

        var o=this.$attr.text;
        delete o["arrow-start"];
        delete o["arrow-end"];
        delete o["stroke-dasharray"];
        delete o["stroke-linecap"];
        delete o["stroke-linejoin"];
        delete o["stroke-miterlimit"];
        delete o["stroke-opacity"];
        delete o['stroke-dashoffset'];
        delete o["stroke-width"];
        
        delete this.prototype.toHtml;
    },
    Instance:{
        initialize:function(){
            if(typeof(Raphael)!="function")throw "Browser doesn't suppor SVG or VML, all diagram functions were disabled!";
        },
        getAttr:function(key){
            var prf=this.get(0);
            if(prf){
                var prop=prf.properties,
                    dftAttr=Raphael._availableAttrs,
                    attr=prf.box.ISCOMBO?prop.attr:{KEY:prop.attr},node;

                if(prf._elset){
                    prf._elset.forEach(function(el){
                        var key1=el.type,tag=prf.getKey(el.node.id,true);
                        if(!key || key===tag){
                            node=el.node;
                            if(node&&('raphaelid' in node)){
                                var paper=prf.boxing().getPaper();
                                if(paper && (node=paper.getById(node.raphaelid))){
                                    var attf=node.attr();
                                    xui.filter(attf,function(o,i){
                                        if(i=='transform' && xui.isArr(o) && o.length===0)o="";
                                        // get the simple transform string
                                        if(i=='transform' && o)
                                            o=node.matrix.toTransformString();

                                        // special for text
                                        if(key1=='text'){
                                            if(i=='stroke') return o!="none";
                                            if(i=='fill') return o!="#000";
                                            if(tag!="KEY" && ('hAlign' in prf.box.$DataModel) && (i=='x'||i=='y'))return false;
                                        }
                                        if(tag!="KEY" &&  i=='transform')return false;
                                        return o!=dftAttr[i];
                                    });
                                    // keep the  original src attr
                                    if('src' in attf && 'src' in attr[tag])
                                        attf.src=attr[tag].src;
                                    attr[tag]=attf;
                                }
                            }
                        }
                    });
                }
            }
            // filter
            attr=prf.box._adjustAttr(attr);
            return prf.box.ISCOMBO? (key?attr[key]:attr) :attr.KEY;
        },
        setAttr:function(key, attr, reset, notify){
            if(xui.isHash(key))attr=key;
            else{
                var h={};
                h[key]=attr;
                attr=h;
                key=key||"KEY";
            };
            reset=reset!==false;
            return this.each(function(prf){
                var prop=prf.properties,node,
                    dftAttr=Raphael._availableAttrs,
                    oAttr=prf.box._adjustAttr(prop.attr),
                    attr2=prf.box._adjustAttr(attr);
                if(reset){
                    // add dft attr to reset the old attr
                    xui.each(oAttr,function(o,i){
                        if(!(i in attr2)){
                            attr2[i]={};
                        }

                        xui.each(o,function(o1,i1){
                            if(!(i1 in attr2[i])){
                                attr2[i][i1]=dftAttr[i1];
                                // special for text
                                if((prf.box.$tagName[i]|| i.split("_")[0].toLowerCase())=='text'){
                                    if(i1=='stroke') attr2[i][i1]="none";
                                    if(i1=='fill') attr2[i][i1]="#000";
                                }
                            }
                        });
                        // special for text
                        if((prf.box.$tagName[i]|| i.split("_")[0].toLowerCase())=='text'){
                            if(i!="KEY" && ('hAlign' in prf.box.$DataModel) ){
                                delete attr2[i].x;
                                delete attr2[i].y;
                            }
                        }
                        if(i!="KEY"){
                            delete attr2[i].transform;
                        }
                    });
                }

                if(prf._elset){
                    prf._elset.forEach(function(el){
                        var key1=el.type,tag=prf.getKey(el.node.id,true);
                        if(xui.isHash(key) || key===tag){
                            node=el.node;
                            if(node&&('raphaelid' in node)){
                                var paper=prf.boxing().getPaper();
                                if(paper && (node=paper.getById(node.raphaelid))){
                                    var rattr=xui.copy(attr2[tag]);
                                    if(rattr){
                                        if('src' in rattr)
                                            rattr.src = xui.adjustRes(rattr.src);
                                        node.attr(rattr);
                                    }
                                }
                            }
                        }
                    });

                    var ot=attr2.KEY,
                        shapeChanged=ot && ('x' in ot
                        || 'y' in ot
                        || 'width' in ot
                        || 'height' in ot
                        || 'r' in ot
                        || 'rx' in ot
                        || 'ry' in ot
                        || 'path' in ot
                        || 'transform' in ot
                        || 'arrow-start' in ot
                        || 'arrow-end' in ot);
                    if(ot){
                        var ss=prf._elset;
                        if(ss[1]){
                            // sync transform
                            if('transform' in ot){
                                for(var i=1,l=ss.length;i<l;i++)
                                    ss[i].attr('transform', ot.transform);
                            }
                        }
                        if(notify!==false)
                            prf.box._notify(prf, ot, shapeChanged);
                    }
                }

                // set to attr property
                if(prf.box.ISCOMBO){
                    prop.attr=xui.merge(prop.attr,attr2,function(o,i){
                        if(typeof o=='object'){
                            if(i in prop.attr)
                                xui.merge(prop.attr[i], o, 'all');
                            else
                                prop.attr[i]=xui.copy(o);
                        }else{
                            return true;
                        }
                    });

                    // filter default setting
                    xui.each(prop.attr,function(o,i){
                        xui.filter(o,function(o1,i1){
                            if(i1=='transform' && xui.isArr(dftAttr[i1]) && dftAttr[i1].length===0)dftAttr[i1]="";
                            // special for text
                            if((prf.box.$tagName[i]|| i.split("_")[0].toLowerCase())=='text'){
                                if(i1=='stroke') return o1!="none";
                                if(i1=='fill') return o1!="#000";
                                if(i!="KEY" && ('hAlign' in prf.box.$DataModel) && (i1=='x'||i1=='y'))return false;
                            }
                            if(i!="KEY" && i1=='transform')return false;
                            return dftAttr[i1]!==o1;
                        });
                    });
                }else{
                    xui.merge(prop.attr, attr2.KEY, 'all');

                    // filter default setting
                    xui.filter(prop.attr,function(o1,i1){
                        if(i1=='transform' && xui.isArr(dftAttr[i1]) && dftAttr[i1].length===0)dftAttr[i1]="";
                        // special for text
                        if((prf.box.$tagName.KEY|| i.split("_")[0].toLowerCase())=='text'){
                            if(i1=='stroke') return o1!="none";
                            if(i1=='fill') return o1!="#000";
                        }
                        return dftAttr[i1]!==o1;
                    });
                }
            });
        },
        toFront:function(){
            return this.each(function(prf){
                if(prf._shadow)prf._shadow.toFront();
                if(prf._elset)
                    xui.arr.each(prf._elset.items,function(el){
                        el.toFront();
                    });
                var arr=xui.get(prf,['parent','children']);
                if(arr && arr.length){
                    var index=xui.arr.subIndexOf(arr,"0",prf),o;
                    if(index!=-1){
                        o=arr[index];
                        arr.splice(index,1);
                        arr.push(o);
                    }
                }
            });
        },
        toBack:function(){
            return this.each(function(prf){
                if(prf._elset)
                    xui.arr.each(prf._elset.items,function(el){
                        el.toBack();
                    },null,true);
                if(prf._shadow)prf._shadow.toBack();
                var arr=xui.get(prf,['parent','children']);
                if(arr && arr.length){
                    var index=xui.arr.subIndexOf(arr,"0",prf),o;
                    if(index!=-1){
                        o=arr[index];
                        arr.splice(index,1);
                        arr.unshift(o);
                    }
                }
            });
        },
        getAllNodes:function(){
            var prf=this.get(0),arr=[];
            if(prf&&prf._elset){
                prf._elset.forEach(function(el){
                    arr.push(el.node);
                });
            }
            return xui(arr);
        },
        getPaper:function(){
            var prf=this.get(0);
            return prf && prf.parent && prf.parent._paper;
        },
        elemsAnimate:function(endpoints, ms, easing, callback){
            var prf=this.get(0);
            if(prf&&prf._elset){
                prf._elset.animate(endpoints, ms, easing, callback);
            }
            return this;
        },
        getElemSet:function(){
            var prf=this.get(0);
            prf&&prf._elset;
        },
        getLeft:function(){
            return this._getBBox('x');
        },
        setLeft:function(value){
            return this._setBBox('x',value);
        },
        getTop:function(){
            return this._getBBox('y');
        },
        setTop:function(value){
            return this._setBBox('y',value);
        },
        getWidth:function(){
            return this._getBBox('width');
        },
        getHeight:function(){
            return this._getBBox('height');
        },
        setWidth:function(value){
            return this._setBBox('width',parseFloat(value));
        },
        setHeight:function(value){
            return this._setBBox('height',parseFloat(value));
        },

        _getBBox:function(key, withTransform){
            var prf=this.get(0),el,bbox;
            if((el=prf._elset)&&el.length){
                el[0]._.dirty=1;
                bbox={};
                xui.merge(bbox,el[0]._getBBox(withTransform!==false),'all',true);
                for(var i=1,l=el.length,t;i<l;i++){
                   if(!(el[i].type=='text' && ('hAlign' in prf.box.$DataModel))){
                        el[i]._.dirty=1;
                        t=el[i]._getBBox(withTransform!==false);
                        bbox.x=Math.min(t.x,bbox.x);
                        bbox.y=Math.min(t.y,bbox.y);
                        bbox.x2=Math.max(('x2' in t)?t.x2:(t.x+t.width), ('x2' in bbox)?bbox.x2:(bbox.x+bbox.width));
                        bbox.y2=Math.max(('y2' in t)?t.y2:(t.y+t.height), ('y2' in bbox)?bbox.y2:(bbox.y+bbox.height));
                    }
                }

                if('x2' in bbox)bbox.width=bbox.x2-bbox.x;
                if('y2' in bbox)bbox.height=bbox.y2-bbox.y;

                delete bbox.x2;
                delete bbox.y2;
                return key?bbox[key]:bbox;
            }
        },
        _setBBox:function(key,value){
        },
        _getConnectAnchors:function(){
            var prf=this.get(0),rst;
            if(prf){
                if(xui.get(prf._pathCached,['_connAnchors']))
                    return xui.get(prf._pathCached,['_connAnchors']);

                var ss=prf._elset;
                if(ss&&ss[0]){
                    ss[0]._.dirty=1;
                    var tf=Raphael.parseTransformString(ss[0].transform()),
                        matrix;
                    if(tf && tf.length){
                        matrix=ss[0].matrix;
                    }

                    var bbox=ss[0]._getBBox(true),
                        r1=180,r2=270,r3=0,r4=90,
                        x1=bbox.x ,y1=bbox.y+bbox.height/2 ,
                        x2=bbox.x+bbox.width/2 ,y2=bbox.y ,
                        x3=bbox.x+bbox.width ,y3=bbox.y+bbox.height/2 ,
                        x4=bbox.x+bbox.width/2 ,y4=bbox.y+bbox.height;
                    if(matrix){
                        var xx1=x1,xx2=x2,xx3=x3,xx4=x4,yy1=y1,yy2=y2,yy3=y3,yy4=y4;
                        x1=matrix.x(xx1,yy1);y1=matrix.y(xx1,yy1);
                        x2=matrix.x(xx2,yy2);y2=matrix.y(xx2,yy2);
                        x3=matrix.x(xx3,yy3);y3=matrix.y(xx3,yy3);
                        x4=matrix.x(xx4,yy4);y4=matrix.y(xx4,yy4);

                        var xc=(x1+x2+x3+x4)/4,
                             yc=(y1+y2+y3+y4)/4;

                        r1=Raphael.angle(x1,y1,xc,yc);
                        r2=Raphael.angle(x2,y2,xc,yc);
                        r3=Raphael.angle(x3,y3,xc,yc);
                        r4=Raphael.angle(x4,y4,xc,yc);
                    }

                    rst={
                        "left":{x:x1, y:y1, alpha:r1, solid:1},
                        "top":{x:x2, y:y2, alpha:r2, solid:1},
                        "right":{x:x3, y:y3, alpha:r3, solid:1},
                        "bottom":{x:x4, y:y4,alpha:r4, solid:1}
                    }

                    if(prf._pathCached)xui.set(prf._pathCached,['_connAnchors'], rst);

                    return rst;
                }
            }
        },
        _getConnectPath:function(){
            var prf=this.get(0),ss;

            if(xui.get(prf._pathCached,['_connPath']))
                return xui.get(prf._pathCached,['_connPath']);

            if(prf && (ss=prf._elset) && ss[0]){
                var tf=Raphael.parseTransformString(ss[0].transform()),
                        matrix;
                    if(tf && tf.length){
                        matrix=ss[0].matrix;
                    }
                var path=ss[0].getPath();
                if(matrix){
                    path=Raphael.mapPath(path,matrix);
                }

                if(prf._pathCached)xui.set(prf._pathCached,['_connPath'], path);

                return path;
            }
        },
        _getConnectPoint:function(anchor){
            if(anchor){
                var prf=this.get(0),rst;

                if(xui.get(prf._pathCached,['_connPoint',anchor]))
                    return xui.get(prf._pathCached,['_connPoint',anchor]);

                if(/^[1-9][0-9]*:((1([.][0]+)?)|(0\.[0-9]+))$/.test(anchor)){
                    var arr=anchor.split(":");
                    arr[0]=+arr[0];
                    arr[1]=+arr[1];
                    if(arr[0]>=1 && arr[1]>=0 && arr[1]<=1){
                        var prf=this.get(0),cp=this._getConnectPath();
                        if(cp){
                            var cv=Raphael.path2curve(cp),cur,prev;
                            if((cur=cv[arr[0]])&&(prev=cv[arr[0]-1])){
                                rst = Raphael.findDotsAtSegment(prev[prev.length-2],prev[prev.length-1], cur[1],cur[2],cur[3],cur[4],cur[5],cur[6],arr[1]);
                            }
                        }
                    }
                }else{
                    var hash=this._getConnectAnchors();
                    rst = hash && hash[anchor];
                }

                if(prf._pathCached)xui.set(prf._pathCached,['_connPoint',anchor],rst);

                return rst;
            }
        },
        _removeHandler:function(){
            return this.each(function(prf){
                var el,tt,hh;
                if(tt=prf._pathHandler){
                    if(hh=tt.handlers){
                        for(var i=0, ii=hh.length,o,t; i<ii; i++){
                            o=hh[i];
                            for(var j in o){
                                if((t=o[j]) && typeof t.remove=='function')t.remove();
                                o[i]=null;
                            }
                        }
                    }
                    el=tt.el;
                    delete tt.el;
                    delete prf._pathHandler;
                }
                delete prf._ddstartFun;
                delete prf._ddendFun;
                if(el && el._shape){
                    el._shape.remove();
                    delete el._shape;
                }
            });
        },
        _addHandler:function(callback, type){
            type=type||"adv";
            this._removeHandler();
            return this.each(function(prf){
                if(!prf._elset || !prf._elset[0])return;

                var r=prf.boxing().getPaper(),
                    isCombo=prf.box.ISCOMBO,
                    el=prf._elset[0],
                    absPos,
                    isConnector=prf.box._CONNECTOR,
                    connType=prf.properties.type,
                    dotAttr1 = {fill:"#fff",stroke:"#000",r:5},
                    dotAttr2 = {fill:"#fff",stroke:"#000",r:4},
                    dotAttr3 = {fill:"#fff",stroke:"#000",r:3},
                    dotAttr4 = {fill:"#fff",stroke:"#000",r:4},
                    dotAttr6 = {fill:"#bf5600",stroke:"#bf5600",r:5,"fill-opacity":0.5},

                    lineAttr = {stroke:"#0000FF","stroke-dasharray":". "},
                    rectAttr = {stroke:"#0000FF","stroke-dasharray":"- "},
                    shadowAttr1 = {stroke:"#ccc","stroke-dasharray":"- ",opacity:0.8},
                    shadowAttr2 = {opacity:0.8},

                    magneticDistance1 = 16,
                    magneticDistance2 = 16,

                    magneticPos,
                    magneticOffPos,

                    handlers = {
                        /*text:function (el){
                            el._.dirty=1;
                            var attr=el.attr(),handler={},bbox=el._getBBox(true);
                            handler.rectBox=createDDElem(r.rect(bbox.x, bbox.y, bbox.width, bbox.height).attr(rectAttr),el);
                            handler.dot = createDDElem(r.circle(bbox.cx, bbox.cy).attr(dotAttr1).attr('cursor','move'),
                                el,function (x, y){
                                    var rtn = moveFun(this, x,y);

                                    bbox.x+=rtn.rx;
                                    bbox.y+=rtn.ry;
                                    handler.rectBox.attr({x:bbox.x, y:bbox.y, width:bbox.width, height:bbox.height});
                                    moveFun(el, rtn.rx, rtn.ry);
                                });
                            return {
                                el:el,
                                handlers:[handler]
                            }
                        },*/
                        rect:function (el){
                            var attr=el.attr(),handler={};
                            handler.dot = createDDElem(r.circle(attr.x+attr.width/2, attr.y+attr.height/2).attr(dotAttr1).attr('cursor','move'),
                                el, function (x, y, ax, ay){
                                    var pos = moveFun(this, x,y,ax,ay),nshape;
                                    attr.x+=pos.rx;
                                    attr.y+=pos.ry;

                                    nshape={x:attr.x,y:attr.y};
                                    el.attr(nshape);

                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    moveFun(handler.dot1, x,y,ax,ay);
                                    moveFun(handler.dot2, x,y,ax,ay);
                                    moveFun(handler.dot3, x,y,ax,ay);

                                    return {dx:pos.dx,dy:pos.dy};
                                },'main');
                            handler.dot1 = createDDElem(r.circle(attr.x, attr.y).attr(dotAttr2).attr('cursor','nw-resize'),
                                el, function (x, y, ax, ay){
                                    var x2=el.attr("x")+el.attr("width"),
                                        y2=el.attr("y")+el.attr("height"),
                                        pos = moveFun(this, x,y,ax,ay,null,x2,null,y2),
                                        nshape;
                                    attr.x=pos.cx;
                                    attr.y=pos.cy;
                                    attr.height=y2-pos.cy;
                                    attr.width=x2-pos.cx;

                                    nshape={x:attr.x,y:attr.y,width:attr.width,height:attr.height};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    handler.dot.attr({cx:attr.x+attr.width/2, cy:attr.y+attr.height/2});

                                    var m=Math.min(el.attr("width"),el.attr("height"));
                                    if(el.attr("r")>m){
                                        el.attr("r",attr.r=m);
                                        if(el._shape)el._shape.attr("r",m);
                                        xui.tryF(el.onShapeChanged,[{r:m}]);
                                    }
                                    handler.dot3.attr({
                                        cx:el.attr("x")+el.attr("width")-el.attr("r"),
                                        cy:el.attr("y")
                                    });

                                    return {dx:pos.dx,dy:pos.dy};
                                },'w');
                            handler.dot2= createDDElem(r.circle(attr.x+attr.width, attr.y+attr.height).attr(dotAttr2).attr('cursor','se-resize'),
                                el, function (x, y, ax, ay){
                                    var pos = moveFun(this, x,y,ax,ay,attr.x,null,attr.y,null),
                                        nshape;

                                    attr.width=pos.cx-attr.x;
                                    attr.height=pos.cy-attr.y;

                                    nshape={width:attr.width, height:attr.height};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    handler.dot.attr({cx:attr.x+attr.width/2, cy:attr.y+attr.height/2});

                                    var m=Math.min(el.attr("width"),el.attr("height"));
                                    if(el.attr("r")>m){
                                        el.attr("r",attr.r=m);
                                        if(el._shape)el._shape.attr("r",m);
                                        xui.tryF(el.onShapeChanged,[{r:m}]);
                                    }
                                    handler.dot3.attr({
                                        cx:el.attr("x")+el.attr("width")-el.attr("r"),
                                        cy:el.attr("y")
                                    });
                                    return {dx:pos.dx,dy:pos.dy};
                                },'h');
                            handler.dot3= createDDElem(r.circle(attr.x+attr.width-(attr.r||0), attr.y).attr(dotAttr3).attr('cursor','e-resize'),
                                el, function (x, y, ax, ay){
                                    var attr=el.attr(),
                                        pos = moveFun(this, x,y,ax,ay,(attr.x+attr.width-Math.max(attr.width,attr.height)/2),attr.x+attr.width, attr.y,attr.y),
                                        nshape;
                                    nshape={r:attr.width-(pos.cx-attr.x)};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    return {dx:pos.dx,dy:pos.dy};
                                },'r');
                            return {
                                el:el,
                                handlers:[handler]
                            }
                        },
                        circle:function (el){
                            var attr=el.attr(),handler={};
                            handler.dot = createDDElem(r.circle(attr.cx, attr.cy).attr(dotAttr1).attr('cursor','move'),
                                el, function (x, y){
                                    var rtn = moveFun(this, x, y ),
                                        pos = {cx:rtn.cx,cy:rtn.cy};
                                    attr.cx=pos.cx;
                                    attr.cy=pos.cy;
                                    el.attr(pos);
                                    if(el._shape)el._shape.attr(pos);
                                    xui.tryF(el.onShapeChanged,[pos]);

                                    pos.cx += el.attr("r");
                                    handler.dotr.attr(pos);
                                },'main');
                            handler.dotr = createDDElem(r.circle(attr.cx+attr.r, attr.cy).attr(dotAttr2).attr('cursor','e-resize'),
                                el, function (x, y,ax,ay){
                                    var attr=el.attr(),
                                        pos = moveFun(this, x,y,ax,ay,attr.cx,null,attr.cy,attr.cy),
                                        nshape;
                                    attr.r=pos.cx-attr.cx;
                                    nshape={r:attr.r};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    return {dx:pos.dx,dy:pos.dy};
                                },'r');
                            return {
                                el:el,
                                handlers:[handler]
                            }
                        },
                        ellipse:function (el){
                            var attr=el.attr(),handler={},dot;
                            handler.dot = createDDElem(r.circle(attr.cx, attr.cy).attr(dotAttr1).attr('cursor','move'),
                                el, function (x, y){
                                    var rtn = moveFun(this, x,y),
                                        pos = {cx:rtn.cx,cy:rtn.cy};
                                    attr.cx=pos.cx;
                                    attr.cy=pos.cy;
                                    el.attr(pos);
                                    if(el._shape)el._shape.attr(pos);
                                    xui.tryF(el.onShapeChanged,[pos]);

                                    handler.dotrx.attr({cx:pos.cx+el.attr("rx"),cy:pos.cy});
                                    handler.dotry.attr({cy:pos.cy-el.attr("ry"),cx:pos.cx});
                                },'main');
                            handler.dotrx = createDDElem(r.circle(attr.cx+attr.rx, attr.cy).attr(dotAttr2).attr('cursor','w-resize'),
                                el, function (x, y,ax,ay){
                                    var attr=el.attr(),
                                        pos = moveFun(this, x,y,ax,ay,attr.cx,null,attr.cy,attr.cy),
                                        nshape;
                                    attr.rx=pos.cx-attr.cx;
                                    nshape={rx:attr.rx};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);
                                    return {dx:pos.dx,dy:pos.dy};
                                },'rx');
                            handler.dotry = createDDElem(r.circle(attr.cx, attr.cy-attr.ry).attr(dotAttr2).attr('cursor','n-resize'),
                                el,function (x, y,ax,ay){
                                    var attr=el.attr(),
                                        pos = moveFun(this, x,y,ax,ay,attr.cx,attr.cx,null,attr.cy),
                                        nshape;
                                    attr.ry=attr.cy-pos.cy;
                                    nshape={ry:attr.ry};
                                    el.attr(nshape);
                                    if(el._shape)el._shape.attr(nshape);
                                    xui.tryF(el.onShapeChanged,[nshape]);

                                    return {dx:pos.dx,dy:pos.dy};
                                },'ry');

                            return {
                                el:el,
                                handlers:[handler]
                            }
                        },
                        path : function (el){
                            var x, y, ox, oy, ax, ay, bx, by, zx, zy,
                                paths=el.getPath(),
                                manualPathModify,
                                addSegmentJunctionDD=function(r,el,x,y,index,type3,conType,prf){
                                    var circle=r.circle(x, y);

                                    if(conType=='from')
                                        circle.attr(dotAttr4);
                                    else if(conType=='to')
                                        circle.attr(dotAttr4);
                                    else
                                        circle.attr(dotAttr1).attr('cursor','move');

                                    return createDDElem(circle, el, function (x, y, ax, ay, beForced, mx, my,ix,iy,event, callback) {
                                        var paper=el.paper,
                                            ox = this.attr('cx'),
                                            oy = this.attr('cy'),
                                            X = xui.isSet(ix)?ix:(ox + x),
                                            Y = xui.isSet(iy)?iy:(oy + y),
                                            pos,anchorPos;
                                        if(xui.isSet(ix)){
                                            x=X-ox;
                                        }
                                        if(xui.isSet(iy)){
                                            y=Y-oy;
                                        }
                                        // for connector
                                        // find target connected el, draw/undraw magnetic dots
                                        if(conType=='from'||conType=='to'){
                                            var d=el.node.ownerDocument||document;

                                            // hide those for get right object
                                            this.hide();
                                            prf._elset.hide();
                                            el._shape.hide();
                                            xui.arr.each(handlers,function(o,i){
                                                if(i=o.dot)i.hide();
                                                if(i=o.dot1)i.hide();
                                                if(i=o.dot2)i.hide();
                                                if(i=o.dot3)i.hide();
                                                if(i=o.dotPrev)i.hide();
                                                if(i=o.dotNext)i.hide();
                                                if(i=o.linePrev)i.hide();
                                                if(i=o.lineNext)i.hide();
                                            });
                                            // get right object under mouse
                                            var esrc=d.elementFromPoint(mx, my);
                                            // show again
                                            this.show();
                                            prf._elset.show();
                                            el._shape.show();
                                            xui.arr.each(handlers,function(o,i){
                                                if(i=o.dot)i.show();
                                                if(i=o.dot1)i.show();
                                                if(i=o.dot2)i.show();
                                                if(i=o.dot3)i.show();
                                                if(i=o.dotPrev)i.show();
                                                if(i=o.dotNext)i.show();
                                                if(i=o.linePrev)i.show();
                                                if(i=o.lineNext)i.show();
                                            });

                                            if(esrc._rootNode)
                                                esrc=esrc._rootNode;

                                            if(!esrc)
                                                return;
                                            // special one
                                            if(esrc && esrc.raphael){
                                                var o=paper.getById(esrc.raphaelid);
                                                if(o && o._attached){
                                                    esrc = o._attached;
                                                }
                                            }

                                            // get the top widget
                                            while(esrc &&
                                                (
                                                    (!esrc.id)
                                                    || esrc.id==xui.$localeDomId
                                                    || esrc.tagName=='tspan'
                                                )
                                                && esrc!==paper.canvas.parentNode
                                                && esrc.parentNode!==d
                                            ){
                                                esrc=esrc.parentNode;
                                            }

                                            if(!esrc)
                                                return;

                                            // has anchors or anchorPath
                                            var magneticObj,anchorKey,
                                                targetNode,anchors,anchorPath,centerPoint,
                                                anchorShadow=paper._anchorShadow;
                                            if(esrc!==paper.canvas){
                                                var tobj=xui.UIProfile.getFromDom(esrc.id);
                                                if(tobj && tobj.parent&& tobj.parent._paper==paper){
                                                    if(tobj.box['xui.svg']){
                                                        targetNode=tobj.getRootNode();
                                                        if(!tobj.box._CONNECTOR){
                                                            anchors=tobj.boxing()._getConnectAnchors();
                                                            anchorPath=tobj.boxing()._getConnectPath();
                                                            if(anchorPath){
                                                                var anchorBBox;
                                                                if(anchorBBox=xui.get(tobj._pathCached,['_connBBox'])){
                                                                }else{
                                                                    anchorBBox=Raphael.pathBBox(anchorPath);
                                                                    xui.set(tobj._pathCached,['_connBBox'], anchorBBox);
                                                                }
                                                                centerPoint={x:anchorBBox.x+anchorBBox.width/2,y:anchorBBox.y+anchorBBox.height/2};
                                                            }
                                                            magneticObj=tobj.alias;
                                                        }
                                                    }else if(tobj.box['xui.UI']){
                                                        //console.log(esrc.id,tobj.getRoot().cssRegion(),X,Y,mx,my);
                                                    }
                                                }
                                            }


                                            // remove anchorShadow
                                            if(anchorShadow && ((!anchors && !anchorPath) || anchorShadow._attached!==targetNode)){
                                                anchorShadow.remove();
                                                anchorShadow.clear();
                                                anchorShadow=null;
                                                delete paper._anchorShadow;
                                                this.show();
                                            }
                                            // draw anchorShadow
                                            if(anchors || anchorPath){
                                                if(!anchorShadow){
                                                    anchorShadow=paper.set();
                                                    anchorShadow._attached=targetNode;

                                                    var circle=paper.circle(-100,-100);
                                                    circle._attached=targetNode;
                                                    circle.hide();
                                                    anchorShadow.push(circle);

                                                    // draw anchorShadow
                                                    for(var i in anchors){
                                                        o=anchors[i];
                                                        circle=paper.circle(o.x, o.y);
                                                        circle._attached=targetNode;
                                                        circle._anchorKey=i;
                                                        anchorShadow.push(circle);
                                                    }

                                                    anchorShadow.attr(dotAttr6);
                                                    paper._anchorShadow=anchorShadow;
                                                }

                                                // magnetic function
                                                var minDis=null;
                                                for(var i in anchors){
                                                    distance=Math.pow(Math.pow(Math.abs(ix-anchors[i].x),2)+Math.pow(Math.abs(iy-anchors[i].y),2),1/2);
                                                    if(distance<=magneticDistance1){
                                                        if(minDis===null || minDis>distance){
                                                            minDis=distance;
                                                            anchorPos=anchors[i];
                                                            anchorKey=i;
                                                        }
                                                    }
                                                }
                                                if(!anchorPos){
                                                    // for path magnetic
                                                    if(anchorPath){
                                                        var v=magneticDistance2,
                                                            path="M,"+X+","+Y+"m,0,-"+v+"a,"+v+","+v+",0,1,1,0,"+v*2+"a,"+v+","+v+",0,1,1,0,-"+v*2+"z",
                                                            len=Raphael.getTotalLength(path)/2,
                                                            cross=Raphael.pathIntersection(anchorPath, path);

                                                        if(cross.length>=2){
                                                            var x0=(cross[0].x+cross[1].x)/2,y0=(cross[0].y+cross[1].y)/2,
                                                                angle=Raphael.angle(x0,y0,X,Y);

                                                            if((Math.abs(x0-centerPoint.x)+Math.abs(y0-centerPoint.y))<Math.abs(X-centerPoint.x)+Math.abs(Y-centerPoint.y)){
                                                                angle+=180;
                                                            }

                                                            var rad=Raphael.rad(angle),
                                                                x1 = X - v * Math.cos(rad),
                                                                x2 = X + v * Math.cos(rad),
                                                                y1 = Y - v * Math.sin(rad),
                                                                y2 = Y + v * Math.sin(rad);

                                                            cross=Raphael.pathIntersection(anchorPath, "M"+x1+","+y1+",L"+x2+","+y2);
                                                            if(cross.length===1){
                                                                var b=cross[0].bez1,
                                                                    ppath="M"+b[0]+","+b[1]+"C"+b[2]+","+b[3]+","+b[4]+","+b[5]+","+b[6]+","+b[7],
                                                                    point=Raphael.getPointAtLength(ppath, cross[0].t1*Raphael.getTotalLength(ppath));
                                                                anchorKey=cross[0].segment1 + ":" + cross[0].t1;
                                                                anchorPos={
                                                                    x:cross[0].x,
                                                                    y:cross[0].y,
                                                                    alpha:angle,
                                                                    _path:true
                                                                };
                                                            }
                                                        }
                                                    }
                                                }

                                                if(anchorPos){
                                                    // hold
                                                    if(magneticPos){
                                                        // still the old magnetic
                                                        if(magneticPos.x==anchorPos.x && magneticPos.y==anchorPos.y){
//console.log('still the old magnetic');
                                                            x=y=0;
                                                            ax=magneticOffPos.x;
                                                            ay=magneticOffPos.y;
                                                        }
                                                        // swtich to the new magnetic
                                                        else{
//console.log('swtich to the new magnetic');
                                                            x = anchorPos.x-magneticPos.x;
                                                            y = anchorPos.y-magneticPos.y;

                                                            // need return to adjust
                                                            ax = magneticOffPos.x + x;
                                                            ay = magneticOffPos.y + y;
                                                            magneticPos={x:anchorPos.x,y:anchorPos.y};
                                                            magneticOffPos={x:ax,y:ay};
                                                            if(anchorPos._path){
                                                                anchorShadow[0].attr({cx:anchorPos.x,cy:anchorPos.y});
                                                                anchorShadow[0].show();
                                                            }else{
                                                                anchorShadow[0].hide();
                                                            }
                                                        }
                                                    }
                                                    // first magnetic
                                                    else{
//console.log('first magnetic');
                                                        x += anchorPos.x-ix;
                                                        y += anchorPos.y-iy;

                                                        // need return to adjust
                                                        ax += anchorPos.x-ix;
                                                        ay += anchorPos.y-iy;
                                                        magneticPos={x:anchorPos.x,y:anchorPos.y};
                                                        magneticOffPos={x:ax,y:ay};

                                                        if(anchorPos._path){
                                                            anchorShadow[0].attr({cx:anchorPos.x,cy:anchorPos.y});
                                                            anchorShadow[0].show();
                                                        }else{
                                                            anchorShadow[0].hide();
                                                        }
                                                    }

                                                    X = anchorPos.x;
                                                    Y = anchorPos.y;

                                                    pos={dx:ax,dy:ay};
                                                }
                                            }
                                            // off-magnetic
                                            if(!anchorPos && magneticPos){
                                                x = ix-magneticPos.x;
                                                y = iy-magneticPos.y;

                                                // need return to adjust
                                                ax = magneticOffPos.x + x;
                                                ay = magneticOffPos.y + y;

                                                magneticPos=magneticOffPos=null;

                                                if(anchorShadow)
                                                    anchorShadow[0].hide();
                                            }

                                            // keep connector parameters
                                            prf.properties[conType=='from'?'fromObj':'toObj'] = magneticObj || "";
                                            prf.properties[conType=='from'?'fromPoint':'toPoint'] = anchorKey || "";
                                        }

                                        // normal move function
                                        var pathModified,
                                            pos = {cx: X, cy: Y};
                                        if(beForced || false!==xui.tryF(manualPathModify,[index,paths,X,Y,this,pos])){
                                            var i=this._handlerIndex,
                                                l=paths[i].length,
                                                data=handlers[i],
                                                data2,p,d;

                                            if(!beForced){
                                                if(type3=='V'){
                                                    // stop the last H/V's prev V/H moving
                                                    if(handlers.length-1==i+1 && handlers[i+1].type=='H'){
                                                        delete pos.cy;
                                                        y=ay=0;
                                                    }else{
                                                        paths[i][l-1] = Y;
                                                    }

                                                    // try to move previoius path point
                                                    if((0!==i-1)&&(data2=handlers[i-1])){
                                                        if(data2.type=="H"){
                                                            paths[i-1][1] = X;
                                                            if(d=data2.dot)d.update(x, 0, ax, 0, true, mx, my);
                                                        }else if(data2.type=="V"){
                                                            delete pos.cx;
                                                        }else if(data2.type=="L"){
                                                            paths[i-1][paths[i-1].length-2] = X;
                                                            if(d=data2.dot)d.update(x, 0, ax, 0, true, mx, my);
                                                        }else{
                                                            delete pos.cx;
                                                        }
                                                    }else{
                                                        delete pos.cx;
                                                    }
                                                }else if(type3=='H'){
                                                    // stop the last H/V's prev V/H moving
                                                    if(handlers.length-1==i+1 && handlers[i+1].type=='V'){
                                                        delete pos.cx;
                                                        x=ax=0;
                                                    }else{
                                                        paths[i][l-1] = X;
                                                    }

                                                    // try to move previoius path point
                                                    if((0!==i-1)&&(data2=handlers[i-1])){
                                                        if(data2.type=="H"){
                                                            delete pos.cy;
                                                        }else if(data2.type=="V"){
                                                            paths[i-1][1] = Y;
                                                            if(d=data2.dot)d.update(0, y, ax, ay, true, mx, my);
                                                        }else if(data2.type=="L"){
                                                            paths[i-1][paths[i-1].length-1] = Y;
                                                            if(d=data2.dot)d.update(0, y, ax, ay, true, mx, my);
                                                        }else{
                                                            delete pos.cy;
                                                        }
                                                    }else{
                                                        delete pos.cy;
                                                    }
                                                }else{
                                                    paths[i][l-2] = X;
                                                    paths[i][l-1] = Y;
                                                }

                                                // move next handler's dot
                                                if((data2=handlers[i+1]) && (d=data2.dot)){
                                                    if(data2.type=='V'){
                                                        d.update(x, 0, ax, 0, true, mx, my);
                                                    }else if(data2.type=='H'){
                                                        d.update(0, y, 0, ay, true, mx, my);
                                                    }
                                                }
                                            }

                                            // move dot itself
                                            this.attr(pos);

                                            // move other linked dots
                                            if(p=data.linePrevPath){
                                                p[0][1] = X;
                                                p[0][2] = Y;
                                            }
                                            if(p=data.lineNextPath){
                                                p[0][1] = X;
                                                p[0][2] = Y;
                                            }
                                            if(d=data.dotPrev){
                                                d.update(X-ox, Y-oy, ax, ay, true);
                                                pathModified=true;
                                            }
                                            if(d=data.dotNext){
                                                d.update(X-ox, Y-oy, ax, ay, true);
                                                pathModified=true;
                                            }
                                        }
                                        // modify path
                                        if(!pathModified){
                                            var nshape={path: paths};
                                            el.attr(nshape);
                                            if(el._shape)el._shape.attr(nshape);
                                            xui.tryF(el.onShapeChanged,[nshape]);
                                        }

                                        // adjust angle for connector
                                        if((conType=='from'||conType=='to') && connType=='bezier' && anchorPos && (X!==ox || Y!==oy)){
                                            var dot=conType=='from'?handlers[0].dotNext:handlers[paths.length-1].dotPrev;
                                            if(dot){
                                                var x0=dot.attr('cx'),
                                                    y0=dot.attr('cy'),
                                                    distance=Math.pow(Math.pow(Math.abs(X-x0),2)+Math.pow(Math.abs(Y-y0),2),1/2),
                                                    rad=Raphael.rad(anchorPos.alpha),
                                                    x1 = X + distance * Math.cos(rad),
                                                    y1 = Y + distance * Math.sin(rad);
                                                dot.update(x1-x0, y1-y0, null, null, true);
                                            }
                                        }
                                        // adjust drag pos
                                        if(pos)return pos;
                                    },'main',index);
                                },
                                addBezierAnchor2DD=function(r,el,x,y,index,conType,prf){
                                    return createDDElem(r.circle(x, y).attr(dotAttr3),
                                        el, function (x, y) {
                                            var X = this.attr("cx") + x,
                                                Y = this.attr("cy") + y,
                                                nshape;
                                            this.attr({cx: X, cy: Y});

                                            var i=this._handlerIndex,data=handlers[i],p,d;
                                            if(p=data.lineNextPath){
                                                p[1][1] = X;
                                                p[1][2] = Y;
                                            }
                                            if(d=data.lineNext){
                                                d.attr({path: p});
                                            }

                                            paths[i+1][1] = X;
                                            paths[i+1][2] = Y;

                                            nshape={path: paths};
                                            el.attr(nshape);
                                            if(el._shape)el._shape.attr(nshape);
                                            xui.tryF(el.onShapeChanged,[nshape]);
                                        },'path2',index);
                                },
                                addBezierAnchor1DD=function(r,el,x,y,index,conType,prf){
                                    return createDDElem(r.circle(x, y).attr(dotAttr3),
                                        el, function (x, y) {
                                            var X = this.attr("cx") + x,
                                                Y = this.attr("cy") + y,
                                                nshape;
                                            this.attr({cx: X, cy: Y});

                                            var i=this._handlerIndex,data=handlers[i],p,d;
                                            if(p=data.linePrevPath){
                                                p[1][1] = X;
                                                p[1][2] = Y;
                                            }
                                            if(d=data.linePrev){
                                                d.attr({path: p});
                                            }

                                            paths[i][paths[i].length-4] = X;
                                            paths[i][paths[i].length-3] = Y;
                                            nshape={path: paths};
                                            el.attr(nshape);
                                            if(el._shape)el._shape.attr(nshape);
                                            xui.tryF(el.onShapeChanged,[nshape]);
                                        },'path1',index);
                                },
                                type1=1,type2=1,type3=0,prevtype2=1,
                                handlers=[];
                            if(xui.isStr(paths))paths=Raphael.parsePathString(paths);
                            // connector [type=flowchart] show two point only when dd
                            if(isConnector && connType=="flowchart"){
                                prf._ddstartFun=function(prf,index,dot){
                                    if(index===0 || index===prf._pathHandler.handlers.length-1)
                                        xui.arr.each(prf._pathHandler.handlers,function(o,i){
                                            if(i!==0 && i!==prf._pathHandler.handlers.length-1)
                                                o.dot.attr({opacity:0,r:0});
                                        });
                                };
                                prf._ddendFun=function(prf,index, dot){
                                    if(index===0 || index===prf._pathHandler.handlers.length-1)
                                        prf.boxing()._addHandler(callback);
                                };
                                manualPathModify=function(index,paths,X,Y,dot,pos){
                                    if(index===0 || index===prf._pathHandler.handlers.length-1){
                                        // move the dot itself
                                        dot.attr(pos);
                                        // modify path manually
                                        var np=prf.box._redrawBrokenLine(prf,index===0?'start':'end',X,Y);

                                        // renew paths
                                        paths.length=0;
                                        xui.arr.each(np,function(p){
                                            paths.push(p);
                                        });
                                        // stop default path modifing
                                        return false;
                                    }
                                }
                            }

                            for(var i=0, ii=paths.length, l, handler; i<ii; i++){
                                var conType;
                                if(isConnector)
                                    conType=(i===0)?"from":(i===(ii-1))?"to":null;

                                handlers.push(handler={
                                    dot:0,
                                    dotPrev:0,
                                    dotNext:0,
                                    linePrev:0,
                                    lineNext:0,
                                    linePrevPath:0,
                                    lineNextPath:0,
                                    type:paths[i][0]
                                });

                                l = paths[i].length;
                                type3=0;
                                switch (paths[i][0]) {
                                    case "M":
                                        x = zx = ox = paths[i][l - 2];
                                        y = zy = oy = paths[i][l - 1];
                                        type1=0;
                                        type2=1;
                                        break;
                                    case "L":
                                        type1=type2=1;
                                        zx = ox = paths[i][l - 2];
                                        zy = oy = paths[i][l - 1];
                                        break;
                                    case "H":
                                        type1=type2=1;
                                        zy = oy = y;
                                        zx = ox = paths[i][1];
                                        type3='H';
                                        break;
                                    case "V":
                                        type1=type2=1;
                                        zx = ox = x;
                                        zy = oy = paths[i][1];
                                        type3='V';
                                        break;
                                    case "C":
                                        type1=type2=2;
                                        ax = paths[i][l - 6];
                                        ay = paths[i][l - 5];
                                        bx = paths[i][l - 4];
                                        by = paths[i][l - 3];
                                        ox = zx = paths[i][l - 2];
                                        oy = zy = paths[i][l - 1];
                                        break;
                                    case "Q":
                                        type1=2;
                                        type2=1;
                                        ax = paths[i][l - 4];
                                        ay = paths[i][l - 3];
                                        ox = zx = paths[i][l - 2];
                                        oy = zy = paths[i][l - 1];
                                        break;
                                    case "S":
                                        type1=1;
                                        type2=2;
                                        bx = paths[i][l - 4];
                                        by = paths[i][l - 3];
                                        ox = zx = paths[i][l - 2];
                                        oy = zy = paths[i][l - 1];
                                        break;
                                    case "T":
                                        type1=type2=1;
                                        ox = zx = paths[i][l - 2];
                                        oy = zy = paths[i][l - 1];
                                        break;
                                    case "A":
                                        // TODO: to add
                                        // currently, jump to end only
                                        type1=type2=0;
                                        ox = zx = paths[i][l - 2];
                                        oy = zy = paths[i][l - 1];
                                        continue;
                                    //case "R":
                                    //case "Z":
                                    default:
                                        continue;
                                }

                                switch(type1){
                                    case 0:
                                    // no dot
                                    break;
                                    case 1:
                                    // added
                                    break;
                                    case 2:
                                        if(type=="adv"){
                                            handlers[i-1].lineNextPath=[["M", x, y], ["L", ax, ay]],
                                            handlers[i-1].lineNext=r.path(handlers[i-1].lineNextPath).attr(lineAttr);
                                            handlers[i-1].dotNext=addBezierAnchor2DD(r,el,ax,ay,i-1,conType,prf);
                                        }
                                    break;
                                }

                                switch(type2){
                                    // case 0:
                                    // no dot
                                    // break;
                                    case 1:
                                        // 1 dot
                                        handlers[i].dot=addSegmentJunctionDD(r,el,zx,zy,i,type3,conType,prf);

                                        // hide this unmovable dot
                                        if(isConnector && connType=="flowchart" && ii===3 && i===1){
                                            handlers[i].dot.attr({opacity:0,r:0});
                                        }
                                    break;
                                    case 2:
                                        // 2 dots
                                        handlers[i].dot=addSegmentJunctionDD(r,el,zx,zy,i,null,conType,prf);
                                        if(type=="adv"){
                                            handlers[i].linePrevPath=[["M", zx, zy], ["L", bx, by]],
                                            handlers[i].linePrev=r.path(handlers[i].linePrevPath).attr(lineAttr);
                                            handlers[i].dotPrev=addBezierAnchor1DD(r,el,bx,by,i,conType,prf);
                                        }
                                    break;
                                }
                                if(ox!=undefined)x=ox;
                                if(oy!=undefined)y=oy;

                                prevtype2=type2;
                            }
                            // ensure dd point on the top
                            for(var i=0, ii=paths.length, l, handler; i<ii; i++){
                                handler=handlers[i];
                                if(handler.dot)handler.dot.toFront();
                            }
                            return {
                                el:el,
                                handlers:handlers
                            }
                        }
                    },
                    move = function(dx, dy, mx, my, event) {
                        var rtn = this.update(dx - (this.dx || 0), dy - (this.dy || 0), dx, dy, false, mx, my, mx-absPos.left, my-absPos.top, event);
                        this.dx = (rtn&&rtn.dx)||dx;
                        this.dy = (rtn&&rtn.dy)||dy;

                        if(callback)callback(this, event, 'drag', this._attached);
                    },
                    start = function(mx,my,event){
                        if(callback)callback(this, event, 'beforedragstart', this._attached);
                        this.toFront();

                        this.dx = this.dy = 0;

                        magneticPos=magneticOffPos=null;

                        absPos = xui(this.paper.canvas.parentNode).offset(null);

                        var cursor=this.attr('cursor'),t;
                        this._oldCursor = (t=r.canvas.style).cursor||"";
                        t.cursor = cursor;

                        if(t=this._attached){
                            t._oldCursor=t.attr('cursor')||"";
                            t.attr("cursor", cursor);
                            t._opath=t.getPath();
                            t._obbox=Raphael.pathBBox(t._opath);

                            // get prf
                            if(prf._ddstartFun)xui.tryF(prf._ddstartFun,[prf, this._handlerIndex,this]);
                        }

                        if(callback)callback(this, event, 'dragstart', this._attached);
                    },
                    end=function(event){
                        if(callback)callback(this, event, 'beforedragend', this._attached);
                        absPos=null;

                        magneticPos=magneticOffPos=null;

                        var paper=this.paper;
                        r.canvas.style.cursor = this._oldCursor;
                        delete this._oldCursor;

                        var t;
                        if(t=this._attached){
                            t.attr('cursor',t._oldCursor);
                            delete t._oldCursor;
                            delete t._obbox;
                            delete t._opath;

                            var attr=t.attr();
                            if(isCombo){
                                xui.merge(prf.properties.attr.KEY,attr,'all');
                                attr=prf.properties.attr.KEY;
                            }else{
                                xui.merge(prf.properties.attr,attr,'all');
                                attr=prf.properties.attr;
                            }
                            if(attr.path)
                                attr.path=t.getPath().join('');

                            prf.box._notify(prf, {path:1}, true);


                            // get prf
                            if(prf._ddendFun)xui.tryF(prf._ddendFun,[prf,this._handlerIndex,this]);

                        }
                        if(t=paper._anchorShadow){
                            t.remove();
                            t.clear();
                            delete paper._anchorShadow;
                        }
                        if(callback)callback(this, event, 'dragend', this._attached);
                    },
                    createDDElem=function(obj,el,update,key,index){
                        obj._handlerIndex=index||0;
                        obj._attached=el;
                        if(update){
                            obj.drag(move,start,end);
                            obj.update=update;
                            obj.dblclick(function(event){
                                if(callback)callback(this, event, 'dblclick', el, key, index);
                            });
                            obj.click(function(event){
                                if(callback)callback(this, event, 'click', el, key, index);
                                xui.Event.stopBubble(event);
                                xui.Event.stopDefault(event);
                            });
                            obj.contextmenu(function(event){
                                if(callback)callback(this, event, 'contextmenu', el, key, index);
                            });
                            // stop select parent
                            //xui(obj.node).onContextMenu(function(){
                            //    return false;
                            //});
                        }
                        obj.toFront();
                        return obj;
                    },
                    moveFun=function (el, x, y, ax, ay, limitX1, limitX2, limitY1, limitY2){
                        switch(el.type){
                            case 'path':{
                                var paths=el.getPath(),nshape;
                                for(var i=0, ii=paths.length, l; i<ii; i++){
                                    l = paths[i].length;
                                    switch (paths[i][0]) {
                                        case "M":
                                        case "L":
                                            paths[i][1] += x;
                                            paths[i][2] += y;
                                            break;
                                        case "H":
                                            paths[i][1] += x;
                                            break;
                                        case "V":
                                            paths[i][1] += y;
                                            break;
                                        case "C":
                                            paths[i][1] += x;
                                            paths[i][2] += y;
                                            paths[i][3] += x;
                                            paths[i][4] += y;
                                            paths[i][5] += x;
                                            paths[i][6] += y;
                                            break;
                                        case "Q":
                                        case "S":
                                            paths[i][1] += x;
                                            paths[i][2] += y;
                                            paths[i][3] += x;
                                            paths[i][4] += y;
                                            break;
                                        case "T":
                                            paths[i][1] += x;
                                            paths[i][2] += y;
                                            break;
                                        case "A":
                                            paths[i][l-2] += x;
                                            paths[i][l-1] += y;
                                            continue;
                                        //case "R":
                                        //case "Z":
                                        default:
                                            continue;
                                    }
                                }
                                nshape={path: paths};
                                el.attr(nshape);
                                if(el._shape)el._shape.attr(nshape);
                                xui.tryF(el.onShapeChanged,[nshape]);
                                break;
                            }
                            case 'circle':{
                                var X1=el.attr("cx"),
                                    Y1=el.attr("cy"),
                                    X = X1 + x,
                                    Y = Y1 + y,
                                    lx=0,
                                    ly=0,rst;
                                if((limitX1===0||limitX1)&&X<(limitX1+1)){
                                    lx=X-(limitX1+1);
                                    X=(limitX1+1);
                                }
                                if((limitX2===0||limitX2)&&X>limitX2){
                                    lx=X-limitX2;
                                    X=limitX2;
                                }
                                if((limitY1===0||limitY1)&&Y<(limitY1+1)){
                                    ly=Y-(limitY1+1);
                                    Y=(limitY1+1);
                                }
                                if((limitY2===0||limitY2)&&Y>limitY2){
                                    ly=Y-limitY2;
                                    Y=limitY2;
                                }
                                rst={cx: X, cy: Y, rx:x, ry:y};
                                el.attr(rst);
                                if(el._shape)el._shape.attr(rst);
                                xui.tryF(el.onShapeChanged,[rst]);
                                rst.dx=ax-lx;
                                rst.dy=ay-ly;
                                return rst;
                            }
                            case 'ellipse':{
                                var X = el.attr("cx") + x,
                                    Y = el.attr("cy") + y,
                                    nshape={cx: X, cy: Y};
                                el.attr(nshape);
                                if(el._shape)el._shape.attr(nshape);
                                xui.tryF(el.onShapeChanged,[nshape]);
                                break;
                            }
                            case 'rect':{
                                var X = el.attr("x") + x,
                                    Y = el.attr("y") + y,
                                    nshape={x: X, y: Y};
                                el.attr(nshape);
                                if(el._shape)el._shape.attr(nshape);
                                xui.tryF(el.onShapeChanged,[nshape]);
                                break;
                            }
                            case 'text':{
                                var X = el.attr("x") + x,
                                    Y = el.attr("y") + y,
                                    nshape={x: X, y: Y};
                                el.attr(nshape);
                                if(el._shape)el._shape.attr(nshape);
                                xui.tryF(el.onShapeChanged,[nshape]);
                                break;
                            }
                        }
                    };

                if(handlers[el.type]){
                    prf._pathHandler=handlers[el.type](el);

                    el=el._shape=el.clone();
                    el.attr({"arrow-start":"none","arrow-end":"none"});
                    el.transform("").attr(el.type=='text'?shadowAttr2:shadowAttr1).toBack();
                }
            });
        }
    },
    Static:{
        $abstract:true,
        _objectProp:{attr:1},
        DataModel:{
            selectable:null,
            defaultFocus:null,
            renderer:null,
            position:null,
            disableClickEffect:null,
            disableHoverEffect:null,
            disableTips:null,
            disabled:null,
            //zIndex:null,
            left:null,
            top:null,
            right:null,
            bottom:null,
            width:null,
            height:null,

            svgTag:{
                ini:""
            },
            attr:{
                ini:{}
            },
            shadow:{
                ini:false,
                action:function(v){
                    if(v && !this._shadow){
                        this._shadow=this._elset[0].shadow();
                    }else if(this._shadow){
                        this._shadow.remove();
                        this._shadow.clear();
                        delete this._shadow;
                    }
                }
            },
            animDraw:{
                ini:'',
                combobox:['2s linear','2s ease','2s ease-in','2s ease-out','2s ease-in-out'],
                action:function(v){
                    if(!v || !Raphael.svg || this.box.$noShape)return;
                    var prf=this, e=prf._elset[0],
                        elm=e&&e.node;
                    if(!elm)return;
                    var length = elm.getTotalLength(), 
                        style=elm.style,
                        trans=function(v){style.transition = style[xui.browser.cssTag2+'Transition'] =v;},
                        bak1 = style.strokeDasharray ||'',
                        bak2 = style.strokeDashoffset||'';

                    trans('none');
                    style.strokeDasharray = length + ',' + length;
                    style.strokeDashoffset = length;
                    
                    // Trigger layout
                    elm.getBoundingClientRect();
                    trans('stroke-dashoffset '+v);

                    // restore
                    style.strokeDashoffset = 0;

                    if(prf._flowthread)xui.Thread.abort(prf._flowthread);
                    xui.setTimeout(function(t){
                        if(!prf.destroyed && e && elm){
                            trans('none');
                            style.strokeDasharray=bak1;
                            style.strokeDashoffset=bak2;

                            if(t=prf.properties.offsetFlow){
                                prf.boxing().setOffsetFlow(t,true);
                            }
                        }
                    }, parseInt(v,10)*1000);
                }
            },
            offsetFlow:{
                ini:'',
                combobox:['none','2x','4x','8x','-2x','-4x','-8x'],
                action:function(v){
                    if(!Raphael.svg || this.box.$noShape)return;
                    var prf=this, elm=prf._elset[0], arr,sum=0;
                    if(prf._flowthread)xui.Thread.abort(prf._flowthread);
                    if(v){
                        // must get the original value
                        arr=xui(elm.node).attr('stroke-dasharray');
                        if(!arr)return;
                        arr=arr.replace(/\s+/,'').split(',');
                        for(var i=0,l=arr.length;i<l;i++) sum += parseInt(arr[i],10);
                        
                        if(sum>0){
                            sum=sum*2;
                            var offset=0, speed=parseInt(v, 10);
                            if(speed){
                                prf._flowthread=xui.Thread.repeat(function(){
                                    if(prf.destroyed||!elm||!elm.attr)return false;
                                    elm.attr('stroke-dashoffset', offset = (offset + speed) % sum );
                                }, 100).id;
                            }
                        }
                    }
                }
            }
        },
        Behaviors:{
            HotKeyAllowed:false,
            HoverEffected:{KEY:'KEY'},
            ClickEffected:{KEY:'KEY'},
            onClick:function(profile, e, src){
                if(profile.$inDesign)return false;
                var p=profile.properties;
                if(p.disabled)return false;
                //onClick event
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            },
            onDblclick:function(profile, e, src){
                if(profile.$inDesign)return false;
                var p=profile.properties;
                if(p.disabled)return false;
                //onClick event
                if(profile.onDblClick)
                    return profile.boxing().onDblClick(profile, e, src);
            },
            onContextmenu:function(profile, e, src){
                if(profile.onContextmenu)
                    return profile.boxing().onContextmenu(profile, e, src)!==false;
            }
        },
        EventHandlers:{
            onClick:function(profile, e, src){},
            onDblClick:function(profile, e, src){},
            onContextmenu:function(profile, e, src){},
            onHotKeydown:null,
            onHotKeypress:null,
            onHotKeyup:null
        },
        _beforeSerialized:function(profile){
            var o = arguments.callee.upper.call(this,profile),prop=o.properties;
            prop.attr=xui.clone(prop.attr,true);
            xui.filter(prop.attr,function(o,i){
                if(i=='transform'&&(!o||o.length<1))return false;
                if(i=='href'||i=='target')return false;
                if(i=='path' && xui.isArr(prop.attr.path))prop.attr.path=o.join('');
            });
            return o;
        },
        RenderTrigger:function(){
            var prf=this,t;
            (prf.$beforeDestroy=(prf.$beforeDestroy||{}))["svgClear"]=function(){
                if(prf._flowthread)xui.Thread.abort(prf._flowthread);

                if(prf._elset){
                    prf._elset.forEach(function(el){
                        if(el)delete el._rootNode;
                    });
                    prf._elset.remove();
                    prf._elset.clear();
                    delete prf._elset;
                }
                if(prf._shadow){
                    prf._shadow.remove();
                    prf._shadow.clear();
                    delete prf._shadow;
                }
            };
            prf.box._initAttr2UI(prf);
            xui.setTimeout(function(){
                if(prf.destroyed)return;
                if(t=prf.properties.animDraw){
                    prf.boxing().setAnimDraw(t,true);
                }else if(t=prf.properties.offsetFlow){
                    prf.boxing().setOffsetFlow(t,true);
                }
            });
        },
        _RenderSVG:function(prf){
            prf._pathCached={};
            var p=prf.parent;
            if(p && p._paper && p._canvas){
                prf._elset=this._draw(p._paper, prf, prf.properties);
                for(var i=1,l=prf._elset.length;i<l;i++){
                    prf._elset._rootNode=prf._elset[0];
                }
            }
        },
        _adjustAttr:function(attr){
            var ns=this,
                attr2={},
                attr3=xui.svg.$attr;
            // get valid attr
            xui.each(attr,function(o,i){
                if(/^[A-Z_]+(_[0-9]+)?$/.test(i) && xui.isHash(o) && ((i.indexOf("_")!=-1)||( i in ns.$tagName))){
                    attr2[i]=attr2[i]||{};
                    xui.each(o,function(o1,i1){
                        if(attr3[ns.$tagName[i]|| i.split("_")[0].toLowerCase()][i1])
                            attr2[i][i1]=o1;
                    });
                }else if(attr3[ns.$tagName.KEY][i]){
                    attr2.KEY=attr2.KEY||{};
                    attr2.KEY[i]=o;
                }
            });
            return attr2;
        },
        _initAttr2UI:function(prf){
            var attr=this._adjustAttr(prf.properties.attr);
            // set svg attr
            if(prf._elset){
                prf.boxing().setAttr(attr);
            }
            if(prf.properties.shadow)
                prf.boxing().setShadow(true,true);
        },
        $adjustBB:function(key,value){
            var bb=typeof(key)=='object'?key:{},keys="left,top,right,bottom,x,y,x2,y2,width,height".split(",");
            if(typeof(key)=="string")bb[key]=value;
            xui.filter(bb,function(v,k){
                if(xui.arr.indexOf(keys,k)==-1 || v==='auto' || v==='')return false;
                if(!xui.isNumb(v)){
                    bb[k]=parseFloat(v)||0;
                    return false;
                }
            });
            if('left' in bb){bb.x=bb.left;delete bb.left;}
            if('top' in bb){bb.y=bb.top;delete bb.top;}
            if('right' in bb){bb.x2=bb.right;delete bb.right;}
            if('bottom' in bb){bb.y2=bb.bottom;delete bb.bottom;}
            // conflict
            if('x' in bb && 'width' in bb)delete bb.x2;
            if('y' in bb && 'height' in bb)delete bb.y2;
            // recaculate
            if('x2' in bb){
                if('width' in bb) bb.x=bb.x2-bb.width;
                else bb.width=bb.x2-bb.x;
                delete bb.x2;
            }
            if('y2' in bb){
                if('height' in bb)bb.y=bb.y2-bb.height;
                else bb.height=bb.y2-bb.y;
                delete bb.y2;
            }

            return bb;
        },
        $transform:function(opath,trans){
            if(!xui.isStr(opath))opath=opath.join('');
            if(/[mlhvcsqtaz]/.test(opath)){
                opath = Raphael._pathToAbsolute(opath);
            }else{
                opath=Raphael.parsePathString(opath);
            }
            var npath=Raphael.transformPath(opath,trans),
                rotate=/[r]/.test(trans);
            for(var i=0,l=npath.length,ll,t;i<l;i++){
                if(npath[i][0]!=opath[i][0]){
                    ll=npath[i].length;
                    switch (t=opath[i][0]) {
                    case "M":
                        // keep "M"
                        break;
                    case "L":
                        npath[i]=[t,npath[i][ll-2],npath[i][ll-1]];
                        break;
                    case "H":
                        if(rotate)
                            npath[i]=["L",npath[i][ll-2],npath[i][ll-1]];
                        else
                            npath[i]=[t,npath[i][ll-2]];
                        break;
                    case "V":
                        if(rotate)
                            npath[i]=["L",npath[i][ll-2],npath[i][ll-1]];
                        else
                            npath[i]=[t,npath[i][ll-1]];
                        break;
                    case "C":
                        // keep "C"
                        break;
                    case "Q":
                        npath[i]=[t,npath[i][ll-6],npath[i][ll-5],npath[i][ll-2],npath[i][ll-1]];
                        break;
                    case "S":
                        npath[i]=[t,npath[i][ll-4],npath[i][ll-3],npath[i][ll-2],npath[i][ll-1]];
                        break;
                    case "T":
                        npath[i]=[t,npath[i][ll-2],npath[i][ll-1]];
                        break;
                    case "A":
                        // keep "C"
                        break;
                    //case "R":
                    case "Z":
                        npath[i]=[t];
                        break;
                    default:
                        continue;
                    }
                }
            }
            return npath.join('');
        },
        $setBB:function(prf,type,bbox,attr,el,notify){
            var h={},
                // for IE9 cant set bbox prop
                copy=function(o){var a={};for(var i in o)a[i]=o[i];return a;};
            switch(type){
                case 'circle':{
                    if(xui.isNumb(bbox.width))
                        h.r=bbox.width/2;
                    if(xui.isNumb(bbox.height)){
                        if(bbox.height/2>=attr.r && (xui.isSet(h.r)?h.r>=attr.r:1))
                            h.r=xui.isSet(h.r)?Math.max(h.r,bbox.height/2):(bbox.height/2);
                        else
                            h.r=xui.isSet(h.r)?Math.min(h.r,bbox.height/2):(bbox.height/2);
                    }
                    h.cx=xui.isNumb(bbox.x)?(bbox.x+(xui.isSet(h.r)?h.r:attr.r)):(attr.cx+(xui.isSet(h.r)?(h.r-attr.r):0));
                    h.cy=xui.isNumb(bbox.y)?(bbox.y+(xui.isSet(h.r)?h.r:attr.r)):(attr.cy+(xui.isSet(h.r)?(h.r-attr.r):0));
                }break;
                case 'ellipse':{
                    if(xui.isNumb(bbox.width))
                        h.rx=bbox.width/2;
                    if(xui.isNumb(bbox.height))
                        h.ry=bbox.height/2;
                    h.cx=xui.isNumb(bbox.x)?(bbox.x+(xui.isSet(h.rx)?h.rx:attr.rx)):(attr.cx+(xui.isSet(h.rx)?(h.rx-attr.rx):0));
                    h.cy=xui.isNumb(bbox.y)?(bbox.y+(xui.isSet(h.ry)?h.ry:attr.ry)):(attr.cy+(xui.isSet(h.ry)?(h.ry-attr.ry):0));
                }break;
                case 'rect':
                case 'image':{
                    if(xui.isNumb(bbox.x))
                        h.x=bbox.x;
                    if(xui.isNumb(bbox.y))
                        h.y=bbox.y;
                    if(xui.isNumb(bbox.width))
                        h.width=bbox.width;
                    if(xui.isNumb(bbox.height))
                        h.height=bbox.height;
                }break;
                case 'text':{
                    var obbox,textAnchor;
                    // must get real size first
                    if(el){
                        el._.dirty=1;
                        obbox=copy(el._getBBox(true));
                        textAnchor=el.attr('text-anchor');
                    }else{
                        var div=xui.Dom.getEmptyDiv(),
                            r=Raphael(div.get(0).id,1,1),
                            t=r.text(0,0,attr.text);
                       obbox=copy(t._getBBox(true));
                       textAnchor=t.attr('text-anchor');
                       t.remove();
                       r.remove();
                       div.empty();
                    }
                    
                    if(xui.isNumb(bbox.x))
                        obbox.x=bbox.x;
                    if(xui.isNumb(bbox.y))
                        obbox.y=bbox.y;
                        
                    //if('hAlign' in prf.box.$DataModel){
                        var ha=attr.hAlign||'center',
                            va=attr.vAlign||'middle',
                            offsetx=obbox?(textAnchor=='start'?-obbox.width/2:textAnchor=='middle'?0:obbox.width/2):0;
    
                        if(xui.isNumb(bbox.x)){
                            if(ha=='center'){
                                if(xui.isNumb(bbox.width)){
                                    h.x=bbox.x + bbox.width/2;
                                }else{
                                    h.x=bbox.x+(obbox?(obbox.width/2):0);
                                }
                            }else if(ha=='left'){
                                h.x=bbox.x+(obbox?(obbox.width/2):0);
                            }else if(ha=='outterleft'){
                                h.x=bbox.x-(obbox?(obbox.width/2):0);
                            }else if(ha=='right'){
                                if(xui.isNumb(bbox.width)){
                                    h.x=bbox.x+bbox.width-(obbox?(obbox.width/2):0);
                                }else{
                                    //
                                }
                            }else if(ha=='outterright'){
                                if(xui.isNumb(bbox.width)){
                                    h.x=bbox.x+bbox.width+(obbox?(obbox.width/2):0);
                                }else{
                                    //
                                }
                            }else{
                                if(xui.isNumb(bbox.width)){
                                    h.x=bbox.x+bbox.width*parseFloat(ha)/100;
                                }else{
                                    h.x=bbox.x+(obbox?(obbox.width*parseFloat(ha)/100):0);
                                }
                            }
                            h.x += offsetx;
                        }
    
                        if(xui.isNumb(bbox.y)){
                            if(va=='middle'){
                                if(xui.isNumb(bbox.height)){
                                    h.y=bbox.y+bbox.height/2;
                                }else{
                                    h.y=bbox.y+(obbox?(obbox.height/2):0);
                                }
                            }else if(va=='top'){
                                h.y=bbox.y+(obbox?(obbox.height/2):0);
                            }else if(va=='outtertop'){
                                h.y=bbox.y-(obbox?(obbox.height/2):0);
                            }else if(va=='bottom'){
                                if(xui.isNumb(bbox.height)){
                                    h.y=bbox.y+bbox.height-(obbox?(obbox.height/2):0);
                                }else{
                                    //
                                }
                            }else if(va=='outterbottom'){
                                if(xui.isNumb(bbox.height)){
                                    h.y=bbox.y+bbox.height+(obbox?(obbox.height/2):0);
                                }else{
                                    //
                                }
                            }else{
                                if(xui.isNumb(bbox.height)){
                                    h.y=bbox.y+bbox.height*parseFloat(va)/100;
                                }else{
                                    h.y=bbox.y+(obbox?(obbox.height*parseFloat(va)/100):0);
                                }
                            }
                        }
                    /*}else{
                        if(xui.isNumb(obbox.x))
                            h.x=obbox.x;
                        if(xui.isNumb(obbox.y))
                            h.y=obbox.y;
                        if(xui.isNumb(obbox.width))
                            h.width=obbox.width;
                        if(xui.isNumb(obbox.height))
                            h.height=obbox.height;
                    }*/
                }break;
                case 'path':{
                    var obbox;
                    if(el){
                        el._.dirty=1;
                        obbox=copy(el._getBBox(true));
                    }else{
                        var div=xui.Dom.getEmptyDiv(),
                            r=Raphael(div.get(0).id,1,1),
                            t=r.path("");
                       t.attr(attr);
                       obbox=copy(t._getBBox(true));
                       t.remove();
                       r.remove();
                       div.empty();
                    }
                    var obbox2=copy(obbox);
                    
                    //if(obbox.width===0 || obbox.height===0)
                    //    return;

                    if(xui.isNumb(bbox.x))
                        h.x=bbox.x;
                    if(xui.isNumb(bbox.y))
                        h.y=bbox.y;
                    if(xui.isNumb(bbox.width))
                        h.width=bbox.width;
                    if(xui.isNumb(bbox.height))
                        h.height=bbox.height;

                    if(('x' in h && obbox.x!==h.x)||('y' in h && obbox.y!==h.y)){
                        var x=0,y=0;
                        if('x' in h){
                            x=h.x-obbox.x;
                            obbox.x=h.x;
                        }
                        if('y' in h){
                            y=h.y-obbox.y;
                            obbox.y=h.y;
                        }

                        var paths=Raphael.parsePathString(attr.path);
                        for(var i=0, ii=paths.length, l; i<ii; i++){
                            l = paths[i].length;
                            switch (paths[i][0]) {
                                case "M":
                                case "L":
                                    paths[i][1] += x;
                                    paths[i][2] += y;
                                    break;
                                case "H":
                                    paths[i][1] += x;
                                    break;
                                case "V":
                                    paths[i][1] += y;
                                    break;
                                case "C":
                                    paths[i][1] += x;
                                    paths[i][2] += y;
                                    paths[i][3] += x;
                                    paths[i][4] += y;
                                    paths[i][5] += x;
                                    paths[i][6] += y;
                                    break;
                                case "Q":
                                case "S":
                                    paths[i][1] += x;
                                    paths[i][2] += y;
                                    paths[i][3] += x;
                                    paths[i][4] += y;
                                    break;
                                case "T":
                                    paths[i][1] += x;
                                    paths[i][2] += y;
                                    break;
                                case "A":
                                    paths[i][l-2] += x;
                                    paths[i][l-1] += y;
                                    continue;
                                //case "R":
                                //case "Z":
                                default:
                                    continue;
                            }
                        }
                        h.path=paths.join('');
                    }
                    if(('width' in h && obbox.width!==h.width)||('height' in h && obbox.height!==h.height)){
                        var ww=('width' in h)?h.width:null,
                            hh=('height' in h)?h.height:null,
                            opath= h.path ||attr.path,
                            npath=xui.svg.$transform(opath, "s"+((xui.isSet(ww)&&ww!==obbox2.width)?(obbox2.width===0?(ww>=0?1.1:0.9):ww/obbox2.width):"1")+","+((xui.isSet(hh)&&hh!==obbox2.height)?(obbox2.height===0?(hh>=0?1.1:0.9):hh/obbox2.height):"1")+","+obbox.x+","+obbox.y);
                        h.path=npath;
                    }
                }break;
            }

            var attr2=xui.svg.$attr[type];
            xui.filter(h,function(o,i){
                if(xui.isSet(o) && (i in attr2)){
                    attr[i]=o;
                }else{
                    return false;
                }
            });
            if(el && (!xui.isEmpty(h))){
                // keep transfrom
                var ts=Raphael.parseTransformString(el.transform()),withTransform;
                if(ts && ts.length){
                    withTransform=1;
                    el.transform("");

                    //for rotate setting
                    var ir=-1, it=-1, rot; 
                    for(var i=0,l=ts.length; i<l; i++){
                        if(ts[i][0]=='r'){
                            ir = i;
                            rot = ts[i][1];
                        }else if(ts[i][0]=='t'){
                            it = i;
                        }
                    }
                    if(it!=-1 && ir!=-1){
                        // recalculate it back precisely
                        el.rotate(rot);
                        var ts2=Raphael.parseTransformString(el.transform());
                        //reset it gain
                        el.transform("");
                        ts[it][1]-=ts2[0][1];
                        ts[it][2]-=ts2[0][2];
                        
                        if(!ts[it][1] && !ts[it][2]){
                            xui.arr.removeFrom(ts, it);
                        }
                    }
                }

                el.attr(h);

                // reset transform
                if(withTransform){
                    el.transform("r"+rot);
                }

                if(notify!==false)
                    prf.box._notify(prf,{bBox:1},true);
            }
        },
        _syncAttr:function(prf,options,shapeChanged){
            prf._pathCached={};
        },
        _notify:function(prf, options, shapeChanged){
            // sync attr
            if(prf.box._syncAttr){
                prf.box._syncAttr(prf,options,shapeChanged);
            }
            // sync connectors
            if(shapeChanged && !prf.box._CONNECTOR && prf.box._syncConnectors){
                prf.box._syncConnectors(prf);
            }
            // refresh shadow
            if(shapeChanged && prf._shadow){
                prf.boxing().setShadow(false).setShadow(true);
            }
        },
        _draw:function(){},

        _syncConnectors:function(prf){
            // find all connectors connected to me
            // redraw those connectors
            if(prf.parent.key!=="xui.UI.SVGPaper")return;

            var children=xui.get(prf,['parent','children']),
                alias=prf.alias;
            if(children&&children.length){
                xui.arr.each(children,function(o,i){
                    if(!o[0].destroyed && prf.renderCompleted && o[0].renderCompleted && o[0].key==="xui.svg.connector"){
                        if(alias===xui.get(o[0],['properties','fromObj'])){
                            // redraw from point
                            o[0].box._reconnect(o[0],prf);
                        }
                        if(alias===xui.get(o[0],['properties','toObj'])){
                            // redraw to point
                            o[0].box._reconnect(o[0],null,prf);
                        }
                    }
                });
            }
        },
        _syncAlias:function(prf,oa,na){
            // find all connectors connected on me, sync alias
            var children=xui.get(prf,['parent','children']);
            if(children&&children.length){
                xui.arr.each(children,function(o,i){
                    if(o[0].key==="xui.svg.connector"){
                        if(oa===xui.get(o[0],['properties','fromObj'])){
                            xui.set(o[0],['properties','fromObj'],na);
                        }
                        if(oa===xui.get(o[0],['properties','toObj'])){
                            xui.set(o[0],['properties','toObj'],na);
                        }
                    }
                });
            }
        }
    }
});

xui.Class("xui.svg.circle", "xui.svg",{
    Instance:{
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'circle', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        DataModel:{
            attr:{
                ini:{cx:0,cy:0,r:20}
            }
        },
        Templates:{
            tagName:'circle'
        },
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.circle(prop.cx,prop.cy,prop.r);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        }
    }
});
xui.Class("xui.svg.ellipse", "xui.svg",{
    Instance:{
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'ellipse', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        DataModel:{
            attr:{
                ini:{cx:0,cy:0,rx:20,ry:40}
            }
        },
        Templates:{
            tagName:'ellipse'
        },
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.ellipse(prop.cx,prop.cy,prop.rx,prop.ry);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        }
    }
});
xui.Class("xui.svg.rect", "xui.svg",{
    Instance:{
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'rect', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        DataModel:{
            attr:{
                ini:{x:0,y:0,r:0,width:40,height:40}
            }
        },
        Templates:{
            tagName:'rect'
        },
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.rect(prop.x,prop.y,prop.width,prop.height,prop.r);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        }
    }
});
xui.Class("xui.svg.image", "xui.svg",{
    Instance:{
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'image', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        $noShape:1,
        IMGNODE:1,
        DataModel:{
            attr:{
                ini:{src:"",x:0,y:0,width:20,height:20}
            }
        },
        Templates:{
            tagName:'image'
        },
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.image(xui.adjustRes(prop.src),prop.x,prop.y,prop.width,prop.height);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        }
    }
});
xui.Class("xui.svg.text", "xui.svg",{
    Instance:{
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'text', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        $noShape:1,
        DataModel:{
            attr:{
                ini:{x:0,y:0,text:"text"}
            },
            text:{
                ini:undefined,
                hidden:true,
                set:function(value){
                    this.boxing().setAttr('KEY',{text:this.properties.text=value||""},false);
                }
            }
        },
        Templates:{
            tagName:'text'
        },
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.text(prop.x,prop.y,prop.text);
            if(xui.isSet(prop.text))el.attr('text',prop.text);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        }
    }
});
xui.Class("xui.svg.path", "xui.svg",{
    Instance:{
        getPath:function(){
            var prf=this.get(0),prop=prf.properties;
            if(prf._elset && prf._elset[0])prop.path=prf._elset[0].attr('path').join('');
            return prop.path;
        },
        _getConnectAnchors:function(){
            // no solid anchors
        },
        _setBBox:function(key,value){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                xui.svg.$setBB(prf,'path', bb, prf.properties.attr, prf._elset&&prf._elset[0]);
            });
        }
    },
    Static:{
        $abstract:true,
        _draw:function(paper, prf, prop){
            prop=prop.attr;
            var el = paper.path(prop.path);
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            return paper.set().push(el);
        },
        DataModel:{
            attr:{
                ini:{path:""}
            }
        },
        Templates:{
            tagName:'path'
        }
    }
});

xui.Class("xui.svg.absComb", "xui.svg",{
    Instance:{
        _setBBox:function(key,value,notify){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                var prop=prf.properties, ss=prf._elset;
                xui.svg.$setBB(prf,prf.box._type, bb, prop.attr.KEY, ss&&ss[0]);

                if(prf.renderId && ss&&ss[0]){
                    if(prop.attr.TEXT&&prop.attr.TEXT.text){
                        var attr=xui.copy(prop.attr.TEXT||{}),att2=ss[0]._getBBox(true);
                        attr.hAlign=prop.hAlign;
                        attr.vAlign=prop.vAlign;
                        if(!('x' in bb))bb.x=att2.x;
                        if(!('y' in bb))bb.y=att2.y;
                        if(!('width' in bb))bb.width=att2.width;
                        if(!('height' in bb))bb.height=att2.height;
                        xui.svg.$setBB(prf,"text", bb, attr, ss&&ss[1],notify);
                    }
                }
            });
        },
        _adjustText:function(){
            return this.each(function(prf){
                var prop=prf.properties, ss=prf._elset;
                if(prf.renderId && ss && ss[0]){
                    if(prop.attr.TEXT && prop.attr.TEXT.text){
                        var attr=xui.copy(prop.attr.TEXT||{}),att2=ss[0]._getBBox(true);
                        attr.hAlign=prop.hAlign;
                        attr.vAlign=prop.vAlign;
                        xui.svg.$setBB(prf,"text", att2, attr, ss[1], false);
                    }
                }
            });
        },
        setAttr:function(key, value, reset, notify){
            var h;
            if(xui.isHash(key))h=key;
            else{
                h={};
                h[key]=value;
            };
            arguments.callee.upper.call(this, key, value, reset, notify);
            return this.each(function(prf){
                if(prf._elset){
                    // adjust text postion
                    if((h=h.TEXT)&&h['text-anchor'])
                        prf.boxing()._adjustText();
                }
            });
        }
    },
    Static:{
        $abstract:true,
        ISCOMBO:1,
        _beforeSerialized:function(profile){
            var o = arguments.callee.upper.call(this,profile),prop=o.properties;
            prop.attr=xui.clone(prop.attr,true);
            xui.filter(prop.attr.KEY,function(o,i){
                if(i=='transform'&&(!o||o.length<1))return false;
                if(i=='href'||i=='target')return false;
                if(i=='path' && xui.isArr(prop.attr.KEY.path))prop.attr.KEY.path=o.join('');
            });
            if(prop.attr.TEXT){
                xui.filter(prop.attr.TEXT,function(o,i){
                    // TEXT's transform is from KEY
                    if(i=='transform')return false;
                    // TEXT's postition is caculated from KEY
                    if(i=='x'||i=='y')return false;
                    if(i=='href'||i=='target')return false;
                });
            }
            delete prop.text;
            return o;
        },
        DataModel:{
            attr:{
                ini:{
                    KEY:{
                    },
                    TEXT:{
                    }
                }
            },
            hAlign:{
                ini:'center',
                combobox:['left','25%','center','75%','right','outterleft','outterright'],
                action: function(){
                    // adjust text postion
                    this.boxing()._adjustText();
                }
            },
            vAlign:{
                ini:'middle',
                combobox:['top','25%','middle','75%','bottom','outtertop','outterbottom'],
                action: function(){
                    // adjust text postion
                    this.boxing()._adjustText();
                }
            },
            text:{
                ini:undefined,
                hidden:true,
                get:function(){
                    var att=this.boxing().getAttr('TEXT');
                    return att&&att.text;
                },
                set:function(value){
                        this.boxing().setAttr('TEXT',{text:value||""},false);
                }
            },
            shadow:true
        },
        Behaviors:{
            onClick:function(profile, e, src){
                if(profile.$inDesign)return false;
                var p=profile.properties;
                if(p.disabled)return false;
                //onClick event
                if(profile.onClick)
                    return profile.boxing().onClick(profile, e, src);
            },
            onDblclick:function(profile, e, src){
                if(profile.$inDesign)return false;
                var p=profile.properties;
                if(p.disabled)return false;
                //onClick event
                if(profile.onDblClick)
                    return profile.boxing().onDblClick(profile, e, src);
            },            
            onContextmenu:function(profile, e, src){
                if(profile.onContextmenu)
                    return profile.boxing().onContextmenu(profile, e, src)!==false;
            },
            TEXT:{
                onClick:function(profile, e, src){
                    if(profile.$inDesign)return false;
                    var p=profile.properties,rtn;
                    if(p.disabled)return false;
                    //onClick event
                    if(profile.onTextClick)
                        rtn=profile.boxing().onTextClick(profile, e, src);
                    if(rtn!==false && profile.onClick)
                        return profile.boxing().onClick(profile, e, src);
                },
                onDblclick:function(profile, e, src){
                    if(profile.$inDesign)return false;
                    var p=profile.properties;
                    if(p.disabled)return false;
                    //onClick event
                    if(profile.onDblClick)
                        return profile.boxing().onDblClick(profile, e, src);
                },
                onContextmenu:function(profile, e, src){
                    if(profile.onContextmenu)
                        return profile.boxing().onContextmenu(profile, e, src)!==false;
                }
            }
        },
        EventHandlers:{
            onTextClick:function(profile, e, src){}
        },
        _initAttr2UI:function(prf){
            arguments.callee.upper.call(this,prf);

            // adjust text postion
            prf.boxing()._adjustText();

            // transform
            var ss=prf._elset;
            if(ss&&ss[1]){
                var tf=ss[0].attr('transform');
                for(var i=1,l=ss.length;i<l;i++)
                    ss[i].attr('transform', tf);
            }
        },
        _syncAttr:function(prf,options,shapeChanged){
            var upper=arguments.callee.upper, args=xui.toArr(arguments);
            upper.apply(this,args);
            upper=null;
            if(shapeChanged){
                prf.boxing()._adjustText();
            }
        },
        _draw:function(paper, prf, prop){
            var s=paper.set(), attr=prop.attr.KEY,att2=prop.attr.TEXT,
                el = this._drawRoot(paper,attr);

            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            s.push(el);

            el = paper.text(attr.x, attr.y, att2.text);
            el.node.id=prf.box.KEY+"-TEXT:"+prf.serialId+":";
            s.push(el);

            return s;
        }
    }
});
xui.Class("xui.svg.rectComb", "xui.svg.absComb",{
    Static:{
        _type:'rect',
        Templates:{
            tagName:'rect',
            TEXT:{
                tagName:'text',
                svg:1
            }
        },
        _drawRoot:function(paper,attr){
            return paper.rect(attr.x,attr.y,attr.width,attr.height);
        }
    }
});
xui.Class("xui.svg.circleComb", "xui.svg.absComb",{
    Static:{
        _type:'circle',
        Templates:{
            tagName:'circle',
            TEXT:{
                tagName:'text',
                svg:1
            }
        },
        _drawRoot:function(paper,attr){
            return paper.circle(attr.cx,attr.cy,attr.r);
        }
    }
});
xui.Class("xui.svg.ellipseComb", "xui.svg.absComb",{
    Static:{
        _type:'ellipse',
        Templates:{
            tagName:'ellipse',
            TEXT:{
                tagName:'text',
                svg:1
            }
        },
        _drawRoot:function(paper,attr){
            return paper.ellipse(attr.cx,attr.cy,attr.rx,attr.ry);
        }
    }
});
xui.Class("xui.svg.pathComb", "xui.svg.absComb",{
    Static:{
        _type:'path',
        Templates:{
            tagName:'path',
            TEXT:{
                tagName:'text',
                svg:1
            }
        },
        _drawRoot:function(paper,attr){
            return paper.path(attr.path);
        }
    }
});
xui.Class("xui.svg.imageComb", "xui.svg.absComb",{
    Static:{
        IMGNODE:1,
        $noShape:1,
        _type:'image',
        Templates:{
            tagName:'image',
            TEXT:{
                tagName:'text',
                svg:1
            }
        },
        _drawRoot:function(paper,attr){
            return paper.image(attr.src,attr.x,attr.y,attr.width,attr.height);
        }
    }
});


xui.Class("xui.svg.connector","xui.svg.absComb",{
    Instance:{
        _getConnectAnchors:null,
        _getConnectPath:null,
        _getConnectPoint:null,
        toFront:function(){
            return this.each(function(prf){
                if(prf=prf._elset){
                    prf[1].toFront();
                    prf[0].toFront();
                }
                var arr=xui.get(prf,['parent','children']);
                if(arr && arr.length){
                    var index=xui.arr.subIndexOf(arr,"0",prf),o;
                    if(index!=-1){
                        o=arr[index];
                        arr.splice(index,1);
                        arr.push(o);
                    }
                }
            });
        },
        toBack:function(){
            return this.each(function(prf){
                if(prf=prf._elset){
                    prf[0].toBack();
                    prf[1].toBack();
                }
                var arr=xui.get(prf,['parent','children']);
                if(arr && arr.length){
                    var index=xui.arr.subIndexOf(arr,"0",prf),o;
                    if(index!=-1){
                        o=arr[index];
                        arr.splice(index,1);
                        arr.unshift(o);
                    }
                }
            });
        }
    },
    Static:{
        _CONNECTOR:true,
        _beforeSerialized:function(profile){
            var o = arguments.callee.upper.call(this,profile),prop=o.properties;
            if(prop.attr.BG){
                delete prop.attr.BG.path;
                delete prop.attr.BG['arrow-start'];
                delete prop.attr.BG['arrow-end'];
            }
            return o;
        },
        DataModel:{
            hAlign:null,
            vAlign:null,
            shadow:null,

            bgLine:{
                ini:true,
                action:function(v){
                    if(this._bg){
                        if(v)this._bg.show();else this._bg.hide();
                    }
                }
            },
            attr:{
                ini:{
                    KEY:{path:""}//,
                   // TEXT:{text:""}
                }
            },
            type:{
                ini:'straight',
                listbox:['straight','bezier','flowchart'],
                action:function(v,ov){
                    // stop changing type
                    if(this.renderId)
                        this.properties.type=ov;
                }
            },
            fromObj:"",
            fromPoint:{
                ini:'',
                combobox:['left','top','right','bottom']
            },
            //fromDDKey:"default",

            toObj:"",
            toPoint:{
                ini:'',
                combobox:['left','top','right','bottom']
            }//,
            //toDDKey:"default",

            //textPos:0.5

        },
        _type:'path',
        Templates:{
            tagName:'path',
          /*  TEXT:{
                tagName:'text',
                svg:1
            },*/
            BG:{
                tagName:'path',
                svg:1
            }
        },
        _draw:function(paper, prf, prop){
           var s=paper.set(),
               attr=prop.attr.KEY,//att2=prop.attr.TEXT,
               obj1,obj2;

            obj2 = paper.path(attr.path);
            obj2.node.id=prf.box.KEY+":"+prf.serialId+":";
            obj2.onShapeChanged=function(attr){
                if(attr.path)obj1.attr({path:attr.path},null,false);
            };
            s.push(obj2);

            obj1 = paper.path(attr.path);
            
            if(!prf.properties.bgLine)obj1.hide();
            
            obj1.node.id=prf.box.KEY+"-BG:"+prf.serialId+":";
            s.push(obj1);
            obj1.insertBefore(obj2);
            prf._bg=obj1;

            (prf.$beforeDestroy=(prf.$beforeDestroy||{}))["unbind"]=function(){
                obj2.onShapeChanged=null;
                obj2=null;
            };

            /*
                        el = paper.text(attr.x, attr.y, att2.text);
                        el.node.id=prf.box.KEY+"-TEXT:"+prf.serialId+":";
                        s.push(el);
            */
            return s;
        },
        _syncAttr:function(prf,options,shapeChanged){
            var upper=arguments.callee.upper,args=xui.toArr(arguments);
            upper.apply(this,args);
            upper=null;
            prf._pathCached={};

            if(!prf._bg)return;

            var ns=this,prop=prf.properties,t=prf._elset[0],h={},a,k;
            k='path';
            if((k in options) || ('bBox' in options)){
                h[k]=t.attr(k);
            }
            k='arrow-start';
            if(k in options){
                a=t.attr(k);
                a=a.split('-');
                if(a[0]!='none')h[k]=a[0]+"-narrow-short";
                else h[k]='none';
            }
            k='arrow-end';
            if(k in options){
                a=t.attr(k);
                a=a.split('-');
                if(a[0]!='none')h[k]=a[0]+"-narrow-short";
                else h[k]='none';
            }
            prf._bg.attr(h,null,false);

            if(('bBox' in options) && prf.parent){
                if(prop.fromObj&&prop.fromPoint){
                    xui.arr.each(prf.parent.children,function(o){
                        if(o[0].alias==prop.fromObj){
                            ns._reconnect(prf,o[0]);
                            return false;
                        }
                    });
                }
                if(prop.toObj&&prop.toPoint){
                    xui.arr.each(prf.parent.children,function(o){
                        if(o[0].alias==prop.toObj){
                            ns._reconnect(prf,null,o[0]);
                            return false;
                        }
                    });
                }

            }
        },
        // have to set to null
        _reconnect:function(prf,fromPrf,toPrf){
            if(prf.destroyed)return;
            var prop=prf.properties,
                type=prop.type,
                path=Raphael.parsePathString(prop.attr.KEY.path),
                conn=prf.boxing(),
                ins,cp;
            if(fromPrf && prop.fromObj && prop.fromPoint){
                ins=fromPrf.boxing();
                cp=ins._getConnectPoint(prop.fromPoint);
                if(cp){
                    switch(type){
                        case 'flowchart':
                            // need to redraw it
                            var np=this._redrawBrokenLine(prf);
                            if(np){
                                // renew paths
                                path.length=0;
                                xui.arr.each(np,function(p){
                                    path.push(p);
                                });
                            }
                        break;
                        case 'straight':
                            path[0][1]=cp.x;
                            path[0][2]=cp.y;
                        break;
                        case 'bezier':
                            var ox=cp.x-path[0][1],
                                oy=cp.y-path[0][2];
                            path[0][1]=cp.x;
                            path[0][2]=cp.y;
                            path[1][1]+=ox;
                            path[1][2]+=oy;
                        break;
                    }
                    conn.setAttr("KEY",{path:path},false);
                }
            }
            if(toPrf && prop.toObj  && prop.toPoint){
                ins=toPrf.boxing();
                cp=ins._getConnectPoint(prop.toPoint);
                if(cp){
                    var l=path.length-1;
                    if( (path[l][0]||"").toUpperCase()=='Z')l--;
                    switch(type){
                        case 'flowchart':
                            // need to redraw it
                            var np=this._redrawBrokenLine(prf);
                            if(np){
                                // renew paths
                                path.length=0;
                                xui.arr.each(np,function(p){
                                    path.push(p);
                                });
                            }
                        break;
                        case 'straight':
                            path[l][1]=cp.x;
                            path[l][2]=cp.y;
                        break;
                        case 'bezier':
                            var ox=cp.x-path[l][5],
                                oy=cp.y-path[l][6];
                            path[l][5]=cp.x;
                            path[l][6]=cp.y;
                            path[l][3]+=ox;
                            path[l][4]+=oy;
                        break;
                    }
                    conn.setAttr("KEY",{path:path},false);
                }
            }
        },
        _redrawBrokenLine:function(prf,inputPoint,x,y){
            var offset=30,
                offsetx=30,
                offsety=30,
                prop=prf.properties,
                attr=prop.attr.KEY,
                opath=Raphael.parsePathString(attr.path),
                startConn=prop.fromObj && prop.fromPoint,
                endConn=prop.toObj && prop.toPoint,
                startPoints,endPoints,
                startPath=[],endPath=[],
                startPathLen=[],endPathLen=[],
                ins,
                sPath,ePath,sBox,eBox,
                sPoint,ePoint,angle,sCenter,eCenter,
                sdir,edir,
                t;
            // Collect possible start points
            if(startConn){
                ins=null;
                //startPoints 3
                xui.arr.each(prf.parent.children,function(p){
                    if(p[0].alias==prop.fromObj){
                        ins=p[0].boxing();
                        sPoint=ins._getConnectPoint(prop.fromPoint);
                        if(sPoint){
                            sPath=ins._getConnectPath();

                            if(sBox=xui.get(p[0]._pathCached,['_connBBox'])){
                            }else{
                                sBox=Raphael.pathBBox(sPath);
                                xui.set(p[0]._pathCached,['_connBBox'], sBox)
                            }

                            if(sPoint.solid){
                                angle=sPoint.alpha;
                            }else{
                                angle=sPoint.alpha-90;
                            }
                            sCenter={x:sBox.x+sBox.width/2,y:sBox.y+sBox.height/2};
                            sdir = (angle>45&&angle<=135)?'down':
                                  (angle>135&&angle<=225)?'left':
                                  (angle>225&&angle<=315)?'up':'right';
                            if(sdir=='down'&&sPoint.y<sCenter.y)
                                sdir='up';
                            if(sdir=='right'&&sPoint.x<sCenter.x)
                                sdir='left';
                        }
                        return false;
                    }
                });
            }
            if(endConn){
                ins=null;
                //endPoints 3
                xui.arr.each(prf.parent.children,function(p){
                    if(p[0].alias==prop.toObj){
                        ins=p[0].boxing();
                        ePoint=ins._getConnectPoint(prop.toPoint);
                        if(ePoint){
                            ePath=ins._getConnectPath();

                            if(eBox=xui.get(p[0]._pathCached,['_connBBox'])){
                            }else{
                                eBox=Raphael.pathBBox(ePath);
                                xui.set(p[0]._pathCached,['_connBBox'], eBox)
                            }

                            if(ePoint.solid){
                                angle=ePoint.alpha;
                            }else{
                                angle=ePoint.alpha-90;
                            }
                            eCenter={x:eBox.x+eBox.width/2,y:eBox.y+eBox.height/2};
                            edir = (angle>45&&angle<=135)?'down':
                                  (angle>135&&angle<=225)?'left':
                                  (angle>225&&angle<=315)?'up':'right';
                            if(edir=='down'&&ePoint.y<eCenter.y)
                                edir='up';
                            if(edir=='right'&&ePoint.x<eCenter.x)
                                edir='left';
                        }
                        return false;
                    }
                });
            }
            if(sPoint&&ePoint){
                // These points can link to each other directly(opposite)
                if((sdir=='left'&&edir=='right'&&ePoint.x>=sPoint.x)||(sdir=='right'&&edir=='left'&&ePoint.x<=sPoint.x))
                    offsetx=Math.min(offsetx, Math.abs(ePoint.x-sPoint.x)/2);
                if((sdir=='down'&&edir=='up'&&ePoint.y>=sPoint.y)||(sdir=='up'&&edir=='down'&&ePoint.y<=sPoint.y))
                    offsety=Math.min(offsety, Math.abs(ePoint.y-sPoint.y)/2);
            }

            // Collect possible start points
            if(sPoint){
                switch(sdir){
                    case 'down':{
                    startPoints=[
                        {x:sPoint.x, y:t=sPoint.y+offsety},
                        {x:sBox.x-offset, y:t},
                        {x:sBox.x+offset+sBox.width, y:t}
                    ];
                    startPath=[
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y]],
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y],["H",startPoints[1].x]],
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y],["H",startPoints[2].x]]
                    ];
                    startPathLen=[offsety, offsety + Math.abs(startPoints[1].x-startPoints[0].x), offsety + Math.abs(startPoints[2].x-startPoints[0].x)];
                    }break;
                    case 'left':{
                    startPoints=[
                        {x:t=sPoint.x-offsetx, y:sPoint.y},
                        {x:t,y:sBox.y-offset},
                        {x:t,y:sBox.y+offset+sBox.height}
                    ];
                    startPath=[
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x]],
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x],["V",startPoints[1].y]],
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x],["V",startPoints[2].y]]
                    ];
                    startPathLen=[offsetx, offsetx + Math.abs(startPoints[1].y-startPoints[0].y), offsetx + Math.abs(startPoints[2].y-startPoints[0].y)];
                    }break;
                    case 'up':{
                    startPoints=[
                        {x:sPoint.x, y:t=sPoint.y-offsety},
                        {x:sBox.x-offset, y:t},
                        {x:sBox.x+offset+sBox.width, y:t}
                    ];
                    startPath=[
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y]],
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y],["H",startPoints[1].x]],
                        [["M",sPoint.x,sPoint.y],["V",startPoints[0].y],["H",startPoints[2].x]]
                    ];
                    startPathLen=[offsety, offsety + Math.abs(startPoints[1].x-startPoints[0].x), offsety + Math.abs(startPoints[2].x-startPoints[0].x)];
                    }break;
                    case 'right':{
                    startPoints=[
                        {x:t=sPoint.x+offsetx, y:sPoint.y},
                        {x:t,y:sBox.y-offset},
                        {x:t,y:sBox.y+offset+sBox.height}
                    ];
                    startPath=[
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x]],
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x],["V",startPoints[1].y]],
                        [["M",sPoint.x,sPoint.y],["H",startPoints[0].x],["V",startPoints[2].y]]
                    ];
                    startPathLen=[offsetx, offsetx + Math.abs(startPoints[1].y-startPoints[0].y), offsetx + Math.abs(startPoints[2].y-startPoints[0].y)];
                    }break;
                }
            }else{
                if(inputPoint=='start'){
                    startPoints=[{x:x,y:y}];
                }else{
                    startPoints=[{x:opath[0][1],y:opath[0][2]}];
                }
                startPath=[
                    [["M",startPoints[0].x,startPoints[0].y]]
                ];
                startPathLen=[0];
            }
            // Collect possible end points
            if(ePoint){
                switch(edir){
                    case 'down':{
                    endPoints=[
                        {x:ePoint.x, y:t=ePoint.y+offsety},
                        {x:eBox.x-offset, y:t},
                        {x:eBox.x+offset+eBox.width, y:t}
                    ];
                    endPath=[
                        [["V",ePoint.y]],
                        [["H",ePoint.x],["V",ePoint.y]],
                        [["H",ePoint.x],["V",ePoint.y]]
                    ];
                    endPathLen=[offsety, offsety + Math.abs(endPoints[1].x-endPoints[0].x), offsety + Math.abs(endPoints[2].x-endPoints[0].x)];
                    }break;
                    case 'left':{
                    endPoints=[
                        {x:t=ePoint.x-offsetx, y:ePoint.y},
                        {x:t,y:eBox.y-offset},
                        {x:t,y:eBox.y+offset+eBox.height}
                    ];
                    endPath=[
                        [["H",ePoint.x]],
                        [["V",ePoint.y],["H",ePoint.x]],
                        [["V",ePoint.y],["H",ePoint.x]]
                    ];
                    endPathLen=[offsetx, offsetx + Math.abs(endPoints[1].y-endPoints[0].y), offsetx + Math.abs(endPoints[2].y-endPoints[0].y)];
                    }break;
                    case 'up':{
                    endPoints=[
                        {x:ePoint.x, y:t=ePoint.y-offsety},
                        {x:eBox.x-offset, y:t},
                        {x:eBox.x+offset+eBox.width, y:t}
                    ];
                    endPath=[
                        [["V",ePoint.y]],
                        [["H",ePoint.x],["V",ePoint.y]],
                        [["H",ePoint.x],["V",ePoint.y]]
                    ];
                    endPathLen=[offsety, offsety + Math.abs(endPoints[1].x-endPoints[0].x), offsety + Math.abs(endPoints[2].x-endPoints[0].x)];
                    }break;
                    case 'right':{
                    endPoints=[
                        {x:t=ePoint.x+offsetx, y:ePoint.y},
                        {x:t,y:eBox.y-offset},
                        {x:t,y:eBox.y+offset+eBox.height}
                    ];
                    endPath=[
                        [["H",ePoint.x]],
                        [["V",ePoint.y],["H",ePoint.x]],
                        [["V",ePoint.y],["H",ePoint.x]]
                    ];
                    endPathLen=[offsetx, offsetx + Math.abs(endPoints[1].y-endPoints[0].y), offsetx + Math.abs(endPoints[2].y-endPoints[0].y)];
                    }break;
                }
            }else{
                if(inputPoint=='end'){
                    endPoints=[{x:x,y:y}];
                }else{
                    var p={x:opath[0][1],y:opath[0][2]};
                    xui.arr.each(opath,function(o){
                        if(o[0]=='H')p.x=o[1];
                        else p.y=o[1];
                    });
                    endPoints=[p];
                }
                endPath=[];
                endPathLen=[0];
            }

            // Collect all possible paths
            var paths=[],path,inter;
            xui.arr.each(startPoints,function(sp,i){
                xui.arr.each(endPoints,function(ep,j){
                    for(var k=0;k<=1;k++){
                        path=xui.clone(startPath[i],true);
                        if(k===0){
                            if(ep.x!==sp.x)path.push(['H',ep.x]);
                            if(ep.y!==sp.y)path.push(['V',ep.y]);
                        }else{
                            if(ep.y!==sp.y)path.push(['V',ep.y]);
                            if(ep.x!==sp.x)path.push(['H',ep.x]);
                        }
                        if(endPath[j] && endPath[j].length)xui.arr.insertAny(path, endPath[j]);

                        paths.push({
                            path:path,
                            len:path.length,
                            len2:(startPathLen[i]||0)+(endPathLen[j]||0)+Math.abs(ep.x-sp.x)+Math.abs(ep.y-sp.y)
                        });
                    }
                });
            });

            // filter repeat segments
            var arr=[];
            xui.filter(paths,function(o){
                var ox=o.path[0][1],
                    oy=o.path[0][2],
                    xdir,ydir,
                    preType;
                for(var i=1,l=o.path.length;i<l;i++){
                    if(preType==o.path[i][0]){
                        if(preType=='H'){
                            if((o.path[i][1]>ox)===xdir){
                                // filter the segement
                                o.path.splice(i-1,1);
                                o.len--;
                                l--;
                                i--;
                                continue;
                            }else{
                                // filter the whole path
                                return false;
                            }
                        }else{
                            if((o.path[i][1]>oy)===ydir){
                                // filter the segement
                                o.path.splice(i-1,1);
                                o.len--;
                                l--;
                                i--;
                                continue;
                            }else{
                                // filter the whole path
                                return false;
                            }
                        }
                    }
                    if(o.path[i][0]=='H'){
                        xdir=o.path[i][1]>ox;
                        ox=o.path[i][1];
                    }else{
                        ydir=o.path[i][1]>oy;
                        oy=o.path[i][1];
                    }
                    preType=o.path[i][0];
                }
            });

            // caculate cross count
            xui.arr.each(paths,function(o){
                inter=0;
                var cx,cy;
                if(sBox||eBox){
                    cx=o.path[0][1];cy=o.path[0][2];
                    xui.arr.each(o.path,function(p,i){
                        if(i!==0){
                            if(p[0]=='H'){
                                if(sBox && cy>=sBox.y && cy<=sBox.y2 && Math.max(cx,p[1])>Math.min(sBox.x,sBox.x2) && Math.min(cx,p[1])<Math.max(sBox.x,sBox.x2))inter++;
                                if(eBox && cy>=eBox.y && cy<=eBox.y2 && Math.max(cx,p[1])>Math.min(eBox.x,eBox.x2) && Math.min(cx,p[1])<Math.max(eBox.x,eBox.x2))inter++;
                                cx=p[1];
                            }else{
                                if(sBox && cx>=sBox.x && cx<=sBox.x2 && Math.max(cy,p[1])>Math.min(sBox.y,sBox.y2) && Math.min(cy,p[1])<Math.max(sBox.y,sBox.y2))inter++;
                                if(eBox && cx>=eBox.x && cx<=eBox.x2 && Math.max(cy,p[1])>Math.min(eBox.y,eBox.y2) && Math.min(cy,p[1])<Math.max(eBox.y,eBox.y2))inter++;
                                cy=p[1];
                            }
                        }
                    });
                }
                o.inter=inter;
            });

            // Sort paths by path length
			// < 22, stable sort
            xui.arr.stableSort(paths,function(x,y){
                return x.inter>y.inter?1:
                       x.inter<y.inter?-1:
                       x.len>y.len?1:
                       x.len<y.len?-1:
                       x.len2>y.len2?1:x.len2==y.len2?0:-1;
            });
            // set the shortest path

            prf.boxing().setAttr('KEY',{path: paths[0].path},false);

            return paths[0].path;
        }
    }
});

xui.Class("xui.svg.group", "xui.svg.absComb",{
    Instance:{
        _adjustText:function(){
            return this;
        },
        _setBBox:function(key,value,notify){
            var bb=xui.svg.$adjustBB(key,value);
            return this.each(function(prf){
                var prop=prf.properties, ss=prf._elset, attrs=prop.attr;
                if(prf.renderId && ss&&ss[0]){
                    var bbo=prf.boxing()._getBBox();
                    ss.forEach(function(el){
                        var attr=attrs[prf.getKey(el.node.id,true)], bbn={};
                        if(el.type=="text"){
                            bbn={x:attr.x, y:attr.y};
                            if('x' in bb)bbn.x+=bb.x-bbo.x;
                            if('y' in bb)bbn.y+=bb.y-bbo.y;
                            attr.x=bbn.x;
                            attr.y=bbn.y;
                            el.attr(bbn);
                        }else{
                            xui.merge(bbn, el._getBBox(true),'all',true);
                            if('x' in bb)bbn.x+=bb.x-bbo.x;
                            if('y' in bb)bbn.y+=bb.y-bbo.y;
                            if('width' in bb)bbn.width+=bb.width-bbo.width;
                            if('height' in bb)bbn.height+=bb.height-bbo.height;
                            xui.svg.$setBB(prf, el.type, bbn, attr, el, notify);
                        }
                    });
                }else{
                    if(!prf._init_bbox)prf._init_bbox={};
                    xui.merge(prf._init_bbox,bb,'all',true);
                }
            });
        }
    },
    Static:{
        ISCOMBO:1,
        _beforeSerialized:function(profile){
            var o = arguments.callee.upper.call(this,profile),prop=o.properties;
            var attrs=prop.attr=xui.clone(prop.attr,true);
            
            xui.filter(attrs.KEY,function(o,i){
                if(i=='transform'&&(!o||o.length<1))return false;
                if(i=='href'||i=='target')return false;
                if(i=='path' && xui.isArr(prop.attr.KEY.path))prop.attr.KEY.path=o.join('');
            });
            // other elements
            xui.each(attrs,function(attr,key){
                if(key=="KEY")return;
                xui.filter(attr,function(o,i){
                    // transform is from KEY
                    if(i=='transform')return false;
                });
                
                var type=key.split("_")[0];
                if(type=="path"){
                    xui.each(attr,function(o,i){
                        if(i=='path' && xui.isArr(o))attr.path=o.join('');
                    });
                }
            });

            return o;
        },
        _type:'path',
        Templates:{
            tagName:'path'
        },
        DataModel:{
            attr:{
                ini:{
                    KEY:{
                    }
                }
            },
            hAlign:null,
            vAlign:null,
            shadow:false
        },
        RenderTrigger:function(){
            var prf=this,bb;
            if(bb=prf._init_bbox){
                prf.boxing()._setBBox(bb);
                delete prf._init_bbox;
            }
        },
        _draw:function(paper, prf, prop){
            var s=paper.set(), attrs=prop.attr, rootattr=attrs.KEY||{path:""},
                el=paper.path(rootattr.path||"");
            el._isGroupFirst=1;
            // root is a path
            el.node.id=prf.box.KEY+":"+prf.serialId+":";
            s.push(el);
            // other elements
            xui.each(attrs,function(attr,key){
                if(key=="KEY")return;
                
                var type=key.split("_")[0].toLowerCase();
                switch(type){
                    case "rect":
                        el = paper.rect(attr.x,attr.y,attr.width,attr.height);
                        break;
                    case "circle":
                        el = paper.circle(attr.cx,attr.cy,attr.r);
                        break;
                    case "ellipse":
                        el = paper.ellipse(attr.cx,attr.cy,attr.rx,attr.ry);
                        break;
                    case "image":
                        el =paper.image(attr.src,attr.x,attr.y,attr.width,attr.height);
                        break;
                    case "path":
                        el =paper.path(attr.path);
                        break;                    
                    case "text":
                        el = paper.text(attr.x, attr.y, attr.text);
                        break;
                    default:
                        return;
                }
                var src = xui(this.node).xid();
                if(type=="text"){
                    el.click(function(e){
                        if(prf.$inDesign)return false;
                        if(prf.properties.disabled)return false;
                        var rtn;
                        if(prf.onTextClick)
                            rtn=prf.boxing().onTextClick(prf, e, src);
                        if(rtn!==false && prf.onClick)
                            return prf.boxing().onClick(prf, e, src);
                    });
                }else{
                    el.click(function(e){
                        if(prf.$inDesign)return false;
                        if(prf.properties.disabled)return false;
                        if(prf.onClick)
                            return prf.boxing().onClick(prf, e, src);
                    });
                }
                el.dblclick(function(e){
                    if(prf.$inDesign)return false;
                    if(prf.properties.disabled)return false;
                    if(prf.onDblClick)
                        return prf.boxing().onDblClick(prf, e, src);
                });
                el.contextmenu(function(e){
                    if(prf.onContextmenu)
                        return prf.boxing().onContextmenu(prf, e, src)!==false;
                });
                el.node.id=prf.box.KEY+"-"+key+":"+prf.serialId+":";
                s.push(el);
            });
            return s;
        }
    }
});xui.Class("xui.UI.SVGPaper", "xui.UI.Div",{
    Initialize:function(){
        this.addTemplateKeys(['SVG']);
    },
    Instance:{
        append:function(target, pre, base){
            if(xui.isHash(target) || xui.isStr(target))
                target=xui.create(target);
            if(target['xui.UIProfile'])target=target.boxing();

            var ns=this,f=arguments.callee.upper,isSvg,rendersvg;
            target.each(function(prf){
                isSvg=!!prf.box['xui.svg'];
                if(isSvg&&prf.renderId){
                    prf.clearCache();
                    prf.$beforeDestroy["svgClear"]();
                    delete prf.renderId;
                    delete prf.rendered;
                    rendersvg=1;
                }
                f.call(ns, prf, null, pre, base, isSvg, ns.get(0)&&xui(ns.get(0)._canvas));
                if(rendersvg){
                    prf.box._initAttr2UI(prf);
                }
            });
            return this;
        },
        getPaper:function(){
            return xui.get(this.get(0), ["_paper"]);
        },
        getSVGString:function(){
            var paper = xui.get(this.get(0), ["_paper"]);
            return paper?paper.toSVG():"";
        }
    },
    Static:{
        DataModel:{
            iframeAutoLoad:null,
            html:null,
            width:{
                $spaceunit:1,
                ini:'32em'
            },
            height:{
                $spaceunit:1,
                ini:'25em'
            },
            scaleChildren:{
                ini:false
            },
            overflow:{
                ini:undefined
            },
            graphicZIndex:{
                ini:0,
                action:function(v){
                    this.getSubNode('SVG').css('zIndex',v);
                }
            }
        },
        Behaviors:{
            onSize:xui.UI.$onSize
        },
        RenderTrigger:function(){
            var profile=this,
                root=profile.getRootNode(),
                prop=profile.properties,
            // force to px    
            w=xui.CSS.$px(prop.width,root,true),h=xui.CSS.$px(prop.height,root,true);
            (profile.$beforeDestroy=(profile.$beforeDestroy||{}))["svgClear"]=function(){
                if(profile._paper){
                    profile._paper.clear();
                    profile._paper.remove();
                }
            };
            profile._paper=Raphael(profile.$domId, w, h);
            profile._canvas=profile._paper.canvas;
            profile._canvas.id=profile.box.KEY+"-SVG:"+profile.serialId+":";
            var s=profile._canvas.style;
            s.position='absolute';
            s.left=0;
            s.top=0;
            s.zIndex=prop.graphicZIndex;

            // contents
            var a=[];
            xui.arr.each(profile.children,function(o){
                if(o[0].box["xui.svg"])a.push(o[0]);
            });
            if(a.length){
                profile.boxing().append(xui.svg.pack(a));
                // for IE
                if(!Raphael.svg){
                    xui.setTimeout(function(){
                        if(profile && !profile.destroyed){
                        	  // read again in IE
                            profile.boxing().append(xui.svg.pack(a));
                        }
                    });
                }
            }
            if(profile._paper){
            	  xui.setTimeout(function(){
            	        if(profile && !profile.destroyed){
            	  	    // ensure right position
            	  	    if(profile.$designerRoot)
                                 profile._frame=profile._paper.rect(0,0,1,1,0).attr({"stroke-width":"0px"});
            	  	    else if(profile.$inDesign)
                                profile._frame=profile._paper.rect(0,0,w,h,8).attr({"stroke-dasharray": ". ", stroke: "#666"});
                        if(profile._frame)profile._frame._decoration=1;
                    }
                });
            }
        },
        _onresize:function(profile,width,height){
            var paper=profile._paper, scaleChildren=profile.properties.scaleChildren,ow,oh,
                prop=profile,properties,
                us = xui.$us(prop),
                adjustunit = function(v,emRate){return profile.$forceu(v, us>0?'em':'px', emRate)};

            // caculate by px
            width=width?profile.$px(width, null, true):width;
            height=height?profile.$px(height, null, true):height;

            if(scaleChildren){
                ow=profile.$px(paper.width,null,true);
                oh=profile.$px(paper.height,null,true);
            }
            if(paper){
                var pw=profile.$px(paper.width,null,true), ph=profile.$px(paper.height,null,true);
                if( (width && pw!=width) || (height && ph!=height) ){
                    var args={},node=profile.getSubNode("SVG");
                    paper.setSize(width,height);
                    
                    if(profile.$inDesign && profile._frame){
                        if(width||width===0)
                            profile._frame.attr('width',width);
                        if(height||height===0)
                            profile._frame.attr('height',height);
                    }
                    
                    if(!(width||width===0)){
                       width=pw; 
                    }
                    args.width=width;
                    if((height||height===0)){
                       height=ph; 
                    }
                    args.height=height;
                    
                    if((!xui.isEmpty(args)) && xui.Dom.$hasEventHandler(node.get(0),'onsize'))
                        node.onSize(true, args);

                    if(scaleChildren){
                        paper.forEach(function(elem){
                            var wr=width/ow,hr=height/oh,xuiElem, 
                                fun=function(elem, key) {
                                    var xuiElem=xui.UIProfile.getFromDom(elem.node.id);
                                    if(!xuiElem)return;

                                    var attr=elem.attr(),
                                        hash;
                                        
                                    switch(elem.type){
                                        // circle is xuiElem, so dont use cirle in this case
                                        case 'circle':
                                            hash={
                                                cx:attr.cx*wr,
                                                cy:attr.cy*hr,
                                                r:attr.r*(wr+hr)/2
                                            };
                                        break;
                                        case 'ellipse':
                                            hash={
                                                cx:attr.cx*wr,
                                                cy:attr.cy*hr,
                                                rx:attr.rx*wr,
                                                ry:attr.ry*hr
                                            };
                                        break;
                                        case 'rect':
                                        case 'image':
                                        hash={
                                                x:attr.x*wr,
                                                y:attr.y*hr,
                                                width:attr.width*wr,
                                                height:attr.height*hr
                                            };
                                        break;
                                        case 'text':
                                        hash={
                                                x:attr.x*wr,
                                                y:attr.y*hr
                                            };
                                        break;
                                        case 'path':
                                            hash={
                                                path:Raphael.transformPath(xui.isArr(attr.path)?attr.path.join(""):attr.path, "s"+wr+","+hr+",0,0")
                                            };
                                        break;
                                    }

                                    if(hash){
                                        xuiElem.boxing().setAttr(key || "KEY",hash,false,true);
                                        //elem.attr(hash);
                                    }
                                };
                            // find root node
                            if(profile._frame!==elem 
                                && elem.node.$xid 
                                && elem.node.id 
                                && !/^[^:]+-/.test(elem.node.id) 
                                ){

                                if(elem._isGroupFirst){
                                    var xuiElem=xui.UIProfile.getFromDom(elem.node.id);
                                    if(xuiElem){
                                        xuiElem._elset.forEach(function(o){
                                            fun(o, xuiElem.getKey(o.node.id, true));
                                        })
                                    }
                                }else{
                                    fun(elem);
                                }
                            }
                        });
                    }
                }
            }
        }
    }
});        if(!('Class' in window))window.Class=function(){return xui.Class.apply(xui.Class,arguments);};

    if (typeof module !== 'undefined' && typeof exports === 'object') {
        module.exports = xui;
    } else if (typeof define === 'function' && (define.amd || define.cmd)) {
        define(function() { return xui; });
    }
}).call(this || (typeof window !== 'undefined' ? window : global));